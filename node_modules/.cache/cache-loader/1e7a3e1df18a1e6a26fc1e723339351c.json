{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\ETH2GHOST.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\ETH2GHOST.ts","mtime":1614842913756},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXN5bmNUb0dlbmVyYXRvciI7CmltcG9ydCBfY2xhc3NDYWxsQ2hlY2sgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jcmVhdGVDbGFzcyI7CmltcG9ydCBfYXNzZXJ0VGhpc0luaXRpYWxpemVkIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXNzZXJ0VGhpc0luaXRpYWxpemVkIjsKaW1wb3J0IF9pbmhlcml0cyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjsKaW1wb3J0IF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiI7CmltcG9ydCBfZ2V0IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0IjsKaW1wb3J0IF9nZXRQcm90b3R5cGVPZiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldFByb3RvdHlwZU9mIjsKaW1wb3J0IF9kZWZpbmVQcm9wZXJ0eSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2RlZmluZVByb3BlcnR5IjsKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgppbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnOwppbXBvcnQgeyBjb25zdGFudHMsIHV0aWwgfSBmcm9tICdzd2FwLmFwcCc7CmltcG9ydCB7IEF0b21pY0FCMlVUWE8gfSBmcm9tICdzd2FwLnN3YXAnOwoKdmFyIEVUSDJHSE9TVCA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoX0F0b21pY0FCMlVUWE8pIHsKICBfaW5oZXJpdHMoRVRIMkdIT1NULCBfQXRvbWljQUIyVVRYTyk7CgogIHZhciBfc3VwZXIgPSBfY3JlYXRlU3VwZXIoRVRIMkdIT1NUKTsKCiAgZnVuY3Rpb24gRVRIMkdIT1NUKHN3YXApIHsKICAgIHZhciBfdGhpc1N1cGVyLCBfdGhpczsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRVRIMkdIT1NUKTsKCiAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsIHN3YXApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIl9mbG93TmFtZSIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZXRoU3dhcCIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZ2hvc3RTd2FwIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJzdGF0ZSIsIHZvaWQgMCk7CgogICAgX3RoaXMudXR4b0NvaW4gPSAiZ2hvc3QiOwogICAgX3RoaXMuX2Zsb3dOYW1lID0gRVRIMkdIT1NULmdldE5hbWUoKTsKICAgIF90aGlzLnN0ZXBOdW1iZXJzID0gewogICAgICAnc2lnbic6IDEsCiAgICAgICd3YWl0LWxvY2stdXR4byc6IDIsCiAgICAgICd2ZXJpZnktc2NyaXB0JzogMywKICAgICAgJ3N5bmMtYmFsYW5jZSc6IDQsCiAgICAgICdsb2NrLWV0aCc6IDUsCiAgICAgICd3YWl0LXdpdGhkcmF3LWV0aCc6IDYsCiAgICAgIC8vIGFrYSBnZXRTZWNyZXQKICAgICAgJ3dpdGhkcmF3LXV0eG8nOiA3LAogICAgICAnZmluaXNoJzogOCwKICAgICAgJ2VuZCc6IDkKICAgIH07CiAgICBfdGhpcy5ldGhTd2FwID0gc3dhcC5wYXJ0aWNpcGFudFN3YXA7CiAgICBfdGhpcy5naG9zdFN3YXAgPSBzd2FwLm93bmVyU3dhcDsKICAgIF90aGlzLmFiQmxvY2tjaGFpbiA9IF90aGlzLmV0aFN3YXA7CiAgICBfdGhpcy51dHhvQmxvY2tjaGFpbiA9IF90aGlzLmdob3N0U3dhcDsKCiAgICBpZiAoIV90aGlzLmV0aFN3YXApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdFVEgyR0hPU1Q6ICJldGhTd2FwIiBvZiB0eXBlIG9iamVjdCByZXF1aXJlZCcpOwogICAgfQoKICAgIGlmICghX3RoaXMuZ2hvc3RTd2FwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignRVRIMkdIT1NUOiAiZ2hvc3RTd2FwIiBvZiB0eXBlIG9iamVjdCByZXF1aXJlZCcpOwogICAgfQoKICAgIF90aGlzLnN0YXRlID0gewogICAgICBzdGVwOiAwLAogICAgICBpc1N0b3BwZWRTd2FwOiBmYWxzZSwKICAgICAgc2lnblRyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgaXNTaWduRmV0Y2hpbmc6IGZhbHNlLAogICAgICBpc01lU2lnbmVkOiBmYWxzZSwKICAgICAgdGFyZ2V0V2FsbGV0OiBudWxsLAogICAgICBzZWNyZXRIYXNoOiBudWxsLAogICAgICBpc0JhbGFuY2VGZXRjaGluZzogZmFsc2UsCiAgICAgIGlzQmFsYW5jZUVub3VnaDogdHJ1ZSwKICAgICAgYmFsYW5jZTogbnVsbCwKICAgICAgZXRoU3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICBjYW5DcmVhdGVFdGhUcmFuc2FjdGlvbjogdHJ1ZSwKICAgICAgaXNFdGhDb250cmFjdEZ1bmRlZDogZmFsc2UsCiAgICAgIHNlY3JldDogbnVsbCwKICAgICAgaXNFdGhXaXRoZHJhd246IGZhbHNlLAogICAgICBpc0dob3N0V2l0aGRyYXduOiBmYWxzZSwKICAgICAgZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICBnaG9zdFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgcmVmdW5kVHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICBpc1JlZnVuZGVkOiBmYWxzZSwKICAgICAgaXNGaW5pc2hlZDogZmFsc2UsCiAgICAgIGlzU3dhcEV4aXN0OiBmYWxzZSwKICAgICAgd2l0aGRyYXdSZXF1ZXN0SW5jb21pbmc6IGZhbHNlLAogICAgICB3aXRoZHJhd1JlcXVlc3RBY2NlcHRlZDogZmFsc2UsCiAgICAgIGlzRmFpbGVkVHJhbnNhY3Rpb246IGZhbHNlLAogICAgICBpc0ZhaWxlZFRyYW5zYWN0aW9uRXJyb3I6IG51bGwKICAgIH07CgogICAgX3RoaXMuX3BlcnNpc3RTdGF0ZSgpOwoKICAgIHZhciBmbG93ID0gX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyk7CgogICAgZmxvdy5zd2FwLnJvb20ub25jZSgncmVxdWVzdCB3aXRoZHJhdycsIGZ1bmN0aW9uICgpIHsKICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgd2l0aGRyYXdSZXF1ZXN0SW5jb21pbmc6IHRydWUKICAgICAgfSk7CiAgICB9KTsKICAgIGZsb3cuc3dhcC5yb29tLm9uKCdyZXF1ZXN0IGV0aCBjb250cmFjdCcsIGZ1bmN0aW9uICgpIHsKICAgICAgY29uc29sZS5sb2coJ1JlcXVlc3RpbmcgZXRoIGNvbnRyYWN0Jyk7CiAgICAgIHZhciBldGhTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2ggPSBmbG93LnN0YXRlLmV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDsKCiAgICAgIGlmIChldGhTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2gpIHsKICAgICAgICBjb25zb2xlLmxvZygnRXhpc3RzIC0gc2VuZCBoYXNoJyk7CiAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgZXZlbnQ6ICdjcmVhdGUgZXRoIGNvbnRyYWN0JywKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgZXRoU3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoOiBldGhTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2gKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CgogICAgX2dldCgoX3RoaXNTdXBlciA9IF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCBfZ2V0UHJvdG90eXBlT2YoRVRIMkdIT1NULnByb3RvdHlwZSkpLCAiX3BlcnNpc3RTdGVwcyIsIF90aGlzU3VwZXIpLmNhbGwoX3RoaXNTdXBlcik7CgogICAgcmV0dXJuIF90aGlzOwogIH0KCiAgX2NyZWF0ZUNsYXNzKEVUSDJHSE9TVCwgW3sKICAgIGtleTogIl9wZXJzaXN0U3RhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9wZXJzaXN0U3RhdGUoKSB7CiAgICAgIF9nZXQoX2dldFByb3RvdHlwZU9mKEVUSDJHSE9TVC5wcm90b3R5cGUpLCAiX3BlcnNpc3RTdGF0ZSIsIHRoaXMpLmNhbGwodGhpcyk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2dldFN0ZXBzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2V0U3RlcHMoKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgdmFyIGZsb3cgPSB0aGlzOwogICAgICByZXR1cm4gWy8vIDEuIFNpZ24gc3dhcCB0byBzdGFydAogICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMyLnNpZ25BQlNpZGUoKTsKICAgICAgfSwgLy8gMi4gV2FpdCBwYXJ0aWNpcGFudCBjcmVhdGUsIGZ1bmQgQlRDIFNjcmlwdAogICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgZmxvdy53YWl0VVRYT1NjcmlwdENyZWF0ZWQoKTsKICAgICAgfSwgLy8gMy4gVmVyaWZ5IEdIT1NUIFNjcmlwdAogICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoIndhaXRpbmcgdmVyaWZ5IGdob3N0IHNjcmlwdCIpOyAvLyB0aGlzLnZlcmlmeUdob3N0U2NyaXB0KCkKICAgICAgfSwgLy8gNC4gQ2hlY2sgYmFsYW5jZQogICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMyLnN5bmNCYWxhbmNlKCk7CiAgICAgIH0sCiAgICAgIC8qI19fUFVSRV9fKi8KICAgICAgLy8gNS4gQ3JlYXRlIEVUSCBDb250cmFjdAogICAgICBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiBmbG93LmV0aFN3YXAuZnVuZEFCMlVUWE9Db250cmFjdCh7CiAgICAgICAgICAgICAgICAgIGZsb3c6IGZsb3csCiAgICAgICAgICAgICAgICAgIHV0eG9Db2luOiAiZ2hvc3QiCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZSk7CiAgICAgIH0pKSwKICAgICAgLyojX19QVVJFX18qLwogICAgICAvLyA2LiBXYWl0IHBhcnRpY2lwYW50IHdpdGhkcmF3CiAgICAgIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyKCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIkKF9jb250ZXh0MikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDIucHJldiA9IF9jb250ZXh0Mi5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSAyOwogICAgICAgICAgICAgICAgcmV0dXJuIGZsb3cuZXRoU3dhcC5nZXRTZWNyZXRGcm9tQUIyVVRYTyh7CiAgICAgICAgICAgICAgICAgIGZsb3c6IGZsb3cKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTIpOwogICAgICB9KSksCiAgICAgIC8qI19fUFVSRV9fKi8KICAgICAgLy8gNy4gV2l0aGRyYXcKICAgICAgX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMoKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMyQoX2NvbnRleHQzKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0My5wcmV2ID0gX2NvbnRleHQzLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5oZWxwZXJzLnJlcGVhdEFzeW5jVW50aWxSZXN1bHQoZnVuY3Rpb24gKHN0b3BSZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9mbG93JHN0YXRlID0gZmxvdy5zdGF0ZSwKICAgICAgICAgICAgICAgICAgICAgIHNlY3JldCA9IF9mbG93JHN0YXRlLnNlY3JldCwKICAgICAgICAgICAgICAgICAgICAgIHV0eG9TY3JpcHRWYWx1ZXMgPSBfZmxvdyRzdGF0ZS51dHhvU2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgICAgZ2hvc3RTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2ggPSBfZmxvdyRzdGF0ZS5naG9zdFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDsKCiAgICAgICAgICAgICAgICAgIGlmIChnaG9zdFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZiAoIXV0eG9TY3JpcHRWYWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdUaGVyZSBpcyBubyAidXR4b1NjcmlwdFZhbHVlcyIgaW4gc3RhdGUuIE5vIHdheSB0byBjb250aW51ZSBzd2FwLi4uJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHJldHVybiBmbG93Lmdob3N0U3dhcC53aXRoZHJhdyh7CiAgICAgICAgICAgICAgICAgICAgc2NyaXB0VmFsdWVzOiB1dHhvU2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgIHNlY3JldDogc2VjcmV0LAogICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uQWRkcmVzczogZmxvdy5zd2FwLmRlc3RpbmF0aW9uQnV5QWRkcmVzcwogICAgICAgICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3dpdGhkcmF3IGhhc2gnLCBoYXNoKTsKICAgICAgICAgICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICAgIGdob3N0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBoYXNoCiAgICAgICAgICAgICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0pWyJjYXRjaCJdKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICBpc0dob3N0V2l0aGRyYXduOiB0cnVlCiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgIHN0ZXA6ICd3aXRoZHJhdy11dHhvJwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMyk7CiAgICAgIH0pKSwgLy8gOC4gRmluaXNoCiAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICBmbG93LnN3YXAucm9vbS5vbmNlKCdyZXF1ZXN0IHN3YXAgZmluaXNoZWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgZ2hvc3RTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2ggPSBmbG93LnN0YXRlLmdob3N0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOwogICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICBldmVudDogJ3N3YXAgZmluaXNoZWQnLAogICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgZ2hvc3RTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IGdob3N0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIGZsb3cuZmluaXNoU3RlcCh7CiAgICAgICAgICBpc0ZpbmlzaGVkOiB0cnVlCiAgICAgICAgfSwgewogICAgICAgICAgc3RlcDogJ2ZpbmlzaCcKICAgICAgICB9KTsKICAgICAgfSwgLy8gOS4gRmluaXNoZWQhCiAgICAgIGZ1bmN0aW9uICgpIHt9XTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfY2hlY2tTd2FwQWxyZWFkeUV4aXN0cyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2NoZWNrU3dhcEFscmVhZHlFeGlzdHMoKSB7CiAgICAgIHZhciBzd2FwRGF0YSA9IHsKICAgICAgICBvd25lckFkZHJlc3M6IHRoaXMuYXBwLmdldE15RXRoQWRkcmVzcygpLAogICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogdGhpcy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKHRoaXMuc3dhcCkKICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMuZXRoU3dhcC5jaGVja1N3YXBFeGlzdHMoc3dhcERhdGEpOwogICAgfQogIH0sIHsKICAgIGtleTogInRyeVJlZnVuZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3RyeVJlZnVuZCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU0KCkgewogICAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgICB2YXIgc2VjcmV0SGFzaCwgcmVmdW5kSGFuZGxlciwgd2FzUmVmdW5kZWQ7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NC5wcmV2ID0gX2NvbnRleHQ0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBzZWNyZXRIYXNoID0gdGhpcy5zdGF0ZS5zZWNyZXRIYXNoOwoKICAgICAgICAgICAgICAgIHJlZnVuZEhhbmRsZXIgPSBmdW5jdGlvbiByZWZ1bmRIYW5kbGVyKCkgewogICAgICAgICAgICAgICAgICB2YXIgaGFzaCA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogbnVsbDsKCiAgICAgICAgICAgICAgICAgIF90aGlzMy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgIGV2ZW50OiAnZXRoIHJlZnVuZCBjb21wbGV0ZWQnCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgX3RoaXMzLnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICByZWZ1bmRUcmFuc2FjdGlvbkhhc2g6IGhhc2gsCiAgICAgICAgICAgICAgICAgICAgaXNSZWZ1bmRlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBpc1N3YXBFeGlzdDogZmFsc2UKICAgICAgICAgICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIF9jb250ZXh0NC5wcmV2ID0gMjsKICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gNTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV0aFN3YXAud2FzUmVmdW5kZWQoewogICAgICAgICAgICAgICAgICBzZWNyZXRIYXNoOiBzZWNyZXRIYXNoCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgd2FzUmVmdW5kZWQgPSBfY29udGV4dDQuc2VudDsKCiAgICAgICAgICAgICAgICBpZiAoIXdhc1JlZnVuZGVkKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gMTA7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCdUaGlzIHN3YXAgd2FzIHJlZnVuZGVkJyk7CiAgICAgICAgICAgICAgICByZWZ1bmRIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDE2OwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgICAgICBfY29udGV4dDQucHJldiA9IDEyOwogICAgICAgICAgICAgICAgX2NvbnRleHQ0LnQwID0gX2NvbnRleHQ0WyJjYXRjaCJdKDIpOwogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCd3YXNSZWZ1bmRlZCBlcnJvcjonLCBfY29udGV4dDQudDApOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5hYnJ1cHQoInJldHVybiIsIGZhbHNlKTsKCiAgICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuYWJydXB0KCJyZXR1cm4iLCB0aGlzLmV0aFN3YXAucmVmdW5kKHsKICAgICAgICAgICAgICAgICAgcGFydGljaXBhbnRBZGRyZXNzOiB0aGlzLmFwcC5nZXRQYXJ0aWNpcGFudEV0aEFkZHJlc3ModGhpcy5zd2FwKQogICAgICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc2gpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHJlZnVuZEhhbmRsZXIoaGFzaCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfSlbImNhdGNoIl0oZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgY2FzZSAxNzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNCwgdGhpcywgW1syLCAxMl1dKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gdHJ5UmVmdW5kKCkgewogICAgICAgIHJldHVybiBfdHJ5UmVmdW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnlSZWZ1bmQ7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJpc1JlZnVuZFN1Y2Nlc3MiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9pc1JlZnVuZFN1Y2Nlc3MgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNSgpIHsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU1JChfY29udGV4dDUpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ1LnByZXYgPSBfY29udGV4dDUubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ1LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU1KTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gaXNSZWZ1bmRTdWNjZXNzKCkgewogICAgICAgIHJldHVybiBfaXNSZWZ1bmRTdWNjZXNzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBpc1JlZnVuZFN1Y2Nlc3M7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJ0cnlXaXRoZHJhdyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3RyeVdpdGhkcmF3ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTYoX3NlY3JldCkgewogICAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgICB2YXIgX3RoaXMkc3RhdGUsIHNlY3JldCwgc2VjcmV0SGFzaCwgaXNFdGhXaXRoZHJhd24sIGlzR2hvc3RXaXRoZHJhd24sIHV0eG9TY3JpcHRWYWx1ZXMsIF9zZWNyZXRIYXNoLCBfdGhpcyRnaG9zdFN3YXAkY3JlYXQsIHNjcmlwdEFkZHJlc3MsIGJhbGFuY2U7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTYkKF9jb250ZXh0NikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDYucHJldiA9IF9jb250ZXh0Ni5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX3RoaXMkc3RhdGUgPSB0aGlzLnN0YXRlLCBzZWNyZXQgPSBfdGhpcyRzdGF0ZS5zZWNyZXQsIHNlY3JldEhhc2ggPSBfdGhpcyRzdGF0ZS5zZWNyZXRIYXNoLCBpc0V0aFdpdGhkcmF3biA9IF90aGlzJHN0YXRlLmlzRXRoV2l0aGRyYXduLCBpc0dob3N0V2l0aGRyYXduID0gX3RoaXMkc3RhdGUuaXNHaG9zdFdpdGhkcmF3biwgdXR4b1NjcmlwdFZhbHVlcyA9IF90aGlzJHN0YXRlLnV0eG9TY3JpcHRWYWx1ZXM7CgogICAgICAgICAgICAgICAgaWYgKF9zZWNyZXQpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSAzOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldpdGhkcmF3YWwgaXMgYXV0b21hdGljLiBGb3IgbWFudWFsIHdpdGhkcmF3YWwsIHByb3ZpZGUgYSBzZWNyZXQiKTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgaWYgKHV0eG9TY3JpcHRWYWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSA1OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCB3aXRoZHJhdyB3aXRob3V0IHNjcmlwdCB2YWx1ZXMiKTsKCiAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgaWYgKHNlY3JldCAmJiBzZWNyZXQgIT0gX3NlY3JldCkgY29uc29sZS53YXJuKCJTZWNyZXQgYWxyZWFkeSBrbm93biBhbmQgaXMgZGlmZmVyZW50LiBBcmUgeW91IHN1cmU/Iik7CiAgICAgICAgICAgICAgICBpZiAoaXNHaG9zdFdpdGhkcmF3bikgY29uc29sZS53YXJuKCJMb29rcyBsaWtlIG1vbmV5IHdlcmUgYWxyZWFkeSB3aXRoZHJhd24sIGFyZSB5b3Ugc3VyZT8iKTsKICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJXSVRIRFJBVyB1c2luZyBzZWNyZXQgPSAiLmNvbmNhdChfc2VjcmV0KSk7CiAgICAgICAgICAgICAgICBfc2VjcmV0SGFzaCA9IHRoaXMuYXBwLmVudi5iaXRjb2luLmNyeXB0by5yaXBlbWQxNjAoQnVmZmVyLmZyb20oX3NlY3JldCwgJ2hleCcpKS50b1N0cmluZygnaGV4Jyk7CiAgICAgICAgICAgICAgICBpZiAoc2VjcmV0SGFzaCAhPSBfc2VjcmV0SGFzaCkgY29uc29sZS53YXJuKCJIYXNoIGRvZXMgbm90IG1hdGNoISBzdGF0ZTogIi5jb25jYXQoc2VjcmV0SGFzaCwgIiwgZ2l2ZW46ICIpLmNvbmNhdChfc2VjcmV0SGFzaCkpOwogICAgICAgICAgICAgICAgX3RoaXMkZ2hvc3RTd2FwJGNyZWF0ID0gdGhpcy5naG9zdFN3YXAuY3JlYXRlU2NyaXB0KHV0eG9TY3JpcHRWYWx1ZXMpLCBzY3JpcHRBZGRyZXNzID0gX3RoaXMkZ2hvc3RTd2FwJGNyZWF0LnNjcmlwdEFkZHJlc3M7CiAgICAgICAgICAgICAgICBfY29udGV4dDYubmV4dCA9IDEzOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2hvc3RTd2FwLmdldEJhbGFuY2Uoc2NyaXB0QWRkcmVzcyk7CgogICAgICAgICAgICAgIGNhc2UgMTM6CiAgICAgICAgICAgICAgICBiYWxhbmNlID0gX2NvbnRleHQ2LnNlbnQ7CiAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgiYWRkcmVzcz0iLmNvbmNhdChzY3JpcHRBZGRyZXNzLCAiLCBiYWxhbmNlPSIpLmNvbmNhdChiYWxhbmNlKSk7CgogICAgICAgICAgICAgICAgaWYgKCEoYmFsYW5jZSA9PT0gMCkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSAxODsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5maW5pc2hTdGVwKHsKICAgICAgICAgICAgICAgICAgaXNHaG9zdFdpdGhkcmF3bjogdHJ1ZQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBzdGVwOiAnd2l0aGRyYXctdXR4bycKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbHJlYWR5IHdpdGhkcmF3bjogYWRkcmVzcz0iLmNvbmNhdChzY3JpcHRBZGRyZXNzLCAiLGJhbGFuY2U9IikuY29uY2F0KGJhbGFuY2UpKTsKCiAgICAgICAgICAgICAgY2FzZSAxODoKICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMjA7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5naG9zdFN3YXAud2l0aGRyYXcoewogICAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXM6IHV0eG9TY3JpcHRWYWx1ZXMsCiAgICAgICAgICAgICAgICAgIHNlY3JldDogX3NlY3JldAogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoIlRYIGhhc2g9Ii5jb25jYXQoaGFzaCkpOwoKICAgICAgICAgICAgICAgICAgX3RoaXM0LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICBidGNTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IGhhc2gKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSAyMDoKICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJUWCB3aXRoZHJhdyBzZW50OiAiLmNvbmNhdCh0aGlzLnN0YXRlLmJ0Y1N3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCkpOwogICAgICAgICAgICAgICAgdGhpcy5maW5pc2hTdGVwKHsKICAgICAgICAgICAgICAgICAgaXNHaG9zdFdpdGhkcmF3bjogdHJ1ZQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBzdGVwOiAnd2l0aGRyYXctdXR4bycKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDIyOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ2LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU2LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gdHJ5V2l0aGRyYXcoX3gpIHsKICAgICAgICByZXR1cm4gX3RyeVdpdGhkcmF3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnlXaXRoZHJhdzsKICAgIH0oKQogIH1dLCBbewogICAga2V5OiAiZ2V0TmFtZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0TmFtZSgpIHsKICAgICAgcmV0dXJuICIiLmNvbmNhdCh0aGlzLmdldEZyb21OYW1lKCksICIyIikuY29uY2F0KHRoaXMuZ2V0VG9OYW1lKCkpOwogICAgfQogIH0sIHsKICAgIGtleTogImdldEZyb21OYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRGcm9tTmFtZSgpIHsKICAgICAgcmV0dXJuIGNvbnN0YW50cy5DT0lOUy5ldGg7CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2V0VG9OYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRUb05hbWUoKSB7CiAgICAgIHJldHVybiBjb25zdGFudHMuQ09JTlMuZ2hvc3Q7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gRVRIMkdIT1NUOwp9KEF0b21pY0FCMlVUWE8pOwoKZXhwb3J0IGRlZmF1bHQgRVRIMkdIT1NUOw=="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.flows/ETH2GHOST.ts"],"names":["debug","constants","util","AtomicAB2UTXO","ETH2GHOST","swap","utxoCoin","_flowName","getName","stepNumbers","ethSwap","participantSwap","ghostSwap","ownerSwap","abBlockchain","utxoBlockchain","Error","state","step","isStoppedSwap","signTransactionHash","isSignFetching","isMeSigned","targetWallet","secretHash","isBalanceFetching","isBalanceEnough","balance","ethSwapCreationTransactionHash","canCreateEthTransaction","isEthContractFunded","secret","isEthWithdrawn","isGhostWithdrawn","ethSwapWithdrawTransactionHash","ghostSwapWithdrawTransactionHash","refundTransactionHash","isRefunded","isFinished","isSwapExist","withdrawRequestIncoming","withdrawRequestAccepted","isFailedTransaction","isFailedTransactionError","_persistState","flow","room","once","setState","on","console","log","sendMessage","event","data","signABSide","waitUTXOScriptCreated","syncBalance","fundAB2UTXOContract","getSecretFromAB2UTXO","helpers","repeatAsyncUntilResult","stopRepeat","utxoScriptValues","error","withdraw","scriptValues","destinationAddress","destinationBuyAddress","then","hash","finishStep","swapData","ownerAddress","app","getMyEthAddress","participantAddress","getParticipantEthAddress","checkSwapExists","refundHandler","wasRefunded","warn","refund","_secret","_secretHash","env","bitcoin","crypto","ripemd160","Buffer","from","toString","createScript","scriptAddress","getBalance","btcSwapWithdrawTransactionHash","getFromName","getToName","COINS","eth","ghost"],"mappings":"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","sourcesContent":["import debug from 'debug'\r\nimport SwapApp, { constants, util } from 'swap.app'\r\nimport { AtomicAB2UTXO } from 'swap.swap'\r\n\r\n\r\nclass ETH2GHOST extends AtomicAB2UTXO {\r\n\r\n  _flowName: string\r\n  ethSwap: any\r\n  ghostSwap: any\r\n  state: any\r\n\r\n  static getName() {\r\n    return `${this.getFromName()}2${this.getToName()}`\r\n  }\r\n  static getFromName() {\r\n    return constants.COINS.eth\r\n  }\r\n  static getToName() {\r\n    return constants.COINS.ghost\r\n  }\r\n  constructor(swap) {\r\n    super(swap)\r\n    this.utxoCoin = `ghost`\r\n    this._flowName = ETH2GHOST.getName()\r\n\r\n    this.stepNumbers = {\r\n      'sign': 1,\r\n      'wait-lock-utxo': 2,\r\n      'verify-script': 3,\r\n      'sync-balance': 4,\r\n      'lock-eth': 5,\r\n      'wait-withdraw-eth': 6, // aka getSecret\r\n      'withdraw-utxo': 7,\r\n      'finish': 8,\r\n      'end': 9\r\n    }\r\n\r\n    this.ethSwap = swap.participantSwap\r\n    this.ghostSwap = swap.ownerSwap\r\n\r\n    this.abBlockchain = this.ethSwap\r\n    this.utxoBlockchain = this.ghostSwap\r\n\r\n    if (!this.ethSwap) {\r\n      throw new Error('ETH2GHOST: \"ethSwap\" of type object required')\r\n    }\r\n    if (!this.ghostSwap) {\r\n      throw new Error('ETH2GHOST: \"ghostSwap\" of type object required')\r\n    }\r\n\r\n    this.state = {\r\n      step: 0,\r\n\r\n      isStoppedSwap: false,\r\n\r\n      signTransactionHash: null,\r\n      isSignFetching: false,\r\n      isMeSigned: false,\r\n\r\n      targetWallet : null,\r\n      secretHash: null,\r\n\r\n      isBalanceFetching: false,\r\n      isBalanceEnough: true,\r\n      balance: null,\r\n\r\n      ethSwapCreationTransactionHash: null,\r\n      canCreateEthTransaction: true,\r\n      isEthContractFunded: false,\r\n\r\n      secret: null,\r\n\r\n      isEthWithdrawn: false,\r\n      isGhostWithdrawn: false,\r\n\r\n      ethSwapWithdrawTransactionHash: null,\r\n      ghostSwapWithdrawTransactionHash: null,\r\n\r\n      refundTransactionHash: null,\r\n      isRefunded: false,\r\n\r\n      isFinished: false,\r\n      isSwapExist: false,\r\n\r\n      withdrawRequestIncoming: false,\r\n      withdrawRequestAccepted: false,\r\n\r\n      isFailedTransaction: false,\r\n      isFailedTransactionError: null,\r\n    }\r\n\r\n    this._persistState()\r\n\r\n    const flow = this\r\n    flow.swap.room.once('request withdraw', () => {\r\n      flow.setState({\r\n        withdrawRequestIncoming: true,\r\n      })\r\n    })\r\n\r\n    flow.swap.room.on('request eth contract', () => {\r\n      console.log('Requesting eth contract')\r\n      const { ethSwapCreationTransactionHash } = flow.state\r\n\r\n      if (ethSwapCreationTransactionHash) {\r\n        console.log('Exists - send hash')\r\n        flow.swap.room.sendMessage({\r\n          event: 'create eth contract',\r\n          data: {\r\n            ethSwapCreationTransactionHash,\r\n          },\r\n        })\r\n      }\r\n    })\r\n\r\n    super._persistSteps()\r\n  }\r\n\r\n  _persistState() {\r\n    super._persistState()\r\n  }\r\n\r\n  _getSteps() {\r\n    const flow = this\r\n\r\n    return [\r\n\r\n      // 1. Sign swap to start\r\n\r\n      () => {\r\n        this.signABSide()\r\n      },\r\n\r\n      // 2. Wait participant create, fund BTC Script\r\n\r\n      () => {\r\n        flow.waitUTXOScriptCreated()\r\n      },\r\n\r\n      // 3. Verify GHOST Script\r\n\r\n      () => {\r\n        debug('swap.core:flow')(`waiting verify ghost script`)\r\n        // this.verifyGhostScript()\r\n      },\r\n\r\n      // 4. Check balance\r\n\r\n      () => {\r\n        this.syncBalance()\r\n      },\r\n\r\n      // 5. Create ETH Contract\r\n\r\n      async () => {\r\n        await flow.ethSwap.fundAB2UTXOContract({\r\n          flow,\r\n          utxoCoin: `ghost`,\r\n        })\r\n      },\r\n\r\n      // 6. Wait participant withdraw\r\n\r\n      async () => {\r\n        await flow.ethSwap.getSecretFromAB2UTXO({ flow })\r\n      },\r\n\r\n      // 7. Withdraw\r\n\r\n      async () => {\r\n        await util.helpers.repeatAsyncUntilResult((stopRepeat) => {\r\n          const { secret, utxoScriptValues, ghostSwapWithdrawTransactionHash } = flow.state\r\n\r\n          if (ghostSwapWithdrawTransactionHash) {\r\n            return true\r\n          }\r\n\r\n          if (!utxoScriptValues) {\r\n            console.error('There is no \"utxoScriptValues\" in state. No way to continue swap...')\r\n            return null\r\n          }\r\n\r\n          return flow.ghostSwap.withdraw({\r\n            scriptValues: utxoScriptValues,\r\n            secret,\r\n            destinationAddress: flow.swap.destinationBuyAddress,\r\n          })\r\n            .then((hash) => {\r\n              console.log('withdraw hash', hash)\r\n              flow.setState({\r\n                ghostSwapWithdrawTransactionHash: hash,\r\n              }, true)\r\n              return true\r\n            })\r\n            .catch((error) => null)\r\n        })\r\n\r\n        flow.finishStep({\r\n          isGhostWithdrawn: true,\r\n        }, { step: 'withdraw-utxo' })\r\n      },\r\n\r\n      // 8. Finish\r\n\r\n      () => {\r\n        flow.swap.room.once('request swap finished', () => {\r\n          const { ghostSwapWithdrawTransactionHash } = flow.state\r\n\r\n          flow.swap.room.sendMessage({\r\n            event: 'swap finished',\r\n            data: {\r\n              ghostSwapWithdrawTransactionHash,\r\n            },\r\n          })\r\n        })\r\n\r\n        flow.finishStep({\r\n          isFinished: true,\r\n        }, { step: 'finish' })\r\n      },\r\n\r\n      // 9. Finished!\r\n\r\n      () => {}\r\n    ]\r\n  }\r\n\r\n  _checkSwapAlreadyExists() {\r\n    const swapData = {\r\n      ownerAddress: this.app.getMyEthAddress(),\r\n      participantAddress: this.app.getParticipantEthAddress(this.swap)\r\n    }\r\n\r\n    return this.ethSwap.checkSwapExists(swapData)\r\n  }\r\n\r\n  async tryRefund() {\r\n    const { secretHash } = this.state\r\n\r\n    const refundHandler = (hash = null) => {\r\n      this.swap.room.sendMessage({\r\n        event: 'eth refund completed',\r\n      })\r\n\r\n      this.setState({\r\n        refundTransactionHash: hash,\r\n        isRefunded: true,\r\n        isSwapExist: false,\r\n      }, true)\r\n    }\r\n\r\n    try {\r\n      const wasRefunded = await this.ethSwap.wasRefunded({ secretHash })\r\n\r\n      if (wasRefunded) {\r\n        debug('swap.core:flow')('This swap was refunded')\r\n\r\n        refundHandler()\r\n\r\n        return true\r\n      }\r\n    } catch (error) {\r\n      console.warn('wasRefunded error:', error)\r\n\r\n      return false\r\n    }\r\n\r\n    return this.ethSwap.refund({\r\n      participantAddress: this.app.getParticipantEthAddress(this.swap),\r\n    })\r\n      .then((hash) => {\r\n        if (!hash) {\r\n          return false\r\n        }\r\n\r\n        refundHandler(hash)\r\n\r\n        return true\r\n      })\r\n      .catch((error) => false)\r\n  }\r\n\r\n  async isRefundSuccess() {\r\n    return true\r\n  }\r\n\r\n  async tryWithdraw(_secret) {\r\n    const { secret, secretHash, isEthWithdrawn, isGhostWithdrawn, utxoScriptValues } = this.state\r\n\r\n    if (!_secret)\r\n      throw new Error(`Withdrawal is automatic. For manual withdrawal, provide a secret`)\r\n\r\n    if (!utxoScriptValues)\r\n      throw new Error(`Cannot withdraw without script values`)\r\n\r\n    if (secret && secret != _secret)\r\n      console.warn(`Secret already known and is different. Are you sure?`)\r\n\r\n    if (isGhostWithdrawn)\r\n      console.warn(`Looks like money were already withdrawn, are you sure?`)\r\n\r\n    debug('swap.core:flow')(`WITHDRAW using secret = ${_secret}`)\r\n\r\n    const _secretHash = this.app.env.bitcoin.crypto.ripemd160(Buffer.from(_secret, 'hex')).toString('hex')\r\n\r\n    if (secretHash != _secretHash)\r\n      console.warn(`Hash does not match! state: ${secretHash}, given: ${_secretHash}`)\r\n\r\n    const { scriptAddress } = this.ghostSwap.createScript(utxoScriptValues)\r\n    const balance = await this.ghostSwap.getBalance(scriptAddress)\r\n\r\n    debug('swap.core:flow')(`address=${scriptAddress}, balance=${balance}`)\r\n\r\n    if (balance === 0) {\r\n      this.finishStep({\r\n        isGhostWithdrawn: true,\r\n      }, { step: 'withdraw-utxo' })\r\n      throw new Error(`Already withdrawn: address=${scriptAddress},balance=${balance}`)\r\n    }\r\n\r\n    await this.ghostSwap.withdraw({\r\n      scriptValues: utxoScriptValues,\r\n      secret: _secret,\r\n    }, (hash) => {\r\n      debug('swap.core:flow')(`TX hash=${hash}`)\r\n      this.setState({\r\n        btcSwapWithdrawTransactionHash: hash,\r\n      })\r\n    })\r\n    debug('swap.core:flow')(`TX withdraw sent: ${this.state.btcSwapWithdrawTransactionHash}`)\r\n\r\n    this.finishStep({\r\n      isGhostWithdrawn: true,\r\n    }, { step: 'withdraw-utxo' })\r\n  }\r\n}\r\n\r\n\r\nexport default ETH2GHOST\r\n"]}]}