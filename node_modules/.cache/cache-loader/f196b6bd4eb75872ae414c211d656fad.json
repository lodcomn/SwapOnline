{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.swaps\\GhostSwap.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.swaps\\GhostSwap.ts","mtime":1614850195477},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF90eXBlb2YgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy90eXBlb2YiOwppbXBvcnQgX2FzeW5jVG9HZW5lcmF0b3IgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9hc3luY1RvR2VuZXJhdG9yIjsKaW1wb3J0IF9jbGFzc0NhbGxDaGVjayBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2NsYXNzQ2FsbENoZWNrIjsKaW1wb3J0IF9jcmVhdGVDbGFzcyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2NyZWF0ZUNsYXNzIjsKaW1wb3J0IF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQiOwppbXBvcnQgX2dldCBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldCI7CmltcG9ydCBfaW5oZXJpdHMgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9pbmhlcml0cyI7CmltcG9ydCBfcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4iOwppbXBvcnQgX2dldFByb3RvdHlwZU9mIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0UHJvdG90eXBlT2YiOwppbXBvcnQgX2RlZmluZVByb3BlcnR5IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZGVmaW5lUHJvcGVydHkiOwppbXBvcnQgX3JlZ2VuZXJhdG9yUnVudGltZSBmcm9tICJAYmFiZWwvcnVudGltZS9yZWdlbmVyYXRvciI7CgpmdW5jdGlvbiBfY3JlYXRlU3VwZXIoRGVyaXZlZCkgeyB2YXIgaGFzTmF0aXZlUmVmbGVjdENvbnN0cnVjdCA9IF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKTsgcmV0dXJuIGZ1bmN0aW9uIF9jcmVhdGVTdXBlckludGVybmFsKCkgeyB2YXIgU3VwZXIgPSBfZ2V0UHJvdG90eXBlT2YoRGVyaXZlZCksIHJlc3VsdDsgaWYgKGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QpIHsgdmFyIE5ld1RhcmdldCA9IF9nZXRQcm90b3R5cGVPZih0aGlzKS5jb25zdHJ1Y3RvcjsgcmVzdWx0ID0gUmVmbGVjdC5jb25zdHJ1Y3QoU3VwZXIsIGFyZ3VtZW50cywgTmV3VGFyZ2V0KTsgfSBlbHNlIHsgcmVzdWx0ID0gU3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfSByZXR1cm4gX3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgcmVzdWx0KTsgfTsgfQoKZnVuY3Rpb24gX2lzTmF0aXZlUmVmbGVjdENvbnN0cnVjdCgpIHsgaWYgKHR5cGVvZiBSZWZsZWN0ID09PSAidW5kZWZpbmVkIiB8fCAhUmVmbGVjdC5jb25zdHJ1Y3QpIHJldHVybiBmYWxzZTsgaWYgKFJlZmxlY3QuY29uc3RydWN0LnNoYW0pIHJldHVybiBmYWxzZTsgaWYgKHR5cGVvZiBQcm94eSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIHRydWU7IHRyeSB7IEJvb2xlYW4ucHJvdG90eXBlLnZhbHVlT2YuY2FsbChSZWZsZWN0LmNvbnN0cnVjdChCb29sZWFuLCBbXSwgZnVuY3Rpb24gKCkge30pKTsgcmV0dXJuIHRydWU7IH0gY2F0Y2ggKGUpIHsgcmV0dXJuIGZhbHNlOyB9IH0KCi8vIEB0cy1ub2NoZWNrCmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7CmltcG9ydCB7IFN3YXBJbnRlcmZhY2UsIGNvbnN0YW50cywgdXRpbCB9IGZyb20gJ3N3YXAuYXBwJzsKaW1wb3J0IEJpZ051bWJlciBmcm9tICdiaWdudW1iZXIuanMnOwppbXBvcnQgYml0Y29yZSBmcm9tICdnaG9zdC1iaXRjb3JlLWxpYic7CnZhciBQcml2YXRlS2V5ID0gYml0Y29yZS5Qcml2YXRlS2V5Owp2YXIgQnVmZmVyVXRpbCA9IGJpdGNvcmUudXRpbC5idWZmZXI7Cgp2YXIgR2hvc3RTd2FwID0gLyojX19QVVJFX18qL2Z1bmN0aW9uIChfU3dhcEludGVyZmFjZSkgewogIF9pbmhlcml0cyhHaG9zdFN3YXAsIF9Td2FwSW50ZXJmYWNlKTsKCiAgdmFyIF9zdXBlciA9IF9jcmVhdGVTdXBlcihHaG9zdFN3YXApOwoKICAvKioNCiAgICoNCiAgICogQHBhcmFtIG9wdGlvbnMNCiAgICogQHBhcmFtIG9wdGlvbnMuZmV0Y2hCYWxhbmNlDQogICAqIEBwYXJhbSBvcHRpb25zLmZldGNoVW5zcGVudHMNCiAgICogQHBhcmFtIG9wdGlvbnMuYnJvYWRjYXN0VHgNCiAgICogQHBhcmFtIG9wdGlvbnMuZmV0Y2hUeEluZm8geyh0eF9oYXNoKSA9PiBQcm9taXNlKHsgY29uZmlkZW5jZSwgZmVlcyB9KX0NCiAgICogQHBhcmFtIG9wdGlvbnMuZXN0aW1hdGVGZWVWYWx1ZSB7ICh7IGluU2F0b3NoaXMsIHNwZWVkLCBhZGRyZXNzLCB0eFNpemUgfSkgPT4gUHJvbWlzZShmZWVfdmFsdWUpIH0NCiAgICovCiAgZnVuY3Rpb24gR2hvc3RTd2FwKG9wdGlvbnMpIHsKICAgIHZhciBfdGhpczsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgR2hvc3RTd2FwKTsKCiAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIl9zd2FwTmFtZSIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZmV0Y2hCYWxhbmNlIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJmZXRjaFVuc3BlbnRzIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJicm9hZGNhc3RUeCIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiY2hlY2tXaXRoZHJhdyIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZmVlVmFsdWUiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImZldGNoVHhJbmZvIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJlc3RpbWF0ZUZlZVZhbHVlIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJhcHAiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIm5ldHdvcmsiLCB2b2lkIDApOwoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5mZXRjaEJhbGFuY2UgIT09ICdmdW5jdGlvbicpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdHaG9zdFN3YXA6ICJmZXRjaEJhbGFuY2UiIHJlcXVpcmVkJyk7CiAgICB9CgogICAgaWYgKHR5cGVvZiBvcHRpb25zLmZldGNoVW5zcGVudHMgIT09ICdmdW5jdGlvbicpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdHaG9zdFN3YXA6ICJmZXRjaFVuc3BlbnRzIiByZXF1aXJlZCcpOwogICAgfQoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5icm9hZGNhc3RUeCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dob3N0U3dhcDogImJyb2FkY2FzdFR4IiByZXF1aXJlZCcpOwogICAgfQoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5mZXRjaFR4SW5mbyAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAvLyB0eF9oYXNoID0+IHsgY29uZmlkZW5jZSwgZmVlcyB9CiAgICAgIGNvbnNvbGUud2FybigiR2hvc3RTd2FwOiBcImZldGNoVHhJbmZvXCIgaXMgbm90IGEgZnVuY3Rpb24uIFlvdSB3aWxsIG5vdCBiZSBhYmxlIHRvIHVzZSB0eC1jb25maWRlbmNlIGZlYXR1cmUiKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIG9wdGlvbnMuZXN0aW1hdGVGZWVWYWx1ZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAvLyAoeyBzcGVlZCB9ID0ge30pID0+IGZlZVJhdGUKICAgICAgY29uc29sZS53YXJuKCJHaG9zdFN3YXA6IFwiZXN0aW1hdGVGZWVWYWx1ZVwiIGlzIG5vdCBhIGZ1bmN0aW9uLiBZb3Ugd2lsbCBub3QgYmUgYWJsZSB1c2UgYXV0b21hdGljIG1lbXBvb2wtYmFzZWQgZmVlIik7CiAgICB9CgogICAgX3RoaXMuX3N3YXBOYW1lID0gY29uc3RhbnRzLkNPSU5TLmdob3N0OwogICAgX3RoaXMuZmV0Y2hCYWxhbmNlID0gb3B0aW9ucy5mZXRjaEJhbGFuY2U7CiAgICBfdGhpcy5mZXRjaFVuc3BlbnRzID0gb3B0aW9ucy5mZXRjaFVuc3BlbnRzOwogICAgX3RoaXMuYnJvYWRjYXN0VHggPSBvcHRpb25zLmJyb2FkY2FzdFR4OwogICAgX3RoaXMuY2hlY2tXaXRoZHJhdyA9IG9wdGlvbnMuY2hlY2tXaXRoZHJhdzsKICAgIF90aGlzLmZlZVZhbHVlID0gb3B0aW9ucy5mZWVWYWx1ZSB8fCA1NDY7CgogICAgX3RoaXMuZmV0Y2hUeEluZm8gPSBvcHRpb25zLmZldGNoVHhJbmZvIHx8IGZ1bmN0aW9uICgpIHt9OwoKICAgIF90aGlzLmVzdGltYXRlRmVlVmFsdWUgPSBvcHRpb25zLmVzdGltYXRlRmVlVmFsdWUgfHwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gMDsKICAgIH07CgogICAgcmV0dXJuIF90aGlzOwogIH0KCiAgX2NyZWF0ZUNsYXNzKEdob3N0U3dhcCwgW3sKICAgIGtleTogIl9pbml0U3dhcCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2luaXRTd2FwKGFwcCkgewogICAgICBfZ2V0KF9nZXRQcm90b3R5cGVPZihHaG9zdFN3YXAucHJvdG90eXBlKSwgIl9pbml0U3dhcCIsIHRoaXMpLmNhbGwodGhpcywgYXBwKTsKCiAgICAgIHRoaXMuYXBwID0gYXBwOwogICAgICB0aGlzLm5ldHdvcmsgPSB0aGlzLmFwcC5zZXJ2aWNlcy5hdXRoLmFjY291bnRzLmdob3N0Lm5ldHdvcms7IC8vIFRPRE86IHRlbXBsZXNzIHNvbHV0aW9uLCB0cnkgdG8gZmluZCBiZXR0ZXIgc29sdXRpb24KICAgIH0KICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMNCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IG9wdGlvbnMuaW5TYXRvc2hpcw0KICAgICAqIEBwYXJhbSB7TnVtYmVyfSBvcHRpb25zLnNpemUNCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gb3B0aW9ucy5zcGVlZA0KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBvcHRpb25zLmFkZHJlc3MNCiAgICAgKiBAcmV0dXJucyB7QmlnTnVtYmVyfQ0KICAgICAqIEBwdWJsaWMNCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2V0VHhGZWUiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9nZXRUeEZlZSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUoX3JlZikgewogICAgICAgIHZhciBpblNhdG9zaGlzLCBzaXplLCBfcmVmJHNwZWVkLCBzcGVlZCwgYWRkcmVzcywgZXN0aW1hdGVkRmVlOwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgaW5TYXRvc2hpcyA9IF9yZWYuaW5TYXRvc2hpcywgc2l6ZSA9IF9yZWYuc2l6ZSwgX3JlZiRzcGVlZCA9IF9yZWYuc3BlZWQsIHNwZWVkID0gX3JlZiRzcGVlZCA9PT0gdm9pZCAwID8gJ2Zhc3QnIDogX3JlZiRzcGVlZCwgYWRkcmVzcyA9IF9yZWYuYWRkcmVzczsKICAgICAgICAgICAgICAgIF9jb250ZXh0LnQwID0gQmlnTnVtYmVyOwogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lc3RpbWF0ZUZlZVZhbHVlKHsKICAgICAgICAgICAgICAgICAgaW5TYXRvc2hpczogaW5TYXRvc2hpcywKICAgICAgICAgICAgICAgICAgYWRkcmVzczogYWRkcmVzcywKICAgICAgICAgICAgICAgICAgc3BlZWQ6IHNwZWVkLAogICAgICAgICAgICAgICAgICBtZXRob2Q6ICdzd2FwJywKICAgICAgICAgICAgICAgICAgdHhTaXplOiBzaXplCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgX2NvbnRleHQudDEgPSBfY29udGV4dC5zZW50OwogICAgICAgICAgICAgICAgZXN0aW1hdGVkRmVlID0gbmV3IF9jb250ZXh0LnQwKF9jb250ZXh0LnQxKTsKICAgICAgICAgICAgICAgIHRoaXMuZmVlVmFsdWUgPSBlc3RpbWF0ZWRGZWU7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuYWJydXB0KCJyZXR1cm4iLCBpblNhdG9zaGlzID8gZXN0aW1hdGVkRmVlIDogZXN0aW1hdGVkRmVlLmRpdmlkZWRCeSgxZTgpLmRwKDAsIEJpZ051bWJlci5ST1VORF9VUCkpOwoKICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gZ2V0VHhGZWUoX3gpIHsKICAgICAgICByZXR1cm4gX2dldFR4RmVlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBnZXRUeEZlZTsKICAgIH0oKQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge2FycmF5fSB1bnNwZW50cw0KICAgICAqIEBwYXJhbSB7TnVtYmVyfSBleHBlY3RlZENvbmZpZGVuY2VMZXZlbA0KICAgICAqIEByZXR1cm5zIHthcnJheX0NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJmaWx0ZXJDb25maWRlbnRVbnNwZW50cyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2ZpbHRlckNvbmZpZGVudFVuc3BlbnRzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTQodW5zcGVudHMpIHsKICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgICAgdmFyIGV4cGVjdGVkQ29uZmlkZW5jZUxldmVsLAogICAgICAgICAgICBmZWVzVG9Db25maWRlbmNlLAogICAgICAgICAgICBjb25maXJtYXRpb25zVG9Db25maWRlbmNlLAogICAgICAgICAgICBmZXRjaENvbmZpZGVuY2UsCiAgICAgICAgICAgIGNvbmZpZGVuY2VzLAogICAgICAgICAgICBfYXJnczQgPSBhcmd1bWVudHM7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NC5wcmV2ID0gX2NvbnRleHQ0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBleHBlY3RlZENvbmZpZGVuY2VMZXZlbCA9IF9hcmdzNC5sZW5ndGggPiAxICYmIF9hcmdzNFsxXSAhPT0gdW5kZWZpbmVkID8gX2FyZ3M0WzFdIDogMC45NTsKCiAgICAgICAgICAgICAgICBmZWVzVG9Db25maWRlbmNlID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWYyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIoZmVlcywgc2l6ZSwgYWRkcmVzcykgewogICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50RmFzdGVzdEZlZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUyJChfY29udGV4dDIpIHsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyLnByZXYgPSBfY29udGV4dDIubmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczIuZ2V0VHhGZWUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpblNhdG9zaGlzOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplOiBzaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVlZDogJ2Zhc3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEZhc3Rlc3RGZWUgPSBfY29udGV4dDIuc2VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuYWJydXB0KCJyZXR1cm4iLCBuZXcgQmlnTnVtYmVyKGZlZXMpLmlzTGVzc1RoYW4oY3VycmVudEZhc3Rlc3RGZWUpID8gbmV3IEJpZ051bWJlcihmZWVzKS5kaXZpZGVkQnkoY3VycmVudEZhc3Rlc3RGZWUpLnRvTnVtYmVyKCkgOiAxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUyKTsKICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGZlZXNUb0NvbmZpZGVuY2UoX3gzLCBfeDQsIF94NSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSgpOwoKICAgICAgICAgICAgICAgIGNvbmZpcm1hdGlvbnNUb0NvbmZpZGVuY2UgPSBmdW5jdGlvbiBjb25maXJtYXRpb25zVG9Db25maWRlbmNlKGNvbmZzKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb25mcyA+IDAgPyAxIDogMDsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgZmV0Y2hDb25maWRlbmNlID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWY0ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMoX3JlZjMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdHhpZCwgY29uZmlybWF0aW9ucywgY29uZmlkZW5jZUZyb21Db25maXJtYXRpb25zLCBpbmZvLCBmZWVzLCBzaXplLCBzZW5kZXJBZGRyZXNzOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTMkKF9jb250ZXh0MykgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDMucHJldiA9IF9jb250ZXh0My5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHhpZCA9IF9yZWYzLnR4aWQsIGNvbmZpcm1hdGlvbnMgPSBfcmVmMy5jb25maXJtYXRpb25zOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlkZW5jZUZyb21Db25maXJtYXRpb25zID0gY29uZmlybWF0aW9uc1RvQ29uZmlkZW5jZShjb25maXJtYXRpb25zKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5ldyBCaWdOdW1iZXIoY29uZmlkZW5jZUZyb21Db25maXJtYXRpb25zKS5pc0dyZWF0ZXJUaGFuT3JFcXVhbFRvKGV4cGVjdGVkQ29uZmlkZW5jZUxldmVsKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuYWJydXB0KCJyZXR1cm4iLCBjb25maWRlbmNlRnJvbUNvbmZpcm1hdGlvbnMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMucHJldiA9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMyLmZldGNoVHhJbmZvKHR4aWQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmZvID0gX2NvbnRleHQzLnNlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZWVzID0gaW5mby5mZWVzLCBzaXplID0gaW5mby5zaXplLCBzZW5kZXJBZGRyZXNzID0gaW5mby5zZW5kZXJBZGRyZXNzOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZmVlcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDEzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDEyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZlZXNUb0NvbmZpZGVuY2UoZmVlcywgc2l6ZSwgc2VuZGVyQWRkcmVzcyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLmFicnVwdCgicmV0dXJuIiwgX2NvbnRleHQzLnNlbnQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ0eGluZm89Ii5jb25jYXQoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maXJtYXRpb25zOiBjb25maXJtYXRpb25zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZWVzOiBmZWVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplOiBzaXplLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kZXJBZGRyZXNzOiBzZW5kZXJBZGRyZXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMucHJldiA9IDE2OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzLnQwID0gX2NvbnRleHQzWyJjYXRjaCJdKDQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiR2hvc3RTd2FwOiBFcnJvciBmZXRjaGluZyBjb25maWRlbmNlOiB1c2luZyBjb25maXJtYXRpb25zID4gMDoiLCBfY29udGV4dDMudDAubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLmFicnVwdCgicmV0dXJuIiwgY29uZmlkZW5jZUZyb21Db25maXJtYXRpb25zKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyMDoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMywgbnVsbCwgW1s0LCAxNl1dKTsKICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGZldGNoQ29uZmlkZW5jZShfeDYpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZjQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oKTsKCiAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDY7CiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwodW5zcGVudHMubWFwKGZldGNoQ29uZmlkZW5jZSkpOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICBjb25maWRlbmNlcyA9IF9jb250ZXh0NC5zZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5hYnJ1cHQoInJldHVybiIsIHVuc3BlbnRzLmZpbHRlcihmdW5jdGlvbiAodXR4bywgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpzd2FwcycpKCJjb25maWRlbmNlWyIuY29uY2F0KGluZGV4LCAiXToiKSwgY29uZmlkZW5jZXNbaW5kZXhdKTsgLy9ACgogICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEJpZ051bWJlcihjb25maWRlbmNlc1tpbmRleF0pLmlzR3JlYXRlclRoYW5PckVxdWFsVG8oZXhwZWN0ZWRDb25maWRlbmNlTGV2ZWwpOwogICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTQpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBmaWx0ZXJDb25maWRlbnRVbnNwZW50cyhfeDIpIHsKICAgICAgICByZXR1cm4gX2ZpbHRlckNvbmZpZGVudFVuc3BlbnRzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBmaWx0ZXJDb25maWRlbnRVbnNwZW50czsKICAgIH0oKQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhLnNjcmlwdA0KICAgICAqIEBwYXJhbSB7Kn0gZGF0YS50eA0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLnNlY3JldA0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbnB1dEluZGV4DQogICAgICogQHByaXZhdGUNCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiX3NpZ25UcmFuc2FjdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3NpZ25UcmFuc2FjdGlvbihkYXRhKSB7CiAgICAgIHZhciBpbnB1dEluZGV4ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiAwOwogICAgICBkZWJ1Zygnc3dhcC5jb3JlOnN3YXBzJykoJ3NpZ25pbmcgc2NyaXB0IGlucHV0JywgaW5wdXRJbmRleCk7CiAgICAgIHZhciBzY3JpcHQgPSBkYXRhLnNjcmlwdCwKICAgICAgICAgIHR4ID0gZGF0YS50eCwKICAgICAgICAgIHNlY3JldCA9IGRhdGEuc2VjcmV0OwogICAgICB2YXIgaGFzaFR5cGUgPSB0aGlzLmFwcC5lbnYuYml0Y29pbi5UcmFuc2FjdGlvbi5TSUdIQVNIX0FMTDsgLy8gQXQgdGhlIG1vbWVudCB3ZSBhcmUgdXNpbmcgQml0Y29yZSBsaWIgZnJvbSBHaG9zdCB0byBoYW5kbGUgc2lnbmluZyBsb2dpYy4gVE9ETzogcG9ydCBCaXRjb2luanMtbGliIHRvIGJlIGNvbXBhdGlibGUgd2l0aCBHaG9zdCBhbmQKICAgICAgLy8gdG8gYXZvaWQgbGliJ3MgZHVwbGljYXRlCgogICAgICB2YXIgbmV0d29yayA9IHRoaXMuYXBwLmlzTWFpbk5ldCgpID8gYml0Y29yZS5OZXR3b3Jrcy5tYWlubmV0IDogYml0Y29yZS5OZXR3b3Jrcy50ZXN0bmV0OyAvLyBGb3IgcmVmdW5kIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBzZXF1ZW5jZSBudW1iZXIKCiAgICAgIHR4LmlucHV0c1tpbnB1dEluZGV4XS5zZXF1ZW5jZU51bWJlciA9IDQyOTQ5NjcyOTQ7CiAgICAgIHZhciBwcml2YXRlS2V5ID0gbmV3IFByaXZhdGVLZXkodGhpcy5hcHAuc2VydmljZXMuYXV0aC5hY2NvdW50cy5naG9zdC5nZXRQcml2YXRlS2V5KCksIG5ldHdvcmspOwogICAgICB2YXIgc2lnbmF0dXJlID0gYml0Y29yZS5UcmFuc2FjdGlvbi5TaWdoYXNoLnNpZ24odHgsIHByaXZhdGVLZXksIGhhc2hUeXBlLCBpbnB1dEluZGV4LCBzY3JpcHQpOwogICAgICB2YXIgc2lnQnVmZmVyID0gQnVmZmVyVXRpbC5jb25jYXQoW3NpZ25hdHVyZS50b0RFUigpLCBCdWZmZXJVdGlsLmludGVnZXJBc1NpbmdsZUJ5dGVCdWZmZXIoaGFzaFR5cGUpXSk7CiAgICAgIHZhciBwYXltZW50ID0gdGhpcy5hcHAuZW52LmJpdGNvaW4ucGF5bWVudHMucDJzaCh7CiAgICAgICAgcmVkZWVtOiB0aGlzLmFwcC5lbnYuYml0Y29pbi5wYXltZW50cy5wMndzaCh7CiAgICAgICAgICByZWRlZW06IHsKICAgICAgICAgICAgb3V0cHV0OiBzY3JpcHQsCiAgICAgICAgICAgIGlucHV0OiB0aGlzLmFwcC5lbnYuYml0Y29pbi5zY3JpcHQuY29tcGlsZShbc2lnQnVmZmVyLCB0aGlzLmFwcC5zZXJ2aWNlcy5hdXRoLmFjY291bnRzLmdob3N0LmdldFB1YmxpY0tleUJ1ZmZlcigpLCBCdWZmZXIuZnJvbShzZWNyZXQucmVwbGFjZSgvXjB4LywgJycpLCAnaGV4JyldKQogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0pOwogICAgICB0eC5pbnB1dHNbaW5wdXRJbmRleF0uc2V0V2l0bmVzc2VzKHBheW1lbnQud2l0bmVzcyk7CiAgICB9CiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0SGFzaA0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLm93bmVyUHVibGljS2V5DQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucmVjaXBpZW50UHVibGljS2V5DQogICAgICogQHBhcmFtIHtudW1iZXJ9IGRhdGEubG9ja1RpbWUNCiAgICAgKiBAcmV0dXJucyB7e3NjcmlwdEFkZHJlc3M6ICosIHNjcmlwdDogKCp8e2lnbm9yZWR9KX19DQogICAgICovCgogIH0sIHsKICAgIGtleTogImNyZWF0ZVNjcmlwdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlU2NyaXB0KGRhdGEpIHsKICAgICAgdmFyIGhhc2hOYW1lID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiAncmlwZW1kMTYwJzsKICAgICAgdmFyIGhhc2hPcGNvZGVOYW1lID0gIk9QXyIuY29uY2F0KGhhc2hOYW1lLnRvVXBwZXJDYXNlKCkpOwogICAgICB2YXIgaGFzaE9wY29kZSA9IHRoaXMuYXBwLmVudi5iaXRjb2luLm9wY29kZXNbaGFzaE9wY29kZU5hbWVdOwogICAgICB2YXIgc2VjcmV0SGFzaCA9IGRhdGEuc2VjcmV0SGFzaCwKICAgICAgICAgIG93bmVyUHVibGljS2V5ID0gZGF0YS5vd25lclB1YmxpY0tleSwKICAgICAgICAgIHJlY2lwaWVudFB1YmxpY0tleSA9IGRhdGEucmVjaXBpZW50UHVibGljS2V5LAogICAgICAgICAgbG9ja1RpbWUgPSBkYXRhLmxvY2tUaW1lOwogICAgICB2YXIgc2NyaXB0ID0gdGhpcy5hcHAuZW52LmJpdGNvaW4uc2NyaXB0LmNvbXBpbGUoW3RoaXMuYXBwLmVudi5iaXRjb2luLm9wY29kZXMuT1BfU0laRSwgQnVmZmVyLmZyb20oJzIwJywgJ2hleCcpLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5vcGNvZGVzLk9QX0VRVUFMVkVSSUZZLCBoYXNoT3Bjb2RlLCBCdWZmZXIuZnJvbShzZWNyZXRIYXNoLCAnaGV4JyksIHRoaXMuYXBwLmVudi5iaXRjb2luLm9wY29kZXMuT1BfRVFVQUxWRVJJRlksIEJ1ZmZlci5mcm9tKHJlY2lwaWVudFB1YmxpY0tleSwgJ2hleCcpLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5vcGNvZGVzLk9QX0VRVUFMLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5vcGNvZGVzLk9QX0lGLCBCdWZmZXIuZnJvbShyZWNpcGllbnRQdWJsaWNLZXksICdoZXgnKSwgdGhpcy5hcHAuZW52LmJpdGNvaW4ub3Bjb2Rlcy5PUF9FTFNFLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5zY3JpcHQubnVtYmVyLmVuY29kZShsb2NrVGltZSksIHRoaXMuYXBwLmVudi5iaXRjb2luLm9wY29kZXMuT1BfQ0hFQ0tMT0NLVElNRVZFUklGWSwgdGhpcy5hcHAuZW52LmJpdGNvaW4ub3Bjb2Rlcy5PUF9EUk9QLCBCdWZmZXIuZnJvbShvd25lclB1YmxpY0tleSwgJ2hleCcpLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5vcGNvZGVzLk9QX0VORElGLCB0aGlzLmFwcC5lbnYuYml0Y29pbi5vcGNvZGVzLk9QX0NIRUNLU0lHXSk7CiAgICAgIHZhciBzY3JpcHREYXRhID0gdGhpcy5hcHAuZW52LmJpdGNvaW4ucGF5bWVudHMucDJzaCh7CiAgICAgICAgcmVkZWVtOiB7CiAgICAgICAgICBvdXRwdXQ6IHNjcmlwdCwKICAgICAgICAgIG5ldHdvcms6IHRoaXMubmV0d29yawogICAgICAgIH0sCiAgICAgICAgbmV0d29yazogdGhpcy5uZXR3b3JrCiAgICAgIH0pOwogICAgICB2YXIgc2NyaXB0QWRkcmVzcyA9IHNjcmlwdERhdGEuYWRkcmVzczsKICAgICAgcmV0dXJuIHsKICAgICAgICBzY3JpcHRBZGRyZXNzOiBzY3JpcHRBZGRyZXNzLAogICAgICAgIHNjcmlwdDogc2NyaXB0CiAgICAgIH07CiAgICB9CiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucmVjaXBpZW50UHVibGljS2V5DQogICAgICogQHBhcmFtIHtudW1iZXJ9IGRhdGEubG9ja1RpbWUNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZXhwZWN0ZWQNCiAgICAgKiBAcGFyYW0ge251bWJlcn0gZXhwZWN0ZWQudmFsdWUNCiAgICAgKiBAcGFyYW0ge251bWJlcn0gZXhwZWN0ZWQubG9ja1RpbWUNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwZWN0ZWQucmVjaXBpZW50UHVibGljS2V5DQogICAgICogQHJldHVybnMge1Byb21pc2UuPHN0cmluZz59DQogICAgICovCgogIH0sIHsKICAgIGtleTogImNoZWNrU2NyaXB0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfY2hlY2tTY3JpcHQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNShkYXRhLCBleHBlY3RlZCwgaGFzaE5hbWUpIHsKICAgICAgICB2YXIgcmVjaXBpZW50UHVibGljS2V5LCBsb2NrVGltZSwgX3RoaXMkY3JlYXRlU2NyaXB0LCBzY3JpcHRBZGRyZXNzLCBzY3JpcHQsIGV4cGVjdGVkQ29uZmlkZW5jZSwgdW5zcGVudHMsIGV4cGVjdGVkVmFsdWUsIHRvdGFsVW5zcGVudCwgY29uZmlkZW50VW5zcGVudHMsIHRvdGFsQ29uZmlkZW50VW5zcGVudDsKCiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNSQoX2NvbnRleHQ1KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NS5wcmV2ID0gX2NvbnRleHQ1Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICByZWNpcGllbnRQdWJsaWNLZXkgPSBkYXRhLnJlY2lwaWVudFB1YmxpY0tleSwgbG9ja1RpbWUgPSBkYXRhLmxvY2tUaW1lOwogICAgICAgICAgICAgICAgX3RoaXMkY3JlYXRlU2NyaXB0ID0gdGhpcy5jcmVhdGVTY3JpcHQoZGF0YSwgaGFzaE5hbWUpLCBzY3JpcHRBZGRyZXNzID0gX3RoaXMkY3JlYXRlU2NyaXB0LnNjcmlwdEFkZHJlc3MsIHNjcmlwdCA9IF90aGlzJGNyZWF0ZVNjcmlwdC5zY3JpcHQ7CiAgICAgICAgICAgICAgICBleHBlY3RlZENvbmZpZGVuY2UgPSBleHBlY3RlZC5jb25maWRlbmNlIHx8IDAuOTU7CiAgICAgICAgICAgICAgICBfY29udGV4dDUubmV4dCA9IDU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mZXRjaFVuc3BlbnRzKHNjcmlwdEFkZHJlc3MpOwoKICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICB1bnNwZW50cyA9IF9jb250ZXh0NS5zZW50OwogICAgICAgICAgICAgICAgZXhwZWN0ZWRWYWx1ZSA9IGV4cGVjdGVkLnZhbHVlLm11bHRpcGxpZWRCeSgxZTgpLmludGVnZXJWYWx1ZSgpOwogICAgICAgICAgICAgICAgdG90YWxVbnNwZW50ID0gdW5zcGVudHMucmVkdWNlKGZ1bmN0aW9uIChzdW1tLCBfcmVmNSkgewogICAgICAgICAgICAgICAgICB2YXIgc2F0b3NoaXMgPSBfcmVmNS5zYXRvc2hpczsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1bW0gKyBzYXRvc2hpczsKICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICAgICAgX2NvbnRleHQ1Lm5leHQgPSAxMDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbHRlckNvbmZpZGVudFVuc3BlbnRzKHVuc3BlbnRzLCBleHBlY3RlZENvbmZpZGVuY2UpOwoKICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgY29uZmlkZW50VW5zcGVudHMgPSBfY29udGV4dDUuc2VudDsKICAgICAgICAgICAgICAgIHRvdGFsQ29uZmlkZW50VW5zcGVudCA9IGNvbmZpZGVudFVuc3BlbnRzLnJlZHVjZShmdW5jdGlvbiAoc3VtbSwgX3JlZjYpIHsKICAgICAgICAgICAgICAgICAgdmFyIHNhdG9zaGlzID0gX3JlZjYuc2F0b3NoaXM7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzdW1tICsgc2F0b3NoaXM7CiAgICAgICAgICAgICAgICB9LCAwKTsKCiAgICAgICAgICAgICAgICBpZiAoIWV4cGVjdGVkVmFsdWUuaXNHcmVhdGVyVGhhbih0b3RhbFVuc3BlbnQpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NS5uZXh0ID0gMTQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuYWJydXB0KCJyZXR1cm4iLCAiRXhwZWN0ZWQgc2NyaXB0IHZhbHVlOiAiLmNvbmNhdChleHBlY3RlZFZhbHVlLnRvTnVtYmVyKCksICIsIGdvdDogIikuY29uY2F0KHRvdGFsVW5zcGVudCwgIiwgYWRkcmVzczogIikuY29uY2F0KHNjcmlwdEFkZHJlc3MpKTsKCiAgICAgICAgICAgICAgY2FzZSAxNDoKICAgICAgICAgICAgICAgIGlmICghKGV4cGVjdGVkLmxvY2tUaW1lID4gbG9ja1RpbWUpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NS5uZXh0ID0gMTY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuYWJydXB0KCJyZXR1cm4iLCAiRXhwZWN0ZWQgc2NyaXB0IGxvY2tUaW1lOiAiLmNvbmNhdChleHBlY3RlZC5sb2NrVGltZSwgIiwgZ290OiAiKS5jb25jYXQobG9ja1RpbWUsICIsIGFkZHJlc3M6ICIpLmNvbmNhdChzY3JpcHRBZGRyZXNzKSk7CgogICAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgICAgICBpZiAoIShleHBlY3RlZC5yZWNpcGllbnRQdWJsaWNLZXkgIT09IHJlY2lwaWVudFB1YmxpY0tleSkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ1Lm5leHQgPSAxODsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5hYnJ1cHQoInJldHVybiIsICJFeHBlY3RlZCBzY3JpcHQgcmVjaXBpZW50IHB1YmxpY0tleTogIi5jb25jYXQoZXhwZWN0ZWQucmVjaXBpZW50UHVibGljS2V5LCAiLCBnb3Q6ICIpLmNvbmNhdChyZWNpcGllbnRQdWJsaWNLZXkpKTsKCiAgICAgICAgICAgICAgY2FzZSAxODoKICAgICAgICAgICAgICAgIGlmICghZXhwZWN0ZWRWYWx1ZS5pc0dyZWF0ZXJUaGFuKHRvdGFsQ29uZmlkZW50VW5zcGVudCkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ1Lm5leHQgPSAyMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5hYnJ1cHQoInJldHVybiIsICJFeHBlY3RlZCBzY3JpcHQgdmFsdWU6ICIuY29uY2F0KGV4cGVjdGVkVmFsdWUudG9TdHJpbmcoKSwgIiB3aXRoIGNvbmZpZGVuY2UgYWJvdmUgIikuY29uY2F0KGV4cGVjdGVkQ29uZmlkZW5jZSwgIiwgZ290OiAiKS5jb25jYXQodG90YWxDb25maWRlbnRVbnNwZW50LCAiLCBhZGRyZXNzOiAiKS5jb25jYXQoc2NyaXB0QWRkcmVzcykpOwoKICAgICAgICAgICAgICBjYXNlIDIwOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ1LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU1LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gY2hlY2tTY3JpcHQoX3g3LCBfeDgsIF94OSkgewogICAgICAgIHJldHVybiBfY2hlY2tTY3JpcHQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNoZWNrU2NyaXB0OwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEuc2NyaXB0VmFsdWVzDQogICAgICogQHBhcmFtIHtCaWdOdW1iZXJ9IGRhdGEuYW1vdW50DQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlVHJhbnNhY3Rpb25IYXNoDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhc2hOYW1lDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImZ1bmRTY3JpcHQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGZ1bmRTY3JpcHQoZGF0YSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoLCBoYXNoTmFtZSkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHZhciBzY3JpcHRWYWx1ZXMgPSBkYXRhLnNjcmlwdFZhbHVlcywKICAgICAgICAgIGFtb3VudCA9IGRhdGEuYW1vdW50OwogICAgICByZXR1cm4gbmV3IFByb21pc2UoIC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIF9yZWY3ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTYocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICB2YXIgX3RoaXMzJGNyZWF0ZVNjcmlwdCwgc2NyaXB0QWRkcmVzcywgb3duZXJBZGRyZXNzLCB1bnNwZW50cywgZnVuZFZhbHVlLCBmZWVWYWx1ZUJOLCBmZWVWYWx1ZSwgdG90YWxVbnNwZW50LCBza2lwVmFsdWUsIHRyYW5zYWN0aW9uLCByZXN1bHQ7CgogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNiQoX2NvbnRleHQ2KSB7CiAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDYucHJldiA9IF9jb250ZXh0Ni5uZXh0KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5wcmV2ID0gMDsKICAgICAgICAgICAgICAgICAgX3RoaXMzJGNyZWF0ZVNjcmlwdCA9IF90aGlzMy5jcmVhdGVTY3JpcHQoc2NyaXB0VmFsdWVzLCBoYXNoTmFtZSksIHNjcmlwdEFkZHJlc3MgPSBfdGhpczMkY3JlYXRlU2NyaXB0LnNjcmlwdEFkZHJlc3M7CiAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzcyA9IF90aGlzMy5hcHAuc2VydmljZXMuYXV0aC5hY2NvdW50cy5naG9zdC5nZXRBZGRyZXNzKCk7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gNTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMy5mZXRjaFVuc3BlbnRzKG93bmVyQWRkcmVzcyk7CgogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICB1bnNwZW50cyA9IF9jb250ZXh0Ni5zZW50OwogICAgICAgICAgICAgICAgICBmdW5kVmFsdWUgPSBhbW91bnQubXVsdGlwbGllZEJ5KDFlOCkuaW50ZWdlclZhbHVlKCkudG9OdW1iZXIoKTsgLy9ACgogICAgICAgICAgICAgICAgICBfY29udGV4dDYubmV4dCA9IDk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczMuZ2V0VHhGZWUoewogICAgICAgICAgICAgICAgICAgIGluU2F0b3NoaXM6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYWRkcmVzczogb3duZXJBZGRyZXNzCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhc2UgOToKICAgICAgICAgICAgICAgICAgZmVlVmFsdWVCTiA9IF9jb250ZXh0Ni5zZW50OwogICAgICAgICAgICAgICAgICBmZWVWYWx1ZSA9IGZlZVZhbHVlQk4uaW50ZWdlclZhbHVlKCkudG9OdW1iZXIoKTsKICAgICAgICAgICAgICAgICAgdG90YWxVbnNwZW50ID0gdW5zcGVudHMucmVkdWNlKGZ1bmN0aW9uIChzdW1tLCBfcmVmOCkgewogICAgICAgICAgICAgICAgICAgIHZhciBzYXRvc2hpcyA9IF9yZWY4LnNhdG9zaGlzOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdW1tICsgc2F0b3NoaXM7CiAgICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICAgICAgICBza2lwVmFsdWUgPSB0b3RhbFVuc3BlbnQgLSBmdW5kVmFsdWUgLSBmZWVWYWx1ZTsKCiAgICAgICAgICAgICAgICAgIGlmICghKHRvdGFsVW5zcGVudCA8IGZlZVZhbHVlICsgZnVuZFZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMTU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVG90YWwgbGVzcyB0aGFuIGZlZTogIi5jb25jYXQodG90YWxVbnNwZW50LCAiIDwgIikuY29uY2F0KGZlZVZhbHVlLCAiICsgIikuY29uY2F0KGZ1bmRWYWx1ZSkpOwoKICAgICAgICAgICAgICAgIGNhc2UgMTU6CiAgICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uID0gbmV3IGJpdGNvcmUuVHJhbnNhY3Rpb24oKS5mcm9tKHVuc3BlbnRzKS50byhzY3JpcHRBZGRyZXNzLCBmdW5kVmFsdWUpLmNoYW5nZShfdGhpczMuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHMuZ2hvc3QuZ2V0QWRkcmVzcygpKS5zaWduKF90aGlzMy5hcHAuc2VydmljZXMuYXV0aC5hY2NvdW50cy5naG9zdC5nZXRQcml2YXRlS2V5KCkpOwoKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBoYW5kbGVUcmFuc2FjdGlvbkhhc2ggPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICBoYW5kbGVUcmFuc2FjdGlvbkhhc2godHJhbnNhY3Rpb24udG9PYmplY3QoKS50eGlkKTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ2LnByZXYgPSAxNzsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSAyMDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMy5icm9hZGNhc3RUeChTdHJpbmcodHJhbnNhY3Rpb24uc2VyaWFsaXplKCkpKTsKCiAgICAgICAgICAgICAgICBjYXNlIDIwOgogICAgICAgICAgICAgICAgICByZXN1bHQgPSBfY29udGV4dDYuc2VudDsKICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpOwogICAgICAgICAgICAgICAgICBfY29udGV4dDYubmV4dCA9IDI3OwogICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICAgICAgICBfY29udGV4dDYucHJldiA9IDI0OwogICAgICAgICAgICAgICAgICBfY29udGV4dDYudDAgPSBfY29udGV4dDZbImNhdGNoIl0oMTcpOwogICAgICAgICAgICAgICAgICByZWplY3QoX2NvbnRleHQ2LnQwKTsKCiAgICAgICAgICAgICAgICBjYXNlIDI3OgogICAgICAgICAgICAgICAgICBfY29udGV4dDYubmV4dCA9IDMyOwogICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlIDI5OgogICAgICAgICAgICAgICAgICBfY29udGV4dDYucHJldiA9IDI5OwogICAgICAgICAgICAgICAgICBfY29udGV4dDYudDEgPSBfY29udGV4dDZbImNhdGNoIl0oMCk7CiAgICAgICAgICAgICAgICAgIHJlamVjdChfY29udGV4dDYudDEpOwoKICAgICAgICAgICAgICAgIGNhc2UgMzI6CiAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ2LnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIF9jYWxsZWU2LCBudWxsLCBbWzAsIDI5XSwgWzE3LCAyNF1dKTsKICAgICAgICB9KSk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoX3gxMCwgX3gxMSkgewogICAgICAgICAgcmV0dXJuIF9yZWY3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgICAgfSgpKTsKICAgIH0KICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R8c3RyaW5nfSBkYXRhIC0gc2NyaXB0VmFsdWVzIG9yIHdhbGxldCBhZGRyZXNzDQogICAgICogQHJldHVybnMge1Byb21pc2UuPHZvaWQ+fQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZXRCYWxhbmNlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfZ2V0QmFsYW5jZSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU3KGRhdGEsIGhhc2hOYW1lKSB7CiAgICAgICAgdmFyIGFkZHJlc3MsIF90aGlzJGNyZWF0ZVNjcmlwdDIsIHNjcmlwdEFkZHJlc3MsIHVuc3BlbnRzLCB0b3RhbFVuc3BlbnQ7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTckKF9jb250ZXh0NykgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDcucHJldiA9IF9jb250ZXh0Ny5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgaWYgKCEodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDcubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGFkZHJlc3MgPSBkYXRhOwogICAgICAgICAgICAgICAgX2NvbnRleHQ3Lm5leHQgPSAxMDsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICBpZiAoIShfdHlwZW9mKGRhdGEpID09PSAnb2JqZWN0JykpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ3Lm5leHQgPSA5OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfdGhpcyRjcmVhdGVTY3JpcHQyID0gdGhpcy5jcmVhdGVTY3JpcHQoZGF0YSwgaGFzaE5hbWUpLCBzY3JpcHRBZGRyZXNzID0gX3RoaXMkY3JlYXRlU2NyaXB0Mi5zY3JpcHRBZGRyZXNzOwogICAgICAgICAgICAgICAgYWRkcmVzcyA9IHNjcmlwdEFkZHJlc3M7CiAgICAgICAgICAgICAgICBfY29udGV4dDcubmV4dCA9IDEwOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgOToKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignV3JvbmcgZGF0YSB0eXBlJyk7CgogICAgICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICAgICAgICBfY29udGV4dDcubmV4dCA9IDEyOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmV0Y2hVbnNwZW50cyhhZGRyZXNzKTsKCiAgICAgICAgICAgICAgY2FzZSAxMjoKICAgICAgICAgICAgICAgIHVuc3BlbnRzID0gX2NvbnRleHQ3LnNlbnQ7CiAgICAgICAgICAgICAgICB0b3RhbFVuc3BlbnQgPSB1bnNwZW50cyAmJiB1bnNwZW50cy5sZW5ndGggJiYgdW5zcGVudHMucmVkdWNlKGZ1bmN0aW9uIChzdW1tLCBfcmVmOSkgewogICAgICAgICAgICAgICAgICB2YXIgc2F0b3NoaXMgPSBfcmVmOS5zYXRvc2hpczsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1bW0gKyBzYXRvc2hpczsKICAgICAgICAgICAgICAgIH0sIDApIHx8IDA7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ3LmFicnVwdCgicmV0dXJuIiwgdG90YWxVbnNwZW50KTsKCiAgICAgICAgICAgICAgY2FzZSAxNToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNywgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGdldEJhbGFuY2UoX3gxMiwgX3gxMykgewogICAgICAgIHJldHVybiBfZ2V0QmFsYW5jZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZ2V0QmFsYW5jZTsKICAgIH0oKQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhLnNjcmlwdFZhbHVlcw0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLnNlY3JldA0KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNSZWZ1bmQNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2V0V2l0aGRyYXdSYXdUcmFuc2FjdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2dldFdpdGhkcmF3UmF3VHJhbnNhY3Rpb24gPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlOChkYXRhLCBpc1JlZnVuZCwgaGFzaE5hbWUpIHsKICAgICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgICAgdmFyIHNjcmlwdFZhbHVlcywgc2VjcmV0LCBkZXN0aW5hdGlvbkFkZHJlc3MsIGRlc3RBZGRyZXNzLCBfdGhpcyRjcmVhdGVTY3JpcHQzLCBzY3JpcHQsIHNjcmlwdEFkZHJlc3MsIHVuc3BlbnRzLCBmZWVWYWx1ZUJOLCBmZWVWYWx1ZSwgdG90YWxVbnNwZW50LCBoYXNXaXRoZHJhdywgdHgsIHR4SGV4LCB0eElkOwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU4JChfY29udGV4dDgpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ4LnByZXYgPSBfY29udGV4dDgubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlcyA9IGRhdGEuc2NyaXB0VmFsdWVzLCBzZWNyZXQgPSBkYXRhLnNlY3JldCwgZGVzdGluYXRpb25BZGRyZXNzID0gZGF0YS5kZXN0aW5hdGlvbkFkZHJlc3M7CiAgICAgICAgICAgICAgICBkZXN0QWRkcmVzcyA9IGRlc3RpbmF0aW9uQWRkcmVzcyA/IGRlc3RpbmF0aW9uQWRkcmVzcyA6IHRoaXMuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHMuZ2hvc3QuZ2V0QWRkcmVzcygpOwogICAgICAgICAgICAgICAgX3RoaXMkY3JlYXRlU2NyaXB0MyA9IHRoaXMuY3JlYXRlU2NyaXB0KHNjcmlwdFZhbHVlcywgaGFzaE5hbWUpLCBzY3JpcHQgPSBfdGhpcyRjcmVhdGVTY3JpcHQzLnNjcmlwdCwgc2NyaXB0QWRkcmVzcyA9IF90aGlzJGNyZWF0ZVNjcmlwdDMuc2NyaXB0QWRkcmVzczsKICAgICAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gNTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZldGNoVW5zcGVudHMoc2NyaXB0QWRkcmVzcyk7CgogICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgIHVuc3BlbnRzID0gX2NvbnRleHQ4LnNlbnQ7CiAgICAgICAgICAgICAgICBfY29udGV4dDgubmV4dCA9IDg7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRUeEZlZSh7CiAgICAgICAgICAgICAgICAgIGluU2F0b3NoaXM6IHRydWUsCiAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IHNjcmlwdEFkZHJlc3MKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICBmZWVWYWx1ZUJOID0gX2NvbnRleHQ4LnNlbnQ7CiAgICAgICAgICAgICAgICBmZWVWYWx1ZSA9IGZlZVZhbHVlQk4uaW50ZWdlclZhbHVlKCkudG9OdW1iZXIoKTsKICAgICAgICAgICAgICAgIHRvdGFsVW5zcGVudCA9IHVuc3BlbnRzLnJlZHVjZShmdW5jdGlvbiAoc3VtbSwgX3JlZjEwKSB7CiAgICAgICAgICAgICAgICAgIHZhciBzYXRvc2hpcyA9IF9yZWYxMC5zYXRvc2hpczsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1bW0gKyBzYXRvc2hpczsKICAgICAgICAgICAgICAgIH0sIDApOwoKICAgICAgICAgICAgICAgIGlmICghbmV3IEJpZ051bWJlcih0b3RhbFVuc3BlbnQpLmlzTGVzc1RoYW4oZmVlVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gMjQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghKHR5cGVvZiB0aGlzLmNoZWNrV2l0aGRyYXcgPT09ICdmdW5jdGlvbicpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gMjM7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gMTU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVja1dpdGhkcmF3KHNjcmlwdEFkZHJlc3MpOwoKICAgICAgICAgICAgICBjYXNlIDE1OgogICAgICAgICAgICAgICAgaGFzV2l0aGRyYXcgPSBfY29udGV4dDguc2VudDsKCiAgICAgICAgICAgICAgICBpZiAoIShoYXNXaXRoZHJhdyAmJiBoYXNXaXRoZHJhdy5hZGRyZXNzLnRvTG93ZXJDYXNlKCkgPT0gZGVzdEFkZHJlc3MudG9Mb3dlckNhc2UoKSkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ4Lm5leHQgPSAyMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OC5hYnJ1cHQoInJldHVybiIsIHsKICAgICAgICAgICAgICAgICAgdHhJZDogaGFzV2l0aGRyYXcudHhpZCwKICAgICAgICAgICAgICAgICAgYWxyZWFkeVdpdGhkcmF3ZWQ6IHRydWUKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDIwOgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUb3RhbCBsZXNzIHRoYW4gZmVlOiAiLmNvbmNhdCh0b3RhbFVuc3BlbnQsICIgPCAiKS5jb25jYXQoZmVlVmFsdWUpKTsKCiAgICAgICAgICAgICAgY2FzZSAyMToKICAgICAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gMjQ7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgY2FzZSAyMzoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVG90YWwgbGVzcyB0aGFuIGZlZTogIi5jb25jYXQodG90YWxVbnNwZW50LCAiIDwgIikuY29uY2F0KGZlZVZhbHVlKSk7CgogICAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgICAgICB0eCA9IG5ldyBiaXRjb3JlLlRyYW5zYWN0aW9uKCk7CgogICAgICAgICAgICAgICAgaWYgKGlzUmVmdW5kKSB7CiAgICAgICAgICAgICAgICAgIHR4LmxvY2tVbnRpbERhdGUoc2NyaXB0VmFsdWVzLmxvY2tUaW1lKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0eC5mcm9tKHVuc3BlbnRzKTsKICAgICAgICAgICAgICAgIHR4LnRvKGRlc3RBZGRyZXNzLCB0b3RhbFVuc3BlbnQgLSBmZWVWYWx1ZSk7IC8vIFNpZ24gaW5wdXQgd2l0bmVzcydzCgogICAgICAgICAgICAgICAgdHguaW5wdXRzLm1hcChmdW5jdGlvbiAoXywgaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzNC5fc2lnblRyYW5zYWN0aW9uKHsKICAgICAgICAgICAgICAgICAgICBzY3JpcHQ6IHNjcmlwdCwKICAgICAgICAgICAgICAgICAgICBzZWNyZXQ6IHNlY3JldCwKICAgICAgICAgICAgICAgICAgICB0eDogdHgKICAgICAgICAgICAgICAgICAgfSwgaW5kZXgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0eEhleCA9IHR4LnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICB0eElkID0gdHgudG9PYmplY3QoKS5oYXNoOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OC5hYnJ1cHQoInJldHVybiIsIHsKICAgICAgICAgICAgICAgICAgdHhIZXg6IHR4SGV4LAogICAgICAgICAgICAgICAgICB0eElkOiB0eElkCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSAzMjoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlOCwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGdldFdpdGhkcmF3UmF3VHJhbnNhY3Rpb24oX3gxNCwgX3gxNSwgX3gxNikgewogICAgICAgIHJldHVybiBfZ2V0V2l0aGRyYXdSYXdUcmFuc2FjdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZ2V0V2l0aGRyYXdSYXdUcmFuc2FjdGlvbjsKICAgIH0oKQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhLnNjcmlwdFZhbHVlcw0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLnNlY3JldA0KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNSZWZ1bmQNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2V0V2l0aGRyYXdIZXhUcmFuc2FjdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2dldFdpdGhkcmF3SGV4VHJhbnNhY3Rpb24gPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlOShkYXRhLCBpc1JlZnVuZCkgewogICAgICAgIHZhciB0eFJhdzsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU5JChfY29udGV4dDkpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ5LnByZXYgPSBfY29udGV4dDkubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0OS5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFdpdGhkcmF3UmF3VHJhbnNhY3Rpb24oZGF0YSwgaXNSZWZ1bmQpOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICB0eFJhdyA9IF9jb250ZXh0OS5zZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OS5hYnJ1cHQoInJldHVybiIsIHR4UmF3LnR4SGV4KTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU5LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gZ2V0V2l0aGRyYXdIZXhUcmFuc2FjdGlvbihfeDE3LCBfeDE4KSB7CiAgICAgICAgcmV0dXJuIF9nZXRXaXRoZHJhd0hleFRyYW5zYWN0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBnZXRXaXRoZHJhd0hleFRyYW5zYWN0aW9uOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEuc2NyaXB0VmFsdWVzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0DQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImdldFJlZnVuZFJhd1RyYW5zYWN0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRSZWZ1bmRSYXdUcmFuc2FjdGlvbihkYXRhKSB7CiAgICAgIHJldHVybiB0aGlzLmdldFdpdGhkcmF3UmF3VHJhbnNhY3Rpb24oZGF0YSwgdHJ1ZSk7CiAgICB9CiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEuc2NyaXB0VmFsdWVzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0DQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImdldFJlZnVuZEhleFRyYW5zYWN0aW9uIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfZ2V0UmVmdW5kSGV4VHJhbnNhY3Rpb24gPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTAoZGF0YSkgewogICAgICAgIHZhciB0eFJhdzsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxMCQoX2NvbnRleHQxMCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDEwLnByZXYgPSBfY29udGV4dDEwLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDEwLm5leHQgPSAyOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UmVmdW5kUmF3VHJhbnNhY3Rpb24oZGF0YSk7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHR4UmF3ID0gX2NvbnRleHQxMC5zZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTAuYWJydXB0KCJyZXR1cm4iLCB0eFJhdy50eEhleCk7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTAuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTEwLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gZ2V0UmVmdW5kSGV4VHJhbnNhY3Rpb24oX3gxOSkgewogICAgICAgIHJldHVybiBfZ2V0UmVmdW5kSGV4VHJhbnNhY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGdldFJlZnVuZEhleFRyYW5zYWN0aW9uOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEuc2NyaXB0VmFsdWVzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0DQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlVHJhbnNhY3Rpb25IYXNoDQogICAgICogQHBhcmFtIHtib29sZWFufSBpc1JlZnVuZA0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoTmFtZQ0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJ3aXRoZHJhdyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gd2l0aGRyYXcoZGF0YSwgaXNSZWZ1bmQsIGhhc2hOYW1lKSB7CiAgICAgIHZhciBfdGhpczUgPSB0aGlzOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfcmVmMTEgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTEocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICB2YXIgdHhSYXcsIHJlc3VsdCwgdHhTdWNjZXNzLCBlcnJvck1lc3NhZ2U7CiAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxMSQoX2NvbnRleHQxMSkgewogICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQxMS5wcmV2ID0gX2NvbnRleHQxMS5uZXh0KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTEucHJldiA9IDA7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTEubmV4dCA9IDM7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczUuZ2V0V2l0aGRyYXdSYXdUcmFuc2FjdGlvbihkYXRhLCBpc1JlZnVuZCwgaGFzaE5hbWUpOwoKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgdHhSYXcgPSBfY29udGV4dDExLnNlbnQ7CgogICAgICAgICAgICAgICAgICBpZiAoIXR4UmF3LmFscmVhZHlXaXRoZHJhd2VkKSB7CiAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gNzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0eFJhdy50eElkKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuYWJydXB0KCJyZXR1cm4iKTsKCiAgICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6c3dhcHMnKSgncmF3IHR4IHdpdGhkcmF3JywgdHhSYXcudHhIZXgpOwogICAgICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSAxMDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzNS5icm9hZGNhc3RUeCh0eFJhdy50eEhleCk7CgogICAgICAgICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gX2NvbnRleHQxMS5zZW50OwogICAgICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSAxMzsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy53YWl0RGVsYXkoMTApOwoKICAgICAgICAgICAgICAgIGNhc2UgMTM6CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTEubmV4dCA9IDE1OwogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXM1LmNoZWNrVFgodHhSYXcudHhJZCk7CgogICAgICAgICAgICAgICAgY2FzZSAxNToKICAgICAgICAgICAgICAgICAgdHhTdWNjZXNzID0gX2NvbnRleHQxMS5zZW50OwoKICAgICAgICAgICAgICAgICAgaWYgKHR4U3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHhSYXcudHhJZCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdHaG9zdFN3YXA6IGNhbnQgd2l0aGRyYXcnLCAnR2VuZXJhdGVkIFRYIG5vdCBmb3VuZCcpOwogICAgICAgICAgICAgICAgICAgIHJlamVjdCgnVFggbm90IGZvdW5kLiBUcnkgaXQgbGF0ZXIuICcpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSAyNDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAxOToKICAgICAgICAgICAgICAgICAgX2NvbnRleHQxMS5wcmV2ID0gMTk7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTEudDAgPSBfY29udGV4dDExWyJjYXRjaCJdKDApOwogICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ0dob3N0U3dhcDogY2FudCB3aXRoZHJhdycsIF9jb250ZXh0MTEudDAubWVzc2FnZSk7CgogICAgICAgICAgICAgICAgICBpZiAoX2NvbnRleHQxMS50MC5yZXMgJiYgL25vbi1maW5hbC8udGVzdChfY29udGV4dDExLnQwLnJlcy50ZXh0KSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9ICdUcnkgaXQgbGF0ZXInOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKC9Ub3RhbCBsZXNzIHRoYW4gZmVlLy50ZXN0KF9jb250ZXh0MTEudDAubWVzc2FnZSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoL1RvdGFsIGxlc3MgdGhhbiBmZWU6IDAvLnRlc3QoX2NvbnRleHQxMS50MC5tZXNzYWdlKSkgewogICAgICAgICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlID0gJ0FkZHJlc3MgaXMgZW1wdHknOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2UgPSAnTGVzcyB0aGFuIGZlZSc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IF9jb250ZXh0MTEudDA7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvck1lc3NhZ2UpOwoKICAgICAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMS5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlMTEsIG51bGwsIFtbMCwgMTldXSk7CiAgICAgICAgfSkpOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKF94MjAsIF94MjEpIHsKICAgICAgICAgIHJldHVybiBfcmVmMTEuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICB9KCkpOwogICAgfQogICAgLyoqDQogICAgICogDQogICAgICogQHBhcmFtIHtzdHJpbmd9IHR4SUQNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiY2hlY2tUWCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2NoZWNrVFggPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTIodHhJRCkgewogICAgICAgIHZhciB0eEluZm87CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMTIkKF9jb250ZXh0MTIpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQxMi5wcmV2ID0gX2NvbnRleHQxMi5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX2NvbnRleHQxMi5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZldGNoVHhJbmZvKHR4SUQpOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICB0eEluZm8gPSBfY29udGV4dDEyLnNlbnQ7CgogICAgICAgICAgICAgICAgaWYgKCEodHhJbmZvICYmIHR4SW5mby5zZW5kZXJBZGRyZXNzICYmIHR4SW5mby50eGlkICYmIHR4SW5mby50eGlkLnRvTG93ZXJDYXNlKCkgPT0gdHhJRC50b0xvd2VyQ2FzZSgpKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDEyLm5leHQgPSA1OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMi5hYnJ1cHQoInJldHVybiIsIHRydWUpOwoKICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMi5hYnJ1cHQoInJldHVybiIsIGZhbHNlKTsKCiAgICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMi5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTIsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBjaGVja1RYKF94MjIpIHsKICAgICAgICByZXR1cm4gX2NoZWNrVFguYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNoZWNrVFg7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YS5zY3JpcHRWYWx1ZXMNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXQNCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBoYW5kbGVUcmFuc2FjdGlvbkhhc2gNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGFzaE5hbWUNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAicmVmdW5kIiwKICAgIHZhbHVlOiBmdW5jdGlvbiByZWZ1bmQoZGF0YSwgaGFzaE5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMud2l0aGRyYXcoZGF0YSwgdHJ1ZSwgaGFzaE5hbWUpOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEdob3N0U3dhcDsKfShTd2FwSW50ZXJmYWNlKTsKCmV4cG9ydCBkZWZhdWx0IEdob3N0U3dhcDs="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.swaps/GhostSwap.ts"],"names":["debug","SwapInterface","constants","util","BigNumber","bitcore","PrivateKey","BufferUtil","buffer","GhostSwap","options","fetchBalance","Error","fetchUnspents","broadcastTx","fetchTxInfo","console","warn","estimateFeeValue","_swapName","COINS","ghost","checkWithdraw","feeValue","app","network","services","auth","accounts","inSatoshis","size","speed","address","method","txSize","estimatedFee","dividedBy","dp","ROUND_UP","unspents","expectedConfidenceLevel","feesToConfidence","fees","getTxFee","currentFastestFee","isLessThan","toNumber","confirmationsToConfidence","confs","fetchConfidence","txid","confirmations","confidenceFromConfirmations","isGreaterThanOrEqualTo","info","senderAddress","error","message","Promise","all","map","confidences","filter","utxo","index","data","inputIndex","script","tx","secret","hashType","env","bitcoin","Transaction","SIGHASH_ALL","isMainNet","Networks","mainnet","testnet","inputs","sequenceNumber","privateKey","getPrivateKey","signature","Sighash","sign","sigBuffer","concat","toDER","integerAsSingleByteBuffer","payment","payments","p2sh","redeem","p2wsh","output","input","compile","getPublicKeyBuffer","Buffer","from","replace","setWitnesses","witness","hashName","hashOpcodeName","toUpperCase","hashOpcode","opcodes","secretHash","ownerPublicKey","recipientPublicKey","lockTime","OP_SIZE","OP_EQUALVERIFY","OP_EQUAL","OP_IF","OP_ELSE","number","encode","OP_CHECKLOCKTIMEVERIFY","OP_DROP","OP_ENDIF","OP_CHECKSIG","scriptData","scriptAddress","expected","createScript","expectedConfidence","confidence","expectedValue","value","multipliedBy","integerValue","totalUnspent","reduce","summ","satoshis","filterConfidentUnspents","confidentUnspents","totalConfidentUnspent","isGreaterThan","toString","handleTransactionHash","scriptValues","amount","resolve","reject","ownerAddress","getAddress","fundValue","feeValueBN","skipValue","transaction","to","change","toObject","String","serialize","result","length","isRefund","destinationAddress","destAddress","hasWithdraw","toLowerCase","txId","alreadyWithdrawed","lockUntilDate","_","_signTransaction","txHex","hash","getWithdrawRawTransaction","txRaw","getRefundRawTransaction","helpers","waitDelay","checkTX","txSuccess","res","test","text","errorMessage","txID","txInfo","withdraw"],"mappings":"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","sourcesContent":["// @ts-nocheck\r\nimport debug from 'debug'\r\nimport SwapApp, { SwapInterface, constants, util } from 'swap.app'\r\nimport BigNumber from 'bignumber.js'\r\nimport bitcore from 'ghost-bitcore-lib'\r\nconst PrivateKey = bitcore.PrivateKey;\r\nconst BufferUtil = bitcore.util.buffer;\r\n\r\nclass GhostSwap extends SwapInterface {\r\n\r\n  _swapName: string\r\n  fetchBalance: any\r\n  fetchUnspents: any\r\n  broadcastTx: any\r\n  checkWithdraw: any\r\n  feeValue: any\r\n  fetchTxInfo: any\r\n  estimateFeeValue: ({}) => string\r\n\r\n  app: any\r\n  network: any\r\n\r\n  /**\r\n   *\r\n   * @param options\r\n   * @param options.fetchBalance\r\n   * @param options.fetchUnspents\r\n   * @param options.broadcastTx\r\n   * @param options.fetchTxInfo {(tx_hash) => Promise({ confidence, fees })}\r\n   * @param options.estimateFeeValue { ({ inSatoshis, speed, address, txSize }) => Promise(fee_value) }\r\n   */\r\n  constructor(options) {\r\n    super()\r\n\r\n    if (typeof options.fetchBalance !== 'function') {\r\n      throw new Error('GhostSwap: \"fetchBalance\" required')\r\n    }\r\n    if (typeof options.fetchUnspents !== 'function') {\r\n      throw new Error('GhostSwap: \"fetchUnspents\" required')\r\n    }\r\n    if (typeof options.broadcastTx !== 'function') {\r\n      throw new Error('GhostSwap: \"broadcastTx\" required')\r\n    }\r\n    if (typeof options.fetchTxInfo !== 'function') {\r\n      // tx_hash => { confidence, fees }\r\n      console.warn(`GhostSwap: \"fetchTxInfo\" is not a function. You will not be able to use tx-confidence feature`)\r\n    }\r\n    if (typeof options.estimateFeeValue !== 'function') {\r\n      // ({ speed } = {}) => feeRate\r\n      console.warn(`GhostSwap: \"estimateFeeValue\" is not a function. You will not be able use automatic mempool-based fee`)\r\n    }\r\n\r\n    this._swapName = constants.COINS.ghost\r\n    this.fetchBalance = options.fetchBalance\r\n    this.fetchUnspents = options.fetchUnspents\r\n    this.broadcastTx = options.broadcastTx\r\n    this.checkWithdraw = options.checkWithdraw\r\n    this.feeValue = options.feeValue || 546\r\n    this.fetchTxInfo = options.fetchTxInfo || (() => { })\r\n    this.estimateFeeValue = options.estimateFeeValue || (() => 0)\r\n  }\r\n\r\n  _initSwap(app) {\r\n    super._initSwap(app)\r\n\r\n    this.app = app\r\n\r\n    this.network = this.app.services.auth.accounts.ghost.network // TODO: templess solution, try to find better solution\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} options\r\n   * @param {boolean} options.inSatoshis\r\n   * @param {Number} options.size\r\n   * @param {String} options.speed\r\n   * @param {String} options.address\r\n   * @returns {BigNumber}\r\n   * @public\r\n   */\r\n  async getTxFee({ inSatoshis, size, speed = 'fast', address }) {\r\n    let estimatedFee = new BigNumber(await this.estimateFeeValue({ \r\n      inSatoshis,\r\n      address,\r\n      speed,\r\n      method: 'swap',\r\n      txSize: size\r\n    }))\r\n\r\n    this.feeValue = estimatedFee\r\n\r\n    return inSatoshis\r\n      ? estimatedFee\r\n      : estimatedFee.dividedBy(1e8).dp(0, BigNumber.ROUND_UP)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {array} unspents\r\n   * @param {Number} expectedConfidenceLevel\r\n   * @returns {array}\r\n   * @private\r\n   */\r\n  async filterConfidentUnspents(unspents, expectedConfidenceLevel = 0.95) {\r\n    const feesToConfidence = async (fees, size, address) => {\r\n      const currentFastestFee = await this.getTxFee({ inSatoshis: true, size, speed: 'fast', address })\r\n\r\n      return new BigNumber(fees).isLessThan(currentFastestFee)\r\n        ? new BigNumber(fees).dividedBy(currentFastestFee).toNumber()\r\n        : 1\r\n    }\r\n\r\n    const confirmationsToConfidence = confs => confs > 0 ? 1 : 0\r\n\r\n    const fetchConfidence = async ({ txid, confirmations }) => {\r\n      const confidenceFromConfirmations = confirmationsToConfidence(confirmations)\r\n\r\n      if (new BigNumber(confidenceFromConfirmations).isGreaterThanOrEqualTo(expectedConfidenceLevel)) {\r\n        return confidenceFromConfirmations\r\n      }\r\n\r\n      try {\r\n        const info = await this.fetchTxInfo(txid)\r\n\r\n        const { fees, size, senderAddress } = info\r\n\r\n        if (fees) {\r\n          return await feesToConfidence(fees, size, senderAddress)\r\n        }\r\n\r\n        throw new Error(`txinfo=${{ confirmations, fees, size, senderAddress }}`)\r\n\r\n      } catch (err) {\r\n        console.error(`GhostSwap: Error fetching confidence: using confirmations > 0:`, err.message)\r\n        return confidenceFromConfirmations\r\n      }\r\n    }\r\n\r\n    const confidences = await Promise.all(unspents.map(fetchConfidence))\r\n\r\n    return unspents.filter((utxo, index) => {\r\n      debug('swap.core:swaps')(`confidence[${index}]:`, confidences[index])\r\n      //@\r\n      return new BigNumber(confidences[index]).isGreaterThanOrEqualTo(expectedConfidenceLevel)\r\n    })\r\n  }\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.script\r\n   * @param {*} data.tx\r\n   * @param {string} data.secret\r\n   * @param {number} inputIndex\r\n   * @private\r\n   */\r\n  _signTransaction(data, inputIndex = 0) {\r\n    debug('swap.core:swaps')('signing script input', inputIndex)\r\n    const { script, tx, secret } = data\r\n    const hashType = this.app.env.bitcoin.Transaction.SIGHASH_ALL\r\n    // At the moment we are using Bitcore lib from Ghost to handle signing logic. TODO: port Bitcoinjs-lib to be compatible with Ghost and\r\n    // to avoid lib's duplicate\r\n    const network = this.app.isMainNet() ? bitcore.Networks.mainnet : bitcore.Networks.testnet; \r\n    // For refund we need to change the sequence number\r\n    tx.inputs[inputIndex].sequenceNumber = 4294967294;\r\n    const privateKey = new PrivateKey(this.app.services.auth.accounts.ghost.getPrivateKey(), network);\r\n    const signature = bitcore.Transaction.Sighash.sign(tx, privateKey, hashType, inputIndex, script);\r\n    const sigBuffer = BufferUtil.concat([\r\n      signature.toDER(),\r\n      BufferUtil.integerAsSingleByteBuffer(hashType)\r\n    ]);\r\n    const payment = this.app.env.bitcoin.payments.p2sh({\r\n      redeem: this.app.env.bitcoin.payments.p2wsh({\r\n        redeem: {\r\n          output: script,\r\n          input: this.app.env.bitcoin.script.compile([\r\n            sigBuffer,\r\n            this.app.services.auth.accounts.ghost.getPublicKeyBuffer(),\r\n            Buffer.from(secret.replace(/^0x/, ''), 'hex'),\r\n          ])\r\n        }\r\n      })\r\n    })\r\n    \r\n    tx.inputs[inputIndex].setWitnesses(payment.witness);\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @param {string} data.ownerPublicKey\r\n   * @param {string} data.recipientPublicKey\r\n   * @param {number} data.lockTime\r\n   * @returns {{scriptAddress: *, script: (*|{ignored})}}\r\n   */\r\n  createScript(data, hashName = 'ripemd160') {\r\n    const hashOpcodeName = `OP_${hashName.toUpperCase()}`\r\n    const hashOpcode = this.app.env.bitcoin.opcodes[hashOpcodeName]\r\n\r\n    const { secretHash, ownerPublicKey, recipientPublicKey, lockTime } = data\r\n    const script = this.app.env.bitcoin.script.compile([\r\n\r\n      this.app.env.bitcoin.opcodes.OP_SIZE,\r\n      Buffer.from('20' ,'hex'),\r\n      this.app.env.bitcoin.opcodes.OP_EQUALVERIFY,\r\n\r\n      hashOpcode,\r\n      Buffer.from(secretHash, 'hex'),\r\n      this.app.env.bitcoin.opcodes.OP_EQUALVERIFY,\r\n\r\n      Buffer.from(recipientPublicKey, 'hex'),\r\n      this.app.env.bitcoin.opcodes.OP_EQUAL,\r\n      this.app.env.bitcoin.opcodes.OP_IF,\r\n\r\n      Buffer.from(recipientPublicKey, 'hex'),\r\n\r\n      this.app.env.bitcoin.opcodes.OP_ELSE,\r\n\r\n      this.app.env.bitcoin.script.number.encode(lockTime),\r\n      this.app.env.bitcoin.opcodes.OP_CHECKLOCKTIMEVERIFY,\r\n      this.app.env.bitcoin.opcodes.OP_DROP,\r\n      Buffer.from(ownerPublicKey, 'hex'),\r\n\r\n      this.app.env.bitcoin.opcodes.OP_ENDIF,\r\n\r\n      this.app.env.bitcoin.opcodes.OP_CHECKSIG,\r\n    ])\r\n\r\n    const scriptData = this.app.env.bitcoin.payments.p2sh({ redeem: { output: script, network: this.network }, network: this.network })\r\n    const scriptAddress = scriptData.address;\r\n\r\n    return {\r\n      scriptAddress,\r\n      script,\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.recipientPublicKey\r\n   * @param {number} data.lockTime\r\n   * @param {object} expected\r\n   * @param {number} expected.value\r\n   * @param {number} expected.lockTime\r\n   * @param {string} expected.recipientPublicKey\r\n   * @returns {Promise.<string>}\r\n   */\r\n  async checkScript(data, expected, hashName) {\r\n    const { recipientPublicKey, lockTime } = data\r\n    const { scriptAddress, script } = this.createScript(data, hashName)\r\n\r\n    const expectedConfidence = expected.confidence || 0.95\r\n    const unspents = await this.fetchUnspents(scriptAddress)\r\n    const expectedValue = expected.value.multipliedBy(1e8).integerValue()\r\n    const totalUnspent = unspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n\r\n    const confidentUnspents = await this.filterConfidentUnspents(unspents, expectedConfidence)\r\n    const totalConfidentUnspent = confidentUnspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n\r\n    if (expectedValue.isGreaterThan(totalUnspent)) {\r\n      return `Expected script value: ${expectedValue.toNumber()}, got: ${totalUnspent}, address: ${scriptAddress}`\r\n    }\r\n    if (expected.lockTime > lockTime) {\r\n      return `Expected script lockTime: ${expected.lockTime}, got: ${lockTime}, address: ${scriptAddress}`\r\n    }\r\n    if (expected.recipientPublicKey !== recipientPublicKey) {\r\n      return `Expected script recipient publicKey: ${expected.recipientPublicKey}, got: ${recipientPublicKey}`\r\n    }\r\n    if (expectedValue.isGreaterThan(totalConfidentUnspent)) {\r\n      return `Expected script value: ${expectedValue.toString()} with confidence above ${expectedConfidence}, got: ${totalConfidentUnspent}, address: ${scriptAddress}`\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {BigNumber} data.amount\r\n   * @param {function} handleTransactionHash\r\n   * @param {string} hashName\r\n   * @returns {Promise}\r\n   */\r\n  fundScript(data, handleTransactionHash, hashName) {\r\n    const { scriptValues, amount } = data\r\n\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n\r\n        const { scriptAddress } = this.createScript(scriptValues, hashName)\r\n\r\n        const ownerAddress = this.app.services.auth.accounts.ghost.getAddress()\r\n\r\n        const unspents = await this.fetchUnspents(ownerAddress)\r\n        const fundValue = amount.multipliedBy(1e8).integerValue().toNumber()\r\n        //@\r\n        const feeValueBN = await this.getTxFee({\r\n          inSatoshis: true,\r\n          address: ownerAddress,\r\n        })\r\n        const feeValue = feeValueBN.integerValue().toNumber()\r\n        const totalUnspent = unspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n        const skipValue = totalUnspent - fundValue - feeValue\r\n        if (totalUnspent < feeValue + fundValue) {\r\n          throw new Error(`Total less than fee: ${totalUnspent} < ${feeValue} + ${fundValue}`)\r\n        }\r\n\r\n        const transaction = new bitcore.Transaction()\r\n          .from(unspents)         \r\n          .to(scriptAddress, fundValue) \r\n          .change(this.app.services.auth.accounts.ghost.getAddress())     \r\n          .sign(this.app.services.auth.accounts.ghost.getPrivateKey())    \r\n\r\n        if (typeof handleTransactionHash === 'function') {\r\n          handleTransactionHash(transaction.toObject().txid)\r\n        }\r\n\r\n        try {\r\n          const result = await this.broadcastTx(String(transaction.serialize()))\r\n          resolve(result)\r\n        }\r\n        catch (err) {\r\n          reject(err)\r\n        }\r\n      }\r\n      catch (err) {\r\n        reject(err)\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object|string} data - scriptValues or wallet address\r\n   * @returns {Promise.<void>}\r\n   */\r\n  async getBalance(data, hashName) {\r\n    let address\r\n\r\n    if (typeof data === 'string') {\r\n      address = data\r\n    }\r\n    else if (typeof data === 'object') {\r\n      const { scriptAddress } = this.createScript(data, hashName)\r\n\r\n      address = scriptAddress\r\n    }\r\n    else {\r\n      throw new Error('Wrong data type')\r\n    }\r\n\r\n    const unspents = await this.fetchUnspents(address)\r\n    const totalUnspent = unspents && unspents.length && unspents.reduce((summ, { satoshis }) => summ + satoshis, 0) || 0\r\n\r\n    return totalUnspent\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @param {boolean} isRefund\r\n   * @returns {Promise}\r\n   */\r\n  async getWithdrawRawTransaction(data, isRefund, hashName?) {\r\n    const { scriptValues, secret, destinationAddress } = data\r\n    const destAddress = (destinationAddress) ? destinationAddress : this.app.services.auth.accounts.ghost.getAddress()\r\n\r\n    const { script, scriptAddress } = this.createScript(scriptValues, hashName)\r\n    const unspents = await this.fetchUnspents(scriptAddress)\r\n    //@\r\n    const feeValueBN = await this.getTxFee({\r\n      inSatoshis: true,\r\n      address: scriptAddress\r\n    })\r\n    const feeValue = feeValueBN.integerValue().toNumber()\r\n    const totalUnspent = unspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n\r\n    if (new BigNumber(totalUnspent).isLessThan(feeValue)) {\r\n      /* Check - may be withdrawed */\r\n      if (typeof this.checkWithdraw === 'function') {\r\n        const hasWithdraw = await this.checkWithdraw(scriptAddress)\r\n        if (hasWithdraw\r\n          && hasWithdraw.address.toLowerCase() == destAddress.toLowerCase()\r\n        ) {\r\n          // already withdrawed\r\n          return {\r\n            txId: hasWithdraw.txid,\r\n            alreadyWithdrawed: true\r\n          }\r\n        } else {\r\n          throw new Error(`Total less than fee: ${totalUnspent} < ${feeValue}`)\r\n        }\r\n      } else {\r\n        throw new Error(`Total less than fee: ${totalUnspent} < ${feeValue}`)\r\n      }\r\n    }\r\n\r\n    const tx = new bitcore.Transaction();\r\n\r\n    if (isRefund) {\r\n      tx.lockUntilDate(scriptValues.lockTime);\r\n    }\r\n \r\n    tx.from(unspents);\r\n    tx.to(destAddress, totalUnspent - feeValue);\r\n    // Sign input witness's\r\n    tx.inputs.map((_, index) =>\r\n      this._signTransaction({\r\n        script,\r\n        secret,\r\n        tx,\r\n      }, index)\r\n\r\n    );\r\n\r\n    const txHex = tx.toString()\r\n    const txId = tx.toObject().hash\r\n\r\n     return {\r\n       txHex,\r\n       txId,\r\n     }\r\n\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @param {boolean} isRefund\r\n   * @returns {Promise}\r\n   */\r\n  async getWithdrawHexTransaction(data, isRefund) {\r\n    const txRaw = await this.getWithdrawRawTransaction(data, isRefund)\r\n\r\n    return txRaw.txHex\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @returns {Promise}\r\n   */\r\n  getRefundRawTransaction(data) {\r\n    return this.getWithdrawRawTransaction(data, true)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @returns {Promise}\r\n   */\r\n  async getRefundHexTransaction(data) {\r\n    const txRaw = await this.getRefundRawTransaction(data)\r\n\r\n    return txRaw.txHex\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @param {function} handleTransactionHash\r\n   * @param {boolean} isRefund\r\n   * @param {string} hashName\r\n   * @returns {Promise}\r\n   */\r\n  withdraw(data, isRefund, hashName) {\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n        const txRaw = await this.getWithdrawRawTransaction(data, isRefund, hashName)\r\n\r\n        if (txRaw.alreadyWithdrawed) {\r\n          resolve(txRaw.txId)\r\n          return\r\n        }\r\n\r\n        debug('swap.core:swaps')('raw tx withdraw', txRaw.txHex)\r\n\r\n        const result = await this.broadcastTx(txRaw.txHex)\r\n\r\n\r\n        // Wait some delay until transaction can be rejected or broadcast failed\r\n        await util.helpers.waitDelay(10)\r\n\r\n        const txSuccess = await this.checkTX(txRaw.txId)\r\n\r\n        if (txSuccess) {\r\n          resolve(txRaw.txId)\r\n        } else {\r\n          console.warn('GhostSwap: cant withdraw', 'Generated TX not found')\r\n          reject('TX not found. Try it later. ')\r\n        }\r\n      }\r\n      catch (error) {\r\n        console.warn('GhostSwap: cant withdraw', error.message)\r\n\r\n        let errorMessage\r\n\r\n        if (error.res && /non-final/.test(error.res.text)) {\r\n          errorMessage = 'Try it later'\r\n        } else if (/Total less than fee/.test(error.message)) {\r\n          if (/Total less than fee: 0/.test(error.message)) {\r\n            errorMessage = 'Address is empty'\r\n          } else {\r\n            errorMessage = 'Less than fee'\r\n          }\r\n        } else {\r\n          errorMessage = error\r\n        }\r\n\r\n        reject(errorMessage)\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @param {string} txID\r\n   * @returns {Promise}\r\n   */\r\n  async checkTX(txID) {\r\n    const txInfo = await this.fetchTxInfo(txID)\r\n    if (txInfo\r\n      && txInfo.senderAddress\r\n      && txInfo.txid\r\n      && (txInfo.txid.toLowerCase() == txID.toLowerCase())\r\n    ) {\r\n      return true\r\n    }\r\n    return false\r\n  }\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {object} data.scriptValues\r\n   * @param {string} data.secret\r\n   * @param {function} handleTransactionHash\r\n   * @param {string} hashName\r\n   * @returns {Promise}\r\n   */\r\n  refund(data, hashName) {\r\n    return this.withdraw(data, true, hashName)\r\n  }\r\n}\r\n\r\n\r\nexport default GhostSwap\r\n"]}]}