{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.swaps\\EthTokenSwap.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.swaps\\EthTokenSwap.ts","mtime":1614850209298},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9zbGljZWRUb0FycmF5IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvc2xpY2VkVG9BcnJheSI7CmltcG9ydCBfdG9BcnJheSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL3RvQXJyYXkiOwppbXBvcnQgX3RvQ29uc3VtYWJsZUFycmF5IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvdG9Db25zdW1hYmxlQXJyYXkiOwppbXBvcnQgX2FzeW5jVG9HZW5lcmF0b3IgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9hc3luY1RvR2VuZXJhdG9yIjsKaW1wb3J0IF9jbGFzc0NhbGxDaGVjayBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2NsYXNzQ2FsbENoZWNrIjsKaW1wb3J0IF9jcmVhdGVDbGFzcyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2NyZWF0ZUNsYXNzIjsKaW1wb3J0IF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQiOwppbXBvcnQgX2dldCBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldCI7CmltcG9ydCBfaW5oZXJpdHMgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9pbmhlcml0cyI7CmltcG9ydCBfcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4iOwppbXBvcnQgX2dldFByb3RvdHlwZU9mIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0UHJvdG90eXBlT2YiOwppbXBvcnQgX2RlZmluZVByb3BlcnR5IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZGVmaW5lUHJvcGVydHkiOwoKZnVuY3Rpb24gb3duS2V5cyhvYmplY3QsIGVudW1lcmFibGVPbmx5KSB7IHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqZWN0KTsgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsgdmFyIHN5bWJvbHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKG9iamVjdCk7IGlmIChlbnVtZXJhYmxlT25seSkgc3ltYm9scyA9IHN5bWJvbHMuZmlsdGVyKGZ1bmN0aW9uIChzeW0pIHsgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBzeW0pLmVudW1lcmFibGU7IH0pOyBrZXlzLnB1c2guYXBwbHkoa2V5cywgc3ltYm9scyk7IH0gcmV0dXJuIGtleXM7IH0KCmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQodGFyZ2V0KSB7IGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7IHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV0gIT0gbnVsbCA/IGFyZ3VtZW50c1tpXSA6IHt9OyBpZiAoaSAlIDIpIHsgb3duS2V5cyhPYmplY3Qoc291cmNlKSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7IF9kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgc291cmNlW2tleV0pOyB9KTsgfSBlbHNlIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycykgeyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHNvdXJjZSkpOyB9IGVsc2UgeyBvd25LZXlzKE9iamVjdChzb3VyY2UpKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHNvdXJjZSwga2V5KSk7IH0pOyB9IH0gcmV0dXJuIHRhcmdldDsgfQoKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgovLyBAdHMtbm9jaGVjawppbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnOwppbXBvcnQgeyBTd2FwSW50ZXJmYWNlLCBjb25zdGFudHMsIHV0aWwgfSBmcm9tICdzd2FwLmFwcCc7CmltcG9ydCBCaWdOdW1iZXIgZnJvbSAnYmlnbnVtYmVyLmpzJzsKaW1wb3J0IElucHV0RGF0YURlY29kZXIgZnJvbSAnZXRoZXJldW0taW5wdXQtZGF0YS1kZWNvZGVyJzsKCnZhciBFdGhUb2tlblN3YXAgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9Td2FwSW50ZXJmYWNlKSB7CiAgX2luaGVyaXRzKEV0aFRva2VuU3dhcCwgX1N3YXBJbnRlcmZhY2UpOwoKICB2YXIgX3N1cGVyID0gX2NyZWF0ZVN1cGVyKEV0aFRva2VuU3dhcCk7CgogIC8qKg0KICAgKg0KICAgKiBAcGFyYW0ge29iamVjdH0gICAgb3B0aW9ucw0KICAgKiBAcGFyYW0ge3N0cmluZ30gICAgb3B0aW9ucy5uYW1lDQogICAqIEBwYXJhbSB7c3RyaW5nfSAgICBvcHRpb25zLmFkZHJlc3MNCiAgICogQHBhcmFtIHthcnJheX0gICAgIG9wdGlvbnMuYWJpDQogICAqIEBwYXJhbSB7c3RyaW5nfSAgICBvcHRpb25zLnRva2VuQWRkcmVzcw0KICAgKiBAcGFyYW0ge2FycmF5fSAgICAgb3B0aW9ucy50b2tlbkFiaQ0KICAgKiBAcGFyYW0ge251bWJlcn0gICAgb3B0aW9ucy5nYXNMaW1pdA0KICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSAgb3B0aW9ucy5mZXRjaEJhbGFuY2UNCiAgICovCiAgZnVuY3Rpb24gRXRoVG9rZW5Td2FwKG9wdGlvbnMpIHsKICAgIHZhciBfdGhpczsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRXRoVG9rZW5Td2FwKTsKCiAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIl9zd2FwTmFtZSIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiYWRkcmVzcyIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiYWJpIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJkZWNpbWFscyIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAidG9rZW5BZGRyZXNzIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJ0b2tlbkFiaSIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZ2FzTGltaXQiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImdhc1ByaWNlIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJmZXRjaEJhbGFuY2UiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImVzdGltYXRlR2FzUHJpY2UiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIl9hbGxTd2FwRXZlbnRzIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJhcHAiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImRlY29kZXIiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImNvbnRyYWN0Iiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJFUkMyMCIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZ2V0U2VjcmV0RnJvbVR4aGFzaCIsIGZ1bmN0aW9uICh0cmFuc2FjdGlvbkhhc2gpIHsKICAgICAgcmV0dXJuIF90aGlzLmFwcC5lbnYud2ViMy5ldGguZ2V0VHJhbnNhY3Rpb24odHJhbnNhY3Rpb25IYXNoKS50aGVuKGZ1bmN0aW9uICh0eFJlc3VsdCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgYnl0ZXMzMiA9IF90aGlzLmRlY29kZXIuZGVjb2RlRGF0YSh0eFJlc3VsdC5pbnB1dCk7CgogICAgICAgICAgcmV0dXJuIF90aGlzLmFwcC5lbnYud2ViMy51dGlscy5ieXRlc1RvSGV4KGJ5dGVzMzIuaW5wdXRzWzBdKS5zcGxpdCgnMHgnKVsxXTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6c3dhcHMnKSgnVHJ5aW5nIHRvIGZldGNoIHNlY3JldCBmcm9tIHR4OiAnICsgZXJyLm1lc3NhZ2UpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKCiAgICBpZiAoIW9wdGlvbnMubmFtZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V0aFRva2VuU3dhcDogIm5hbWUiIHJlcXVpcmVkJyk7CiAgICB9CgogICAgaWYgKCFPYmplY3QudmFsdWVzKGNvbnN0YW50cy5DT0lOUykuaW5jbHVkZXMob3B0aW9ucy5uYW1lLnRvVXBwZXJDYXNlKCkpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignRXRoVG9rZW5Td2FwOiAibmFtZSIgc2hvdWxkIGJlIGNvcnJlY3QnKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIG9wdGlvbnMuYWRkcmVzcyAhPT0gJ3N0cmluZycpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdFdGhUb2tlblN3YXA6ICJhZGRyZXNzIiByZXF1aXJlZCcpOwogICAgfQoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5kZWNpbWFscyAhPT0gJ251bWJlcicpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdFdGhUb2tlblN3YXA6ICJkZWNpbWFscyIgcmVxdWlyZWQnKTsKICAgIH0KCiAgICBpZiAoIUFycmF5LmlzQXJyYXkob3B0aW9ucy5hYmkpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignRXRoVG9rZW5Td2FwOiAiYWJpIiByZXF1aXJlZCcpOwogICAgfQoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy50b2tlbkFkZHJlc3MgIT09ICdzdHJpbmcnKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignRXRoVG9rZW5Td2FwOiAidG9rZW5BZGRyZXNzIiByZXF1aXJlZCcpOwogICAgfQoKICAgIGlmICghQXJyYXkuaXNBcnJheShvcHRpb25zLnRva2VuQWJpKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V0aFRva2VuU3dhcDogInRva2VuQWJpIiByZXF1aXJlZCcpOwogICAgfQoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5lc3RpbWF0ZUdhc1ByaWNlICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIC8vICh7IHNwZWVkIH0gPSB7fSkgPT4gZ2FzUHJpY2UKICAgICAgY29uc29sZS53YXJuKCJFdGhUb2tlblN3YXA6IFwiZXN0aW1hdGVHYXNQcmljZVwiIGlzIG5vdCBhIGZ1bmN0aW9uLiBZb3Ugd2lsbCBub3QgYmUgYWJsZSB1c2UgYXV0b21hdGljIG1lbXBvb2wtYmFzZWQgZmVlIik7CiAgICB9CgogICAgX3RoaXMuX3N3YXBOYW1lID0gb3B0aW9ucy5uYW1lLnRvVXBwZXJDYXNlKCk7CiAgICBfdGhpcy5hZGRyZXNzID0gb3B0aW9ucy5hZGRyZXNzOwogICAgX3RoaXMuYWJpID0gb3B0aW9ucy5hYmk7CiAgICBfdGhpcy5kZWNpbWFscyA9IG9wdGlvbnMuZGVjaW1hbHM7CiAgICBfdGhpcy50b2tlbkFkZHJlc3MgPSBvcHRpb25zLnRva2VuQWRkcmVzczsKICAgIF90aGlzLnRva2VuQWJpID0gb3B0aW9ucy50b2tlbkFiaTsKICAgIF90aGlzLmdhc0xpbWl0ID0gb3B0aW9ucy5nYXNMaW1pdCB8fCAyZTU7CiAgICBfdGhpcy5nYXNQcmljZSA9IG9wdGlvbnMuZ2FzUHJpY2UgfHwgMmU5OwogICAgX3RoaXMuZmV0Y2hCYWxhbmNlID0gb3B0aW9ucy5mZXRjaEJhbGFuY2U7CgogICAgX3RoaXMuZXN0aW1hdGVHYXNQcmljZSA9IG9wdGlvbnMuZXN0aW1hdGVHYXNQcmljZSB8fCBmdW5jdGlvbiAoKSB7fTsKCiAgICByZXR1cm4gX3RoaXM7CiAgfQoKICBfY3JlYXRlQ2xhc3MoRXRoVG9rZW5Td2FwLCBbewogICAga2V5OiAiX2luaXRTd2FwIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfaW5pdFN3YXAoYXBwKSB7CiAgICAgIF9nZXQoX2dldFByb3RvdHlwZU9mKEV0aFRva2VuU3dhcC5wcm90b3R5cGUpLCAiX2luaXRTd2FwIiwgdGhpcykuY2FsbCh0aGlzLCBhcHApOwoKICAgICAgdGhpcy5hcHAgPSBhcHA7CiAgICAgIHZhciB3ZWIzID0gdGhpcy5hcHAuZW52LmdldFdlYjMoKTsKICAgICAgdGhpcy5kZWNvZGVyID0gbmV3IElucHV0RGF0YURlY29kZXIodGhpcy5hYmkpOwogICAgICB0aGlzLmNvbnRyYWN0ID0gbmV3IHdlYjMuZXRoLkNvbnRyYWN0KHRoaXMuYWJpLCB0aGlzLmFkZHJlc3MpOwogICAgICB0aGlzLkVSQzIwID0gbmV3IHdlYjMuZXRoLkNvbnRyYWN0KHRoaXMudG9rZW5BYmksIHRoaXMudG9rZW5BZGRyZXNzKTsKICAgIH0KICAgIC8qKg0KICAgICAqIEBkZXByZWNhdGVkDQogICAgICovCgogIH0sIHsKICAgIGtleTogInVwZGF0ZUdhcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdXBkYXRlR2FzKCkgewogICAgICBjb25zb2xlLndhcm4oIkV0aFN3YXAudXBkYXRlR2FzKCkgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkLiBVc2UgLnVwZGF0ZUdhc1ByaWNlKCkiKTsKICAgICAgcmV0dXJuIHRoaXMudXBkYXRlR2FzUHJpY2UoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ1cGRhdGVHYXNQcmljZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3VwZGF0ZUdhc1ByaWNlID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZSgpIHsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgLy9ACiAgICAgICAgICAgICAgICBkZWJ1ZygnZ2FzIHByaWNlIGJlZm9yZSB1cGRhdGUnLCB0aGlzLmdhc1ByaWNlKTsKICAgICAgICAgICAgICAgIF9jb250ZXh0LnByZXYgPSAxOwogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lc3RpbWF0ZUdhc1ByaWNlKHsKICAgICAgICAgICAgICAgICAgc3BlZWQ6ICdmYXN0JwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIHRoaXMuZ2FzUHJpY2UgPSBfY29udGV4dC5zZW50OwogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDEwOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgIF9jb250ZXh0LnByZXYgPSA3OwogICAgICAgICAgICAgICAgX2NvbnRleHQudDAgPSBfY29udGV4dFsiY2F0Y2giXSgxKTsKICAgICAgICAgICAgICAgIGRlYnVnKCJFdGhUb2tlblN3YXA6IEVycm9yIHdpdGggZ2FzIHVwZGF0ZTogIi5jb25jYXQoX2NvbnRleHQudDAubWVzc2FnZSwgIiwgdXNpbmcgb2xkIHZhbHVlIGdhc1ByaWNlPSIpLmNvbmNhdCh0aGlzLmdhc1ByaWNlKSk7CgogICAgICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICAgICAgICAvL0AKICAgICAgICAgICAgICAgIGRlYnVnKCdnYXMgcHJpY2UgYWZ0ZXIgdXBkYXRlJywgdGhpcy5nYXNQcmljZSk7CgogICAgICAgICAgICAgIGNhc2UgMTE6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlLCB0aGlzLCBbWzEsIDddXSk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHVwZGF0ZUdhc1ByaWNlKCkgewogICAgICAgIHJldHVybiBfdXBkYXRlR2FzUHJpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHVwZGF0ZUdhc1ByaWNlOwogICAgfSgpCiAgfSwgewogICAga2V5OiAic2VuZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3NlbmQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMyhtZXRob2ROYW1lLCBhcmdzKSB7CiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICAgIHZhciBfcGFyYW1zLAogICAgICAgICAgICBoYW5kbGVUcmFuc2FjdGlvbkhhc2gsCiAgICAgICAgICAgIF9hcmdzMyA9IGFyZ3VtZW50czsKCiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMyQoX2NvbnRleHQzKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0My5wcmV2ID0gX2NvbnRleHQzLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfcGFyYW1zID0gX2FyZ3MzLmxlbmd0aCA+IDIgJiYgX2FyZ3MzWzJdICE9PSB1bmRlZmluZWQgPyBfYXJnczNbMl0gOiB7fTsKICAgICAgICAgICAgICAgIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCA9IF9hcmdzMy5sZW5ndGggPiAzID8gX2FyZ3MzWzNdIDogdW5kZWZpbmVkOwoKICAgICAgICAgICAgICAgIGlmICghKHR5cGVvZiB0aGlzLmNvbnRyYWN0Lm1ldGhvZHNbbWV0aG9kTmFtZV0gIT09ICdmdW5jdGlvbicpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gNDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFdGhUb2tlblN3YXAuc2VuZDogTm8gbWV0aG9kICIuY29uY2F0KG1ldGhvZE5hbWUsICIgaW4gY29udHJhY3QiKSk7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gNjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZUdhc1ByaWNlKCk7CgogICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuYWJydXB0KCJyZXR1cm4iLCBuZXcgUHJvbWlzZSggLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWYgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3RoaXMyJGNvbnRyYWN0JG1ldGhvMjsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmFtcywgZ2FzQW1vdW50LCBfdGhpczIkY29udHJhY3QkbWV0aG8sIHJlY2VpcHQ7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIkKF9jb250ZXh0MikgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDIucHJldiA9IF9jb250ZXh0Mi5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0gX29iamVjdFNwcmVhZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IF90aGlzMi5hcHAuZ2V0TXlFdGhBZGRyZXNzKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhczogX3RoaXMyLmdhc0xpbWl0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXNQcmljZTogX3RoaXMyLmdhc1ByaWNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBfcGFyYW1zKTsgLy9ACgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoIkV0aFRva2VuU3dhcCAtPiAiLmNvbmNhdChtZXRob2ROYW1lLCAiIC0+IHBhcmFtcyIpLCBwYXJhbXMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FzQW1vdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5wcmV2ID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gNjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoX3RoaXMyJGNvbnRyYWN0JG1ldGhvID0gX3RoaXMyLmNvbnRyYWN0Lm1ldGhvZHMpW21ldGhvZE5hbWVdLmFwcGx5KF90aGlzMiRjb250cmFjdCRtZXRobywgX3RvQ29uc3VtYWJsZUFycmF5KGFyZ3MpKS5lc3RpbWF0ZUdhcyhwYXJhbXMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXNBbW91bnQgPSBfY29udGV4dDIuc2VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gMTM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyLnByZXYgPSA5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyLnQwID0gX2NvbnRleHQyWyJjYXRjaCJdKDMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogX2NvbnRleHQyLnQwLm1lc3NhZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhc0Ftb3VudDogbmV3IEJpZ051bWJlcihnYXNBbW91bnQpLmRpdmlkZWRCeSgxZTgpLnRvU3RyaW5nKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zLmdhcyA9IGdhc0Ftb3VudDsgLy9ACgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoIkV0aFRva2VuU3dhcCAtPiAiLmNvbmNhdChtZXRob2ROYW1lLCAiIC0+IGdhcyIpLCBnYXNBbW91bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSAxNzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoX3RoaXMyJGNvbnRyYWN0JG1ldGhvMiA9IF90aGlzMi5jb250cmFjdC5tZXRob2RzKVttZXRob2ROYW1lXS5hcHBseShfdGhpczIkY29udHJhY3QkbWV0aG8yLCBfdG9Db25zdW1hYmxlQXJyYXkoYXJncykpLnNlbmQocGFyYW1zKS5vbigndHJhbnNhY3Rpb25IYXNoJywgZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBoYW5kbGVUcmFuc2FjdGlvbkhhc2ggPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVUcmFuc2FjdGlvbkhhc2goaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pWyJjYXRjaCJdKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FzQW1vdW50OiBuZXcgQmlnTnVtYmVyKGdhc0Ftb3VudCkuZGl2aWRlZEJ5KDFlOCkudG9TdHJpbmcoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE3OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjZWlwdCA9IF9jb250ZXh0Mi5zZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZWNlaXB0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxOToKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMiwgbnVsbCwgW1szLCA5XV0pOwogICAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKF94MywgX3g0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWYuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oKSkpOwoKICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTMsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBzZW5kKF94LCBfeDIpIHsKICAgICAgICByZXR1cm4gX3NlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHNlbmQ7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge0JpZ051bWJlcn0gZGF0YS5hbW91bnQNCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBoYW5kbGVUcmFuc2FjdGlvbkhhc2gNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiYXBwcm92ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2FwcHJvdmUgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNShkYXRhKSB7CiAgICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICAgIHZhciBoYW5kbGVUcmFuc2FjdGlvbkhhc2gsCiAgICAgICAgICAgIGFtb3VudCwKICAgICAgICAgICAgZXhwLAogICAgICAgICAgICBuZXdBbW91bnQsCiAgICAgICAgICAgIF9hcmdzNSA9IGFyZ3VtZW50czsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU1JChfY29udGV4dDUpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ1LnByZXYgPSBfY29udGV4dDUubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCA9IF9hcmdzNS5sZW5ndGggPiAxICYmIF9hcmdzNVsxXSAhPT0gdW5kZWZpbmVkID8gX2FyZ3M1WzFdIDogbnVsbDsKICAgICAgICAgICAgICAgIGFtb3VudCA9IGRhdGEuYW1vdW50OwogICAgICAgICAgICAgICAgZXhwID0gbmV3IEJpZ051bWJlcigxMCkucG93KHRoaXMuZGVjaW1hbHMpOwogICAgICAgICAgICAgICAgbmV3QW1vdW50ID0gbmV3IEJpZ051bWJlcihhbW91bnQpLnRpbWVzKGV4cCkudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgIF9jb250ZXh0NS5uZXh0ID0gNjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZUdhc1ByaWNlKCk7CgogICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuYWJydXB0KCJyZXR1cm4iLCBuZXcgUHJvbWlzZSggLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWYyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTQocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmFtcywgZ2FzQW1vdW50LCByZXN1bHQ7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NC5wcmV2ID0gX2NvbnRleHQ0Lm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDQucHJldiA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IF90aGlzMy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhczogX3RoaXMzLmdhc0xpbWl0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXNQcmljZTogX3RoaXMzLmdhc1ByaWNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OyAvL0AKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZygiRXRoVG9rZW5Td2FwIC0+IGFwcHJvdmUgLT4gcGFyYW1zIiwgcGFyYW1zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczMuRVJDMjAubWV0aG9kcy5hcHByb3ZlKF90aGlzMy5hZGRyZXNzLCBuZXdBbW91bnQpLmVzdGltYXRlR2FzKHBhcmFtcyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhc0Ftb3VudCA9IF9jb250ZXh0NC5zZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zLmdhcyA9IGdhc0Ftb3VudDsgLy9ACgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoIkV0aFRva2VuU3dhcCAtPiBhcHByb3ZlIC0+IGdhcyIsIGdhc0Ftb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDEwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMy5FUkMyMC5tZXRob2RzLmFwcHJvdmUoX3RoaXMzLmFkZHJlc3MsIG5ld0Ftb3VudCkuc2VuZChwYXJhbXMpLm9uKCd0cmFuc2FjdGlvbkhhc2gnLCBmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZVRyYW5zYWN0aW9uSGFzaChoYXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlbImNhdGNoIl0oZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXNBbW91bnQ6IG5ldyBCaWdOdW1iZXIoZ2FzQW1vdW50KS5kaXZpZGVkQnkoMWU4KS50b1N0cmluZygpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBfY29udGV4dDQuc2VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gMTc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxNDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0NC5wcmV2ID0gMTQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDQudDAgPSBfY29udGV4dDRbImNhdGNoIl0oMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoX2NvbnRleHQ0LnQwKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxNzoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlNCwgbnVsbCwgW1swLCAxNF1dKTsKICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeDYsIF94NykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmMi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSgpKSk7CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGFwcHJvdmUoX3g1KSB7CiAgICAgICAgcmV0dXJuIF9hcHByb3ZlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBhcHByb3ZlOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc3BlbmRlcg0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJjaGVja0FsbG93YW5jZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2hlY2tBbGxvd2FuY2UoZGF0YSkgewogICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgIHZhciBzcGVuZGVyID0gZGF0YS5zcGVuZGVyOwogICAgICByZXR1cm4gbmV3IFByb21pc2UoIC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIF9yZWYzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTYocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNiQoX2NvbnRleHQ2KSB7CiAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDYucHJldiA9IF9jb250ZXh0Ni5uZXh0KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5wcmV2ID0gMDsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSAzOwogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXM0LkVSQzIwLm1ldGhvZHMuYWxsb3dhbmNlKHNwZW5kZXIsIF90aGlzNC5hZGRyZXNzKS5jYWxsKHsKICAgICAgICAgICAgICAgICAgICBmcm9tOiBfdGhpczQuYXBwLmdldE15RXRoQWRkcmVzcygpCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gX2NvbnRleHQ2LnNlbnQ7CiAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSAxMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICBfY29udGV4dDYucHJldiA9IDc7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni50MCA9IF9jb250ZXh0NlsiY2F0Y2giXSgwKTsKICAgICAgICAgICAgICAgICAgcmVqZWN0KF9jb250ZXh0Ni50MCk7CgogICAgICAgICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDYuc3RvcCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwgX2NhbGxlZTYsIG51bGwsIFtbMCwgN11dKTsKICAgICAgICB9KSk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoX3g4LCBfeDkpIHsKICAgICAgICAgIHJldHVybiBfcmVmMy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH07CiAgICAgIH0oKSk7CiAgICB9CiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0SGFzaA0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcw0KICAgICAqIEBwYXJhbSB7QmlnTnVtYmVyfSBkYXRhLmFtb3VudA0KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGhhbmRsZVRyYW5zYWN0aW9uSGFzaA0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJjcmVhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jcmVhdGUgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNyhkYXRhLCBoYW5kbGVUcmFuc2FjdGlvbkhhc2gpIHsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU3JChfY29udGV4dDcpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ3LnByZXYgPSBfY29udGV4dDcubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGlmICghKGRhdGEudGFyZ2V0V2FsbGV0ICYmIGRhdGEudGFyZ2V0V2FsbGV0ICE9PSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcykpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ3Lm5leHQgPSA0OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ3LmFicnVwdCgicmV0dXJuIiwgdGhpcy5jcmVhdGVTd2FwVGFyZ2V0KGRhdGEsIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCkpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ3LmFicnVwdCgicmV0dXJuIiwgdGhpcy5jcmVhdGVTd2FwKGRhdGEsIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCkpOwoKICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDcuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTcsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBjcmVhdGUoX3gxMCwgX3gxMSkgewogICAgICAgIHJldHVybiBfY3JlYXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBjcmVhdGU7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXRIYXNoDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzDQogICAgICogQHBhcmFtIHtCaWdOdW1iZXJ9IGRhdGEuYW1vdW50DQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlVHJhbnNhY3Rpb25IYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImNyZWF0ZVN3YXAiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jcmVhdGVTd2FwID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTgoZGF0YSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSB7CiAgICAgICAgdmFyIHNlY3JldEhhc2gsIHBhcnRpY2lwYW50QWRkcmVzcywgYW1vdW50LCBleHAsIG5ld0Ftb3VudCwgaGFzaCwgYXJnczsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU4JChfY29udGV4dDgpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ4LnByZXYgPSBfY29udGV4dDgubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHNlY3JldEhhc2ggPSBkYXRhLnNlY3JldEhhc2gsIHBhcnRpY2lwYW50QWRkcmVzcyA9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzLCBhbW91bnQgPSBkYXRhLmFtb3VudDsKICAgICAgICAgICAgICAgIGV4cCA9IG5ldyBCaWdOdW1iZXIoMTApLnBvdyh0aGlzLmRlY2ltYWxzKTsKICAgICAgICAgICAgICAgIG5ld0Ftb3VudCA9IG5ldyBCaWdOdW1iZXIoYW1vdW50KS50aW1lcyhleHApLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICBoYXNoID0gIjB4Ii5jb25jYXQoc2VjcmV0SGFzaC5yZXBsYWNlKC9eMHgvLCAnJykpOwogICAgICAgICAgICAgICAgYXJncyA9IFtoYXNoLCBwYXJ0aWNpcGFudEFkZHJlc3MsIG5ld0Ftb3VudCwgdGhpcy50b2tlbkFkZHJlc3NdOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OC5hYnJ1cHQoInJldHVybiIsIHRoaXMuc2VuZCgnY3JlYXRlU3dhcCcsIFtdLmNvbmNhdChhcmdzKSwge30sIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCkpOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDguc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTgsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBjcmVhdGVTd2FwKF94MTIsIF94MTMpIHsKICAgICAgICByZXR1cm4gX2NyZWF0ZVN3YXAuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNyZWF0ZVN3YXA7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXRIYXNoDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzDQogICAgICogQHBhcmFtIHtCaWdOdW1iZXJ9IGRhdGEuYW1vdW50DQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlVHJhbnNhY3Rpb25IYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImNyZWF0ZVN3YXBUYXJnZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jcmVhdGVTd2FwVGFyZ2V0ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTkoZGF0YSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSB7CiAgICAgICAgdmFyIHNlY3JldEhhc2gsIHBhcnRpY2lwYW50QWRkcmVzcywgYW1vdW50LCB0YXJnZXRXYWxsZXQsIGV4cCwgbmV3QW1vdW50LCBoYXNoLCBhcmdzOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTkkKF9jb250ZXh0OSkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDkucHJldiA9IF9jb250ZXh0OS5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgc2VjcmV0SGFzaCA9IGRhdGEuc2VjcmV0SGFzaCwgcGFydGljaXBhbnRBZGRyZXNzID0gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MsIGFtb3VudCA9IGRhdGEuYW1vdW50LCB0YXJnZXRXYWxsZXQgPSBkYXRhLnRhcmdldFdhbGxldDsKICAgICAgICAgICAgICAgIGV4cCA9IG5ldyBCaWdOdW1iZXIoMTApLnBvdyh0aGlzLmRlY2ltYWxzKTsKICAgICAgICAgICAgICAgIG5ld0Ftb3VudCA9IG5ldyBCaWdOdW1iZXIoYW1vdW50KS50aW1lcyhleHApLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICBoYXNoID0gIjB4Ii5jb25jYXQoc2VjcmV0SGFzaC5yZXBsYWNlKC9eMHgvLCAnJykpOwogICAgICAgICAgICAgICAgYXJncyA9IFtoYXNoLCBwYXJ0aWNpcGFudEFkZHJlc3MsIHRhcmdldFdhbGxldCwgbmV3QW1vdW50LCB0aGlzLnRva2VuQWRkcmVzc107CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LmFicnVwdCgicmV0dXJuIiwgdGhpcy5zZW5kKCdjcmVhdGVTd2FwVGFyZ2V0JywgW10uY29uY2F0KGFyZ3MpLCB7fSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSk7CgogICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlOSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGNyZWF0ZVN3YXBUYXJnZXQoX3gxNCwgX3gxNSkgewogICAgICAgIHJldHVybiBfY3JlYXRlU3dhcFRhcmdldC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gY3JlYXRlU3dhcFRhcmdldDsKICAgIH0oKQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLm93bmVyQWRkcmVzcw0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcw0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJzd2FwcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc3dhcHMoZGF0YSkgewogICAgICB2YXIgb3duZXJBZGRyZXNzID0gZGF0YS5vd25lckFkZHJlc3MsCiAgICAgICAgICBwYXJ0aWNpcGFudEFkZHJlc3MgPSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzczsKICAgICAgcmV0dXJuIHRoaXMuY29udHJhY3QubWV0aG9kcy5zd2Fwcyhvd25lckFkZHJlc3MsIHBhcnRpY2lwYW50QWRkcmVzcykuY2FsbCgpOwogICAgfQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLm93bmVyQWRkcmVzcw0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcw0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJjaGVja1N3YXBFeGlzdHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jaGVja1N3YXBFeGlzdHMgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTAoZGF0YSkgewogICAgICAgIHZhciBzd2FwLCBiYWxhbmNlOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTEwJChfY29udGV4dDEwKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTAucHJldiA9IF9jb250ZXh0MTAubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0MTAubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zd2FwcyhkYXRhKTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgc3dhcCA9IF9jb250ZXh0MTAuc2VudDsKICAgICAgICAgICAgICAgIC8vQAogICAgICAgICAgICAgICAgZGVidWcoJ3N3YXBFeGlzdHMnLCBzd2FwKTsKICAgICAgICAgICAgICAgIGJhbGFuY2UgPSBzd2FwICYmIHN3YXAuYmFsYW5jZSA/IHBhcnNlSW50KHN3YXAuYmFsYW5jZSkgOiAwOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTAuYWJydXB0KCJyZXR1cm4iLCBiYWxhbmNlID4gMCk7CgogICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTAuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTEwLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gY2hlY2tTd2FwRXhpc3RzKF94MTYpIHsKICAgICAgICByZXR1cm4gX2NoZWNrU3dhcEV4aXN0cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gY2hlY2tTd2FwRXhpc3RzOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEub3duZXJBZGRyZXNzDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImdldEJhbGFuY2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldEJhbGFuY2UoZGF0YSkgewogICAgICB2YXIgb3duZXJBZGRyZXNzID0gZGF0YS5vd25lckFkZHJlc3M7CiAgICAgIHJldHVybiB0aGlzLmNvbnRyYWN0Lm1ldGhvZHMuZ2V0QmFsYW5jZShvd25lckFkZHJlc3MpLmNhbGwoewogICAgICAgIGZyb206IHRoaXMuYXBwLmdldE15RXRoQWRkcmVzcygpCiAgICAgIH0pOwogICAgfQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLm93bmVyQWRkcmVzcw0KICAgICAqIEBwYXJhbSB7QmlnTnVtYmVyfSBkYXRhLmV4cGVjdGVkVmFsdWUNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZS48c3RyaW5nPn0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiY2hlY2tCYWxhbmNlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfY2hlY2tCYWxhbmNlID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTExKGRhdGEpIHsKICAgICAgICB2YXIgX3RoaXM1ID0gdGhpczsKCiAgICAgICAgdmFyIG93bmVyQWRkcmVzcywgcGFydGljaXBhbnRBZGRyZXNzLCBleHBlY3RlZFZhbHVlLCBleHBlY3RlZEhhc2gsIGJhbGFuY2UsIHN3YXAsIHNlY3JldEhhc2gsIF9zZWNyZXRIYXNoLCBleHBlY3RlZFZhbHVlV2VpOwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxMSQoX2NvbnRleHQxMSkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDExLnByZXYgPSBfY29udGV4dDExLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBvd25lckFkZHJlc3MgPSBkYXRhLm93bmVyQWRkcmVzcywgcGFydGljaXBhbnRBZGRyZXNzID0gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MsIGV4cGVjdGVkVmFsdWUgPSBkYXRhLmV4cGVjdGVkVmFsdWUsIGV4cGVjdGVkSGFzaCA9IGRhdGEuZXhwZWN0ZWRIYXNoOwogICAgICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gMzsKICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLmhlbHBlcnMucmVwZWF0QXN5bmNVbnRpbFJlc3VsdChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczUuZ2V0QmFsYW5jZSh7CiAgICAgICAgICAgICAgICAgICAgb3duZXJBZGRyZXNzOiBvd25lckFkZHJlc3MKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgYmFsYW5jZSA9IF9jb250ZXh0MTEuc2VudDsKICAgICAgICAgICAgICAgIF9jb250ZXh0MTEubmV4dCA9IDY7CiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5oZWxwZXJzLnJlcGVhdEFzeW5jVW50aWxSZXN1bHQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXM1LmNvbnRyYWN0Lm1ldGhvZHMuc3dhcHMob3duZXJBZGRyZXNzLCBwYXJ0aWNpcGFudEFkZHJlc3MpLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICBzd2FwID0gX2NvbnRleHQxMS5zZW50OwogICAgICAgICAgICAgICAgLy9ACiAgICAgICAgICAgICAgICBzZWNyZXRIYXNoID0gc3dhcC5zZWNyZXRIYXNoOwogICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpzd2FwcycpKCJzd2FwLnNlY3JldEhhc2giLCBzZWNyZXRIYXNoKTsKICAgICAgICAgICAgICAgIF9zZWNyZXRIYXNoID0gIiIuY29uY2F0KHNlY3JldEhhc2gucmVwbGFjZSgvXjB4LywgJycpKTsKICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6c3dhcHMnKSgic2VjcmV0SGFzaDogZXhwZWN0ZWQgaGFzaCA9ICIuY29uY2F0KGV4cGVjdGVkSGFzaCwgIiwgY29udHJhY3QgaGFzaCA9ICIpLmNvbmNhdChfc2VjcmV0SGFzaCkpOwoKICAgICAgICAgICAgICAgIGlmICghKGV4cGVjdGVkSGFzaCAhPT0gX3NlY3JldEhhc2gpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTEubmV4dCA9IDEzOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMS5hYnJ1cHQoInJldHVybiIsICJFeHBlY3RlZCBoYXNoOiAiLmNvbmNhdChleHBlY3RlZEhhc2gsICIsIGdvdDogIikuY29uY2F0KF9zZWNyZXRIYXNoKSk7CgogICAgICAgICAgICAgIGNhc2UgMTM6CiAgICAgICAgICAgICAgICBleHBlY3RlZFZhbHVlV2VpID0gbmV3IEJpZ051bWJlcihleHBlY3RlZFZhbHVlKS5tdWx0aXBsaWVkQnkodGhpcy5kZWNpbWFscyk7CgogICAgICAgICAgICAgICAgaWYgKCFleHBlY3RlZFZhbHVlV2VpLmlzR3JlYXRlclRoYW4oYmFsYW5jZSkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gMTY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDExLmFicnVwdCgicmV0dXJuIiwgIkV4cGVjdGVkIHZhbHVlOiAiLmNvbmNhdChleHBlY3RlZFZhbHVlV2VpLnRvU3RyaW5nKCksICIsIGdvdDogIikuY29uY2F0KGJhbGFuY2UpKTsKCiAgICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTExLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gY2hlY2tCYWxhbmNlKF94MTcpIHsKICAgICAgICByZXR1cm4gX2NoZWNrQmFsYW5jZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gY2hlY2tCYWxhbmNlOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJmZXRjaFN3YXBFdmVudHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9mZXRjaFN3YXBFdmVudHMgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTIoKSB7CiAgICAgICAgdmFyIF90aGlzNiA9IHRoaXM7CgogICAgICAgIHZhciBhbGxTd2FwRXZlbnRzOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTEyJChfY29udGV4dDEyKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTIucHJldiA9IF9jb250ZXh0MTIubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGlmICghdGhpcy5fYWxsU3dhcEV2ZW50cykgewogICAgICAgICAgICAgICAgICBfY29udGV4dDEyLm5leHQgPSAyOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMi5hYnJ1cHQoInJldHVybiIsIHRoaXMuX2FsbFN3YXBFdmVudHMpOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBfY29udGV4dDEyLm5leHQgPSA0OwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29udHJhY3QuZ2V0UGFzdEV2ZW50cygnYWxsRXZlbnRzJywgewogICAgICAgICAgICAgICAgICBmcm9tQmxvY2s6IDAsCiAgICAgICAgICAgICAgICAgIHRvQmxvY2s6ICdsYXRlc3QnCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgYWxsU3dhcEV2ZW50cyA9IF9jb250ZXh0MTIuc2VudDsKICAgICAgICAgICAgICAgIHRoaXMuY29udHJhY3QuZXZlbnRzLmFsbEV2ZW50cyh7CiAgICAgICAgICAgICAgICAgIGZyb21CbG9jazogMCwKICAgICAgICAgICAgICAgICAgdG9CbG9jazogJ2xhdGVzdCcKICAgICAgICAgICAgICAgIH0pLm9uKCdkYXRhJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgIF90aGlzNi5fYWxsU3dhcEV2ZW50cy5wdXNoKGV2ZW50KTsKICAgICAgICAgICAgICAgIH0pLm9uKCdjaGFuZ2VkJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkV0aFRva2VuU3dhcDogZmV0Y2hFdmVudHM6IG5lZWRzIHJlc2NhbiIpOwogICAgICAgICAgICAgICAgICBfdGhpczYuX2FsbFN3YXBFdmVudHMgPSBudWxsOwogICAgICAgICAgICAgICAgfSkub24oJ2Vycm9yJywgZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICAgICAgICAgICAgICAgIF90aGlzNi5fYWxsU3dhcEV2ZW50cyA9IG51bGw7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuX2FsbFN3YXBFdmVudHMgPSBhbGxTd2FwRXZlbnRzOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTIuYWJydXB0KCJyZXR1cm4iLCBhbGxTd2FwRXZlbnRzKTsKCiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMi5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTIsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBmZXRjaFN3YXBFdmVudHMoKSB7CiAgICAgICAgcmV0dXJuIF9mZXRjaFN3YXBFdmVudHMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZldGNoU3dhcEV2ZW50czsKICAgIH0oKQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLnNlY3JldEhhc2gNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZmluZFN3YXAiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9maW5kU3dhcCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxMyhkYXRhKSB7CiAgICAgICAgdmFyIHNlY3JldEhhc2gsIGFsbFN3YXBFdmVudHMsIHN3YXBFdmVudHMsIF9zd2FwRXZlbnRzLCBjcmVhdGUsIGNsb3NlLCByZXN0OwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxMyQoX2NvbnRleHQxMykgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDEzLnByZXYgPSBfY29udGV4dDEzLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBzZWNyZXRIYXNoID0gZGF0YS5zZWNyZXRIYXNoOwogICAgICAgICAgICAgICAgX2NvbnRleHQxMy5uZXh0ID0gMzsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmZldGNoU3dhcEV2ZW50cygpOwoKICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICBhbGxTd2FwRXZlbnRzID0gX2NvbnRleHQxMy5zZW50OwogICAgICAgICAgICAgICAgc3dhcEV2ZW50cyA9IGFsbFN3YXBFdmVudHMuZmlsdGVyKGZ1bmN0aW9uIChfcmVmNCkgewogICAgICAgICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWVzID0gX3JlZjQucmV0dXJuVmFsdWVzOwogICAgICAgICAgICAgICAgICByZXR1cm4gcmV0dXJuVmFsdWVzLl9zZWNyZXRIYXNoID09PSAiMHgiLmNvbmNhdChzZWNyZXRIYXNoLnJlcGxhY2UoJzB4JywgJycpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgX3N3YXBFdmVudHMgPSBfdG9BcnJheShzd2FwRXZlbnRzKSwgY3JlYXRlID0gX3N3YXBFdmVudHNbMF0sIGNsb3NlID0gX3N3YXBFdmVudHNbMV0sIHJlc3QgPSBfc3dhcEV2ZW50cy5zbGljZSgyKTsKCiAgICAgICAgICAgICAgICBpZiAocmVzdCAmJiByZXN0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJNb3JlIHRoYW4gdHdvIHN3YXBzIHdpdGggc2FtZSBoYXNoIiwgcmVzdCk7IC8vIHRocm93IG5ldyBFcnJvcihgTW9yZSB0aGFuIHR3byBzd2FwcyB3aXRoIHNhbWUgaGFzaGApCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTMuYWJydXB0KCJyZXR1cm4iLCBbY3JlYXRlLCBjbG9zZV0pOwoKICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDEzLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUxMywgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGZpbmRTd2FwKF94MTgpIHsKICAgICAgICByZXR1cm4gX2ZpbmRTd2FwLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBmaW5kU3dhcDsKICAgIH0oKQogICAgLyoqDQogICAgICAqDQogICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLnNlY3JldEhhc2gNCiAgICAgICogQHJldHVybnMge1Byb21pc2Uoc3RhdHVzKX0NCiAgICAgICovCgogIH0sIHsKICAgIGtleTogIndhc0Nsb3NlZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3dhc0Nsb3NlZCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxNChkYXRhKSB7CiAgICAgICAgdmFyIF95aWVsZCR0aGlzJGZpbmRTd2FwLCBfeWllbGQkdGhpcyRmaW5kU3dhcDIsIGNyZWF0ZSwgY2xvc2U7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE0JChfY29udGV4dDE0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTQucHJldiA9IF9jb250ZXh0MTQubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0MTQubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5maW5kU3dhcChkYXRhKTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgX3lpZWxkJHRoaXMkZmluZFN3YXAgPSBfY29udGV4dDE0LnNlbnQ7CiAgICAgICAgICAgICAgICBfeWllbGQkdGhpcyRmaW5kU3dhcDIgPSBfc2xpY2VkVG9BcnJheShfeWllbGQkdGhpcyRmaW5kU3dhcCwgMik7CiAgICAgICAgICAgICAgICBjcmVhdGUgPSBfeWllbGQkdGhpcyRmaW5kU3dhcDJbMF07CiAgICAgICAgICAgICAgICBjbG9zZSA9IF95aWVsZCR0aGlzJGZpbmRTd2FwMlsxXTsKCiAgICAgICAgICAgICAgICBpZiAoY3JlYXRlKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTQubmV4dCA9IDExOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBkZWJ1ZygiTm8gc3dhcCB3aXRoIGhhc2ggIi5jb25jYXQoZGF0YS5zZWNyZXRIYXNoKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNC5hYnJ1cHQoInJldHVybiIsICdubyBzd2FwJyk7CgogICAgICAgICAgICAgIGNhc2UgMTE6CiAgICAgICAgICAgICAgICBpZiAoIShjcmVhdGUgJiYgIWNsb3NlKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDE0Lm5leHQgPSAxNjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZGVidWcoIk9wZW4geWV0ISIpOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTQuYWJydXB0KCJyZXR1cm4iLCAnb3BlbicpOwoKICAgICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICAgICAgaWYgKCEoY2xvc2UuZXZlbnQgPT0gJ1dpdGhkcmF3JykpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQxNC5uZXh0ID0gMjE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGRlYnVnKCJXaXRoZHJhd24iKTsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE0LmFicnVwdCgicmV0dXJuIiwgJ3dpdGhkcmF3bicpOwoKICAgICAgICAgICAgICBjYXNlIDIxOgogICAgICAgICAgICAgICAgaWYgKCEoY2xvc2UuZXZlbnQgPT0gJ1JlZnVuZCcpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTQubmV4dCA9IDI2OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBkZWJ1ZygiUmVmdW5kIik7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNC5hYnJ1cHQoInJldHVybiIsICdyZWZ1bmRlZCcpOwoKICAgICAgICAgICAgICBjYXNlIDI2OgogICAgICAgICAgICAgICAgZGVidWcoIlVua25vd24gZXZlbnQsIGVycm9yIik7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNC5hYnJ1cHQoInJldHVybiIsICdlcnJvcicpOwoKICAgICAgICAgICAgICBjYXNlIDI4OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTQsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiB3YXNDbG9zZWQoX3gxOSkgewogICAgICAgIHJldHVybiBfd2FzQ2xvc2VkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB3YXNDbG9zZWQ7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXRIYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2UoYm9vbGVhbil9DQogICAgICovCgogIH0sIHsKICAgIGtleTogIndhc1JlZnVuZGVkIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB3YXNSZWZ1bmRlZChkYXRhKSB7CiAgICAgIHJldHVybiB0aGlzLndhc0Nsb3NlZChkYXRhKS50aGVuKGZ1bmN0aW9uIChzdGF0dXMpIHsKICAgICAgICByZXR1cm4gc3RhdHVzID09PSAncmVmdW5kZWQnOwogICAgICB9KTsKICAgIH0KICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXRIYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2UoYm9vbGVhbil9DQogICAgICovCgogIH0sIHsKICAgIGtleTogIndhc1dpdGhkcmF3biIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3dhc1dpdGhkcmF3biA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxNShkYXRhKSB7CiAgICAgICAgdmFyIHN0YXR1czsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxNSQoX2NvbnRleHQxNSkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDE1LnByZXYgPSBfY29udGV4dDE1Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDE1Lm5leHQgPSAyOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMud2FzQ2xvc2VkKGRhdGEpOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBzdGF0dXMgPSBfY29udGV4dDE1LnNlbnQ7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNS5hYnJ1cHQoInJldHVybiIsIHN0YXR1cyA9PT0gJ3dpdGhkcmF3bicpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE1LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUxNSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHdhc1dpdGhkcmF3bihfeDIwKSB7CiAgICAgICAgcmV0dXJuIF93YXNXaXRoZHJhd24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHdhc1dpdGhkcmF3bjsKICAgIH0oKQogICAgLyoqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5vd25lckFkZHJlc3MNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdG9rZW5BZGRyZXNzDQogICAgICovCgogIH0sIHsKICAgIGtleTogImNoZWNrVG9rZW5Jc1ZhbGlkIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfY2hlY2tUb2tlbklzVmFsaWQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTYoZGF0YSkgewogICAgICAgIHZhciBfdGhpczcgPSB0aGlzOwoKICAgICAgICB2YXIgb3duZXJBZGRyZXNzLCBwYXJ0aWNpcGFudEFkZHJlc3MsIHN3YXAsIHRva2VuOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE2JChfY29udGV4dDE2KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTYucHJldiA9IF9jb250ZXh0MTYubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzcyA9IGRhdGEub3duZXJBZGRyZXNzLCBwYXJ0aWNpcGFudEFkZHJlc3MgPSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzczsKICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6c3dhcHMnKSgiQ2hlY2sgdG9rZW4gaXMgdmFsaWQuIE5lZWRlZCB0b2tlbiBhZGRyZXNzOiAiLmNvbmNhdCh0aGlzLnRva2VuQWRkcmVzcy50b1VwcGVyQ2FzZSgpKSk7CiAgICAgICAgICAgICAgICBfY29udGV4dDE2Lm5leHQgPSA0OwogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy5yZXBlYXRBc3luY1VudGlsUmVzdWx0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzNy5jb250cmFjdC5tZXRob2RzLnN3YXBzKG93bmVyQWRkcmVzcywgcGFydGljaXBhbnRBZGRyZXNzKS5jYWxsKCk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgc3dhcCA9IF9jb250ZXh0MTYuc2VudDsKICAgICAgICAgICAgICAgIHRva2VuID0gc3dhcC50b2tlbjsKICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6c3dhcHMnKSgiVG9rZW4gYWRkcmVzcyBhdCBzd2FwIGNvbnRyYWN0OiAiLmNvbmNhdCh0b2tlbi50b1VwcGVyQ2FzZSgpKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNi5hYnJ1cHQoInJldHVybiIsIHRoaXMudG9rZW5BZGRyZXNzLnRvVXBwZXJDYXNlKCkgPT0gdG9rZW4udG9VcHBlckNhc2UoKSk7CgogICAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTYuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTE2LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gY2hlY2tUb2tlbklzVmFsaWQoX3gyMSkgewogICAgICAgIHJldHVybiBfY2hlY2tUb2tlbklzVmFsaWQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNoZWNrVG9rZW5Jc1ZhbGlkOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEByZXR1cm5zIHtib29sZWFufQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJoYXNUYXJnZXRXYWxsZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGhhc1RhcmdldFdhbGxldCgpIHsKICAgICAgcmV0dXJuICEhdGhpcy5jb250cmFjdC5tZXRob2RzLmdldFRhcmdldFdhbGxldDsKICAgIH0KICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtzdHJpbmd9IG93bmVyQWRkcmVzcw0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlLjxzdHJpbmc+fQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZXRUYXJnZXRXYWxsZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9nZXRUYXJnZXRXYWxsZXQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTcob3duZXJBZGRyZXNzKSB7CiAgICAgICAgdmFyIF90aGlzOCA9IHRoaXM7CgogICAgICAgIHZhciBhZGRyZXNzOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE3JChfY29udGV4dDE3KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTcucHJldiA9IF9jb250ZXh0MTcubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0MTcubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5oZWxwZXJzLnJlcGVhdEFzeW5jVW50aWxSZXN1bHQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXM4LmdldFRhcmdldFdhbGxldFByb21pc2Uob3duZXJBZGRyZXNzKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBhZGRyZXNzID0gX2NvbnRleHQxNy5zZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTcuYWJydXB0KCJyZXR1cm4iLCBhZGRyZXNzKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNy5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTcpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBnZXRUYXJnZXRXYWxsZXQoX3gyMikgewogICAgICAgIHJldHVybiBfZ2V0VGFyZ2V0V2FsbGV0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBnZXRUYXJnZXRXYWxsZXQ7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtzdHJpbmd9IG93bmVyQWRkcmVzcw0KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImdldFRhcmdldFdhbGxldFByb21pc2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9nZXRUYXJnZXRXYWxsZXRQcm9taXNlID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTE5KG93bmVyQWRkcmVzcykgewogICAgICAgIHZhciBfdGhpczkgPSB0aGlzOwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxOSQoX2NvbnRleHQxOSkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDE5LnByZXYgPSBfY29udGV4dDE5Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOnN3YXBzJykoJ0V0aFRva2VuU3dhcC0+Z2V0VGFyZ2V0V2FsbGV0Jyk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxOS5hYnJ1cHQoInJldHVybiIsIG5ldyBQcm9taXNlKCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB2YXIgX3JlZjUgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTgocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldFdhbGxldDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxOCQoX2NvbnRleHQxOCkgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDE4LnByZXYgPSBfY29udGV4dDE4Lm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDE4LnByZXYgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxOC5uZXh0ID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczkuY29udHJhY3QubWV0aG9kcy5nZXRUYXJnZXRXYWxsZXQob3duZXJBZGRyZXNzKS5jYWxsKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogX3RoaXM5LmFwcC5nZXRNeUV0aEFkZHJlc3MoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFdhbGxldCA9IF9jb250ZXh0MTguc2VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6c3dhcHMnKSgnRXRoVG9rZW5Td2FwLT5nZXRUYXJnZXRXYWxsZXQnLCB0YXJnZXRXYWxsZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0YXJnZXRXYWxsZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxOC5uZXh0ID0gMTE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxOC5wcmV2ID0gODsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTgudDAgPSBfY29udGV4dDE4WyJjYXRjaCJdKDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KF9jb250ZXh0MTgudDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxOC5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMTgsIG51bGwsIFtbMCwgOF1dKTsKICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeDI0LCBfeDI1KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWY1LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KCkpKTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxOS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTkpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBnZXRUYXJnZXRXYWxsZXRQcm9taXNlKF94MjMpIHsKICAgICAgICByZXR1cm4gX2dldFRhcmdldFdhbGxldFByb21pc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGdldFRhcmdldFdhbGxldFByb21pc2U7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXQNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5vd25lckFkZHJlc3MNCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBoYW5kbGVUcmFuc2FjdGlvbkhhc2gNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiY2FsY1dpdGhkcmF3R2FzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfY2FsY1dpdGhkcmF3R2FzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIwKGRhdGEpIHsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUyMCQoX2NvbnRleHQyMCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDIwLnByZXYgPSBfY29udGV4dDIwLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyMC5hYnJ1cHQoInJldHVybiIsIHRoaXMuY2FsY1dpdGhkcmF3T3RoZXJHYXMoewogICAgICAgICAgICAgICAgICBvd25lckFkZHJlc3M6IGRhdGEub3duZXJBZGRyZXNzLAogICAgICAgICAgICAgICAgICBwYXJ0aWNpcGFudEFkZHJlc3M6IHRoaXMuYXBwLmdldE15RXRoQWRkcmVzcygpLAogICAgICAgICAgICAgICAgICBzZWNyZXQ6IGRhdGEuc2VjcmV0CiAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjAuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTIwLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gY2FsY1dpdGhkcmF3R2FzKF94MjYpIHsKICAgICAgICByZXR1cm4gX2NhbGNXaXRoZHJhd0dhcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gY2FsY1dpdGhkcmF3R2FzOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0DQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEub3duZXJBZGRyZXNzDQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlVHJhbnNhY3Rpb25IYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogIndpdGhkcmF3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfd2l0aGRyYXcgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMjEoZGF0YSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMjEkKF9jb250ZXh0MjEpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyMS5wcmV2ID0gX2NvbnRleHQyMS5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjEuYWJydXB0KCJyZXR1cm4iLCB0aGlzLndpdGhkcmF3T3RoZXIoewogICAgICAgICAgICAgICAgICBvd25lckFkZHJlc3M6IGRhdGEub3duZXJBZGRyZXNzLAogICAgICAgICAgICAgICAgICBwYXJ0aWNpcGFudEFkZHJlc3M6IHRoaXMuYXBwLmdldE15RXRoQWRkcmVzcygpLAogICAgICAgICAgICAgICAgICBzZWNyZXQ6IGRhdGEuc2VjcmV0CiAgICAgICAgICAgICAgICB9LCBoYW5kbGVUcmFuc2FjdGlvbkhhc2gpKTsKCiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyMS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMjEsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiB3aXRoZHJhdyhfeDI3LCBfeDI4KSB7CiAgICAgICAgcmV0dXJuIF93aXRoZHJhdy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gd2l0aGRyYXc7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXQNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiY2FsY1dpdGhkcmF3Tm9Nb25leUdhcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2NhbGNXaXRoZHJhd05vTW9uZXlHYXMgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMjIoZGF0YSkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIyJChfY29udGV4dDIyKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MjIucHJldiA9IF9jb250ZXh0MjIubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIyLmFicnVwdCgicmV0dXJuIiwgdGhpcy5jYWxjV2l0aGRyYXdPdGhlckdhcyh7CiAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogdGhpcy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCksCiAgICAgICAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MsCiAgICAgICAgICAgICAgICAgIHNlY3JldDogZGF0YS5zZWNyZXQKICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyMi5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMjIsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBjYWxjV2l0aGRyYXdOb01vbmV5R2FzKF94MjkpIHsKICAgICAgICByZXR1cm4gX2NhbGNXaXRoZHJhd05vTW9uZXlHYXMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNhbGNXaXRoZHJhd05vTW9uZXlHYXM7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXQNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MNCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBoYW5kbGVUcmFuc2FjdGlvbkhhc2gNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAid2l0aGRyYXdOb01vbmV5IiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfd2l0aGRyYXdOb01vbmV5ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIzKGRhdGEsIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIzJChfY29udGV4dDIzKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MjMucHJldiA9IF9jb250ZXh0MjMubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIzLmFicnVwdCgicmV0dXJuIiwgdGhpcy53aXRoZHJhd090aGVyKHsKICAgICAgICAgICAgICAgICAgb3duZXJBZGRyZXNzOiB0aGlzLmFwcC5nZXRNeUV0aEFkZHJlc3MoKSwKICAgICAgICAgICAgICAgICAgcGFydGljaXBhbnRBZGRyZXNzOiBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcywKICAgICAgICAgICAgICAgICAgc2VjcmV0OiBkYXRhLnNlY3JldAogICAgICAgICAgICAgICAgfSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSk7CgogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjMuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTIzLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gd2l0aGRyYXdOb01vbmV5KF94MzAsIF94MzEpIHsKICAgICAgICByZXR1cm4gX3dpdGhkcmF3Tm9Nb25leS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gd2l0aGRyYXdOb01vbmV5OwogICAgfSgpCiAgfSwgewogICAga2V5OiAiY2FsY1dpdGhkcmF3T3RoZXJHYXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jYWxjV2l0aGRyYXdPdGhlckdhcyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyNShkYXRhKSB7CiAgICAgICAgdmFyIF90aGlzMTAgPSB0aGlzOwoKICAgICAgICB2YXIgb3duZXJBZGRyZXNzLCBwYXJ0aWNpcGFudEFkZHJlc3MsIHNlY3JldDsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUyNSQoX2NvbnRleHQyNSkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDI1LnByZXYgPSBfY29udGV4dDI1Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBvd25lckFkZHJlc3MgPSBkYXRhLm93bmVyQWRkcmVzcywgcGFydGljaXBhbnRBZGRyZXNzID0gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MsIHNlY3JldCA9IGRhdGEuc2VjcmV0OwogICAgICAgICAgICAgICAgX2NvbnRleHQyNS5uZXh0ID0gMzsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZUdhc1ByaWNlKCk7CgogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDI1LmFicnVwdCgicmV0dXJuIiwgbmV3IFByb21pc2UoIC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfcmVmNiA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyNChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3NlY3JldCwgcGFyYW1zLCBnYXNBbW91bnQ7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTI0JChfY29udGV4dDI0KSB7CiAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MjQucHJldiA9IF9jb250ZXh0MjQubmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9zZWNyZXQgPSAiMHgiLmNvbmNhdChzZWNyZXQucmVwbGFjZSgvXjB4LywgJycpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogX3RoaXMxMC5hcHAuZ2V0TXlFdGhBZGRyZXNzKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhczogX3RoaXMxMC5nYXNMaW1pdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FzUHJpY2U6IF90aGlzMTAuZ2FzUHJpY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDI0LnByZXYgPSAyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyNC5uZXh0ID0gNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczEwLmNvbnRyYWN0Lm1ldGhvZHMud2l0aGRyYXdPdGhlcihfc2VjcmV0LCBvd25lckFkZHJlc3MsIHBhcnRpY2lwYW50QWRkcmVzcykuZXN0aW1hdGVHYXMocGFyYW1zKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FzQW1vdW50ID0gX2NvbnRleHQyNC5zZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShnYXNBbW91bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyNC5uZXh0ID0gMTI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyNC5wcmV2ID0gOTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjQudDAgPSBfY29udGV4dDI0WyJjYXRjaCJdKDIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KF9jb250ZXh0MjQudDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyNC5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMjQsIG51bGwsIFtbMiwgOV1dKTsKICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeDMzLCBfeDM0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWY2LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KCkpKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyNS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMjUsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBjYWxjV2l0aGRyYXdPdGhlckdhcyhfeDMyKSB7CiAgICAgICAgcmV0dXJuIF9jYWxjV2l0aGRyYXdPdGhlckdhcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gY2FsY1dpdGhkcmF3T3RoZXJHYXM7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXQNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5vd25lckFkZHJlc3MNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MNCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBoYW5kbGVUcmFuc2FjdGlvbkhhc2gNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAid2l0aGRyYXdPdGhlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3dpdGhkcmF3T3RoZXIgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMjYoZGF0YSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSB7CiAgICAgICAgdmFyIG93bmVyQWRkcmVzcywgcGFydGljaXBhbnRBZGRyZXNzLCBzZWNyZXQsIF9zZWNyZXQ7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTI2JChfY29udGV4dDI2KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MjYucHJldiA9IF9jb250ZXh0MjYubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzcyA9IGRhdGEub3duZXJBZGRyZXNzLCBwYXJ0aWNpcGFudEFkZHJlc3MgPSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcywgc2VjcmV0ID0gZGF0YS5zZWNyZXQ7CiAgICAgICAgICAgICAgICBfc2VjcmV0ID0gIjB4Ii5jb25jYXQoc2VjcmV0LnJlcGxhY2UoL14weC8sICcnKSk7CiAgICAgICAgICAgICAgICBfY29udGV4dDI2Lm5leHQgPSA0OwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlR2FzUHJpY2UoKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjYuYWJydXB0KCJyZXR1cm4iLCB0aGlzLnNlbmQoJ3dpdGhkcmF3T3RoZXInLCBbX3NlY3JldCwgb3duZXJBZGRyZXNzLCBwYXJ0aWNpcGFudEFkZHJlc3NdLCB7fSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSk7CgogICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjYuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTI2LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gd2l0aGRyYXdPdGhlcihfeDM1LCBfeDM2KSB7CiAgICAgICAgcmV0dXJuIF93aXRoZHJhd090aGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB3aXRoZHJhd090aGVyOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzDQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlVHJhbnNhY3Rpb25IYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogInJlZnVuZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3JlZnVuZCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyNyhkYXRhLCBoYW5kbGVUcmFuc2FjdGlvbkhhc2gpIHsKICAgICAgICB2YXIgcGFydGljaXBhbnRBZGRyZXNzOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTI3JChfY29udGV4dDI3KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MjcucHJldiA9IF9jb250ZXh0MjcubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzcyA9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzOwogICAgICAgICAgICAgICAgX2NvbnRleHQyNy5uZXh0ID0gMzsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZUdhc1ByaWNlKCk7CgogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDI3LmFicnVwdCgicmV0dXJuIiwgdGhpcy5zZW5kKCdyZWZ1bmQnLCBbcGFydGljaXBhbnRBZGRyZXNzXSwge30sIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCkpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDI3LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUyNywgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHJlZnVuZChfeDM3LCBfeDM4KSB7CiAgICAgICAgcmV0dXJuIF9yZWZ1bmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlZnVuZDsKICAgIH0oKQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcw0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZXRTZWNyZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldFNlY3JldChkYXRhKSB7CiAgICAgIHZhciBfdGhpczExID0gdGhpczsKCiAgICAgIHZhciBwYXJ0aWNpcGFudEFkZHJlc3MgPSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzczsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfcmVmNyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyOChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIHZhciBzZWNyZXQsIHNlY3JldFZhbHVlOwogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMjgkKF9jb250ZXh0MjgpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MjgucHJldiA9IF9jb250ZXh0MjgubmV4dCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBfY29udGV4dDI4LnByZXYgPSAwOwogICAgICAgICAgICAgICAgICBfY29udGV4dDI4Lm5leHQgPSAzOwogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMxMS5jb250cmFjdC5tZXRob2RzLmdldFNlY3JldChwYXJ0aWNpcGFudEFkZHJlc3MpLmNhbGwoewogICAgICAgICAgICAgICAgICAgIGZyb206IF90aGlzMTEuYXBwLmdldE15RXRoQWRkcmVzcygpCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgc2VjcmV0ID0gX2NvbnRleHQyOC5zZW50OwogICAgICAgICAgICAgICAgICBzZWNyZXRWYWx1ZSA9IHNlY3JldCAmJiAhL14weDArJC8udGVzdChzZWNyZXQpID8gc2VjcmV0IDogbnVsbDsKICAgICAgICAgICAgICAgICAgcmVzb2x2ZShzZWNyZXRWYWx1ZSk7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjgubmV4dCA9IDExOwogICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjgucHJldiA9IDg7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjgudDAgPSBfY29udGV4dDI4WyJjYXRjaCJdKDApOwogICAgICAgICAgICAgICAgICByZWplY3QoX2NvbnRleHQyOC50MCk7CgogICAgICAgICAgICAgICAgY2FzZSAxMToKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDI4LnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIF9jYWxsZWUyOCwgbnVsbCwgW1swLCA4XV0pOwogICAgICAgIH0pKTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeDM5LCBfeDQwKSB7CiAgICAgICAgICByZXR1cm4gX3JlZjcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICB9KCkpOwogICAgfQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHJhbnNhY3Rpb25IYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2U8YW55Pn0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZnVuZEVSQzIwQ29udHJhY3QiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9mdW5kRVJDMjBDb250cmFjdCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUzMShfcmVmOCkgewogICAgICAgIHZhciBmbG93LCBhYkNsYXNzLCBfZmxvdyRzd2FwLCBwYXJ0aWNpcGFudCwgYnV5QW1vdW50LCBzZWxsQW1vdW50LCB3YWl0Q29uZmlybSwgc2VjcmV0SGFzaCwgc3dhcERhdGEsIHRyeUNyZWF0ZVN3YXAsIGlzRXRoQ29udHJhY3RGdW5kZWQsIGlzU3RvcHBlZFN3YXA7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTMxJChfY29udGV4dDMxKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MzEucHJldiA9IF9jb250ZXh0MzEubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGZsb3cgPSBfcmVmOC5mbG93OwogICAgICAgICAgICAgICAgYWJDbGFzcyA9IHRoaXM7CiAgICAgICAgICAgICAgICBfZmxvdyRzd2FwID0gZmxvdy5zd2FwLCBwYXJ0aWNpcGFudCA9IF9mbG93JHN3YXAucGFydGljaXBhbnQsIGJ1eUFtb3VudCA9IF9mbG93JHN3YXAuYnV5QW1vdW50LCBzZWxsQW1vdW50ID0gX2Zsb3ckc3dhcC5zZWxsQW1vdW50LCB3YWl0Q29uZmlybSA9IF9mbG93JHN3YXAud2FpdENvbmZpcm07CiAgICAgICAgICAgICAgICBzZWNyZXRIYXNoID0gZmxvdy5zdGF0ZS5zZWNyZXRIYXNoOwogICAgICAgICAgICAgICAgc3dhcERhdGEgPSB7CiAgICAgICAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogYWJDbGFzcy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKGZsb3cuc3dhcCksCiAgICAgICAgICAgICAgICAgIHNlY3JldEhhc2g6IHNlY3JldEhhc2gsCiAgICAgICAgICAgICAgICAgIGFtb3VudDogc2VsbEFtb3VudCwKICAgICAgICAgICAgICAgICAgdGFyZ2V0V2FsbGV0OiBmbG93LnN3YXAuZGVzdGluYXRpb25TZWxsQWRkcmVzcywKICAgICAgICAgICAgICAgICAgY2FsY0ZlZTogdHJ1ZQogICAgICAgICAgICAgICAgfTsgLy8gVE9ETyBmZWUgYWZ0ZXIgYWxsb3dhbmNlCiAgICAgICAgICAgICAgICAvLyBFdGhUb2tlblN3YXAgLT4gYXBwcm92ZSBuZWVkIGdhcyB0b28KCiAgICAgICAgICAgICAgICAvKiBjYWxjIGNyZWF0ZSBjb250cmFjdCBmZWUgYW5kIHNhdmUgdGhpcyAqLwoKICAgICAgICAgICAgICAgIC8qDQogICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7DQogICAgICAgICAgICAgICAgICBjcmVhdGVTd2FwRmVlOiBhd2FpdCBmbG93LmV0aFRva2VuU3dhcC5jcmVhdGUoc3dhcERhdGEpLA0KICAgICAgICAgICAgICAgIH0pDQogICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgICAgICBzd2FwRGF0YS5jYWxjRmVlID0gZmFsc2U7IC8vZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ2NyZWF0ZSBzd2FwIGZlZScsIGZsb3cuc3RhdGUuY3JlYXRlU3dhcEZlZSkKCiAgICAgICAgICAgICAgICB0cnlDcmVhdGVTd2FwID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWY5ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMwKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpc0V0aENvbnRyYWN0RnVuZGVkLCBhbGxvd2FuY2UsIHN3YXBFeGlzdHMsIG1lc3NhZ2UsIGdhc0Ftb3VudDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzMCQoX2NvbnRleHQzMCkgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDMwLnByZXYgPSBfY29udGV4dDMwLm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0V0aENvbnRyYWN0RnVuZGVkID0gZmxvdy5zdGF0ZS5pc0V0aENvbnRyYWN0RnVuZGVkOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0V0aENvbnRyYWN0RnVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MzAubmV4dCA9IDQwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMwLnByZXYgPSAyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ2ZldGNoaW5nIGFsbG93YW5jZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzMC5uZXh0ID0gNjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhYkNsYXNzLmNoZWNrQWxsb3dhbmNlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlbmRlcjogYWJDbGFzcy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvd2FuY2UgPSBfY29udGV4dDMwLnNlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgnYWxsb3dhbmNlJywgYWxsb3dhbmNlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5ldyBCaWdOdW1iZXIoYWxsb3dhbmNlKS5pc0xlc3NUaGFuKHNlbGxBbW91bnQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MzAubmV4dCA9IDEyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgnYWxsb3dhbmNlIDwgc2VsbEFtb3VudCcsIGFsbG93YW5jZSwgc2VsbEFtb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMwLm5leHQgPSAxMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhYkNsYXNzLmFwcHJvdmUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IHNlbGxBbW91bnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ2NoZWNrIHN3YXAgZXhpc3RzJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMwLm5leHQgPSAxNTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbG93Ll9jaGVja1N3YXBBbHJlYWR5RXhpc3RzKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2FwRXhpc3RzID0gX2NvbnRleHQzMC5zZW50OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3dhcEV4aXN0cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMwLm5leHQgPSAyMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdTd2FwIGV4aXN0cyEhIE1heSBiZSBzdHVja2VkLiBUcnkgcmVmdW5kJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMwLm5leHQgPSAyMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhYkNsYXNzLnJlZnVuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogYWJDbGFzcy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKGZsb3cuc3dhcCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChyZWZ1bmRUeCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgnU3R1Y2tlZCBzd2FwIHJlZnVuZGVkJywgcmVmdW5kVHgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMwLm5leHQgPSAyMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhYkNsYXNzLmNyZWF0ZShzd2FwRGF0YSwgLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9yZWYxMCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyOShoYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMjkkKF9jb250ZXh0MjkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyOS5wcmV2ID0gX2NvbnRleHQyOS5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ2NyZWF0ZSBzd2FwIHR4IGhhc2gnLCBoYXNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6ICdjcmVhdGUgZXRoIGNvbnRyYWN0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDogaGFzaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLm9uKCdyZXF1ZXN0IGV0aCBjb250cmFjdCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50OiAnY3JlYXRlIGV0aCBjb250cmFjdCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXRoU3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoOiBoYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDogaGFzaCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuQ3JlYXRlRXRoVHJhbnNhY3Rpb246IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzRmFpbGVkVHJhbnNhY3Rpb246IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCdjcmVhdGVkIHN3YXAhJywgaGFzaCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mjkuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgX2NhbGxlZTI5KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeDQyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWYxMC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSgpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyMjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MzAubmV4dCA9IDQwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMwLnByZXYgPSAyNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MzAudDAgPSBfY29udGV4dDMwWyJjYXRjaCJdKDIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZmxvdy5zdGF0ZS5ldGhTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzMC5uZXh0ID0gMzA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2ZhaWwgY3JlYXRlIHN3YXAsIGJ1dCB0eCBhbHJlYWR5IGV4aXN0cycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbkNyZWF0ZUV0aFRyYW5zYWN0aW9uOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0ZhaWxlZFRyYW5zYWN0aW9uOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzMC5hYnJ1cHQoInJldHVybiIsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDMwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IF9jb250ZXh0MzAudDAubWVzc2FnZSwgZ2FzQW1vdW50ID0gX2NvbnRleHQzMC50MC5nYXNBbW91bnQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEvaW5zdWZmaWNpZW50IGZ1bmRzLy50ZXN0KG1lc3NhZ2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MzAubmV4dCA9IDM3OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJJbnN1ZmZpY2llbnQgRVRIIGZvciBnYXM6ICIuY29uY2F0KGdhc0Ftb3VudCwgIiBFVEggbmVlZGVkIikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbkNyZWF0ZUV0aFRyYW5zYWN0aW9uOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FzQW1vdW50TmVlZGVkOiBnYXNBbW91bnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzAuYWJydXB0KCJyZXR1cm4iLCBudWxsKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzNzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgva25vd24gdHJhbnNhY3Rpb24vLnRlc3QobWVzc2FnZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigia25vd24gdHg6ICIuY29uY2F0KG1lc3NhZ2UpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoL291dCBvZiBnYXMvLnRlc3QobWVzc2FnZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigidHggZmFpbGVkICh3cm9uZyBzZWNyZXQ/KTogIi5jb25jYXQobWVzc2FnZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgvYWx3YXlzIGZhaWxpbmcgdHJhbnNhY3Rpb24vLnRlc3QobWVzc2FnZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiSW5zdWZmaWNpZW50IFRva2VuIGZvciB0cmFuc2FjdGlvbjogIi5jb25jYXQobWVzc2FnZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgvRmFpbGVkIHRvIGNoZWNrIGZvciB0cmFuc2FjdGlvbiByZWNlaXB0Ly50ZXN0KG1lc3NhZ2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoX2NvbnRleHQzMC50MCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKC9yZXBsYWNlbWVudCB0cmFuc2FjdGlvbiB1bmRlcnByaWNlZC8udGVzdChtZXNzYWdlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKF9jb250ZXh0MzAudDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihfY29udGV4dDMwLnQwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzODoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0ZhaWxlZFRyYW5zYWN0aW9uOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0ZhaWxlZFRyYW5zYWN0aW9uRXJyb3I6IF9jb250ZXh0MzAudDAubWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzMC5hYnJ1cHQoInJldHVybiIsIG51bGwpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDQwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzAuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0MToKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzAuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgX2NhbGxlZTMwLCBudWxsLCBbWzIsIDI0XV0pOwogICAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gdHJ5Q3JlYXRlU3dhcCgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZjkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oKTsKCiAgICAgICAgICAgICAgICBfY29udGV4dDMxLm5leHQgPSA5OwogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy5yZXBlYXRBc3luY1VudGlsUmVzdWx0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRyeUNyZWF0ZVN3YXAoKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgICAgICBpc0V0aENvbnRyYWN0RnVuZGVkID0gX2NvbnRleHQzMS5zZW50OwogICAgICAgICAgICAgICAgaXNTdG9wcGVkU3dhcCA9IGZsb3cuc3RhdGUuaXNTdG9wcGVkU3dhcDsKCiAgICAgICAgICAgICAgICBpZiAoaXNFdGhDb250cmFjdEZ1bmRlZCAmJiAhaXNTdG9wcGVkU3dhcCkgewogICAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgiZmluaXNoIHN0ZXAiKTsKICAgICAgICAgICAgICAgICAgZmxvdy5maW5pc2hTdGVwKHsKICAgICAgICAgICAgICAgICAgICBpc0V0aENvbnRyYWN0RnVuZGVkOiBpc0V0aENvbnRyYWN0RnVuZGVkCiAgICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBzdGVwOiAnbG9jay1ldGgnCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzMS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMzEsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBmdW5kRVJDMjBDb250cmFjdChfeDQxKSB7CiAgICAgICAgcmV0dXJuIF9mdW5kRVJDMjBDb250cmFjdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZnVuZEVSQzIwQ29udHJhY3Q7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJnZXRTZWNyZXRGcm9tQUIyVVRYTyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2dldFNlY3JldEZyb21BQjJVVFhPID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTM0KF9yZWYxMSkgewogICAgICAgIHZhciBmbG93LCBhYkNsYXNzLCBwYXJ0aWNpcGFudCwgY2hlY2tTZWNyZXRFeGlzdCwgc2VjcmV0RnJvbUNvbnRyYWN0LCBpc0V0aFdpdGhkcmF3bjsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzNCQoX2NvbnRleHQzNCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDM0LnByZXYgPSBfY29udGV4dDM0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBmbG93ID0gX3JlZjExLmZsb3c7CiAgICAgICAgICAgICAgICBhYkNsYXNzID0gdGhpczsKICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLm9uY2UoJ2V0aFdpdGhkcmF3VHhIYXNoJywgLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWYxMyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUzMihfcmVmMTIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoLCBzZWNyZXRGcm9tVHhoYXNoLCBpc0V0aFdpdGhkcmF3bjsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzMiQoX2NvbnRleHQzMikgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDMyLnByZXYgPSBfY29udGV4dDMyLm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2ggPSBfcmVmMTIuZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MzIubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5oZWxwZXJzLmV4dHJhY3RTZWNyZXRGcm9tVHgoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93OiBmbG93LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2FwRmxvdzogZmxvdy5ldGhUb2tlblN3YXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcDogZmxvdy5hcHAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjcmV0RnJvbVR4aGFzaCA9IF9jb250ZXh0MzIuc2VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzRXRoV2l0aGRyYXduID0gZmxvdy5zdGF0ZS5pc0V0aFdpdGhkcmF3bjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRXRoV2l0aGRyYXduICYmIHNlY3JldEZyb21UeGhhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ2dvdCBzZWNyZXQgZnJvbSB0eCcsIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCwgc2VjcmV0RnJvbVR4aGFzaCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNFdGhXaXRoZHJhd246IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjcmV0OiBzZWNyZXRGcm9tVHhoYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGVwOiAnd2FpdC13aXRoZHJhdy1ldGgnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMyLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUzMik7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoX3g0NCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmMTMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oKSk7CiAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgIGV2ZW50OiAncmVxdWVzdCBldGhXaXRoZHJhd1R4SGFzaCcKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcGFydGljaXBhbnQgPSBmbG93LnN3YXAucGFydGljaXBhbnQ7CgogICAgICAgICAgICAgICAgY2hlY2tTZWNyZXRFeGlzdCA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfcmVmMTQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMzMoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMzMkKF9jb250ZXh0MzMpIHsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQzMy5wcmV2ID0gX2NvbnRleHQzMy5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzMy5uZXh0ID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLmhlbHBlcnMuZXh0cmFjdFNlY3JldEZyb21Db250cmFjdCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3c6IGZsb3csCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3YXBGbG93OiBhYkNsYXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0aWNpcGFudEFkZHJlc3M6IGZsb3cuYXBwLmdldFBhcnRpY2lwYW50RXRoQWRkcmVzcyhmbG93LnN3YXApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvd25lckFkZHJlc3M6IGZsb3cuYXBwLmdldE15RXRoQWRkcmVzcygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHA6IGZsb3cuYXBwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzMuYWJydXB0KCJyZXR1cm4iLCBfY29udGV4dDMzLnNlbnQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUzMyk7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBjaGVja1NlY3JldEV4aXN0KCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmMTQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oKTsKCiAgICAgICAgICAgICAgICBfY29udGV4dDM0Lm5leHQgPSA4OwogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy5yZXBlYXRBc3luY1VudGlsUmVzdWx0KGZ1bmN0aW9uIChzdG9wUmVwZWF0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmxvdyRzdGF0ZSA9IGZsb3cuc3RhdGUsCiAgICAgICAgICAgICAgICAgICAgICBpc0V0aFdpdGhkcmF3biA9IF9mbG93JHN0YXRlLmlzRXRoV2l0aGRyYXduLAogICAgICAgICAgICAgICAgICAgICAgaXNSZWZ1bmRlZCA9IF9mbG93JHN0YXRlLmlzUmVmdW5kZWQ7CgogICAgICAgICAgICAgICAgICBpZiAoaXNFdGhXaXRoZHJhd24gfHwgaXNSZWZ1bmRlZCkgewogICAgICAgICAgICAgICAgICAgIHN0b3BSZXBlYXQoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHJldHVybiBjaGVja1NlY3JldEV4aXN0KCk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgc2VjcmV0RnJvbUNvbnRyYWN0ID0gX2NvbnRleHQzNC5zZW50OwogICAgICAgICAgICAgICAgaXNFdGhXaXRoZHJhd24gPSBmbG93LnN0YXRlLmlzRXRoV2l0aGRyYXduOwoKICAgICAgICAgICAgICAgIGlmIChzZWNyZXRGcm9tQ29udHJhY3QgJiYgIWlzRXRoV2l0aGRyYXduKSB7CiAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCdnb3Qgc2VjcmV0IGZyb20gc21hcnQgY29udHJhY3QnLCBzZWNyZXRGcm9tQ29udHJhY3QpOwogICAgICAgICAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICAgIGlzRXRoV2l0aGRyYXduOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHNlY3JldDogc2VjcmV0RnJvbUNvbnRyYWN0CiAgICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBzdGVwOiAnd2FpdC13aXRoZHJhdy1ldGgnCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzNC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMzQsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBnZXRTZWNyZXRGcm9tQUIyVVRYTyhfeDQzKSB7CiAgICAgICAgcmV0dXJuIF9nZXRTZWNyZXRGcm9tQUIyVVRYTy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZ2V0U2VjcmV0RnJvbUFCMlVUWE87CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJ3YWl0QUIyVVRYT0NvbnRyYWN0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfd2FpdEFCMlVUWE9Db250cmFjdCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUzNihfcmVmMTUpIHsKICAgICAgICB2YXIgZmxvdywgdXR4b0NvaW4sIGFiQ2xhc3MsIHBhcnRpY2lwYW50LCBpc0NvbnRyYWN0QmFsYW5jZU9rLCBpc0V0aENvbnRyYWN0RnVuZGVkOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTM2JChfY29udGV4dDM2KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MzYucHJldiA9IF9jb250ZXh0MzYubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGZsb3cgPSBfcmVmMTUuZmxvdywgdXR4b0NvaW4gPSBfcmVmMTUudXR4b0NvaW47CiAgICAgICAgICAgICAgICBhYkNsYXNzID0gdGhpczsKICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgZXZlbnQ6ICdyZXF1ZXN0IGV0aCBjb250cmFjdCcKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20ub25jZSgicmVxdWVzdCAiLmNvbmNhdCh1dHhvQ29pbiwgIiBzY3JpcHQiKSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Zsb3ckc3RhdGUyID0gZmxvdy5zdGF0ZSwKICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlcyA9IF9mbG93JHN0YXRlMi51dHhvU2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgICAgdHhIYXNoID0gX2Zsb3ckc3RhdGUyLnV0eG9TY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaDsKICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgIGV2ZW50OiAiY3JlYXRlICIuY29uY2F0KHV0eG9Db2luLCAiIHNjcmlwdCIpLAogICAgICAgICAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlczogc2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgICAgdXR4b1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoOiB0eEhhc2gKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBwYXJ0aWNpcGFudCA9IGZsb3cuc3dhcC5wYXJ0aWNpcGFudDsKICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLm9uKCdjcmVhdGUgZXRoIGNvbnRyYWN0JywgZnVuY3Rpb24gKF9yZWYxNikgewogICAgICAgICAgICAgICAgICB2YXIgZXRoU3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoID0gX3JlZjE2LmV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDsKICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgZXRoU3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoOiBldGhTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2gKICAgICAgICAgICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIF9jb250ZXh0MzYubmV4dCA9IDg7CiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5oZWxwZXJzLnJlcGVhdEFzeW5jVW50aWxSZXN1bHQoIC8qI19fUFVSRV9fKi9fYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMzUoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBiYWxhbmNlOwogICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzNSQoX2NvbnRleHQzNSkgewogICAgICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MzUucHJldiA9IF9jb250ZXh0MzUubmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzNS5uZXh0ID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWJDbGFzcy5nZXRCYWxhbmNlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogZmxvdy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKGZsb3cuc3dhcCkKICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgICAgICAgICBiYWxhbmNlID0gX2NvbnRleHQzNS5zZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCdDaGVja2luZyBjb250cmFjdCBiYWxhbmNlOicsIGJhbGFuY2UpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShiYWxhbmNlID4gMCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MzUubmV4dCA9IDY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDM1LmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzUuYWJydXB0KCJyZXR1cm4iLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzUuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwgX2NhbGxlZTM1KTsKICAgICAgICAgICAgICAgIH0pKSk7CgogICAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgICAgIGlzQ29udHJhY3RCYWxhbmNlT2sgPSBfY29udGV4dDM2LnNlbnQ7CgogICAgICAgICAgICAgICAgaWYgKGlzQ29udHJhY3RCYWxhbmNlT2spIHsKICAgICAgICAgICAgICAgICAgaXNFdGhDb250cmFjdEZ1bmRlZCA9IGZsb3cuc3RhdGUuaXNFdGhDb250cmFjdEZ1bmRlZDsKCiAgICAgICAgICAgICAgICAgIGlmICghaXNFdGhDb250cmFjdEZ1bmRlZCkgewogICAgICAgICAgICAgICAgICAgIGZsb3cuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgICAgICBpc0V0aENvbnRyYWN0RnVuZGVkOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgICAgc3RlcDogJ3dhaXQtbG9jay1ldGgnCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzYuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTM2LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gd2FpdEFCMlVUWE9Db250cmFjdChfeDQ1KSB7CiAgICAgICAgcmV0dXJuIF93YWl0QUIyVVRYT0NvbnRyYWN0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB3YWl0QUIyVVRYT0NvbnRyYWN0OwogICAgfSgpCiAgfSwgewogICAga2V5OiAid2l0aGRyYXdGcm9tQUIyVVRYTyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3dpdGhkcmF3RnJvbUFCMlVUWE8gPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMzgoX3JlZjE4KSB7CiAgICAgICAgdmFyIGZsb3csIGFiQ2xhc3MsIF9mbG93JHN3YXAyLCBidXlBbW91bnQsIHBhcnRpY2lwYW50LCBfZmxvdyRzdGF0ZTMsIHNlY3JldEhhc2gsIHNlY3JldCwgZGF0YSwgYmFsYW5jZUNoZWNrRXJyb3IsIHRhcmdldFdhbGxldCwgbmVlZFRhcmdldFdhbGxldCwgdG9rZW5BZGRyZXNzSXNWYWxpZCwgb25XaXRoZHJhd1JlYWR5LCB0cnlXaXRoZHJhdywgaXNFdGhXaXRoZHJhd247CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTM4JChfY29udGV4dDM4KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MzgucHJldiA9IF9jb250ZXh0MzgubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGZsb3cgPSBfcmVmMTguZmxvdzsKICAgICAgICAgICAgICAgIGFiQ2xhc3MgPSB0aGlzOwogICAgICAgICAgICAgICAgX2Zsb3ckc3dhcDIgPSBmbG93LnN3YXAsIGJ1eUFtb3VudCA9IF9mbG93JHN3YXAyLmJ1eUFtb3VudCwgcGFydGljaXBhbnQgPSBfZmxvdyRzd2FwMi5wYXJ0aWNpcGFudDsKICAgICAgICAgICAgICAgIF9mbG93JHN0YXRlMyA9IGZsb3cuc3RhdGUsIHNlY3JldEhhc2ggPSBfZmxvdyRzdGF0ZTMuc2VjcmV0SGFzaCwgc2VjcmV0ID0gX2Zsb3ckc3RhdGUzLnNlY3JldDsKICAgICAgICAgICAgICAgIGRhdGEgPSB7CiAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogZmxvdy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKGZsb3cuc3dhcCksCiAgICAgICAgICAgICAgICAgIHNlY3JldDogc2VjcmV0CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgX2NvbnRleHQzOC5uZXh0ID0gNzsKICAgICAgICAgICAgICAgIHJldHVybiBhYkNsYXNzLmNoZWNrQmFsYW5jZSh7CiAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogZmxvdy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKGZsb3cuc3dhcCksCiAgICAgICAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogZmxvdy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCksCiAgICAgICAgICAgICAgICAgIGV4cGVjdGVkVmFsdWU6IGJ1eUFtb3VudCwKICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRIYXNoOiBzZWNyZXRIYXNoCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgYmFsYW5jZUNoZWNrRXJyb3IgPSBfY29udGV4dDM4LnNlbnQ7CgogICAgICAgICAgICAgICAgaWYgKCFiYWxhbmNlQ2hlY2tFcnJvcikgewogICAgICAgICAgICAgICAgICBfY29udGV4dDM4Lm5leHQgPSAxMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignV2FpdGluZyB1bnRpbCBkZXBvc2l0OiBFVEggYmFsYW5jZSBjaGVjayBlcnJvcjonLCBiYWxhbmNlQ2hlY2tFcnJvcik7CiAgICAgICAgICAgICAgICBmbG93LnN3YXAuZXZlbnRzLmRpc3BhdGNoKCdldGggYmFsYW5jZSBjaGVjayBlcnJvcicsIGJhbGFuY2VDaGVja0Vycm9yKTsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDM4LmFicnVwdCgicmV0dXJuIik7CgogICAgICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgICAgICBpZiAoIWFiQ2xhc3MuaGFzVGFyZ2V0V2FsbGV0KCkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQzOC5uZXh0ID0gMjE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF9jb250ZXh0MzgubmV4dCA9IDE1OwogICAgICAgICAgICAgICAgcmV0dXJuIGFiQ2xhc3MuZ2V0VGFyZ2V0V2FsbGV0KGZsb3cuYXBwLmdldFBhcnRpY2lwYW50RXRoQWRkcmVzcyhmbG93LnN3YXApKTsKCiAgICAgICAgICAgICAgY2FzZSAxNToKICAgICAgICAgICAgICAgIHRhcmdldFdhbGxldCA9IF9jb250ZXh0Mzguc2VudDsKICAgICAgICAgICAgICAgIG5lZWRUYXJnZXRXYWxsZXQgPSBmbG93LnN3YXAuZGVzdGluYXRpb25CdXlBZGRyZXNzID8gZmxvdy5zd2FwLmRlc3RpbmF0aW9uQnV5QWRkcmVzcyA6IGZsb3cuYXBwLmdldE15RXRoQWRkcmVzcygpOwoKICAgICAgICAgICAgICAgIGlmICghKHRhcmdldFdhbGxldC50b0xvd2VyQ2FzZSgpICE9IG5lZWRUYXJnZXRXYWxsZXQudG9Mb3dlckNhc2UoKSkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQzOC5uZXh0ID0gMjE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkRlc3RpbmF0aW9uIGFkZHJlc3MgZm9yIHRva2VucyBkaXNtYXRjaCB3aXRoIG5lZWRlZCAoTmVlZGVkLCBHZXR0ZWQpLiBTdG9wIHN3YXAgbm93ISIsIG5lZWRUYXJnZXRXYWxsZXQsIHRhcmdldFdhbGxldCk7CiAgICAgICAgICAgICAgICBmbG93LnN3YXAuZXZlbnRzLmRpc3BhdGNoKCdhZGRyZXNzIGZvciB0b2tlbnMgaW52YWxpZCcsIHsKICAgICAgICAgICAgICAgICAgbmVlZGVkOiBuZWVkVGFyZ2V0V2FsbGV0LAogICAgICAgICAgICAgICAgICBnZXR0ZWQ6IHRhcmdldFdhbGxldAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzOC5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgICAgICBjYXNlIDIxOgogICAgICAgICAgICAgICAgX2NvbnRleHQzOC5uZXh0ID0gMjM7CiAgICAgICAgICAgICAgICByZXR1cm4gYWJDbGFzcy5jaGVja1Rva2VuSXNWYWxpZCh7CiAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogZmxvdy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKGZsb3cuc3dhcCksCiAgICAgICAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogZmxvdy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCkKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDIzOgogICAgICAgICAgICAgICAgdG9rZW5BZGRyZXNzSXNWYWxpZCA9IF9jb250ZXh0Mzguc2VudDsKCiAgICAgICAgICAgICAgICBpZiAodG9rZW5BZGRyZXNzSXNWYWxpZCkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDM4Lm5leHQgPSAyNzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiVG9rZW5zLCBibG9ja2VkIGF0IGNvbnRyYWN0IGRpc21hdGNoIHdpdGggbmVlZGVkLiBTdG9wIHN3YXAgbm93ISIpOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzguYWJydXB0KCJyZXR1cm4iKTsKCiAgICAgICAgICAgICAgY2FzZSAyNzoKICAgICAgICAgICAgICAgIG9uV2l0aGRyYXdSZWFkeSA9IGZ1bmN0aW9uIG9uV2l0aGRyYXdSZWFkeSgpIHsKICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20ub25jZSgncmVxdWVzdCBldGhXaXRoZHJhd1R4SGFzaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoID0gZmxvdy5zdGF0ZS5ldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g7CiAgICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6ICdldGhXaXRoZHJhd1R4SGFzaCcsCiAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB2YXIgc3RlcCA9IGZsb3cuc3RhdGUuc3RlcDsKCiAgICAgICAgICAgICAgICAgIGlmIChzdGVwID49IDcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGZsb3cuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgICAgaXNFdGhXaXRoZHJhd246IHRydWUKICAgICAgICAgICAgICAgICAgfSwgJ3dpdGhkcmF3LWV0aCcpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB0cnlXaXRoZHJhdyA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfcmVmMTkgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMzcoc3RvcFJlcGVhdGVyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlzRXRoV2l0aGRyYXduLCB3aXRoZHJhd0ZlZSwgd2l0aGRyYXdOZWVkZWRHYXMsIHJlcXVpcmVXaXRoZHJhd0ZlZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzNyQoX2NvbnRleHQzNykgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDM3LnByZXYgPSBfY29udGV4dDM3Lm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0V0aFdpdGhkcmF3biA9IGZsb3cuc3RhdGUuaXNFdGhXaXRoZHJhd247CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRXRoV2l0aGRyYXduKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MzcubmV4dCA9IDI3OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDM3LnByZXYgPSAyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aGRyYXdGZWUgPSBmbG93LnN0YXRlLndpdGhkcmF3RmVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aXRoZHJhd0ZlZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDM3Lm5leHQgPSAxMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzNy5uZXh0ID0gNzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhYkNsYXNzLmNhbGNXaXRoZHJhd0dhcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogZGF0YS5vd25lckFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlY3JldDogc2VjcmV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aGRyYXdOZWVkZWRHYXMgPSBfY29udGV4dDM3LnNlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aGRyYXdGZWU6IHdpdGhkcmF3TmVlZGVkR2FzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCd3aXRoZHJhdyBnYXMgZmVlJywgd2l0aGRyYXdOZWVkZWRHYXMpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzNy5uZXh0ID0gMTI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWJDbGFzcy53aXRoZHJhdyhkYXRhLCBmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0V0aFdpdGhkcmF3bjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IGhhc2gsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuQ3JlYXRlRXRoVHJhbnNhY3Rpb246IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZVdpdGhkcmF3RmVlOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50OiAnZXRoV2l0aGRyYXdUeEhhc2gnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogaGFzaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxMjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BSZXBlYXRlcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzcuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MzcucHJldiA9IDE2OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzNy50MCA9IF9jb250ZXh0MzdbImNhdGNoIl0oMik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEva25vd24gdHJhbnNhY3Rpb24vLnRlc3QoX2NvbnRleHQzNy50MC5tZXNzYWdlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDM3Lm5leHQgPSAyNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigia25vd24gdHg6ICIuY29uY2F0KF9jb250ZXh0MzcudDAubWVzc2FnZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFJlcGVhdGVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzNy5hYnJ1cHQoInJldHVybiIsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC9vdXQgb2YgZ2FzLy50ZXN0KF9jb250ZXh0MzcudDAubWVzc2FnZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigidHggZmFpbGVkICh3cm9uZyBzZWNyZXQ/KTogIi5jb25jYXQoX2NvbnRleHQzNy50MC5tZXNzYWdlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKC9pbnN1ZmZpY2llbnQgZnVuZHMgZm9yIGdhcy8udGVzdChfY29udGV4dDM3LnQwLm1lc3NhZ2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoImluc3VmZmljaWVudCBmdW5kIGZvciBnYXM6ICIuY29uY2F0KF9jb250ZXh0MzcudDAubWVzc2FnZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgnaW5zdWZmaWNpZW50IGZ1bmQgZm9yIGdhcy4uLiB3YWl0IGZ1bmQgb3IgcmVxdWVzdCBvdGhlciBzaWRlIHRvIHdpdGhkcmF3Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVXaXRoZHJhd0ZlZSA9IGZsb3cuc3RhdGUucmVxdWlyZVdpdGhkcmF3RmVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXF1aXJlV2l0aGRyYXdGZWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5vbmNlKCd3aXRoZHJhdyByZWFkeScsIGZ1bmN0aW9uIChfcmVmMjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2ggPSBfcmVmMjAuZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uV2l0aGRyYXdSZWFkeSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZVdpdGhkcmF3RmVlOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoX2NvbnRleHQzNy50MCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuQ3JlYXRlRXRoVHJhbnNhY3Rpb246IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDM3LmFicnVwdCgicmV0dXJuIiwgbnVsbCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzNy5hYnJ1cHQoInJldHVybiIsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI4OgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzNy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMzcsIG51bGwsIFtbMiwgMTZdXSk7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiB0cnlXaXRoZHJhdyhfeDQ3KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWYxOS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSgpOwoKICAgICAgICAgICAgICAgIF9jb250ZXh0MzgubmV4dCA9IDMxOwogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy5yZXBlYXRBc3luY1VudGlsUmVzdWx0KGZ1bmN0aW9uIChzdG9wUmVwZWF0ZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRyeVdpdGhkcmF3KHN0b3BSZXBlYXRlcik7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSAzMToKICAgICAgICAgICAgICAgIGlzRXRoV2l0aGRyYXduID0gX2NvbnRleHQzOC5zZW50OwoKICAgICAgICAgICAgICAgIGlmIChpc0V0aFdpdGhkcmF3bikgewogICAgICAgICAgICAgICAgICBvbldpdGhkcmF3UmVhZHkoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2FzZSAzMzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mzguc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTM4LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gd2l0aGRyYXdGcm9tQUIyVVRYTyhfeDQ2KSB7CiAgICAgICAgcmV0dXJuIF93aXRoZHJhd0Zyb21BQjJVVFhPLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB3aXRoZHJhd0Zyb21BQjJVVFhPOwogICAgfSgpCiAgfV0pOwoKICByZXR1cm4gRXRoVG9rZW5Td2FwOwp9KFN3YXBJbnRlcmZhY2UpOwoKZXhwb3J0IGRlZmF1bHQgRXRoVG9rZW5Td2FwOw=="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.swaps/EthTokenSwap.ts"],"names":["debug","SwapInterface","constants","util","BigNumber","InputDataDecoder","EthTokenSwap","options","transactionHash","app","env","web3","eth","getTransaction","then","txResult","bytes32","decoder","decodeData","input","utils","bytesToHex","inputs","split","err","message","name","Error","Object","values","COINS","includes","toUpperCase","address","decimals","Array","isArray","abi","tokenAddress","tokenAbi","estimateGasPrice","console","warn","_swapName","gasLimit","gasPrice","fetchBalance","getWeb3","contract","Contract","ERC20","updateGasPrice","speed","methodName","args","_params","handleTransactionHash","methods","Promise","resolve","reject","params","from","getMyEthAddress","gas","gasAmount","estimateGas","dividedBy","toString","send","on","hash","error","receipt","data","amount","exp","pow","newAmount","times","approve","result","spender","allowance","call","targetWallet","participantAddress","createSwapTarget","createSwap","secretHash","replace","ownerAddress","swaps","swap","balance","parseInt","getBalance","expectedValue","expectedHash","helpers","repeatAsyncUntilResult","_secretHash","expectedValueWei","multipliedBy","isGreaterThan","_allSwapEvents","getPastEvents","fromBlock","toBlock","allSwapEvents","events","allEvents","event","push","fetchSwapEvents","swapEvents","filter","returnValues","create","close","rest","length","findSwap","wasClosed","status","token","getTargetWallet","getTargetWalletPromise","calcWithdrawOtherGas","secret","withdrawOther","_secret","getSecret","secretValue","test","flow","abClass","participant","buyAmount","sellAmount","waitConfirm","state","swapData","getParticipantEthAddress","destinationSellAddress","calcFee","tryCreateSwap","isEthContractFunded","checkAllowance","isLessThan","_checkSwapAlreadyExists","swapExists","refund","refundTx","room","sendMessage","ethSwapCreationTransactionHash","setState","canCreateEthTransaction","isFailedTransaction","gasAmountNeeded","isFailedTransactionError","isStoppedSwap","finishStep","step","once","ethSwapWithdrawTransactionHash","extractSecretFromTx","swapFlow","ethTokenSwap","secretFromTxhash","isEthWithdrawn","checkSecretExist","extractSecretFromContract","stopRepeat","isRefunded","secretFromContract","utxoCoin","scriptValues","utxoScriptValues","txHash","utxoScriptCreatingTransactionHash","isContractBalanceOk","checkBalance","balanceCheckError","dispatch","hasTargetWallet","needTargetWallet","destinationBuyAddress","toLowerCase","needed","getted","checkTokenIsValid","tokenAddressIsValid","onWithdrawReady","tryWithdraw","stopRepeater","withdrawFee","calcWithdrawGas","withdrawNeededGas","withdraw","requireWithdrawFee"],"mappings":"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","sourcesContent":["// @ts-nocheck\r\nimport debug from 'debug'\r\nimport SwapApp, { SwapInterface, constants, util } from 'swap.app'\r\nimport BigNumber from 'bignumber.js'\r\nimport InputDataDecoder from 'ethereum-input-data-decoder'\r\n\r\n\r\nclass EthTokenSwap extends SwapInterface {\r\n\r\n  _swapName: string\r\n  address: string\r\n  abi: any[]\r\n  decimals: number\r\n  tokenAddress: string\r\n  tokenAbi: any[]\r\n  gasLimit: number\r\n  gasPrice: number\r\n  fetchBalance: any\r\n  estimateGasPrice: any\r\n  _allSwapEvents: any\r\n\r\n  app: any\r\n  decoder: any\r\n  contract: any\r\n  ERC20: any\r\n\r\n  /**\r\n   *\r\n   * @param {object}    options\r\n   * @param {string}    options.name\r\n   * @param {string}    options.address\r\n   * @param {array}     options.abi\r\n   * @param {string}    options.tokenAddress\r\n   * @param {array}     options.tokenAbi\r\n   * @param {number}    options.gasLimit\r\n   * @param {function}  options.fetchBalance\r\n   */\r\n  constructor(options) {\r\n    super()\r\n\r\n    if (!options.name) {\r\n      throw new Error('EthTokenSwap: \"name\" required')\r\n    }\r\n    if (!Object.values(constants.COINS).includes(options.name.toUpperCase())) {\r\n      throw new Error('EthTokenSwap: \"name\" should be correct')\r\n    }\r\n    if (typeof options.address !== 'string') {\r\n      throw new Error('EthTokenSwap: \"address\" required')\r\n    }\r\n    if (typeof options.decimals !== 'number') {\r\n      throw new Error('EthTokenSwap: \"decimals\" required')\r\n    }\r\n    if (!Array.isArray(options.abi)) {\r\n      throw new Error('EthTokenSwap: \"abi\" required')\r\n    }\r\n    if (typeof options.tokenAddress !== 'string') {\r\n      throw new Error('EthTokenSwap: \"tokenAddress\" required')\r\n    }\r\n    if (!Array.isArray(options.tokenAbi)) {\r\n      throw new Error('EthTokenSwap: \"tokenAbi\" required')\r\n    }\r\n    if (typeof options.estimateGasPrice !== 'function') {\r\n      // ({ speed } = {}) => gasPrice\r\n      console.warn(`EthTokenSwap: \"estimateGasPrice\" is not a function. You will not be able use automatic mempool-based fee`)\r\n    }\r\n\r\n\r\n\r\n    this._swapName      = options.name.toUpperCase()\r\n\r\n    this.address        = options.address\r\n    this.abi            = options.abi\r\n    this.decimals       = options.decimals\r\n    this.tokenAddress   = options.tokenAddress\r\n    this.tokenAbi       = options.tokenAbi\r\n\r\n    this.gasLimit       = options.gasLimit || 2e5\r\n    this.gasPrice       = options.gasPrice || 2e9\r\n    this.fetchBalance   = options.fetchBalance\r\n    this.estimateGasPrice = options.estimateGasPrice || (() => {})\r\n\r\n  }\r\n\r\n  _initSwap(app) {\r\n    super._initSwap(app)\r\n\r\n    this.app = app\r\n\r\n    const web3 = this.app.env.getWeb3()\r\n    this.decoder        = new InputDataDecoder(this.abi)\r\n    this.contract       = new web3.eth.Contract(this.abi, this.address)\r\n    this.ERC20          = new web3.eth.Contract(this.tokenAbi, this.tokenAddress)\r\n  }\r\n\r\n  /**\r\n   * @deprecated\r\n   */\r\n  updateGas() {\r\n    console.warn(`EthSwap.updateGas() is deprecated and will be removed. Use .updateGasPrice()`)\r\n    return this.updateGasPrice()\r\n  }\r\n\r\n  async updateGasPrice() {\r\n    //@\r\n    debug('gas price before update', this.gasPrice)\r\n\r\n    try {\r\n      this.gasPrice = await this.estimateGasPrice({ speed: 'fast' })\r\n    } catch(err) {\r\n      debug(`EthTokenSwap: Error with gas update: ${err.message}, using old value gasPrice=${this.gasPrice}`)\r\n    }\r\n    //@\r\n    debug('gas price after update', this.gasPrice)\r\n  }\r\n\r\n  async send(methodName, args, _params = {}, handleTransactionHash) {\r\n    if (typeof this.contract.methods[methodName] !== 'function') {\r\n      throw new Error(`EthTokenSwap.send: No method ${methodName} in contract`)\r\n    }\r\n\r\n    await this.updateGasPrice()\r\n\r\n    return new Promise(async (resolve, reject) => {\r\n      const params = {\r\n        from: this.app.getMyEthAddress(),\r\n        gas: this.gasLimit,\r\n        gasPrice: this.gasPrice,\r\n        ..._params,\r\n      }\r\n      //@\r\n      debug(`EthTokenSwap -> ${methodName} -> params`, params)\r\n\r\n      let gasAmount = 0\r\n      try {\r\n        gasAmount = await this.contract.methods[methodName](...args).estimateGas(params)\r\n      } catch (estimateGasError) {\r\n        reject({ message: estimateGasError.message, gasAmount: new BigNumber(gasAmount).dividedBy(1e8).toString() })\r\n        return\r\n      }\r\n\r\n      params.gas = gasAmount\r\n      //@\r\n      debug(`EthTokenSwap -> ${methodName} -> gas`, gasAmount)\r\n      const receipt = await this.contract.methods[methodName](...args).send(params)\r\n        .on('transactionHash', (hash) => {\r\n          if (typeof handleTransactionHash === 'function') {\r\n            handleTransactionHash(hash)\r\n          }\r\n        })\r\n        .catch((error) => {\r\n          reject({ message: error.message, gasAmount: new BigNumber(gasAmount).dividedBy(1e8).toString() })\r\n        })\r\n\r\n      resolve(receipt)\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {BigNumber} data.amount\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async approve(data, handleTransactionHash: Function = null) {\r\n    const { amount } = data\r\n\r\n    const exp = new BigNumber(10).pow(this.decimals)\r\n    const newAmount = new BigNumber(amount).times(exp).toString()\r\n\r\n    await this.updateGasPrice()\r\n\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n        const params = {\r\n          from: this.app.getMyEthAddress(),\r\n          gas: this.gasLimit,\r\n          gasPrice: this.gasPrice,\r\n        }\r\n        //@\r\n        debug(`EthTokenSwap -> approve -> params`, params)\r\n\r\n        const gasAmount = await this.ERC20.methods.approve(this.address, newAmount).estimateGas(params)\r\n\r\n        params.gas = gasAmount\r\n        //@\r\n        debug(`EthTokenSwap -> approve -> gas`, gasAmount)\r\n\r\n        const result = await this.ERC20.methods.approve(this.address, newAmount).send(params)\r\n          .on('transactionHash', (hash) => {\r\n            if (typeof handleTransactionHash === 'function') {\r\n              handleTransactionHash(hash)\r\n            }\r\n          })\r\n          .catch((error) => {\r\n            reject({ message: error.message, gasAmount: new BigNumber(gasAmount).dividedBy(1e8).toString() })\r\n          })\r\n\r\n        resolve(result)\r\n      }\r\n      catch (err) {\r\n        reject(err)\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.spender\r\n   * @returns {Promise}\r\n   */\r\n  checkAllowance(data): Promise<number> {\r\n    const { spender } = data\r\n\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n        const result = await this.ERC20.methods.allowance(spender, this.address).call({\r\n          from: this.app.getMyEthAddress(),\r\n        })\r\n\r\n        resolve(result)\r\n      }\r\n      catch (err) {\r\n        reject(err)\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @param {string} data.participantAddress\r\n   * @param {BigNumber} data.amount\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async create(data, handleTransactionHash) {\r\n    if (data.targetWallet && (data.targetWallet!==data.participantAddress)) {\r\n      return this.createSwapTarget(data, handleTransactionHash)\r\n    } else {\r\n      return this.createSwap(data, handleTransactionHash)\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @param {string} data.participantAddress\r\n   * @param {BigNumber} data.amount\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async createSwap(data, handleTransactionHash) {\r\n    const { secretHash, participantAddress, amount } = data\r\n\r\n    const exp = new BigNumber(10).pow(this.decimals)\r\n    const newAmount = new BigNumber(amount).times(exp).toString()\r\n\r\n    const hash = `0x${secretHash.replace(/^0x/, '')}`\r\n    const args = [ hash, participantAddress, newAmount, this.tokenAddress ]\r\n\r\n    return this.send('createSwap', [...args], {}, handleTransactionHash)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @param {string} data.participantAddress\r\n   * @param {BigNumber} data.amount\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async createSwapTarget(data, handleTransactionHash) {\r\n    const { secretHash, participantAddress, amount, targetWallet } = data\r\n\r\n    const exp = new BigNumber(10).pow(this.decimals)\r\n    const newAmount = new BigNumber(amount).times(exp).toString()\r\n\r\n    const hash = `0x${secretHash.replace(/^0x/, '')}`\r\n    const args = [ hash, participantAddress, targetWallet, newAmount, this.tokenAddress ]\r\n\r\n    return this.send('createSwapTarget', [...args], {}, handleTransactionHash)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.ownerAddress\r\n   * @param {string} data.participantAddress\r\n   * @returns {Promise}\r\n   */\r\n  swaps(data) {\r\n    const { ownerAddress, participantAddress } = data\r\n\r\n    return this.contract.methods.swaps(ownerAddress, participantAddress).call()\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.ownerAddress\r\n   * @param {string} data.participantAddress\r\n   * @returns {Promise}\r\n   */\r\n  async checkSwapExists(data) {\r\n    const swap = await this.swaps(data)\r\n    //@\r\n    debug('swapExists', swap)\r\n\r\n    const balance = swap && swap.balance ? parseInt(swap.balance) : 0\r\n\r\n    return balance > 0\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.ownerAddress\r\n   * @returns {Promise}\r\n   */\r\n  getBalance(data) {\r\n    const { ownerAddress } = data\r\n\r\n    return this.contract.methods.getBalance(ownerAddress).call({\r\n      from: this.app.getMyEthAddress(),\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.ownerAddress\r\n   * @param {BigNumber} data.expectedValue\r\n   * @returns {Promise.<string>}\r\n   */\r\n  async checkBalance(data) {\r\n    const { ownerAddress, participantAddress, expectedValue, expectedHash } = data\r\n\r\n    const balance = await util.helpers.repeatAsyncUntilResult(() =>\r\n      this.getBalance({ ownerAddress })\r\n    )\r\n    const swap = await util.helpers.repeatAsyncUntilResult(() =>\r\n      this.contract.methods.swaps(ownerAddress, participantAddress).call()\r\n    )\r\n    //@\r\n    const { secretHash } = swap\r\n    debug('swap.core:swaps')(`swap.secretHash`, secretHash)\r\n\r\n    const _secretHash = `${secretHash.replace(/^0x/, '')}`\r\n\r\n    debug('swap.core:swaps')(`secretHash: expected hash = ${expectedHash}, contract hash = ${_secretHash}`)\r\n\r\n    if (expectedHash !== _secretHash) {\r\n      return `Expected hash: ${expectedHash}, got: ${_secretHash}`\r\n    }\r\n\r\n    const expectedValueWei = new BigNumber(expectedValue).multipliedBy(this.decimals)\r\n\r\n    if (expectedValueWei.isGreaterThan(balance)) {\r\n      return `Expected value: ${expectedValueWei.toString()}, got: ${balance}`\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   *\r\n   * @returns {Promise}\r\n   */\r\n  async fetchSwapEvents() {\r\n    if (this._allSwapEvents) return this._allSwapEvents\r\n\r\n    const allSwapEvents = await this.contract.getPastEvents('allEvents', {\r\n      fromBlock: 0,\r\n      toBlock: 'latest',\r\n    })\r\n\r\n    this.contract.events.allEvents({ fromBlock: 0, toBlock: 'latest' })\r\n      .on('data', event => {\r\n        this._allSwapEvents.push(event)\r\n      })\r\n      .on('changed', (event) => {\r\n        console.error(`EthTokenSwap: fetchEvents: needs rescan`)\r\n        this._allSwapEvents = null\r\n      })\r\n      .on('error', err => {\r\n        console.error(err)\r\n        this._allSwapEvents = null\r\n      })\r\n\r\n    this._allSwapEvents = allSwapEvents\r\n\r\n    return allSwapEvents\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @returns {Promise}\r\n   */\r\n  async findSwap(data) {\r\n    const { secretHash } = data\r\n\r\n    const allSwapEvents = await this.fetchSwapEvents()\r\n\r\n    const swapEvents = allSwapEvents\r\n      .filter(({ returnValues }) => returnValues._secretHash === `0x${secretHash.replace('0x','')}`)\r\n\r\n    const [ create, close, ...rest ] = swapEvents\r\n\r\n    if (rest && rest.length) {\r\n      console.error(`More than two swaps with same hash`, rest)\r\n      // throw new Error(`More than two swaps with same hash`)\r\n    }\r\n\r\n    return [ create, close ]\r\n  }\r\n\r\n  /**\r\n    *\r\n    * @param {object} data\r\n    * @param {string} data.secretHash\r\n    * @returns {Promise(status)}\r\n    */\r\n\r\n  async wasClosed(data) {\r\n    const [ create, close ] = await this.findSwap(data)\r\n\r\n    if (!create) {\r\n      debug(`No swap with hash ${data.secretHash}`)\r\n      return 'no swap'\r\n    } else if (create && !close) {\r\n      debug(`Open yet!`)\r\n      return 'open'\r\n    } else {\r\n      if (close.event == 'Withdraw') {\r\n        debug(`Withdrawn`)\r\n        return 'withdrawn'\r\n      } else if (close.event == 'Refund') {\r\n        debug(`Refund`)\r\n        return 'refunded'\r\n      } else {\r\n        debug(`Unknown event, error`)\r\n        return 'error'\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @returns {Promise(boolean)}\r\n   */\r\n  wasRefunded(data) {\r\n    return this.wasClosed(data)\r\n      .then((status) =>\r\n        status === 'refunded'\r\n      )\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @returns {Promise(boolean)}\r\n   */\r\n  async wasWithdrawn(data) {\r\n    const status = await this.wasClosed(data)\r\n    return status === 'withdrawn'\r\n  }\r\n\r\n\r\n  /**\r\n   * @param {object} data\r\n   * @param {string} data.ownerAddress\r\n   * @param {string} tokenAddress\r\n   */\r\n  async checkTokenIsValid(data) {\r\n    const { ownerAddress, participantAddress } = data\r\n\r\n    debug('swap.core:swaps')(`Check token is valid. Needed token address: ${this.tokenAddress.toUpperCase()}`);\r\n    const swap = await util.helpers.repeatAsyncUntilResult(() =>\r\n      this.contract.methods.swaps(ownerAddress, participantAddress).call()\r\n    )\r\n\r\n    const { token } = swap\r\n    debug('swap.core:swaps')(`Token address at swap contract: ${token.toUpperCase()}`);\r\n\r\n    return (this.tokenAddress.toUpperCase() == token.toUpperCase())\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @returns {boolean}\r\n   */\r\n  hasTargetWallet() {\r\n    return !!this.contract.methods.getTargetWallet\r\n  }\r\n\r\n\r\n  /**\r\n   *\r\n   * @param {string} ownerAddress\r\n   * @returns {Promise.<string>}\r\n   */\r\n  async getTargetWallet(ownerAddress: string): Promise<string> {\r\n    let address: string = await util.helpers.repeatAsyncUntilResult(() =>\r\n      this.getTargetWalletPromise(ownerAddress)\r\n    )\r\n    return address\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {string} ownerAddress\r\n   * @returns {string}\r\n   */\r\n  async getTargetWalletPromise(ownerAddress) {\r\n    debug('swap.core:swaps')('EthTokenSwap->getTargetWallet');\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n        const targetWallet = await this.contract.methods.getTargetWallet(ownerAddress).call({\r\n          from: this.app.getMyEthAddress(),\r\n        })\r\n        debug('swap.core:swaps')('EthTokenSwap->getTargetWallet',targetWallet);\r\n\r\n        resolve(targetWallet)\r\n      }\r\n      catch (err) {\r\n        reject(err)\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secret\r\n   * @param {string} data.ownerAddress\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async calcWithdrawGas(data) {\r\n    return this.calcWithdrawOtherGas({\r\n      ownerAddress: data.ownerAddress,\r\n      participantAddress: this.app.getMyEthAddress(),\r\n      secret: data.secret,\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secret\r\n   * @param {string} data.ownerAddress\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async withdraw(data, handleTransactionHash) {\r\n    return this.withdrawOther({\r\n      ownerAddress: data.ownerAddress,\r\n      participantAddress: this.app.getMyEthAddress(),\r\n      secret: data.secret,\r\n    } , handleTransactionHash)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secret\r\n   * @param {string} data.participantAddress\r\n   * @returns {Promise}\r\n   */\r\n  async calcWithdrawNoMoneyGas(data) {\r\n    return this.calcWithdrawOtherGas({\r\n      ownerAddress: this.app.getMyEthAddress(),\r\n      participantAddress: data.participantAddress,\r\n      secret: data.secret,\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secret\r\n   * @param {string} data.participantAddress\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async withdrawNoMoney(data, handleTransactionHash) {\r\n    return this.withdrawOther({\r\n      ownerAddress: this.app.getMyEthAddress(),\r\n      participantAddress: data.participantAddress,\r\n      secret: data.secret,\r\n    }, handleTransactionHash)\r\n  }\r\n\r\n  async calcWithdrawOtherGas(data) {\r\n    const { ownerAddress, participantAddress, secret } = data\r\n\r\n    await this.updateGasPrice()\r\n\r\n    return new Promise(async (resolve, reject) => {\r\n      const _secret = `0x${secret.replace(/^0x/, '')}`\r\n\r\n      const params = {\r\n        from: this.app.getMyEthAddress(),\r\n        gas: this.gasLimit,\r\n        gasPrice: this.gasPrice,\r\n      }\r\n\r\n      try {\r\n        const gasAmount = await this.contract.methods.withdrawOther(_secret, ownerAddress, participantAddress).estimateGas(params);\r\n        resolve(gasAmount)\r\n      }\r\n      catch (err) {\r\n        reject(err)\r\n      }\r\n    })\r\n  }\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secret\r\n   * @param {string} data.ownerAddress\r\n   * @param {string} data.participantAddress\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async withdrawOther(data, handleTransactionHash) {\r\n    const { ownerAddress, participantAddress, secret } = data\r\n\r\n    const _secret = `0x${secret.replace(/^0x/, '')}`\r\n\r\n    await this.updateGasPrice()\r\n\r\n    return this.send('withdrawOther', [ _secret, ownerAddress, participantAddress ], {}, handleTransactionHash)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.participantAddress\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async refund(data, handleTransactionHash?: Function) {\r\n    const { participantAddress } = data\r\n\r\n    await this.updateGasPrice()\r\n\r\n    return this.send('refund', [ participantAddress ], {}, handleTransactionHash)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.participantAddress\r\n   * @returns {Promise}\r\n   */\r\n  getSecret(data) {\r\n    const { participantAddress } = data\r\n\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n        const secret = await this.contract.methods.getSecret(participantAddress).call({\r\n          from: this.app.getMyEthAddress(),\r\n        })\r\n\r\n        const secretValue = secret && !/^0x0+$/.test(secret) ? secret : null\r\n\r\n        resolve(secretValue)\r\n      }\r\n      catch (err) {\r\n        reject(err)\r\n      }\r\n    })\r\n  }\r\n\r\n\r\n  /**\r\n   *\r\n   * @param {string} transactionHash\r\n   * @returns {Promise<any>}\r\n   */\r\n  getSecretFromTxhash = (transactionHash) =>\r\n    this.app.env.web3.eth.getTransaction(transactionHash)\r\n      .then(txResult => {\r\n        try {\r\n          const bytes32 = this.decoder.decodeData(txResult.input)\r\n          return this.app.env.web3.utils.bytesToHex(bytes32.inputs[0]).split('0x')[1]\r\n        } catch (err) {\r\n          debug('swap.core:swaps')('Trying to fetch secret from tx: ' + err.message)\r\n          return\r\n        }\r\n      })\r\n\r\n\r\n  async fundERC20Contract({\r\n    flow,\r\n  }: {\r\n    flow: any,\r\n  }) {\r\n    const abClass = this\r\n    const {\r\n      participant,\r\n      buyAmount,\r\n      sellAmount,\r\n      waitConfirm,\r\n    } = flow.swap\r\n\r\n    const { secretHash } = flow.state\r\n\r\n    const swapData = {\r\n      participantAddress: abClass.app.getParticipantEthAddress(flow.swap),\r\n      secretHash,\r\n      amount: sellAmount,\r\n      targetWallet: flow.swap.destinationSellAddress,\r\n      calcFee: true,\r\n    }\r\n\r\n    // TODO fee after allowance\r\n    // EthTokenSwap -> approve need gas too\r\n    /* calc create contract fee and save this */\r\n    /*\r\n    flow.setState({\r\n      createSwapFee: await flow.ethTokenSwap.create(swapData),\r\n    })\r\n    */\r\n    swapData.calcFee = false\r\n    //debug('swap.core:flow')('create swap fee', flow.state.createSwapFee)\r\n\r\n    const tryCreateSwap = async () => {\r\n      const { isEthContractFunded } = flow.state\r\n\r\n      if (!isEthContractFunded) {\r\n        try {\r\n          debug('swap.core:flow')('fetching allowance')\r\n\r\n          const allowance = await abClass.checkAllowance({\r\n            spender: abClass.app.getMyEthAddress(),\r\n          })\r\n\r\n          debug('swap.core:flow')('allowance', allowance)\r\n\r\n          if (new BigNumber(allowance).isLessThan(sellAmount)) {\r\n            debug('swap.core:flow')('allowance < sellAmount', allowance, sellAmount)\r\n            await abClass.approve({\r\n              amount: sellAmount,\r\n            })\r\n          }\r\n\r\n          debug('swap.core:flow')('check swap exists')\r\n          const swapExists = await flow._checkSwapAlreadyExists()\r\n          if (swapExists) {\r\n            console.warn('Swap exists!! May be stucked. Try refund')\r\n            await abClass.refund({\r\n              participantAddress: abClass.app.getParticipantEthAddress(flow.swap),\r\n            }, (refundTx) => {\r\n              debug('swap.core:flow')('Stucked swap refunded', refundTx)\r\n            })\r\n          }\r\n          await abClass.create(swapData, async (hash) => {\r\n            debug('swap.core:flow')('create swap tx hash', hash)\r\n            flow.swap.room.sendMessage({\r\n              event: 'create eth contract',\r\n              data: {\r\n                ethSwapCreationTransactionHash: hash,\r\n              },\r\n            })\r\n\r\n            flow.swap.room.on('request eth contract', () => {\r\n              flow.swap.room.sendMessage({\r\n                event: 'create eth contract',\r\n                data: {\r\n                  ethSwapCreationTransactionHash: hash,\r\n                },\r\n              })\r\n            })\r\n\r\n            flow.setState({\r\n              ethSwapCreationTransactionHash: hash,\r\n              canCreateEthTransaction: true,\r\n              isFailedTransaction: false,\r\n            }, true)\r\n\r\n            debug('swap.core:flow')('created swap!', hash)\r\n          })\r\n\r\n        } catch (error) {\r\n          if (flow.state.ethSwapCreationTransactionHash) {\r\n            console.error('fail create swap, but tx already exists')\r\n            flow.setState({\r\n              canCreateEthTransaction: true,\r\n              isFailedTransaction: false,\r\n            }, true)\r\n            return true\r\n          }\r\n          const { message, gasAmount } = error\r\n\r\n          if ( /insufficient funds/.test(message) ) {\r\n            console.error(`Insufficient ETH for gas: ${gasAmount} ETH needed`)\r\n\r\n            flow.setState({\r\n              canCreateEthTransaction: false,\r\n              gasAmountNeeded: gasAmount,\r\n            })\r\n\r\n            return null\r\n          } else if ( /known transaction/.test(message) ) {\r\n            console.error(`known tx: ${message}`)\r\n          } else if ( /out of gas/.test(message) ) {\r\n            console.error(`tx failed (wrong secret?): ${message}`)\r\n          } else if ( /always failing transaction/.test(message) ) {\r\n            console.error(`Insufficient Token for transaction: ${message}`)\r\n          } else if ( /Failed to check for transaction receipt/.test(message) ) {\r\n            console.error(error)\r\n          } else if ( /replacement transaction underpriced/.test(message) ) {\r\n            console.error(error)\r\n          } else {\r\n            console.error(error)\r\n          }\r\n\r\n          flow.setState({\r\n            isFailedTransaction: true,\r\n            isFailedTransactionError: error.message,\r\n          })\r\n\r\n          return null\r\n        }\r\n      }\r\n\r\n      return true\r\n    }\r\n\r\n    const isEthContractFunded = await util.helpers.repeatAsyncUntilResult(() =>\r\n      tryCreateSwap(),\r\n    )\r\n\r\n    const { isStoppedSwap } = flow.state\r\n\r\n    if (isEthContractFunded && !isStoppedSwap) {\r\n      debug('swap.core:flow')(`finish step`)\r\n      flow.finishStep({\r\n        isEthContractFunded,\r\n      }, {step: 'lock-eth'})\r\n    }\r\n  }\r\n\r\n\r\n  async getSecretFromAB2UTXO({\r\n    flow,\r\n  }: {\r\n    flow: any,\r\n  }) {\r\n    const abClass = this\r\n\r\n    flow.swap.room.once('ethWithdrawTxHash', async ({ethSwapWithdrawTransactionHash}) => {\r\n      flow.setState({\r\n        ethSwapWithdrawTransactionHash,\r\n      }, true)\r\n\r\n      const secretFromTxhash = await util.helpers.extractSecretFromTx({\r\n        flow,\r\n        swapFlow: flow.ethTokenSwap,\r\n        app: flow.app,\r\n        ethSwapWithdrawTransactionHash,\r\n      })\r\n\r\n      const { isEthWithdrawn } = flow.state\r\n\r\n      if (!isEthWithdrawn && secretFromTxhash) {\r\n        debug('swap.core:flow')('got secret from tx', ethSwapWithdrawTransactionHash, secretFromTxhash)\r\n        flow.finishStep({\r\n          isEthWithdrawn: true,\r\n          secret: secretFromTxhash,\r\n        }, {step: 'wait-withdraw-eth'})\r\n      }\r\n    })\r\n\r\n    flow.swap.room.sendMessage({\r\n      event: 'request ethWithdrawTxHash',\r\n    })\r\n\r\n    const { participant } = flow.swap\r\n\r\n    const checkSecretExist = async () => {\r\n      return await util.helpers.extractSecretFromContract({\r\n        flow,\r\n        swapFlow: abClass,\r\n        participantAddress: flow.app.getParticipantEthAddress(flow.swap),\r\n        ownerAddress: flow.app.getMyEthAddress(),\r\n        app: flow.app,\r\n      })\r\n    }\r\n\r\n    const secretFromContract = await util.helpers.repeatAsyncUntilResult((stopRepeat) => {\r\n      const { isEthWithdrawn, isRefunded } = flow.state\r\n\r\n      if (isEthWithdrawn || isRefunded) {\r\n        stopRepeat()\r\n\r\n        return false\r\n      }\r\n\r\n      return checkSecretExist()\r\n    })\r\n\r\n    const { isEthWithdrawn } = flow.state\r\n\r\n    if (secretFromContract && !isEthWithdrawn) {\r\n      debug('swap.core:flow')('got secret from smart contract', secretFromContract)\r\n\r\n      flow.finishStep({\r\n        isEthWithdrawn: true,\r\n        secret: secretFromContract,\r\n      }, { step: 'wait-withdraw-eth' })\r\n    }\r\n  }\r\n\r\n\r\n  async waitAB2UTXOContract({\r\n    flow,\r\n    utxoCoin,\r\n  }: {\r\n    flow: any,\r\n    utxoCoin: string,\r\n  }) {\r\n    const abClass = this\r\n\r\n    flow.swap.room.sendMessage({\r\n      event: 'request eth contract',\r\n    })\r\n\r\n    flow.swap.room.once(`request ${utxoCoin} script`, () => {\r\n      const {\r\n        utxoScriptValues: scriptValues,\r\n        utxoScriptCreatingTransactionHash: txHash,\r\n      } = flow.state\r\n\r\n      flow.swap.room.sendMessage({\r\n        event:  `create ${utxoCoin} script`,\r\n        data: {\r\n          scriptValues,\r\n          utxoScriptCreatingTransactionHash: txHash,\r\n        }\r\n      })\r\n    })\r\n\r\n    const { participant } = flow.swap\r\n\r\n    flow.swap.room.on('create eth contract', ({ ethSwapCreationTransactionHash }) => {\r\n      flow.setState({\r\n        ethSwapCreationTransactionHash,\r\n      }, true)\r\n    })\r\n\r\n    const isContractBalanceOk = await util.helpers.repeatAsyncUntilResult(async () => {\r\n      const balance = await abClass.getBalance({\r\n        ownerAddress: flow.app.getParticipantEthAddress(flow.swap),\r\n      })\r\n\r\n      debug('swap.core:flow')('Checking contract balance:', balance)\r\n\r\n      if (balance > 0) {\r\n        return true\r\n      }\r\n\r\n      return false\r\n    })\r\n\r\n    if (isContractBalanceOk) {\r\n      const { isEthContractFunded } = flow.state\r\n\r\n      if (!isEthContractFunded) {\r\n        flow.finishStep({\r\n          isEthContractFunded: true,\r\n        }, { step: 'wait-lock-eth' })\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n  async withdrawFromAB2UTXO({\r\n    flow,\r\n  }: {\r\n    flow: any,\r\n  }) {\r\n    const abClass = this\r\n    const { buyAmount, participant } = flow.swap\r\n    const { secretHash, secret } = flow.state\r\n\r\n    const data = {\r\n      ownerAddress: flow.app.getParticipantEthAddress(flow.swap),\r\n      secret,\r\n    }\r\n\r\n    const balanceCheckError = await abClass.checkBalance({\r\n      ownerAddress: flow.app.getParticipantEthAddress(flow.swap),\r\n      participantAddress: flow.app.getMyEthAddress(),\r\n      expectedValue: buyAmount,\r\n      expectedHash: secretHash,\r\n    })\r\n\r\n    if (balanceCheckError) {\r\n      console.error('Waiting until deposit: ETH balance check error:', balanceCheckError)\r\n      flow.swap.events.dispatch('eth balance check error', balanceCheckError)\r\n\r\n      return\r\n    }\r\n\r\n    if (abClass.hasTargetWallet()) {\r\n      const targetWallet = await abClass.getTargetWallet(\r\n        flow.app.getParticipantEthAddress(flow.swap)\r\n      )\r\n      const needTargetWallet = (flow.swap.destinationBuyAddress)\r\n        ? flow.swap.destinationBuyAddress\r\n        : flow.app.getMyEthAddress()\r\n\r\n      if (targetWallet.toLowerCase() != needTargetWallet.toLowerCase()) {\r\n        console.error(\r\n          \"Destination address for tokens dismatch with needed (Needed, Getted). Stop swap now!\",\r\n          needTargetWallet,\r\n          targetWallet,\r\n        )\r\n\r\n        flow.swap.events.dispatch('address for tokens invalid', {\r\n          needed: needTargetWallet,\r\n          getted: targetWallet,\r\n        })\r\n\r\n        return\r\n      }\r\n    }\r\n\r\n    const tokenAddressIsValid = await abClass.checkTokenIsValid({\r\n      ownerAddress: flow.app.getParticipantEthAddress(flow.swap),\r\n      participantAddress: flow.app.getMyEthAddress(),\r\n    })\r\n\r\n    if (!tokenAddressIsValid) {\r\n      console.error(\"Tokens, blocked at contract dismatch with needed. Stop swap now!\")\r\n      return\r\n    }\r\n\r\n    const onWithdrawReady = () => {\r\n      flow.swap.room.once('request ethWithdrawTxHash', () => {\r\n        const { ethSwapWithdrawTransactionHash } = flow.state\r\n\r\n        flow.swap.room.sendMessage({\r\n          event: 'ethWithdrawTxHash',\r\n          data: {\r\n            ethSwapWithdrawTransactionHash,\r\n          },\r\n        })\r\n      })\r\n\r\n      const { step } = flow.state\r\n\r\n      if (step >= 7) {\r\n        return\r\n      }\r\n\r\n      flow.finishStep({\r\n        isEthWithdrawn: true,\r\n      }, 'withdraw-eth')\r\n    }\r\n\r\n    const tryWithdraw = async (stopRepeater) => {\r\n      const { isEthWithdrawn } = flow.state\r\n\r\n      if (!isEthWithdrawn) {\r\n        try {\r\n          const { withdrawFee } = flow.state\r\n\r\n          if (!withdrawFee) {\r\n            const withdrawNeededGas = await abClass.calcWithdrawGas({\r\n              ownerAddress: data.ownerAddress,\r\n              secret,\r\n            })\r\n            flow.setState({\r\n              withdrawFee: withdrawNeededGas,\r\n            })\r\n            debug('swap.core:flow')('withdraw gas fee', withdrawNeededGas)\r\n          }\r\n\r\n          await abClass.withdraw(data, (hash) => {\r\n            flow.setState({\r\n              isEthWithdrawn: true,\r\n              ethSwapWithdrawTransactionHash: hash,\r\n              canCreateEthTransaction: true,\r\n              requireWithdrawFee: false,\r\n            }, true)\r\n\r\n            flow.swap.room.sendMessage({\r\n              event: 'ethWithdrawTxHash',\r\n              data: {\r\n                ethSwapWithdrawTransactionHash: hash,\r\n              }\r\n            })\r\n          })\r\n\r\n          stopRepeater()\r\n          return true\r\n        } catch (err) {\r\n          if ( /known transaction/.test(err.message) ) {\r\n            console.error(`known tx: ${err.message}`)\r\n            stopRepeater()\r\n            return true\r\n          } else if ( /out of gas/.test(err.message) ) {\r\n            console.error(`tx failed (wrong secret?): ${err.message}`)\r\n          } else if ( /insufficient funds for gas/.test(err.message) ) {\r\n            console.error(`insufficient fund for gas: ${err.message}`)\r\n\r\n            debug('swap.core:flow')('insufficient fund for gas... wait fund or request other side to withdraw')\r\n\r\n            const { requireWithdrawFee } = flow.state\r\n\r\n            if (!requireWithdrawFee) {\r\n              flow.swap.room.once('withdraw ready', ({ethSwapWithdrawTransactionHash}) => {\r\n                flow.setState({\r\n                  ethSwapWithdrawTransactionHash,\r\n                })\r\n\r\n                onWithdrawReady()\r\n              })\r\n\r\n              flow.setState({\r\n                requireWithdrawFee: true,\r\n              })\r\n            }\r\n\r\n          } else {\r\n            console.error(err)\r\n          }\r\n\r\n          flow.setState({\r\n            canCreateEthTransaction: false,\r\n          })\r\n\r\n          return null\r\n        }\r\n      }\r\n\r\n      return true\r\n    }\r\n\r\n    const isEthWithdrawn = await util.helpers.repeatAsyncUntilResult((stopRepeater) =>\r\n      tryWithdraw(stopRepeater),\r\n    )\r\n\r\n    if (isEthWithdrawn) {\r\n      onWithdrawReady()\r\n    }\r\n  }\r\n}\r\n\r\n\r\nexport default EthTokenSwap\r\n"]}]}