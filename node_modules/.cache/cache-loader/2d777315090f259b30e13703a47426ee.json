{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\ETH2NEXT.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\ETH2NEXT.ts","mtime":1614842913756},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXN5bmNUb0dlbmVyYXRvciI7CmltcG9ydCBfY2xhc3NDYWxsQ2hlY2sgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jcmVhdGVDbGFzcyI7CmltcG9ydCBfYXNzZXJ0VGhpc0luaXRpYWxpemVkIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXNzZXJ0VGhpc0luaXRpYWxpemVkIjsKaW1wb3J0IF9pbmhlcml0cyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjsKaW1wb3J0IF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiI7CmltcG9ydCBfZ2V0IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0IjsKaW1wb3J0IF9nZXRQcm90b3R5cGVPZiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldFByb3RvdHlwZU9mIjsKaW1wb3J0IF9kZWZpbmVQcm9wZXJ0eSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2RlZmluZVByb3BlcnR5IjsKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgppbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnOwppbXBvcnQgeyBjb25zdGFudHMsIHV0aWwgfSBmcm9tICdzd2FwLmFwcCc7CmltcG9ydCB7IEF0b21pY0FCMlVUWE8gfSBmcm9tICdzd2FwLnN3YXAnOwoKdmFyIEVUSDJORVhUID0gLyojX19QVVJFX18qL2Z1bmN0aW9uIChfQXRvbWljQUIyVVRYTykgewogIF9pbmhlcml0cyhFVEgyTkVYVCwgX0F0b21pY0FCMlVUWE8pOwoKICB2YXIgX3N1cGVyID0gX2NyZWF0ZVN1cGVyKEVUSDJORVhUKTsKCiAgZnVuY3Rpb24gRVRIMk5FWFQoc3dhcCkgewogICAgdmFyIF90aGlzU3VwZXIsIF90aGlzOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBFVEgyTkVYVCk7CgogICAgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCBzd2FwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJfZmxvd05hbWUiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImV0aFN3YXAiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIm5leHRTd2FwIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJzdGF0ZSIsIHZvaWQgMCk7CgogICAgX3RoaXMudXR4b0NvaW4gPSAibmV4dCI7CiAgICBfdGhpcy5fZmxvd05hbWUgPSBFVEgyTkVYVC5nZXROYW1lKCk7CiAgICBfdGhpcy5zdGVwTnVtYmVycyA9IHsKICAgICAgJ3NpZ24nOiAxLAogICAgICAnd2FpdC1sb2NrLXV0eG8nOiAyLAogICAgICAndmVyaWZ5LXNjcmlwdCc6IDMsCiAgICAgICdzeW5jLWJhbGFuY2UnOiA0LAogICAgICAnbG9jay1ldGgnOiA1LAogICAgICAnd2FpdC13aXRoZHJhdy1ldGgnOiA2LAogICAgICAvLyBha2EgZ2V0U2VjcmV0CiAgICAgICd3aXRoZHJhdy11dHhvJzogNywKICAgICAgJ2ZpbmlzaCc6IDgsCiAgICAgICdlbmQnOiA5CiAgICB9OwogICAgX3RoaXMuZXRoU3dhcCA9IHN3YXAucGFydGljaXBhbnRTd2FwOwogICAgX3RoaXMubmV4dFN3YXAgPSBzd2FwLm93bmVyU3dhcDsKICAgIF90aGlzLmFiQmxvY2tjaGFpbiA9IF90aGlzLmV0aFN3YXA7CiAgICBfdGhpcy51dHhvQmxvY2tjaGFpbiA9IF90aGlzLm5leHRTd2FwOwoKICAgIGlmICghX3RoaXMuZXRoU3dhcCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VUSDJORVhUOiAiZXRoU3dhcCIgb2YgdHlwZSBvYmplY3QgcmVxdWlyZWQnKTsKICAgIH0KCiAgICBpZiAoIV90aGlzLm5leHRTd2FwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignRVRIMk5FWFQ6ICJuZXh0U3dhcCIgb2YgdHlwZSBvYmplY3QgcmVxdWlyZWQnKTsKICAgIH0KCiAgICBfdGhpcy5zdGF0ZSA9IHsKICAgICAgc3RlcDogMCwKICAgICAgaXNTdG9wcGVkU3dhcDogZmFsc2UsCiAgICAgIHNpZ25UcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgIGlzU2lnbkZldGNoaW5nOiBmYWxzZSwKICAgICAgaXNNZVNpZ25lZDogZmFsc2UsCiAgICAgIHRhcmdldFdhbGxldDogbnVsbCwKICAgICAgc2VjcmV0SGFzaDogbnVsbCwKICAgICAgbmV4dFNjcmlwdFZlcmlmaWVkOiBmYWxzZSwKICAgICAgaXNCYWxhbmNlRmV0Y2hpbmc6IGZhbHNlLAogICAgICBpc0JhbGFuY2VFbm91Z2g6IHRydWUsCiAgICAgIGJhbGFuY2U6IG51bGwsCiAgICAgIGV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgY2FuQ3JlYXRlRXRoVHJhbnNhY3Rpb246IHRydWUsCiAgICAgIGlzRXRoQ29udHJhY3RGdW5kZWQ6IGZhbHNlLAogICAgICBzZWNyZXQ6IG51bGwsCiAgICAgIGlzRXRoV2l0aGRyYXduOiBmYWxzZSwKICAgICAgaXNOZXh0V2l0aGRyYXduOiBmYWxzZSwKICAgICAgZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICBuZXh0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICByZWZ1bmRUcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgIGlzUmVmdW5kZWQ6IGZhbHNlLAogICAgICBpc0ZpbmlzaGVkOiBmYWxzZSwKICAgICAgaXNTd2FwRXhpc3Q6IGZhbHNlLAogICAgICB3aXRoZHJhd1JlcXVlc3RJbmNvbWluZzogZmFsc2UsCiAgICAgIHdpdGhkcmF3UmVxdWVzdEFjY2VwdGVkOiBmYWxzZSwKICAgICAgaXNGYWlsZWRUcmFuc2FjdGlvbjogZmFsc2UsCiAgICAgIGlzRmFpbGVkVHJhbnNhY3Rpb25FcnJvcjogbnVsbAogICAgfTsKCiAgICBfdGhpcy5fcGVyc2lzdFN0YXRlKCk7CgogICAgdmFyIGZsb3cgPSBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKTsKCiAgICBmbG93LnN3YXAucm9vbS5vbmNlKCdyZXF1ZXN0IHdpdGhkcmF3JywgZnVuY3Rpb24gKCkgewogICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICB3aXRoZHJhd1JlcXVlc3RJbmNvbWluZzogdHJ1ZQogICAgICB9KTsKICAgIH0pOwogICAgZmxvdy5zd2FwLnJvb20ub24oJ3JlcXVlc3QgZXRoIGNvbnRyYWN0JywgZnVuY3Rpb24gKCkgewogICAgICBjb25zb2xlLmxvZygnUmVxdWVzdGluZyBldGggY29udHJhY3QnKTsKICAgICAgdmFyIGV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaCA9IGZsb3cuc3RhdGUuZXRoU3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoOwoKICAgICAgaWYgKGV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaCkgewogICAgICAgIGNvbnNvbGUubG9nKCdFeGlzdHMgLSBzZW5kIGhhc2gnKTsKICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICBldmVudDogJ2NyZWF0ZSBldGggY29udHJhY3QnLAogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBldGhTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2g6IGV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaAogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKCiAgICBfZ2V0KChfdGhpc1N1cGVyID0gX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksIF9nZXRQcm90b3R5cGVPZihFVEgyTkVYVC5wcm90b3R5cGUpKSwgIl9wZXJzaXN0U3RlcHMiLCBfdGhpc1N1cGVyKS5jYWxsKF90aGlzU3VwZXIpOwoKICAgIHJldHVybiBfdGhpczsKICB9CgogIF9jcmVhdGVDbGFzcyhFVEgyTkVYVCwgW3sKICAgIGtleTogIl9wZXJzaXN0U3RhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9wZXJzaXN0U3RhdGUoKSB7CiAgICAgIF9nZXQoX2dldFByb3RvdHlwZU9mKEVUSDJORVhULnByb3RvdHlwZSksICJfcGVyc2lzdFN0YXRlIiwgdGhpcykuY2FsbCh0aGlzKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfZ2V0U3RlcHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9nZXRTdGVwcygpIHsKICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICB2YXIgZmxvdyA9IHRoaXM7CiAgICAgIHJldHVybiBbLy8gMS4gU2lnbiBzd2FwIHRvIHN0YXJ0CiAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpczIuc2lnbkFCU2lkZSgpOwogICAgICB9LCAvLyAyLiBXYWl0IHBhcnRpY2lwYW50IGNyZWF0ZSwgZnVuZCBORVhUIFNjcmlwdAogICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgZmxvdy53YWl0VVRYT1NjcmlwdENyZWF0ZWQoKTsKICAgICAgfSwgLy8gMy4gVmVyaWZ5IE5FWFQgU2NyaXB0CiAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgid2FpdGluZyB2ZXJpZnkgbmV4dCBzY3JpcHQiKTsgLy8gdGhpcy52ZXJpZnlOZXh0U2NyaXB0KCkKICAgICAgfSwgLy8gNC4gQ2hlY2sgYmFsYW5jZQogICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMyLnN5bmNCYWxhbmNlKCk7CiAgICAgIH0sCiAgICAgIC8qI19fUFVSRV9fKi8KICAgICAgLy8gNS4gQ3JlYXRlIEVUSCBDb250cmFjdAogICAgICBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiBmbG93LmV0aFN3YXAuZnVuZEFCMlVUWE9Db250cmFjdCh7CiAgICAgICAgICAgICAgICAgIGZsb3c6IGZsb3csCiAgICAgICAgICAgICAgICAgIHV0eG9Db2luOiAibmV4dCIKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlKTsKICAgICAgfSkpLAogICAgICAvKiNfX1BVUkVfXyovCiAgICAgIC8vIDYuIFdhaXQgcGFydGljaXBhbnQgd2l0aGRyYXcKICAgICAgX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIoKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMiQoX2NvbnRleHQyKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Mi5wcmV2ID0gX2NvbnRleHQyLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gZmxvdy5ldGhTd2FwLmdldFNlY3JldEZyb21BQjJVVFhPKHsKICAgICAgICAgICAgICAgICAgZmxvdzogZmxvdwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMik7CiAgICAgIH0pKSwKICAgICAgLyojX19QVVJFX18qLwogICAgICAvLyA3LiBXaXRoZHJhdwogICAgICBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMygpIHsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzJChfY29udGV4dDMpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQzLnByZXYgPSBfY29udGV4dDMubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLmhlbHBlcnMucmVwZWF0QXN5bmNVbnRpbFJlc3VsdChmdW5jdGlvbiAoc3RvcFJlcGVhdCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Zsb3ckc3RhdGUgPSBmbG93LnN0YXRlLAogICAgICAgICAgICAgICAgICAgICAgc2VjcmV0ID0gX2Zsb3ckc3RhdGUuc2VjcmV0LAogICAgICAgICAgICAgICAgICAgICAgdXR4b1NjcmlwdFZhbHVlcyA9IF9mbG93JHN0YXRlLnV0eG9TY3JpcHRWYWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgICBuZXh0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoID0gX2Zsb3ckc3RhdGUubmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDsKCiAgICAgICAgICAgICAgICAgIGlmIChuZXh0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmICghdXR4b1NjcmlwdFZhbHVlcykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1RoZXJlIGlzIG5vICJ1dHhvU2NyaXB0VmFsdWVzIiBpbiBzdGF0ZS4gTm8gd2F5IHRvIGNvbnRpbnVlIHN3YXAuLi4nKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZsb3cubmV4dFN3YXAud2l0aGRyYXcoewogICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlczogdXR4b1NjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgICBzZWNyZXQ6IHNlY3JldCwKICAgICAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbkFkZHJlc3M6IGZsb3cuc3dhcC5kZXN0aW5hdGlvbkJ1eUFkZHJlc3MKICAgICAgICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCd3aXRoZHJhdyBoYXNoJywgaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICBuZXh0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBoYXNoCiAgICAgICAgICAgICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0pWyJjYXRjaCJdKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICBpc05leHRXaXRoZHJhd246IHRydWUKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgc3RlcDogJ3dpdGhkcmF3LXV0eG8nCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUzKTsKICAgICAgfSkpLCAvLyA4LiBGaW5pc2gKICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIGZsb3cuc3dhcC5yb29tLm9uY2UoJ3JlcXVlc3Qgc3dhcCBmaW5pc2hlZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBuZXh0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoID0gZmxvdy5zdGF0ZS5uZXh0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOwogICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICBldmVudDogJ3N3YXAgZmluaXNoZWQnLAogICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaAogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgaXNGaW5pc2hlZDogdHJ1ZQogICAgICAgIH0sIHsKICAgICAgICAgIHN0ZXA6ICdmaW5pc2gnCiAgICAgICAgfSk7CiAgICAgIH0sIC8vIDkuIEZpbmlzaGVkIQogICAgICBmdW5jdGlvbiAoKSB7fV07CiAgICB9CiAgfSwgewogICAga2V5OiAiX2NoZWNrU3dhcEFscmVhZHlFeGlzdHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9jaGVja1N3YXBBbHJlYWR5RXhpc3RzKCkgewogICAgICB2YXIgc3dhcERhdGEgPSB7CiAgICAgICAgb3duZXJBZGRyZXNzOiB0aGlzLmFwcC5nZXRNeUV0aEFkZHJlc3MoKSwKICAgICAgICBwYXJ0aWNpcGFudEFkZHJlc3M6IHRoaXMuYXBwLmdldFBhcnRpY2lwYW50RXRoQWRkcmVzcyh0aGlzLnN3YXApCiAgICAgIH07CiAgICAgIHJldHVybiB0aGlzLmV0aFN3YXAuY2hlY2tTd2FwRXhpc3RzKHN3YXBEYXRhKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ0cnlSZWZ1bmQiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF90cnlSZWZ1bmQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNCgpIHsKICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgdmFyIHNlY3JldEhhc2gsIHJlZnVuZEhhbmRsZXIsIHdhc1JlZnVuZGVkOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTQkKF9jb250ZXh0NCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDQucHJldiA9IF9jb250ZXh0NC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgc2VjcmV0SGFzaCA9IHRoaXMuc3RhdGUuc2VjcmV0SGFzaDsKCiAgICAgICAgICAgICAgICByZWZ1bmRIYW5kbGVyID0gZnVuY3Rpb24gcmVmdW5kSGFuZGxlcigpIHsKICAgICAgICAgICAgICAgICAgdmFyIGhhc2ggPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IG51bGw7CgogICAgICAgICAgICAgICAgICBfdGhpczMuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICBldmVudDogJ2V0aCByZWZ1bmQgY29tcGxldGVkJwogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgIF90aGlzMy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgcmVmdW5kVHJhbnNhY3Rpb25IYXNoOiBoYXNoLAogICAgICAgICAgICAgICAgICAgIGlzUmVmdW5kZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgaXNTd2FwRXhpc3Q6IGZhbHNlCiAgICAgICAgICAgICAgICAgIH0sIHRydWUpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBfY29udGV4dDQucHJldiA9IDI7CiAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ldGhTd2FwLndhc1JlZnVuZGVkKHsKICAgICAgICAgICAgICAgICAgc2VjcmV0SGFzaDogc2VjcmV0SGFzaAogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgIHdhc1JlZnVuZGVkID0gX2NvbnRleHQ0LnNlbnQ7CgogICAgICAgICAgICAgICAgaWYgKCF3YXNSZWZ1bmRlZCkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDEwOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgnVGhpcyBzd2FwIHdhcyByZWZ1bmRlZCcpOwogICAgICAgICAgICAgICAgcmVmdW5kSGFuZGxlcigpOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5hYnJ1cHQoInJldHVybiIsIHRydWUpOwoKICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSAxNjsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICAgICAgX2NvbnRleHQ0LnByZXYgPSAxMjsKICAgICAgICAgICAgICAgIF9jb250ZXh0NC50MCA9IF9jb250ZXh0NFsiY2F0Y2giXSgyKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2Fybignd2FzUmVmdW5kZWQgZXJyb3I6JywgX2NvbnRleHQ0LnQwKTsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuYWJydXB0KCJyZXR1cm4iLCBmYWxzZSk7CgogICAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LmFicnVwdCgicmV0dXJuIiwgdGhpcy5ldGhTd2FwLnJlZnVuZCh7CiAgICAgICAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogdGhpcy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKHRoaXMuc3dhcCkKICAgICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICByZWZ1bmRIYW5kbGVyKGhhc2gpOwogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pWyJjYXRjaCJdKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgIGNhc2UgMTc6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTQsIHRoaXMsIFtbMiwgMTJdXSk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHRyeVJlZnVuZCgpIHsKICAgICAgICByZXR1cm4gX3RyeVJlZnVuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gdHJ5UmVmdW5kOwogICAgfSgpCiAgfSwgewogICAga2V5OiAiaXNSZWZ1bmRTdWNjZXNzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfaXNSZWZ1bmRTdWNjZXNzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTUoKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNSQoX2NvbnRleHQ1KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NS5wcmV2ID0gX2NvbnRleHQ1Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ1LmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNSk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGlzUmVmdW5kU3VjY2VzcygpIHsKICAgICAgICByZXR1cm4gX2lzUmVmdW5kU3VjY2Vzcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gaXNSZWZ1bmRTdWNjZXNzOwogICAgfSgpCiAgfSwgewogICAga2V5OiAidHJ5V2l0aGRyYXciLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF90cnlXaXRoZHJhdyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU2KF9zZWNyZXQpIHsKICAgICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgICAgdmFyIF90aGlzJHN0YXRlLCBzZWNyZXQsIHNlY3JldEhhc2gsIGlzRXRoV2l0aGRyYXduLCBpc05leHRXaXRoZHJhd24sIHV0eG9TY3JpcHRWYWx1ZXMsIF9zZWNyZXRIYXNoLCBfdGhpcyRuZXh0U3dhcCRjcmVhdGUsIHNjcmlwdEFkZHJlc3MsIGJhbGFuY2U7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTYkKF9jb250ZXh0NikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDYucHJldiA9IF9jb250ZXh0Ni5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX3RoaXMkc3RhdGUgPSB0aGlzLnN0YXRlLCBzZWNyZXQgPSBfdGhpcyRzdGF0ZS5zZWNyZXQsIHNlY3JldEhhc2ggPSBfdGhpcyRzdGF0ZS5zZWNyZXRIYXNoLCBpc0V0aFdpdGhkcmF3biA9IF90aGlzJHN0YXRlLmlzRXRoV2l0aGRyYXduLCBpc05leHRXaXRoZHJhd24gPSBfdGhpcyRzdGF0ZS5pc05leHRXaXRoZHJhd24sIHV0eG9TY3JpcHRWYWx1ZXMgPSBfdGhpcyRzdGF0ZS51dHhvU2NyaXB0VmFsdWVzOwoKICAgICAgICAgICAgICAgIGlmIChfc2VjcmV0KSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaXRoZHJhd2FsIGlzIGF1dG9tYXRpYy4gRm9yIG1hbnVhbCB3aXRoZHJhd2FsLCBwcm92aWRlIGEgc2VjcmV0Iik7CgogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIGlmICh1dHhvU2NyaXB0VmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gNTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgd2l0aGRyYXcgd2l0aG91dCBzY3JpcHQgdmFsdWVzIik7CgogICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgIGlmIChzZWNyZXQgJiYgc2VjcmV0ICE9IF9zZWNyZXQpIGNvbnNvbGUud2FybigiU2VjcmV0IGFscmVhZHkga25vd24gYW5kIGlzIGRpZmZlcmVudC4gQXJlIHlvdSBzdXJlPyIpOwogICAgICAgICAgICAgICAgaWYgKGlzTmV4dFdpdGhkcmF3bikgY29uc29sZS53YXJuKCJMb29rcyBsaWtlIG1vbmV5IHdlcmUgYWxyZWFkeSB3aXRoZHJhd24sIGFyZSB5b3Ugc3VyZT8iKTsKICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJXSVRIRFJBVyB1c2luZyBzZWNyZXQgPSAiLmNvbmNhdChfc2VjcmV0KSk7CiAgICAgICAgICAgICAgICBfc2VjcmV0SGFzaCA9IHRoaXMuYXBwLmVudi5iaXRjb2luLmNyeXB0by5yaXBlbWQxNjAoQnVmZmVyLmZyb20oX3NlY3JldCwgJ2hleCcpKS50b1N0cmluZygnaGV4Jyk7CiAgICAgICAgICAgICAgICBpZiAoc2VjcmV0SGFzaCAhPSBfc2VjcmV0SGFzaCkgY29uc29sZS53YXJuKCJIYXNoIGRvZXMgbm90IG1hdGNoISBzdGF0ZTogIi5jb25jYXQoc2VjcmV0SGFzaCwgIiwgZ2l2ZW46ICIpLmNvbmNhdChfc2VjcmV0SGFzaCkpOwogICAgICAgICAgICAgICAgX3RoaXMkbmV4dFN3YXAkY3JlYXRlID0gdGhpcy5uZXh0U3dhcC5jcmVhdGVTY3JpcHQodXR4b1NjcmlwdFZhbHVlcyksIHNjcmlwdEFkZHJlc3MgPSBfdGhpcyRuZXh0U3dhcCRjcmVhdGUuc2NyaXB0QWRkcmVzczsKICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMTM7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5uZXh0U3dhcC5nZXRCYWxhbmNlKHNjcmlwdEFkZHJlc3MpOwoKICAgICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICAgICAgYmFsYW5jZSA9IF9jb250ZXh0Ni5zZW50OwogICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoImFkZHJlc3M9Ii5jb25jYXQoc2NyaXB0QWRkcmVzcywgIiwgYmFsYW5jZT0iKS5jb25jYXQoYmFsYW5jZSkpOwoKICAgICAgICAgICAgICAgIGlmICghKGJhbGFuY2UgPT09IDApKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMTg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgIGlzTmV4dFdpdGhkcmF3bjogdHJ1ZQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBzdGVwOiAnd2l0aGRyYXctdXR4bycKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbHJlYWR5IHdpdGhkcmF3bjogYWRkcmVzcz0iLmNvbmNhdChzY3JpcHRBZGRyZXNzLCAiLGJhbGFuY2U9IikuY29uY2F0KGJhbGFuY2UpKTsKCiAgICAgICAgICAgICAgY2FzZSAxODoKICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMjA7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5uZXh0U3dhcC53aXRoZHJhdyh7CiAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlczogdXR4b1NjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgc2VjcmV0OiBfc2VjcmV0CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgiVFggaGFzaD0iLmNvbmNhdChoYXNoKSk7CgogICAgICAgICAgICAgICAgICBfdGhpczQuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgIG5leHRTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IGhhc2gKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSAyMDoKICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJUWCB3aXRoZHJhdyBzZW50OiAiLmNvbmNhdCh0aGlzLnN0YXRlLm5leHRTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2gpKTsKICAgICAgICAgICAgICAgIHRoaXMuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgIGlzTmV4dFdpdGhkcmF3bjogdHJ1ZQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBzdGVwOiAnd2l0aGRyYXctdXR4bycKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDIyOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ2LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU2LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gdHJ5V2l0aGRyYXcoX3gpIHsKICAgICAgICByZXR1cm4gX3RyeVdpdGhkcmF3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnlXaXRoZHJhdzsKICAgIH0oKQogIH1dLCBbewogICAga2V5OiAiZ2V0TmFtZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0TmFtZSgpIHsKICAgICAgcmV0dXJuICIiLmNvbmNhdCh0aGlzLmdldEZyb21OYW1lKCksICIyIikuY29uY2F0KHRoaXMuZ2V0VG9OYW1lKCkpOwogICAgfQogIH0sIHsKICAgIGtleTogImdldEZyb21OYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRGcm9tTmFtZSgpIHsKICAgICAgcmV0dXJuIGNvbnN0YW50cy5DT0lOUy5ldGg7CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2V0VG9OYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRUb05hbWUoKSB7CiAgICAgIHJldHVybiBjb25zdGFudHMuQ09JTlMubmV4dDsKICAgIH0KICB9XSk7CgogIHJldHVybiBFVEgyTkVYVDsKfShBdG9taWNBQjJVVFhPKTsKCmV4cG9ydCBkZWZhdWx0IEVUSDJORVhUOw=="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.flows/ETH2NEXT.ts"],"names":["debug","constants","util","AtomicAB2UTXO","ETH2NEXT","swap","utxoCoin","_flowName","getName","stepNumbers","ethSwap","participantSwap","nextSwap","ownerSwap","abBlockchain","utxoBlockchain","Error","state","step","isStoppedSwap","signTransactionHash","isSignFetching","isMeSigned","targetWallet","secretHash","nextScriptVerified","isBalanceFetching","isBalanceEnough","balance","ethSwapCreationTransactionHash","canCreateEthTransaction","isEthContractFunded","secret","isEthWithdrawn","isNextWithdrawn","ethSwapWithdrawTransactionHash","nextSwapWithdrawTransactionHash","refundTransactionHash","isRefunded","isFinished","isSwapExist","withdrawRequestIncoming","withdrawRequestAccepted","isFailedTransaction","isFailedTransactionError","_persistState","flow","room","once","setState","on","console","log","sendMessage","event","data","signABSide","waitUTXOScriptCreated","syncBalance","fundAB2UTXOContract","getSecretFromAB2UTXO","helpers","repeatAsyncUntilResult","stopRepeat","utxoScriptValues","error","withdraw","scriptValues","destinationAddress","destinationBuyAddress","then","hash","finishStep","swapData","ownerAddress","app","getMyEthAddress","participantAddress","getParticipantEthAddress","checkSwapExists","refundHandler","wasRefunded","warn","refund","_secret","_secretHash","env","bitcoin","crypto","ripemd160","Buffer","from","toString","createScript","scriptAddress","getBalance","getFromName","getToName","COINS","eth","next"],"mappings":"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","sourcesContent":["import debug from 'debug'\r\nimport SwapApp, { constants, util } from 'swap.app'\r\nimport { AtomicAB2UTXO } from 'swap.swap'\r\n\r\n\r\nclass ETH2NEXT extends AtomicAB2UTXO {\r\n\r\n  _flowName: string\r\n  ethSwap: any\r\n  nextSwap: any\r\n  state: any\r\n\r\n  static getName() {\r\n    return `${this.getFromName()}2${this.getToName()}`\r\n  }\r\n  static getFromName() {\r\n    return constants.COINS.eth\r\n  }\r\n  static getToName() {\r\n    return constants.COINS.next\r\n  }\r\n  constructor(swap) {\r\n    super(swap)\r\n    this.utxoCoin = `next`\r\n    this._flowName = ETH2NEXT.getName()\r\n\r\n    this.stepNumbers = {\r\n      'sign': 1,\r\n      'wait-lock-utxo': 2,\r\n      'verify-script': 3,\r\n      'sync-balance': 4,\r\n      'lock-eth': 5,\r\n      'wait-withdraw-eth': 6, // aka getSecret\r\n      'withdraw-utxo': 7,\r\n      'finish': 8,\r\n      'end': 9\r\n    }\r\n\r\n    this.ethSwap = swap.participantSwap\r\n    this.nextSwap = swap.ownerSwap\r\n\r\n    this.abBlockchain = this.ethSwap\r\n    this.utxoBlockchain = this.nextSwap\r\n\r\n    if (!this.ethSwap) {\r\n      throw new Error('ETH2NEXT: \"ethSwap\" of type object required')\r\n    }\r\n    if (!this.nextSwap) {\r\n      throw new Error('ETH2NEXT: \"nextSwap\" of type object required')\r\n    }\r\n\r\n    this.state = {\r\n      step: 0,\r\n\r\n      isStoppedSwap: false,\r\n\r\n      signTransactionHash: null,\r\n      isSignFetching: false,\r\n      isMeSigned: false,\r\n\r\n      targetWallet : null,\r\n      secretHash: null,\r\n\r\n      nextScriptVerified: false,\r\n\r\n      isBalanceFetching: false,\r\n      isBalanceEnough: true,\r\n      balance: null,\r\n\r\n      ethSwapCreationTransactionHash: null,\r\n      canCreateEthTransaction: true,\r\n      isEthContractFunded: false,\r\n\r\n      secret: null,\r\n\r\n      isEthWithdrawn: false,\r\n      isNextWithdrawn: false,\r\n\r\n      ethSwapWithdrawTransactionHash: null,\r\n      nextSwapWithdrawTransactionHash: null,\r\n\r\n      refundTransactionHash: null,\r\n      isRefunded: false,\r\n\r\n      isFinished: false,\r\n      isSwapExist: false,\r\n\r\n      withdrawRequestIncoming: false,\r\n      withdrawRequestAccepted: false,\r\n\r\n      isFailedTransaction: false,\r\n      isFailedTransactionError: null,\r\n    }\r\n\r\n    this._persistState()\r\n\r\n    const flow = this\r\n    flow.swap.room.once('request withdraw', () => {\r\n      flow.setState({\r\n        withdrawRequestIncoming: true,\r\n      })\r\n    })\r\n\r\n    flow.swap.room.on('request eth contract', () => {\r\n      console.log('Requesting eth contract')\r\n      const { ethSwapCreationTransactionHash } = flow.state\r\n\r\n      if (ethSwapCreationTransactionHash) {\r\n        console.log('Exists - send hash')\r\n        flow.swap.room.sendMessage({\r\n          event: 'create eth contract',\r\n          data: {\r\n            ethSwapCreationTransactionHash,\r\n          },\r\n        })\r\n      }\r\n    })\r\n\r\n    super._persistSteps()\r\n  }\r\n\r\n  _persistState() {\r\n    super._persistState()\r\n  }\r\n\r\n  _getSteps() {\r\n    const flow = this\r\n\r\n    return [\r\n\r\n      // 1. Sign swap to start\r\n\r\n      () => {\r\n        this.signABSide()\r\n      },\r\n\r\n      // 2. Wait participant create, fund NEXT Script\r\n\r\n      () => {\r\n        flow.waitUTXOScriptCreated()\r\n      },\r\n\r\n      // 3. Verify NEXT Script\r\n\r\n      () => {\r\n        debug('swap.core:flow')(`waiting verify next script`)\r\n        // this.verifyNextScript()\r\n      },\r\n\r\n      // 4. Check balance\r\n\r\n      () => {\r\n        this.syncBalance()\r\n      },\r\n\r\n      // 5. Create ETH Contract\r\n\r\n      async () => {\r\n        await flow.ethSwap.fundAB2UTXOContract({\r\n          flow,\r\n          utxoCoin: `next`,\r\n        })\r\n      },\r\n\r\n      // 6. Wait participant withdraw\r\n\r\n      async () => {\r\n        await flow.ethSwap.getSecretFromAB2UTXO({ flow })\r\n      },\r\n\r\n      // 7. Withdraw\r\n\r\n      async () => {\r\n        await util.helpers.repeatAsyncUntilResult((stopRepeat) => {\r\n          const { secret, utxoScriptValues, nextSwapWithdrawTransactionHash } = flow.state\r\n\r\n          if (nextSwapWithdrawTransactionHash) {\r\n            return true\r\n          }\r\n\r\n          if (!utxoScriptValues) {\r\n            console.error('There is no \"utxoScriptValues\" in state. No way to continue swap...')\r\n            return null\r\n          }\r\n\r\n          return flow.nextSwap.withdraw({\r\n            scriptValues: utxoScriptValues,\r\n            secret,\r\n            destinationAddress: flow.swap.destinationBuyAddress,\r\n          })\r\n            .then((hash) => {\r\n              console.log('withdraw hash', hash)\r\n              flow.setState({\r\n                nextSwapWithdrawTransactionHash: hash,\r\n              }, true)\r\n              return true\r\n            })\r\n            .catch((error) => null)\r\n        })\r\n\r\n        flow.finishStep({\r\n          isNextWithdrawn: true,\r\n        }, { step: 'withdraw-utxo' })\r\n      },\r\n\r\n      // 8. Finish\r\n\r\n      () => {\r\n        flow.swap.room.once('request swap finished', () => {\r\n          const { nextSwapWithdrawTransactionHash } = flow.state\r\n\r\n          flow.swap.room.sendMessage({\r\n            event: 'swap finished',\r\n            data: {\r\n              nextSwapWithdrawTransactionHash,\r\n            },\r\n          })\r\n        })\r\n\r\n        flow.finishStep({\r\n          isFinished: true,\r\n        }, { step: 'finish' })\r\n      },\r\n\r\n      // 9. Finished!\r\n\r\n      () => {}\r\n    ]\r\n  }\r\n\r\n  _checkSwapAlreadyExists() {\r\n    const swapData = {\r\n      ownerAddress: this.app.getMyEthAddress(),\r\n      participantAddress: this.app.getParticipantEthAddress(this.swap)\r\n    }\r\n\r\n    return this.ethSwap.checkSwapExists(swapData)\r\n  }\r\n\r\n  async tryRefund() {\r\n    const { secretHash } = this.state\r\n\r\n    const refundHandler = (hash = null) => {\r\n      this.swap.room.sendMessage({\r\n        event: 'eth refund completed',\r\n      })\r\n\r\n      this.setState({\r\n        refundTransactionHash: hash,\r\n        isRefunded: true,\r\n        isSwapExist: false,\r\n      }, true)\r\n    }\r\n\r\n    try {\r\n      const wasRefunded = await this.ethSwap.wasRefunded({ secretHash })\r\n\r\n      if (wasRefunded) {\r\n        debug('swap.core:flow')('This swap was refunded')\r\n\r\n        refundHandler()\r\n\r\n        return true\r\n      }\r\n    } catch (error) {\r\n      console.warn('wasRefunded error:', error)\r\n\r\n      return false\r\n    }\r\n\r\n    return this.ethSwap.refund({\r\n      participantAddress: this.app.getParticipantEthAddress(this.swap),\r\n    })\r\n      .then((hash) => {\r\n        if (!hash) {\r\n          return false\r\n        }\r\n\r\n        refundHandler(hash)\r\n\r\n        return true\r\n      })\r\n      .catch((error) => false)\r\n  }\r\n\r\n  async isRefundSuccess() {\r\n    return true\r\n  }\r\n\r\n  async tryWithdraw(_secret) {\r\n    const { secret, secretHash, isEthWithdrawn, isNextWithdrawn, utxoScriptValues } = this.state\r\n\r\n    if (!_secret)\r\n      throw new Error(`Withdrawal is automatic. For manual withdrawal, provide a secret`)\r\n\r\n    if (!utxoScriptValues)\r\n      throw new Error(`Cannot withdraw without script values`)\r\n\r\n    if (secret && secret != _secret)\r\n      console.warn(`Secret already known and is different. Are you sure?`)\r\n\r\n    if (isNextWithdrawn)\r\n      console.warn(`Looks like money were already withdrawn, are you sure?`)\r\n\r\n    debug('swap.core:flow')(`WITHDRAW using secret = ${_secret}`)\r\n\r\n    const _secretHash = this.app.env.bitcoin.crypto.ripemd160(Buffer.from(_secret, 'hex')).toString('hex')\r\n\r\n    if (secretHash != _secretHash)\r\n      console.warn(`Hash does not match! state: ${secretHash}, given: ${_secretHash}`)\r\n\r\n    const { scriptAddress } = this.nextSwap.createScript(utxoScriptValues)\r\n    const balance = await this.nextSwap.getBalance(scriptAddress)\r\n\r\n    debug('swap.core:flow')(`address=${scriptAddress}, balance=${balance}`)\r\n\r\n    if (balance === 0) {\r\n      this.finishStep({\r\n        isNextWithdrawn: true,\r\n      }, { step: 'withdraw-utxo' })\r\n      throw new Error(`Already withdrawn: address=${scriptAddress},balance=${balance}`)\r\n    }\r\n\r\n    await this.nextSwap.withdraw({\r\n      scriptValues: utxoScriptValues,\r\n      secret: _secret,\r\n    }, (hash) => {\r\n      debug('swap.core:flow')(`TX hash=${hash}`)\r\n      this.setState({\r\n        nextSwapWithdrawTransactionHash: hash,\r\n      })\r\n    })\r\n    debug('swap.core:flow')(`TX withdraw sent: ${this.state.nextSwapWithdrawTransactionHash}`)\r\n\r\n    this.finishStep({\r\n      isNextWithdrawn: true,\r\n    }, { step: 'withdraw-utxo' })\r\n  }\r\n}\r\n\r\n\r\nexport default ETH2NEXT\r\n"]}]}