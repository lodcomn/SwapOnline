{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.swaps\\EthSwap.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.swaps\\EthSwap.ts","mtime":1614851198878},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9zbGljZWRUb0FycmF5IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvc2xpY2VkVG9BcnJheSI7CmltcG9ydCBfdG9BcnJheSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL3RvQXJyYXkiOwppbXBvcnQgX3RvQ29uc3VtYWJsZUFycmF5IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvdG9Db25zdW1hYmxlQXJyYXkiOwppbXBvcnQgX2FzeW5jVG9HZW5lcmF0b3IgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9hc3luY1RvR2VuZXJhdG9yIjsKaW1wb3J0IF9jbGFzc0NhbGxDaGVjayBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2NsYXNzQ2FsbENoZWNrIjsKaW1wb3J0IF9jcmVhdGVDbGFzcyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2NyZWF0ZUNsYXNzIjsKaW1wb3J0IF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQiOwppbXBvcnQgX2dldCBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldCI7CmltcG9ydCBfaW5oZXJpdHMgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9pbmhlcml0cyI7CmltcG9ydCBfcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4iOwppbXBvcnQgX2dldFByb3RvdHlwZU9mIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0UHJvdG90eXBlT2YiOwppbXBvcnQgX2RlZmluZVByb3BlcnR5IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZGVmaW5lUHJvcGVydHkiOwoKZnVuY3Rpb24gb3duS2V5cyhvYmplY3QsIGVudW1lcmFibGVPbmx5KSB7IHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqZWN0KTsgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsgdmFyIHN5bWJvbHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKG9iamVjdCk7IGlmIChlbnVtZXJhYmxlT25seSkgc3ltYm9scyA9IHN5bWJvbHMuZmlsdGVyKGZ1bmN0aW9uIChzeW0pIHsgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBzeW0pLmVudW1lcmFibGU7IH0pOyBrZXlzLnB1c2guYXBwbHkoa2V5cywgc3ltYm9scyk7IH0gcmV0dXJuIGtleXM7IH0KCmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQodGFyZ2V0KSB7IGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7IHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV0gIT0gbnVsbCA/IGFyZ3VtZW50c1tpXSA6IHt9OyBpZiAoaSAlIDIpIHsgb3duS2V5cyhPYmplY3Qoc291cmNlKSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7IF9kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgc291cmNlW2tleV0pOyB9KTsgfSBlbHNlIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycykgeyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHNvdXJjZSkpOyB9IGVsc2UgeyBvd25LZXlzKE9iamVjdChzb3VyY2UpKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHNvdXJjZSwga2V5KSk7IH0pOyB9IH0gcmV0dXJuIHRhcmdldDsgfQoKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgovLyBAdHMtbm9jaGVjawppbXBvcnQgX2RlYnVnIGZyb20gJ2RlYnVnJzsKaW1wb3J0IHsgY29uc3RhbnRzLCBTd2FwSW50ZXJmYWNlLCB1dGlsIH0gZnJvbSAnc3dhcC5hcHAnOwppbXBvcnQgQmlnTnVtYmVyIGZyb20gJ2JpZ251bWJlci5qcyc7CmltcG9ydCBJbnB1dERhdGFEZWNvZGVyIGZyb20gJ2V0aGVyZXVtLWlucHV0LWRhdGEtZGVjb2Rlcic7Cgp2YXIgZGVidWcgPSBfZGVidWcoJ3N3YXAuY29yZTpzd2FwcycpOwoKdmFyIEV0aFN3YXAgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9Td2FwSW50ZXJmYWNlKSB7CiAgX2luaGVyaXRzKEV0aFN3YXAsIF9Td2FwSW50ZXJmYWNlKTsKCiAgdmFyIF9zdXBlciA9IF9jcmVhdGVTdXBlcihFdGhTd2FwKTsKCiAgLyoqDQogICAqDQogICAqIEBwYXJhbSB7b2JqZWN0fSAgICBvcHRpb25zDQogICAqIEBwYXJhbSB7c3RyaW5nfSAgICBvcHRpb25zLmFkZHJlc3MNCiAgICogQHBhcmFtIHthcnJheX0gICAgIG9wdGlvbnMuYWJpDQogICAqIEBwYXJhbSB7bnVtYmVyfSAgICBvcHRpb25zLmdhc0xpbWl0DQogICAqIEBwYXJhbSB7ZnVuY3Rpb259ICBvcHRpb25zLmZldGNoQmFsYW5jZQ0KICAgKi8KICBmdW5jdGlvbiBFdGhTd2FwKG9wdGlvbnMpIHsKICAgIHZhciBfdGhpczsKCiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRXRoU3dhcCk7CgogICAgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJhZGRyZXNzIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJhYmkiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIl9zd2FwTmFtZSIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZ2FzTGltaXQiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImdhc1ByaWNlIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJmZXRjaEJhbGFuY2UiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImVzdGltYXRlR2FzUHJpY2UiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgInNlbmRUcmFuc2FjdGlvbiIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiYXBwIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJkZWNvZGVyIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJjb250cmFjdCIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiX2FsbFN3YXBFdmVudHMiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImdldFNlY3JldEZyb21UeGhhc2giLCBmdW5jdGlvbiAodHJhbnNhY3Rpb25IYXNoKSB7CiAgICAgIHJldHVybiBfdGhpcy5hcHAuZW52LmdldFdlYjMoKS5ldGguZ2V0VHJhbnNhY3Rpb24odHJhbnNhY3Rpb25IYXNoKS50aGVuKGZ1bmN0aW9uICh0eFJlc3VsdCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgYnl0ZXMzMiA9IF90aGlzLmRlY29kZXIuZGVjb2RlRGF0YSh0eFJlc3VsdC5pbnB1dCk7CgogICAgICAgICAgcmV0dXJuIF90aGlzLmFwcC5lbnYuZ2V0V2ViMygpLnV0aWxzLmJ5dGVzVG9IZXgoYnl0ZXMzMi5pbnB1dHNbMF0pLnNwbGl0KCcweCcpWzFdOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgZGVidWcoJ1RyeWluZyB0byBmZXRjaCBzZWNyZXQgZnJvbSB0eDogJyArIGVyci5tZXNzYWdlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CgogICAgaWYgKHR5cGVvZiBvcHRpb25zLmZldGNoQmFsYW5jZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V0aFN3YXA6ICJmZXRjaEJhbGFuY2UiIHJlcXVpcmVkJyk7CiAgICB9CgogICAgaWYgKHR5cGVvZiBvcHRpb25zLmFkZHJlc3MgIT09ICdzdHJpbmcnKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignRXRoU3dhcDogImFkZHJlc3MiIHJlcXVpcmVkJyk7CiAgICB9CgogICAgaWYgKCFBcnJheS5pc0FycmF5KG9wdGlvbnMuYWJpKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V0aFN3YXA6ICJhYmkiIHJlcXVpcmVkJyk7CiAgICB9CgogICAgaWYgKHR5cGVvZiBvcHRpb25zLmVzdGltYXRlR2FzUHJpY2UgIT09ICdmdW5jdGlvbicpIHsKICAgICAgLy8gKHsgc3BlZWQgfSA9IHt9KSA9PiBnYXNQcmljZQogICAgICBjb25zb2xlLndhcm4oIkV0aFRva2VuU3dhcDogXCJlc3RpbWF0ZUdhc1ByaWNlXCIgaXMgbm90IGEgZnVuY3Rpb24uIFlvdSB3aWxsIG5vdCBiZSBhYmxlIHVzZSBhdXRvbWF0aWMgbWVtcG9vbC1iYXNlZCBmZWUiKTsKICAgIH0KCiAgICBfdGhpcy5hZGRyZXNzID0gb3B0aW9ucy5hZGRyZXNzOwogICAgX3RoaXMuYWJpID0gb3B0aW9ucy5hYmk7CiAgICBfdGhpcy5fc3dhcE5hbWUgPSBjb25zdGFudHMuQ09JTlMuZXRoOwogICAgX3RoaXMuZ2FzTGltaXQgPSBvcHRpb25zLmdhc0xpbWl0IHx8IDNlNTsKICAgIF90aGlzLmdhc1ByaWNlID0gb3B0aW9ucy5nYXNQcmljZSB8fCAyZTk7CiAgICBfdGhpcy5mZXRjaEJhbGFuY2UgPSBvcHRpb25zLmZldGNoQmFsYW5jZTsKCiAgICBfdGhpcy5lc3RpbWF0ZUdhc1ByaWNlID0gb3B0aW9ucy5lc3RpbWF0ZUdhc1ByaWNlIHx8IGZ1bmN0aW9uICgpIHt9OwoKICAgIF90aGlzLnNlbmRUcmFuc2FjdGlvbiA9IG9wdGlvbnMuc2VuZFRyYW5zYWN0aW9uOwogICAgcmV0dXJuIF90aGlzOwogIH0KCiAgX2NyZWF0ZUNsYXNzKEV0aFN3YXAsIFt7CiAgICBrZXk6ICJfaW5pdFN3YXAiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9pbml0U3dhcChhcHApIHsKICAgICAgX2dldChfZ2V0UHJvdG90eXBlT2YoRXRoU3dhcC5wcm90b3R5cGUpLCAiX2luaXRTd2FwIiwgdGhpcykuY2FsbCh0aGlzLCBhcHApOwoKICAgICAgdGhpcy5hcHAgPSBhcHA7CiAgICAgIHRoaXMuZGVjb2RlciA9IG5ldyBJbnB1dERhdGFEZWNvZGVyKHRoaXMuYWJpKTsKICAgICAgdmFyIHdlYjMgPSB0aGlzLmFwcC5lbnYuZ2V0V2ViMygpOwogICAgICB0aGlzLmNvbnRyYWN0ID0gbmV3IHdlYjMuZXRoLkNvbnRyYWN0KHRoaXMuYWJpLCB0aGlzLmFkZHJlc3MpOwogICAgfQogICAgLyoqDQogICAgICogQGRlcHJlY2F0ZWQNCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAidXBkYXRlR2FzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB1cGRhdGVHYXMoKSB7CiAgICAgIGNvbnNvbGUud2FybigiRXRoU3dhcC51cGRhdGVHYXMoKSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQuIFVzZSAudXBkYXRlR2FzUHJpY2UoKSIpOyAvL0AKCiAgICAgIHJldHVybiB1cGRhdGVHYXNQcmljZSgpOwogICAgfQogIH0sIHsKICAgIGtleTogInVwZGF0ZUdhc1ByaWNlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfdXBkYXRlR2FzUHJpY2UgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBkZWJ1ZygnZ2FzIHByaWNlIGJlZm9yZSB1cGRhdGUnLCB0aGlzLmdhc1ByaWNlKTsKICAgICAgICAgICAgICAgIF9jb250ZXh0LnByZXYgPSAxOwogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lc3RpbWF0ZUdhc1ByaWNlKHsKICAgICAgICAgICAgICAgICAgc3BlZWQ6ICdmYXN0JwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIHRoaXMuZ2FzUHJpY2UgPSBfY29udGV4dC5zZW50OwogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDEwOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgIF9jb250ZXh0LnByZXYgPSA3OwogICAgICAgICAgICAgICAgX2NvbnRleHQudDAgPSBfY29udGV4dFsiY2F0Y2giXSgxKTsKICAgICAgICAgICAgICAgIGRlYnVnKCJFdGhTd2FwOiBFcnJvciB3aXRoIGdhcyB1cGRhdGU6ICIuY29uY2F0KF9jb250ZXh0LnQwLm1lc3NhZ2UsICIsIHVzaW5nIG9sZCB2YWx1ZSBnYXNQcmljZT0iKS5jb25jYXQodGhpcy5nYXNQcmljZSkpOwoKICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgZGVidWcoJ2dhcyBwcmljZSBhZnRlciB1cGRhdGUnLCB0aGlzLmdhc1ByaWNlKTsKCiAgICAgICAgICAgICAgY2FzZSAxMToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUsIHRoaXMsIFtbMSwgN11dKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gdXBkYXRlR2FzUHJpY2UoKSB7CiAgICAgICAgcmV0dXJuIF91cGRhdGVHYXNQcmljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gdXBkYXRlR2FzUHJpY2U7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXRIYXNoDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEudGFyZ2V0V2FsbGV0DQogICAgICogQHBhcmFtIHtudW1iZXJ9IGRhdGEuYW1vdW50DQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlVHJhbnNhY3Rpb25IYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImNyZWF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2NyZWF0ZSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyKGRhdGEsIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIkKF9jb250ZXh0MikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDIucHJldiA9IF9jb250ZXh0Mi5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgaWYgKCEoZGF0YS50YXJnZXRXYWxsZXQgJiYgZGF0YS50YXJnZXRXYWxsZXQgIT09IGRhdGEucGFydGljaXBhbnRBZGRyZXNzICYmIHRoaXMuaGFzVGFyZ2V0V2FsbGV0KCkpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gNDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5hYnJ1cHQoInJldHVybiIsIHRoaXMuY3JlYXRlU3dhcFRhcmdldChkYXRhLCBoYW5kbGVUcmFuc2FjdGlvbkhhc2gpKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5hYnJ1cHQoInJldHVybiIsIHRoaXMuY3JlYXRlU3dhcChkYXRhLCBoYW5kbGVUcmFuc2FjdGlvbkhhc2gpKTsKCiAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUyLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gY3JlYXRlKF94LCBfeDIpIHsKICAgICAgICByZXR1cm4gX2NyZWF0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gY3JlYXRlOwogICAgfSgpCiAgfSwgewogICAga2V5OiAic2VuZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3NlbmQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNChtZXRob2ROYW1lLCBhcmdzKSB7CiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICAgIHZhciBfcGFyYW1zLAogICAgICAgICAgICBoYW5kbGVUcmFuc2FjdGlvbkhhc2gsCiAgICAgICAgICAgIF9hcmdzNCA9IGFyZ3VtZW50czsKCiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NC5wcmV2ID0gX2NvbnRleHQ0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfcGFyYW1zID0gX2FyZ3M0Lmxlbmd0aCA+IDIgJiYgX2FyZ3M0WzJdICE9PSB1bmRlZmluZWQgPyBfYXJnczRbMl0gOiB7fTsKICAgICAgICAgICAgICAgIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCA9IF9hcmdzNC5sZW5ndGggPiAzID8gX2FyZ3M0WzNdIDogdW5kZWZpbmVkOwoKICAgICAgICAgICAgICAgIGlmICghKHR5cGVvZiB0aGlzLmNvbnRyYWN0Lm1ldGhvZHNbbWV0aG9kTmFtZV0gIT09ICdmdW5jdGlvbicpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gNDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFdGhTd2FwLnNlbmQ6IE5vIG1ldGhvZCAiLmNvbmNhdChtZXRob2ROYW1lLCAiIGluIGNvbnRyYWN0IikpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDY7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVHYXNQcmljZSgpOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LmFicnVwdCgicmV0dXJuIiwgbmV3IFByb21pc2UoIC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfcmVmID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90aGlzMiRjb250cmFjdCRtZXRobywgX3RoaXMyJGNvbnRyYWN0JG1ldGhvMjsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmFtcywgZ2FzQW1vdW50LCByZWNlaXB0OwogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTMkKF9jb250ZXh0MykgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDMucHJldiA9IF9jb250ZXh0My5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0gX29iamVjdFNwcmVhZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb206IF90aGlzMi5hcHAuZ2V0TXlFdGhBZGRyZXNzKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhczogX3RoaXMyLmdhc0xpbWl0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXNQcmljZTogX3RoaXMyLmdhc1ByaWNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBfcGFyYW1zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKCJFdGhTd2FwIC0+ICIuY29uY2F0KG1ldGhvZE5hbWUsICIgLT4gcGFyYW1zIiksIHBhcmFtcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKF90aGlzMiRjb250cmFjdCRtZXRobyA9IF90aGlzMi5jb250cmFjdC5tZXRob2RzKVttZXRob2ROYW1lXS5hcHBseShfdGhpczIkY29udHJhY3QkbWV0aG8sIF90b0NvbnN1bWFibGVBcnJheShhcmdzKSkuZXN0aW1hdGVHYXMocGFyYW1zKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FzQW1vdW50ID0gX2NvbnRleHQzLnNlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMuZ2FzID0gZ2FzQW1vdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoIkV0aFN3YXAgLT4gIi5jb25jYXQobWV0aG9kTmFtZSwgIiAtPiBnYXMiKSwgZ2FzQW1vdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gOTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoX3RoaXMyJGNvbnRyYWN0JG1ldGhvMiA9IF90aGlzMi5jb250cmFjdC5tZXRob2RzKVttZXRob2ROYW1lXS5hcHBseShfdGhpczIkY29udHJhY3QkbWV0aG8yLCBfdG9Db25zdW1hYmxlQXJyYXkoYXJncykpLnNlbmQocGFyYW1zKS5vbigndHJhbnNhY3Rpb25IYXNoJywgZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBoYW5kbGVUcmFuc2FjdGlvbkhhc2ggPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVUcmFuc2FjdGlvbkhhc2goaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLm9uKCdlcnJvcicsIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjZWlwdCA9IF9jb250ZXh0My5zZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZWNlaXB0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxMToKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMyk7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoX3g1LCBfeDYpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSgpKSk7CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNCwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHNlbmQoX3gzLCBfeDQpIHsKICAgICAgICByZXR1cm4gX3NlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHNlbmQ7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXRIYXNoDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEudGFyZ2V0V2FsbGV0DQogICAgICogQHBhcmFtIHtudW1iZXJ9IGRhdGEuYW1vdW50DQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlVHJhbnNhY3Rpb25IYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImNyZWF0ZVN3YXAiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jcmVhdGVTd2FwID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTUoZGF0YSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSB7CiAgICAgICAgdmFyIHNlY3JldEhhc2gsIHBhcnRpY2lwYW50QWRkcmVzcywgYW1vdW50LCB3ZWIzLCBhbW91bnRXZWksIGhhc2gsIGFyZ3M7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNSQoX2NvbnRleHQ1KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NS5wcmV2ID0gX2NvbnRleHQ1Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBzZWNyZXRIYXNoID0gZGF0YS5zZWNyZXRIYXNoLCBwYXJ0aWNpcGFudEFkZHJlc3MgPSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcywgYW1vdW50ID0gZGF0YS5hbW91bnQ7CiAgICAgICAgICAgICAgICB3ZWIzID0gdGhpcy5hcHAuZW52LmdldFdlYjMoKTsKICAgICAgICAgICAgICAgIGFtb3VudFdlaSA9IHdlYjMudXRpbHMudG9XZWkoYW1vdW50LnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgaGFzaCA9ICIweCIuY29uY2F0KHNlY3JldEhhc2gucmVwbGFjZSgvXjB4LywgJycpKTsKICAgICAgICAgICAgICAgIGFyZ3MgPSBbaGFzaCwgcGFydGljaXBhbnRBZGRyZXNzXTsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuYWJydXB0KCJyZXR1cm4iLCB0aGlzLnNlbmQoJ2NyZWF0ZVN3YXAnLCBbXS5jb25jYXQoYXJncyksIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IGFtb3VudFdlaQogICAgICAgICAgICAgICAgfSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSk7CgogICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGNyZWF0ZVN3YXAoX3g3LCBfeDgpIHsKICAgICAgICByZXR1cm4gX2NyZWF0ZVN3YXAuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNyZWF0ZVN3YXA7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXRIYXNoDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEudGFyZ2V0V2FsbGV0DQogICAgICogQHBhcmFtIHtudW1iZXJ9IGRhdGEuYW1vdW50DQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlVHJhbnNhY3Rpb25IYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImNyZWF0ZVN3YXBUYXJnZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jcmVhdGVTd2FwVGFyZ2V0ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTYoZGF0YSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSB7CiAgICAgICAgdmFyIHNlY3JldEhhc2gsIHBhcnRpY2lwYW50QWRkcmVzcywgYW1vdW50LCB0YXJnZXRXYWxsZXQsIHdlYjMsIGFtb3VudFdlaSwgaGFzaCwgdmFsdWVzOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTYkKF9jb250ZXh0NikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDYucHJldiA9IF9jb250ZXh0Ni5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgc2VjcmV0SGFzaCA9IGRhdGEuc2VjcmV0SGFzaCwgcGFydGljaXBhbnRBZGRyZXNzID0gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MsIGFtb3VudCA9IGRhdGEuYW1vdW50LCB0YXJnZXRXYWxsZXQgPSBkYXRhLnRhcmdldFdhbGxldDsKICAgICAgICAgICAgICAgIHdlYjMgPSB0aGlzLmFwcC5lbnYuZ2V0V2ViMygpOwogICAgICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSA0OwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlR2FzUHJpY2UoKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgYW1vdW50V2VpID0gd2ViMy51dGlscy50b1dlaShhbW91bnQudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICBoYXNoID0gIjB4Ii5jb25jYXQoc2VjcmV0SGFzaC5yZXBsYWNlKC9eMHgvLCAnJykpOwogICAgICAgICAgICAgICAgdmFsdWVzID0gW2hhc2gsIHBhcnRpY2lwYW50QWRkcmVzcywgdGFyZ2V0V2FsbGV0XTsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDYuYWJydXB0KCJyZXR1cm4iLCB0aGlzLnNlbmQoJ2NyZWF0ZVN3YXBUYXJnZXQnLCBbXS5jb25jYXQodmFsdWVzKSwgewogICAgICAgICAgICAgICAgICB2YWx1ZTogYW1vdW50V2VpCiAgICAgICAgICAgICAgICB9LCBoYW5kbGVUcmFuc2FjdGlvbkhhc2gpKTsKCiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ2LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU2LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gY3JlYXRlU3dhcFRhcmdldChfeDksIF94MTApIHsKICAgICAgICByZXR1cm4gX2NyZWF0ZVN3YXBUYXJnZXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNyZWF0ZVN3YXBUYXJnZXQ7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5vd25lckFkZHJlc3MNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2V0QmFsYW5jZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0QmFsYW5jZShkYXRhKSB7CiAgICAgIHZhciBvd25lckFkZHJlc3MgPSBkYXRhLm93bmVyQWRkcmVzczsKICAgICAgcmV0dXJuIHRoaXMuY29udHJhY3QubWV0aG9kcy5nZXRCYWxhbmNlKG93bmVyQWRkcmVzcykuY2FsbCh7CiAgICAgICAgZnJvbTogdGhpcy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCkKICAgICAgfSk7CiAgICB9CiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEub3duZXJBZGRyZXNzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogInN3YXBzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzd2FwcyhkYXRhKSB7CiAgICAgIHZhciBvd25lckFkZHJlc3MgPSBkYXRhLm93bmVyQWRkcmVzcywKICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzcyA9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzOwogICAgICByZXR1cm4gdGhpcy5jb250cmFjdC5tZXRob2RzLnN3YXBzKG93bmVyQWRkcmVzcywgcGFydGljaXBhbnRBZGRyZXNzKS5jYWxsKCk7CiAgICB9CiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEub3duZXJBZGRyZXNzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImNoZWNrU3dhcEV4aXN0cyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2NoZWNrU3dhcEV4aXN0cyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU3KGRhdGEpIHsKICAgICAgICB2YXIgc3dhcCwgYmFsYW5jZTsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU3JChfY29udGV4dDcpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ3LnByZXYgPSBfY29udGV4dDcubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0Ny5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnN3YXBzKGRhdGEpOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBzd2FwID0gX2NvbnRleHQ3LnNlbnQ7CiAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcEV4aXN0cycsIHN3YXApOwogICAgICAgICAgICAgICAgYmFsYW5jZSA9IHN3YXAgJiYgc3dhcC5iYWxhbmNlID8gcGFyc2VJbnQoc3dhcC5iYWxhbmNlKSA6IDA7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ3LmFicnVwdCgicmV0dXJuIiwgYmFsYW5jZSA+IDApOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDcuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTcsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBjaGVja1N3YXBFeGlzdHMoX3gxMSkgewogICAgICAgIHJldHVybiBfY2hlY2tTd2FwRXhpc3RzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBjaGVja1N3YXBFeGlzdHM7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5vd25lckFkZHJlc3MNCiAgICAgKiBAcGFyYW0ge0JpZ051bWJlcn0gZGF0YS5leHBlY3RlZFZhbHVlDQogICAgICogQHJldHVybnMge1Byb21pc2UuPHN0cmluZz59DQogICAgICovCgogIH0sIHsKICAgIGtleTogImNoZWNrQmFsYW5jZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2NoZWNrQmFsYW5jZSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU4KGRhdGEpIHsKICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgdmFyIG93bmVyQWRkcmVzcywgcGFydGljaXBhbnRBZGRyZXNzLCBleHBlY3RlZFZhbHVlLCBleHBlY3RlZEhhc2gsIGJhbGFuY2UsIHN3YXAsIHNlY3JldEhhc2gsIF9zZWNyZXRIYXNoLCBleHBlY3RlZFZhbHVlV2VpOwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU4JChfY29udGV4dDgpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ4LnByZXYgPSBfY29udGV4dDgubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzcyA9IGRhdGEub3duZXJBZGRyZXNzLCBwYXJ0aWNpcGFudEFkZHJlc3MgPSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcywgZXhwZWN0ZWRWYWx1ZSA9IGRhdGEuZXhwZWN0ZWRWYWx1ZSwgZXhwZWN0ZWRIYXNoID0gZGF0YS5leHBlY3RlZEhhc2g7CiAgICAgICAgICAgICAgICBfY29udGV4dDgubmV4dCA9IDM7CiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5oZWxwZXJzLnJlcGVhdEFzeW5jVW50aWxSZXN1bHQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzLmdldEJhbGFuY2UoewogICAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogb3duZXJBZGRyZXNzCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIGJhbGFuY2UgPSBfY29udGV4dDguc2VudDsKICAgICAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gNjsKICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLmhlbHBlcnMucmVwZWF0QXN5bmNVbnRpbFJlc3VsdChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczMuY29udHJhY3QubWV0aG9kcy5zd2Fwcyhvd25lckFkZHJlc3MsIHBhcnRpY2lwYW50QWRkcmVzcykuY2FsbCgpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgIHN3YXAgPSBfY29udGV4dDguc2VudDsKICAgICAgICAgICAgICAgIC8vQAogICAgICAgICAgICAgICAgc2VjcmV0SGFzaCA9IHN3YXAuc2VjcmV0SGFzaDsKICAgICAgICAgICAgICAgIGRlYnVnKCJzd2FwLnNlY3JldEhhc2giLCBzZWNyZXRIYXNoKTsKICAgICAgICAgICAgICAgIF9zZWNyZXRIYXNoID0gIiIuY29uY2F0KHNlY3JldEhhc2gucmVwbGFjZSgvXjB4LywgJycpKTsKICAgICAgICAgICAgICAgIGRlYnVnKCJzZWNyZXRIYXNoOiBleHBlY3RlZCBoYXNoID0gIi5jb25jYXQoZXhwZWN0ZWRIYXNoLCAiLCBjb250cmFjdCBoYXNoID0gIikuY29uY2F0KF9zZWNyZXRIYXNoKSk7CgogICAgICAgICAgICAgICAgaWYgKCEoZXhwZWN0ZWRIYXNoICE9PSBfc2VjcmV0SGFzaCkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ4Lm5leHQgPSAxMzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OC5hYnJ1cHQoInJldHVybiIsICJFeHBlY3RlZCBoYXNoOiAiLmNvbmNhdChleHBlY3RlZEhhc2gsICIsIGdvdDogIikuY29uY2F0KF9zZWNyZXRIYXNoKSk7CgogICAgICAgICAgICAgIGNhc2UgMTM6CiAgICAgICAgICAgICAgICBleHBlY3RlZFZhbHVlV2VpID0gbmV3IEJpZ051bWJlcihleHBlY3RlZFZhbHVlKS5tdWx0aXBsaWVkQnkoMWUxOCk7IC8vQAoKICAgICAgICAgICAgICAgIGlmICghZXhwZWN0ZWRWYWx1ZVdlaS5pc0dyZWF0ZXJUaGFuKGJhbGFuY2UpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gMTY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDguYWJydXB0KCJyZXR1cm4iLCAiRXhwZWN0ZWQgdmFsdWU6ICIuY29uY2F0KGV4cGVjdGVkVmFsdWVXZWkudG9TdHJpbmcoKSwgIiwgZ290OiAiKS5jb25jYXQoYmFsYW5jZSkpOwoKICAgICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ4LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU4KTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gY2hlY2tCYWxhbmNlKF94MTIpIHsKICAgICAgICByZXR1cm4gX2NoZWNrQmFsYW5jZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gY2hlY2tCYWxhbmNlOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJmZXRjaFN3YXBFdmVudHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9mZXRjaFN3YXBFdmVudHMgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlOSgpIHsKICAgICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgICAgdmFyIGFsbFN3YXBFdmVudHM7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlOSQoX2NvbnRleHQ5KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0OS5wcmV2ID0gX2NvbnRleHQ5Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2FsbFN3YXBFdmVudHMpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAyOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LmFicnVwdCgicmV0dXJuIiwgdGhpcy5fYWxsU3dhcEV2ZW50cyk7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIF9jb250ZXh0OS5uZXh0ID0gNDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbnRyYWN0LmdldFBhc3RFdmVudHMoJ2FsbEV2ZW50cycsIHsKICAgICAgICAgICAgICAgICAgZnJvbUJsb2NrOiAwLAogICAgICAgICAgICAgICAgICB0b0Jsb2NrOiAnbGF0ZXN0JwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIGFsbFN3YXBFdmVudHMgPSBfY29udGV4dDkuc2VudDsKICAgICAgICAgICAgICAgIHRoaXMuY29udHJhY3QuZXZlbnRzLmFsbEV2ZW50cyh7CiAgICAgICAgICAgICAgICAgIGZyb21CbG9jazogMCwKICAgICAgICAgICAgICAgICAgdG9CbG9jazogJ2xhdGVzdCcKICAgICAgICAgICAgICAgIH0pLm9uKCdkYXRhJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgIF90aGlzNC5fYWxsU3dhcEV2ZW50cy5wdXNoKGV2ZW50KTsKICAgICAgICAgICAgICAgIH0pLm9uKCdjaGFuZ2VkJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkV0aFN3YXA6IGZldGNoRXZlbnRzOiBuZWVkcyByZXNjYW4iKTsKICAgICAgICAgICAgICAgICAgX3RoaXM0Ll9hbGxTd2FwRXZlbnRzID0gbnVsbDsKICAgICAgICAgICAgICAgIH0pLm9uKCdlcnJvcicsIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpOwogICAgICAgICAgICAgICAgICBfdGhpczQuX2FsbFN3YXBFdmVudHMgPSBudWxsOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLl9hbGxTd2FwRXZlbnRzID0gYWxsU3dhcEV2ZW50czsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDkuYWJydXB0KCJyZXR1cm4iLCBhbGxTd2FwRXZlbnRzKTsKCiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU5LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gZmV0Y2hTd2FwRXZlbnRzKCkgewogICAgICAgIHJldHVybiBfZmV0Y2hTd2FwRXZlbnRzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBmZXRjaFN3YXBFdmVudHM7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXRIYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogImZpbmRTd2FwIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfZmluZFN3YXAgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTAoZGF0YSkgewogICAgICAgIHZhciBzZWNyZXRIYXNoLCBhbGxTd2FwRXZlbnRzLCBzd2FwRXZlbnRzLCBfc3dhcEV2ZW50cywgY3JlYXRlLCBjbG9zZSwgcmVzdDsKCiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMTAkKF9jb250ZXh0MTApIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQxMC5wcmV2ID0gX2NvbnRleHQxMC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgc2VjcmV0SGFzaCA9IGRhdGEuc2VjcmV0SGFzaDsKICAgICAgICAgICAgICAgIF9jb250ZXh0MTAubmV4dCA9IDM7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mZXRjaFN3YXBFdmVudHMoKTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgYWxsU3dhcEV2ZW50cyA9IF9jb250ZXh0MTAuc2VudDsKICAgICAgICAgICAgICAgIHN3YXBFdmVudHMgPSBhbGxTd2FwRXZlbnRzLmZpbHRlcihmdW5jdGlvbiAoX3JlZjIpIHsKICAgICAgICAgICAgICAgICAgdmFyIHJldHVyblZhbHVlcyA9IF9yZWYyLnJldHVyblZhbHVlczsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldHVyblZhbHVlcy5fc2VjcmV0SGFzaCA9PT0gIjB4Ii5jb25jYXQoc2VjcmV0SGFzaC5yZXBsYWNlKCcweCcsICcnKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIF9zd2FwRXZlbnRzID0gX3RvQXJyYXkoc3dhcEV2ZW50cyksIGNyZWF0ZSA9IF9zd2FwRXZlbnRzWzBdLCBjbG9zZSA9IF9zd2FwRXZlbnRzWzFdLCByZXN0ID0gX3N3YXBFdmVudHMuc2xpY2UoMik7CgogICAgICAgICAgICAgICAgaWYgKHJlc3QgJiYgcmVzdC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiTW9yZSB0aGFuIHR3byBzd2FwcyB3aXRoIHNhbWUgaGFzaCIsIHJlc3QpOyAvLyB0aHJvdyBuZXcgRXJyb3IoYE1vcmUgdGhhbiB0d28gc3dhcHMgd2l0aCBzYW1lIGhhc2hgKQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDEwLmFicnVwdCgicmV0dXJuIiwgW2NyZWF0ZSwgY2xvc2VdKTsKCiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTAsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBmaW5kU3dhcChfeDEzKSB7CiAgICAgICAgcmV0dXJuIF9maW5kU3dhcC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZmluZFN3YXA7CiAgICB9KCkKICAgIC8qKg0KICAgICAgKg0KICAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXRIYXNoDQogICAgICAqIEByZXR1cm5zIHtQcm9taXNlKHN0YXR1cyl9DQogICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJ3YXNDbG9zZWQiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF93YXNDbG9zZWQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTEoZGF0YSkgewogICAgICAgIHZhciBfeWllbGQkdGhpcyRmaW5kU3dhcCwgX3lpZWxkJHRoaXMkZmluZFN3YXAyLCBjcmVhdGUsIGNsb3NlOwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxMSQoX2NvbnRleHQxMSkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDExLnByZXYgPSBfY29udGV4dDExLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSAyOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmluZFN3YXAoZGF0YSk7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIF95aWVsZCR0aGlzJGZpbmRTd2FwID0gX2NvbnRleHQxMS5zZW50OwogICAgICAgICAgICAgICAgX3lpZWxkJHRoaXMkZmluZFN3YXAyID0gX3NsaWNlZFRvQXJyYXkoX3lpZWxkJHRoaXMkZmluZFN3YXAsIDIpOwogICAgICAgICAgICAgICAgY3JlYXRlID0gX3lpZWxkJHRoaXMkZmluZFN3YXAyWzBdOwogICAgICAgICAgICAgICAgY2xvc2UgPSBfeWllbGQkdGhpcyRmaW5kU3dhcDJbMV07CgogICAgICAgICAgICAgICAgaWYgKGNyZWF0ZSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSAxMTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZGVidWcoIk5vIHN3YXAgd2l0aCBoYXNoICIuY29uY2F0KGRhdGEuc2VjcmV0SGFzaCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuYWJydXB0KCJyZXR1cm4iLCAnbm8gc3dhcCcpOwoKICAgICAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICAgICAgaWYgKCEoY3JlYXRlICYmICFjbG9zZSkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gMTY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGRlYnVnKCJPcGVuIHlldCEiKTsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDExLmFicnVwdCgicmV0dXJuIiwgJ29wZW4nKTsKCiAgICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgICAgIGlmICghKGNsb3NlLmV2ZW50ID09ICdXaXRoZHJhdycpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTEubmV4dCA9IDIxOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBkZWJ1ZygiV2l0aGRyYXduIik7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMS5hYnJ1cHQoInJldHVybiIsICd3aXRoZHJhd24nKTsKCiAgICAgICAgICAgICAgY2FzZSAyMToKICAgICAgICAgICAgICAgIGlmICghKGNsb3NlLmV2ZW50ID09ICdSZWZ1bmQnKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSAyNjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZGVidWcoIlJlZnVuZCIpOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuYWJydXB0KCJyZXR1cm4iLCAncmVmdW5kZWQnKTsKCiAgICAgICAgICAgICAgY2FzZSAyNjoKICAgICAgICAgICAgICAgIGRlYnVnKCJVbmtub3duIGV2ZW50LCBlcnJvciIpOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuYWJydXB0KCJyZXR1cm4iLCAnZXJyb3InKTsKCiAgICAgICAgICAgICAgY2FzZSAyODoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTExLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gd2FzQ2xvc2VkKF94MTQpIHsKICAgICAgICByZXR1cm4gX3dhc0Nsb3NlZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gd2FzQ2xvc2VkOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0SGFzaA0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlKGJvb2xlYW4pfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJ3YXNSZWZ1bmRlZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gd2FzUmVmdW5kZWQoZGF0YSkgewogICAgICByZXR1cm4gdGhpcy53YXNDbG9zZWQoZGF0YSkudGhlbihmdW5jdGlvbiAoc3RhdHVzKSB7CiAgICAgICAgcmV0dXJuIHN0YXR1cyA9PT0gJ3JlZnVuZGVkJzsKICAgICAgfSk7CiAgICB9CiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0SGFzaA0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlKGJvb2xlYW4pfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJ3YXNXaXRoZHJhd24iLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF93YXNXaXRoZHJhd24gPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTIoZGF0YSkgewogICAgICAgIHZhciBzdGF0dXM7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMTIkKF9jb250ZXh0MTIpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQxMi5wcmV2ID0gX2NvbnRleHQxMi5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX2NvbnRleHQxMi5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLndhc0Nsb3NlZChkYXRhKTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgc3RhdHVzID0gX2NvbnRleHQxMi5zZW50OwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTIuYWJydXB0KCJyZXR1cm4iLCBzdGF0dXMgPT09ICd3aXRoZHJhd24nKTsKCiAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMi5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTIsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiB3YXNXaXRoZHJhd24oX3gxNSkgewogICAgICAgIHJldHVybiBfd2FzV2l0aGRyYXduLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB3YXNXaXRoZHJhd247CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHJldHVybnMge2Jvb2xlYW59DQogICAgICovCgogIH0sIHsKICAgIGtleTogImhhc1RhcmdldFdhbGxldCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gaGFzVGFyZ2V0V2FsbGV0KCkgewogICAgICByZXR1cm4gISF0aGlzLmNvbnRyYWN0Lm1ldGhvZHMuZ2V0VGFyZ2V0V2FsbGV0OwogICAgfQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gb3duZXJBZGRyZXNzDQogICAgICogQHJldHVybnMge1Byb21pc2UuPHN0cmluZz59DQogICAgICovCgogIH0sIHsKICAgIGtleTogImdldFRhcmdldFdhbGxldCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2dldFRhcmdldFdhbGxldCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxMyhvd25lckFkZHJlc3MpIHsKICAgICAgICB2YXIgX3RoaXM1ID0gdGhpczsKCiAgICAgICAgdmFyIGFkZHJlc3M7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMTMkKF9jb250ZXh0MTMpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQxMy5wcmV2ID0gX2NvbnRleHQxMy5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0V0aFN3YXAtPmdldFRhcmdldFdhbGxldCcpOwogICAgICAgICAgICAgICAgX2NvbnRleHQxMy5uZXh0ID0gMzsKICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLmhlbHBlcnMucmVwZWF0QXN5bmNVbnRpbFJlc3VsdChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczUuZ2V0VGFyZ2V0V2FsbGV0UHJvbWlzZShvd25lckFkZHJlc3MpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIGFkZHJlc3MgPSBfY29udGV4dDEzLnNlbnQ7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMy5hYnJ1cHQoInJldHVybiIsIGFkZHJlc3MpOwoKICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDEzLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUxMyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGdldFRhcmdldFdhbGxldChfeDE2KSB7CiAgICAgICAgcmV0dXJuIF9nZXRUYXJnZXRXYWxsZXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGdldFRhcmdldFdhbGxldDsKICAgIH0oKQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gb3duZXJBZGRyZXNzDQogICAgICogQHBhcmFtIHtudW1iZXJ9IHJlcGVhdENvdW50DQogICAgICogQHJldHVybnMge3N0cmluZ30NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2V0VGFyZ2V0V2FsbGV0UHJvbWlzZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2dldFRhcmdldFdhbGxldFByb21pc2UgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTUob3duZXJBZGRyZXNzKSB7CiAgICAgICAgdmFyIF90aGlzNiA9IHRoaXM7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE1JChfY29udGV4dDE1KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTUucHJldiA9IF9jb250ZXh0MTUubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE1LmFicnVwdCgicmV0dXJuIiwgbmV3IFByb21pc2UoIC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfcmVmMyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxNChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0V2FsbGV0OwogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE0JChfY29udGV4dDE0KSB7CiAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTQucHJldiA9IF9jb250ZXh0MTQubmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTQucHJldiA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDE0Lm5leHQgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzNi5jb250cmFjdC5tZXRob2RzLmdldFRhcmdldFdhbGxldChvd25lckFkZHJlc3MpLmNhbGwoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiBfdGhpczYuYXBwLmdldE15RXRoQWRkcmVzcygpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0V2FsbGV0ID0gX2NvbnRleHQxNC5zZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0YXJnZXRXYWxsZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxNC5uZXh0ID0gMTA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxNC5wcmV2ID0gNzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MTQudDAgPSBfY29udGV4dDE0WyJjYXRjaCJdKDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KF9jb250ZXh0MTQudDApOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNC5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMTQsIG51bGwsIFtbMCwgN11dKTsKICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeDE4LCBfeDE5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWYzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KCkpKTsKCiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTUpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBnZXRUYXJnZXRXYWxsZXRQcm9taXNlKF94MTcpIHsKICAgICAgICByZXR1cm4gX2dldFRhcmdldFdhbGxldFByb21pc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGdldFRhcmdldFdhbGxldFByb21pc2U7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXQNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5vd25lckFkZHJlc3MNCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBoYW5kbGVUcmFuc2FjdGlvbkhhc2gNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiY2FsY1dpdGhkcmF3R2FzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfY2FsY1dpdGhkcmF3R2FzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTE2KGRhdGEpIHsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxNiQoX2NvbnRleHQxNikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDE2LnByZXYgPSBfY29udGV4dDE2Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNi5hYnJ1cHQoInJldHVybiIsIHRoaXMuY2FsY1dpdGhkcmF3T3RoZXJHYXMoewogICAgICAgICAgICAgICAgICBvd25lckFkZHJlc3M6IGRhdGEub3duZXJBZGRyZXNzLAogICAgICAgICAgICAgICAgICBwYXJ0aWNpcGFudEFkZHJlc3M6IHRoaXMuYXBwLmdldE15RXRoQWRkcmVzcygpLAogICAgICAgICAgICAgICAgICBzZWNyZXQ6IGRhdGEuc2VjcmV0CiAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTYuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTE2LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gY2FsY1dpdGhkcmF3R2FzKF94MjApIHsKICAgICAgICByZXR1cm4gX2NhbGNXaXRoZHJhd0dhcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gY2FsY1dpdGhkcmF3R2FzOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0DQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEub3duZXJBZGRyZXNzDQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlVHJhbnNhY3Rpb25IYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogIndpdGhkcmF3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfd2l0aGRyYXcgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTcoZGF0YSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMTckKF9jb250ZXh0MTcpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQxNy5wcmV2ID0gX2NvbnRleHQxNy5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTcuYWJydXB0KCJyZXR1cm4iLCB0aGlzLndpdGhkcmF3T3RoZXIoewogICAgICAgICAgICAgICAgICBvd25lckFkZHJlc3M6IGRhdGEub3duZXJBZGRyZXNzLAogICAgICAgICAgICAgICAgICBwYXJ0aWNpcGFudEFkZHJlc3M6IHRoaXMuYXBwLmdldE15RXRoQWRkcmVzcygpLAogICAgICAgICAgICAgICAgICBzZWNyZXQ6IGRhdGEuc2VjcmV0CiAgICAgICAgICAgICAgICB9LCBoYW5kbGVUcmFuc2FjdGlvbkhhc2gpKTsKCiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNy5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTcsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiB3aXRoZHJhdyhfeDIxLCBfeDIyKSB7CiAgICAgICAgcmV0dXJuIF93aXRoZHJhdy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gd2l0aGRyYXc7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXQNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiY2FsY1dpdGhkcmF3Tm9Nb25leUdhcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2NhbGNXaXRoZHJhd05vTW9uZXlHYXMgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTgoZGF0YSkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE4JChfY29udGV4dDE4KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTgucHJldiA9IF9jb250ZXh0MTgubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE4LmFicnVwdCgicmV0dXJuIiwgdGhpcy5jYWxjV2l0aGRyYXdPdGhlckdhcyh7CiAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogdGhpcy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCksCiAgICAgICAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MsCiAgICAgICAgICAgICAgICAgIHNlY3JldDogZGF0YS5zZWNyZXQKICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxOC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMTgsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBjYWxjV2l0aGRyYXdOb01vbmV5R2FzKF94MjMpIHsKICAgICAgICByZXR1cm4gX2NhbGNXaXRoZHJhd05vTW9uZXlHYXMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNhbGNXaXRoZHJhd05vTW9uZXlHYXM7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5zZWNyZXQNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MNCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBoYW5kbGVUcmFuc2FjdGlvbkhhc2gNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAid2l0aGRyYXdOb01vbmV5IiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfd2l0aGRyYXdOb01vbmV5ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTE5KGRhdGEsIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE5JChfY29udGV4dDE5KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTkucHJldiA9IF9jb250ZXh0MTkubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE5LmFicnVwdCgicmV0dXJuIiwgdGhpcy53aXRoZHJhd090aGVyKHsKICAgICAgICAgICAgICAgICAgb3duZXJBZGRyZXNzOiB0aGlzLmFwcC5nZXRNeUV0aEFkZHJlc3MoKSwKICAgICAgICAgICAgICAgICAgcGFydGljaXBhbnRBZGRyZXNzOiBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcywKICAgICAgICAgICAgICAgICAgc2VjcmV0OiBkYXRhLnNlY3JldAogICAgICAgICAgICAgICAgfSwgaGFuZGxlVHJhbnNhY3Rpb25IYXNoKSk7CgogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTkuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTE5LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gd2l0aGRyYXdOb01vbmV5KF94MjQsIF94MjUpIHsKICAgICAgICByZXR1cm4gX3dpdGhkcmF3Tm9Nb25leS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gd2l0aGRyYXdOb01vbmV5OwogICAgfSgpCiAgfSwgewogICAga2V5OiAiY2FsY1dpdGhkcmF3T3RoZXJHYXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jYWxjV2l0aGRyYXdPdGhlckdhcyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyMShkYXRhKSB7CiAgICAgICAgdmFyIF90aGlzNyA9IHRoaXM7CgogICAgICAgIHZhciBvd25lckFkZHJlc3MsIHBhcnRpY2lwYW50QWRkcmVzcywgc2VjcmV0OwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIxJChfY29udGV4dDIxKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MjEucHJldiA9IF9jb250ZXh0MjEubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzcyA9IGRhdGEub3duZXJBZGRyZXNzLCBwYXJ0aWNpcGFudEFkZHJlc3MgPSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcywgc2VjcmV0ID0gZGF0YS5zZWNyZXQ7CiAgICAgICAgICAgICAgICBfY29udGV4dDIxLm5leHQgPSAzOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlR2FzUHJpY2UoKTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjEuYWJydXB0KCJyZXR1cm4iLCBuZXcgUHJvbWlzZSggLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWY0ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIwKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICAgIHZhciBfc2VjcmV0LCBwYXJhbXMsIGdhc0ZlZTsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMjAkKF9jb250ZXh0MjApIHsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyMC5wcmV2ID0gX2NvbnRleHQyMC5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3NlY3JldCA9ICIweCIuY29uY2F0KHNlY3JldC5yZXBsYWNlKC9eMHgvLCAnJykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiBfdGhpczcuYXBwLmdldE15RXRoQWRkcmVzcygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXM6IF90aGlzNy5nYXNMaW1pdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FzUHJpY2U6IF90aGlzNy5nYXNQcmljZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjAucHJldiA9IDI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDIwLm5leHQgPSA1OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzNy5jb250cmFjdC5tZXRob2RzLndpdGhkcmF3T3RoZXIoX3NlY3JldCwgb3duZXJBZGRyZXNzLCBwYXJ0aWNpcGFudEFkZHJlc3MpLmVzdGltYXRlR2FzKHBhcmFtcyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhc0ZlZSA9IF9jb250ZXh0MjAuc2VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZ2FzRmVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjAubmV4dCA9IDEyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgOToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjAucHJldiA9IDk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDIwLnQwID0gX2NvbnRleHQyMFsiY2F0Y2giXSgyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChfY29udGV4dDIwLnQwKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxMjoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjAuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgX2NhbGxlZTIwLCBudWxsLCBbWzIsIDldXSk7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoX3gyNywgX3gyOCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmNC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSgpKSk7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjEuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTIxLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gY2FsY1dpdGhkcmF3T3RoZXJHYXMoX3gyNikgewogICAgICAgIHJldHVybiBfY2FsY1dpdGhkcmF3T3RoZXJHYXMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNhbGNXaXRoZHJhd090aGVyR2FzOwogICAgfSgpCiAgICAvKioNCiAgICAgKg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEuc2VjcmV0DQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEub3duZXJBZGRyZXNzDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEucGFydGljaXBhbnRBZGRyZXNzDQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlVHJhbnNhY3Rpb25IYXNoDQogICAgICogQHJldHVybnMge1Byb21pc2V9DQogICAgICovCgogIH0sIHsKICAgIGtleTogIndpdGhkcmF3T3RoZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF93aXRoZHJhd090aGVyID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIyKGRhdGEsIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCkgewogICAgICAgIHZhciBvd25lckFkZHJlc3MsIHBhcnRpY2lwYW50QWRkcmVzcywgc2VjcmV0LCBfc2VjcmV0OwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUyMiQoX2NvbnRleHQyMikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDIyLnByZXYgPSBfY29udGV4dDIyLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBvd25lckFkZHJlc3MgPSBkYXRhLm93bmVyQWRkcmVzcywgcGFydGljaXBhbnRBZGRyZXNzID0gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MsIHNlY3JldCA9IGRhdGEuc2VjcmV0OwogICAgICAgICAgICAgICAgX3NlY3JldCA9ICIweCIuY29uY2F0KHNlY3JldC5yZXBsYWNlKC9eMHgvLCAnJykpOwogICAgICAgICAgICAgICAgX2NvbnRleHQyMi5uZXh0ID0gNDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZUdhc1ByaWNlKCk7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIyLmFicnVwdCgicmV0dXJuIiwgdGhpcy5zZW5kKCd3aXRoZHJhd090aGVyJywgW19zZWNyZXQsIG93bmVyQWRkcmVzcywgcGFydGljaXBhbnRBZGRyZXNzXSwge30sIGhhbmRsZVRyYW5zYWN0aW9uSGFzaCkpOwoKICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIyLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUyMiwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHdpdGhkcmF3T3RoZXIoX3gyOSwgX3gzMCkgewogICAgICAgIHJldHVybiBfd2l0aGRyYXdPdGhlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gd2l0aGRyYXdPdGhlcjsKICAgIH0oKQogICAgLyoqDQogICAgICoNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YQ0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzcw0KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGhhbmRsZVRyYW5zYWN0aW9uSGFzaA0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfQ0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJyZWZ1bmQiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9yZWZ1bmQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMjMoZGF0YSkgewogICAgICAgIHZhciBoYW5kbGVUcmFuc2FjdGlvbkhhc2gsCiAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzcywKICAgICAgICAgICAgX2FyZ3MyMyA9IGFyZ3VtZW50czsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUyMyQoX2NvbnRleHQyMykgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDIzLnByZXYgPSBfY29udGV4dDIzLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBoYW5kbGVUcmFuc2FjdGlvbkhhc2ggPSBfYXJnczIzLmxlbmd0aCA+IDEgJiYgX2FyZ3MyM1sxXSAhPT0gdW5kZWZpbmVkID8gX2FyZ3MyM1sxXSA6IG51bGw7CiAgICAgICAgICAgICAgICBwYXJ0aWNpcGFudEFkZHJlc3MgPSBkYXRhLnBhcnRpY2lwYW50QWRkcmVzczsKICAgICAgICAgICAgICAgIF9jb250ZXh0MjMubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVHYXNQcmljZSgpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyMy5hYnJ1cHQoInJldHVybiIsIHRoaXMuc2VuZCgncmVmdW5kJywgW3BhcnRpY2lwYW50QWRkcmVzc10sIHt9LCBoYW5kbGVUcmFuc2FjdGlvbkhhc2gpKTsKCiAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyMy5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMjMsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiByZWZ1bmQoX3gzMSkgewogICAgICAgIHJldHVybiBfcmVmdW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiByZWZ1bmQ7CiAgICB9KCkKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGENCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3MNCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0NCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2V0U2VjcmV0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRTZWNyZXQoZGF0YSkgewogICAgICB2YXIgcGFydGljaXBhbnRBZGRyZXNzID0gZGF0YS5wYXJ0aWNpcGFudEFkZHJlc3M7CiAgICAgIHJldHVybiB0aGlzLmNvbnRyYWN0Lm1ldGhvZHMuZ2V0U2VjcmV0KHBhcnRpY2lwYW50QWRkcmVzcykuY2FsbCh7CiAgICAgICAgZnJvbTogdGhpcy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCkKICAgICAgfSkudGhlbihmdW5jdGlvbiAoc2VjcmV0KSB7CiAgICAgICAgZGVidWcoJ3NlY3JldCBldGhzd2FwLmpzJywgc2VjcmV0KTsKICAgICAgICByZXR1cm4gc2VjcmV0ICYmICEvXjB4MCskLy50ZXN0KHNlY3JldCkgPyBzZWNyZXQgOiBudWxsOwogICAgICB9KVsiY2F0Y2giXShmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICByZXR1cm4gZXJyb3I7CiAgICAgIH0pOwogICAgfQogICAgLyoNCiAgICAgIEZ1bmN0aW9uOiB3aXRoZHJhdyhieXRlczMyIF9zZWNyZXQsIGFkZHJlc3MgX293bmVyQWRkcmVzcykNCiAgICAgIGJ5dGVzMzIgey4uLn0NCiAgICAgIGlucHV0czogKDIpIFvigKZdDQogICAgICAgIDA6IFVpbnQ4QXJyYXkoMzIpIFsgMjA4LCAyMDIsIDE3MCwg4oCmIF0NCiAgICAgICAgMTogImU5MThjODcxOWJhZTA1MjU3ODY1NDhiOGRhN2ZiZWY5YjMzZDRlMjUiDQogICAgICBuYW1lOiAid2l0aGRyYXciDQogICAgICB0eXBlczogKDIpIFvigKZdDQogICAgICAgIDA6ICJieXRlczMyIg0KICAgICAgICAxOiAiYWRkcmVzcyINCiAgICAqLwoKICAgIC8qKg0KICAgICAqDQogICAgICogQHBhcmFtIHtzdHJpbmd9IHRyYW5zYWN0aW9uSGFzaA0KICAgICAqIEByZXR1cm5zIHtQcm9taXNlPGFueT59DQogICAgICovCgogIH0sIHsKICAgIGtleTogImZ1bmRDb250cmFjdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX2Z1bmRDb250cmFjdCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyNShfcmVmNSkgewogICAgICAgIHZhciBmbG93LCBhYkNsYXNzLCBfZmxvdyRzd2FwLCBwYXJ0aWNpcGFudCwgYnV5QW1vdW50LCBzZWxsQW1vdW50LCB3YWl0Q29uZmlybSwgc2VjcmV0SGFzaCwgc3dhcERhdGEsIHRyeUNyZWF0ZVN3YXAsIGlzRXRoQ29udHJhY3RGdW5kZWQsIGlzU3RvcHBlZFN3YXA7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTI1JChfY29udGV4dDI1KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MjUucHJldiA9IF9jb250ZXh0MjUubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGZsb3cgPSBfcmVmNS5mbG93OwogICAgICAgICAgICAgICAgYWJDbGFzcyA9IHRoaXM7CiAgICAgICAgICAgICAgICBfZmxvdyRzd2FwID0gZmxvdy5zd2FwLCBwYXJ0aWNpcGFudCA9IF9mbG93JHN3YXAucGFydGljaXBhbnQsIGJ1eUFtb3VudCA9IF9mbG93JHN3YXAuYnV5QW1vdW50LCBzZWxsQW1vdW50ID0gX2Zsb3ckc3dhcC5zZWxsQW1vdW50LCB3YWl0Q29uZmlybSA9IF9mbG93JHN3YXAud2FpdENvbmZpcm07CiAgICAgICAgICAgICAgICBzZWNyZXRIYXNoID0gZmxvdy5zdGF0ZS5zZWNyZXRIYXNoOwogICAgICAgICAgICAgICAgc3dhcERhdGEgPSB7CiAgICAgICAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogYWJDbGFzcy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKGZsb3cuc3dhcCksCiAgICAgICAgICAgICAgICAgIHNlY3JldEhhc2g6IHNlY3JldEhhc2gsCiAgICAgICAgICAgICAgICAgIGFtb3VudDogc2VsbEFtb3VudCwKICAgICAgICAgICAgICAgICAgdGFyZ2V0V2FsbGV0OiBmbG93LnN3YXAuZGVzdGluYXRpb25TZWxsQWRkcmVzcwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB0cnlDcmVhdGVTd2FwID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWY2ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTI0KCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpc0V0aENvbnRyYWN0RnVuZGVkLCBzd2FwRXhpc3RzOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTI0JChfY29udGV4dDI0KSB7CiAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MjQucHJldiA9IF9jb250ZXh0MjQubmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzRXRoQ29udHJhY3RGdW5kZWQgPSBmbG93LnN0YXRlLmlzRXRoQ29udHJhY3RGdW5kZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRXRoQ29udHJhY3RGdW5kZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyNC5uZXh0ID0gMjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjQucHJldiA9IDI7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2RlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCdjaGVjayBzd2FwIGV4aXN0cycpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjQubmV4dCA9IDY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmxvdy5fY2hlY2tTd2FwQWxyZWFkeUV4aXN0cygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2FwRXhpc3RzID0gX2NvbnRleHQyNC5zZW50OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3dhcEV4aXN0cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDI0Lm5leHQgPSAxMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdTd2FwIGV4aXN0cyEhIE1heSBiZSBzdHVja2VkLiBUcnkgcmVmdW5kJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDI0Lm5leHQgPSAxMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmbG93LmV0aFN3YXAucmVmdW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGljaXBhbnRBZGRyZXNzOiBhYkNsYXNzLmFwcC5nZXRQYXJ0aWNpcGFudEV0aEFkZHJlc3MoZmxvdy5zd2FwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKHJlZnVuZFR4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9kZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgnU3R1Y2tlZCBzd2FwIHJlZnVuZGVkJywgcmVmdW5kVHgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ2NyZWF0ZSBzd2FwJywgc3dhcERhdGEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjQubmV4dCA9IDE0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFiQ2xhc3MuY3JlYXRlKHN3YXBEYXRhLCBmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ2NyZWF0ZSBzd2FwIHR4IGhhc2gnLCBoYXNoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudDogJ2NyZWF0ZSBldGggY29udHJhY3QnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDogaGFzaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDogaGFzaCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYW5DcmVhdGVFdGhUcmFuc2FjdGlvbjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0ZhaWxlZFRyYW5zYWN0aW9uOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyNC5uZXh0ID0gMjU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjQucHJldiA9IDE2OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyNC50MCA9IF9jb250ZXh0MjRbImNhdGNoIl0oMik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFmbG93LnN0YXRlLmV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDI0Lm5leHQgPSAyMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignZmFpbCBjcmVhdGUgc3dhcCwgYnV0IHR4IGFscmVhZHkgZXhpc3RzJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuQ3JlYXRlRXRoVHJhbnNhY3Rpb246IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzRmFpbGVkVHJhbnNhY3Rpb246IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDI0LmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoL2tub3duIHRyYW5zYWN0aW9uLy50ZXN0KF9jb250ZXh0MjQudDAubWVzc2FnZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigia25vd24gdHg6ICIuY29uY2F0KF9jb250ZXh0MjQudDAubWVzc2FnZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgvb3V0IG9mIGdhcy8udGVzdChfY29udGV4dDI0LnQwLm1lc3NhZ2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoInR4IGZhaWxlZCAod3Jvbmcgc2VjcmV0Pyk6ICIuY29uY2F0KF9jb250ZXh0MjQudDAubWVzc2FnZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihfY29udGV4dDI0LnQwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FuQ3JlYXRlRXRoVHJhbnNhY3Rpb246IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0ZhaWxlZFRyYW5zYWN0aW9uOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0ZhaWxlZFRyYW5zYWN0aW9uRXJyb3I6IF9jb250ZXh0MjQudDAubWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyNC5hYnJ1cHQoInJldHVybiIsIG51bGwpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI1OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjQuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyNjoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjQuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwgX2NhbGxlZTI0LCBudWxsLCBbWzIsIDE2XV0pOwogICAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gdHJ5Q3JlYXRlU3dhcCgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZjYuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oKTsKCiAgICAgICAgICAgICAgICBfY29udGV4dDI1Lm5leHQgPSA4OwogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy5yZXBlYXRBc3luY1VudGlsUmVzdWx0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRyeUNyZWF0ZVN3YXAoKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICBpc0V0aENvbnRyYWN0RnVuZGVkID0gX2NvbnRleHQyNS5zZW50OwogICAgICAgICAgICAgICAgaXNTdG9wcGVkU3dhcCA9IGZsb3cuc3RhdGUuaXNTdG9wcGVkU3dhcDsKCiAgICAgICAgICAgICAgICBpZiAoaXNFdGhDb250cmFjdEZ1bmRlZCAmJiAhaXNTdG9wcGVkU3dhcCkgewogICAgICAgICAgICAgICAgICBfZGVidWcoJ3N3YXAuY29yZTpmbG93JykoImZpbmlzaCBzdGVwIik7CgogICAgICAgICAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICAgIGlzRXRoQ29udHJhY3RGdW5kZWQ6IGlzRXRoQ29udHJhY3RGdW5kZWQKICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIHN0ZXA6ICdsb2NrLWV0aCcKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNhc2UgMTE6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDI1LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUyNSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGZ1bmRDb250cmFjdChfeDMyKSB7CiAgICAgICAgcmV0dXJuIF9mdW5kQ29udHJhY3QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZ1bmRDb250cmFjdDsKICAgIH0oKQogIH0sIHsKICAgIGtleTogImdldFNlY3JldEZyb21BQjJVVFhPIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfZ2V0U2VjcmV0RnJvbUFCMlVUWE8gPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMjgoX3JlZjcpIHsKICAgICAgICB2YXIgZmxvdywgYWJDbGFzcywgcGFydGljaXBhbnQsIGNoZWNrU2VjcmV0RXhpc3QsIHNlY3JldEZyb21Db250cmFjdCwgaXNFdGhXaXRoZHJhd247CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMjgkKF9jb250ZXh0MjgpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyOC5wcmV2ID0gX2NvbnRleHQyOC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgZmxvdyA9IF9yZWY3LmZsb3c7CiAgICAgICAgICAgICAgICBhYkNsYXNzID0gdGhpczsKICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLm9uY2UoJ2V0aFdpdGhkcmF3VHhIYXNoJywgLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWY5ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTI2KF9yZWY4KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCwgc2VjcmV0RnJvbVR4aGFzaCwgaXNFdGhXaXRoZHJhd247CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMjYkKF9jb250ZXh0MjYpIHsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyNi5wcmV2ID0gX2NvbnRleHQyNi5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoID0gX3JlZjguZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjYubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5oZWxwZXJzLmV4dHJhY3RTZWNyZXRGcm9tVHgoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93OiBmbG93LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2FwRmxvdzogYWJDbGFzcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwOiBhYkNsYXNzLmFwcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWNyZXRGcm9tVHhoYXNoID0gX2NvbnRleHQyNi5zZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNFdGhXaXRoZHJhd24gPSBmbG93LnN0YXRlLmlzRXRoV2l0aGRyYXduOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNFdGhXaXRoZHJhd24gJiYgc2VjcmV0RnJvbVR4aGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ2dvdCBzZWNyZXQgZnJvbSB0eCcsIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCwgc2VjcmV0RnJvbVR4aGFzaCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzRXRoV2l0aGRyYXduOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlY3JldDogc2VjcmV0RnJvbVR4aGFzaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RlcDogJ3dhaXQtd2l0aGRyYXctZXRoJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyNi5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMjYpOwogICAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKF94MzQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZjkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oKSk7CiAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgIGV2ZW50OiAncmVxdWVzdCBldGhXaXRoZHJhd1R4SGFzaCcKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcGFydGljaXBhbnQgPSBmbG93LnN3YXAucGFydGljaXBhbnQ7CgogICAgICAgICAgICAgICAgY2hlY2tTZWNyZXRFeGlzdCA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfcmVmMTAgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMjcoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMjckKF9jb250ZXh0MjcpIHsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyNy5wcmV2ID0gX2NvbnRleHQyNy5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyNy5uZXh0ID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLmhlbHBlcnMuZXh0cmFjdFNlY3JldEZyb21Db250cmFjdCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3c6IGZsb3csCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3YXBGbG93OiBhYkNsYXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0aWNpcGFudEFkZHJlc3M6IGFiQ2xhc3MuYXBwLmdldFBhcnRpY2lwYW50RXRoQWRkcmVzcyhmbG93LnN3YXApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvd25lckFkZHJlc3M6IGZsb3cuYXBwLmdldE15RXRoQWRkcmVzcygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHA6IGFiQ2xhc3MuYXBwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjcuYWJydXB0KCJyZXR1cm4iLCBfY29udGV4dDI3LnNlbnQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDI3LnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUyNyk7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBjaGVja1NlY3JldEV4aXN0KCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmMTAuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0oKTsKCiAgICAgICAgICAgICAgICBfY29udGV4dDI4Lm5leHQgPSA4OwogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy5yZXBlYXRBc3luY1VudGlsUmVzdWx0KGZ1bmN0aW9uIChzdG9wUmVwZWF0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmxvdyRzdGF0ZSA9IGZsb3cuc3RhdGUsCiAgICAgICAgICAgICAgICAgICAgICBpc0V0aFdpdGhkcmF3biA9IF9mbG93JHN0YXRlLmlzRXRoV2l0aGRyYXduLAogICAgICAgICAgICAgICAgICAgICAgaXNSZWZ1bmRlZCA9IF9mbG93JHN0YXRlLmlzUmVmdW5kZWQ7CgogICAgICAgICAgICAgICAgICBpZiAoaXNFdGhXaXRoZHJhd24gfHwgaXNSZWZ1bmRlZCkgewogICAgICAgICAgICAgICAgICAgIHN0b3BSZXBlYXQoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHJldHVybiBjaGVja1NlY3JldEV4aXN0KCk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgc2VjcmV0RnJvbUNvbnRyYWN0ID0gX2NvbnRleHQyOC5zZW50OwogICAgICAgICAgICAgICAgaXNFdGhXaXRoZHJhd24gPSBmbG93LnN0YXRlLmlzRXRoV2l0aGRyYXduOwoKICAgICAgICAgICAgICAgIGlmIChzZWNyZXRGcm9tQ29udHJhY3QgJiYgIWlzRXRoV2l0aGRyYXduKSB7CiAgICAgICAgICAgICAgICAgIF9kZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgnZ290IHNlY3JldCBmcm9tIHNtYXJ0IGNvbnRyYWN0Jywgc2VjcmV0RnJvbUNvbnRyYWN0KTsKCiAgICAgICAgICAgICAgICAgIGZsb3cuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgICAgaXNFdGhXaXRoZHJhd246IHRydWUsCiAgICAgICAgICAgICAgICAgICAgc2VjcmV0OiBzZWNyZXRGcm9tQ29udHJhY3QKICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIHN0ZXA6ICd3YWl0LXdpdGhkcmF3LWV0aCcKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNhc2UgMTE6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDI4LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUyOCwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGdldFNlY3JldEZyb21BQjJVVFhPKF94MzMpIHsKICAgICAgICByZXR1cm4gX2dldFNlY3JldEZyb21BQjJVVFhPLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBnZXRTZWNyZXRGcm9tQUIyVVRYTzsKICAgIH0oKQogIH0sIHsKICAgIGtleTogIndhaXRBQkNvbnRyYWN0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfd2FpdEFCQ29udHJhY3QgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMzAoX3JlZjExKSB7CiAgICAgICAgdmFyIGZsb3csIHV0eG9Db2luLCBhYkNsYXNzLCBwYXJ0aWNpcGFudCwgaXNDb250cmFjdEJhbGFuY2VPaywgaXNFdGhDb250cmFjdEZ1bmRlZDsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzMCQoX2NvbnRleHQzMCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDMwLnByZXYgPSBfY29udGV4dDMwLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBmbG93ID0gX3JlZjExLmZsb3csIHV0eG9Db2luID0gX3JlZjExLnV0eG9Db2luOwogICAgICAgICAgICAgICAgYWJDbGFzcyA9IHRoaXM7CiAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgIGV2ZW50OiAncmVxdWVzdCBldGggY29udHJhY3QnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLm9uY2UoInJlcXVlc3QgIi5jb25jYXQodXR4b0NvaW4sICIgc2NyaXB0IiksIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9mbG93JHN0YXRlMiA9IGZsb3cuc3RhdGUsCiAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXMgPSBfZmxvdyRzdGF0ZTIudXR4b1NjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgICAgIHR4SGFzaCA9IF9mbG93JHN0YXRlMi51dHhvU2NyaXB0Q3JlYXRpbmdUcmFuc2FjdGlvbkhhc2g7CiAgICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICBldmVudDogImNyZWF0ZSAiLmNvbmNhdCh1dHhvQ29pbiwgIiBzY3JpcHQiKSwKICAgICAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXM6IHNjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgICAgIHV0eG9TY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaDogdHhIYXNoCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcGFydGljaXBhbnQgPSBmbG93LnN3YXAucGFydGljaXBhbnQ7CiAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5vbignY3JlYXRlIGV0aCBjb250cmFjdCcsIGZ1bmN0aW9uIChfcmVmMTIpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaCA9IF9yZWYxMi5ldGhTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2g7CiAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgIGV0aFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDogZXRoU3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICAgICAgICAgIH0sIHRydWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBfY29udGV4dDMwLm5leHQgPSA4OwogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy5yZXBlYXRBc3luY1VudGlsUmVzdWx0KCAvKiNfX1BVUkVfXyovX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTI5KCkgewogICAgICAgICAgICAgICAgICB2YXIgYmFsYW5jZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMjkkKF9jb250ZXh0MjkpIHsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDI5LnByZXYgPSBfY29udGV4dDI5Lm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MjkubmV4dCA9IDI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZsb3cuZXRoU3dhcC5nZXRCYWxhbmNlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogYWJDbGFzcy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKGZsb3cuc3dhcCkKICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgICAgICAgICBiYWxhbmNlID0gX2NvbnRleHQyOS5zZW50OwoKICAgICAgICAgICAgICAgICAgICAgICAgICBfZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ0NoZWNraW5nIGNvbnRyYWN0IGJhbGFuY2U6JywgYmFsYW5jZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKGJhbGFuY2UgPiAwKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyOS5uZXh0ID0gNjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjkuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyOS5hYnJ1cHQoInJldHVybiIsIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyOS5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMjkpOwogICAgICAgICAgICAgICAgfSkpKTsKCiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgaXNDb250cmFjdEJhbGFuY2VPayA9IF9jb250ZXh0MzAuc2VudDsKCiAgICAgICAgICAgICAgICBpZiAoaXNDb250cmFjdEJhbGFuY2VPaykgewogICAgICAgICAgICAgICAgICBpc0V0aENvbnRyYWN0RnVuZGVkID0gZmxvdy5zdGF0ZS5pc0V0aENvbnRyYWN0RnVuZGVkOyAvLyBAVG9EbyAtINC90YPQttC90L4g0L/RgNC+0LLQtdGA0LjRgtGMINGB0YbQtdC90LDRgNC40LksINC10YHQu9C4INCx0YvQuyDQv9GA0LXRgNCy0LDQvSDRgdCy0LDQvwogICAgICAgICAgICAgICAgICAvLyDQnNGLINC+0YHRgtCw0LvQuNGB0Ywg0L3QsCDRjdGC0L7QvCDRiNCw0LPQtSwg0L3QviDQv9GA0Lgg0Y3RgtC+0LwgaXNFdGhDb250cmFjdEZ1bmRlZCA9IHRydWUKICAgICAgICAgICAgICAgICAgLy8g0JfQsNGB0YLRgNGP0L3QtdGCINC70Lgg0YHQstCw0L8g0L3QsCDRjdGC0L7QvCDRiNCw0LPQtSAoIzUpCiAgICAgICAgICAgICAgICAgIC8vINCY0LvQuCDQvdGD0LbQvdC+INC/0YDQuNC90YPQtNC40YLQtdC70YzQvdC+INC/0LXRgNC10LLQtdGB0YLQuCDQvdCwINGB0LvQtdC00YPRjtGJ0LjQuSDRiNCw0LMKCiAgICAgICAgICAgICAgICAgIGlmICghaXNFdGhDb250cmFjdEZ1bmRlZCkgewogICAgICAgICAgICAgICAgICAgIGZsb3cuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgICAgICBpc0V0aENvbnRyYWN0RnVuZGVkOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgICAgc3RlcDogJ3dhaXQtbG9jay1ldGgnCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzAuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTMwLCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gd2FpdEFCQ29udHJhY3QoX3gzNSkgewogICAgICAgIHJldHVybiBfd2FpdEFCQ29udHJhY3QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHdhaXRBQkNvbnRyYWN0OwogICAgfSgpCiAgfSwgewogICAga2V5OiAid2l0aGRyYXdGcm9tQUJDb250cmFjdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3dpdGhkcmF3RnJvbUFCQ29udHJhY3QgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMzIoX3JlZjE0KSB7CiAgICAgICAgdmFyIGZsb3csIGFiQ2xhc3MsIF9mbG93JHN3YXAyLCBidXlBbW91bnQsIHBhcnRpY2lwYW50LCBfZmxvdyRzdGF0ZTMsIHNlY3JldEhhc2gsIHNlY3JldCwgZGF0YSwgYmFsYW5jZUNoZWNrRXJyb3IsIHRhcmdldFdhbGxldCwgbmVlZFRhcmdldFdhbGxldCwgb25XaXRoZHJhd1JlYWR5LCB0cnlXaXRoZHJhdywgaXNFdGhXaXRoZHJhd247CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTMyJChfY29udGV4dDMyKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MzIucHJldiA9IF9jb250ZXh0MzIubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGZsb3cgPSBfcmVmMTQuZmxvdzsKICAgICAgICAgICAgICAgIGFiQ2xhc3MgPSB0aGlzOwogICAgICAgICAgICAgICAgX2Zsb3ckc3dhcDIgPSBmbG93LnN3YXAsIGJ1eUFtb3VudCA9IF9mbG93JHN3YXAyLmJ1eUFtb3VudCwgcGFydGljaXBhbnQgPSBfZmxvdyRzd2FwMi5wYXJ0aWNpcGFudDsKICAgICAgICAgICAgICAgIF9mbG93JHN0YXRlMyA9IGZsb3cuc3RhdGUsIHNlY3JldEhhc2ggPSBfZmxvdyRzdGF0ZTMuc2VjcmV0SGFzaCwgc2VjcmV0ID0gX2Zsb3ckc3RhdGUzLnNlY3JldDsKICAgICAgICAgICAgICAgIGRhdGEgPSB7CiAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogYWJDbGFzcy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKGZsb3cuc3dhcCksCiAgICAgICAgICAgICAgICAgIHNlY3JldDogc2VjcmV0CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgX2NvbnRleHQzMi5uZXh0ID0gNzsKICAgICAgICAgICAgICAgIHJldHVybiBhYkNsYXNzLmNoZWNrQmFsYW5jZSh7CiAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogYWJDbGFzcy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKGZsb3cuc3dhcCksCiAgICAgICAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogYWJDbGFzcy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCksCiAgICAgICAgICAgICAgICAgIGV4cGVjdGVkVmFsdWU6IGJ1eUFtb3VudCwKICAgICAgICAgICAgICAgICAgZXhwZWN0ZWRIYXNoOiBzZWNyZXRIYXNoCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgYmFsYW5jZUNoZWNrRXJyb3IgPSBfY29udGV4dDMyLnNlbnQ7CgogICAgICAgICAgICAgICAgaWYgKCFiYWxhbmNlQ2hlY2tFcnJvcikgewogICAgICAgICAgICAgICAgICBfY29udGV4dDMyLm5leHQgPSAxMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignV2FpdGluZyB1bnRpbCBkZXBvc2l0OiBFVEggYmFsYW5jZSBjaGVjayBlcnJvcjonLCBiYWxhbmNlQ2hlY2tFcnJvcik7CiAgICAgICAgICAgICAgICBmbG93LnN3YXAuZXZlbnRzLmRpc3BhdGNoKCdldGggYmFsYW5jZSBjaGVjayBlcnJvcicsIGJhbGFuY2VDaGVja0Vycm9yKTsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMyLmFicnVwdCgicmV0dXJuIik7CgogICAgICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgICAgICBpZiAoIWZsb3cuZXRoU3dhcC5oYXNUYXJnZXRXYWxsZXQoKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDMyLm5leHQgPSAyMTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgX2NvbnRleHQzMi5uZXh0ID0gMTU7CiAgICAgICAgICAgICAgICByZXR1cm4gYWJDbGFzcy5nZXRUYXJnZXRXYWxsZXQoYWJDbGFzcy5hcHAuZ2V0UGFydGljaXBhbnRFdGhBZGRyZXNzKGZsb3cuc3dhcCkpOwoKICAgICAgICAgICAgICBjYXNlIDE1OgogICAgICAgICAgICAgICAgdGFyZ2V0V2FsbGV0ID0gX2NvbnRleHQzMi5zZW50OwogICAgICAgICAgICAgICAgbmVlZFRhcmdldFdhbGxldCA9IGZsb3cuc3dhcC5kZXN0aW5hdGlvbkJ1eUFkZHJlc3MgPyBmbG93LnN3YXAuZGVzdGluYXRpb25CdXlBZGRyZXNzIDogYWJDbGFzcy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCk7CgogICAgICAgICAgICAgICAgaWYgKCEodGFyZ2V0V2FsbGV0LnRvTG93ZXJDYXNlKCkgIT09IG5lZWRUYXJnZXRXYWxsZXQudG9Mb3dlckNhc2UoKSkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQzMi5uZXh0ID0gMjE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Rlc3RpbmF0aW9uIGFkZHJlc3MgZm9yIGV0aGVyIGRpc21hdGNoIHdpdGggbmVlZGVkIChOZWVkZWQsIEdldHRlZCkuIFN0b3Agc3dhcCBub3chJywgbmVlZFRhcmdldFdhbGxldCwgdGFyZ2V0V2FsbGV0KTsKICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5ldmVudHMuZGlzcGF0Y2goJ2FkZHJlc3MgZm9yIGV0aGVyIGludmFsaWQnLCB7CiAgICAgICAgICAgICAgICAgIG5lZWRlZDogbmVlZFRhcmdldFdhbGxldCwKICAgICAgICAgICAgICAgICAgZ2V0dGVkOiB0YXJnZXRXYWxsZXQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzIuYWJydXB0KCJyZXR1cm4iKTsKCiAgICAgICAgICAgICAgY2FzZSAyMToKICAgICAgICAgICAgICAgIG9uV2l0aGRyYXdSZWFkeSA9IGZ1bmN0aW9uIG9uV2l0aGRyYXdSZWFkeSgpIHsKICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20ub25jZSgncmVxdWVzdCBldGhXaXRoZHJhd1R4SGFzaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoID0gZmxvdy5zdGF0ZS5ldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g7CiAgICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6ICdldGhXaXRoZHJhd1R4SGFzaCcsCiAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB2YXIgc3RlcCA9IGZsb3cuc3RhdGUuc3RlcDsKCiAgICAgICAgICAgICAgICAgIGlmIChzdGVwID49IDcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGZsb3cuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgICAgaXNFdGhXaXRoZHJhd246IHRydWUKICAgICAgICAgICAgICAgICAgfSwgJ3dpdGhkcmF3LWV0aCcpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB0cnlXaXRoZHJhdyA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfcmVmMTUgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMzEoc3RvcFJlcGVhdGVyKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlzRXRoV2l0aGRyYXduLCB3aXRoZHJhd0ZlZSwgd2l0aGRyYXdOZWVkZWRHYXMsIHJlcXVpcmVXaXRoZHJhd0ZlZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzMSQoX2NvbnRleHQzMSkgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDMxLnByZXYgPSBfY29udGV4dDMxLm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0V0aFdpdGhkcmF3biA9IGZsb3cuc3RhdGUuaXNFdGhXaXRoZHJhd247CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRXRoV2l0aGRyYXduKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MzEubmV4dCA9IDI3OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMxLnByZXYgPSAyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aGRyYXdGZWUgPSBmbG93LnN0YXRlLndpdGhkcmF3RmVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3aXRoZHJhd0ZlZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMxLm5leHQgPSAxMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzMS5uZXh0ID0gNzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhYkNsYXNzLmNhbGNXaXRoZHJhd0dhcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG93bmVyQWRkcmVzczogZGF0YS5vd25lckFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlY3JldDogc2VjcmV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aGRyYXdOZWVkZWRHYXMgPSBfY29udGV4dDMxLnNlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aGRyYXdGZWU6IHdpdGhkcmF3TmVlZGVkR2FzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ3dpdGhkcmF3IGdhcyBmZWUnLCB3aXRoZHJhd05lZWRlZEdhcyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMxLm5leHQgPSAxMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhYkNsYXNzLndpdGhkcmF3KGRhdGEsIGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzRXRoV2l0aGRyYXduOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogaGFzaCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYW5DcmVhdGVFdGhUcmFuc2FjdGlvbjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlV2l0aGRyYXdGZWU6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6ICdldGhXaXRoZHJhd1R4SGFzaCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBoYXNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFJlcGVhdGVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzMS5hYnJ1cHQoInJldHVybiIsIHRydWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzMS5wcmV2ID0gMTY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMxLnQwID0gX2NvbnRleHQzMVsiY2F0Y2giXSgyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIS9rbm93biB0cmFuc2FjdGlvbi8udGVzdChfY29udGV4dDMxLnQwLm1lc3NhZ2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0MzEubmV4dCA9IDI0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJrbm93biB0eDogIi5jb25jYXQoX2NvbnRleHQzMS50MC5tZXNzYWdlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wUmVwZWF0ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMxLmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoL291dCBvZiBnYXMvLnRlc3QoX2NvbnRleHQzMS50MC5tZXNzYWdlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJ0eCBmYWlsZWQgKHdyb25nIHNlY3JldD8pOiAiLmNvbmNhdChfY29udGV4dDMxLnQwLm1lc3NhZ2UpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoL2luc3VmZmljaWVudCBmdW5kcyBmb3IgZ2FzLy50ZXN0KF9jb250ZXh0MzEudDAubWVzc2FnZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiaW5zdWZmaWNpZW50IGZ1bmQgZm9yIGdhczogIi5jb25jYXQoX2NvbnRleHQzMS50MC5tZXNzYWdlKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ2luc3VmZmljaWVudCBmdW5kIGZvciBnYXMuLi4gd2FpdCBmdW5kIG9yIHJlcXVlc3Qgb3RoZXIgc2lkZSB0byB3aXRoZHJhdycpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZVdpdGhkcmF3RmVlID0gZmxvdy5zdGF0ZS5yZXF1aXJlV2l0aGRyYXdGZWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlcXVpcmVXaXRoZHJhd0ZlZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLm9uY2UoJ3dpdGhkcmF3IHJlYWR5JywgZnVuY3Rpb24gKF9yZWYxNikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV0aFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCA9IF9yZWYxNi5ldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25XaXRoZHJhd1JlYWR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlV2l0aGRyYXdGZWU6IHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihfY29udGV4dDMxLnQwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyNToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYW5DcmVhdGVFdGhUcmFuc2FjdGlvbjogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MzEuYWJydXB0KCJyZXR1cm4iLCBudWxsKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAyNzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMxLmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjg6CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMxLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUzMSwgbnVsbCwgW1syLCAxNl1dKTsKICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHRyeVdpdGhkcmF3KF94MzcpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3JlZjE1LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KCk7CgogICAgICAgICAgICAgICAgX2NvbnRleHQzMi5uZXh0ID0gMjU7CiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5oZWxwZXJzLnJlcGVhdEFzeW5jVW50aWxSZXN1bHQoZnVuY3Rpb24gKHN0b3BSZXBlYXRlcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ5V2l0aGRyYXcoc3RvcFJlcGVhdGVyKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDI1OgogICAgICAgICAgICAgICAgaXNFdGhXaXRoZHJhd24gPSBfY29udGV4dDMyLnNlbnQ7CgogICAgICAgICAgICAgICAgaWYgKGlzRXRoV2l0aGRyYXduKSB7CiAgICAgICAgICAgICAgICAgIG9uV2l0aGRyYXdSZWFkeSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjYXNlIDI3OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzMi5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMzIsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiB3aXRoZHJhd0Zyb21BQkNvbnRyYWN0KF94MzYpIHsKICAgICAgICByZXR1cm4gX3dpdGhkcmF3RnJvbUFCQ29udHJhY3QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHdpdGhkcmF3RnJvbUFCQ29udHJhY3Q7CiAgICB9KCkKICB9XSk7CgogIHJldHVybiBFdGhTd2FwOwp9KFN3YXBJbnRlcmZhY2UpOwoKZXhwb3J0IGRlZmF1bHQgRXRoU3dhcDs="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.swaps/EthSwap.ts"],"names":["_debug","constants","SwapInterface","util","BigNumber","InputDataDecoder","debug","EthSwap","options","transactionHash","app","env","getWeb3","eth","getTransaction","then","txResult","bytes32","decoder","decodeData","input","utils","bytesToHex","inputs","split","err","message","fetchBalance","Error","address","Array","isArray","abi","estimateGasPrice","console","warn","_swapName","COINS","gasLimit","gasPrice","sendTransaction","web3","contract","Contract","updateGasPrice","speed","data","handleTransactionHash","targetWallet","participantAddress","hasTargetWallet","createSwapTarget","createSwap","methodName","args","_params","methods","Promise","resolve","reject","params","from","getMyEthAddress","gas","estimateGas","gasAmount","send","on","hash","receipt","secretHash","amount","amountWei","toWei","toString","replace","value","values","ownerAddress","getBalance","call","swaps","swap","balance","parseInt","expectedValue","expectedHash","helpers","repeatAsyncUntilResult","_secretHash","expectedValueWei","multipliedBy","isGreaterThan","_allSwapEvents","getPastEvents","fromBlock","toBlock","allSwapEvents","events","allEvents","event","push","error","fetchSwapEvents","swapEvents","filter","returnValues","create","close","rest","length","findSwap","wasClosed","status","getTargetWallet","log","getTargetWalletPromise","calcWithdrawOtherGas","secret","withdrawOther","_secret","gasFee","getSecret","test","flow","abClass","participant","buyAmount","sellAmount","waitConfirm","state","swapData","getParticipantEthAddress","destinationSellAddress","tryCreateSwap","isEthContractFunded","_checkSwapAlreadyExists","swapExists","ethSwap","refund","refundTx","room","sendMessage","ethSwapCreationTransactionHash","setState","canCreateEthTransaction","isFailedTransaction","isFailedTransactionError","isStoppedSwap","finishStep","step","once","ethSwapWithdrawTransactionHash","extractSecretFromTx","swapFlow","secretFromTxhash","isEthWithdrawn","checkSecretExist","extractSecretFromContract","stopRepeat","isRefunded","secretFromContract","utxoCoin","scriptValues","utxoScriptValues","txHash","utxoScriptCreatingTransactionHash","isContractBalanceOk","checkBalance","balanceCheckError","dispatch","needTargetWallet","destinationBuyAddress","toLowerCase","needed","getted","onWithdrawReady","tryWithdraw","stopRepeater","withdrawFee","calcWithdrawGas","withdrawNeededGas","withdraw","requireWithdrawFee"],"mappings":"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","sourcesContent":["// @ts-nocheck\r\nimport _debug from 'debug'\r\nimport SwapApp, { constants, SwapInterface, util } from 'swap.app'\r\nimport BigNumber from 'bignumber.js'\r\nimport InputDataDecoder from 'ethereum-input-data-decoder'\r\nconst debug = _debug('swap.core:swaps')\r\n\r\nclass EthSwap extends SwapInterface {\r\n\r\n  address: string\r\n  abi: any[]\r\n  _swapName: string\r\n  gasLimit: number\r\n  gasPrice: number\r\n  fetchBalance: Function\r\n  estimateGasPrice: Function\r\n  sendTransaction: Function\r\n\r\n  app: any\r\n  decoder: any\r\n  contract: any\r\n  _allSwapEvents: any\r\n\r\n  /**\r\n   *\r\n   * @param {object}    options\r\n   * @param {string}    options.address\r\n   * @param {array}     options.abi\r\n   * @param {number}    options.gasLimit\r\n   * @param {function}  options.fetchBalance\r\n   */\r\n  constructor(options) {\r\n    super()\r\n\r\n    if (typeof options.fetchBalance !== 'function') {\r\n      throw new Error('EthSwap: \"fetchBalance\" required')\r\n    }\r\n    if (typeof options.address !== 'string') {\r\n      throw new Error('EthSwap: \"address\" required')\r\n    }\r\n    if (!Array.isArray(options.abi)) {\r\n      throw new Error('EthSwap: \"abi\" required')\r\n    }\r\n    if (typeof options.estimateGasPrice !== 'function') {\r\n      // ({ speed } = {}) => gasPrice\r\n      console.warn(`EthTokenSwap: \"estimateGasPrice\" is not a function. You will not be able use automatic mempool-based fee`)\r\n    }\r\n\r\n    this.address        = options.address\r\n    this.abi            = options.abi\r\n\r\n    this._swapName      = constants.COINS.eth\r\n    this.gasLimit       = options.gasLimit || 3e5\r\n    this.gasPrice       = options.gasPrice || 2e9\r\n    this.fetchBalance   = options.fetchBalance\r\n    this.estimateGasPrice = options.estimateGasPrice || (() => {})\r\n    this.sendTransaction = options.sendTransaction\r\n  }\r\n\r\n  _initSwap(app) {\r\n    super._initSwap(app)\r\n\r\n    this.app = app\r\n\r\n    this.decoder  = new InputDataDecoder(this.abi)\r\n\r\n    const web3 = this.app.env.getWeb3()\r\n\r\n    this.contract = new web3.eth.Contract(this.abi, this.address)\r\n  }\r\n\r\n  /**\r\n   * @deprecated\r\n   */\r\n  updateGas() {\r\n    console.warn(`EthSwap.updateGas() is deprecated and will be removed. Use .updateGasPrice()`)\r\n    //@\r\n    return updateGasPrice()\r\n  }\r\n\r\n  async updateGasPrice() {\r\n    debug('gas price before update', this.gasPrice)\r\n\r\n    try {\r\n      this.gasPrice = await this.estimateGasPrice({ speed: 'fast' })\r\n    } catch(err) {\r\n      debug(`EthSwap: Error with gas update: ${err.message}, using old value gasPrice=${this.gasPrice}`)\r\n    }\r\n\r\n    debug('gas price after update', this.gasPrice)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @param {string} data.participantAddress\r\n   * @param {string} data.targetWallet\r\n   * @param {number} data.amount\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async create(data, handleTransactionHash) {\r\n    if (data.targetWallet && (data.targetWallet!==data.participantAddress) && this.hasTargetWallet()) {\r\n      return this.createSwapTarget(data, handleTransactionHash)\r\n    } else {\r\n      return this.createSwap(data, handleTransactionHash)\r\n    }\r\n  }\r\n\r\n  async send(methodName, args, _params = {}, handleTransactionHash) {\r\n    if (typeof this.contract.methods[methodName] !== 'function') {\r\n      throw new Error(`EthSwap.send: No method ${methodName} in contract`)\r\n    }\r\n\r\n    await this.updateGasPrice()\r\n\r\n    return new Promise(async (resolve, reject) => {\r\n      const params = {\r\n        from: this.app.getMyEthAddress(),\r\n        gas: this.gasLimit,\r\n        gasPrice: this.gasPrice,\r\n        ..._params,\r\n      }\r\n\r\n      debug(`EthSwap -> ${methodName} -> params`, params)\r\n\r\n      const gasAmount = await this.contract.methods[methodName](...args).estimateGas(params)\r\n\r\n      params.gas = gasAmount\r\n\r\n      debug(`EthSwap -> ${methodName} -> gas`, gasAmount)\r\n\r\n      const receipt = await this.contract.methods[methodName](...args).send(params)\r\n        .on('transactionHash', (hash) => {\r\n          if (typeof handleTransactionHash === 'function') {\r\n            handleTransactionHash(hash)\r\n          }\r\n        })\r\n        .on('error', (err) => {\r\n          reject(err)\r\n        })\r\n\r\n      resolve(receipt)\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @param {string} data.participantAddress\r\n   * @param {string} data.targetWallet\r\n   * @param {number} data.amount\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async createSwap(data, handleTransactionHash) {\r\n    const { secretHash, participantAddress, amount } = data\r\n    const web3 = this.app.env.getWeb3()\r\n\r\n    const amountWei = web3.utils.toWei(amount.toString())\r\n\r\n    const hash = `0x${secretHash.replace(/^0x/, '')}`\r\n    const args = [ hash, participantAddress ]\r\n\r\n    return this.send('createSwap', [...args], { value: amountWei }, handleTransactionHash)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @param {string} data.participantAddress\r\n   * @param {string} data.targetWallet\r\n   * @param {number} data.amount\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async createSwapTarget(data, handleTransactionHash) {\r\n    const { secretHash, participantAddress, amount, targetWallet } = data\r\n\r\n    const web3 = this.app.env.getWeb3()\r\n\r\n    await this.updateGasPrice()\r\n\r\n    const amountWei = web3.utils.toWei(amount.toString())\r\n\r\n    const hash = `0x${secretHash.replace(/^0x/, '')}`\r\n\r\n    const values = [ hash, participantAddress, targetWallet ]\r\n\r\n    return this.send('createSwapTarget', [...values], { value: amountWei }, handleTransactionHash)\r\n  }\r\n  \r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.ownerAddress\r\n   * @returns {Promise}\r\n   */\r\n  getBalance(data) {\r\n    const { ownerAddress } = data\r\n\r\n    return this.contract.methods.getBalance(ownerAddress).call({\r\n      from: this.app.getMyEthAddress(),\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.ownerAddress\r\n   * @param {string} data.participantAddress\r\n   * @returns {Promise}\r\n   */\r\n  swaps(data) {\r\n    const { ownerAddress, participantAddress } = data\r\n\r\n    return this.contract.methods.swaps(ownerAddress, participantAddress).call()\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.ownerAddress\r\n   * @param {string} data.participantAddress\r\n   * @returns {Promise}\r\n   */\r\n  async checkSwapExists(data) {\r\n    const swap = await this.swaps(data)\r\n\r\n    debug('swapExists', swap)\r\n\r\n    const balance = swap && swap.balance ? parseInt(swap.balance) : 0\r\n\r\n    return balance > 0\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.ownerAddress\r\n   * @param {BigNumber} data.expectedValue\r\n   * @returns {Promise.<string>}\r\n   */\r\n  async checkBalance(data) {\r\n    const { ownerAddress, participantAddress, expectedValue, expectedHash } = data\r\n\r\n    const balance = await util.helpers.repeatAsyncUntilResult(() =>\r\n      this.getBalance({ ownerAddress })\r\n    )\r\n    const swap = await util.helpers.repeatAsyncUntilResult(() =>\r\n      this.contract.methods.swaps(ownerAddress, participantAddress).call()\r\n    )\r\n    //@\r\n    const { secretHash } = swap\r\n    debug(`swap.secretHash`, secretHash)\r\n\r\n    const _secretHash = `${secretHash.replace(/^0x/, '')}`\r\n\r\n    debug(`secretHash: expected hash = ${expectedHash}, contract hash = ${_secretHash}`)\r\n\r\n    if (expectedHash !== _secretHash) {\r\n      return `Expected hash: ${expectedHash}, got: ${_secretHash}`\r\n    }\r\n\r\n    const expectedValueWei = new BigNumber(expectedValue).multipliedBy(1e18)\r\n    //@\r\n    if (expectedValueWei.isGreaterThan(balance)) {\r\n      return `Expected value: ${expectedValueWei.toString()}, got: ${balance}`\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @returns {Promise}\r\n   */\r\n  async fetchSwapEvents() {\r\n    if (this._allSwapEvents) return this._allSwapEvents\r\n\r\n    const allSwapEvents = await this.contract.getPastEvents('allEvents', {\r\n      fromBlock: 0,\r\n      toBlock: 'latest',\r\n    })\r\n\r\n    this.contract.events.allEvents({ fromBlock: 0, toBlock: 'latest' })\r\n      .on('data', event => {\r\n        this._allSwapEvents.push(event)\r\n      })\r\n      .on('changed', (event) => {\r\n        console.error(`EthSwap: fetchEvents: needs rescan`)\r\n        this._allSwapEvents = null\r\n      })\r\n      .on('error', err => {\r\n        console.error(err)\r\n        this._allSwapEvents = null\r\n      })\r\n\r\n    this._allSwapEvents = allSwapEvents\r\n\r\n    return allSwapEvents\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @returns {Promise}\r\n   */\r\n  async findSwap(data) {\r\n    const { secretHash } = data\r\n\r\n    const allSwapEvents = await this.fetchSwapEvents()\r\n\r\n    const swapEvents = allSwapEvents\r\n      .filter(({ returnValues }) => returnValues._secretHash === `0x${secretHash.replace('0x','')}`)\r\n\r\n    const [ create, close, ...rest ] = swapEvents\r\n\r\n    if (rest && rest.length) {\r\n      console.error(`More than two swaps with same hash`, rest)\r\n      // throw new Error(`More than two swaps with same hash`)\r\n    }\r\n\r\n    return [ create, close ]\r\n  }\r\n\r\n  /**\r\n    *\r\n    * @param {object} data\r\n    * @param {string} data.secretHash\r\n    * @returns {Promise(status)}\r\n    */\r\n\r\n  async wasClosed(data) {\r\n    const [ create, close ] = await this.findSwap(data)\r\n\r\n    if (!create) {\r\n      debug(`No swap with hash ${data.secretHash}`)\r\n      return 'no swap'\r\n    } else if (create && !close) {\r\n      debug(`Open yet!`)\r\n      return 'open'\r\n    } else {\r\n      if (close.event == 'Withdraw') {\r\n        debug(`Withdrawn`)\r\n        return 'withdrawn'\r\n      } else if (close.event == 'Refund') {\r\n        debug(`Refund`)\r\n        return 'refunded'\r\n      } else {\r\n        debug(`Unknown event, error`)\r\n        return 'error'\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @returns {Promise(boolean)}\r\n   */\r\n  wasRefunded(data) {\r\n    return this.wasClosed(data)\r\n      .then((status) =>\r\n        status === 'refunded'\r\n      )\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secretHash\r\n   * @returns {Promise(boolean)}\r\n   */\r\n  async wasWithdrawn(data) {\r\n    const status = await this.wasClosed(data)\r\n    return status === 'withdrawn'\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @returns {boolean}\r\n   */\r\n  hasTargetWallet() {\r\n    return !!this.contract.methods.getTargetWallet\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {string} ownerAddress\r\n   * @returns {Promise.<string>}\r\n   */\r\n  async getTargetWallet(ownerAddress: string): Promise<string> {\r\n    console.log('EthSwap->getTargetWallet');\r\n    let address: any = await util.helpers.repeatAsyncUntilResult(() =>\r\n      this.getTargetWalletPromise(ownerAddress)\r\n    )\r\n    return address\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {string} ownerAddress\r\n   * @param {number} repeatCount\r\n   * @returns {string}\r\n   */\r\n  async getTargetWalletPromise(ownerAddress: string): Promise<string> {\r\n    return new Promise(async (resolve, reject) => {\r\n      try {\r\n        const targetWallet = await this.contract.methods.getTargetWallet(ownerAddress).call({\r\n          from: this.app.getMyEthAddress(),\r\n        })\r\n\r\n        resolve(targetWallet)\r\n      }\r\n      catch (err) {\r\n        reject(err)\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secret\r\n   * @param {string} data.ownerAddress\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async calcWithdrawGas(data) {\r\n    return this.calcWithdrawOtherGas({\r\n      ownerAddress: data.ownerAddress,\r\n      participantAddress: this.app.getMyEthAddress(),\r\n      secret: data.secret,\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secret\r\n   * @param {string} data.ownerAddress\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async withdraw(data, handleTransactionHash) {\r\n    return this.withdrawOther({\r\n      ownerAddress: data.ownerAddress,\r\n      participantAddress: this.app.getMyEthAddress(),\r\n      secret: data.secret,\r\n    }, handleTransactionHash)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secret\r\n   * @param {string} data.participantAddress\r\n   * @returns {Promise}\r\n   */\r\n  async calcWithdrawNoMoneyGas(data) {\r\n    return this.calcWithdrawOtherGas({\r\n      ownerAddress: this.app.getMyEthAddress(),\r\n      participantAddress: data.participantAddress,\r\n      secret: data.secret,\r\n    })\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secret\r\n   * @param {string} data.participantAddress\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async withdrawNoMoney(data, handleTransactionHash) {\r\n    return this.withdrawOther({\r\n      ownerAddress: this.app.getMyEthAddress(),\r\n      participantAddress: data.participantAddress,\r\n      secret: data.secret,\r\n    }, handleTransactionHash)\r\n  }\r\n\r\n  async calcWithdrawOtherGas(data) {\r\n    const { ownerAddress, participantAddress, secret } = data\r\n\r\n    await this.updateGasPrice()\r\n\r\n    return new Promise(async (resolve, reject) => {\r\n      const _secret = `0x${secret.replace(/^0x/, '')}`\r\n\r\n      const params = {\r\n        from: this.app.getMyEthAddress(),\r\n        gas: this.gasLimit,\r\n        gasPrice: this.gasPrice,\r\n      }\r\n\r\n      try {\r\n        const gasFee = await this.contract.methods.withdrawOther(_secret, ownerAddress, participantAddress).estimateGas(params);\r\n        resolve(gasFee)\r\n      }\r\n      catch (err) {\r\n        reject(err)\r\n      }\r\n    })\r\n  }\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.secret\r\n   * @param {string} data.ownerAddress\r\n   * @param {string} data.participantAddress\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async withdrawOther(data, handleTransactionHash) {\r\n    const { ownerAddress, participantAddress, secret } = data\r\n\r\n    const _secret = `0x${secret.replace(/^0x/, '')}`\r\n\r\n    await this.updateGasPrice()\r\n\r\n    return this.send('withdrawOther', [ _secret, ownerAddress, participantAddress ], {}, handleTransactionHash)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.participantAddress\r\n   * @param {function} handleTransactionHash\r\n   * @returns {Promise}\r\n   */\r\n  async refund(data, handleTransactionHash: Function = null) {\r\n    const { participantAddress } = data\r\n\r\n    await this.updateGasPrice()\r\n\r\n    return this.send('refund', [ participantAddress ], {}, handleTransactionHash)\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param {object} data\r\n   * @param {string} data.participantAddress\r\n   * @returns {Promise}\r\n   */\r\n  getSecret(data) {\r\n    const { participantAddress } = data\r\n\r\n    return this.contract.methods.getSecret(participantAddress).call({\r\n      from: this.app.getMyEthAddress(),\r\n    })\r\n      .then((secret) => {\r\n        debug('secret ethswap.js', secret)\r\n        return secret && !/^0x0+$/.test(secret) ? secret : null\r\n      })\r\n      .catch((error) => error)\r\n  }\r\n\r\n/*\r\n  Function: withdraw(bytes32 _secret, address _ownerAddress)\r\n  bytes32 {...}\r\n  inputs: (2) […]\r\n    0: Uint8Array(32) [ 208, 202, 170, … ]\r\n    1: \"e918c8719bae0525786548b8da7fbef9b33d4e25\"\r\n  name: \"withdraw\"\r\n  types: (2) […]\r\n    0: \"bytes32\"\r\n    1: \"address\"\r\n*/\r\n\r\n  /**\r\n   *\r\n   * @param {string} transactionHash\r\n   * @returns {Promise<any>}\r\n   */\r\n  getSecretFromTxhash = (transactionHash) =>\r\n    this.app.env.getWeb3().eth.getTransaction(transactionHash)\r\n      .then(txResult => {\r\n        try {\r\n          const bytes32 = this.decoder.decodeData(txResult.input)\r\n          return this.app.env.getWeb3().utils.bytesToHex(bytes32.inputs[0]).split('0x')[1]\r\n        } catch (err) {\r\n          debug('Trying to fetch secret from tx: ' + err.message)\r\n          return\r\n        }\r\n      })\r\n\r\n  async fundContract({\r\n    flow,\r\n  }: {\r\n    flow: any,\r\n  }) {\r\n    const abClass = this\r\n    const {\r\n      participant,\r\n      buyAmount,\r\n      sellAmount,\r\n      waitConfirm,\r\n    } = flow.swap\r\n\r\n    const { secretHash } = flow.state\r\n\r\n    const swapData = {\r\n      participantAddress: abClass.app.getParticipantEthAddress(flow.swap),\r\n      secretHash: secretHash,\r\n      amount: sellAmount,\r\n      targetWallet: flow.swap.destinationSellAddress\r\n    }\r\n\r\n    const tryCreateSwap = async () => {\r\n      const { isEthContractFunded } = flow.state\r\n\r\n      if (!isEthContractFunded) {\r\n        try {\r\n          _debug('swap.core:flow')('check swap exists')\r\n          const swapExists = await flow._checkSwapAlreadyExists()\r\n          if (swapExists) {\r\n            console.warn('Swap exists!! May be stucked. Try refund')\r\n            await flow.ethSwap.refund({\r\n              participantAddress: abClass.app.getParticipantEthAddress(flow.swap),\r\n            }, (refundTx) => {\r\n              _debug('swap.core:flow')('Stucked swap refunded', refundTx)\r\n            })\r\n          }\r\n          _debug('swap.core:flow')('create swap', swapData)\r\n          await abClass.create(swapData, (hash) => {\r\n            _debug('swap.core:flow')('create swap tx hash', hash)\r\n            flow.swap.room.sendMessage({\r\n              event: 'create eth contract',\r\n              data: {\r\n                ethSwapCreationTransactionHash: hash,\r\n              },\r\n            })\r\n\r\n            flow.setState({\r\n              ethSwapCreationTransactionHash: hash,\r\n              canCreateEthTransaction: true,\r\n              isFailedTransaction: false,\r\n            }, true)\r\n          })\r\n        } catch (err) {\r\n          if (flow.state.ethSwapCreationTransactionHash) {\r\n            console.error('fail create swap, but tx already exists')\r\n            flow.setState({\r\n              canCreateEthTransaction: true,\r\n              isFailedTransaction: false,\r\n            }, true)\r\n            return true\r\n          }\r\n          if ( /known transaction/.test(err.message) ) {\r\n            console.error(`known tx: ${err.message}`)\r\n          } else if ( /out of gas/.test(err.message) ) {\r\n            console.error(`tx failed (wrong secret?): ${err.message}`)\r\n          } else {\r\n            console.error(err)\r\n          }\r\n\r\n          flow.setState({\r\n            canCreateEthTransaction: false,\r\n            isFailedTransaction: true,\r\n            isFailedTransactionError: err.message,\r\n          }, true)\r\n\r\n          return null\r\n        }\r\n      }\r\n      return true\r\n    }\r\n\r\n    const isEthContractFunded = await util.helpers.repeatAsyncUntilResult(() =>\r\n      tryCreateSwap(),\r\n    )\r\n\r\n    const { isStoppedSwap } = flow.state\r\n\r\n    if (isEthContractFunded && !isStoppedSwap) {\r\n      _debug('swap.core:flow')(`finish step`)\r\n      flow.finishStep({\r\n        isEthContractFunded,\r\n      }, {step: 'lock-eth'})\r\n    }\r\n  }\r\n\r\n\r\n  async getSecretFromAB2UTXO({\r\n    flow,\r\n  }: {\r\n    flow: any,\r\n  }) {\r\n    const abClass = this\r\n\r\n    flow.swap.room.once('ethWithdrawTxHash', async ({ethSwapWithdrawTransactionHash}) => {\r\n      flow.setState({\r\n        ethSwapWithdrawTransactionHash,\r\n      }, true)\r\n\r\n      const secretFromTxhash = await util.helpers.extractSecretFromTx({\r\n        flow,\r\n        swapFlow: abClass,\r\n        app: abClass.app,\r\n        ethSwapWithdrawTransactionHash,\r\n      })\r\n\r\n      const { isEthWithdrawn } = flow.state\r\n\r\n      if (!isEthWithdrawn && secretFromTxhash) {\r\n        _debug('swap.core:flow')('got secret from tx', ethSwapWithdrawTransactionHash, secretFromTxhash)\r\n        flow.finishStep({\r\n          isEthWithdrawn: true,\r\n          secret: secretFromTxhash,\r\n        }, {step: 'wait-withdraw-eth'})\r\n      }\r\n    })\r\n\r\n    flow.swap.room.sendMessage({\r\n      event: 'request ethWithdrawTxHash',\r\n    })\r\n\r\n    const { participant } = flow.swap\r\n\r\n    const checkSecretExist = async () => {\r\n      return await util.helpers.extractSecretFromContract({\r\n        flow,\r\n        swapFlow: abClass,\r\n        participantAddress: abClass.app.getParticipantEthAddress(flow.swap),\r\n        ownerAddress: flow.app.getMyEthAddress(),\r\n        app: abClass.app,\r\n      })\r\n    }\r\n\r\n    const secretFromContract = await util.helpers.repeatAsyncUntilResult((stopRepeat) => {\r\n      const { isEthWithdrawn, isRefunded } = flow.state\r\n\r\n      if (isEthWithdrawn || isRefunded) {\r\n        stopRepeat()\r\n\r\n        return false\r\n      }\r\n\r\n      return checkSecretExist()\r\n    })\r\n\r\n    const { isEthWithdrawn } = flow.state\r\n\r\n    if (secretFromContract && !isEthWithdrawn) {\r\n      _debug('swap.core:flow')('got secret from smart contract', secretFromContract)\r\n\r\n      flow.finishStep({\r\n        isEthWithdrawn: true,\r\n        secret: secretFromContract,\r\n      }, { step: 'wait-withdraw-eth' })\r\n    }\r\n  }\r\n\r\n  async waitABContract({\r\n    flow,\r\n    utxoCoin,\r\n  }: {\r\n    flow: any,\r\n    utxoCoin: string,\r\n  }) {\r\n    const abClass = this\r\n\r\n    flow.swap.room.sendMessage({\r\n      event: 'request eth contract',\r\n    })\r\n\r\n    flow.swap.room.once(`request ${utxoCoin} script`, () => {\r\n      const {\r\n        utxoScriptValues: scriptValues,\r\n        utxoScriptCreatingTransactionHash: txHash,\r\n      } = flow.state\r\n\r\n      flow.swap.room.sendMessage({\r\n        event:  `create ${utxoCoin} script`,\r\n        data: {\r\n          scriptValues,\r\n          utxoScriptCreatingTransactionHash: txHash,\r\n        }\r\n      })\r\n    })\r\n\r\n    const { participant } = flow.swap\r\n\r\n    flow.swap.room.on('create eth contract', ({ ethSwapCreationTransactionHash }) => {\r\n      flow.setState({\r\n        ethSwapCreationTransactionHash,\r\n      }, true)\r\n    })\r\n\r\n    const isContractBalanceOk = await util.helpers.repeatAsyncUntilResult(async () => {\r\n      const balance = await flow.ethSwap.getBalance({\r\n        ownerAddress: abClass.app.getParticipantEthAddress(flow.swap),\r\n      })\r\n\r\n      _debug('swap.core:flow')('Checking contract balance:', balance)\r\n\r\n      if (balance > 0) {\r\n        return true\r\n      }\r\n\r\n      return false\r\n    })\r\n\r\n    if (isContractBalanceOk) {\r\n      const { isEthContractFunded } = flow.state\r\n\r\n      // @ToDo - нужно проверить сценарий, если был прерван свап\r\n      // Мы остались на этом шаге, но при этом isEthContractFunded = true\r\n      // Застрянет ли свап на этом шаге (#5)\r\n      // Или нужно принудительно перевести на следующий шаг\r\n      if (!isEthContractFunded) {\r\n        flow.finishStep({\r\n          isEthContractFunded: true,\r\n        }, { step: 'wait-lock-eth' })\r\n      }\r\n    }\r\n  }\r\n\r\n  async withdrawFromABContract({\r\n    flow,\r\n  }: {\r\n    flow: any,\r\n  }) {\r\n    const abClass = this\r\n    const { buyAmount, participant } = flow.swap\r\n    const { secretHash, secret } = flow.state\r\n\r\n    const data = {\r\n      ownerAddress: abClass.app.getParticipantEthAddress(flow.swap),\r\n      secret,\r\n    }\r\n\r\n    const balanceCheckError = await abClass.checkBalance({\r\n      ownerAddress: abClass.app.getParticipantEthAddress(flow.swap),\r\n      participantAddress: abClass.app.getMyEthAddress(),\r\n      expectedValue: buyAmount,\r\n      expectedHash: secretHash,\r\n    })\r\n\r\n    if (balanceCheckError) {\r\n      console.error('Waiting until deposit: ETH balance check error:', balanceCheckError)\r\n      flow.swap.events.dispatch('eth balance check error', balanceCheckError)\r\n\r\n      return\r\n    }\r\n\r\n    if (flow.ethSwap.hasTargetWallet()) {\r\n      const targetWallet = await abClass.getTargetWallet(\r\n        abClass.app.getParticipantEthAddress(flow.swap)\r\n      )\r\n      const needTargetWallet = (flow.swap.destinationBuyAddress)\r\n        ? flow.swap.destinationBuyAddress\r\n        : abClass.app.getMyEthAddress()\r\n\r\n      if (targetWallet.toLowerCase() !== needTargetWallet.toLowerCase()) {\r\n        console.error(\r\n          'Destination address for ether dismatch with needed (Needed, Getted). Stop swap now!',\r\n          needTargetWallet,\r\n          targetWallet,\r\n        )\r\n        flow.swap.events.dispatch('address for ether invalid', {\r\n          needed: needTargetWallet,\r\n          getted: targetWallet,\r\n        })\r\n\r\n        return\r\n      }\r\n    }\r\n\r\n    const onWithdrawReady = () => {\r\n      flow.swap.room.once('request ethWithdrawTxHash', () => {\r\n        const { ethSwapWithdrawTransactionHash } = flow.state\r\n\r\n        flow.swap.room.sendMessage({\r\n          event: 'ethWithdrawTxHash',\r\n          data: {\r\n            ethSwapWithdrawTransactionHash,\r\n          },\r\n        })\r\n      })\r\n\r\n      const { step } = flow.state\r\n\r\n      if (step >= 7) {\r\n        return\r\n      }\r\n\r\n      flow.finishStep({\r\n        isEthWithdrawn: true,\r\n      }, 'withdraw-eth')\r\n    }\r\n\r\n    const tryWithdraw = async (stopRepeater) => {\r\n      const { isEthWithdrawn } = flow.state\r\n\r\n      if (!isEthWithdrawn) {\r\n        try {\r\n          const { withdrawFee } = flow.state\r\n\r\n          if (!withdrawFee) {\r\n            const withdrawNeededGas = await abClass.calcWithdrawGas({\r\n              ownerAddress: data.ownerAddress,\r\n              secret,\r\n            })\r\n            flow.setState({\r\n              withdrawFee: withdrawNeededGas,\r\n            })\r\n            _debug('swap.core:flow')('withdraw gas fee', withdrawNeededGas)\r\n          }\r\n\r\n          await abClass.withdraw(data, (hash) => {\r\n            flow.setState({\r\n              isEthWithdrawn: true,\r\n              ethSwapWithdrawTransactionHash: hash,\r\n              canCreateEthTransaction: true,\r\n              requireWithdrawFee: false,\r\n            }, true)\r\n\r\n            flow.swap.room.sendMessage({\r\n              event: 'ethWithdrawTxHash',\r\n              data: {\r\n                ethSwapWithdrawTransactionHash: hash,\r\n              }\r\n            })\r\n          })\r\n\r\n          stopRepeater()\r\n          return true\r\n        } catch (err) {\r\n          if ( /known transaction/.test(err.message) ) {\r\n            console.error(`known tx: ${err.message}`)\r\n            stopRepeater()\r\n            return true\r\n          } else if ( /out of gas/.test(err.message) ) {\r\n            console.error(`tx failed (wrong secret?): ${err.message}`)\r\n          } else if ( /insufficient funds for gas/.test(err.message) ) {\r\n            console.error(`insufficient fund for gas: ${err.message}`)\r\n\r\n            _debug('swap.core:flow')('insufficient fund for gas... wait fund or request other side to withdraw')\r\n\r\n            const { requireWithdrawFee } = flow.state\r\n\r\n            if (!requireWithdrawFee) {\r\n              flow.swap.room.once('withdraw ready', ({ethSwapWithdrawTransactionHash}) => {\r\n                flow.setState({\r\n                  ethSwapWithdrawTransactionHash,\r\n                })\r\n\r\n                onWithdrawReady()\r\n              })\r\n\r\n              flow.setState({\r\n                requireWithdrawFee: true,\r\n              })\r\n            }\r\n\r\n          } else {\r\n            console.error(err)\r\n          }\r\n\r\n          flow.setState({\r\n            canCreateEthTransaction: false,\r\n          })\r\n\r\n          return null\r\n        }\r\n      }\r\n\r\n      return true\r\n    }\r\n\r\n    const isEthWithdrawn = await util.helpers.repeatAsyncUntilResult((stopRepeater) =>\r\n      tryWithdraw(stopRepeater),\r\n    )\r\n\r\n    if (isEthWithdrawn) {\r\n      onWithdrawReady()\r\n    }\r\n  }\r\n}\r\n\r\n\r\nexport default EthSwap\r\n"]}]}