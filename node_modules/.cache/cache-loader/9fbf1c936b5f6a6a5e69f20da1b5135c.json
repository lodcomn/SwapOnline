{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\GHOST2BTC.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\GHOST2BTC.ts","mtime":1614842913758},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXN5bmNUb0dlbmVyYXRvciI7CmltcG9ydCBfY2xhc3NDYWxsQ2hlY2sgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jcmVhdGVDbGFzcyI7CmltcG9ydCBfYXNzZXJ0VGhpc0luaXRpYWxpemVkIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXNzZXJ0VGhpc0luaXRpYWxpemVkIjsKaW1wb3J0IF9pbmhlcml0cyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjsKaW1wb3J0IF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiI7CmltcG9ydCBfZ2V0IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0IjsKaW1wb3J0IF9nZXRQcm90b3R5cGVPZiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldFByb3RvdHlwZU9mIjsKaW1wb3J0IF9kZWZpbmVQcm9wZXJ0eSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2RlZmluZVByb3BlcnR5IjsKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgppbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnOwppbXBvcnQgY3J5cHRvIGZyb20gJ2JpdGNvaW5qcy1saWIvc3JjL2NyeXB0byc7IC8vIG1vdmUgdG8gQnRjU3dhcAoKaW1wb3J0IHsgY29uc3RhbnRzIH0gZnJvbSAnc3dhcC5hcHAnOwppbXBvcnQgeyBGbG93IH0gZnJvbSAnc3dhcC5zd2FwJzsKCnZhciBHSE9TVDJCVEMgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9GbG93KSB7CiAgX2luaGVyaXRzKEdIT1NUMkJUQywgX0Zsb3cpOwoKICB2YXIgX3N1cGVyID0gX2NyZWF0ZVN1cGVyKEdIT1NUMkJUQyk7CgogIGZ1bmN0aW9uIEdIT1NUMkJUQyhzd2FwKSB7CiAgICB2YXIgX3RoaXNTdXBlciwgX3RoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEdIT1NUMkJUQyk7CgogICAgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCBzd2FwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJfZmxvd05hbWUiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImdob3N0U3dhcCIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiYnRjU3dhcCIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAic3RhdGUiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImdldFJlZnVuZFR4SGV4IiwgZnVuY3Rpb24gKCkgewogICAgICBfdGhpcy5naG9zdFN3YXAuZ2V0UmVmdW5kSGV4VHJhbnNhY3Rpb24oewogICAgICAgIHNjcmlwdFZhbHVlczogX3RoaXMuc3RhdGUuZ2hvc3RTY3JpcHRWYWx1ZXMsCiAgICAgICAgc2VjcmV0OiBfdGhpcy5zdGF0ZS5zZWNyZXQKICAgICAgfSkudGhlbihmdW5jdGlvbiAodHhIZXgpIHsKICAgICAgICBfdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICByZWZ1bmRUeEhleDogdHhIZXgKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBfdGhpcy5fZmxvd05hbWUgPSBHSE9TVDJCVEMuZ2V0TmFtZSgpOwogICAgX3RoaXMuc3RlcE51bWJlcnMgPSB7CiAgICAgICdzaWduJzogMSwKICAgICAgJ3dhaXQtbG9jay1idGMnOiAyLAogICAgICAndmVyaWZ5LXNjcmlwdCc6IDMsCiAgICAgICdzeW5jLWJhbGFuY2UnOiA0LAogICAgICAnbG9jay1naG9zdCc6IDUsCiAgICAgICd3YWl0LXdpdGhkcmF3LWdob3N0JzogNiwKICAgICAgLy8gYWthIGdldFNlY3JldAogICAgICAnd2l0aGRyYXctYnRjJzogNywKICAgICAgJ2ZpbmlzaCc6IDgsCiAgICAgICdlbmQnOiA5CiAgICB9OwogICAgX3RoaXMuZ2hvc3RTd2FwID0gc3dhcC5wYXJ0aWNpcGFudFN3YXA7CiAgICBfdGhpcy5idGNTd2FwID0gc3dhcC5vd25lclN3YXA7CgogICAgaWYgKCFfdGhpcy5naG9zdFN3YXApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdCVEMyR0hPU1Q6ICJnaG9zdFN3YXAiIG9mIHR5cGUgb2JqZWN0IHJlcXVpcmVkJyk7CiAgICB9CgogICAgaWYgKCFfdGhpcy5idGNTd2FwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQlRDMkdIT1NUOiAiYnRjU3dhcCIgb2YgdHlwZSBvYmplY3QgcmVxdWlyZWQnKTsKICAgIH0KCiAgICBfdGhpcy5zdGF0ZSA9IHsKICAgICAgc3RlcDogMCwKICAgICAgc2lnblRyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgaXNTaWduRmV0Y2hpbmc6IGZhbHNlLAogICAgICBpc01lU2lnbmVkOiBmYWxzZSwKICAgICAgc2VjcmV0SGFzaDogbnVsbCwKICAgICAgYnRjU2NyaXB0VmFsdWVzOiBudWxsLAogICAgICBnaG9zdFNjcmlwdFZhbHVlczogbnVsbCwKICAgICAgYnRjU2NyaXB0VmVyaWZpZWQ6IGZhbHNlLAogICAgICBpc0JhbGFuY2VGZXRjaGluZzogZmFsc2UsCiAgICAgIGlzQmFsYW5jZUVub3VnaDogZmFsc2UsCiAgICAgIGJhbGFuY2U6IG51bGwsCiAgICAgIGJ0Y1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICBnaG9zdFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgaXNHaG9zdFNjcmlwdEZ1bmRlZDogZmFsc2UsCiAgICAgIHNlY3JldDogbnVsbCwKICAgICAgaXNHaG9zdFdpdGhkcmF3bjogZmFsc2UsCiAgICAgIGlzYnRjV2l0aGRyYXduOiBmYWxzZSwKICAgICAgcmVmdW5kVHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICBpc1JlZnVuZGVkOiBmYWxzZSwKICAgICAgaXNGaW5pc2hlZDogZmFsc2UsCiAgICAgIGlzU3dhcEV4aXN0OiBmYWxzZQogICAgfTsKCiAgICBfdGhpcy5fcGVyc2lzdFN0YXRlKCk7CgogICAgX2dldCgoX3RoaXNTdXBlciA9IF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCBfZ2V0UHJvdG90eXBlT2YoR0hPU1QyQlRDLnByb3RvdHlwZSkpLCAiX3BlcnNpc3RTdGVwcyIsIF90aGlzU3VwZXIpLmNhbGwoX3RoaXNTdXBlcik7CgogICAgcmV0dXJuIF90aGlzOwogIH0KCiAgX2NyZWF0ZUNsYXNzKEdIT1NUMkJUQywgW3sKICAgIGtleTogIl9wZXJzaXN0U3RhdGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9wZXJzaXN0U3RhdGUoKSB7CiAgICAgIF9nZXQoX2dldFByb3RvdHlwZU9mKEdIT1NUMkJUQy5wcm90b3R5cGUpLCAiX3BlcnNpc3RTdGF0ZSIsIHRoaXMpLmNhbGwodGhpcyk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2dldFN0ZXBzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2V0U3RlcHMoKSB7CiAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgdmFyIGZsb3cgPSB0aGlzOwogICAgICByZXR1cm4gWy8vIDEuIFNpZ24gc3dhcCB0byBzdGFydAogICAgICBmdW5jdGlvbiAoKSB7Ly8gdGhpcy5zaWduKCkKICAgICAgfSwgLy8gMi4gV2FpdCBwYXJ0aWNpcGFudCBjcmVhdGUsIGZ1bmQgQlRDIFNjcmlwdAogICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgZmxvdy5zd2FwLnJvb20ub25jZSgnY3JlYXRlIGJ0YyBzY3JpcHQnLCBmdW5jdGlvbiAoX3JlZikgewogICAgICAgICAgdmFyIHNjcmlwdFZhbHVlcyA9IF9yZWYuc2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgIGJ0Y1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoID0gX3JlZi5idGNTY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaDsKICAgICAgICAgIGZsb3cuZmluaXNoU3RlcCh7CiAgICAgICAgICAgIHNlY3JldEhhc2g6IHNjcmlwdFZhbHVlcy5zZWNyZXRIYXNoLAogICAgICAgICAgICBidGNTY3JpcHRWYWx1ZXM6IHNjcmlwdFZhbHVlcywKICAgICAgICAgICAgYnRjU2NyaXB0Q3JlYXRpbmdUcmFuc2FjdGlvbkhhc2g6IGJ0Y1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICB9LCB7CiAgICAgICAgICAgIHN0ZXA6ICd3YWl0LWxvY2stYnRjJywKICAgICAgICAgICAgc2lsZW50RXJyb3I6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgIGV2ZW50OiAncmVxdWVzdCBidGMgc2NyaXB0JwogICAgICAgIH0pOwogICAgICB9LCAvLyAzLiBWZXJpZnkgQlRDIFNjcmlwdAogICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoIndhaXRpbmcgdmVyaWZ5IGJ0YyBzY3JpcHQiKTsgLy8gdGhpcy52ZXJpZnlCdGNTY3JpcHQoKQogICAgICB9LCAvLyA0LiBDaGVjayBiYWxhbmNlCiAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpczIuc3luY0JhbGFuY2UoKTsKCiAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoX3RoaXMyKTsKICAgICAgfSwKICAgICAgLyojX19QVVJFX18qLwogICAgICAvLyA1LiBDcmVhdGUgR2hvc3QgU2NyaXB0CiAgICAgIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUoKSB7CiAgICAgICAgdmFyIF9mbG93JHN3YXAsIHBhcnRpY2lwYW50LCBidXlBbW91bnQsIHNlbGxBbW91bnQsIGdob3N0U3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoLCB1dGNOb3csIGdldExvY2tUaW1lLCBzY3JpcHRDaGVja1Jlc3VsdCwgc2NyaXB0VmFsdWVzOwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX2Zsb3ckc3dhcCA9IGZsb3cuc3dhcCwgcGFydGljaXBhbnQgPSBfZmxvdyRzd2FwLnBhcnRpY2lwYW50LCBidXlBbW91bnQgPSBfZmxvdyRzd2FwLmJ1eUFtb3VudCwgc2VsbEFtb3VudCA9IF9mbG93JHN3YXAuc2VsbEFtb3VudDsKCiAgICAgICAgICAgICAgICAvLyBUT0RPIG1vdmUgdGhpcyBzb21ld2hlcmUhCiAgICAgICAgICAgICAgICB1dGNOb3cgPSBmdW5jdGlvbiB1dGNOb3coKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgZ2V0TG9ja1RpbWUgPSBmdW5jdGlvbiBnZXRMb2NrVGltZSgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHV0Y05vdygpICsgMzYwMCAqIDE7CiAgICAgICAgICAgICAgICB9OyAvLyAxIGhvdXIgZnJvbSBub3cKCgogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmxvdy5idGNTd2FwLmNoZWNrU2NyaXB0KGZsb3cuc3RhdGUuYnRjU2NyaXB0VmFsdWVzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBidXlBbW91bnQsCiAgICAgICAgICAgICAgICAgIHJlY2lwaWVudFB1YmxpY0tleTogX3RoaXMyLmFwcC5zZXJ2aWNlcy5hdXRoLmFjY291bnRzLmJ0Yy5nZXRQdWJsaWNLZXkoKSwKICAgICAgICAgICAgICAgICAgbG9ja1RpbWU6IGdldExvY2tUaW1lKCkKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICBzY3JpcHRDaGVja1Jlc3VsdCA9IF9jb250ZXh0LnNlbnQ7CgogICAgICAgICAgICAgICAgaWYgKCFzY3JpcHRDaGVja1Jlc3VsdCkgewogICAgICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gMTA7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkJ0YyBzY3JpcHQgY2hlY2sgZXJyb3I6Iiwgc2NyaXB0Q2hlY2tSZXN1bHQpOwogICAgICAgICAgICAgICAgZmxvdy5zd2FwLmV2ZW50cy5kaXNwYXRjaCgnYnRjIHNjcmlwdCBjaGVjayBlcnJvcicsIHNjcmlwdENoZWNrUmVzdWx0KTsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgc2NyaXB0VmFsdWVzID0gewogICAgICAgICAgICAgICAgICBzZWNyZXRIYXNoOiBmbG93LnN0YXRlLnNlY3JldEhhc2gsCiAgICAgICAgICAgICAgICAgIG93bmVyUHVibGljS2V5OiBfdGhpczIuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHMuZ2hvc3QuZ2V0UHVibGljS2V5KCksCiAgICAgICAgICAgICAgICAgIHJlY2lwaWVudFB1YmxpY0tleTogcGFydGljaXBhbnQuZ2hvc3QucHVibGljS2V5LAogICAgICAgICAgICAgICAgICBsb2NrVGltZTogZ2V0TG9ja1RpbWUoKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIF9jb250ZXh0LnByZXYgPSAxMTsKICAgICAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSAxNDsKICAgICAgICAgICAgICAgIHJldHVybiBmbG93Lmdob3N0U3dhcC5mdW5kU2NyaXB0KHsKICAgICAgICAgICAgICAgICAgc2NyaXB0VmFsdWVzOiBzY3JpcHRWYWx1ZXMsCiAgICAgICAgICAgICAgICAgIGFtb3VudDogc2VsbEFtb3VudAogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgICAgICAgICAgZ2hvc3RTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2ggPSBoYXNoOwogICAgICAgICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICBnaG9zdFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDogaGFzaAogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDI3OwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgICAgICBfY29udGV4dC5wcmV2ID0gMTY7CiAgICAgICAgICAgICAgICBfY29udGV4dC50MCA9IF9jb250ZXh0WyJjYXRjaCJdKDExKTsKCiAgICAgICAgICAgICAgICBpZiAoIS9rbm93biB0cmFuc2FjdGlvbi8udGVzdChfY29udGV4dC50MC5tZXNzYWdlKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gMjI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsIGNvbnNvbGUuZXJyb3IoImtub3duIHR4OiAiLmNvbmNhdChfY29udGV4dC50MC5tZXNzYWdlKSkpOwoKICAgICAgICAgICAgICBjYXNlIDIyOgogICAgICAgICAgICAgICAgaWYgKCEvb3V0IG9mIGdhcy8udGVzdChfY29udGV4dC50MC5tZXNzYWdlKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gMjY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsIGNvbnNvbGUuZXJyb3IoInR4IGZhaWxlZCAod3Jvbmcgc2VjcmV0Pyk6ICIuY29uY2F0KF9jb250ZXh0LnQwLm1lc3NhZ2UpKSk7CgogICAgICAgICAgICAgIGNhc2UgMjY6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuYWJydXB0KCJyZXR1cm4iLCBjb25zb2xlLmVycm9yKF9jb250ZXh0LnQwKSk7CgogICAgICAgICAgICAgIGNhc2UgMjc6CiAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5vbigncmVxdWVzdCBnaG9zdCBzY3JpcHQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICBldmVudDogJ2NyZWF0ZSBnaG9zdCBzY3JpcHQnLAogICAgICAgICAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlczogc2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgICAgZ2hvc3RTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2g6IGdob3N0U3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICBldmVudDogJ2NyZWF0ZSBnaG9zdCBzY3JpcHQnLAogICAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgc2NyaXB0VmFsdWVzOiBzY3JpcHRWYWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgZ2hvc3RTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2g6IGdob3N0U3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgZmxvdy5maW5pc2hTdGVwKHsKICAgICAgICAgICAgICAgICAgaXNHaG9zdFNjcmlwdEZ1bmRlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgZ2hvc3RTY3JpcHRWYWx1ZXM6IHNjcmlwdFZhbHVlcwogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBzdGVwOiAnbG9jay1naG9zdCcKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDMwOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZSwgbnVsbCwgW1sxMSwgMTZdXSk7CiAgICAgIH0pKSwgLy8gNi4gV2FpdCBwYXJ0aWNpcGFudCB3aXRoZHJhdwogICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgZmxvdy5zd2FwLnJvb20ub25jZSgnZ2hvc3RXaXRoZHJhd1R4SGFzaCcsIC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgX3JlZjQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMihfcmVmMykgewogICAgICAgICAgICB2YXIgZ2hvc3RTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2gsIHNlY3JldDsKICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMiQoX2NvbnRleHQyKSB7CiAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyLnByZXYgPSBfY29udGV4dDIubmV4dCkgewogICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgZ2hvc3RTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2ggPSBfcmVmMy5naG9zdFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDsKICAgICAgICAgICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICAgIGdob3N0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBnaG9zdFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gNDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmxvdy5naG9zdFN3YXAuZ2V0U2VjcmV0RnJvbVR4aGFzaChnaG9zdFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCk7CgogICAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgICAgc2VjcmV0ID0gX2NvbnRleHQyLnNlbnQ7CgogICAgICAgICAgICAgICAgICAgIGlmICghZmxvdy5zdGF0ZS5pc0dob3N0V2l0aGRyYXduICYmIHNlY3JldCkgewogICAgICAgICAgICAgICAgICAgICAgZmxvdy5maW5pc2hTdGVwKHsKICAgICAgICAgICAgICAgICAgICAgICAgaXNHaG9zdFdpdGhkcmF3bjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgc2VjcmV0OiBzZWNyZXQKICAgICAgICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RlcDogJ3dhaXQtd2l0aGRyYXctZ2hvc3QnCiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBfY2FsbGVlMik7CiAgICAgICAgICB9KSk7CgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeCkgewogICAgICAgICAgICByZXR1cm4gX3JlZjQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgfSgpKTsKICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICBldmVudDogJ3JlcXVlc3QgZ2hvc3RXaXRoZHJhd1R4SGFzaCcKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgLyojX19QVVJFX18qLwogICAgICAvLyA3LiBXaXRoZHJhdwogICAgICBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMygpIHsKICAgICAgICB2YXIgX2Zsb3ckc3RhdGUsIHNlY3JldCwgYnRjU2NyaXB0VmFsdWVzOwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzJChfY29udGV4dDMpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQzLnByZXYgPSBfY29udGV4dDMubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9mbG93JHN0YXRlID0gZmxvdy5zdGF0ZSwgc2VjcmV0ID0gX2Zsb3ckc3RhdGUuc2VjcmV0LCBidGNTY3JpcHRWYWx1ZXMgPSBfZmxvdyRzdGF0ZS5idGNTY3JpcHRWYWx1ZXM7CgogICAgICAgICAgICAgICAgaWYgKGJ0Y1NjcmlwdFZhbHVlcykgewogICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1RoZXJlIGlzIG5vICJidGNTY3JpcHRWYWx1ZXMiIGluIHN0YXRlLiBObyB3YXkgdG8gY29udGludWUgc3dhcC4uLicpOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5hYnJ1cHQoInJldHVybiIpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDY7CiAgICAgICAgICAgICAgICByZXR1cm4gZmxvdy5idGNTd2FwLndpdGhkcmF3KHsKICAgICAgICAgICAgICAgICAgc2NyaXB0VmFsdWVzOiBmbG93LnN0YXRlLmJ0Y1NjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgc2VjcmV0OiBzZWNyZXQKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgIGJ0Y1N3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogaGFzaAogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICBpc2J0Y1dpdGhkcmF3bjogdHJ1ZQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBzdGVwOiAnd2l0aGRyYXctYnRjJwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMyk7CiAgICAgIH0pKSwgLy8gOC4gRmluaXNoCiAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICBldmVudDogJ3N3YXAgZmluaXNoZWQnCiAgICAgICAgfSk7CiAgICAgICAgZmxvdy5maW5pc2hTdGVwKHsKICAgICAgICAgIGlzRmluaXNoZWQ6IHRydWUKICAgICAgICB9LCB7CiAgICAgICAgICBzdGVwOiAnZmluaXNoJwogICAgICAgIH0pOwogICAgICB9LCAvLyA5LiBGaW5pc2hlZCEKICAgICAgZnVuY3Rpb24gKCkge31dOwogICAgfQogIH0sIHsKICAgIGtleTogIl9jaGVja1N3YXBBbHJlYWR5RXhpc3RzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBfY2hlY2tTd2FwQWxyZWFkeUV4aXN0cygpIHsKICAgICAgdmFyIHBhcnRpY2lwYW50ID0gdGhpcy5zd2FwLnBhcnRpY2lwYW50OwogICAgICB2YXIgc3dhcERhdGEgPSB7CiAgICAgICAgb3duZXJBZGRyZXNzOiB0aGlzLmFwcC5zZXJ2aWNlcy5hdXRoLmFjY291bnRzLmdob3N0LmFkZHJlc3MsCiAgICAgICAgcGFydGljaXBhbnRBZGRyZXNzOiBwYXJ0aWNpcGFudC5naG9zdC5hZGRyZXNzCiAgICAgIH07CiAgICAgIHJldHVybiBmYWxzZTsgLy90aGlzLmdob3N0U3dhcC5jaGVja1N3YXBFeGlzdHMoc3dhcERhdGEpCiAgICB9CiAgfSwgewogICAga2V5OiAic2lnbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3NpZ24gPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNCgpIHsKICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgdmFyIHN3YXBFeGlzdHM7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NC5wcmV2ID0gX2NvbnRleHQ0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fY2hlY2tTd2FwQWxyZWFkeUV4aXN0cygpOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBzd2FwRXhpc3RzID0gX2NvbnRleHQ0LnNlbnQ7CgogICAgICAgICAgICAgICAgaWYgKCFzd2FwRXhpc3RzKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gODsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICBldmVudDogJ3N3YXAgZXhpc3RzJwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgaXNTd2FwRXhpc3Q6IHRydWUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSAxMzsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgaXNTaWduRmV0Y2hpbmc6IHRydWUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5zd2FwLnJvb20ub24oJ3JlcXVlc3Qgc2lnbicsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgX3RoaXMzLnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQ6ICdzd2FwIHNpZ24nCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgIGV2ZW50OiAnc3dhcCBzaWduJwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICBpc01lU2lnbmVkOiB0cnVlCiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgIHN0ZXA6ICdzaWduJywKICAgICAgICAgICAgICAgICAgc2lsZW50RXJyb3I6IHRydWUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5hYnJ1cHQoInJldHVybiIsIHRydWUpOwoKICAgICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU0LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gc2lnbigpIHsKICAgICAgICByZXR1cm4gX3NpZ24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHNpZ247CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJ2ZXJpZnlCdGNTY3JpcHQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZlcmlmeUJ0Y1NjcmlwdCgpIHsKICAgICAgaWYgKHRoaXMuc3RhdGUuYnRjU2NyaXB0VmVyaWZpZWQpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLnN0YXRlLmJ0Y1NjcmlwdFZhbHVlcykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiTm8gc2NyaXB0LCBjYW5ub3QgdmVyaWZ5Iik7CiAgICAgIH0KCiAgICAgIHRoaXMuZmluaXNoU3RlcCh7CiAgICAgICAgYnRjU2NyaXB0VmVyaWZpZWQ6IHRydWUKICAgICAgfSwgewogICAgICAgIHN0ZXA6ICd2ZXJpZnktc2NyaXB0JwogICAgICB9KTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSwgewogICAga2V5OiAic3luY0JhbGFuY2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9zeW5jQmFsYW5jZSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU1KCkgewogICAgICAgIHZhciBzZWxsQW1vdW50LCBiYWxhbmNlLCBpc0Vub3VnaE1vbmV5OwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTUkKF9jb250ZXh0NSkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDUucHJldiA9IF9jb250ZXh0NS5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgc2VsbEFtb3VudCA9IHRoaXMuc3dhcC5zZWxsQW1vdW50OwogICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgIGlzQmFsYW5jZUZldGNoaW5nOiB0cnVlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIF9jb250ZXh0NS5uZXh0ID0gNDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdob3N0U3dhcC5mZXRjaEJhbGFuY2UodGhpcy5hcHAuc2VydmljZXMuYXV0aC5hY2NvdW50cy5naG9zdC5nZXRBZGRyZXNzKCkpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICBiYWxhbmNlID0gX2NvbnRleHQ1LnNlbnQ7CiAgICAgICAgICAgICAgICBpc0Vub3VnaE1vbmV5ID0gc2VsbEFtb3VudC5pc0xlc3NUaGFuT3JFcXVhbFRvKGJhbGFuY2UpOwoKICAgICAgICAgICAgICAgIGlmIChpc0Vub3VnaE1vbmV5KSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogYmFsYW5jZSwKICAgICAgICAgICAgICAgICAgICBpc0JhbGFuY2VGZXRjaGluZzogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgaXNCYWxhbmNlRW5vdWdoOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBzdGVwOiAnc3luYy1iYWxhbmNlJwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgIGJhbGFuY2U6IGJhbGFuY2UsCiAgICAgICAgICAgICAgICAgICAgaXNCYWxhbmNlRmV0Y2hpbmc6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGlzQmFsYW5jZUVub3VnaDogZmFsc2UKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHN5bmNCYWxhbmNlKCkgewogICAgICAgIHJldHVybiBfc3luY0JhbGFuY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHN5bmNCYWxhbmNlOwogICAgfSgpCiAgfSwgewogICAga2V5OiAidHJ5UmVmdW5kIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB0cnlSZWZ1bmQoKSB7CiAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgcmV0dXJuIHRoaXMuZ2hvc3RTd2FwLnJlZnVuZCh7CiAgICAgICAgc2NyaXB0VmFsdWVzOiB0aGlzLnN0YXRlLmdob3N0U2NyaXB0VmFsdWVzLAogICAgICAgIHNlY3JldDogdGhpcy5zdGF0ZS5zZWNyZXQKICAgICAgfSwgZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICBfdGhpczQuc2V0U3RhdGUoewogICAgICAgICAgcmVmdW5kVHJhbnNhY3Rpb25IYXNoOiBoYXNoLAogICAgICAgICAgaXNSZWZ1bmRlZDogdHJ1ZQogICAgICAgIH0pOwogICAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpczQuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgIGV2ZW50OiAncmVmdW5kIGNvbXBsZXRlZCcKICAgICAgICB9KTsKCiAgICAgICAgX3RoaXM0LnNldFN0YXRlKHsKICAgICAgICAgIGlzU3dhcEV4aXN0OiBmYWxzZQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpc1JlZnVuZFN1Y2Nlc3MiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9pc1JlZnVuZFN1Y2Nlc3MgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNigpIHsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU2JChfY29udGV4dDYpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ2LnByZXYgPSBfY29udGV4dDYubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDYuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ2LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU2KTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gaXNSZWZ1bmRTdWNjZXNzKCkgewogICAgICAgIHJldHVybiBfaXNSZWZ1bmRTdWNjZXNzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBpc1JlZnVuZFN1Y2Nlc3M7CiAgICB9KCkKICB9LCB7CiAgICBrZXk6ICJ0cnlXaXRoZHJhdyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3RyeVdpdGhkcmF3ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTcoX3NlY3JldCkgewogICAgICAgIHZhciBfdGhpczUgPSB0aGlzOwoKICAgICAgICB2YXIgX3RoaXMkc3RhdGUsIHNlY3JldCwgc2VjcmV0SGFzaCwgaXNHaG9zdFdpdGhkcmF3biwgaXNidGNXaXRoZHJhd24sIGJ0Y1NjcmlwdFZhbHVlcywgX3NlY3JldEhhc2gsIF90aGlzJGJ0Y1N3YXAkY3JlYXRlUywgc2NyaXB0QWRkcmVzcywgYmFsYW5jZTsKCiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNyQoX2NvbnRleHQ3KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Ny5wcmV2ID0gX2NvbnRleHQ3Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfdGhpcyRzdGF0ZSA9IHRoaXMuc3RhdGUsIHNlY3JldCA9IF90aGlzJHN0YXRlLnNlY3JldCwgc2VjcmV0SGFzaCA9IF90aGlzJHN0YXRlLnNlY3JldEhhc2gsIGlzR2hvc3RXaXRoZHJhd24gPSBfdGhpcyRzdGF0ZS5pc0dob3N0V2l0aGRyYXduLCBpc2J0Y1dpdGhkcmF3biA9IF90aGlzJHN0YXRlLmlzYnRjV2l0aGRyYXduLCBidGNTY3JpcHRWYWx1ZXMgPSBfdGhpcyRzdGF0ZS5idGNTY3JpcHRWYWx1ZXM7CgogICAgICAgICAgICAgICAgaWYgKF9zZWNyZXQpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ3Lm5leHQgPSAzOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldpdGhkcmF3YWwgaXMgYXV0b21hdGljLiBGb3IgbWFudWFsIHdpdGhkcmF3YWwsIHByb3ZpZGUgYSBzZWNyZXQiKTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgaWYgKGJ0Y1NjcmlwdFZhbHVlcykgewogICAgICAgICAgICAgICAgICBfY29udGV4dDcubmV4dCA9IDU7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHdpdGhkcmF3IHdpdGhvdXQgc2NyaXB0IHZhbHVlcyIpOwoKICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICBpZiAoc2VjcmV0ICYmIHNlY3JldCAhPSBfc2VjcmV0KSBjb25zb2xlLndhcm4oIlNlY3JldCBhbHJlYWR5IGtub3duIGFuZCBpcyBkaWZmZXJlbnQuIEFyZSB5b3Ugc3VyZT8iKTsKICAgICAgICAgICAgICAgIGlmIChpc2J0Y1dpdGhkcmF3bikgY29uc29sZS53YXJuKCJMb29rcyBsaWtlIG1vbmV5IHdlcmUgYWxyZWFkeSB3aXRoZHJhd24sIGFyZSB5b3Ugc3VyZT8iKTsKICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJXSVRIRFJBVyB1c2luZyBzZWNyZXQgPSAiLmNvbmNhdChfc2VjcmV0KSk7CiAgICAgICAgICAgICAgICBfc2VjcmV0SGFzaCA9IGNyeXB0by5yaXBlbWQxNjAoQnVmZmVyLmZyb20oX3NlY3JldCwgJ2hleCcpKS50b1N0cmluZygnaGV4Jyk7CiAgICAgICAgICAgICAgICBpZiAoc2VjcmV0SGFzaCAhPSBfc2VjcmV0SGFzaCkgY29uc29sZS53YXJuKCJIYXNoIGRvZXMgbm90IG1hdGNoISIpOwogICAgICAgICAgICAgICAgX3RoaXMkYnRjU3dhcCRjcmVhdGVTID0gdGhpcy5idGNTd2FwLmNyZWF0ZVNjcmlwdChidGNTY3JpcHRWYWx1ZXMpLCBzY3JpcHRBZGRyZXNzID0gX3RoaXMkYnRjU3dhcCRjcmVhdGVTLnNjcmlwdEFkZHJlc3M7CiAgICAgICAgICAgICAgICBfY29udGV4dDcubmV4dCA9IDEzOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYnRjU3dhcC5nZXRCYWxhbmNlKHNjcmlwdEFkZHJlc3MpOwoKICAgICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICAgICAgYmFsYW5jZSA9IF9jb250ZXh0Ny5zZW50OwogICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoImFkZHJlc3M9Ii5jb25jYXQoc2NyaXB0QWRkcmVzcywgIiwgYmFsYW5jZT0iKS5jb25jYXQoYmFsYW5jZSkpOwoKICAgICAgICAgICAgICAgIGlmICghKGJhbGFuY2UgPT09IDApKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ny5uZXh0ID0gMTg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgIGlzYnRjV2l0aGRyYXduOiB0cnVlCiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgIHN0ZXA6ICd3aXRoZHJhdy1idGMnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQWxyZWFkeSB3aXRoZHJhd246IGFkZHJlc3M9Ii5jb25jYXQoc2NyaXB0QWRkcmVzcywgIixiYWxhbmNlPSIpLmNvbmNhdChiYWxhbmNlKSk7CgogICAgICAgICAgICAgIGNhc2UgMTg6CiAgICAgICAgICAgICAgICBfY29udGV4dDcubmV4dCA9IDIwOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYnRjU3dhcC53aXRoZHJhdyh7CiAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlczogYnRjU2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICBzZWNyZXQ6IF9zZWNyZXQKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJUWCBoYXNoPSIuY29uY2F0KGhhc2gpKTsKCiAgICAgICAgICAgICAgICAgIF90aGlzNS5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgYnRjU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBoYXNoCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgMjA6CiAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgiVFggd2l0aGRyYXcgc2VudDogIi5jb25jYXQodGhpcy5zdGF0ZS5idGNTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2gpKTsKICAgICAgICAgICAgICAgIHRoaXMuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgIGlzYnRjV2l0aGRyYXduOiB0cnVlCiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgIHN0ZXA6ICd3aXRoZHJhdy1idGMnCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSAyMjoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNywgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHRyeVdpdGhkcmF3KF94MikgewogICAgICAgIHJldHVybiBfdHJ5V2l0aGRyYXcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRyeVdpdGhkcmF3OwogICAgfSgpCiAgfV0sIFt7CiAgICBrZXk6ICJnZXROYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXROYW1lKCkgewogICAgICByZXR1cm4gIiIuY29uY2F0KHRoaXMuZ2V0RnJvbU5hbWUoKSwgIjIiKS5jb25jYXQodGhpcy5nZXRUb05hbWUoKSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2V0RnJvbU5hbWUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldEZyb21OYW1lKCkgewogICAgICByZXR1cm4gY29uc3RhbnRzLkNPSU5TLmdob3N0OwogICAgfQogIH0sIHsKICAgIGtleTogImdldFRvTmFtZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0VG9OYW1lKCkgewogICAgICByZXR1cm4gY29uc3RhbnRzLkNPSU5TLmJ0YzsKICAgIH0KICB9XSk7CgogIHJldHVybiBHSE9TVDJCVEM7Cn0oRmxvdyk7CgpleHBvcnQgZGVmYXVsdCBHSE9TVDJCVEM7"},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.flows/GHOST2BTC.ts"],"names":["debug","crypto","constants","Flow","GHOST2BTC","swap","ghostSwap","getRefundHexTransaction","scriptValues","state","ghostScriptValues","secret","then","txHex","setState","refundTxHex","_flowName","getName","stepNumbers","participantSwap","btcSwap","ownerSwap","Error","step","signTransactionHash","isSignFetching","isMeSigned","secretHash","btcScriptValues","btcScriptVerified","isBalanceFetching","isBalanceEnough","balance","btcScriptCreatingTransactionHash","ghostSwapCreationTransactionHash","isGhostScriptFunded","isGhostWithdrawn","isbtcWithdrawn","refundTransactionHash","isRefunded","isFinished","isSwapExist","_persistState","flow","room","once","finishStep","silentError","sendMessage","event","syncBalance","participant","buyAmount","sellAmount","utcNow","Math","floor","Date","now","getLockTime","checkScript","value","recipientPublicKey","app","services","auth","accounts","btc","getPublicKey","lockTime","scriptCheckResult","console","error","events","dispatch","ownerPublicKey","ghost","publicKey","fundScript","amount","hash","test","message","on","data","ghostSwapWithdrawTransactionHash","getSecretFromTxhash","withdraw","btcSwapWithdrawTransactionHash","swapData","ownerAddress","address","participantAddress","_checkSwapAlreadyExists","swapExists","fetchBalance","getAddress","isEnoughMoney","isLessThanOrEqualTo","refund","_secret","warn","_secretHash","ripemd160","Buffer","from","toString","createScript","scriptAddress","getBalance","getFromName","getToName","COINS"],"mappings":"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","sourcesContent":["import debug from 'debug'\r\nimport crypto from 'bitcoinjs-lib/src/crypto' // move to BtcSwap\r\nimport SwapApp, { constants } from 'swap.app'\r\nimport { Flow } from 'swap.swap'\r\n\r\n\r\nclass GHOST2BTC extends Flow {\r\n\r\n  _flowName: string\r\n  ghostSwap: any\r\n  btcSwap: any\r\n  state: any\r\n\r\n  static getName() {\r\n    return `${this.getFromName()}2${this.getToName()}`\r\n  }\r\n  static getFromName() {\r\n    return constants.COINS.ghost\r\n  }\r\n  static getToName() {\r\n    return constants.COINS.btc\r\n  }\r\n  constructor(swap) {\r\n    super(swap)\r\n\r\n    this._flowName = GHOST2BTC.getName()\r\n\r\n    this.stepNumbers = {\r\n      'sign': 1,\r\n      'wait-lock-btc': 2,\r\n      'verify-script': 3,\r\n      'sync-balance': 4,\r\n      'lock-ghost': 5,\r\n      'wait-withdraw-ghost': 6, // aka getSecret\r\n      'withdraw-btc': 7,\r\n      'finish': 8,\r\n      'end': 9\r\n    }\r\n\r\n    this.ghostSwap = swap.participantSwap\r\n    this.btcSwap = swap.ownerSwap\r\n\r\n    if (!this.ghostSwap) {\r\n      throw new Error('BTC2GHOST: \"ghostSwap\" of type object required')\r\n    }\r\n    if (!this.btcSwap) {\r\n      throw new Error('BTC2GHOST: \"btcSwap\" of type object required')\r\n    }\r\n\r\n    this.state = {\r\n      step: 0,\r\n\r\n      signTransactionHash: null,\r\n      isSignFetching: false,\r\n      isMeSigned: false,\r\n\r\n      secretHash: null,\r\n      btcScriptValues: null,\r\n      ghostScriptValues: null,\r\n\r\n      btcScriptVerified: false,\r\n\r\n      isBalanceFetching: false,\r\n      isBalanceEnough: false,\r\n      balance: null,\r\n\r\n      btcScriptCreatingTransactionHash: null,\r\n      ghostSwapCreationTransactionHash: null,\r\n\r\n      isGhostScriptFunded: false,\r\n\r\n      secret: null,\r\n\r\n      isGhostWithdrawn: false,\r\n      isbtcWithdrawn: false,\r\n\r\n      refundTransactionHash: null,\r\n      isRefunded: false,\r\n\r\n      isFinished: false,\r\n      isSwapExist: false,\r\n    }\r\n\r\n    this._persistState()\r\n    super._persistSteps()\r\n  }\r\n\r\n  _persistState() {\r\n    super._persistState()\r\n  }\r\n\r\n  _getSteps() {\r\n    const flow = this\r\n\r\n    return [\r\n\r\n      // 1. Sign swap to start\r\n\r\n      () => {\r\n        // this.sign()\r\n      },\r\n\r\n      // 2. Wait participant create, fund BTC Script\r\n\r\n      () => {\r\n        flow.swap.room.once('create btc script', ({ scriptValues, btcScriptCreatingTransactionHash }) => {\r\n          flow.finishStep({\r\n            secretHash: scriptValues.secretHash,\r\n            btcScriptValues: scriptValues,\r\n            btcScriptCreatingTransactionHash,\r\n          }, { step: 'wait-lock-btc', silentError: true })\r\n        })\r\n\r\n        flow.swap.room.sendMessage({\r\n          event: 'request btc script',\r\n        })\r\n      },\r\n\r\n      // 3. Verify BTC Script\r\n\r\n      () => {\r\n        debug('swap.core:flow')(`waiting verify btc script`)\r\n        // this.verifyBtcScript()\r\n      },\r\n\r\n      // 4. Check balance\r\n\r\n      () => {\r\n        this.syncBalance()\r\n        debug('swap.core:flow')(this)\r\n      },\r\n\r\n      // 5. Create Ghost Script\r\n\r\n      async () => {\r\n        const { participant, buyAmount, sellAmount } = flow.swap\r\n        let ghostSwapCreationTransactionHash\r\n\r\n        // TODO move this somewhere!\r\n        const utcNow = () => Math.floor(Date.now() / 1000)\r\n        const getLockTime = () => utcNow() + 3600 * 1 // 1 hour from now\r\n\r\n        const scriptCheckResult = await flow.btcSwap.checkScript(flow.state.btcScriptValues, {\r\n          value: buyAmount,\r\n          recipientPublicKey: this.app.services.auth.accounts.btc.getPublicKey(),\r\n          lockTime: getLockTime(),\r\n        })\r\n\r\n        if (scriptCheckResult) {\r\n          console.error(`Btc script check error:`, scriptCheckResult)\r\n          flow.swap.events.dispatch('btc script check error', scriptCheckResult)\r\n          return\r\n        }\r\n\r\n        const scriptValues = {\r\n          secretHash:         flow.state.secretHash,\r\n          ownerPublicKey:     this.app.services.auth.accounts.ghost.getPublicKey(),\r\n          recipientPublicKey: participant.ghost.publicKey,\r\n          lockTime:           getLockTime(),\r\n        }\r\n\r\n        try {\r\n          await flow.ghostSwap.fundScript({\r\n            scriptValues,\r\n            amount: sellAmount,\r\n          }, (hash) => {\r\n            ghostSwapCreationTransactionHash = hash\r\n            flow.setState({\r\n              ghostSwapCreationTransactionHash: hash,\r\n            })\r\n          })\r\n        } catch (err) {\r\n          // TODO user can stuck here after page reload...\r\n          if ( /known transaction/.test(err.message) )\r\n            return console.error(`known tx: ${err.message}`)\r\n          else if ( /out of gas/.test(err.message) )\r\n            return console.error(`tx failed (wrong secret?): ${err.message}`)\r\n          else\r\n            return console.error(err)\r\n        }\r\n\r\n        flow.swap.room.on('request ghost script', () => {\r\n          flow.swap.room.sendMessage({\r\n            event: 'create ghost script',\r\n            data: {\r\n              scriptValues,\r\n              ghostSwapCreationTransactionHash,\r\n            }\r\n          })\r\n        })\r\n\r\n        flow.swap.room.sendMessage({\r\n          event: 'create ghost script',\r\n          data: {\r\n            scriptValues,\r\n            ghostSwapCreationTransactionHash,\r\n          }\r\n        })\r\n\r\n        flow.finishStep({\r\n          isGhostScriptFunded: true,\r\n          ghostScriptValues: scriptValues,\r\n        }, { step: 'lock-ghost' })\r\n      },\r\n\r\n      // 6. Wait participant withdraw\r\n\r\n      () => {\r\n\r\n        flow.swap.room.once('ghostWithdrawTxHash', async ({ ghostSwapWithdrawTransactionHash }) => {\r\n          flow.setState({\r\n            ghostSwapWithdrawTransactionHash,\r\n          })\r\n\r\n          const secret = await flow.ghostSwap.getSecretFromTxhash(ghostSwapWithdrawTransactionHash)\r\n\r\n          if (!flow.state.isGhostWithdrawn && secret) {\r\n            flow.finishStep({\r\n              isGhostWithdrawn: true,\r\n              secret,\r\n            }, { step: 'wait-withdraw-ghost' })\r\n          }\r\n        })\r\n\r\n        flow.swap.room.sendMessage({\r\n          event: 'request ghostWithdrawTxHash',\r\n        })\r\n      },\r\n\r\n      // 7. Withdraw\r\n\r\n      async () => {\r\n        let { secret, btcScriptValues } = flow.state\r\n\r\n        if (!btcScriptValues) {\r\n          console.error('There is no \"btcScriptValues\" in state. No way to continue swap...')\r\n          return\r\n        }\r\n\r\n        await flow.btcSwap.withdraw({\r\n          scriptValues: flow.state.btcScriptValues,\r\n          secret,\r\n        }, (hash) => {\r\n          flow.setState({\r\n            btcSwapWithdrawTransactionHash: hash,\r\n          })\r\n        })\r\n\r\n        flow.finishStep({\r\n          isbtcWithdrawn: true,\r\n        }, { step: 'withdraw-btc' })\r\n      },\r\n\r\n      // 8. Finish\r\n\r\n      () => {\r\n        flow.swap.room.sendMessage({\r\n          event: 'swap finished',\r\n        })\r\n\r\n        flow.finishStep({\r\n          isFinished: true,\r\n        }, { step: 'finish' })\r\n      },\r\n\r\n      // 9. Finished!\r\n      () => {\r\n\r\n      }\r\n    ]\r\n  }\r\n\r\n  _checkSwapAlreadyExists() {\r\n    const { participant } = this.swap\r\n\r\n    const swapData = {\r\n      ownerAddress:       this.app.services.auth.accounts.ghost.address,\r\n      participantAddress: participant.ghost.address\r\n    }\r\n\r\n    return false//this.ghostSwap.checkSwapExists(swapData)\r\n  }\r\n\r\n  async sign() {\r\n    const swapExists = await this._checkSwapAlreadyExists()\r\n\r\n    if (swapExists) {\r\n      this.swap.room.sendMessage({\r\n        event: 'swap exists',\r\n      })\r\n\r\n      this.setState({\r\n        isSwapExist: true,\r\n      })\r\n    } else {\r\n      this.setState({\r\n        isSignFetching: true,\r\n      })\r\n\r\n      this.swap.room.on('request sign', () => {\r\n        this.swap.room.sendMessage({\r\n          event: 'swap sign',\r\n        })\r\n      })\r\n\r\n      this.swap.room.sendMessage({\r\n        event: 'swap sign',\r\n      })\r\n\r\n      this.finishStep({\r\n        isMeSigned: true,\r\n      }, { step: 'sign', silentError: true })\r\n\r\n      return true\r\n    }\r\n  }\r\n\r\n\r\n  verifyBtcScript() {\r\n    if (this.state.btcScriptVerified) {\r\n      return true\r\n    }\r\n    if (!this.state.btcScriptValues) {\r\n      throw new Error(`No script, cannot verify`)\r\n    }\r\n\r\n    this.finishStep({\r\n      btcScriptVerified: true,\r\n    }, { step: 'verify-script' })\r\n\r\n    return true\r\n  }\r\n\r\n  async syncBalance() {\r\n    const { sellAmount } = this.swap\r\n\r\n    this.setState({\r\n      isBalanceFetching: true,\r\n    })\r\n\r\n    const balance = await this.ghostSwap.fetchBalance(this.app.services.auth.accounts.ghost.getAddress())\r\n\r\n    const isEnoughMoney = sellAmount.isLessThanOrEqualTo(balance)\r\n\r\n    if (isEnoughMoney) {\r\n      this.finishStep({\r\n        balance,\r\n        isBalanceFetching: false,\r\n        isBalanceEnough: true,\r\n      }, { step: 'sync-balance' })\r\n    }\r\n    else {\r\n      this.setState({\r\n        balance,\r\n        isBalanceFetching: false,\r\n        isBalanceEnough: false,\r\n      })\r\n    }\r\n  }\r\n\r\n  getRefundTxHex = () => {\r\n    this.ghostSwap.getRefundHexTransaction({\r\n      scriptValues: this.state.ghostScriptValues,\r\n      secret: this.state.secret,\r\n    })\r\n      .then((txHex) => {\r\n        this.setState({\r\n          refundTxHex: txHex,\r\n        })\r\n      })\r\n  }\r\n\r\n  tryRefund() {\r\n    return this.ghostSwap.refund({\r\n      scriptValues: this.state.ghostScriptValues,\r\n      secret: this.state.secret,\r\n    }, (hash) => {\r\n      this.setState({\r\n        refundTransactionHash: hash,\r\n        isRefunded: true,\r\n      })\r\n    })\r\n      .then(() => {\r\n        this.swap.room.sendMessage({\r\n          event: 'refund completed',\r\n        })\r\n\r\n        this.setState({\r\n          isSwapExist: false,\r\n        })\r\n      })\r\n  }\r\n\r\n  async isRefundSuccess() {\r\n    return true\r\n  }\r\n\r\n  async tryWithdraw(_secret) {\r\n    const { secret, secretHash, isGhostWithdrawn, isbtcWithdrawn, btcScriptValues } = this.state\r\n    if (!_secret)\r\n      throw new Error(`Withdrawal is automatic. For manual withdrawal, provide a secret`)\r\n\r\n    if (!btcScriptValues)\r\n      throw new Error(`Cannot withdraw without script values`)\r\n\r\n    if (secret && secret != _secret)\r\n      console.warn(`Secret already known and is different. Are you sure?`)\r\n\r\n    if (isbtcWithdrawn)\r\n      console.warn(`Looks like money were already withdrawn, are you sure?`)\r\n\r\n    debug('swap.core:flow')(`WITHDRAW using secret = ${_secret}`)\r\n\r\n    const _secretHash = crypto.ripemd160(Buffer.from(_secret, 'hex')).toString('hex')\r\n    if (secretHash != _secretHash)\r\n      console.warn(`Hash does not match!`)\r\n\r\n    const { scriptAddress } = this.btcSwap.createScript(btcScriptValues)\r\n    const balance = await this.btcSwap.getBalance(scriptAddress)\r\n\r\n    debug('swap.core:flow')(`address=${scriptAddress}, balance=${balance}`)\r\n\r\n    if (balance === 0) {\r\n      this.finishStep({\r\n        isbtcWithdrawn: true,\r\n      }, { step: 'withdraw-btc' })\r\n      throw new Error(`Already withdrawn: address=${scriptAddress},balance=${balance}`)\r\n    }\r\n\r\n    await this.btcSwap.withdraw({\r\n      scriptValues: btcScriptValues,\r\n      secret: _secret,\r\n    }, (hash) => {\r\n      debug('swap.core:flow')(`TX hash=${hash}`)\r\n      this.setState({\r\n        btcSwapWithdrawTransactionHash: hash,\r\n      })\r\n    })\r\n    debug('swap.core:flow')(`TX withdraw sent: ${this.state.btcSwapWithdrawTransactionHash}`)\r\n\r\n    this.finishStep({\r\n      isbtcWithdrawn: true,\r\n    }, { step: 'withdraw-btc' })\r\n  }\r\n\r\n}\r\n\r\n\r\nexport default GHOST2BTC\r\n"]}]}