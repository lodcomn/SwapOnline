{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\NEXT2ETHTOKEN.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\NEXT2ETHTOKEN.ts","mtime":1614842913760},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXN5bmNUb0dlbmVyYXRvciI7CmltcG9ydCBfY2xhc3NDYWxsQ2hlY2sgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jcmVhdGVDbGFzcyI7CmltcG9ydCBfYXNzZXJ0VGhpc0luaXRpYWxpemVkIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXNzZXJ0VGhpc0luaXRpYWxpemVkIjsKaW1wb3J0IF9pbmhlcml0cyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjsKaW1wb3J0IF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiI7CmltcG9ydCBfZ2V0IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0IjsKaW1wb3J0IF9nZXRQcm90b3R5cGVPZiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldFByb3RvdHlwZU9mIjsKaW1wb3J0IF9kZWZpbmVQcm9wZXJ0eSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2RlZmluZVByb3BlcnR5IjsKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgppbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnOwppbXBvcnQgeyBjb25zdGFudHMsIHV0aWwgfSBmcm9tICdzd2FwLmFwcCc7CmltcG9ydCB7IEF0b21pY0FCMlVUWE8gfSBmcm9tICdzd2FwLnN3YXAnOwppbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdiaWdudW1iZXIuanMnOwpleHBvcnQgZGVmYXVsdCAoZnVuY3Rpb24gKHRva2VuTmFtZSkgewogIHZhciBORVhUMkVUSFRPS0VOID0gLyojX19QVVJFX18qL2Z1bmN0aW9uIChfQXRvbWljQUIyVVRYTykgewogICAgX2luaGVyaXRzKE5FWFQyRVRIVE9LRU4sIF9BdG9taWNBQjJVVFhPKTsKCiAgICB2YXIgX3N1cGVyID0gX2NyZWF0ZVN1cGVyKE5FWFQyRVRIVE9LRU4pOwoKICAgIGZ1bmN0aW9uIE5FWFQyRVRIVE9LRU4oc3dhcCkgewogICAgICB2YXIgX3RoaXNTdXBlciwgX3RoaXM7CgogICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgTkVYVDJFVEhUT0tFTik7CgogICAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsIHN3YXApOwoKICAgICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiX2Zsb3dOYW1lIiwgdm9pZCAwKTsKCiAgICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImV0aFRva2VuU3dhcCIsIHZvaWQgMCk7CgogICAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJuZXh0U3dhcCIsIHZvaWQgMCk7CgogICAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJzdGF0ZSIsIHZvaWQgMCk7CgogICAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJnZXRSZWZ1bmRUeEhleCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpcy5uZXh0U3dhcC5nZXRSZWZ1bmRIZXhUcmFuc2FjdGlvbih7CiAgICAgICAgICBzY3JpcHRWYWx1ZXM6IF90aGlzLnN0YXRlLm5leHRTY3JpcHRWYWx1ZXMsCiAgICAgICAgICBzZWNyZXQ6IF90aGlzLnN0YXRlLnNlY3JldAogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHR4SGV4KSB7CiAgICAgICAgICBfdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICAgIHJlZnVuZFR4SGV4OiB0eEhleAogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgX3RoaXMudXR4b0NvaW4gPSAibmV4dCI7CiAgICAgIF90aGlzLl9mbG93TmFtZSA9IE5FWFQyRVRIVE9LRU4uZ2V0TmFtZSgpOwogICAgICBfdGhpcy5zdGVwTnVtYmVycyA9IHsKICAgICAgICAnc2lnbic6IDEsCiAgICAgICAgJ3N1Ym1pdC1zZWNyZXQnOiAyLAogICAgICAgICdzeW5jLWJhbGFuY2UnOiAzLAogICAgICAgICdsb2NrLXV0eG8nOiA0LAogICAgICAgICd3YWl0LWxvY2stZXRoJzogNSwKICAgICAgICAnd2l0aGRyYXctZXRoJzogNiwKICAgICAgICAnZmluaXNoJzogNywKICAgICAgICAnZW5kJzogOAogICAgICB9OwogICAgICBfdGhpcy5ldGhUb2tlblN3YXAgPSBzd2FwLm93bmVyU3dhcDsKICAgICAgX3RoaXMubmV4dFN3YXAgPSBzd2FwLnBhcnRpY2lwYW50U3dhcDsKICAgICAgX3RoaXMuYWJCbG9ja2NoYWluID0gX3RoaXMuZXRoVG9rZW5Td2FwOwogICAgICBfdGhpcy51dHhvQmxvY2tjaGFpbiA9IF90aGlzLm5leHRTd2FwOwogICAgICBfdGhpcy5pc1VUWE9TaWRlID0gdHJ1ZTsKCiAgICAgIGlmICghX3RoaXMuZXRoVG9rZW5Td2FwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdORVhUMkVUSDogImV0aFRva2VuU3dhcCIgb2YgdHlwZSBvYmplY3QgcmVxdWlyZWQnKTsKICAgICAgfQoKICAgICAgaWYgKCFfdGhpcy5uZXh0U3dhcCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignTkVYVDJFVEg6ICJuZXh0U3dhcCIgb2YgdHlwZSBvYmplY3QgcmVxdWlyZWQnKTsKICAgICAgfQoKICAgICAgX3RoaXMuc3RhdGUgPSB7CiAgICAgICAgc3RlcDogMCwKICAgICAgICBpc1N0b3BwZWRTd2FwOiBmYWxzZSwKICAgICAgICBzaWduVHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICAgIGlzU2lnbkZldGNoaW5nOiBmYWxzZSwKICAgICAgICBpc1BhcnRpY2lwYW50U2lnbmVkOiBmYWxzZSwKICAgICAgICBldGhTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgICAgc2VjcmV0SGFzaDogbnVsbCwKICAgICAgICBpc0JhbGFuY2VGZXRjaGluZzogZmFsc2UsCiAgICAgICAgaXNCYWxhbmNlRW5vdWdoOiB0cnVlLAogICAgICAgIGJhbGFuY2U6IG51bGwsCiAgICAgICAgaXNFdGhDb250cmFjdEZ1bmRlZDogZmFsc2UsCiAgICAgICAgbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgICBldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgICAgc2VjcmV0OiBudWxsLAogICAgICAgIGNhbkNyZWF0ZUV0aFRyYW5zYWN0aW9uOiB0cnVlLAogICAgICAgIGlzRXRoV2l0aGRyYXduOiBmYWxzZSwKICAgICAgICByZWZ1bmRUcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgICAgaXNSZWZ1bmRlZDogZmFsc2UsCiAgICAgICAgd2l0aGRyYXdGZWU6IG51bGwsCiAgICAgICAgcmVmdW5kVHhIZXg6IG51bGwsCiAgICAgICAgaXNGaW5pc2hlZDogZmFsc2UsCiAgICAgICAgaXNTd2FwRXhpc3Q6IGZhbHNlCiAgICAgIH07CgogICAgICBfdGhpcy5fcGVyc2lzdFN0YXRlKCk7CgogICAgICBfZ2V0KChfdGhpc1N1cGVyID0gX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksIF9nZXRQcm90b3R5cGVPZihORVhUMkVUSFRPS0VOLnByb3RvdHlwZSkpLCAiX3BlcnNpc3RTdGVwcyIsIF90aGlzU3VwZXIpLmNhbGwoX3RoaXNTdXBlcik7CgogICAgICByZXR1cm4gX3RoaXM7CiAgICB9CgogICAgX2NyZWF0ZUNsYXNzKE5FWFQyRVRIVE9LRU4sIFt7CiAgICAgIGtleTogIl9wZXJzaXN0U3RhdGUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX3BlcnNpc3RTdGF0ZSgpIHsKICAgICAgICBfZ2V0KF9nZXRQcm90b3R5cGVPZihORVhUMkVUSFRPS0VOLnByb3RvdHlwZSksICJfcGVyc2lzdFN0YXRlIiwgdGhpcykuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfZ2V0U3RlcHMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2dldFN0ZXBzKCkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICB2YXIgZmxvdyA9IHRoaXM7CiAgICAgICAgcmV0dXJuIFsKICAgICAgICAvKiNfX1BVUkVfXyovCiAgICAgICAgLy8gMS4gU2lnbnMKICAgICAgICBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlJChfY29udGV4dCkgewogICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX3RoaXMyLnNpZ25VVFhPU2lkZSgpOwoKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlKTsKICAgICAgICB9KSksIC8vIDIuIENyZWF0ZSBzZWNyZXQsIHNlY3JldCBoYXNoIGFuZCBORVhUIHNjcmlwdAogICAgICAgIGZ1bmN0aW9uICgpIHsvLyB0aGlzLnN1Ym1pdFNlY3JldCgpCiAgICAgICAgfSwgLy8gMy4gQ2hlY2sgc3lzdGVtIHdhbGxldCBiYWxhbmNlCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgX3RoaXMyLnN5bmNCYWxhbmNlKCk7CiAgICAgICAgfSwKICAgICAgICAvKiNfX1BVUkVfXyovCiAgICAgICAgLy8gNC4gQ3JlYXRlIE5FWFQgU2NyaXB0LCBmdW5kLCBub3RpZnkgcGFydGljaXBhbnQKICAgICAgICBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNCgpIHsKICAgICAgICAgIHZhciBvblRyYW5zYWN0aW9uSGFzaCwgc2VsbEFtb3VudCwgX2Zsb3ckc3RhdGUyLCBpc0JhbGFuY2VFbm91Z2gsIHV0eG9TY3JpcHRWYWx1ZXMsIGNoZWNrTkVYVFNjcmlwdEJhbGFuY2UsIGlzU3RvcHBlZFN3YXA7CgogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDQucHJldiA9IF9jb250ZXh0NC5uZXh0KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIG9uVHJhbnNhY3Rpb25IYXNoID0gZnVuY3Rpb24gb25UcmFuc2FjdGlvbkhhc2godHhJRCkgewogICAgICAgICAgICAgICAgICAgIHZhciBfZmxvdyRzdGF0ZSA9IGZsb3cuc3RhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgIHV0eG9TY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaCA9IF9mbG93JHN0YXRlLnV0eG9TY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaCwKICAgICAgICAgICAgICAgICAgICAgICAgdXR4b1NjcmlwdFZhbHVlcyA9IF9mbG93JHN0YXRlLnV0eG9TY3JpcHRWYWx1ZXM7CgogICAgICAgICAgICAgICAgICAgIGlmICh1dHhvU2NyaXB0Q3JlYXRpbmdUcmFuc2FjdGlvbkhhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgICAgdXR4b1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoOiB0eElECiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20ub25jZSgncmVxdWVzdCB1dHhvIHNjcmlwdCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6ICdjcmVhdGUgdXR4byBzY3JpcHQnLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0VmFsdWVzOiB1dHhvU2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgICAgICAgIHV0eG9TY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaDogdHhJRAogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICBldmVudDogJ2NyZWF0ZSB1dHhvIHNjcmlwdCcsCiAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlczogdXR4b1NjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgICAgICAgdXR4b1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoOiB0eElECiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICBzZWxsQW1vdW50ID0gZmxvdy5zd2FwLnNlbGxBbW91bnQ7CiAgICAgICAgICAgICAgICAgIF9mbG93JHN0YXRlMiA9IGZsb3cuc3RhdGUsIGlzQmFsYW5jZUVub3VnaCA9IF9mbG93JHN0YXRlMi5pc0JhbGFuY2VFbm91Z2gsIHV0eG9TY3JpcHRWYWx1ZXMgPSBfZmxvdyRzdGF0ZTIudXR4b1NjcmlwdFZhbHVlczsKCiAgICAgICAgICAgICAgICAgIGlmICghaXNCYWxhbmNlRW5vdWdoKSB7CiAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSA2OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDY7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmbG93Lm5leHRTd2FwLmZ1bmRTY3JpcHQoewogICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlczogdXR4b1NjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IHNlbGxBbW91bnQKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICAgICAgICBjaGVja05FWFRTY3JpcHRCYWxhbmNlID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3JlZjMgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMigpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBfdGhpczIkbmV4dFN3YXAkY3JlYXQsIHNjcmlwdEFkZHJlc3MsIHVuc3BlbnRzLCB0eElELCBiYWxhbmNlLCBpc0Vub3VnaE1vbmV5OwoKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIkKF9jb250ZXh0MikgewogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyLnByZXYgPSBfY29udGV4dDIubmV4dCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpczIkbmV4dFN3YXAkY3JlYXQgPSBfdGhpczIubmV4dFN3YXAuY3JlYXRlU2NyaXB0KHV0eG9TY3JpcHRWYWx1ZXMpLCBzY3JpcHRBZGRyZXNzID0gX3RoaXMyJG5leHRTd2FwJGNyZWF0LnNjcmlwdEFkZHJlc3M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMi5uZXh0U3dhcC5mZXRjaFVuc3BlbnRzKHNjcmlwdEFkZHJlc3MpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5zcGVudHMgPSBfY29udGV4dDIuc2VudDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKHVuc3BlbnRzLmxlbmd0aCA9PT0gMCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuYWJydXB0KCJyZXR1cm4iLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eElEID0gdW5zcGVudHNbMF0udHhpZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSA5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMyLm5leHRTd2FwLmdldEJhbGFuY2UodXR4b1NjcmlwdFZhbHVlcyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWxhbmNlID0gX2NvbnRleHQyLnNlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzRW5vdWdoTW9uZXkgPSBuZXcgQmlnTnVtYmVyKGJhbGFuY2UpLmlzR3JlYXRlclRoYW5PckVxdWFsVG8oc2VsbEFtb3VudC50aW1lcygxZTgpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Vub3VnaE1vbmV5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRCYWxhbmNlOiBuZXcgQmlnTnVtYmVyKGJhbGFuY2UpLmRpdigxZTgpLmRwKDgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25UcmFuc2FjdGlvbkhhc2godHhJRCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuYWJydXB0KCJyZXR1cm4iLCBpc0Vub3VnaE1vbmV5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMik7CiAgICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gY2hlY2tORVhUU2NyaXB0QmFsYW5jZSgpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmMy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIH0oKTsKCiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gOTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwuaGVscGVycy5yZXBlYXRBc3luY1VudGlsUmVzdWx0KCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBfcmVmNCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUzKHN0b3BSZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBpc1N0b3BwZWRTd2FwOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMyQoX2NvbnRleHQzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDMucHJldiA9IF9jb250ZXh0My5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzU3RvcHBlZFN3YXAgPSBmbG93LnN0YXRlLmlzU3RvcHBlZFN3YXA7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdG9wcGVkU3dhcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gNzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQzLm5leHQgPSA0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hlY2tORVhUU2NyaXB0QmFsYW5jZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5hYnJ1cHQoInJldHVybiIsIF9jb250ZXh0My5zZW50KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BSZXBlYXQoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUzKTsKICAgICAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoX3gpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmNC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIH0oKSk7CgogICAgICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICAgICAgICBpc1N0b3BwZWRTd2FwID0gZmxvdy5zdGF0ZS5pc1N0b3BwZWRTd2FwOwoKICAgICAgICAgICAgICAgICAgaWYgKCFpc1N0b3BwZWRTd2FwKSB7CiAgICAgICAgICAgICAgICAgICAgZmxvdy5maW5pc2hTdGVwKHsKICAgICAgICAgICAgICAgICAgICAgIGlzTmV4dFNjcmlwdEZ1bmRlZDogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICAgIHN0ZXA6ICdsb2NrLXV0eG8nCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlNCk7CiAgICAgICAgfSkpLAogICAgICAgIC8qI19fUFVSRV9fKi8KICAgICAgICAvLyA1LiBXYWl0IHBhcnRpY2lwYW50IGNyZWF0ZXMgRVRIIENvbnRyYWN0CiAgICAgICAgX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTUoKSB7CiAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU1JChfY29udGV4dDUpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NS5wcmV2ID0gX2NvbnRleHQ1Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ1Lm5leHQgPSAyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMyLmV0aFRva2VuU3dhcC53YWl0QUIyVVRYT0NvbnRyYWN0KHsKICAgICAgICAgICAgICAgICAgICBmbG93OiBmbG93LAogICAgICAgICAgICAgICAgICAgIHV0eG9Db2luOiAibmV4dCIKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlNSk7CiAgICAgICAgfSkpLAogICAgICAgIC8qI19fUFVSRV9fKi8KICAgICAgICAvLyA2LiBXaXRoZHJhdwogICAgICAgIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU2KCkgewogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNiQoX2NvbnRleHQ2KSB7CiAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDYucHJldiA9IF9jb250ZXh0Ni5uZXh0KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZsb3cuZXRoVG9rZW5Td2FwLndpdGhkcmF3RnJvbUFCMlVUWE8oewogICAgICAgICAgICAgICAgICAgIGZsb3c6IGZsb3cKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlNik7CiAgICAgICAgfSkpLCAvLyA3LiBGaW5pc2gKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmbG93LnN3YXAucm9vbS5vbmNlKCdzd2FwIGZpbmlzaGVkJywgZnVuY3Rpb24gKF9yZWY3KSB7CiAgICAgICAgICAgIHZhciBuZXh0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoID0gX3JlZjcubmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDsKICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICBldmVudDogJ3JlcXVlc3Qgc3dhcCBmaW5pc2hlZCcKICAgICAgICAgIH0pOwogICAgICAgICAgZmxvdy5maW5pc2hTdGVwKHsKICAgICAgICAgICAgaXNGaW5pc2hlZDogdHJ1ZQogICAgICAgICAgfSwgJ2ZpbmlzaCcpOwogICAgICAgIH0sIC8vIDguIEZpbmlzaGVkIQogICAgICAgIGZ1bmN0aW9uICgpIHt9XTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJza2lwU3luY0JhbGFuY2UiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfc2tpcFN5bmNCYWxhbmNlID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTcoKSB7CiAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU3JChfY29udGV4dDcpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Ny5wcmV2ID0gX2NvbnRleHQ3Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgdGhpcy5maW5pc2hTdGVwKHt9LCB7CiAgICAgICAgICAgICAgICAgICAgc3RlcDogJ3N5bmMtYmFsYW5jZScKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlNywgdGhpcyk7CiAgICAgICAgfSkpOwoKICAgICAgICBmdW5jdGlvbiBza2lwU3luY0JhbGFuY2UoKSB7CiAgICAgICAgICByZXR1cm4gX3NraXBTeW5jQmFsYW5jZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNraXBTeW5jQmFsYW5jZTsKICAgICAgfSgpCiAgICB9LCB7CiAgICAgIGtleTogInRyeVJlZnVuZCIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiB0cnlSZWZ1bmQoKSB7CiAgICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICAgIHZhciBmbG93ID0gdGhpczsKICAgICAgICB2YXIgX2Zsb3ckc3RhdGUzID0gZmxvdy5zdGF0ZSwKICAgICAgICAgICAgdXR4b1NjcmlwdFZhbHVlcyA9IF9mbG93JHN0YXRlMy51dHhvU2NyaXB0VmFsdWVzLAogICAgICAgICAgICBzZWNyZXQgPSBfZmxvdyRzdGF0ZTMuc2VjcmV0OwogICAgICAgIHJldHVybiBmbG93Lm5leHRTd2FwLnJlZnVuZCh7CiAgICAgICAgICBzY3JpcHRWYWx1ZXM6IHV0eG9TY3JpcHRWYWx1ZXMsCiAgICAgICAgICBzZWNyZXQ6IHNlY3JldAogICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgIGlmICghaGFzaCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgX3RoaXMzLnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgIGV2ZW50OiAndXR4byByZWZ1bmQgY29tcGxldGVkJwogICAgICAgICAgfSk7CgogICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgIHJlZnVuZFRyYW5zYWN0aW9uSGFzaDogaGFzaCwKICAgICAgICAgICAgaXNSZWZ1bmRlZDogdHJ1ZSwKICAgICAgICAgICAgaXNTd2FwRXhpc3Q6IGZhbHNlCiAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0pWyJjYXRjaCJdKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgaWYgKC9BZGRyZXNzIGlzIGVtcHR5Ly50ZXN0KGVycm9yKSkgewogICAgICAgICAgICAvLyBUT0RPIC0gZmV0Y2ggVFggbGlzdCB0byBzY3JpcHQgZm9yIHJlZnVuZCBUWAogICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICBpc1JlZnVuZGVkOiB0cnVlLAogICAgICAgICAgICAgIGlzU3dhcEV4aXN0OiBmYWxzZQogICAgICAgICAgICB9LCB0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLndhcm4oJ05leHQgcmVmdW5kOicsIGVycm9yKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImlzUmVmdW5kU3VjY2VzcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIF9pc1JlZnVuZFN1Y2Nlc3MgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlOCgpIHsKICAgICAgICAgIHZhciBfdGhpcyRzdGF0ZSwgcmVmdW5kVHJhbnNhY3Rpb25IYXNoLCBpc1JlZnVuZGVkOwoKICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTgkKF9jb250ZXh0OCkgewogICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ4LnByZXYgPSBfY29udGV4dDgubmV4dCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBfdGhpcyRzdGF0ZSA9IHRoaXMuc3RhdGUsIHJlZnVuZFRyYW5zYWN0aW9uSGFzaCA9IF90aGlzJHN0YXRlLnJlZnVuZFRyYW5zYWN0aW9uSGFzaCwgaXNSZWZ1bmRlZCA9IF90aGlzJHN0YXRlLmlzUmVmdW5kZWQ7CgogICAgICAgICAgICAgICAgICBpZiAoIShyZWZ1bmRUcmFuc2FjdGlvbkhhc2ggJiYgaXNSZWZ1bmRlZCkpIHsKICAgICAgICAgICAgICAgICAgICBfY29udGV4dDgubmV4dCA9IDExOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBfY29udGV4dDgubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm5leHRTd2FwLmNoZWNrVFgocmVmdW5kVHJhbnNhY3Rpb25IYXNoKTsKCiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgIGlmICghX2NvbnRleHQ4LnNlbnQpIHsKICAgICAgICAgICAgICAgICAgICBfY29udGV4dDgubmV4dCA9IDg7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDguYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignTkVYVDJFVEhUT0tFTiAtIHVua25vd24gcmVmdW5kIHRyYW5zYWN0aW9uJyk7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgIHJlZnVuZFRyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgICAgICAgICAgICAgICBpc1JlZnVuZGVkOiBmYWxzZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OC5hYnJ1cHQoInJldHVybiIsIGZhbHNlKTsKCiAgICAgICAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ4LmFicnVwdCgicmV0dXJuIiwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ4LnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIF9jYWxsZWU4LCB0aGlzKTsKICAgICAgICB9KSk7CgogICAgICAgIGZ1bmN0aW9uIGlzUmVmdW5kU3VjY2VzcygpIHsKICAgICAgICAgIHJldHVybiBfaXNSZWZ1bmRTdWNjZXNzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNSZWZ1bmRTdWNjZXNzOwogICAgICB9KCkKICAgIH0sIHsKICAgICAga2V5OiAidHJ5V2l0aGRyYXciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfdHJ5V2l0aGRyYXcgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlOShfc2VjcmV0KSB7CiAgICAgICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgICAgICB2YXIgX3RoaXMkc3RhdGUyLCBzZWNyZXQsIHNlY3JldEhhc2gsIGlzRXRoV2l0aGRyYXduLCBfc2VjcmV0SGFzaCwgZmxvdywgZGF0YTsKCiAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU5JChfY29udGV4dDkpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0OS5wcmV2ID0gX2NvbnRleHQ5Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX3RoaXMkc3RhdGUyID0gdGhpcy5zdGF0ZSwgc2VjcmV0ID0gX3RoaXMkc3RhdGUyLnNlY3JldCwgc2VjcmV0SGFzaCA9IF90aGlzJHN0YXRlMi5zZWNyZXRIYXNoLCBpc0V0aFdpdGhkcmF3biA9IF90aGlzJHN0YXRlMi5pc0V0aFdpdGhkcmF3bjsKCiAgICAgICAgICAgICAgICAgIGlmIChfc2VjcmV0KSB7CiAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAzOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldpdGhkcmF3YWwgaXMgYXV0b21hdGljLiBGb3IgbWFudWFsIHdpdGhkcmF3YWwsIHByb3ZpZGUgYSBzZWNyZXQiKTsKCiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgIGlmIChzZWNyZXQgJiYgc2VjcmV0ICE9IF9zZWNyZXQpIGNvbnNvbGUud2FybigiU2VjcmV0IGFscmVhZHkga25vd24gYW5kIGlzIGRpZmZlcmVudC4gQXJlIHlvdSBzdXJlPyIpOwogICAgICAgICAgICAgICAgICBpZiAoaXNFdGhXaXRoZHJhd24pIGNvbnNvbGUud2FybigiTG9va3MgbGlrZSBtb25leSB3ZXJlIGFscmVhZHkgd2l0aGRyYXduLCBhcmUgeW91IHN1cmU/Iik7CiAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJXSVRIRFJBVyB1c2luZyBzZWNyZXQgPSAiLmNvbmNhdChfc2VjcmV0KSk7CiAgICAgICAgICAgICAgICAgIF9zZWNyZXRIYXNoID0gdGhpcy5hcHAuZW52LmJpdGNvaW4uY3J5cHRvLnJpcGVtZDE2MChCdWZmZXIuZnJvbShfc2VjcmV0LCAnaGV4JykpLnRvU3RyaW5nKCdoZXgnKTsKICAgICAgICAgICAgICAgICAgaWYgKHNlY3JldEhhc2ggIT0gX3NlY3JldEhhc2gpIGNvbnNvbGUud2FybigiSGFzaCBkb2VzIG5vdCBtYXRjaCEgc3RhdGU6ICIuY29uY2F0KHNlY3JldEhhc2gsICIsIGdpdmVuOiAiKS5jb25jYXQoX3NlY3JldEhhc2gpKTsKICAgICAgICAgICAgICAgICAgZmxvdyA9IHRoaXM7CiAgICAgICAgICAgICAgICAgIGRhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgb3duZXJBZGRyZXNzOiB0aGlzLmFwcC5nZXRQYXJ0aWNpcGFudEV0aEFkZHJlc3MoZmxvdy5zd2FwKSwKICAgICAgICAgICAgICAgICAgICBzZWNyZXQ6IF9zZWNyZXQKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAxMjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXRoVG9rZW5Td2FwLndpdGhkcmF3KGRhdGEsIGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoIlRYIGhhc2g9Ii5jb25jYXQoaGFzaCkpOwoKICAgICAgICAgICAgICAgICAgICBfdGhpczQuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgICAgZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBoYXNoLAogICAgICAgICAgICAgICAgICAgICAgY2FuQ3JlYXRlRXRoVHJhbnNhY3Rpb246IHRydWUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXM0LmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICAgICAgaXNFdGhXaXRoZHJhd246IHRydWUKICAgICAgICAgICAgICAgICAgICB9LCAnd2l0aGRyYXctZXRoJyk7CiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIF9jYWxsZWU5LCB0aGlzKTsKICAgICAgICB9KSk7CgogICAgICAgIGZ1bmN0aW9uIHRyeVdpdGhkcmF3KF94MikgewogICAgICAgICAgcmV0dXJuIF90cnlXaXRoZHJhdy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRyeVdpdGhkcmF3OwogICAgICB9KCkKICAgIH1dLCBbewogICAgICBrZXk6ICJnZXROYW1lIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldE5hbWUoKSB7CiAgICAgICAgcmV0dXJuICIiLmNvbmNhdCh0aGlzLmdldEZyb21OYW1lKCksICIyIikuY29uY2F0KHRoaXMuZ2V0VG9OYW1lKCkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldEZyb21OYW1lIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldEZyb21OYW1lKCkgewogICAgICAgIHJldHVybiBjb25zdGFudHMuQ09JTlMubmV4dDsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRUb05hbWUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0VG9OYW1lKCkgewogICAgICAgIHJldHVybiB0b2tlbk5hbWUudG9VcHBlckNhc2UoKTsKICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBORVhUMkVUSFRPS0VOOwogIH0oQXRvbWljQUIyVVRYTyk7CgogIHJldHVybiBORVhUMkVUSFRPS0VOOwp9KTs="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.flows/NEXT2ETHTOKEN.ts"],"names":["debug","constants","util","AtomicAB2UTXO","BigNumber","tokenName","NEXT2ETHTOKEN","swap","nextSwap","getRefundHexTransaction","scriptValues","state","nextScriptValues","secret","then","txHex","setState","refundTxHex","utxoCoin","_flowName","getName","stepNumbers","ethTokenSwap","ownerSwap","participantSwap","abBlockchain","utxoBlockchain","isUTXOSide","Error","step","isStoppedSwap","signTransactionHash","isSignFetching","isParticipantSigned","ethSwapCreationTransactionHash","secretHash","isBalanceFetching","isBalanceEnough","balance","isEthContractFunded","nextSwapWithdrawTransactionHash","ethSwapWithdrawTransactionHash","canCreateEthTransaction","isEthWithdrawn","refundTransactionHash","isRefunded","withdrawFee","isFinished","isSwapExist","_persistState","flow","signUTXOSide","syncBalance","onTransactionHash","txID","utxoScriptCreatingTransactionHash","utxoScriptValues","room","once","sendMessage","event","data","sellAmount","fundScript","amount","checkNEXTScriptBalance","createScript","scriptAddress","fetchUnspents","unspents","length","txid","getBalance","isEnoughMoney","isGreaterThanOrEqualTo","times","scriptBalance","div","dp","helpers","repeatAsyncUntilResult","stopRepeat","finishStep","isNextScriptFunded","waitAB2UTXOContract","withdrawFromAB2UTXO","refund","hash","error","test","console","warn","checkTX","_secret","_secretHash","app","env","bitcoin","crypto","ripemd160","Buffer","from","toString","ownerAddress","getParticipantEthAddress","withdraw","getFromName","getToName","COINS","next","toUpperCase"],"mappings":"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","sourcesContent":["import debug from 'debug'\r\nimport SwapApp, { constants, util } from 'swap.app'\r\nimport { AtomicAB2UTXO } from 'swap.swap'\r\nimport { BigNumber } from 'bignumber.js'\r\n\r\n\r\nexport default (tokenName) => {\r\n\r\n  class NEXT2ETHTOKEN extends AtomicAB2UTXO {\r\n\r\n    _flowName: string\r\n    ethTokenSwap: any\r\n    nextSwap: any\r\n    state: any\r\n\r\n    static getName() {\r\n      return `${this.getFromName()}2${this.getToName()}`\r\n    }\r\n    static getFromName() {\r\n      return constants.COINS.next\r\n    }\r\n    static getToName() {\r\n      return tokenName.toUpperCase()\r\n    }\r\n\r\n    constructor(swap) {\r\n      super(swap)\r\n      this.utxoCoin = `next`\r\n\r\n      this._flowName = NEXT2ETHTOKEN.getName()\r\n\r\n      this.stepNumbers = {\r\n        'sign': 1,\r\n        'submit-secret': 2,\r\n        'sync-balance': 3,\r\n        'lock-utxo': 4,\r\n        'wait-lock-eth': 5,\r\n        'withdraw-eth': 6,\r\n        'finish': 7,\r\n        'end': 8\r\n      }\r\n\r\n      this.ethTokenSwap = swap.ownerSwap\r\n      this.nextSwap      = swap.participantSwap\r\n\r\n      this.abBlockchain = this.ethTokenSwap\r\n      this.utxoBlockchain = this.nextSwap\r\n      this.isUTXOSide = true\r\n\r\n      if (!this.ethTokenSwap) {\r\n        throw new Error('NEXT2ETH: \"ethTokenSwap\" of type object required')\r\n      }\r\n      if (!this.nextSwap) {\r\n        throw new Error('NEXT2ETH: \"nextSwap\" of type object required')\r\n      }\r\n\r\n      this.state = {\r\n        step: 0,\r\n\r\n        isStoppedSwap: false,\r\n\r\n        signTransactionHash: null,\r\n        isSignFetching: false,\r\n        isParticipantSigned: false,\r\n\r\n        ethSwapCreationTransactionHash: null,\r\n\r\n        secretHash: null,\r\n\r\n        isBalanceFetching: false,\r\n        isBalanceEnough: true,\r\n        balance: null,\r\n\r\n        isEthContractFunded: false,\r\n\r\n        nextSwapWithdrawTransactionHash: null,\r\n        ethSwapWithdrawTransactionHash: null,\r\n\r\n        secret: null,\r\n\r\n        canCreateEthTransaction: true,\r\n        isEthWithdrawn: false,\r\n\r\n        refundTransactionHash: null,\r\n        isRefunded: false,\r\n\r\n        withdrawFee: null,\r\n        refundTxHex: null,\r\n        isFinished: false,\r\n        isSwapExist: false,\r\n      }\r\n\r\n      this._persistState()\r\n      super._persistSteps()\r\n    }\r\n\r\n    _persistState() {\r\n      super._persistState()\r\n    }\r\n\r\n    _getSteps() {\r\n      const flow = this\r\n\r\n      return [\r\n\r\n        // 1. Signs\r\n\r\n        async () => {\r\n          this.signUTXOSide()\r\n        },\r\n\r\n        // 2. Create secret, secret hash and NEXT script\r\n\r\n        () => {\r\n          // this.submitSecret()\r\n        },\r\n\r\n        // 3. Check system wallet balance\r\n\r\n        () => {\r\n          this.syncBalance()\r\n        },\r\n\r\n        // 4. Create NEXT Script, fund, notify participant\r\n\r\n        async () => {\r\n          const onTransactionHash = (txID) => {\r\n            const { utxoScriptCreatingTransactionHash, utxoScriptValues } = flow.state\r\n\r\n            if (utxoScriptCreatingTransactionHash) {\r\n              return\r\n            }\r\n\r\n            flow.setState({\r\n              utxoScriptCreatingTransactionHash: txID,\r\n            })\r\n\r\n            flow.swap.room.once('request utxo script', () => {\r\n              flow.swap.room.sendMessage({\r\n                event:  'create utxo script',\r\n                data: {\r\n                  scriptValues: utxoScriptValues,\r\n                  utxoScriptCreatingTransactionHash: txID,\r\n                }\r\n              })\r\n            })\r\n\r\n            flow.swap.room.sendMessage({\r\n              event: 'create utxo script',\r\n              data: {\r\n                scriptValues : utxoScriptValues,\r\n                utxoScriptCreatingTransactionHash : txID,\r\n              }\r\n            })\r\n          }\r\n\r\n          const { sellAmount } = flow.swap\r\n          const { isBalanceEnough, utxoScriptValues } = flow.state\r\n\r\n          if (isBalanceEnough) {\r\n            await flow.nextSwap.fundScript({\r\n              scriptValues: utxoScriptValues,\r\n              amount: sellAmount,\r\n            })\r\n          }\r\n\r\n          const checkNEXTScriptBalance = async () => {\r\n            const { scriptAddress } = this.nextSwap.createScript(utxoScriptValues)\r\n            const unspents = await this.nextSwap.fetchUnspents(scriptAddress)\r\n\r\n            if (unspents.length === 0) {\r\n              return false\r\n            }\r\n\r\n            const txID = unspents[0].txid\r\n\r\n            const balance = await this.nextSwap.getBalance(utxoScriptValues)\r\n\r\n            const isEnoughMoney = new BigNumber(balance).isGreaterThanOrEqualTo(sellAmount.times(1e8))\r\n\r\n            if (isEnoughMoney) {\r\n              flow.setState({\r\n                scriptBalance: new BigNumber(balance).div(1e8).dp(8),\r\n              })\r\n\r\n              onTransactionHash(txID)\r\n            }\r\n\r\n            return isEnoughMoney\r\n          }\r\n\r\n          await util.helpers.repeatAsyncUntilResult(async (stopRepeat) => {\r\n            const { isStoppedSwap } = flow.state\r\n\r\n            if (!isStoppedSwap) {\r\n              return await checkNEXTScriptBalance()\r\n            } else {\r\n              stopRepeat()\r\n            }\r\n          })\r\n\r\n          const { isStoppedSwap } = flow.state\r\n\r\n          if (!isStoppedSwap) {\r\n            flow.finishStep({\r\n              isNextScriptFunded: true,\r\n            }, { step: 'lock-utxo' })\r\n          }\r\n        },\r\n\r\n        // 5. Wait participant creates ETH Contract\r\n\r\n        async () => {\r\n          await this.ethTokenSwap.waitAB2UTXOContract({\r\n            flow,\r\n            utxoCoin: `next`,\r\n          })\r\n        },\r\n\r\n        // 6. Withdraw\r\n\r\n        async () => {\r\n          await flow.ethTokenSwap.withdrawFromAB2UTXO({ flow })\r\n        },\r\n\r\n        // 7. Finish\r\n\r\n        () => {\r\n          flow.swap.room.once('swap finished', ({nextSwapWithdrawTransactionHash}) => {\r\n            flow.setState({\r\n              nextSwapWithdrawTransactionHash,\r\n            })\r\n          })\r\n\r\n          flow.swap.room.sendMessage({\r\n            event: 'request swap finished',\r\n          })\r\n\r\n          flow.finishStep({\r\n            isFinished: true,\r\n          }, 'finish')\r\n        },\r\n\r\n        // 8. Finished!\r\n\r\n        () => {}\r\n      ]\r\n    }\r\n\r\n    async skipSyncBalance() {\r\n      this.finishStep({}, { step: 'sync-balance' })\r\n    }\r\n\r\n    getRefundTxHex = () => {\r\n      this.nextSwap.getRefundHexTransaction({\r\n        scriptValues: this.state.nextScriptValues,\r\n        secret: this.state.secret,\r\n      })\r\n        .then((txHex) => {\r\n          this.setState({\r\n            refundTxHex: txHex,\r\n          })\r\n        })\r\n    }\r\n\r\n    tryRefund() {\r\n      const flow = this\r\n      const { utxoScriptValues, secret } = flow.state\r\n\r\n      return flow.nextSwap.refund({\r\n        scriptValues: utxoScriptValues,\r\n        secret: secret,\r\n      })\r\n        .then((hash) => {\r\n          if (!hash) {\r\n            return false\r\n          }\r\n\r\n          this.swap.room.sendMessage({\r\n            event: 'utxo refund completed',\r\n          })\r\n\r\n          flow.setState({\r\n            refundTransactionHash: hash,\r\n            isRefunded: true,\r\n            isSwapExist: false,\r\n          }, true)\r\n\r\n          return true\r\n        })\r\n        .catch((error) => {\r\n          if (/Address is empty/.test(error)) {\r\n            // TODO - fetch TX list to script for refund TX\r\n            flow.setState({\r\n              isRefunded: true,\r\n              isSwapExist: false,\r\n            }, true)\r\n            return true\r\n          } else {\r\n            console.warn('Next refund:', error)\r\n\r\n            return false\r\n          }\r\n        })\r\n    }\r\n\r\n    async isRefundSuccess() {\r\n      const { refundTransactionHash, isRefunded } = this.state\r\n      if (refundTransactionHash && isRefunded) {\r\n        if (await this.nextSwap.checkTX(refundTransactionHash)) {\r\n          return true\r\n        } else {\r\n          console.warn('NEXT2ETHTOKEN - unknown refund transaction')\r\n          this.setState( {\r\n            refundTransactionHash: null,\r\n            isRefunded: false,\r\n          } )\r\n          return false\r\n        }\r\n      }\r\n      return false\r\n    }\r\n\r\n    async tryWithdraw(_secret) {\r\n      const { secret, secretHash, isEthWithdrawn } = this.state\r\n\r\n      if (!_secret)\r\n        throw new Error(`Withdrawal is automatic. For manual withdrawal, provide a secret`)\r\n\r\n      if (secret && secret != _secret)\r\n        console.warn(`Secret already known and is different. Are you sure?`)\r\n\r\n      if (isEthWithdrawn)\r\n        console.warn(`Looks like money were already withdrawn, are you sure?`)\r\n\r\n      debug('swap.core:flow')(`WITHDRAW using secret = ${_secret}`)\r\n\r\n      const _secretHash = this.app.env.bitcoin.crypto.ripemd160(Buffer.from(_secret, 'hex')).toString('hex')\r\n\r\n      if (secretHash != _secretHash)\r\n        console.warn(`Hash does not match! state: ${secretHash}, given: ${_secretHash}`)\r\n\r\n      const flow = this\r\n\r\n      const data = {\r\n        ownerAddress: this.app.getParticipantEthAddress(flow.swap),\r\n        secret: _secret,\r\n      }\r\n\r\n      await this.ethTokenSwap.withdraw(data, (hash) => {\r\n        debug('swap.core:flow')(`TX hash=${hash}`)\r\n        this.setState({\r\n          ethSwapWithdrawTransactionHash: hash,\r\n          canCreateEthTransaction: true,\r\n        })\r\n      }).then(() => {\r\n\r\n        this.finishStep({\r\n          isEthWithdrawn: true,\r\n        }, 'withdraw-eth')\r\n      })\r\n    }\r\n  }\r\n\r\n  return NEXT2ETHTOKEN\r\n}\r\n"]}]}