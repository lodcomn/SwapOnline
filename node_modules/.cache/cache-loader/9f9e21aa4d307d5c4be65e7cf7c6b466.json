{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\front\\shared\\redux\\actions\\btcmultisig.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\front\\shared\\redux\\actions\\btcmultisig.ts","mtime":1614852071282},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9kZWZpbmVQcm9wZXJ0eSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2RlZmluZVByb3BlcnR5IjsKaW1wb3J0IF90b0NvbnN1bWFibGVBcnJheSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL3RvQ29uc3VtYWJsZUFycmF5IjsKaW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXN5bmNUb0dlbmVyYXRvciI7CgpmdW5jdGlvbiBvd25LZXlzKG9iamVjdCwgZW51bWVyYWJsZU9ubHkpIHsgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmplY3QpOyBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgeyB2YXIgc3ltYm9scyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMob2JqZWN0KTsgaWYgKGVudW1lcmFibGVPbmx5KSBzeW1ib2xzID0gc3ltYm9scy5maWx0ZXIoZnVuY3Rpb24gKHN5bSkgeyByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHN5bSkuZW51bWVyYWJsZTsgfSk7IGtleXMucHVzaC5hcHBseShrZXlzLCBzeW1ib2xzKTsgfSByZXR1cm4ga2V5czsgfQoKZnVuY3Rpb24gX29iamVjdFNwcmVhZCh0YXJnZXQpIHsgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsgdmFyIHNvdXJjZSA9IGFyZ3VtZW50c1tpXSAhPSBudWxsID8gYXJndW1lbnRzW2ldIDoge307IGlmIChpICUgMikgeyBvd25LZXlzKE9iamVjdChzb3VyY2UpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsgX2RlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBzb3VyY2Vba2V5XSk7IH0pOyB9IGVsc2UgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMoc291cmNlKSk7IH0gZWxzZSB7IG93bktleXMoT2JqZWN0KHNvdXJjZSkpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc291cmNlLCBrZXkpKTsgfSk7IH0gfSByZXR1cm4gdGFyZ2V0OyB9CgppbXBvcnQgX3JlZ2VuZXJhdG9yUnVudGltZSBmcm9tICJAYmFiZWwvcnVudGltZS9yZWdlbmVyYXRvciI7Ci8vIEB0cy1ub2NoZWNrCmltcG9ydCBCaWdJbnRlZ2VyIGZyb20gJ2JpZ2knOwppbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdiaWdudW1iZXIuanMnOwppbXBvcnQgKiBhcyBiaXRjb2luIGZyb20gJ2JpdGNvaW5qcy1saWInOwppbXBvcnQgYml0Y29pbk1lc3NhZ2UgZnJvbSAnYml0Y29pbmpzLW1lc3NhZ2UnOwppbXBvcnQgeyBnZXRTdGF0ZSB9IGZyb20gJ3JlZHV4L2NvcmUnOwppbXBvcnQgcmVkdWNlcnMgZnJvbSAncmVkdXgvY29yZS9yZWR1Y2Vycyc7CmltcG9ydCB7IGFwaUxvb3BlciwgY29uc3RhbnRzIH0gZnJvbSAnaGVscGVycyc7CmltcG9ydCBidGMgZnJvbSAnaGVscGVycy9idGMnOwppbXBvcnQgYWN0aW9ucyBmcm9tICdyZWR1eC9hY3Rpb25zJzsKaW1wb3J0IGNvbmZpZyBmcm9tICdoZWxwZXJzL2V4dGVybmFsQ29uZmlnJzsKaW1wb3J0IFN3YXBBcHAgZnJvbSAnc3dhcC5hcHAnOwppbXBvcnQgeyBkZWZhdWx0IGFzIGJpdGNvaW5VdGlscyB9IGZyb20gJy4uLy4uLy4uLy4uL2NvbW1vbi91dGlscy9jb2luL2J0Yyc7CnZhciBCSVRQQVlfQVBJID0gewogIG5hbWU6ICdiaXRwYXknLAogIHNlcnZlcnM6IGNvbmZpZy5hcGkuYml0cGF5Cn07CnZhciBCTE9DWVBFUl9BUEkgPSB7CiAgbmFtZTogJ2Jsb2NrY3lwaGVyJywKICBzZXJ2ZXJzOiBjb25maWcuYXBpLmJsb2NrY3lwaGVyCn07CnZhciBoYXNBZG1pbkZlZSA9IGNvbmZpZyAmJiBjb25maWcub3B0cyAmJiBjb25maWcub3B0cy5mZWUgJiYgY29uZmlnLm9wdHMuZmVlLmJ0YyAmJiBjb25maWcub3B0cy5mZWUuYnRjLmZlZSAmJiBjb25maWcub3B0cy5mZWUuYnRjLmFkZHJlc3MgJiYgY29uZmlnLm9wdHMuZmVlLmJ0Yy5taW4gPyBjb25maWcub3B0cy5mZWUuYnRjIDogZmFsc2U7Cgp2YXIgYWRkcmVzc1RvV2FsbGV0ID0gZnVuY3Rpb24gYWRkcmVzc1RvV2FsbGV0KGFkZHJlc3MpIHsKICB2YXIgX2dldFN0YXRlID0gZ2V0U3RhdGUoKSwKICAgICAgbXNEYXRhID0gX2dldFN0YXRlLnVzZXIuYnRjTXVsdGlzaWdVc2VyRGF0YTsKCiAgaWYgKG1zRGF0YS5hZGRyZXNzID09PSBhZGRyZXNzKSByZXR1cm4gbXNEYXRhOwoKICBpZiAobXNEYXRhLndhbGxldHMgJiYgbXNEYXRhLndhbGxldHMubGVuZ3RoKSB7CiAgICB2YXIgZm91bmRlZCA9IG1zRGF0YS53YWxsZXRzLmZpbHRlcihmdW5jdGlvbiAod2FsbGV0KSB7CiAgICAgIHJldHVybiB3YWxsZXQuYWRkcmVzcyA9PT0gYWRkcmVzczsKICAgIH0pOwogICAgaWYgKGZvdW5kZWQubGVuZ3RoKSByZXR1cm4gZm91bmRlZFswXTsKICB9CgogIHJldHVybiBmYWxzZTsKfTsKCnZhciBnZXRTbXNLZXlGcm9tTW5lbW9uaWMgPSBmdW5jdGlvbiBnZXRTbXNLZXlGcm9tTW5lbW9uaWMobW5lbW9uaWMpIHsKICBpZiAobW5lbW9uaWMpIHsKICAgIHZhciBtbmVtb25pY1dhbGxldCA9IGFjdGlvbnMuYnRjLmdldFdhbGxldEJ5V29yZHMobW5lbW9uaWMsIDEpOwoKICAgIGlmIChtbmVtb25pY1dhbGxldCkgewogICAgICByZXR1cm4gbW5lbW9uaWNXYWxsZXQucHVibGljS2V5OwogICAgfQogIH0KfTsKCnZhciBfbG9hZEJ0Y011bHRpc2lnS2V5cyA9IGZ1bmN0aW9uIF9sb2FkQnRjTXVsdGlzaWdLZXlzKCkgewogIHZhciBzYXZlZEtleXMgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShjb25zdGFudHMucHJpdmF0ZUtleU5hbWVzLmJ0Y011bHRpc2lnT3RoZXJPd25lcktleSk7CgogIHRyeSB7CiAgICBzYXZlZEtleXMgPSBKU09OLnBhcnNlKHNhdmVkS2V5cyk7CiAgfSBjYXRjaCAoZSkge30gLy9ACgoKICBpZiAoIShzYXZlZEtleXMgaW5zdGFuY2VvZiBBcnJheSkpIHsKICAgIC8vQAogICAgc2F2ZWRLZXlzID0gW3NhdmVkS2V5c107CiAgfQoKICByZXR1cm4gc2F2ZWRLZXlzOwp9OwoKdmFyIHNpZ25Ub1VzZXJNdWx0aXNpZyA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgdmFyIF9yZWYgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgdmFyIF9nZXRTdGF0ZTIsIF9nZXRTdGF0ZTIkdXNlciwgYnRjTXVsdGlzaWdVc2VyRGF0YSwgaW5mb0Fib3V0Q3VycmVuY3ksIHdhbGxldEFkZHJlc2VzLCB3YWxsZXRzRGF0YSwgd2FsbGV0czsKCiAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUkKF9jb250ZXh0KSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dC5wcmV2ID0gX2NvbnRleHQubmV4dCkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBfZ2V0U3RhdGUyID0gZ2V0U3RhdGUoKSwgX2dldFN0YXRlMiR1c2VyID0gX2dldFN0YXRlMi51c2VyLCBidGNNdWx0aXNpZ1VzZXJEYXRhID0gX2dldFN0YXRlMiR1c2VyLmJ0Y011bHRpc2lnVXNlckRhdGEsIGluZm9BYm91dEN1cnJlbmN5ID0gX2dldFN0YXRlMiR1c2VyLmJ0Y011bHRpc2lnVXNlckRhdGEuaW5mb0Fib3V0Q3VycmVuY3k7CiAgICAgICAgICAgIHdhbGxldEFkZHJlc2VzID0gW107CiAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSA0OwogICAgICAgICAgICByZXR1cm4gZ2V0QnRjTXVsdGlzaWdLZXlzKHsKICAgICAgICAgICAgICBvcHRzOiB7CiAgICAgICAgICAgICAgICBkb250RmV0Y2hCYWxhbmNlOiB0cnVlCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHdhbGxldHNEYXRhID0gX2NvbnRleHQuc2VudDsKICAgICAgICAgICAgLy9ACiAgICAgICAgICAgIHdhbGxldHMgPSB3YWxsZXRzRGF0YS5tYXAoZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgYWRkcmVzczogZGF0YS5hZGRyZXNzLAogICAgICAgICAgICAgICAgY3VycmVuY3k6ICJCVEMgKE11bHRpc2lnKSIsCiAgICAgICAgICAgICAgICBmdWxsTmFtZTogIkJpdGNvaW4gKE11bHRpc2lnKSIsCiAgICAgICAgICAgICAgICBpbmZvQWJvdXRDdXJyZW5jeTogaW5mb0Fib3V0Q3VycmVuY3ksCiAgICAgICAgICAgICAgICBpc1VzZXJQcm90ZWN0ZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBhY3RpdmU6IHRydWUsCiAgICAgICAgICAgICAgICBiYWxhbmNlOiAwLAogICAgICAgICAgICAgICAgdW5jb25maXJtZWRCYWxhbmNlOiAwLAogICAgICAgICAgICAgICAgaXNCYWxhbmNlRmV0Y2hlZDogZmFsc2UsCiAgICAgICAgICAgICAgICBiYWxhbmNlRXJyb3I6IGZhbHNlLAogICAgICAgICAgICAgICAgcHVibGljS2V5czogZGF0YS5wdWJsaWNLZXlzLAogICAgICAgICAgICAgICAgcHVibGljS2V5OiBkYXRhLnB1YmxpY0tleSwKICAgICAgICAgICAgICAgIGlzQlRDOiB0cnVlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSkuZmlsdGVyKGZ1bmN0aW9uICh3YWxsZXQpIHsKICAgICAgICAgICAgICByZXR1cm4gd2FsbGV0LmFkZHJlc3MgIT09IGJ0Y011bHRpc2lnVXNlckRhdGEuYWRkcmVzczsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGJ0Y011bHRpc2lnVXNlckRhdGEud2FsbGV0cyA9IHdhbGxldHM7CiAgICAgICAgICAgIHJlZHVjZXJzLnVzZXIuc2V0QXV0aERhdGEoewogICAgICAgICAgICAgIG5hbWU6ICdidGNNdWx0aXNpZ1VzZXJEYXRhJywKICAgICAgICAgICAgICBkYXRhOiBidGNNdWx0aXNpZ1VzZXJEYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBmZXRjaE11bHRpc2lnQmFsYW5jZXMoKTsKCiAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgX2NhbGxlZSk7CiAgfSkpOwoKICByZXR1cm4gZnVuY3Rpb24gc2lnblRvVXNlck11bHRpc2lnKCkgewogICAgcmV0dXJuIF9yZWYuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Owp9KCk7Cgp2YXIgZmV0Y2hNdWx0aXNpZ0JhbGFuY2VzID0gZnVuY3Rpb24gZmV0Y2hNdWx0aXNpZ0JhbGFuY2VzKCkgewogIHZhciBfZ2V0U3RhdGUzID0gZ2V0U3RhdGUoKSwKICAgICAgd2FsbGV0cyA9IF9nZXRTdGF0ZTMudXNlci5idGNNdWx0aXNpZ1VzZXJEYXRhLndhbGxldHM7CgogIGlmICh3YWxsZXRzICYmIHdhbGxldHMubGVuZ3RoKSB7CiAgICB3YWxsZXRzLm1hcChmdW5jdGlvbiAoX3JlZjIsIGluZGV4KSB7CiAgICAgIHZhciBhZGRyZXNzID0gX3JlZjIuYWRkcmVzczsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfcmVmMyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyKHJlc29sdmUpIHsKICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIkKF9jb250ZXh0MikgewogICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyLnByZXYgPSBfY29udGV4dDIubmV4dCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBnZXRBZGRyQmFsYW5jZShhZGRyZXNzKS50aGVuKGZ1bmN0aW9uIChfcmVmNCkgewogICAgICAgICAgICAgICAgICAgIHZhciBiYWxhbmNlID0gX3JlZjQuYmFsYW5jZSwKICAgICAgICAgICAgICAgICAgICAgICAgdW5jb25maXJtZWRCYWxhbmNlID0gX3JlZjQudW5jb25maXJtZWRCYWxhbmNlOwogICAgICAgICAgICAgICAgICAgIHJlZHVjZXJzLnVzZXIuc2V0QnRjTXVsdGlzaWdCYWxhbmNlKHsKICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IGFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGJhbGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICBpc0JhbGFuY2VGZXRjaGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgdW5jb25maXJtZWRCYWxhbmNlOiB1bmNvbmZpcm1lZEJhbGFuY2UKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHsKICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IGFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICBiYWxhbmNlOiBiYWxhbmNlLAogICAgICAgICAgICAgICAgICAgICAgdW5jb25maXJtZWRCYWxhbmNlOiB1bmNvbmZpcm1lZEJhbGFuY2UKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfSlbImNhdGNoIl0oZnVuY3Rpb24gKGUpIHsvLwogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIF9jYWxsZWUyKTsKICAgICAgICB9KSk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoX3gpIHsKICAgICAgICAgIHJldHVybiBfcmVmMy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH07CiAgICAgIH0oKSk7CiAgICB9KTsKICB9Cn07Cgp2YXIgZ2V0QnRjTXVsdGlzaWdLZXlzID0gZnVuY3Rpb24gZ2V0QnRjTXVsdGlzaWdLZXlzKHBhcmFtcykgewogIHZhciBvcHRzID0ge307CiAgaWYgKHBhcmFtcyAmJiBwYXJhbXMub3B0cykgb3B0cyA9IHBhcmFtcy5vcHRzOwogIHJldHVybiBuZXcgUHJvbWlzZSggLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgIHZhciBfcmVmNSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUzKHJlc29sdmUsIHJlamVjdCkgewogICAgICB2YXIgX2dldFN0YXRlNCwgYnRjTXVsdGlzaWdVc2VyRGF0YSwgcHJpdmF0ZUtleSwgc2F2ZWRLZXlzLCBrZXlzSW5mbywgaSwgd2FsbGV0RGF0YTsKCiAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTMkKF9jb250ZXh0MykgewogICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0My5wcmV2ID0gX2NvbnRleHQzLm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIF9nZXRTdGF0ZTQgPSBnZXRTdGF0ZSgpLCBidGNNdWx0aXNpZ1VzZXJEYXRhID0gX2dldFN0YXRlNC51c2VyLmJ0Y011bHRpc2lnVXNlckRhdGE7CiAgICAgICAgICAgICAgcHJpdmF0ZUtleSA9IGJ0Y011bHRpc2lnVXNlckRhdGEucHJpdmF0ZUtleTsKICAgICAgICAgICAgICBzYXZlZEtleXMgPSBfbG9hZEJ0Y011bHRpc2lnS2V5cygpOwogICAgICAgICAgICAgIGtleXNJbmZvID0gW107CgogICAgICAgICAgICAgIGlmICghKHNhdmVkS2V5cy5sZW5ndGggPiAwKSkgewogICAgICAgICAgICAgICAgX2NvbnRleHQzLm5leHQgPSAyMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaSA9IDA7CgogICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgaWYgKCEoaSA8IHNhdmVkS2V5cy5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDIyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoIXNhdmVkS2V5c1tpXSkgewogICAgICAgICAgICAgICAgX2NvbnRleHQzLm5leHQgPSAxOTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgd2FsbGV0RGF0YSA9IGxvZ2luX1VTRVIocHJpdmF0ZUtleSwgc2F2ZWRLZXlzW2ldLCB0cnVlKTsKICAgICAgICAgICAgICB3YWxsZXREYXRhLmluZGV4ID0gaTsgLy9ACgogICAgICAgICAgICAgIGlmICghb3B0cy5kb250RmV0Y2hCYWxhbmNlKSB7CiAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDE0OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBfY29udGV4dDMudDAgPSAwOwogICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gMTc7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gMTY7CiAgICAgICAgICAgICAgcmV0dXJuIGZldGNoQmFsYW5jZSh3YWxsZXREYXRhLmFkZHJlc3MpOwoKICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgICBfY29udGV4dDMudDAgPSBfY29udGV4dDMuc2VudDsKCiAgICAgICAgICAgIGNhc2UgMTc6CiAgICAgICAgICAgICAgd2FsbGV0RGF0YS5iYWxhbmNlID0gX2NvbnRleHQzLnQwOwogICAgICAgICAgICAgIGtleXNJbmZvLnB1c2god2FsbGV0RGF0YSk7CgogICAgICAgICAgICBjYXNlIDE5OgogICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDY7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIDIyOgogICAgICAgICAgICAgIHJlc29sdmUoa2V5c0luZm8pOwoKICAgICAgICAgICAgY2FzZSAyMzoKICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLnN0b3AoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIF9jYWxsZWUzKTsKICAgIH0pKTsKCiAgICByZXR1cm4gZnVuY3Rpb24gKF94MiwgX3gzKSB7CiAgICAgIHJldHVybiBfcmVmNS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICB9KCkpOwp9OwoKdmFyIGFkZEJ0Y011bHRpc2lnS2V5ID0gZnVuY3Rpb24gYWRkQnRjTXVsdGlzaWdLZXkocHVibGljS2V5LCBpc1ByaW1hcnkpIHsKICB2YXIgc2F2ZWRLZXlzID0gX2xvYWRCdGNNdWx0aXNpZ0tleXMoKTsKCiAgaWYgKCFzYXZlZEtleXMuaW5jbHVkZXMocHVibGljS2V5KSkgewogICAgLy9ACiAgICBzYXZlZEtleXMucHVzaChwdWJsaWNLZXkpOwogIH0KCiAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oY29uc3RhbnRzLnByaXZhdGVLZXlOYW1lcy5idGNNdWx0aXNpZ090aGVyT3duZXJLZXksIEpTT04uc3RyaW5naWZ5KHNhdmVkS2V5cykpOwogIGlmIChpc1ByaW1hcnkpIHN3aXRjaEJ0Y011bHRpc2lnS2V5KHB1YmxpY0tleSk7Cn07Cgp2YXIgc3dpdGNoQnRjTXVsdGlzaWdLZXkgPSBmdW5jdGlvbiBzd2l0Y2hCdGNNdWx0aXNpZ0tleShrZXlPckluZGV4KSB7CiAgdmFyIHNhdmVkS2V5cyA9IF9sb2FkQnRjTXVsdGlzaWdLZXlzKCk7CgogIHZhciBpbmRleCA9IGtleU9ySW5kZXg7CiAgaWYgKCFOdW1iZXIuaXNJbnRlZ2VyKGluZGV4KSkgaW5kZXggPSBzYXZlZEtleXMuaW5kZXhPZihrZXlPckluZGV4KTsKCiAgaWYgKGluZGV4ID4gLTEgJiYgaW5kZXggPCBzYXZlZEtleXMubGVuZ3RoKSB7CiAgICBpZiAoaW5kZXggIT09IDApIHsKICAgICAgLy9ACiAgICAgIHZhciBuZXdLZXkgPSBzYXZlZEtleXMuc3BsaWNlKGluZGV4LCAxKTsgLy9ACgogICAgICBzYXZlZEtleXMudW5zaGlmdChuZXdLZXlbMF0pOwogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShjb25zdGFudHMucHJpdmF0ZUtleU5hbWVzLmJ0Y011bHRpc2lnT3RoZXJPd25lcktleSwgSlNPTi5zdHJpbmdpZnkoc2F2ZWRLZXlzKSk7CgogICAgICB2YXIgX2dldFN0YXRlNSA9IGdldFN0YXRlKCksCiAgICAgICAgICBwcml2YXRlS2V5ID0gX2dldFN0YXRlNS51c2VyLmJ0Y0RhdGEucHJpdmF0ZUtleTsgLy9ACgoKICAgICAgbG9naW5fVVNFUihwcml2YXRlS2V5LCBuZXdLZXlbMF0pOyAvL0AKCiAgICAgIGdldEJhbGFuY2VVc2VyKCk7CiAgICB9CiAgfQp9OwoKdmFyIHJlbW92ZUJ0Y011bHRpc2lnTmV5ID0gZnVuY3Rpb24gcmVtb3ZlQnRjTXVsdGlzaWdOZXkoa2V5T3JJbmRleCkgewogIHZhciBzYXZlZEtleXMgPSBfbG9hZEJ0Y011bHRpc2lnS2V5cygpOwoKICB2YXIgaW5kZXggPSBrZXlPckluZGV4OwogIGlmICghTnVtYmVyLmlzSW50ZWdlcihpbmRleCkpIGluZGV4ID0gc2F2ZWRLZXlzLmluZGV4T2Yoa2V5T3JJbmRleCk7CgogIGlmIChpbmRleCA+IC0xKSB7CiAgICAvL0AKICAgIHZhciBuZXdLZXkgPSBzYXZlZEtleXMuc3BsaWNlKGluZGV4LCAxKTsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGNvbnN0YW50cy5wcml2YXRlS2V5TmFtZXMuYnRjTXVsdGlzaWdPdGhlck93bmVyS2V5LCBKU09OLnN0cmluZ2lmeShzYXZlZEtleXMpKTsKCiAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgc3dpdGNoQnRjTXVsdGlzaWdLZXkoMCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KfTsKCnZhciBjaGVja1NNU0FjdGl2YXRlZCA9IGZ1bmN0aW9uIGNoZWNrU01TQWN0aXZhdGVkKCkgewogIHZhciBfZ2V0U3RhdGU2ID0gZ2V0U3RhdGUoKSwKICAgICAgaXNSZWdpc3RlcmVkID0gX2dldFN0YXRlNi51c2VyLmJ0Y011bHRpc2lnU01TRGF0YS5pc1JlZ2lzdGVyZWQ7CgogIHJldHVybiBpc1JlZ2lzdGVyZWQ7Cn07Cgp2YXIgY2hlY2tQSU5BY3RpdmF0ZWQgPSBmdW5jdGlvbiBjaGVja1BJTkFjdGl2YXRlZCgpIHsKICB2YXIgX2dldFN0YXRlNyA9IGdldFN0YXRlKCksCiAgICAgIGlzUmVnaXN0ZXJlZCA9IF9nZXRTdGF0ZTcudXNlci5idGNNdWx0aXNpZ1BpbkRhdGEuaXNSZWdpc3RlcmVkOwoKICByZXR1cm4gaXNSZWdpc3RlcmVkOwp9OwoKdmFyIGNoZWNrRzJGQUFjdGl2YXRlZCA9IGZ1bmN0aW9uIGNoZWNrRzJGQUFjdGl2YXRlZCgpIHsKICByZXR1cm4gZmFsc2U7Cn07Cgp2YXIgY2hlY2tVc2VyQWN0aXZhdGVkID0gZnVuY3Rpb24gY2hlY2tVc2VyQWN0aXZhdGVkKCkgewogIHZhciBfZ2V0U3RhdGU4ID0gZ2V0U3RhdGUoKSwKICAgICAgYWN0aXZlID0gX2dldFN0YXRlOC51c2VyLmJ0Y011bHRpc2lnVXNlckRhdGEuYWN0aXZlOwoKICByZXR1cm4gYWN0aXZlOwp9OwoKdmFyIGlzQlRDU01TQWRkcmVzcyA9IGZ1bmN0aW9uIGlzQlRDU01TQWRkcmVzcyhhZGRyZXNzKSB7CiAgdmFyIF9nZXRTdGF0ZTkgPSBnZXRTdGF0ZSgpLAogICAgICBfZ2V0U3RhdGU5JHVzZXIgPSBfZ2V0U3RhdGU5LnVzZXIsCiAgICAgIGJ0Y0RhdGEgPSBfZ2V0U3RhdGU5JHVzZXIuYnRjRGF0YSwKICAgICAgYnRjTXVsdGlzaWdTTVNEYXRhID0gX2dldFN0YXRlOSR1c2VyLmJ0Y011bHRpc2lnU01TRGF0YTsKCiAgaWYgKGJ0Y011bHRpc2lnU01TRGF0YSAmJiBidGNNdWx0aXNpZ1NNU0RhdGEuYWRkcmVzcyAmJiBidGNNdWx0aXNpZ1NNU0RhdGEuYWRkcmVzcy50b0xvd2VyQ2FzZSgpID09PSBhZGRyZXNzLnRvTG93ZXJDYXNlKCkpIHJldHVybiBidGNNdWx0aXNpZ1NNU0RhdGE7CiAgcmV0dXJuIGZhbHNlOwp9OwoKdmFyIGlzQlRDTVNVc2VyQWRkcmVzcyA9IGZ1bmN0aW9uIGlzQlRDTVNVc2VyQWRkcmVzcyhhZGRyZXNzKSB7CiAgdmFyIF9nZXRTdGF0ZTEwID0gZ2V0U3RhdGUoKSwKICAgICAgbXNEYXRhID0gX2dldFN0YXRlMTAudXNlci5idGNNdWx0aXNpZ1VzZXJEYXRhOwoKICBpZiAobXNEYXRhLmFkZHJlc3MgPT09IGFkZHJlc3MpIHJldHVybiB0cnVlOwoKICBpZiAobXNEYXRhLndhbGxldHMgJiYgbXNEYXRhLndhbGxldHMubGVuZ3RoKSB7CiAgICB2YXIgZm91bmRlZCA9IG1zRGF0YS53YWxsZXRzLmZpbHRlcihmdW5jdGlvbiAod2FsbGV0KSB7CiAgICAgIHJldHVybiB3YWxsZXQuYWRkcmVzcyA9PT0gYWRkcmVzczsKICAgIH0pOwogICAgaWYgKGZvdW5kZWQubGVuZ3RoKSByZXR1cm4gdHJ1ZTsKICB9CgogIHJldHVybiBmYWxzZTsKfTsgLy8gQFRvRG8gLSBSZW1vdmUuCgoKdmFyIGlzQlRDQWRkcmVzcyA9IGZ1bmN0aW9uIGlzQlRDQWRkcmVzcyhhZGRyZXNzKSB7CiAgY29uc29sZS53YXJuKCJEZXByZWNhdGVkIGNhbGwgaXNCVENBZGRyZXNzIik7CiAgcmV0dXJuIGFjdGlvbnMuYnRjLmdldERhdGFCeUFkZHJlc3MoYWRkcmVzcyk7CiAgLypjb25zdCB7DQogICAgdXNlcjogew0KICAgICAgYnRjRGF0YSwNCiAgICAgIGJ0Y01uZW1vbmljRGF0YSwNCiAgICAgIGJ0Y011bHRpc2lnU01TRGF0YSwNCiAgICAgIGJ0Y011bHRpc2lnVXNlckRhdGEsDQogICAgICBidGNNdWx0aXNpZ0cyRkFEYXRhLA0KICAgIH0sDQogIH0gPSBnZXRTdGF0ZSgpDQogICAgaWYgKGJ0Y0RhdGEgJiYgYnRjRGF0YS5hZGRyZXNzICYmIGJ0Y0RhdGEuYWRkcmVzcy50b0xvd2VyQ2FzZSgpID09PSBhZGRyZXNzLnRvTG93ZXJDYXNlKCkpIHJldHVybiBidGNEYXRhDQogIGlmIChidGNNbmVtb25pY0RhdGEgJiYgYnRjTW5lbW9uaWNEYXRhLmFkZHJlc3MgJiYgYnRjTW5lbW9uaWNEYXRhLmFkZHJlc3MudG9Mb3dlckNhc2UoKSA9PT0gYWRkcmVzcy50b0xvd2VyQ2FzZSgpKSByZXR1cm4gYnRjTW5lbW9uaWNEYXRhIC8vIFN3ZWVwDQogIGlmIChidGNNdWx0aXNpZ1NNU0RhdGEgJiYgYnRjTXVsdGlzaWdTTVNEYXRhLmFkZHJlc3MgJiYgYnRjTXVsdGlzaWdTTVNEYXRhLmFkZHJlc3MudG9Mb3dlckNhc2UoKSA9PT0gYWRkcmVzcy50b0xvd2VyQ2FzZSgpKSByZXR1cm4gYnRjTXVsdGlzaWdTTVNEYXRhDQogIGlmIChidGNNdWx0aXNpZ1VzZXJEYXRhICYmIGJ0Y011bHRpc2lnVXNlckRhdGEuYWRkcmVzcyAmJiBidGNNdWx0aXNpZ1VzZXJEYXRhLmFkZHJlc3MudG9Mb3dlckNhc2UoKSA9PT0gYWRkcmVzcy50b0xvd2VyQ2FzZSgpKSByZXR1cm4gYnRjTXVsdGlzaWdVc2VyRGF0YQ0KICBpZiAoYnRjTXVsdGlzaWdHMkZBRGF0YSAmJiBidGNNdWx0aXNpZ0cyRkFEYXRhLmFkZHJlc3MgJiYgYnRjTXVsdGlzaWdHMkZBRGF0YS5hZGRyZXNzLnRvTG93ZXJDYXNlKCkgPT09IGFkZHJlc3MudG9Mb3dlckNhc2UoKSkgcmV0dXJuIGJ0Y011bHRpc2lnRzJGQURhdGENCiAgICByZXR1cm4gZmFsc2UqLwp9OwoKdmFyIGNyZWF0ZVdhbGxldCA9IGZ1bmN0aW9uIGNyZWF0ZVdhbGxldChwcml2YXRlS2V5LCBvdGhlck93bmVyUHVibGljS2V5KSB7CiAgLy8gcHJpdmF0ZUtleSAtIGtleSBvZiBvdXIgcHJpdmFyeSBvbmUtc2lnbiBidGMgd2FsbGV0CiAgdmFyIGtleVBhaXI7CgogIGlmIChwcml2YXRlS2V5KSB7CiAgICB2YXIgaGFzaCA9IGJpdGNvaW4uY3J5cHRvLnNoYTI1Nihwcml2YXRlS2V5KTsKICAgIHZhciBkID0gQmlnSW50ZWdlci5mcm9tQnVmZmVyKGhhc2gpOwogICAga2V5UGFpciA9IGJpdGNvaW4uRUNQYWlyLmZyb21XSUYocHJpdmF0ZUtleSwgYnRjLm5ldHdvcmspOwogIH0gZWxzZSB7CiAgICBjb25zb2xlLmVycm9yKCdSZXF1ZXJ5IHByaXZhdGVLZXknKTsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIHZhciBhY2NvdW50ID0gYml0Y29pbi5FQ1BhaXIuZnJvbVdJRihwcml2YXRlS2V5LCBidGMubmV0d29yayk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUKICAvL0AKCiAgdmFyIF9iaXRjb2luJHBheW1lbnRzJHAydyA9IGJpdGNvaW4ucGF5bWVudHMucDJ3cGtoKHsKICAgIHB1YmtleTogYWNjb3VudC5wdWJsaWNLZXksCiAgICBuZXR3b3JrOiBidGMubmV0d29yawogIH0pLAogICAgICBhZGRyZXNzT2ZNeU93bldhbGxldCA9IF9iaXRjb2luJHBheW1lbnRzJHAydy5hZGRyZXNzT2ZNeU93bldhbGxldDsKCiAgdmFyIHB1YmxpY0tleSA9IGFjY291bnQucHVibGljS2V5OwogIHZhciBwdWJsaWNLZXlzUmF3ID0gW290aGVyT3duZXJQdWJsaWNLZXksIGFjY291bnQucHVibGljS2V5LnRvU3RyaW5nKCdoZXgnKV0uc29ydCgpLnJldmVyc2UoKTsKICB2YXIgcHVibGljS2V5cyA9IHB1YmxpY0tleXNSYXcubWFwKGZ1bmN0aW9uIChoZXgpIHsKICAgIHJldHVybiBCdWZmZXIuZnJvbShoZXgsICdoZXgnKTsKICB9KTsKICB2YXIgcDJtcyA9IGJpdGNvaW4ucGF5bWVudHMucDJtcyh7CiAgICBtOiAyLAogICAgbjogMiwKICAgIHB1YmtleXM6IHB1YmxpY0tleXMsCiAgICBuZXR3b3JrOiBidGMubmV0d29yawogIH0pOwogIHZhciBwMnNoID0gYml0Y29pbi5wYXltZW50cy5wMnNoKHsKICAgIHJlZGVlbTogcDJtcywKICAgIG5ldHdvcms6IGJ0Yy5uZXR3b3JrCiAgfSk7CiAgdmFyIGFkZHJlc3MgPSBwMnNoLmFkZHJlc3M7CiAgdmFyIGRhdGEgPSB7CiAgICBhY2NvdW50OiBhY2NvdW50LAogICAga2V5UGFpcjoga2V5UGFpciwKICAgIGFkZHJlc3M6IGFkZHJlc3MsCiAgICBhZGRyZXNzT2ZNeU93bldhbGxldDogYWRkcmVzc09mTXlPd25XYWxsZXQsCiAgICBjdXJyZW5jeTogJ0JUQyAoTXVsdGlzaWcpJywKICAgIGZ1bGxOYW1lOiAnQml0Y29pbiAoTXVsdGlzaWcpJywKICAgIHByaXZhdGVLZXk6IHByaXZhdGVLZXksCiAgICBwdWJsaWNLZXlzOiBwdWJsaWNLZXlzLAogICAgcHVibGljS2V5OiBwdWJsaWNLZXksCiAgICBpc0JUQzogdHJ1ZQogIH07CiAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oY29uc3RhbnRzLnByaXZhdGVLZXlOYW1lcy5idGNNdWx0aXNpZ090aGVyT3duZXJLZXksIG90aGVyT3duZXJQdWJsaWNLZXkpOwoKICB3aW5kb3cuZ2V0QnRjTXVsdGlzaWdEYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGRhdGE7CiAgfTsKCiAgd2luZG93LmdldEJ0Y011bHRpc2lnQWRkcmVzcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBkYXRhLmFkZHJlc3M7CiAgfTsKCiAgY29uc29sZS5pbmZvKCdMb2dnZWQgaW4gd2l0aCBCaXRjb2luTXVsdGlzaWcnLCBkYXRhKTsKICByZWR1Y2Vycy51c2VyLnNldEF1dGhEYXRhKHsKICAgIG5hbWU6ICdidGNNdWx0aXNpZ0RhdGEnLAogICAgZGF0YTogZGF0YQogIH0pOwp9OwoKdmFyIGxvZ2luX1NNUyA9IGZ1bmN0aW9uIGxvZ2luX1NNUyhwcml2YXRlS2V5LCBvdGhlck93bmVyUHVibGljS2V5KSB7CiAgdmFyIGRhdGEgPSBsb2dpbl8ocHJpdmF0ZUtleSwgb3RoZXJPd25lclB1YmxpY0tleSwgZmFsc2UpOwogIGlmICghZGF0YSkgcmV0dXJuIGZhbHNlOwogIHZhciBpc1JlZ2lzdGVyZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiIi5jb25jYXQoY29uc3RhbnRzLmxvY2FsU3RvcmFnZS5kaWRQcm90ZWN0ZWRCdGNDcmVhdGVkLCAiOiIpLmNvbmNhdChkYXRhLmFkZHJlc3MpKSA9PT0gJzEnOwogIGRhdGEuY3VycmVuY3kgPSAnQlRDIChTTVMtUHJvdGVjdGVkKSc7CiAgZGF0YS5mdWxsTmFtZSA9ICdCaXRjb2luIChTTVMtUHJvdGVjdGVkKSc7CiAgZGF0YS5pc1JlZ2lzdGVyZWQgPSBvdGhlck93bmVyUHVibGljS2V5IGluc3RhbmNlb2YgQXJyYXkgJiYgb3RoZXJPd25lclB1YmxpY0tleS5sZW5ndGggPiAxID8gdHJ1ZSA6IGlzUmVnaXN0ZXJlZDsKICBkYXRhLmlzU21zUHJvdGVjdGVkID0gdHJ1ZTsKCiAgd2luZG93LmdldEJ0Y1Ntc0RhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gZGF0YTsKICB9OwoKICByZWR1Y2Vycy51c2VyLnNldEF1dGhEYXRhKHsKICAgIG5hbWU6ICdidGNNdWx0aXNpZ1NNU0RhdGEnLAogICAgZGF0YTogZGF0YQogIH0pOwp9OwoKdmFyIGxvZ2luX1BJTiA9IGZ1bmN0aW9uIGxvZ2luX1BJTihwcml2YXRlS2V5LCBvdGhlck93bmVyUHVibGljS2V5KSB7CiAgdmFyIGRhdGEgPSBsb2dpbl8ocHJpdmF0ZUtleSwgb3RoZXJPd25lclB1YmxpY0tleSwgZmFsc2UpOwogIGlmICghZGF0YSkgcmV0dXJuIGZhbHNlOwogIHZhciBpc1JlZ2lzdGVyZWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiIi5jb25jYXQoY29uc3RhbnRzLmxvY2FsU3RvcmFnZS5kaWRQaW5CdGNDcmVhdGVkLCAiOiIpLmNvbmNhdChkYXRhLmFkZHJlc3MpKSA9PT0gJzEnOwogIGRhdGEuY3VycmVuY3kgPSAnQlRDIChQSU4tUHJvdGVjdGVkKSc7CiAgZGF0YS5mdWxsTmFtZSA9ICdCaXRjb2luIChQSU4tUHJvdGVjdGVkKSc7CiAgZGF0YS5pc1JlZ2lzdGVyZWQgPSBvdGhlck93bmVyUHVibGljS2V5IGluc3RhbmNlb2YgQXJyYXkgJiYgb3RoZXJPd25lclB1YmxpY0tleS5sZW5ndGggPiAxID8gdHJ1ZSA6IGlzUmVnaXN0ZXJlZDsKICBkYXRhLmlzUGluUHJvdGVjdGVkID0gdHJ1ZTsKCiAgd2luZG93LmdldEJ0Y1BpbkRhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gZGF0YTsKICB9OwoKICByZWR1Y2Vycy51c2VyLnNldEF1dGhEYXRhKHsKICAgIG5hbWU6ICdidGNNdWx0aXNpZ1BpbkRhdGEnLAogICAgZGF0YTogZGF0YQogIH0pOwp9OwoKdmFyIGxvZ2luX0cyRkEgPSBmdW5jdGlvbiBsb2dpbl9HMkZBKHByaXZhdGVLZXksIG90aGVyT3duZXJQdWJsaWNLZXkpIHsKICB2YXIgZGF0YSA9IGxvZ2luXyhwcml2YXRlS2V5LCBvdGhlck93bmVyUHVibGljS2V5LCBmYWxzZSk7CiAgaWYgKCFkYXRhKSByZXR1cm4gZmFsc2U7CiAgdmFyIGlzUmVnaXN0ZXJlZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCIiLmNvbmNhdChjb25zdGFudHMubG9jYWxTdG9yYWdlLmRpZFByb3RlY3RlZEJ0Y0cyRkFDcmVhdGVkLCAiOiIpLmNvbmNhdChkYXRhLmFkZHJlc3MpKSA9PT0gJzEnOwogIGRhdGEuY3VycmVuY3kgPSAnQlRDIChHb29nbGUgMkZBKSc7CiAgZGF0YS5mdWxsTmFtZSA9ICdCaXRjb2luIChHb29nbGUgMkZBKSc7CiAgZGF0YS5pc1JlZ2lzdGVyZWQgPSBpc1JlZ2lzdGVyZWQ7CiAgZGF0YS5pc0cyRkFQcm90ZWN0ZWQgPSB0cnVlOwogIHJlZHVjZXJzLnVzZXIuc2V0QXV0aERhdGEoewogICAgbmFtZTogJ2J0Y011bHRpc2lnRzJGQURhdGEnLAogICAgZGF0YTogZGF0YQogIH0pOwp9OwoKdmFyIGxvZ2luX1VTRVIgPSBmdW5jdGlvbiBsb2dpbl9VU0VSKHByaXZhdGVLZXksIG90aGVyT3duZXJQdWJsaWNLZXksIG9ubHlDaGVjaykgewogIGlmIChvdGhlck93bmVyUHVibGljS2V5IGluc3RhbmNlb2YgQXJyYXkgJiYgb3RoZXJPd25lclB1YmxpY0tleS5sZW5ndGggPT09IDApIHJldHVybjsKICB2YXIgZGF0YSA9IGxvZ2luXyhwcml2YXRlS2V5LCBvdGhlck93bmVyUHVibGljS2V5IGluc3RhbmNlb2YgQXJyYXkgPyBvdGhlck93bmVyUHVibGljS2V5WzBdIDogb3RoZXJPd25lclB1YmxpY0tleSwgdHJ1ZSk7CiAgaWYgKCFkYXRhKSByZXR1cm4gZmFsc2U7CiAgZGF0YS5pc1VzZXJQcm90ZWN0ZWQgPSB0cnVlOwogIGlmIChvbmx5Q2hlY2spIHJldHVybiBkYXRhOwogIHJlZHVjZXJzLnVzZXIuc2V0QXV0aERhdGEoewogICAgbmFtZTogJ2J0Y011bHRpc2lnVXNlckRhdGEnLAogICAgZGF0YTogZGF0YQogIH0pOyAvLyBTZXR1cCBwdWJzdWJSb29tIHNpZ24gcmVxdWVzdAoKICBhY3Rpb25zLnB1YnN1YlJvb20ub25SZWFkeShmdW5jdGlvbiAoKSB7CiAgICB2YXIgX2dldFN0YXRlMTEgPSBnZXRTdGF0ZSgpLAogICAgICAgIGFkZHJlc3MgPSBfZ2V0U3RhdGUxMS51c2VyLmJ0Y011bHRpc2lnVXNlckRhdGEuYWRkcmVzczsKCiAgICB2YXIgb25SZXF1ZXN0RXZlbnROYW1lID0gImJ0YyBtdWx0aXNpZyByZXF1ZXN0IHNpZ24gIi5jb25jYXQoYWRkcmVzcyk7CiAgICBTd2FwQXBwLnNoYXJlZCgpLnNlcnZpY2VzLnJvb20uc3Vic2NyaWJlKG9uUmVxdWVzdEV2ZW50TmFtZSwgZnVuY3Rpb24gKF9kYXRhKSB7CiAgICAgIHZhciB0eERhdGEgPSBfZGF0YS50eERhdGE7CgogICAgICBpZiAodHhEYXRhICYmIHR4RGF0YS5hZGRyZXNzICYmIHR4RGF0YS5hbW91bnQgJiYgdHhEYXRhLmN1cnJlbmN5ICYmIHR4RGF0YS50eFJhdykgewogICAgICAgIFN3YXBBcHAuc2hhcmVkKCkuc2VydmljZXMucm9vbS5zZW5kTWVzc2FnZVBlZXIoX2RhdGEuZnJvbVBlZXIsIHsKICAgICAgICAgIGV2ZW50OiAiYnRjIG11bHRpc2lnIGFjY2VwdCB0eCAiLmNvbmNhdChhZGRyZXNzKSwKICAgICAgICAgIGRhdGE6IHt9CiAgICAgICAgfSk7CiAgICAgICAgYWN0aW9ucy5ub3RpZmljYXRpb25zLnNob3coJ0JUQ011bHRpc2lnblJlcXVlc3QnLCB0eERhdGEpOwogICAgICAgIGFjdGlvbnMubW9kYWxzLm9wZW4oY29uc3RhbnRzLm1vZGFscy5CdGNNdWx0aXNpZ25Db25maXJtVHgsIHsKICAgICAgICAgIHR4RGF0YTogdHhEYXRhLnR4UmF3CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH0pOwp9OwoKdmFyIGxvZ2luXyA9IGZ1bmN0aW9uIGxvZ2luXyhwcml2YXRlS2V5LCBvdGhlck93bmVyUHVibGljS2V5LCBzb3J0S2V5cykgewogIHZhciBrZXlQYWlyOwoKICBpZiAocHJpdmF0ZUtleSkgewogICAgdmFyIGhhc2ggPSBiaXRjb2luLmNyeXB0by5zaGEyNTYocHJpdmF0ZUtleSk7CiAgICB2YXIgZCA9IEJpZ0ludGVnZXIuZnJvbUJ1ZmZlcihoYXNoKTsKICAgIGtleVBhaXIgPSBiaXRjb2luLkVDUGFpci5mcm9tV0lGKHByaXZhdGVLZXksIGJ0Yy5uZXR3b3JrKTsKICB9IGVsc2UgewogICAgY29uc29sZS5sb2coJ1JlcXVlcnkgcHJpdmF0ZUtleScpOwogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgdmFyIGFjY291bnQgPSBiaXRjb2luLkVDUGFpci5mcm9tV0lGKHByaXZhdGVLZXksIGJ0Yy5uZXR3b3JrKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZQoKICB2YXIgcHVibGljS2V5ID0gYWNjb3VudC5wdWJsaWNLZXk7CiAgdmFyIHB1YmxpY0tleV8xID0gYWNjb3VudC5wdWJsaWNLZXkudG9TdHJpbmcoJ2hleCcpOyAvLyBUT0RPIC0gc2ltcGxlIHNvcnQgcHVibGljIGtleXMgYnkgQUJDIC0gbm8gcHJpbWFyeSBhbmQgc2Vjb25kYXJ5CgogIHZhciBfZGF0YTsKCiAgaWYgKG90aGVyT3duZXJQdWJsaWNLZXkpIHsKICAgIHZhciBwdWJsaWNLZXlzUmF3ID0gW107CgogICAgaWYgKG90aGVyT3duZXJQdWJsaWNLZXkgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICBvdGhlck93bmVyUHVibGljS2V5LmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAgIHB1YmxpY0tleXNSYXcucHVzaChrZXkpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHB1YmxpY0tleXNSYXcucHVzaChvdGhlck93bmVyUHVibGljS2V5KTsKICAgIH0KCiAgICBwdWJsaWNLZXlzUmF3LnB1c2gocHVibGljS2V5XzEpOwogICAgaWYgKHNvcnRLZXlzKSBwdWJsaWNLZXlzUmF3ID0gcHVibGljS2V5c1Jhdy5zb3J0KCk7CiAgICB2YXIgcHVibGljS2V5cyA9IHB1YmxpY0tleXNSYXcubWFwKGZ1bmN0aW9uIChoZXgpIHsKICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKGhleCwgJ2hleCcpOwogICAgfSk7CiAgICB2YXIgcDJtcyA9IGJpdGNvaW4ucGF5bWVudHMucDJtcyh7CiAgICAgIG06IDIsCiAgICAgIG46IHB1YmxpY0tleXNSYXcubGVuZ3RoLAogICAgICBwdWJrZXlzOiBwdWJsaWNLZXlzLAogICAgICBuZXR3b3JrOiBidGMubmV0d29yawogICAgfSk7CiAgICB2YXIgcDJzaCA9IGJpdGNvaW4ucGF5bWVudHMucDJzaCh7CiAgICAgIHJlZGVlbTogcDJtcywKICAgICAgbmV0d29yazogYnRjLm5ldHdvcmsKICAgIH0pOwogICAgdmFyIGFkZHJlc3MgPSBwMnNoLmFkZHJlc3M7IC8vQAoKICAgIHZhciBfYml0Y29pbiRwYXltZW50cyRwMncyID0gYml0Y29pbi5wYXltZW50cy5wMndwa2goewogICAgICBwdWJrZXk6IGFjY291bnQucHVibGljS2V5LAogICAgICBuZXR3b3JrOiBidGMubmV0d29yawogICAgfSksCiAgICAgICAgYWRkcmVzc09mTXlPd25XYWxsZXQgPSBfYml0Y29pbiRwYXltZW50cyRwMncyLmFkZHJlc3NPZk15T3duV2FsbGV0OwoKICAgIF9kYXRhID0gewogICAgICBhY2NvdW50OiBhY2NvdW50LAogICAgICBrZXlQYWlyOiBrZXlQYWlyLAogICAgICBwMnNoOiBwMnNoLAogICAgICBhZGRyZXNzOiBhZGRyZXNzLAogICAgICBhZGRyZXNzT2ZNeU93bldhbGxldDogYWRkcmVzc09mTXlPd25XYWxsZXQsCiAgICAgIGN1cnJlbmN5OiAnQlRDIChNdWx0aXNpZyknLAogICAgICBmdWxsTmFtZTogJ0JpdGNvaW4gKE11bHRpc2lnKScsCiAgICAgIHByaXZhdGVLZXk6IHByaXZhdGVLZXksCiAgICAgIHB1YmxpY0tleXM6IHB1YmxpY0tleXMsCiAgICAgIHB1YmxpY0tleTogcHVibGljS2V5LAogICAgICBpc0JUQzogdHJ1ZSwKICAgICAgYWN0aXZlOiB0cnVlCiAgICB9OwogIH0gZWxzZSB7CiAgICBfZGF0YSA9IHsKICAgICAgYWNjb3VudDogYWNjb3VudCwKICAgICAga2V5UGFpcjoga2V5UGFpciwKICAgICAgYWRkcmVzczogJ05vdCBqb2ludGVkJywKICAgICAgYWRkcmVzc09mTXlPd25XYWxsZXQ6ICdOb3Qgam9pbnRlZCcsCiAgICAgIGN1cnJlbmN5OiAnQlRDIChNdWx0aXNpZyknLAogICAgICBmdWxsTmFtZTogJ0JpdGNvaW4gKE11bHRpc2lnKScsCiAgICAgIHByaXZhdGVLZXk6IHByaXZhdGVLZXksCiAgICAgIHB1YmxpY0tleXM6IFtdLAogICAgICBwdWJsaWNLZXk6IHB1YmxpY0tleSwKICAgICAgaXNCVEM6IHRydWUsCiAgICAgIGFjdGl2ZTogZmFsc2UKICAgIH07CiAgfQoKICByZXR1cm4gX2RhdGE7Cn07Cgp2YXIgZW5hYmxlV2FsbGV0U01TID0gZnVuY3Rpb24gZW5hYmxlV2FsbGV0U01TKCkgewogIHZhciBfZ2V0U3RhdGUxMiA9IGdldFN0YXRlKCksCiAgICAgIGJ0Y011bHRpc2lnU01TRGF0YSA9IF9nZXRTdGF0ZTEyLnVzZXIuYnRjTXVsdGlzaWdTTVNEYXRhOwoKICBidGNNdWx0aXNpZ1NNU0RhdGEuaXNSZWdpc3RlcmVkID0gdHJ1ZTsKICByZWR1Y2Vycy51c2VyLnNldEF1dGhEYXRhKHsKICAgIG5hbWU6ICdidGNNdWx0aXNpZ1NNU0RhdGEnLAogICAgYnRjTXVsdGlzaWdTTVNEYXRhOiBidGNNdWx0aXNpZ1NNU0RhdGEKICB9KTsKfTsKCnZhciBlbmFibGVXYWxsZXRHMkZBID0gZnVuY3Rpb24gZW5hYmxlV2FsbGV0RzJGQSgpIHsKICB2YXIgX2dldFN0YXRlMTMgPSBnZXRTdGF0ZSgpLAogICAgICBidGNNdWx0aXNpZ0cyRkFEYXRhID0gX2dldFN0YXRlMTMudXNlci5idGNNdWx0aXNpZ0cyRkFEYXRhOwoKICBidGNNdWx0aXNpZ0cyRkFEYXRhLmlzUmVnaXN0ZXJlZCA9IHRydWU7CiAgcmVkdWNlcnMudXNlci5zZXRBdXRoRGF0YSh7CiAgICBuYW1lOiAnYnRjTXVsdGlzaWdHMkZBRGF0YScsCiAgICBidGNNdWx0aXNpZ0cyRkFEYXRhOiBidGNNdWx0aXNpZ0cyRkFEYXRhCiAgfSk7Cn07Cgp2YXIgZW5hYmxlV2FsbGV0VVNFUiA9IGZ1bmN0aW9uIGVuYWJsZVdhbGxldFVTRVIoKSB7fTsKCnZhciBvblVzZXJNdWx0aXNpZ0pvaW4gPSBmdW5jdGlvbiBvblVzZXJNdWx0aXNpZ0pvaW4oZGF0YSkgewogIGNvbnNvbGUubG9nKCdvbiB1c2VyIG11bHRpc2lnIGpvaW4nLCBkYXRhKTsKCiAgdmFyIF9nZXRTdGF0ZTE0ID0gZ2V0U3RhdGUoKSwKICAgICAgX2dldFN0YXRlMTQkdXNlciA9IF9nZXRTdGF0ZTE0LnVzZXIsCiAgICAgIGJ0Y011bHRpc2lnVXNlckRhdGEgPSBfZ2V0U3RhdGUxNCR1c2VyLmJ0Y011bHRpc2lnVXNlckRhdGEsCiAgICAgIGJ0Y0RhdGEgPSBfZ2V0U3RhdGUxNCR1c2VyLmJ0Y0RhdGE7CgogIHZhciBmcm9tUGVlciA9IGRhdGEuZnJvbVBlZXIsCiAgICAgIGNoZWNrS2V5ID0gZGF0YS5jaGVja0tleSwKICAgICAgcHVibGljS2V5ID0gZGF0YS5wdWJsaWNLZXk7CgogIGlmIChjaGVja0tleSA9PT0gYnRjRGF0YS5wdWJsaWNLZXkudG9TdHJpbmcoJ2hleCcpICYmIHB1YmxpY0tleSAmJiBwdWJsaWNLZXkubGVuZ3RoID09PSA2NikgewogICAgY29uc29sZS5sb2coJ2NoZWNrcyBvayAtIGNvbm5lY3QnKTsKICAgIGFkZEJ0Y011bHRpc2lnS2V5KHB1YmxpY0tleSwgdHJ1ZSk7CiAgICBTd2FwQXBwLnNoYXJlZCgpLnNlcnZpY2VzLnJvb20uc2VuZE1lc3NhZ2VQZWVyKGZyb21QZWVyLCB7CiAgICAgIGV2ZW50OiAnYnRjIG11bHRpc2lnIGpvaW4gcmVhZHknLAogICAgICBkYXRhOiB7fQogICAgfSk7CiAgfQp9OyAvLyDQn9C+0LvRg9GH0LjQu9C4INGC0YDQsNC90LfQsNC60YbQuNGOINC40Lcg0LrQvtC80L3QsNGC0YsgLSAg0L/RgNC+0LLQtdGA0Y/QtdC8LCDQvdCw0Ygg0Y3RgtC+INC60L7RiNC10LvQtdC6INC4INC10YHQu9C4INC00LAuINCX0LDQv9C40YHRi9Cy0LDQtdC8INCyINC40YHRgtC+0YDQuNGOINGC0YDQsNC90LfQsNC60YbQuNC5INGBINC/0L7QvNC10L3RgtC60L7QuSAtINC90YPQttC90L4g0L/QvtC00YLQstC10YDQtNC40YLRjAoKCnZhciBvblVzZXJNdWx0aXNpZ1NlbmQgPSBmdW5jdGlvbiBvblVzZXJNdWx0aXNpZ1NlbmQoZGF0YSkgewogIGNvbnNvbGUubG9nKCdvbiB1c2VyIG11bHRpc2lnIHNlbmQnLCBkYXRhKTsKfTsgLy8g0KDQsNGB0YHRi9C70LDQtdGCINGC0YDQsNC90LfQsNC60YbQuNGOINCyINC60L7QvNC90LDRgtC1LCDQtdGB0LvQuCDQstGC0L7RgNC+0Lkg0LLQu9Cw0LTQtdC70LXRhiDQsiDRgdC10YLQuC4g0KLQviDQvtC9INGB0YDQsNC30YMg0YPQstC40LTQuNGCLCDRh9GC0L4g0LXQvNGDINC90YPQttC90L4g0L/QvtC00YLQstC10YDQtNC40YLRjCDRgtGA0LDQvdC30LDQutGG0LjRjiDQsdC10Lcg0L/QtdGA0LXQtNCw0YfQuCDRgdGB0YvQu9C60LgKCgp2YXIgYnJvYWRjYXN0VFgyUm9vbSA9IGZ1bmN0aW9uIGJyb2FkY2FzdFRYMlJvb20odHhEYXRhLCBjYlN1Y2Nlc3MsIGNiRmFpbCkgewogIHZhciBfZ2V0U3RhdGUxNSA9IGdldFN0YXRlKCksCiAgICAgIF9nZXRTdGF0ZTE1JHVzZXIkYnRjTSA9IF9nZXRTdGF0ZTE1LnVzZXIuYnRjTXVsdGlzaWdVc2VyRGF0YSwKICAgICAgcHVibGljS2V5ID0gX2dldFN0YXRlMTUkdXNlciRidGNNLnB1YmxpY0tleSwKICAgICAgYWRkcmVzcyA9IF9nZXRTdGF0ZTE1JHVzZXIkYnRjTS5hZGRyZXNzOwoKICB2YXIgb25TdWNjZXNzRXZlbnROYW1lID0gImJ0YyBtdWx0aXNpZyBhY2NlcHQgdHggIi5jb25jYXQoYWRkcmVzcyk7CiAgdmFyIGZhaWxUaW1lciA9IGZhbHNlOwoKICB2YXIgb25TdWNjZXNzRXZlbnQgPSBmdW5jdGlvbiBvblN1Y2Nlc3NFdmVudChkYXRhKSB7CiAgICBjb25zb2xlLmxvZygnYnJvYWRjYXN0IHN1Y2VzcycsIGRhdGEpOyAvL0AKCiAgICBjbGVhclRpbWVvdXQoZmFpbFRpbWVyKTsKICAgIFN3YXBBcHAuc2hhcmVkKCkuc2VydmljZXMucm9vbS51bnN1YnNjcmliZShvblN1Y2Nlc3NFdmVudE5hbWUsIG9uU3VjY2Vzc0V2ZW50KTsKICAgIGlmIChjYlN1Y2Nlc3MpIGNiU3VjY2VzcygpOwogIH07CgogIHZhciBjYW5jZWxGdW5jID0gZnVuY3Rpb24gY2FuY2VsRnVuYygpIHsKICAgIGNvbnNvbGUubG9nKCdicm9hZGNhc3QgbXVsdGlzaWcgY2FuY2VsZWQnKTsgLy9ACgogICAgY2xlYXJUaW1lb3V0KGZhaWxUaW1lcik7CiAgICBTd2FwQXBwLnNoYXJlZCgpLnNlcnZpY2VzLnJvb20udW5zdWJzY3JpYmUob25TdWNjZXNzRXZlbnROYW1lLCBvblN1Y2Nlc3NFdmVudCk7CiAgfTsKCiAgdmFyIG9uRmFpbFRpbWVyID0gZnVuY3Rpb24gb25GYWlsVGltZXIoKSB7CiAgICBjb25zb2xlLmxvZygnYnJvYWRjYXN0IG11bHRpc2lnIGZhaWwgdGltZXInKTsgLy9ACgogICAgY2xlYXJUaW1lb3V0KGZhaWxUaW1lcik7CiAgICBTd2FwQXBwLnNoYXJlZCgpLnNlcnZpY2VzLnJvb20udW5zdWJzY3JpYmUob25TdWNjZXNzRXZlbnROYW1lLCBvblN1Y2Nlc3NFdmVudCk7CiAgICBpZiAoY2JGYWlsKSBjYkZhaWwoKTsKICB9OyAvL0AKCgogIGZhaWxUaW1lciA9IHNldFRpbWVvdXQob25GYWlsVGltZXIsIDMwMDAwKTsKICBTd2FwQXBwLnNoYXJlZCgpLnNlcnZpY2VzLnJvb20uc3Vic2NyaWJlKG9uU3VjY2Vzc0V2ZW50TmFtZSwgb25TdWNjZXNzRXZlbnQpOyAvLyBCcm9hZGNhc3QgVFgKCiAgU3dhcEFwcC5zaGFyZWQoKS5zZXJ2aWNlcy5yb29tLnNlbmRNZXNzYWdlUm9vbSh7CiAgICBldmVudDogImJ0YyBtdWx0aXNpZyByZXF1ZXN0IHNpZ24gIi5jb25jYXQoYWRkcmVzcyksCiAgICBkYXRhOiB7CiAgICAgIHR4RGF0YTogdHhEYXRhLAogICAgICBwdWJsaWNLZXk6IHB1YmxpY0tleS50b1N0cmluZygnaGV4JykKICAgIH0KICB9KTsKICByZXR1cm4gY2FuY2VsRnVuYzsKfTsKCndpbmRvdy5icm9hZGNhc3RUWDJSb29tID0gYnJvYWRjYXN0VFgyUm9vbTsKCnZhciBfZ2V0U2lnbiA9IGZ1bmN0aW9uIF9nZXRTaWduKCkgewogIHZhciBfZ2V0U3RhdGUxNiA9IGdldFN0YXRlKCksCiAgICAgIF9nZXRTdGF0ZTE2JHVzZXIkYnRjTSA9IF9nZXRTdGF0ZTE2LnVzZXIuYnRjTXVsdGlzaWdTTVNEYXRhLAogICAgICBhY2NvdW50ID0gX2dldFN0YXRlMTYkdXNlciRidGNNLmFjY291bnQsCiAgICAgIGFkZHJlc3MgPSBfZ2V0U3RhdGUxNiR1c2VyJGJ0Y00uYWRkcmVzcywKICAgICAga2V5UGFpciA9IF9nZXRTdGF0ZTE2JHVzZXIkYnRjTS5rZXlQYWlyLAogICAgICBwdWJsaWNLZXkgPSBfZ2V0U3RhdGUxNiR1c2VyJGJ0Y00ucHVibGljS2V5OwoKICB2YXIgbWVzc2FnZSA9ICIiLmNvbmNhdChhZGRyZXNzLCAiOiIpLmNvbmNhdChwdWJsaWNLZXkudG9TdHJpbmcoJ2hleCcpKTsKICBjb25zb2xlLmxvZyhtZXNzYWdlKTsKICB2YXIgc2lnbiA9IGJpdGNvaW5NZXNzYWdlLnNpZ24obWVzc2FnZSwgYWNjb3VudC5wcml2YXRlS2V5LCBrZXlQYWlyLmNvbXByZXNzZWQpOwogIHJldHVybiBzaWduLnRvU3RyaW5nKCdiYXNlNjQnKTsKfTsKCnZhciBiZWdpblJlZ2lzdGVyU01TID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICB2YXIgX3JlZjYgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNChwaG9uZSwgbW5lbW9uaWMsIG93blB1YmxpY0tleSkgewogICAgdmFyIF9nZXRTdGF0ZTE3LCBfZ2V0U3RhdGUxNyR1c2VyLCBfZ2V0U3RhdGUxNyR1c2VyJGJ0Y00sIGFjY291bnQsIGtleVBhaXIsIHB1YmxpY0tleSwgYWRkcmVzcywgcHVibGljS2V5cywgbW5lbW9uaWNBY2NvdW50LCBzaWduLCByZXN1bHQ7CgogICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dDQucHJldiA9IF9jb250ZXh0NC5uZXh0KSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIF9nZXRTdGF0ZTE3ID0gZ2V0U3RhdGUoKSwgX2dldFN0YXRlMTckdXNlciA9IF9nZXRTdGF0ZTE3LnVzZXIsIF9nZXRTdGF0ZTE3JHVzZXIkYnRjTSA9IF9nZXRTdGF0ZTE3JHVzZXIuYnRjTXVsdGlzaWdTTVNEYXRhLCBhY2NvdW50ID0gX2dldFN0YXRlMTckdXNlciRidGNNLmFjY291bnQsIGtleVBhaXIgPSBfZ2V0U3RhdGUxNyR1c2VyJGJ0Y00ua2V5UGFpciwgcHVibGljS2V5ID0gX2dldFN0YXRlMTckdXNlciRidGNNLnB1YmxpY0tleSwgYWRkcmVzcyA9IF9nZXRTdGF0ZTE3JHVzZXIuYnRjRGF0YS5hZGRyZXNzOwogICAgICAgICAgICBwdWJsaWNLZXlzID0gW107CgogICAgICAgICAgICBpZiAobW5lbW9uaWMgJiYgIW93blB1YmxpY0tleSkgewogICAgICAgICAgICAgIC8vIDJvZjMgLSBleHRyYWN0IHB1YmxpYyBrZXkgZnJvbSBtbmVtb25pYwogICAgICAgICAgICAgIG1uZW1vbmljQWNjb3VudCA9IGFjdGlvbnMuYnRjLmdldFdhbGxldEJ5V29yZHMobW5lbW9uaWMsIDEpOwogICAgICAgICAgICAgIHB1YmxpY0tleXMucHVzaChtbmVtb25pY0FjY291bnQucHVibGljS2V5KTsKICAgICAgICAgICAgfSAvLyDQktC+0LfQvNC+0LbQvdC+0YHRgtGMINC40YHQv9C+0LvRjNC30L7QstCw0YLRjCDQv9GA0L7QuNC30LLQvtC70YzQvdGL0Lkg0L/Rg9Cx0LvQuNC6LdC60LXQuSDQtNC70Y8g0YDQsNC30LHQu9C+0LrQuNGA0L7QstCw0L3QuNGPCgoKICAgICAgICAgICAgaWYgKG93blB1YmxpY0tleSkgewogICAgICAgICAgICAgIHB1YmxpY0tleXMucHVzaChvd25QdWJsaWNLZXkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwdWJsaWNLZXlzLnB1c2gocHVibGljS2V5LnRvU3RyaW5nKCdIZXgnKSk7CiAgICAgICAgICAgIHNpZ24gPSBfZ2V0U2lnbigpOwogICAgICAgICAgICBfY29udGV4dDQucHJldiA9IDY7CiAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gOTsKICAgICAgICAgICAgcmV0dXJuIGFwaUxvb3Blci5wb3N0KCdidGMyRkFQcm90ZWN0ZWQnLCAiL3JlZ2lzdGVyL2JlZ2luLyIsIHsKICAgICAgICAgICAgICBib2R5OiB7CiAgICAgICAgICAgICAgICBwaG9uZTogcGhvbmUsCiAgICAgICAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzLAogICAgICAgICAgICAgICAgcHVibGljS2V5OiBKU09OLnN0cmluZ2lmeShwdWJsaWNLZXlzKSwKICAgICAgICAgICAgICAgIGNoZWNrU2lnbjogc2lnbiwKICAgICAgICAgICAgICAgIG1haW5uZXQ6ICEhcHJvY2Vzcy5lbnYuTUFJTk5FVCwKICAgICAgICAgICAgICAgIHNvdXJjZTogd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgIHJlc3VsdCA9IF9jb250ZXh0NC5zZW50OwogICAgICAgICAgICBjb25zb2xlLmxvZyhyZXN1bHQpOwogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LmFicnVwdCgicmV0dXJuIiwgcmVzdWx0KTsKCiAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICBfY29udGV4dDQucHJldiA9IDE0OwogICAgICAgICAgICBfY29udGV4dDQudDAgPSBfY29udGV4dDRbImNhdGNoIl0oNik7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoX2NvbnRleHQ0LnQwKTsKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5hYnJ1cHQoInJldHVybiIsIGZhbHNlKTsKCiAgICAgICAgICBjYXNlIDE4OgogICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5zdG9wKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCBfY2FsbGVlNCwgbnVsbCwgW1s2LCAxNF1dKTsKICB9KSk7CgogIHJldHVybiBmdW5jdGlvbiBiZWdpblJlZ2lzdGVyU01TKF94NCwgX3g1LCBfeDYpIHsKICAgIHJldHVybiBfcmVmNi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07Cn0oKTsKCnZhciBjb25maXJtUmVnaXN0ZXJTTVMgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIHZhciBfcmVmNyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU1KHBob25lLCBzbXNDb2RlLCBtbmVtb25pYywgb3duUHVibGljS2V5KSB7CiAgICB2YXIgX2dldFN0YXRlMTgsIF9nZXRTdGF0ZTE4JHVzZXIsIF9nZXRTdGF0ZTE4JHVzZXIkYnRjTSwgYWNjb3VudCwga2V5UGFpciwgcHVibGljS2V5LCBhZGRyZXNzLCBwdWJsaWNLZXlzLCBtbmVtb25pY0tleSwgbW5lbW9uaWNBY2NvdW50LCBzaWduLCBuZXdLZXlzLCByZXN1bHQ7CgogICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNSQoX2NvbnRleHQ1KSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dDUucHJldiA9IF9jb250ZXh0NS5uZXh0KSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIF9nZXRTdGF0ZTE4ID0gZ2V0U3RhdGUoKSwgX2dldFN0YXRlMTgkdXNlciA9IF9nZXRTdGF0ZTE4LnVzZXIsIF9nZXRTdGF0ZTE4JHVzZXIkYnRjTSA9IF9nZXRTdGF0ZTE4JHVzZXIuYnRjTXVsdGlzaWdTTVNEYXRhLCBhY2NvdW50ID0gX2dldFN0YXRlMTgkdXNlciRidGNNLmFjY291bnQsIGtleVBhaXIgPSBfZ2V0U3RhdGUxOCR1c2VyJGJ0Y00ua2V5UGFpciwgcHVibGljS2V5ID0gX2dldFN0YXRlMTgkdXNlciRidGNNLnB1YmxpY0tleSwgYWRkcmVzcyA9IF9nZXRTdGF0ZTE4JHVzZXIuYnRjRGF0YS5hZGRyZXNzOwogICAgICAgICAgICBwdWJsaWNLZXlzID0gW107CiAgICAgICAgICAgIG1uZW1vbmljS2V5ID0gZmFsc2U7CgogICAgICAgICAgICBpZiAobW5lbW9uaWMgJiYgIW93blB1YmxpY0tleSkgewogICAgICAgICAgICAgIC8vIDJvZjMgLSBleHRyYWN0IHB1YmxpYyBrZXkgZnJvbSBtbmVtb25pYwogICAgICAgICAgICAgIG1uZW1vbmljQWNjb3VudCA9IGFjdGlvbnMuYnRjLmdldFdhbGxldEJ5V29yZHMobW5lbW9uaWMsIDEpOyAvL0AKCiAgICAgICAgICAgICAgbW5lbW9uaWNLZXkgPSBtbmVtb25pY0FjY291bnQucHVibGljS2V5OwogICAgICAgICAgICAgIHB1YmxpY0tleXMucHVzaChtbmVtb25pY0tleSk7CiAgICAgICAgICAgIH0gLy8g0JLQvtC30LzQvtC20L3QvtGB0YLRjCDQuNGB0L/QvtC70YzQt9C+0LLQsNGC0Ywg0L/RgNC+0LjQt9Cy0L7Qu9GM0L3Ri9C5INC/0YPQsdC70LjQui3QutC10Lkg0LTQu9GPINGA0LDQt9Cx0LvQvtC60LjRgNC+0LLQsNC90LjRjwoKCiAgICAgICAgICAgIGlmIChvd25QdWJsaWNLZXkpIHsKICAgICAgICAgICAgICBwdWJsaWNLZXlzLnB1c2gob3duUHVibGljS2V5KTsKICAgICAgICAgICAgICBtbmVtb25pY0tleSA9IG93blB1YmxpY0tleTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcHVibGljS2V5cy5wdXNoKHB1YmxpY0tleS50b1N0cmluZygnSGV4JykpOwogICAgICAgICAgICBzaWduID0gX2dldFNpZ24oKTsKICAgICAgICAgICAgbmV3S2V5cyA9IEpTT04uc3RyaW5naWZ5KHB1YmxpY0tleXMpOwogICAgICAgICAgICBfY29udGV4dDUucHJldiA9IDg7CiAgICAgICAgICAgIF9jb250ZXh0NS5uZXh0ID0gMTE7CiAgICAgICAgICAgIHJldHVybiBhcGlMb29wZXIucG9zdCgnYnRjMkZBUHJvdGVjdGVkJywgIi9yZWdpc3Rlci9jb25maXJtLyIsIHsKICAgICAgICAgICAgICBib2R5OiB7CiAgICAgICAgICAgICAgICBwaG9uZTogcGhvbmUsCiAgICAgICAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzLAogICAgICAgICAgICAgICAgc21zQ29kZTogc21zQ29kZSwKICAgICAgICAgICAgICAgIHB1YmxpY0tleTogbmV3S2V5cywKICAgICAgICAgICAgICAgIGNoZWNrU2lnbjogc2lnbiwKICAgICAgICAgICAgICAgIG1haW5uZXQ6ICEhcHJvY2Vzcy5lbnYuTUFJTk5FVCwKICAgICAgICAgICAgICAgIHNvdXJjZTogd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICByZXN1bHQgPSBfY29udGV4dDUuc2VudDsKCiAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmFuc3dlciAmJiByZXN1bHQuYW5zd2VyID09PSAnb2snIHx8IHJlc3VsdC5lcnJvciA9PT0gJ0FscmVhZHkgcmVnaXN0ZXJlZCcpIHsKICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiIi5jb25jYXQoY29uc3RhbnRzLmxvY2FsU3RvcmFnZS5kaWRQcm90ZWN0ZWRCdGNDcmVhdGVkLCAiOiIpLmNvbmNhdChhZGRyZXNzKSwgJzEnKTsKCiAgICAgICAgICAgICAgaWYgKG1uZW1vbmljKSB7CiAgICAgICAgICAgICAgICBhZGRTTVNXYWxsZXQobW5lbW9uaWNLZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5hYnJ1cHQoInJldHVybiIsIHJlc3VsdCk7CgogICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgX2NvbnRleHQ1LnByZXYgPSAxNjsKICAgICAgICAgICAgX2NvbnRleHQ1LnQwID0gX2NvbnRleHQ1WyJjYXRjaCJdKDgpOwogICAgICAgICAgICBjb25zb2xlLmVycm9yKF9jb250ZXh0NS50MCk7CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuYWJydXB0KCJyZXR1cm4iLCBmYWxzZSk7CgogICAgICAgICAgY2FzZSAyMDoKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgX2NhbGxlZTUsIG51bGwsIFtbOCwgMTZdXSk7CiAgfSkpOwoKICByZXR1cm4gZnVuY3Rpb24gY29uZmlybVJlZ2lzdGVyU01TKF94NywgX3g4LCBfeDksIF94MTApIHsKICAgIHJldHVybiBfcmVmNy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07Cn0oKTsKCnZhciByZWdpc3Rlcl9QSU4gPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIHZhciBfcmVmOCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU2KHBhc3N3b3JkLCBtbmVtb25pYywgb3duUHVibGljS2V5KSB7CiAgICB2YXIgX2dldFN0YXRlMTksIF9nZXRTdGF0ZTE5JHVzZXIsIF9nZXRTdGF0ZTE5JHVzZXIkYnRjTSwgYWNjb3VudCwga2V5UGFpciwgcHVibGljS2V5LCBfZ2V0U3RhdGUxOSR1c2VyJGJ0Y0QsIGFkZHJlc3MsIG1haW5LZXksIGJ0Y1BpblNlcnZlcktleSwgcHVibGljS2V5cywgbW5lbW9uaWNLZXksIG1uZW1vbmljQWNjb3VudCwgc2lnbiwgbmV3S2V5cywgcmVzdWx0OwoKICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTYkKF9jb250ZXh0NikgewogICAgICB3aGlsZSAoMSkgewogICAgICAgIHN3aXRjaCAoX2NvbnRleHQ2LnByZXYgPSBfY29udGV4dDYubmV4dCkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBfZ2V0U3RhdGUxOSA9IGdldFN0YXRlKCksIF9nZXRTdGF0ZTE5JHVzZXIgPSBfZ2V0U3RhdGUxOS51c2VyLCBfZ2V0U3RhdGUxOSR1c2VyJGJ0Y00gPSBfZ2V0U3RhdGUxOSR1c2VyLmJ0Y011bHRpc2lnUGluRGF0YSwgYWNjb3VudCA9IF9nZXRTdGF0ZTE5JHVzZXIkYnRjTS5hY2NvdW50LCBrZXlQYWlyID0gX2dldFN0YXRlMTkkdXNlciRidGNNLmtleVBhaXIsIHB1YmxpY0tleSA9IF9nZXRTdGF0ZTE5JHVzZXIkYnRjTS5wdWJsaWNLZXksIF9nZXRTdGF0ZTE5JHVzZXIkYnRjRCA9IF9nZXRTdGF0ZTE5JHVzZXIuYnRjRGF0YSwgYWRkcmVzcyA9IF9nZXRTdGF0ZTE5JHVzZXIkYnRjRC5hZGRyZXNzLCBtYWluS2V5ID0gX2dldFN0YXRlMTkkdXNlciRidGNELnB1YmxpY0tleTsKICAgICAgICAgICAgYnRjUGluU2VydmVyS2V5ID0gY29uZmlnLnN3YXBDb250cmFjdC5idGNQaW5LZXk7CiAgICAgICAgICAgIHB1YmxpY0tleXMgPSBbYnRjUGluU2VydmVyS2V5XTsKICAgICAgICAgICAgbW5lbW9uaWNLZXkgPSBmYWxzZTsKCiAgICAgICAgICAgIGlmIChtbmVtb25pYyAmJiAhb3duUHVibGljS2V5KSB7CiAgICAgICAgICAgICAgLy8gMm9mMyAtIGV4dHJhY3QgcHVibGljIGtleSBmcm9tIG1uZW1vbmljCiAgICAgICAgICAgICAgbW5lbW9uaWNBY2NvdW50ID0gYWN0aW9ucy5idGMuZ2V0V2FsbGV0QnlXb3JkcyhtbmVtb25pYywgMSk7IC8vQAoKICAgICAgICAgICAgICBtbmVtb25pY0tleSA9IG1uZW1vbmljQWNjb3VudC5wdWJsaWNLZXk7CiAgICAgICAgICAgICAgcHVibGljS2V5cy5wdXNoKG1uZW1vbmljS2V5KTsKICAgICAgICAgICAgfSAvLyDQktC+0LfQvNC+0LbQvdC+0YHRgtGMINC40YHQv9C+0LvRjNC30L7QstCw0YLRjCDQv9GA0L7QuNC30LLQvtC70YzQvdGL0Lkg0L/Rg9Cx0LvQuNC6LdC60LXQuSDQtNC70Y8g0YDQsNC30LHQu9C+0LrQuNGA0L7QstCw0L3QuNGPCgoKICAgICAgICAgICAgaWYgKG93blB1YmxpY0tleSkgewogICAgICAgICAgICAgIHB1YmxpY0tleXMucHVzaChvd25QdWJsaWNLZXkpOwogICAgICAgICAgICAgIG1uZW1vbmljS2V5ID0gb3duUHVibGljS2V5OwogICAgICAgICAgICB9CgogICAgICAgICAgICBwdWJsaWNLZXlzLnB1c2gobWFpbktleS50b1N0cmluZygnSGV4JykpOwogICAgICAgICAgICBzaWduID0gX2dldFNpZ24oKTsKICAgICAgICAgICAgbmV3S2V5cyA9IEpTT04uc3RyaW5naWZ5KHB1YmxpY0tleXMpOwogICAgICAgICAgICBfY29udGV4dDYucHJldiA9IDk7CiAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMTI7CiAgICAgICAgICAgIHJldHVybiBhcGlMb29wZXIucG9zdCgnYnRjUGluJywgIi9yZWdpc3Rlci8iLCB7CiAgICAgICAgICAgICAgYm9keTogewogICAgICAgICAgICAgICAgYWRkcmVzczogYWRkcmVzcywKICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBwYXNzd29yZCwKICAgICAgICAgICAgICAgIHB1YmxpY0tleTogbmV3S2V5cywKICAgICAgICAgICAgICAgIGNoZWNrU2lnbjogc2lnbiwKICAgICAgICAgICAgICAgIG1haW5uZXQ6ICEhcHJvY2Vzcy5lbnYuTUFJTk5FVCwKICAgICAgICAgICAgICAgIHNvdXJjZTogd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICByZXN1bHQgPSBfY29udGV4dDYuc2VudDsKCiAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmFuc3dlciAmJiByZXN1bHQuYW5zd2VyID09PSAnb2snIHx8IHJlc3VsdC5lcnJvciA9PT0gJ0FscmVhZHkgcmVnaXN0ZXJlZCcpIHsKICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiIi5jb25jYXQoY29uc3RhbnRzLmxvY2FsU3RvcmFnZS5kaWRQaW5CdGNDcmVhdGVkLCAiOiIpLmNvbmNhdChhZGRyZXNzKSwgJzEnKTsKICAgICAgICAgICAgICBhZGRQaW5XYWxsZXQobW5lbW9uaWNLZXkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ2LmFicnVwdCgicmV0dXJuIiwgcmVzdWx0KTsKCiAgICAgICAgICBjYXNlIDE3OgogICAgICAgICAgICBfY29udGV4dDYucHJldiA9IDE3OwogICAgICAgICAgICBfY29udGV4dDYudDAgPSBfY29udGV4dDZbImNhdGNoIl0oOSk7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoX2NvbnRleHQ2LnQwKTsKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5hYnJ1cHQoInJldHVybiIsIGZhbHNlKTsKCiAgICAgICAgICBjYXNlIDIxOgogICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5zdG9wKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LCBfY2FsbGVlNiwgbnVsbCwgW1s5LCAxN11dKTsKICB9KSk7CgogIHJldHVybiBmdW5jdGlvbiByZWdpc3Rlcl9QSU4oX3gxMSwgX3gxMiwgX3gxMykgewogICAgcmV0dXJuIF9yZWY4LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKfSgpOwoKdmFyIGFkZFBpbldhbGxldCA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgdmFyIF9yZWY5ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTcobW5lbW9uaWNPcktleSkgewogICAgdmFyIF9nZXRTdGF0ZTIwLCBwcml2YXRlS2V5LCBtbmVtb25pY0tleSwgbW5lbW9uaWNBY2NvdW50LCBidGNQaW5NbmVtb25pY0tleSwgaW5kZXgsIGJ0Y1BpblNlcnZlcktleSwgYnRjUGluUHVibGljS2V5cywgX2dldFN0YXRlMjEsIGFkZHJlc3M7CgogICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNyQoX2NvbnRleHQ3KSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dDcucHJldiA9IF9jb250ZXh0Ny5uZXh0KSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIF9nZXRTdGF0ZTIwID0gZ2V0U3RhdGUoKSwgcHJpdmF0ZUtleSA9IF9nZXRTdGF0ZTIwLnVzZXIuYnRjRGF0YS5wcml2YXRlS2V5OwogICAgICAgICAgICBtbmVtb25pY0tleSA9IG1uZW1vbmljT3JLZXk7CgogICAgICAgICAgICBpZiAoYWN0aW9ucy5idGMudmFsaWRhdGVNbmVtb25pY1dvcmRzKG1uZW1vbmljT3JLZXkpKSB7CiAgICAgICAgICAgICAgbW5lbW9uaWNBY2NvdW50ID0gYWN0aW9ucy5idGMuZ2V0V2FsbGV0QnlXb3JkcyhtbmVtb25pY09yS2V5LCAxKTsKICAgICAgICAgICAgICBtbmVtb25pY0tleSA9IG1uZW1vbmljQWNjb3VudC5wdWJsaWNLZXk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGJ0Y1Bpbk1uZW1vbmljS2V5ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oY29uc3RhbnRzLnByaXZhdGVLZXlOYW1lcy5idGNQaW5NbmVtb25pY0tleSk7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGJ0Y1Bpbk1uZW1vbmljS2V5ID0gSlNPTi5wYXJzZShidGNQaW5NbmVtb25pY0tleSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIShidGNQaW5NbmVtb25pY0tleSBpbnN0YW5jZW9mIEFycmF5KSkgewogICAgICAgICAgICAgIGJ0Y1Bpbk1uZW1vbmljS2V5ID0gW107CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGluZGV4ID0gYnRjUGluTW5lbW9uaWNLZXkuaW5kZXhPZihtbmVtb25pY0tleSk7CiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gLTEpIGJ0Y1Bpbk1uZW1vbmljS2V5LnVuc2hpZnQobW5lbW9uaWNLZXkpOwoKICAgICAgICAgICAgaWYgKGluZGV4ID4gLTEgJiYgaW5kZXggPCBidGNQaW5NbmVtb25pY0tleS5sZW5ndGgpIHsKICAgICAgICAgICAgICBpZiAoaW5kZXggIT09IDApIHsKICAgICAgICAgICAgICAgIGJ0Y1Bpbk1uZW1vbmljS2V5ID0gYnRjUGluTW5lbW9uaWNLZXkuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgICAgIGJ0Y1Bpbk1uZW1vbmljS2V5LnVuc2hpZnQobW5lbW9uaWNLZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oY29uc3RhbnRzLnByaXZhdGVLZXlOYW1lcy5idGNQaW5NbmVtb25pY0tleSwgSlNPTi5zdHJpbmdpZnkoYnRjUGluTW5lbW9uaWNLZXkpKTsKICAgICAgICAgICAgYnRjUGluU2VydmVyS2V5ID0gY29uZmlnLnN3YXBDb250cmFjdC5idGNQaW5LZXk7CiAgICAgICAgICAgIGJ0Y1BpblB1YmxpY0tleXMgPSBbYnRjUGluU2VydmVyS2V5LCBtbmVtb25pY0tleV07CiAgICAgICAgICAgIF9jb250ZXh0Ny5uZXh0ID0gMTQ7CiAgICAgICAgICAgIHJldHVybiBhY3Rpb25zLmJ0Y211bHRpc2lnLmxvZ2luX1BJTihwcml2YXRlS2V5LCBidGNQaW5QdWJsaWNLZXlzKTsKCiAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICBfZ2V0U3RhdGUyMSA9IGdldFN0YXRlKCksIGFkZHJlc3MgPSBfZ2V0U3RhdGUyMS51c2VyLmJ0Y011bHRpc2lnUGluRGF0YS5hZGRyZXNzOwogICAgICAgICAgICBfY29udGV4dDcubmV4dCA9IDE3OwogICAgICAgICAgICByZXR1cm4gZ2V0QmFsYW5jZShhZGRyZXNzLCAnYnRjTXVsdGlzaWdQaW5EYXRhJyk7CgogICAgICAgICAgY2FzZSAxNzoKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDcuc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgX2NhbGxlZTcpOwogIH0pKTsKCiAgcmV0dXJuIGZ1bmN0aW9uIGFkZFBpbldhbGxldChfeDE0KSB7CiAgICByZXR1cm4gX3JlZjkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Owp9KCk7Cgp2YXIgYWRkU01TV2FsbGV0ID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICB2YXIgX3JlZjEwID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTgobW5lbW9uaWNPcktleSkgewogICAgdmFyIF9nZXRTdGF0ZTIyLCBwcml2YXRlS2V5LCBtbmVtb25pY0tleSwgbW5lbW9uaWNBY2NvdW50LCBidGNTbXNNbmVtb25pY0tleSwgaW5kZXgsIGJ0Y1NNU1NlcnZlcktleSwgYnRjU21zUHVibGljS2V5czsKCiAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU4JChfY29udGV4dDgpIHsKICAgICAgd2hpbGUgKDEpIHsKICAgICAgICBzd2l0Y2ggKF9jb250ZXh0OC5wcmV2ID0gX2NvbnRleHQ4Lm5leHQpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgX2dldFN0YXRlMjIgPSBnZXRTdGF0ZSgpLCBwcml2YXRlS2V5ID0gX2dldFN0YXRlMjIudXNlci5idGNEYXRhLnByaXZhdGVLZXk7CiAgICAgICAgICAgIG1uZW1vbmljS2V5ID0gbW5lbW9uaWNPcktleTsKCiAgICAgICAgICAgIGlmIChhY3Rpb25zLmJ0Yy52YWxpZGF0ZU1uZW1vbmljV29yZHMobW5lbW9uaWNPcktleSkpIHsKICAgICAgICAgICAgICBtbmVtb25pY0FjY291bnQgPSBhY3Rpb25zLmJ0Yy5nZXRXYWxsZXRCeVdvcmRzKG1uZW1vbmljT3JLZXksIDEpOwogICAgICAgICAgICAgIG1uZW1vbmljS2V5ID0gbW5lbW9uaWNBY2NvdW50LnB1YmxpY0tleTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYnRjU21zTW5lbW9uaWNLZXkgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShjb25zdGFudHMucHJpdmF0ZUtleU5hbWVzLmJ0Y1Ntc01uZW1vbmljS2V5KTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgYnRjU21zTW5lbW9uaWNLZXkgPSBKU09OLnBhcnNlKGJ0Y1Ntc01uZW1vbmljS2V5KTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghKGJ0Y1Ntc01uZW1vbmljS2V5IGluc3RhbmNlb2YgQXJyYXkpKSB7CiAgICAgICAgICAgICAgYnRjU21zTW5lbW9uaWNLZXkgPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaW5kZXggPSBidGNTbXNNbmVtb25pY0tleS5pbmRleE9mKG1uZW1vbmljS2V5KTsKICAgICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkgYnRjU21zTW5lbW9uaWNLZXkudW5zaGlmdChtbmVtb25pY0tleSk7CgogICAgICAgICAgICBpZiAoaW5kZXggPiAtMSAmJiBpbmRleCA8IGJ0Y1Ntc01uZW1vbmljS2V5Lmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChpbmRleCAhPT0gMCkgewogICAgICAgICAgICAgICAgYnRjU21zTW5lbW9uaWNLZXkgPSBidGNTbXNNbmVtb25pY0tleS5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICAgICAgYnRjU21zTW5lbW9uaWNLZXkudW5zaGlmdChtbmVtb25pY0tleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShjb25zdGFudHMucHJpdmF0ZUtleU5hbWVzLmJ0Y1Ntc01uZW1vbmljS2V5LCBKU09OLnN0cmluZ2lmeShidGNTbXNNbmVtb25pY0tleSkpOwogICAgICAgICAgICBidGNTTVNTZXJ2ZXJLZXkgPSBjb25maWcuc3dhcENvbnRyYWN0LnByb3RlY3RlZEJ0Y0tleTsKICAgICAgICAgICAgYnRjU21zUHVibGljS2V5cyA9IFtidGNTTVNTZXJ2ZXJLZXksIG1uZW1vbmljS2V5XTsKICAgICAgICAgICAgX2NvbnRleHQ4Lm5leHQgPSAxNDsKICAgICAgICAgICAgcmV0dXJuIGFjdGlvbnMuYnRjbXVsdGlzaWcubG9naW5fU01TKHByaXZhdGVLZXksIGJ0Y1Ntc1B1YmxpY0tleXMpOwoKICAgICAgICAgIGNhc2UgMTQ6CiAgICAgICAgICAgIF9jb250ZXh0OC5uZXh0ID0gMTY7CiAgICAgICAgICAgIHJldHVybiBnZXRCYWxhbmNlKCk7CgogICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDguc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgX2NhbGxlZTgpOwogIH0pKTsKCiAgcmV0dXJuIGZ1bmN0aW9uIGFkZFNNU1dhbGxldChfeDE1KSB7CiAgICByZXR1cm4gX3JlZjEwLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKfSgpOwoKdmFyIGdldEFkZHJCYWxhbmNlID0gZnVuY3Rpb24gZ2V0QWRkckJhbGFuY2UoYWRkcmVzcykgewogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgYml0Y29pblV0aWxzLmZldGNoQmFsYW5jZSh7CiAgICAgIGFkZHJlc3M6IGFkZHJlc3MsCiAgICAgIHdpdGhVbmNvbmZpcm1lZDogdHJ1ZSwKICAgICAgYXBpQml0cGF5OiBCSVRQQVlfQVBJCiAgICB9KS50aGVuKGZ1bmN0aW9uIChhbnN3ZXIpIHsKICAgICAgLy9ACiAgICAgIHZhciBiYWxhbmNlID0gYW5zd2VyLmJhbGFuY2UsCiAgICAgICAgICB1bmNvbmZpcm1lZCA9IGFuc3dlci51bmNvbmZpcm1lZDsKICAgICAgcmVzb2x2ZSh7CiAgICAgICAgYWRkcmVzczogYWRkcmVzcywKICAgICAgICBiYWxhbmNlOiBiYWxhbmNlLAogICAgICAgIHVuY29uZmlybWVkQmFsYW5jZTogdW5jb25maXJtZWQKICAgICAgfSk7CiAgICB9KVsiY2F0Y2giXShmdW5jdGlvbiAoZSkgewogICAgICByZXNvbHZlKGZhbHNlKTsKICAgIH0pOwogIH0pOwp9OwoKdmFyIGdldEJhbGFuY2UgPSBmdW5jdGlvbiBnZXRCYWxhbmNlKCkgewogIHZhciBvd25BZGRyZXNzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBudWxsOwogIHZhciBvd25EYXRhS2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBudWxsOwoKICB2YXIgX2dldFN0YXRlMjMgPSBnZXRTdGF0ZSgpLAogICAgICBhZGRyZXNzID0gX2dldFN0YXRlMjMudXNlci5idGNNdWx0aXNpZ1NNU0RhdGEuYWRkcmVzczsKCiAgdmFyIGNoZWNrQWRkcmVzcyA9IG93bkFkZHJlc3MgfHwgYWRkcmVzczsKICB2YXIgZGF0YUtleSA9IG93bkRhdGFLZXkgfHwgJ2J0Y011bHRpc2lnU01TRGF0YSc7CgogIGlmIChjaGVja0FkZHJlc3MgPT09ICdOb3Qgam9pbnRlZCcpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICByZWR1Y2Vycy51c2VyLnNldEJhbGFuY2UoewogICAgICAgIG5hbWU6IGRhdGFLZXksCiAgICAgICAgYW1vdW50OiAwLAogICAgICAgIHVuY29uZmlybWVkQmFsYW5jZTogMAogICAgICB9KTsKICAgICAgcmVzb2x2ZSgwKTsKICAgIH0pOwogIH0KCiAgcmV0dXJuIGdldEFkZHJCYWxhbmNlKGNoZWNrQWRkcmVzcykudGhlbihmdW5jdGlvbiAoX3JlZjExKSB7CiAgICB2YXIgYmFsYW5jZSA9IF9yZWYxMS5iYWxhbmNlLAogICAgICAgIHVuY29uZmlybWVkQmFsYW5jZSA9IF9yZWYxMS51bmNvbmZpcm1lZEJhbGFuY2U7CiAgICByZWR1Y2Vycy51c2VyLnNldEJhbGFuY2UoewogICAgICBuYW1lOiBkYXRhS2V5LAogICAgICBhbW91bnQ6IGJhbGFuY2UsCiAgICAgIHVuY29uZmlybWVkQmFsYW5jZTogdW5jb25maXJtZWRCYWxhbmNlCiAgICB9KTsKICAgIHJldHVybiBiYWxhbmNlOwogIH0pWyJjYXRjaCJdKGZ1bmN0aW9uIChlKSB7CiAgICByZWR1Y2Vycy51c2VyLnNldEJhbGFuY2VFcnJvcih7CiAgICAgIG5hbWU6IGRhdGFLZXkKICAgIH0pOwogIH0pOwp9OwoKdmFyIGdldEJhbGFuY2VQaW4gPSBmdW5jdGlvbiBnZXRCYWxhbmNlUGluKCkgewogIHZhciBfZ2V0U3RhdGUyNCA9IGdldFN0YXRlKCksCiAgICAgIGFkZHJlc3MgPSBfZ2V0U3RhdGUyNC51c2VyLmJ0Y011bHRpc2lnUGluRGF0YS5hZGRyZXNzOwoKICByZXR1cm4gZ2V0QmFsYW5jZShhZGRyZXNzLCAnYnRjTXVsdGlzaWdQaW5EYXRhJyk7Cn07Cgp2YXIgZ2V0QmFsYW5jZVVzZXIgPSBmdW5jdGlvbiBnZXRCYWxhbmNlVXNlcihjaGVja0FkZHJlc3MpIHsKICB2YXIgX2dldFN0YXRlMjUgPSBnZXRTdGF0ZSgpLAogICAgICBhZGRyZXNzID0gX2dldFN0YXRlMjUudXNlci5idGNNdWx0aXNpZ1VzZXJEYXRhLmFkZHJlc3M7CgogIGlmICghY2hlY2tBZGRyZXNzKSB7CiAgICByZXR1cm4gZ2V0QmFsYW5jZShhZGRyZXNzLCAnYnRjTXVsdGlzaWdVc2VyRGF0YScpOwogIH0KCiAgcmV0dXJuIGdldEFkZHJCYWxhbmNlKGNoZWNrQWRkcmVzcykudGhlbihmdW5jdGlvbiAoX3JlZjEyKSB7CiAgICB2YXIgYmFsYW5jZSA9IF9yZWYxMi5iYWxhbmNlLAogICAgICAgIHVuY29uZmlybWVkQmFsYW5jZSA9IF9yZWYxMi51bmNvbmZpcm1lZEJhbGFuY2U7CiAgICByZWR1Y2Vycy51c2VyLnNldEJ0Y011bHRpc2lnQmFsYW5jZSh7CiAgICAgIGFkZHJlc3M6IGNoZWNrQWRkcmVzcywKICAgICAgYW1vdW50OiBiYWxhbmNlLAogICAgICBpc0JhbGFuY2VGZXRjaGVkOiB0cnVlLAogICAgICB1bmNvbmZpcm1lZEJhbGFuY2U6IHVuY29uZmlybWVkQmFsYW5jZQogICAgfSk7CiAgICByZXR1cm4gYmFsYW5jZTsKICB9KTsKfTsKCnZhciBnZXRCYWxhbmNlRzJGQSA9IGZ1bmN0aW9uIGdldEJhbGFuY2VHMkZBKCkge307Cgp2YXIgZmV0Y2hCYWxhbmNlID0gZnVuY3Rpb24gZmV0Y2hCYWxhbmNlKGFkZHJlc3MpIHsKICByZXR1cm4gYml0Y29pblV0aWxzLmZldGNoQmFsYW5jZSh7CiAgICBhZGRyZXNzOiBhZGRyZXNzLAogICAgd2l0aFVuY29uZmlybWVkOiBmYWxzZSwKICAgIGFwaUJpdHBheTogQklUUEFZX0FQSQogIH0pOwp9OwoKdmFyIGZldGNoVHggPSBmdW5jdGlvbiBmZXRjaFR4KGhhc2gsIGNhY2hlUmVzcG9uc2UpIHsKICByZXR1cm4gYml0Y29pblV0aWxzLmZldGNoVHgoewogICAgaGFzaDogaGFzaCwKICAgIGFwaUJpdHBheTogQklUUEFZX0FQSSwKICAgIGNhY2hlUmVzcG9uc2U6IGNhY2hlUmVzcG9uc2UKICB9KTsKfTsKCnZhciBmZXRjaFR4SW5mbyA9IGZ1bmN0aW9uIGZldGNoVHhJbmZvKGhhc2gsIGNhY2hlUmVzcG9uc2UpIHsKICByZXR1cm4gYml0Y29pblV0aWxzLmZldGNoVHhJbmZvKHsKICAgIGhhc2g6IGhhc2gsCiAgICBhcGlCaXRwYXk6IEJJVFBBWV9BUEksCiAgICBjYWNoZVJlc3BvbnNlOiBjYWNoZVJlc3BvbnNlLAogICAgaGFzQWRtaW5GZWU6IGhhc0FkbWluRmVlCiAgfSk7Cn07Cgp2YXIgZ2V0VHJhbnNhY3Rpb25Vc2VyID0gZnVuY3Rpb24gZ2V0VHJhbnNhY3Rpb25Vc2VyKCkgewogIHZhciBhZGRyZXNzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiAiIjsKCiAgaWYgKCFhZGRyZXNzKSB7CiAgICAvLyBGZXRjaCBhbGwKICAgIHJldHVybiBuZXcgUHJvbWlzZSggLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgdmFyIF9yZWYxMyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU5KHJlc29sdmUpIHsKICAgICAgICB2YXIgbXNXYWxsZXRzLCBwcm9taXNlTGlzdCwgdHhMaXN0cywgcmV0VmFsdWU7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlOSQoX2NvbnRleHQ5KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0OS5wcmV2ID0gX2NvbnRleHQ5Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDkubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0QnRjTXVsdGlzaWdLZXlzKHsKICAgICAgICAgICAgICAgICAgb3B0czogewogICAgICAgICAgICAgICAgICAgIGRvbnRGZXRjaEJhbGFuY2U6IHRydWUKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIG1zV2FsbGV0cyA9IF9jb250ZXh0OS5zZW50OwoKICAgICAgICAgICAgICAgIGlmICghbXNXYWxsZXRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDkubmV4dCA9IDEzOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvL0AKICAgICAgICAgICAgICAgIHByb21pc2VMaXN0ID0gbXNXYWxsZXRzLm1hcChmdW5jdGlvbiAod2FsbGV0RGF0YSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0VHJhbnNhY3Rpb25Vc2VyKHdhbGxldERhdGEuYWRkcmVzcyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIF9jb250ZXh0OS5uZXh0ID0gNzsKICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlTGlzdCk7CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgIHR4TGlzdHMgPSBfY29udGV4dDkuc2VudDsKICAgICAgICAgICAgICAgIHJldFZhbHVlID0gW107CiAgICAgICAgICAgICAgICB0eExpc3RzLmZvckVhY2goZnVuY3Rpb24gKHR4cykgewogICAgICAgICAgICAgICAgICAvL0AKICAgICAgICAgICAgICAgICAgcmV0VmFsdWUgPSBbXS5jb25jYXQoX3RvQ29uc3VtYWJsZUFycmF5KHJldFZhbHVlKSwgX3RvQ29uc3VtYWJsZUFycmF5KHR4cykpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXNvbHZlKHJldFZhbHVlKTsKICAgICAgICAgICAgICAgIF9jb250ZXh0OS5uZXh0ID0gMTQ7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgY2FzZSAxMzoKICAgICAgICAgICAgICAgIHJlc29sdmUoW10pOwoKICAgICAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU5KTsKICAgICAgfSkpOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeDE2KSB7CiAgICAgICAgcmV0dXJuIF9yZWYxMy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfSgpKTsKICB9CgogIHJldHVybiBnZXRUcmFuc2FjdGlvbihhZGRyZXNzLCAnYnRjIChtdWx0aXNpZyknKTsKfTsgLy9ACgoKdmFyIGdldFRyYW5zYWN0aW9uU01TID0gZnVuY3Rpb24gZ2V0VHJhbnNhY3Rpb25TTVMoKSB7CiAgdmFyIGFkZHJlc3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6ICIiOwoKICB2YXIgX2dldFN0YXRlMjYgPSBnZXRTdGF0ZSgpLAogICAgICBfZ2V0U3RhdGUyNiR1c2VyJGJ0Y00gPSBfZ2V0U3RhdGUyNi51c2VyLmJ0Y011bHRpc2lnU01TRGF0YSwKICAgICAgc21zQWRkcmVzcyA9IF9nZXRTdGF0ZTI2JHVzZXIkYnRjTS5hZGRyZXNzLAogICAgICBpc1JlZ2lzdGVyZWQgPSBfZ2V0U3RhdGUyNiR1c2VyJGJ0Y00uaXNSZWdpc3RlcmVkOwoKICBpZiAoIWlzUmVnaXN0ZXJlZCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgIHJlc29sdmUoW10pOwogICAgfSk7CiAgfQoKICByZXR1cm4gZ2V0VHJhbnNhY3Rpb24oYWRkcmVzcyB8fCBzbXNBZGRyZXNzLCAiYnRjIChzbXMtcHJvdGVjdGVkKSIpOwp9OwoKdmFyIGdldFRyYW5zYWN0aW9uUElOID0gZnVuY3Rpb24gZ2V0VHJhbnNhY3Rpb25QSU4oKSB7CiAgdmFyIGFkZHJlc3MgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6ICIiOwoKICB2YXIgX2dldFN0YXRlMjcgPSBnZXRTdGF0ZSgpLAogICAgICBfZ2V0U3RhdGUyNyR1c2VyJGJ0Y00gPSBfZ2V0U3RhdGUyNy51c2VyLmJ0Y011bHRpc2lnUGluRGF0YSwKICAgICAgcGluQWRkcmVzcyA9IF9nZXRTdGF0ZTI3JHVzZXIkYnRjTS5hZGRyZXNzLAogICAgICBpc1JlZ2lzdGVyZWQgPSBfZ2V0U3RhdGUyNyR1c2VyJGJ0Y00uaXNSZWdpc3RlcmVkOwoKICBpZiAoIWlzUmVnaXN0ZXJlZCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlKSB7CiAgICAgIHJlc29sdmUoW10pOwogICAgfSk7CiAgfQoKICByZXR1cm4gZ2V0VHJhbnNhY3Rpb24oYWRkcmVzcyB8fCBwaW5BZGRyZXNzLCAiYnRjIChwaW4tcHJvdGVjdGVkKSIpOwp9OwoKdmFyIGdldFRyYW5zYWN0aW9uRzJGQSA9IGZ1bmN0aW9uIGdldFRyYW5zYWN0aW9uRzJGQSgpIHt9OwoKdmFyIGdldEludm9pY2VzU01TID0gZnVuY3Rpb24gZ2V0SW52b2ljZXNTTVMoKSB7CiAgdmFyIF9nZXRTdGF0ZTI4ID0gZ2V0U3RhdGUoKSwKICAgICAgYWRkcmVzcyA9IF9nZXRTdGF0ZTI4LnVzZXIuYnRjTXVsdGlzaWdTTVNEYXRhLmFkZHJlc3M7CgogIHJldHVybiBhY3Rpb25zLmludm9pY2VzLmdldEludm9pY2VzKHsKICAgIGN1cnJlbmN5OiAnQlRDJywKICAgIGFkZHJlc3M6IGFkZHJlc3MKICB9KTsKfTsKCnZhciBnZXRJbnZvaWNlc1VzZXIgPSBmdW5jdGlvbiBnZXRJbnZvaWNlc1VzZXIoKSB7CiAgdmFyIF9nZXRTdGF0ZTI5ID0gZ2V0U3RhdGUoKSwKICAgICAgYWRkcmVzcyA9IF9nZXRTdGF0ZTI5LnVzZXIuYnRjTXVsdGlzaWdVc2VyRGF0YS5hZGRyZXNzOwoKICByZXR1cm4gYWN0aW9ucy5pbnZvaWNlcy5nZXRJbnZvaWNlcyh7CiAgICBjdXJyZW5jeTogJ0JUQycsCiAgICBhZGRyZXNzOiBhZGRyZXNzCiAgfSk7Cn07Cgp2YXIgZ2V0VHJhbnNhY3Rpb24gPSBmdW5jdGlvbiBnZXRUcmFuc2FjdGlvbihvd25BZGRyZXNzLCBvd25UeXBlKSB7CiAgcmV0dXJuIGJpdGNvaW5VdGlscy5nZXRUcmFuc2FjdGlvbkJsb2N5cGVyKHsKICAgIG93bkFkZHJlc3M6IG93bkFkZHJlc3MsCiAgICBvd25UeXBlOiBvd25UeXBlLAogICAgbXlXYWxsZXRzOiBbb3duQWRkcmVzc10sCiAgICBuZXR3b3JrOiBidGMubmV0d29yaywKICAgIGFwaUJsb2N5cGVyOiBCTE9DWVBFUl9BUEkKICB9KTsKfTsgLy9ACgoKdmFyIHNlbmRTTVNQcm90ZWN0ZWQgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIHZhciBfcmVmMTQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTAoKSB7CiAgICB2YXIgX3JlZjE1LAogICAgICAgIGZyb20sCiAgICAgICAgdG8sCiAgICAgICAgYW1vdW50LAogICAgICAgIGZlZVZhbHVlLAogICAgICAgIHNwZWVkLAogICAgICAgIF9nZXRTdGF0ZTMwLAogICAgICAgIF9nZXRTdGF0ZTMwJHVzZXIsCiAgICAgICAgX2dldFN0YXRlMzAkdXNlciRidGNNLAogICAgICAgIHByaXZhdGVLZXksCiAgICAgICAgc21zQWRkcmVzcywKICAgICAgICBwdWJsaWNLZXlzLAogICAgICAgIHB1YmxpY0tleSwKICAgICAgICBhZGRyZXNzLAogICAgICAgIGZlZUZyb21BbW91bnQsCiAgICAgICAgYWRtaW5GZWUsCiAgICAgICAgYWRtaW5GZWVNaW5WYWx1ZSwKICAgICAgICBhZG1pbkZlZU1pbiwKICAgICAgICBmZWVEYXRhLAogICAgICAgIHNhdG9zaGlzLAogICAgICAgIHVuc3BlbnRzLAogICAgICAgIG9yaWdpbmFsVW5zcGVudHMsCiAgICAgICAgZnVuZFZhbHVlLAogICAgICAgIHRvdGFsVW5zcGVudCwKICAgICAgICBza2lwVmFsdWUsCiAgICAgICAgcDJtcywKICAgICAgICBwc2J0LAogICAgICAgIGksCiAgICAgICAgX3Vuc3BlbnRzJGksCiAgICAgICAgdHhpZCwKICAgICAgICB2b3V0LAogICAgICAgIHJhd1R4LAogICAgICAgIHJhd1RYLAogICAgICAgIGF1dGhLZXlzLAogICAgICAgIHJlc3VsdCwKICAgICAgICBfYXJnczEwID0gYXJndW1lbnRzOwoKICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTEwJChfY29udGV4dDEwKSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dDEwLnByZXYgPSBfY29udGV4dDEwLm5leHQpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgX3JlZjE1ID0gX2FyZ3MxMC5sZW5ndGggPiAwICYmIF9hcmdzMTBbMF0gIT09IHVuZGVmaW5lZCA/IF9hcmdzMTBbMF0gOiB7fSwgZnJvbSA9IF9yZWYxNS5mcm9tLCB0byA9IF9yZWYxNS50bywgYW1vdW50ID0gX3JlZjE1LmFtb3VudCwgZmVlVmFsdWUgPSBfcmVmMTUuZmVlVmFsdWUsIHNwZWVkID0gX3JlZjE1LnNwZWVkOwogICAgICAgICAgICBfZ2V0U3RhdGUzMCA9IGdldFN0YXRlKCksIF9nZXRTdGF0ZTMwJHVzZXIgPSBfZ2V0U3RhdGUzMC51c2VyLCBfZ2V0U3RhdGUzMCR1c2VyJGJ0Y00gPSBfZ2V0U3RhdGUzMCR1c2VyLmJ0Y011bHRpc2lnU01TRGF0YSwgcHJpdmF0ZUtleSA9IF9nZXRTdGF0ZTMwJHVzZXIkYnRjTS5wcml2YXRlS2V5LCBzbXNBZGRyZXNzID0gX2dldFN0YXRlMzAkdXNlciRidGNNLmFkZHJlc3MsIHB1YmxpY0tleXMgPSBfZ2V0U3RhdGUzMCR1c2VyJGJ0Y00ucHVibGljS2V5cywgcHVibGljS2V5ID0gX2dldFN0YXRlMzAkdXNlciRidGNNLnB1YmxpY0tleSwgYWRkcmVzcyA9IF9nZXRTdGF0ZTMwJHVzZXIuYnRjRGF0YS5hZGRyZXNzOwogICAgICAgICAgICBmZWVGcm9tQW1vdW50ID0gbmV3IEJpZ051bWJlcigwKTsKCiAgICAgICAgICAgIGlmIChoYXNBZG1pbkZlZSkgewogICAgICAgICAgICAgIGFkbWluRmVlID0gaGFzQWRtaW5GZWUuZmVlLCBhZG1pbkZlZU1pblZhbHVlID0gaGFzQWRtaW5GZWUubWluOwogICAgICAgICAgICAgIGFkbWluRmVlTWluID0gbmV3IEJpZ051bWJlcihhZG1pbkZlZU1pblZhbHVlKTsKICAgICAgICAgICAgICBmZWVGcm9tQW1vdW50ID0gbmV3IEJpZ051bWJlcihhZG1pbkZlZSkuZGl2aWRlZEJ5KDEwMCkubXVsdGlwbGllZEJ5KGFtb3VudCk7CiAgICAgICAgICAgICAgaWYgKGFkbWluRmVlTWluLmlzR3JlYXRlclRoYW4oZmVlRnJvbUFtb3VudCkpIGZlZUZyb21BbW91bnQgPSBhZG1pbkZlZU1pbjsKICAgICAgICAgICAgICBmZWVGcm9tQW1vdW50ID0gZmVlRnJvbUFtb3VudC5tdWx0aXBsaWVkQnkoMWU4KS5pbnRlZ2VyVmFsdWUoKTsgLy8gQWRtaW4gZmVlIGluIHNhdG9zaGkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZmVlRnJvbUFtb3VudCA9IGZlZUZyb21BbW91bnQudG9OdW1iZXIoKTsKICAgICAgICAgICAgX2NvbnRleHQxMC5uZXh0ID0gNzsKICAgICAgICAgICAgcmV0dXJuIGJ0Yy5lc3RpbWF0ZUZlZVZhbHVlKHsKICAgICAgICAgICAgICBpblNhdG9zaGlzOiB0cnVlLAogICAgICAgICAgICAgIHNwZWVkOiBzcGVlZCwKICAgICAgICAgICAgICBtZXRob2Q6ICdzZW5kXzJmYScsCiAgICAgICAgICAgICAgYWRkcmVzczogc21zQWRkcmVzcywKICAgICAgICAgICAgICBhbW91bnQ6IGFtb3VudCwKICAgICAgICAgICAgICBtb3JlSW5mbzogdHJ1ZQogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgIGZlZURhdGEgPSBfY29udGV4dDEwLnNlbnQ7CiAgICAgICAgICAgIHNhdG9zaGlzID0gZmVlRGF0YS5zYXRvc2hpcywgdW5zcGVudHMgPSBmZWVEYXRhLnVuc3BlbnRzLCBvcmlnaW5hbFVuc3BlbnRzID0gZmVlRGF0YS51bnNwZW50czsKICAgICAgICAgICAgZmVlVmFsdWUgPSBzYXRvc2hpczsKICAgICAgICAgICAgZnVuZFZhbHVlID0gbmV3IEJpZ051bWJlcihTdHJpbmcoYW1vdW50KSkubXVsdGlwbGllZEJ5KDFlOCkuaW50ZWdlclZhbHVlKCkudG9OdW1iZXIoKTsKICAgICAgICAgICAgdG90YWxVbnNwZW50ID0gdW5zcGVudHMucmVkdWNlKGZ1bmN0aW9uIChzdW1tLCBfcmVmMTYpIHsKICAgICAgICAgICAgICB2YXIgc2F0b3NoaXMgPSBfcmVmMTYuc2F0b3NoaXM7CiAgICAgICAgICAgICAgcmV0dXJuIHN1bW0gKyBzYXRvc2hpczsKICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgIHNraXBWYWx1ZSA9IHRvdGFsVW5zcGVudCAtIGZ1bmRWYWx1ZSAtIGZlZVZhbHVlIC0gZmVlRnJvbUFtb3VudDsKICAgICAgICAgICAgcDJtcyA9IGJpdGNvaW4ucGF5bWVudHMucDJtcyh7CiAgICAgICAgICAgICAgbTogMiwKICAgICAgICAgICAgICBuOiBwdWJsaWNLZXlzLmxlbmd0aCwKICAgICAgICAgICAgICBwdWJrZXlzOiBwdWJsaWNLZXlzLAogICAgICAgICAgICAgIG5ldHdvcms6IGJ0Yy5uZXR3b3JrCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBwc2J0ID0gbmV3IGJpdGNvaW4uUHNidCh7CiAgICAgICAgICAgICAgbmV0d29yazogYnRjLm5ldHdvcmsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHBzYnQuYWRkT3V0cHV0KHsKICAgICAgICAgICAgICBhZGRyZXNzOiB0bywKICAgICAgICAgICAgICB2YWx1ZTogZnVuZFZhbHVlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHNraXBWYWx1ZSA+IDU0NikgewogICAgICAgICAgICAgIHBzYnQuYWRkT3V0cHV0KHsKICAgICAgICAgICAgICAgIGFkZHJlc3M6IGZyb20sCiAgICAgICAgICAgICAgICB2YWx1ZTogc2tpcFZhbHVlCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChoYXNBZG1pbkZlZSkgewogICAgICAgICAgICAgIC8vIGFkbWluIGZlZSBvdXRwdXQKICAgICAgICAgICAgICBwc2J0LmFkZE91dHB1dCh7CiAgICAgICAgICAgICAgICBhZGRyZXNzOiBoYXNBZG1pbkZlZS5hZGRyZXNzLAogICAgICAgICAgICAgICAgdmFsdWU6IGZlZUZyb21BbW91bnQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaSA9IDA7CgogICAgICAgICAgY2FzZSAxOToKICAgICAgICAgICAgaWYgKCEoaSA8IHVuc3BlbnRzLmxlbmd0aCkpIHsKICAgICAgICAgICAgICBfY29udGV4dDEwLm5leHQgPSAyODsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3Vuc3BlbnRzJGkgPSB1bnNwZW50c1tpXSwgdHhpZCA9IF91bnNwZW50cyRpLnR4aWQsIHZvdXQgPSBfdW5zcGVudHMkaS52b3V0OwogICAgICAgICAgICBfY29udGV4dDEwLm5leHQgPSAyMzsKICAgICAgICAgICAgcmV0dXJuIGFjdGlvbnMuYnRjLmZldGNoVHhSYXcodHhpZCwgewogICAgICAgICAgICAgIGNhY2hlUmVzcG9uc2U6IDUwMDAKICAgICAgICAgICAgfSk7CgogICAgICAgICAgY2FzZSAyMzoKICAgICAgICAgICAgcmF3VHggPSBfY29udGV4dDEwLnNlbnQ7CiAgICAgICAgICAgIHBzYnQuYWRkSW5wdXQoewogICAgICAgICAgICAgIGhhc2g6IHR4aWQsCiAgICAgICAgICAgICAgaW5kZXg6IHZvdXQsCiAgICAgICAgICAgICAgcmVkZWVtU2NyaXB0OiBwMm1zLm91dHB1dCwKICAgICAgICAgICAgICBub25XaXRuZXNzVXR4bzogQnVmZmVyLmZyb20ocmF3VHgsICdoZXgnKQogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDI1OgogICAgICAgICAgICBpKys7CiAgICAgICAgICAgIF9jb250ZXh0MTAubmV4dCA9IDE5OwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDI4OgogICAgICAgICAgICBwc2J0LnNpZ25BbGxJbnB1dHMoYml0Y29pbi5FQ1BhaXIuZnJvbVdJRihwcml2YXRlS2V5LCBidGMubmV0d29yaykpOwogICAgICAgICAgICByYXdUWCA9IHBzYnQudG9IZXgoKTsKICAgICAgICAgICAgYXV0aEtleXMgPSBwdWJsaWNLZXlzLnNsaWNlKDEpOwogICAgICAgICAgICBhdXRoS2V5cyA9IEpTT04uc3RyaW5naWZ5KGF1dGhLZXlzLm1hcChmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGtleS50b1N0cmluZygnSGV4Jyk7CiAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgX2NvbnRleHQxMC5wcmV2ID0gMzI7CiAgICAgICAgICAgIF9jb250ZXh0MTAubmV4dCA9IDM1OwogICAgICAgICAgICByZXR1cm4gYXBpTG9vcGVyLnBvc3QoJ2J0YzJGQVByb3RlY3RlZCcsICIvcHVzaC8iLCB7CiAgICAgICAgICAgICAgYm9keTogewogICAgICAgICAgICAgICAgYWRkcmVzczogYWRkcmVzcywKICAgICAgICAgICAgICAgIHB1YmxpY0tleTogYXV0aEtleXMsCiAgICAgICAgICAgICAgICBjaGVja1NpZ246IF9nZXRTaWduLAogICAgICAgICAgICAgICAgcmF3VFg6IHJhd1RYLAogICAgICAgICAgICAgICAgbWFpbm5ldDogcHJvY2Vzcy5lbnYuTUFJTk5FVCA/IHRydWUgOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNvdXJjZTogd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB0aW1lb3V0OiB7CiAgICAgICAgICAgICAgICByZXNwb25zZTogMCwKICAgICAgICAgICAgICAgIGRlYWRsaW5lOiA1MDAwCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDM1OgogICAgICAgICAgICByZXN1bHQgPSBfY29udGV4dDEwLnNlbnQ7CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDEwLmFicnVwdCgicmV0dXJuIiwgX29iamVjdFNwcmVhZChfb2JqZWN0U3ByZWFkKHt9LCByZXN1bHQpLCB7fSwgewogICAgICAgICAgICAgIHJhd1R4OiByYXdUWAogICAgICAgICAgICB9KSk7CgogICAgICAgICAgY2FzZSAzOToKICAgICAgICAgICAgX2NvbnRleHQxMC5wcmV2ID0gMzk7CiAgICAgICAgICAgIF9jb250ZXh0MTAudDAgPSBfY29udGV4dDEwWyJjYXRjaCJdKDMyKTsKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTAuYWJydXB0KCJyZXR1cm4iLCB7CiAgICAgICAgICAgICAgZXJyb3I6IF9jb250ZXh0MTAudDAubWVzc2FnZSwKICAgICAgICAgICAgICByYXdUeDogcmF3VFgKICAgICAgICAgICAgfSk7CgogICAgICAgICAgY2FzZSA0MjoKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDEwLnN0b3AoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIF9jYWxsZWUxMCwgbnVsbCwgW1szMiwgMzldXSk7CiAgfSkpOwoKICByZXR1cm4gZnVuY3Rpb24gc2VuZFNNU1Byb3RlY3RlZCgpIHsKICAgIHJldHVybiBfcmVmMTQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Owp9KCk7IC8vQAoKCnZhciBzZW5kUGluUHJvdGVjdGVkID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICB2YXIgX3JlZjE3ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTExKCkgewogICAgdmFyIF9yZWYxOCwKICAgICAgICBmcm9tLAogICAgICAgIHRvLAogICAgICAgIGFtb3VudCwKICAgICAgICBmZWVWYWx1ZSwKICAgICAgICBzcGVlZCwKICAgICAgICBwYXNzd29yZCwKICAgICAgICBtbmVtb25pYywKICAgICAgICBfZ2V0U3RhdGUzMSwKICAgICAgICBfZ2V0U3RhdGUzMSR1c2VyLAogICAgICAgIF9nZXRTdGF0ZTMxJHVzZXIkYnRjTSwKICAgICAgICBwcml2YXRlS2V5LAogICAgICAgIHB1YmxpY0tleXMsCiAgICAgICAgcHVibGljS2V5LAogICAgICAgIHBpbkFkZHJlc3MsCiAgICAgICAgYWRkcmVzcywKICAgICAgICBmZWVGcm9tQW1vdW50LAogICAgICAgIHRvdGFsQW1vdW50LAogICAgICAgIGFkbWluRmVlLAogICAgICAgIGFkbWluRmVlTWluVmFsdWUsCiAgICAgICAgYWRtaW5GZWVNaW4sCiAgICAgICAgZmVlRGF0YSwKICAgICAgICBzYXRvc2hpcywKICAgICAgICB1bnNwZW50cywKICAgICAgICBvcmlnaW5hbFVuc3BlbnRzLAogICAgICAgIGZ1bmRWYWx1ZSwKICAgICAgICB0b3RhbFVuc3BlbnQsCiAgICAgICAgc2tpcFZhbHVlLAogICAgICAgIHAybXMsCiAgICAgICAgcHNidCwKICAgICAgICBpLAogICAgICAgIF91bnNwZW50cyRpMiwKICAgICAgICB0eGlkLAogICAgICAgIHZvdXQsCiAgICAgICAgcmF3VHhvLAogICAgICAgIHJhd1RYLAogICAgICAgIG1uZW1vbmljVHgsCiAgICAgICAgYnJvYWRjYXN0UmVzdWx0LAogICAgICAgIGF1dGhLZXlzLAogICAgICAgIHJlc3VsdCwKICAgICAgICBfYnJvYWRjYXN0UmVzdWx0LAogICAgICAgIF9hcmdzMTEgPSBhcmd1bWVudHM7CgogICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMTEkKF9jb250ZXh0MTEpIHsKICAgICAgd2hpbGUgKDEpIHsKICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTEucHJldiA9IF9jb250ZXh0MTEubmV4dCkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBfcmVmMTggPSBfYXJnczExLmxlbmd0aCA+IDAgJiYgX2FyZ3MxMVswXSAhPT0gdW5kZWZpbmVkID8gX2FyZ3MxMVswXSA6IHt9LCBmcm9tID0gX3JlZjE4LmZyb20sIHRvID0gX3JlZjE4LnRvLCBhbW91bnQgPSBfcmVmMTguYW1vdW50LCBmZWVWYWx1ZSA9IF9yZWYxOC5mZWVWYWx1ZSwgc3BlZWQgPSBfcmVmMTguc3BlZWQsIHBhc3N3b3JkID0gX3JlZjE4LnBhc3N3b3JkLCBtbmVtb25pYyA9IF9yZWYxOC5tbmVtb25pYzsKICAgICAgICAgICAgX2dldFN0YXRlMzEgPSBnZXRTdGF0ZSgpLCBfZ2V0U3RhdGUzMSR1c2VyID0gX2dldFN0YXRlMzEudXNlciwgX2dldFN0YXRlMzEkdXNlciRidGNNID0gX2dldFN0YXRlMzEkdXNlci5idGNNdWx0aXNpZ1BpbkRhdGEsIHByaXZhdGVLZXkgPSBfZ2V0U3RhdGUzMSR1c2VyJGJ0Y00ucHJpdmF0ZUtleSwgcHVibGljS2V5cyA9IF9nZXRTdGF0ZTMxJHVzZXIkYnRjTS5wdWJsaWNLZXlzLCBwdWJsaWNLZXkgPSBfZ2V0U3RhdGUzMSR1c2VyJGJ0Y00ucHVibGljS2V5LCBwaW5BZGRyZXNzID0gX2dldFN0YXRlMzEkdXNlciRidGNNLmFkZHJlc3MsIGFkZHJlc3MgPSBfZ2V0U3RhdGUzMSR1c2VyLmJ0Y0RhdGEuYWRkcmVzczsKICAgICAgICAgICAgZmVlRnJvbUFtb3VudCA9IG5ldyBCaWdOdW1iZXIoMCk7CiAgICAgICAgICAgIHRvdGFsQW1vdW50ID0gbmV3IEJpZ051bWJlcihTdHJpbmcoYW1vdW50KSkubXVsdGlwbGllZEJ5KDFlOCkuaW50ZWdlclZhbHVlKCkudG9OdW1iZXIoKTsKCiAgICAgICAgICAgIGlmIChoYXNBZG1pbkZlZSkgewogICAgICAgICAgICAgIGFkbWluRmVlID0gaGFzQWRtaW5GZWUuZmVlLCBhZG1pbkZlZU1pblZhbHVlID0gaGFzQWRtaW5GZWUubWluOwogICAgICAgICAgICAgIGFkbWluRmVlTWluID0gbmV3IEJpZ051bWJlcihhZG1pbkZlZU1pblZhbHVlKTsKICAgICAgICAgICAgICBmZWVGcm9tQW1vdW50ID0gbmV3IEJpZ051bWJlcihhZG1pbkZlZSkuZGl2aWRlZEJ5KDEwMCkubXVsdGlwbGllZEJ5KGFtb3VudCk7CiAgICAgICAgICAgICAgaWYgKGFkbWluRmVlTWluLmlzR3JlYXRlclRoYW4oZmVlRnJvbUFtb3VudCkpIGZlZUZyb21BbW91bnQgPSBhZG1pbkZlZU1pbjsKICAgICAgICAgICAgICBmZWVGcm9tQW1vdW50ID0gZmVlRnJvbUFtb3VudC5tdWx0aXBsaWVkQnkoMWU4KS5pbnRlZ2VyVmFsdWUoKTsgLy8gQWRtaW4gZmVlIGluIHNhdG9zaGkKCiAgICAgICAgICAgICAgdG90YWxBbW91bnQgPSBuZXcgQmlnTnVtYmVyKHRvdGFsQW1vdW50KS5wbHVzKGZlZUZyb21BbW91bnQpLmludGVnZXJWYWx1ZSgpLnRvTnVtYmVyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZlZUZyb21BbW91bnQgPSBmZWVGcm9tQW1vdW50LnRvTnVtYmVyKCk7CiAgICAgICAgICAgIF9jb250ZXh0MTEubmV4dCA9IDg7CiAgICAgICAgICAgIHJldHVybiBidGMuZXN0aW1hdGVGZWVWYWx1ZSh7CiAgICAgICAgICAgICAgaW5TYXRvc2hpczogdHJ1ZSwKICAgICAgICAgICAgICBzcGVlZDogc3BlZWQsCiAgICAgICAgICAgICAgbWV0aG9kOiAnc2VuZF8yZmEnLAogICAgICAgICAgICAgIGFkZHJlc3M6IHBpbkFkZHJlc3MsCiAgICAgICAgICAgICAgbW9yZUluZm86IHRydWUsCiAgICAgICAgICAgICAgYW1vdW50OiBuZXcgQmlnTnVtYmVyKHRvdGFsQW1vdW50KS5kaXZpZGVkQnkoMWU4KS50b051bWJlcigpCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgZmVlRGF0YSA9IF9jb250ZXh0MTEuc2VudDsKICAgICAgICAgICAgc2F0b3NoaXMgPSBmZWVEYXRhLnNhdG9zaGlzLCB1bnNwZW50cyA9IGZlZURhdGEudW5zcGVudHMsIG9yaWdpbmFsVW5zcGVudHMgPSBmZWVEYXRhLnVuc3BlbnRzOwogICAgICAgICAgICBmZWVWYWx1ZSA9IHNhdG9zaGlzOwogICAgICAgICAgICBmdW5kVmFsdWUgPSBuZXcgQmlnTnVtYmVyKFN0cmluZyhhbW91bnQpKS5tdWx0aXBsaWVkQnkoMWU4KS5pbnRlZ2VyVmFsdWUoKS50b051bWJlcigpOwogICAgICAgICAgICB0b3RhbFVuc3BlbnQgPSB1bnNwZW50cy5yZWR1Y2UoZnVuY3Rpb24gKHN1bW0sIF9yZWYxOSkgewogICAgICAgICAgICAgIHZhciBzYXRvc2hpcyA9IF9yZWYxOS5zYXRvc2hpczsKICAgICAgICAgICAgICByZXR1cm4gc3VtbSArIHNhdG9zaGlzOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgc2tpcFZhbHVlID0gdG90YWxVbnNwZW50IC0gZnVuZFZhbHVlIC0gZmVlVmFsdWUgLSBmZWVGcm9tQW1vdW50OwoKICAgICAgICAgICAgaWYgKG5ldyBCaWdOdW1iZXIoc2tpcFZhbHVlKS5pc0xlc3NUaGFuKDApKSB7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coJz4+Pj4+IHNraXAgaXMgbGVzcyB0aGFuIHplcm8nLCBza2lwVmFsdWUsIGZ1bmRWYWx1ZSwgdG90YWxVbnNwZW50KTsKICAgICAgICAgICAgICBmdW5kVmFsdWUgPSBuZXcgQmlnTnVtYmVyKGZ1bmRWYWx1ZSkucGx1cyhza2lwVmFsdWUpLmludGVnZXJWYWx1ZSgpLnRvTnVtYmVyKCk7CiAgICAgICAgICAgICAgc2tpcFZhbHVlID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcDJtcyA9IGJpdGNvaW4ucGF5bWVudHMucDJtcyh7CiAgICAgICAgICAgICAgbTogMiwKICAgICAgICAgICAgICBuOiBwdWJsaWNLZXlzLmxlbmd0aCwKICAgICAgICAgICAgICBwdWJrZXlzOiBwdWJsaWNLZXlzLAogICAgICAgICAgICAgIG5ldHdvcms6IGJ0Yy5uZXR3b3JrCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBwc2J0ID0gbmV3IGJpdGNvaW4uUHNidCh7CiAgICAgICAgICAgICAgbmV0d29yazogYnRjLm5ldHdvcmsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHBzYnQuYWRkT3V0cHV0KHsKICAgICAgICAgICAgICBhZGRyZXNzOiB0bywKICAgICAgICAgICAgICB2YWx1ZTogZnVuZFZhbHVlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHNraXBWYWx1ZSA+IDU0NikgewogICAgICAgICAgICAgIHBzYnQuYWRkT3V0cHV0KHsKICAgICAgICAgICAgICAgIGFkZHJlc3M6IGZyb20sCiAgICAgICAgICAgICAgICB2YWx1ZTogc2tpcFZhbHVlCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChoYXNBZG1pbkZlZSkgewogICAgICAgICAgICAgIC8vIGFkbWluIGZlZSBvdXRwdXQKICAgICAgICAgICAgICBwc2J0LmFkZE91dHB1dCh7CiAgICAgICAgICAgICAgICBhZGRyZXNzOiBoYXNBZG1pbkZlZS5hZGRyZXNzLAogICAgICAgICAgICAgICAgdmFsdWU6IGZlZUZyb21BbW91bnQKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaSA9IDA7CgogICAgICAgICAgY2FzZSAyMToKICAgICAgICAgICAgaWYgKCEoaSA8IHVuc3BlbnRzLmxlbmd0aCkpIHsKICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSAzMDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3Vuc3BlbnRzJGkyID0gdW5zcGVudHNbaV0sIHR4aWQgPSBfdW5zcGVudHMkaTIudHhpZCwgdm91dCA9IF91bnNwZW50cyRpMi52b3V0OwogICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSAyNTsKICAgICAgICAgICAgcmV0dXJuIGFjdGlvbnMuYnRjLmZldGNoVHhSYXcodHhpZCwgewogICAgICAgICAgICAgIGNhY2hlUmVzcG9uc2U6IDUwMDAKICAgICAgICAgICAgfSk7CgogICAgICAgICAgY2FzZSAyNToKICAgICAgICAgICAgcmF3VHhvID0gX2NvbnRleHQxMS5zZW50OwogICAgICAgICAgICBwc2J0LmFkZElucHV0KHsKICAgICAgICAgICAgICBoYXNoOiB0eGlkLAogICAgICAgICAgICAgIGluZGV4OiB2b3V0LAogICAgICAgICAgICAgIHJlZGVlbVNjcmlwdDogcDJtcy5vdXRwdXQsCiAgICAgICAgICAgICAgbm9uV2l0bmVzc1V0eG86IEJ1ZmZlci5mcm9tKHJhd1R4bywgJ2hleCcpCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIGNhc2UgMjc6CiAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gMjE7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgMzA6CiAgICAgICAgICAgIHBzYnQuc2lnbkFsbElucHV0cyhiaXRjb2luLkVDUGFpci5mcm9tV0lGKHByaXZhdGVLZXksIGJ0Yy5uZXR3b3JrKSk7CiAgICAgICAgICAgIHJhd1RYID0gcHNidC50b0hleCgpOwoKICAgICAgICAgICAgaWYgKCFtbmVtb25pYykgewogICAgICAgICAgICAgIF9jb250ZXh0MTEubmV4dCA9IDQ0OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSAzNTsKICAgICAgICAgICAgcmV0dXJuIHNpZ25QaW5NbmVtb25pYyhyYXdUWCwgbW5lbW9uaWMpOwoKICAgICAgICAgIGNhc2UgMzU6CiAgICAgICAgICAgIG1uZW1vbmljVHggPSBfY29udGV4dDExLnNlbnQ7CiAgICAgICAgICAgIF9jb250ZXh0MTEubmV4dCA9IDM4OwogICAgICAgICAgICByZXR1cm4gYWN0aW9ucy5idGMuYnJvYWRjYXN0VHgobW5lbW9uaWNUeCk7CgogICAgICAgICAgY2FzZSAzODoKICAgICAgICAgICAgYnJvYWRjYXN0UmVzdWx0ID0gX2NvbnRleHQxMS5zZW50OwoKICAgICAgICAgICAgaWYgKCEoYnJvYWRjYXN0UmVzdWx0ICYmIGJyb2FkY2FzdFJlc3VsdC50eGlkKSkgewogICAgICAgICAgICAgIF9jb250ZXh0MTEubmV4dCA9IDQzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMS5hYnJ1cHQoInJldHVybiIsIHsKICAgICAgICAgICAgICBhbnN3ZXI6ICdvaycsCiAgICAgICAgICAgICAgdHhJZDogYnJvYWRjYXN0UmVzdWx0LnR4aWQKICAgICAgICAgICAgfSk7CgogICAgICAgICAgY2FzZSA0MzoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuYWJydXB0KCJyZXR1cm4iLCB7CiAgICAgICAgICAgICAgZXJyb3I6ICJGYWlsIHNpZ24gdHJhbnNhY3Rpb24gYnkgbW5lbW9uaWMiCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIGNhc2UgNDQ6CiAgICAgICAgICAgIGF1dGhLZXlzID0gcHVibGljS2V5czsgLy8uc2xpY2UoMSkKCiAgICAgICAgICAgIGF1dGhLZXlzID0gSlNPTi5zdHJpbmdpZnkoYXV0aEtleXMubWFwKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgICByZXR1cm4ga2V5LnRvU3RyaW5nKCdIZXgnKTsKICAgICAgICAgICAgfSkpOwogICAgICAgICAgICBfY29udGV4dDExLnByZXYgPSA0NjsKICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gNDk7CiAgICAgICAgICAgIHJldHVybiBhcGlMb29wZXIucG9zdCgnYnRjUGluJywgIi9zaWduLyIsIHsKICAgICAgICAgICAgICBib2R5OiB7CiAgICAgICAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzLAogICAgICAgICAgICAgICAgcHVibGljS2V5OiBhdXRoS2V5cywKICAgICAgICAgICAgICAgIGNoZWNrU2lnbjogX2dldFNpZ24sCiAgICAgICAgICAgICAgICByYXdUWDogcmF3VFgsCiAgICAgICAgICAgICAgICBtYWlubmV0OiBwcm9jZXNzLmVudi5NQUlOTkVUID8gdHJ1ZSA6IGZhbHNlLAogICAgICAgICAgICAgICAgc291cmNlOiB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWUsCiAgICAgICAgICAgICAgICBwYXNzd29yZDogcGFzc3dvcmQsCiAgICAgICAgICAgICAgICB2ZXJzaW9uOiAidjUiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB0aW1lb3V0OiB7CiAgICAgICAgICAgICAgICByZXNwb25zZTogMCwKICAgICAgICAgICAgICAgIGRlYWRsaW5lOiA1MDAwCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDQ5OgogICAgICAgICAgICByZXN1bHQgPSBfY29udGV4dDExLnNlbnQ7CgogICAgICAgICAgICBpZiAoIShyZXN1bHQgJiYgcmVzdWx0LmFuc3dlciAmJiByZXN1bHQuYW5zd2VyID09PSAnb2snICYmIHJlc3VsdC5yYXdUWCkpIHsKICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSA2MTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NvbnRleHQxMS5uZXh0ID0gNTM7CiAgICAgICAgICAgIHJldHVybiBhY3Rpb25zLmJ0Yy5icm9hZGNhc3RUeChyZXN1bHQucmF3VFgpOwoKICAgICAgICAgIGNhc2UgNTM6CiAgICAgICAgICAgIF9icm9hZGNhc3RSZXN1bHQgPSBfY29udGV4dDExLnNlbnQ7CgogICAgICAgICAgICBpZiAoIShfYnJvYWRjYXN0UmVzdWx0ICYmIF9icm9hZGNhc3RSZXN1bHQudHhpZCkpIHsKICAgICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSA1ODsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuYWJydXB0KCJyZXR1cm4iLCB7CiAgICAgICAgICAgICAgYW5zd2VyOiAnb2snLAogICAgICAgICAgICAgIHR4SWQ6IF9icm9hZGNhc3RSZXN1bHQudHhpZAogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDU4OgogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMS5hYnJ1cHQoInJldHVybiIsIHsKICAgICAgICAgICAgICBlcnJvcjogJ0ZhaWwgYnJvYWRjYXN0IHRyYW5zYWN0aW9uJwogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDU5OgogICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSA2MjsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSA2MToKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuYWJydXB0KCJyZXR1cm4iLCBfb2JqZWN0U3ByZWFkKHt9LCByZXN1bHQpKTsKCiAgICAgICAgICBjYXNlIDYyOgogICAgICAgICAgICBfY29udGV4dDExLm5leHQgPSA2NzsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSA2NDoKICAgICAgICAgICAgX2NvbnRleHQxMS5wcmV2ID0gNjQ7CiAgICAgICAgICAgIF9jb250ZXh0MTEudDAgPSBfY29udGV4dDExWyJjYXRjaCJdKDQ2KTsKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTEuYWJydXB0KCJyZXR1cm4iLCB7CiAgICAgICAgICAgICAgZXJyb3I6IF9jb250ZXh0MTEudDAubWVzc2FnZSwKICAgICAgICAgICAgICByYXdUWDogcmF3VFgKICAgICAgICAgICAgfSk7CgogICAgICAgICAgY2FzZSA2NzoKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDExLnN0b3AoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIF9jYWxsZWUxMSwgbnVsbCwgW1s0NiwgNjRdXSk7CiAgfSkpOwoKICByZXR1cm4gZnVuY3Rpb24gc2VuZFBpblByb3RlY3RlZCgpIHsKICAgIHJldHVybiBfcmVmMTcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Owp9KCk7Cgp2YXIgY29uZmlybVNNU1Byb3RlY3RlZCA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgdmFyIF9yZWYyMCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxMihzbXNDb2RlKSB7CiAgICB2YXIgX2dldFN0YXRlMzIsIF9nZXRTdGF0ZTMyJHVzZXIsIF9nZXRTdGF0ZTMyJHVzZXIkYnRjTSwgcHJpdmF0ZUtleSwgcHVibGljS2V5cywgcHVibGljS2V5LCBhZGRyZXNzLCBhdXRoS2V5cywgcmVzdWx0OwoKICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTEyJChfY29udGV4dDEyKSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dDEyLnByZXYgPSBfY29udGV4dDEyLm5leHQpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgX2dldFN0YXRlMzIgPSBnZXRTdGF0ZSgpLCBfZ2V0U3RhdGUzMiR1c2VyID0gX2dldFN0YXRlMzIudXNlciwgX2dldFN0YXRlMzIkdXNlciRidGNNID0gX2dldFN0YXRlMzIkdXNlci5idGNNdWx0aXNpZ1NNU0RhdGEsIHByaXZhdGVLZXkgPSBfZ2V0U3RhdGUzMiR1c2VyJGJ0Y00ucHJpdmF0ZUtleSwgcHVibGljS2V5cyA9IF9nZXRTdGF0ZTMyJHVzZXIkYnRjTS5wdWJsaWNLZXlzLCBwdWJsaWNLZXkgPSBfZ2V0U3RhdGUzMiR1c2VyJGJ0Y00ucHVibGljS2V5LCBhZGRyZXNzID0gX2dldFN0YXRlMzIkdXNlci5idGNEYXRhLmFkZHJlc3M7CiAgICAgICAgICAgIGF1dGhLZXlzID0gcHVibGljS2V5cy5zbGljZSgxKTsKICAgICAgICAgICAgYXV0aEtleXMgPSBKU09OLnN0cmluZ2lmeShhdXRoS2V5cy5tYXAoZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgICAgIHJldHVybiBrZXkudG9TdHJpbmcoJ0hleCcpOwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIF9jb250ZXh0MTIubmV4dCA9IDU7CiAgICAgICAgICAgIHJldHVybiBhcGlMb29wZXIucG9zdCgnYnRjMkZBUHJvdGVjdGVkJywgIi9zaWduLyIsIHsKICAgICAgICAgICAgICBib2R5OiB7CiAgICAgICAgICAgICAgICBhZGRyZXNzOiBhZGRyZXNzLAogICAgICAgICAgICAgICAgdmVyc2lvbjogJ3Y1JywKICAgICAgICAgICAgICAgIHB1YmxpY0tleTogYXV0aEtleXMsCiAgICAgICAgICAgICAgICBjaGVja1NpZ246IF9nZXRTaWduLAogICAgICAgICAgICAgICAgY29kZTogc21zQ29kZSwKICAgICAgICAgICAgICAgIG1haW5uZXQ6ICEhcHJvY2Vzcy5lbnYuTUFJTk5FVCwKICAgICAgICAgICAgICAgIHNvdXJjZTogd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIHJlc3VsdCA9IF9jb250ZXh0MTIuc2VudDsKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTIuYWJydXB0KCJyZXR1cm4iLCByZXN1bHQpOwoKICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDEyLnN0b3AoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIF9jYWxsZWUxMik7CiAgfSkpOwoKICByZXR1cm4gZnVuY3Rpb24gY29uZmlybVNNU1Byb3RlY3RlZChfeDE3KSB7CiAgICByZXR1cm4gX3JlZjIwLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKfSgpOyAvL0AKCgp2YXIgc2VuZCA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgdmFyIF9yZWYyMSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxMygpIHsKICAgIHZhciBfcmVmMjIsCiAgICAgICAgZnJvbSwKICAgICAgICB0bywKICAgICAgICBhbW91bnQsCiAgICAgICAgZmVlVmFsdWUsCiAgICAgICAgc3BlZWQsCiAgICAgICAgX2dldFN0YXRlMzMsCiAgICAgICAgcHJpdmF0ZUtleSwKICAgICAgICBzZW5kZXJXYWxsZXQsCiAgICAgICAgYWRkcmVzcywKICAgICAgICBwdWJsaWNLZXlzLAogICAgICAgIGZlZUZyb21BbW91bnQsCiAgICAgICAgYWRtaW5GZWUsCiAgICAgICAgYWRtaW5GZWVNaW5WYWx1ZSwKICAgICAgICBhZG1pbkZlZU1pbiwKICAgICAgICB1bnNwZW50cywKICAgICAgICBmdW5kVmFsdWUsCiAgICAgICAgdG90YWxVbnNwZW50LAogICAgICAgIHNraXBWYWx1ZSwKICAgICAgICBwMm1zLAogICAgICAgIHAyc2gsCiAgICAgICAgcHNidCwKICAgICAgICBpLAogICAgICAgIF91bnNwZW50cyRpMywKICAgICAgICB0eGlkLAogICAgICAgIHZvdXQsCiAgICAgICAgX3Jhd1R4LAogICAgICAgIHJhd1R4LAogICAgICAgIF9hcmdzMTMgPSBhcmd1bWVudHM7CgogICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMTMkKF9jb250ZXh0MTMpIHsKICAgICAgd2hpbGUgKDEpIHsKICAgICAgICBzd2l0Y2ggKF9jb250ZXh0MTMucHJldiA9IF9jb250ZXh0MTMubmV4dCkgewogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBfcmVmMjIgPSBfYXJnczEzLmxlbmd0aCA+IDAgJiYgX2FyZ3MxM1swXSAhPT0gdW5kZWZpbmVkID8gX2FyZ3MxM1swXSA6IHt9LCBmcm9tID0gX3JlZjIyLmZyb20sIHRvID0gX3JlZjIyLnRvLCBhbW91bnQgPSBfcmVmMjIuYW1vdW50LCBmZWVWYWx1ZSA9IF9yZWYyMi5mZWVWYWx1ZSwgc3BlZWQgPSBfcmVmMjIuc3BlZWQ7CiAgICAgICAgICAgIF9nZXRTdGF0ZTMzID0gZ2V0U3RhdGUoKSwgcHJpdmF0ZUtleSA9IF9nZXRTdGF0ZTMzLnVzZXIuYnRjTXVsdGlzaWdVc2VyRGF0YS5wcml2YXRlS2V5OwogICAgICAgICAgICBzZW5kZXJXYWxsZXQgPSBhZGRyZXNzVG9XYWxsZXQoZnJvbSk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzZW5kZXJXYWxsZXQnLCBmcm9tKTsKICAgICAgICAgICAgYWRkcmVzcyA9IHNlbmRlcldhbGxldC5hZGRyZXNzLCBwdWJsaWNLZXlzID0gc2VuZGVyV2FsbGV0LnB1YmxpY0tleXM7CiAgICAgICAgICAgIF9jb250ZXh0MTMudDAgPSBmZWVWYWx1ZTsKCiAgICAgICAgICAgIGlmIChfY29udGV4dDEzLnQwKSB7CiAgICAgICAgICAgICAgX2NvbnRleHQxMy5uZXh0ID0gMTA7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jb250ZXh0MTMubmV4dCA9IDk7CiAgICAgICAgICAgIHJldHVybiBidGMuZXN0aW1hdGVGZWVWYWx1ZSh7CiAgICAgICAgICAgICAgaW5TYXRvc2hpczogdHJ1ZSwKICAgICAgICAgICAgICBzcGVlZDogc3BlZWQsCiAgICAgICAgICAgICAgbWV0aG9kOiAnc2VuZF9tdWx0aXNpZycsCiAgICAgICAgICAgICAgYWRkcmVzczogYWRkcmVzcwogICAgICAgICAgICB9KTsKCiAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgIF9jb250ZXh0MTMudDAgPSBfY29udGV4dDEzLnNlbnQ7CgogICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgZmVlVmFsdWUgPSBfY29udGV4dDEzLnQwOwogICAgICAgICAgICBmZWVGcm9tQW1vdW50ID0gbmV3IEJpZ051bWJlcigwKTsKCiAgICAgICAgICAgIGlmIChoYXNBZG1pbkZlZSkgewogICAgICAgICAgICAgIGFkbWluRmVlID0gaGFzQWRtaW5GZWUuZmVlLCBhZG1pbkZlZU1pblZhbHVlID0gaGFzQWRtaW5GZWUubWluOwogICAgICAgICAgICAgIGFkbWluRmVlTWluID0gbmV3IEJpZ051bWJlcihhZG1pbkZlZU1pblZhbHVlKTsKICAgICAgICAgICAgICBmZWVGcm9tQW1vdW50ID0gbmV3IEJpZ051bWJlcihhZG1pbkZlZSkuZGl2aWRlZEJ5KDEwMCkubXVsdGlwbGllZEJ5KGFtb3VudCk7CiAgICAgICAgICAgICAgaWYgKGFkbWluRmVlTWluLmlzR3JlYXRlclRoYW4oZmVlRnJvbUFtb3VudCkpIGZlZUZyb21BbW91bnQgPSBhZG1pbkZlZU1pbjsKICAgICAgICAgICAgICBmZWVGcm9tQW1vdW50ID0gZmVlRnJvbUFtb3VudC5tdWx0aXBsaWVkQnkoMWU4KS5pbnRlZ2VyVmFsdWUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZmVlRnJvbUFtb3VudCA9IGZlZUZyb21BbW91bnQudG9OdW1iZXIoKTsKICAgICAgICAgICAgX2NvbnRleHQxMy5uZXh0ID0gMTY7CiAgICAgICAgICAgIHJldHVybiBmZXRjaFVuc3BlbnRzKGZyb20pOwoKICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgIHVuc3BlbnRzID0gX2NvbnRleHQxMy5zZW50OwogICAgICAgICAgICBmdW5kVmFsdWUgPSBuZXcgQmlnTnVtYmVyKFN0cmluZyhhbW91bnQpKS5tdWx0aXBsaWVkQnkoMWU4KS5pbnRlZ2VyVmFsdWUoKS50b051bWJlcigpOwogICAgICAgICAgICB0b3RhbFVuc3BlbnQgPSB1bnNwZW50cy5yZWR1Y2UoZnVuY3Rpb24gKHN1bW0sIF9yZWYyMykgewogICAgICAgICAgICAgIHZhciBzYXRvc2hpcyA9IF9yZWYyMy5zYXRvc2hpczsKICAgICAgICAgICAgICByZXR1cm4gc3VtbSArIHNhdG9zaGlzOwogICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgc2tpcFZhbHVlID0gdG90YWxVbnNwZW50IC0gZnVuZFZhbHVlIC0gZmVlVmFsdWUgLSBmZWVGcm9tQW1vdW50OwogICAgICAgICAgICBwMm1zID0gYml0Y29pbi5wYXltZW50cy5wMm1zKHsKICAgICAgICAgICAgICBtOiAyLAogICAgICAgICAgICAgIG46IHB1YmxpY0tleXMubGVuZ3RoLAogICAgICAgICAgICAgIHB1YmtleXM6IHB1YmxpY0tleXMsCiAgICAgICAgICAgICAgbmV0d29yazogYnRjLm5ldHdvcmsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHAyc2ggPSBiaXRjb2luLnBheW1lbnRzLnAyc2goewogICAgICAgICAgICAgIHJlZGVlbTogcDJtcywKICAgICAgICAgICAgICBuZXR3b3JrOiBidGMubmV0d29yawogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcHNidCA9IG5ldyBiaXRjb2luLlBzYnQoewogICAgICAgICAgICAgIG5ldHdvcms6IGJ0Yy5uZXR3b3JrCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBwc2J0LmFkZE91dHB1dCh7CiAgICAgICAgICAgICAgYWRkcmVzczogdG8sCiAgICAgICAgICAgICAgdmFsdWU6IGZ1bmRWYWx1ZQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChza2lwVmFsdWUgPiA1NDYpIHsKICAgICAgICAgICAgICBwc2J0LmFkZE91dHB1dCh7CiAgICAgICAgICAgICAgICBhZGRyZXNzOiBmcm9tLAogICAgICAgICAgICAgICAgdmFsdWU6IHNraXBWYWx1ZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaGFzQWRtaW5GZWUpIHsKICAgICAgICAgICAgICAvLyBhZG1pbiBmZWUgb3V0cHV0CiAgICAgICAgICAgICAgcHNidC5hZGRPdXRwdXQoewogICAgICAgICAgICAgICAgYWRkcmVzczogaGFzQWRtaW5GZWUuYWRkcmVzcywKICAgICAgICAgICAgICAgIHZhbHVlOiBmZWVGcm9tQW1vdW50CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGkgPSAwOwoKICAgICAgICAgIGNhc2UgMjc6CiAgICAgICAgICAgIGlmICghKGkgPCB1bnNwZW50cy5sZW5ndGgpKSB7CiAgICAgICAgICAgICAgX2NvbnRleHQxMy5uZXh0ID0gMzY7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF91bnNwZW50cyRpMyA9IHVuc3BlbnRzW2ldLCB0eGlkID0gX3Vuc3BlbnRzJGkzLnR4aWQsIHZvdXQgPSBfdW5zcGVudHMkaTMudm91dDsgLy9ACgogICAgICAgICAgICBfY29udGV4dDEzLm5leHQgPSAzMTsKICAgICAgICAgICAgcmV0dXJuIGFjdGlvbnMuYnRjLmZldGNoVHhSYXcodHhpZCk7CgogICAgICAgICAgY2FzZSAzMToKICAgICAgICAgICAgX3Jhd1R4ID0gX2NvbnRleHQxMy5zZW50OwogICAgICAgICAgICBwc2J0LmFkZElucHV0KHsKICAgICAgICAgICAgICBoYXNoOiB0eGlkLAogICAgICAgICAgICAgIGluZGV4OiB2b3V0LAogICAgICAgICAgICAgIHJlZGVlbVNjcmlwdDogcDJtcy5vdXRwdXQsCiAgICAgICAgICAgICAgbm9uV2l0bmVzc1V0eG86IEJ1ZmZlci5mcm9tKF9yYXdUeCwgJ2hleCcpCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIGNhc2UgMzM6CiAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgX2NvbnRleHQxMy5uZXh0ID0gMjc7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgMzY6CiAgICAgICAgICAgIHBzYnQuc2lnbkFsbElucHV0cyhiaXRjb2luLkVDUGFpci5mcm9tV0lGKHByaXZhdGVLZXksIGJ0Yy5uZXR3b3JrKSk7CiAgICAgICAgICAgIHJhd1R4ID0gcHNidC50b0hleCgpOwogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxMy5hYnJ1cHQoInJldHVybiIsIHJhd1R4KTsKCiAgICAgICAgICBjYXNlIDM5OgogICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTMuc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgX2NhbGxlZTEzKTsKICB9KSk7CgogIHJldHVybiBmdW5jdGlvbiBzZW5kKCkgewogICAgcmV0dXJuIF9yZWYyMS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07Cn0oKTsKCnZhciBnZXRNU1dhbGxldEJ5U2NyaXB0ID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICB2YXIgX3JlZjI0ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTE0KHNjcmlwdCwgbXlCdGNXYWxsZXRzKSB7CiAgICB2YXIgd2FsbGV0czsKICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE0JChfY29udGV4dDE0KSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dDE0LnByZXYgPSBfY29udGV4dDE0Lm5leHQpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgaWYgKG15QnRjV2FsbGV0cykgewogICAgICAgICAgICAgIF9jb250ZXh0MTQubmV4dCA9IDQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF9jb250ZXh0MTQubmV4dCA9IDM7CiAgICAgICAgICAgIHJldHVybiBnZXRCdGNNdWx0aXNpZ0tleXMoKTsKCiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIG15QnRjV2FsbGV0cyA9IF9jb250ZXh0MTQuc2VudDsKCiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc2NyaXB0ICE9PSAnc3RyaW5nJykgc2NyaXB0ID0gYml0Y29pbi5zY3JpcHQudG9BU00oc2NyaXB0KTsKICAgICAgICAgICAgd2FsbGV0cyA9IG15QnRjV2FsbGV0cy5maWx0ZXIoZnVuY3Rpb24gKHdhbGxldCkgewogICAgICAgICAgICAgIHZhciBrZXlzID0gd2FsbGV0LnB1YmxpY0tleXMubWFwKGZ1bmN0aW9uIChidWYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBidWYudG9TdHJpbmcoJ2hleCcpOwogICAgICAgICAgICAgIH0pLmpvaW4oIiAiKTsKICAgICAgICAgICAgICB2YXIgd2FsbGV0U2NyaXB0ID0gIk9QXzIgIi5jb25jYXQoa2V5cywgIiBPUF8yIE9QX0NIRUNLTVVMVElTSUciKTsKCiAgICAgICAgICAgICAgaWYgKHdhbGxldFNjcmlwdCA9PT0gc2NyaXB0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pLm1hcChmdW5jdGlvbiAod2FsbGV0KSB7CiAgICAgICAgICAgICAgdmFyIHB1YmxpY0tleXMgPSB3YWxsZXQucHVibGljS2V5cywKICAgICAgICAgICAgICAgICAgcHVibGljS2V5ID0gd2FsbGV0LnB1YmxpY0tleSwKICAgICAgICAgICAgICAgICAgYWRkcmVzcyA9IHdhbGxldC5hZGRyZXNzLAogICAgICAgICAgICAgICAgICBiYWxhbmNlID0gd2FsbGV0LmJhbGFuY2U7CiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHB1YmxpY0tleXM6IHB1YmxpY0tleXMsCiAgICAgICAgICAgICAgICBwdWJsaWNLZXk6IHB1YmxpY0tleSwKICAgICAgICAgICAgICAgIGFkZHJlc3M6IGFkZHJlc3MsCiAgICAgICAgICAgICAgICBiYWxhbmNlOiBiYWxhbmNlCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE0LmFicnVwdCgicmV0dXJuIiwgd2FsbGV0cy5sZW5ndGggPyB3YWxsZXRzWzBdIDogZmFsc2UpOwoKICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE0LnN0b3AoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIF9jYWxsZWUxNCk7CiAgfSkpOwoKICByZXR1cm4gZnVuY3Rpb24gZ2V0TVNXYWxsZXRCeVNjcmlwdChfeDE4LCBfeDE5KSB7CiAgICByZXR1cm4gX3JlZjI0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKfSgpOwoKdmFyIHBhcnNlUmF3VFggPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogIHZhciBfcmVmMjUgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTcodHhIYXNoKSB7CiAgICB2YXIgbXlCdGNXYWxsZXRzLCBteUJ0Y0FkZHJlc2VzLCBwc2J0LCBwYXJzZWRUWDsKICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE3JChfY29udGV4dDE3KSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dDE3LnByZXYgPSBfY29udGV4dDE3Lm5leHQpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgX2NvbnRleHQxNy5uZXh0ID0gMjsKICAgICAgICAgICAgcmV0dXJuIGdldEJ0Y011bHRpc2lnS2V5cygpOwoKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgbXlCdGNXYWxsZXRzID0gX2NvbnRleHQxNy5zZW50OwogICAgICAgICAgICAvL0AKICAgICAgICAgICAgbXlCdGNBZGRyZXNlcyA9IG15QnRjV2FsbGV0cy5tYXAoZnVuY3Rpb24gKHdhbGxldCkgewogICAgICAgICAgICAgIHJldHVybiB3YWxsZXQuYWRkcmVzczsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHBzYnQgPSBiaXRjb2luLlBzYnQuZnJvbUhleCh0eEhhc2gpOwogICAgICAgICAgICBwYXJzZWRUWCA9IHsKICAgICAgICAgICAgICBwc2J0OiBwc2J0LAogICAgICAgICAgICAgIGlucHV0OiBbXSwKICAgICAgICAgICAgICBvdXRwdXQ6IFtdLAogICAgICAgICAgICAgIGZyb206IGZhbHNlLAogICAgICAgICAgICAgIHRvOiBmYWxzZSwKICAgICAgICAgICAgICBvdXQ6IHt9LAogICAgICAgICAgICAgIGlzT3VyOiBmYWxzZSwKICAgICAgICAgICAgICBhbW91bnQ6IG5ldyBCaWdOdW1iZXIoMCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgX2NvbnRleHQxNy5uZXh0ID0gODsKICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChpbnB1dFBhcnNlZCkgewogICAgICAgICAgICAgIHBzYnQuZGF0YS5pbnB1dHMuZm9yRWFjaCggLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBfcmVmMjYgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMTUoaW5wdXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIHJlZGVlbVNjcmlwdCwgaW5wdXRXYWxsZXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE1JChfY29udGV4dDE1KSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQxNS5wcmV2ID0gX2NvbnRleHQxNS5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgICByZWRlZW1TY3JpcHQgPSBpbnB1dC5yZWRlZW1TY3JpcHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQxNS5uZXh0ID0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0TVNXYWxsZXRCeVNjcmlwdChyZWRlZW1TY3JpcHQsIG15QnRjV2FsbGV0cyk7CgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRXYWxsZXQgPSBfY29udGV4dDE1LnNlbnQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dFdhbGxldCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0V2FsbGV0LmFkZHJlc3MpIHBhcnNlZFRYLmZyb20gPSBpbnB1dFdhbGxldC5hZGRyZXNzOyAvL0AKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJzZWRUWC53YWxsZXQgPSBpbnB1dFdhbGxldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZFRYLmlzT3VyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTUuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwgX2NhbGxlZTE1KTsKICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKF94MjEpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWYyNi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9KCkpOwogICAgICAgICAgICAgIGlucHV0UGFyc2VkKHRydWUpOwogICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAvL0AKICAgICAgICAgICAgICBwc2J0LmRhdGEuZ2xvYmFsTWFwLnVuc2lnbmVkVHgudHgub3V0cy5mb3JFYWNoKCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIF9yZWYyNyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxNihvdXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIGFkZHJlc3MsIG91dFdhbGxldDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMTYkKF9jb250ZXh0MTYpIHsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDE2LnByZXYgPSBfY29udGV4dDE2Lm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgPSBiaXRjb2luLmFkZHJlc3MuZnJvbU91dHB1dFNjcmlwdChvdXQuc2NyaXB0LCBidGMubmV0d29yayk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcGFyc2VkVFguaXNPdXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vQAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0V2FsbGV0ID0gbXlCdGNXYWxsZXRzLmZpbHRlcihmdW5jdGlvbiAod2FsbGV0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3YWxsZXQuYWRkcmVzcyA9PT0gYWRkcmVzczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvdXRXYWxsZXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvdXRXYWxsZXRbMF0uYWRkcmVzcykgcGFyc2VkVFguZnJvbSA9IG91dFdhbGxldFswXS5hZGRyZXNzOyAvL0AKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZFRYLndhbGxldCA9IG91dFdhbGxldFswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VkVFguaXNPdXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gLy9ACgoKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyc2VkVFguZnJvbSAhPT0gYWRkcmVzcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXJzZWRUWC5vdXRbYWRkcmVzc10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VkVFgub3V0W2FkZHJlc3NdID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiBhZGRyZXNzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudDogbmV3IEJpZ051bWJlcihvdXQudmFsdWUpLmRpdmlkZWRCeSgxZTgpLnRvTnVtYmVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZFRYLm91dFthZGRyZXNzXS5hbW91bnQgPSBwYXJzZWRUWC5vdXRbYWRkcmVzc10uYW1vdW50LnBsdXMobmV3IEJpZ051bWJlcihvdXQudmFsdWUpLmRpdmlkZWRCeSgxZTgpLnRvTnVtYmVyKCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZFRYLmFtb3VudCA9IHBhcnNlZFRYLmFtb3VudC5wbHVzKG5ldyBCaWdOdW1iZXIob3V0LnZhbHVlKS5kaXZpZGVkQnkoMWU4KS50b051bWJlcigpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlZFRYLm91dHB1dC5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3M6IGFkZHJlc3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZVNhdG9zaGk6IG91dC52YWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXcgQmlnTnVtYmVyKG91dC52YWx1ZSkuZGl2aWRlZEJ5KDFlOCkudG9OdW1iZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE2LnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUxNik7CiAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeDIyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmMjcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfSgpKTsKCiAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKHBhcnNlZFRYLm91dCkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBwYXJzZWRUWC50byA9IHBhcnNlZFRYLm91dFtPYmplY3Qua2V5cyhwYXJzZWRUWC5vdXQpWzBdXS50bzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY29uc29sZS5sb2coJ3BhcnNlZFRYJywgcGFyc2VkVFgpOwogICAgICAgICAgICByZXR1cm4gX2NvbnRleHQxNy5hYnJ1cHQoInJldHVybiIsIHBhcnNlZFRYKTsKCiAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTcuc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgX2NhbGxlZTE3KTsKICB9KSk7CgogIHJldHVybiBmdW5jdGlvbiBwYXJzZVJhd1RYKF94MjApIHsKICAgIHJldHVybiBfcmVmMjUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Owp9KCk7Cgp2YXIgc2lnbk1vZk5CeU1uZW1vbmljID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICB2YXIgX3JlZjI4ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTE4KHR4SGFzaCwgb3B0aW9uX00sIHB1YmxpY0tleXMsIG1uZW1vbmljLCB3YWxsZXROdW1iZXIsIG93blBhdGgpIHsKICAgIHZhciBtbmVtb25pY1dhbGxldCwgdHhiLCBwMm1zLCBwMnNoLCB0eCwgdHhIZXg7CiAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUxOCQoX2NvbnRleHQxOCkgewogICAgICB3aGlsZSAoMSkgewogICAgICAgIHN3aXRjaCAoX2NvbnRleHQxOC5wcmV2ID0gX2NvbnRleHQxOC5uZXh0KSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIG1uZW1vbmljV2FsbGV0ID0gYWN0aW9ucy5idGMuZ2V0V2FsbGV0QnlXb3JkcyhtbmVtb25pYywgd2FsbGV0TnVtYmVyLCBvd25QYXRoKTsKCiAgICAgICAgICAgIGlmICghbW5lbW9uaWNXYWxsZXQpIHsKICAgICAgICAgICAgICBfY29udGV4dDE4Lm5leHQgPSAxNTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc29sZS5sb2cobW5lbW9uaWNXYWxsZXQpOwogICAgICAgICAgICBjb25zb2xlLmxvZyh0eEhhc2gpOwogICAgICAgICAgICB0eGIgPSBiaXRjb2luLlRyYW5zYWN0aW9uQnVpbGRlci5mcm9tVHJhbnNhY3Rpb24oYml0Y29pbi5UcmFuc2FjdGlvbi5mcm9tSGV4KHR4SGFzaCksIGJ0Yy5uZXR3b3JrKTsKICAgICAgICAgICAgY29uc29sZS5sb2coJ3AybXMnLCBvcHRpb25fTSwgcHVibGljS2V5cy5sZW5ndGgsIHB1YmxpY0tleXMpOwogICAgICAgICAgICBwMm1zID0gYml0Y29pbi5wYXltZW50cy5wMm1zKHsKICAgICAgICAgICAgICBtOiBvcHRpb25fTSwKICAgICAgICAgICAgICBuOiBwdWJsaWNLZXlzLmxlbmd0aCwKICAgICAgICAgICAgICBwdWJrZXlzOiBwdWJsaWNLZXlzLAogICAgICAgICAgICAgIG5ldHdvcms6IGJ0Yy5uZXR3b3JrCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBwMnNoID0gYml0Y29pbi5wYXltZW50cy5wMnNoKHsKICAgICAgICAgICAgICByZWRlZW06IHAybXMsCiAgICAgICAgICAgICAgbmV0d29yazogYnRjLm5ldHdvcmsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKHR4Yik7IC8vQAoKICAgICAgICAgICAgdHhiLl9fSU5QVVRTLmZvckVhY2goZnVuY3Rpb24gKGlucHV0LCBpbmRleCkgewogICAgICAgICAgICAgIHR4Yi5zaWduKGluZGV4LCBiaXRjb2luLkVDUGFpci5mcm9tV0lGKG1uZW1vbmljV2FsbGV0LldJRiwgYnRjLm5ldHdvcmspLCBwMnNoLnJlZGVlbS5vdXRwdXQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIF9jb250ZXh0MTgubmV4dCA9IDEyOwogICAgICAgICAgICByZXR1cm4gdHhiLmJ1aWxkKCk7CgogICAgICAgICAgY2FzZSAxMjoKICAgICAgICAgICAgdHggPSBfY29udGV4dDE4LnNlbnQ7CiAgICAgICAgICAgIHR4SGV4ID0gdHgudG9IZXgoKTsKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTguYWJydXB0KCJyZXR1cm4iLCB0eEhleCk7CgogICAgICAgICAgY2FzZSAxNToKICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgIHJldHVybiBfY29udGV4dDE4LnN0b3AoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIF9jYWxsZWUxOCk7CiAgfSkpOwoKICByZXR1cm4gZnVuY3Rpb24gc2lnbk1vZk5CeU1uZW1vbmljKF94MjMsIF94MjQsIF94MjUsIF94MjYsIF94MjcsIF94MjgpIHsKICAgIHJldHVybiBfcmVmMjguYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Owp9KCk7Cgp2YXIgc2lnbk11bHRpU2lnbiA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgdmFyIF9yZWYyOSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUxOSh0eEhhc2gsIHdhbGxldCkgewogICAgdmFyIF9nZXRTdGF0ZTM0LCBfZ2V0U3RhdGUzNCR1c2VyJGJ0Y00sIHByaXZhdGVLZXksIHB1YmxpY0tleXMsIHBzYnQsIHJhd1R4OwoKICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTE5JChfY29udGV4dDE5KSB7CiAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgc3dpdGNoIChfY29udGV4dDE5LnByZXYgPSBfY29udGV4dDE5Lm5leHQpIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgX2dldFN0YXRlMzQgPSBnZXRTdGF0ZSgpLCBfZ2V0U3RhdGUzNCR1c2VyJGJ0Y00gPSBfZ2V0U3RhdGUzNC51c2VyLmJ0Y011bHRpc2lnVXNlckRhdGEsIHByaXZhdGVLZXkgPSBfZ2V0U3RhdGUzNCR1c2VyJGJ0Y00ucHJpdmF0ZUtleSwgcHVibGljS2V5cyA9IF9nZXRTdGF0ZTM0JHVzZXIkYnRjTS5wdWJsaWNLZXlzOwogICAgICAgICAgICBwc2J0ID0gYml0Y29pbi5Qc2J0LmZyb21IZXgodHhIYXNoKTsKICAgICAgICAgICAgcHNidC5zaWduQWxsSW5wdXRzKGJpdGNvaW4uRUNQYWlyLmZyb21XSUYocHJpdmF0ZUtleSwgYnRjLm5ldHdvcmspKTsKICAgICAgICAgICAgcHNidC5maW5hbGl6ZUFsbElucHV0cygpOwogICAgICAgICAgICByYXdUeCA9IHBzYnQuZXh0cmFjdFRyYW5zYWN0aW9uKCkudG9IZXgoKTsKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTkuYWJydXB0KCJyZXR1cm4iLCByYXdUeCk7CgogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MTkuc3RvcCgpOwogICAgICAgIH0KICAgICAgfQogICAgfSwgX2NhbGxlZTE5KTsKICB9KSk7CgogIHJldHVybiBmdW5jdGlvbiBzaWduTXVsdGlTaWduKF94MjksIF94MzApIHsKICAgIHJldHVybiBfcmVmMjkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Owp9KCk7Cgp2YXIgc2lnblNtc01uZW1vbmljID0gZnVuY3Rpb24gc2lnblNtc01uZW1vbmljKHR4SGFzaCwgbW5lbW9uaWMpIHsKICB2YXIgX2dldFN0YXRlMzUgPSBnZXRTdGF0ZSgpLAogICAgICBwdWJsaWNLZXlzID0gX2dldFN0YXRlMzUudXNlci5idGNNdWx0aXNpZ1NNU0RhdGEucHVibGljS2V5czsgLy9ACgoKICByZXR1cm4gc2lnbk1vZk5CeU1uZW1vbmljKHR4SGFzaCwgMiwgcHVibGljS2V5cywgbW5lbW9uaWMsIDEpOwp9OwoKdmFyIHNpZ25QaW5NbmVtb25pYyA9IGZ1bmN0aW9uIHNpZ25QaW5NbmVtb25pYyh0eEhhc2gsIG1uZW1vbmljKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgdmFyIF9yZWYzMCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUyMChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgdmFyIG1uZW1vbmljV2FsbGV0LCBwc2J0LCByYXdUeDsKICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMjAkKF9jb250ZXh0MjApIHsKICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgc3dpdGNoIChfY29udGV4dDIwLnByZXYgPSBfY29udGV4dDIwLm5leHQpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgIG1uZW1vbmljV2FsbGV0ID0gYWN0aW9ucy5idGMuZ2V0V2FsbGV0QnlXb3JkcyhtbmVtb25pYywgMSk7CiAgICAgICAgICAgICAgcHNidCA9IGJpdGNvaW4uUHNidC5mcm9tSGV4KHR4SGFzaCk7CiAgICAgICAgICAgICAgcHNidC5zaWduQWxsSW5wdXRzKGJpdGNvaW4uRUNQYWlyLmZyb21XSUYobW5lbW9uaWNXYWxsZXQuV0lGLCBidGMubmV0d29yaykpOwogICAgICAgICAgICAgIHBzYnQuZmluYWxpemVBbGxJbnB1dHMoKTsKICAgICAgICAgICAgICByYXdUeCA9IHBzYnQuZXh0cmFjdFRyYW5zYWN0aW9uKCkudG9IZXgoKTsKCiAgICAgICAgICAgICAgaWYgKCFyYXdUeCkgewogICAgICAgICAgICAgICAgcmVqZWN0KCdyYXdUeCBlbXB0eScpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXNvbHZlKHJhd1R4KTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0MjAuc3RvcCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgX2NhbGxlZTIwKTsKICAgIH0pKTsKCiAgICByZXR1cm4gZnVuY3Rpb24gKF94MzEsIF94MzIpIHsKICAgICAgcmV0dXJuIF9yZWYzMC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICB9KCkpOwp9OwoKdmFyIHNpZ25TbXNNbmVtb25pY0FuZEJ1aWxkID0gZnVuY3Rpb24gc2lnblNtc01uZW1vbmljQW5kQnVpbGQodHhIYXNoLCBtbmVtb25pYykgewogIHJldHVybiBuZXcgUHJvbWlzZSggLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgIHZhciBfcmVmMzEgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMjEocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHZhciBtbmVtb25pY1dhbGxldCwgcHNidCwgcmF3VHg7CiAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIxJChfY29udGV4dDIxKSB7CiAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyMS5wcmV2ID0gX2NvbnRleHQyMS5uZXh0KSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICBtbmVtb25pY1dhbGxldCA9IGFjdGlvbnMuYnRjLmdldFdhbGxldEJ5V29yZHMobW5lbW9uaWMsIDEpOwogICAgICAgICAgICAgIHBzYnQgPSBiaXRjb2luLlBzYnQuZnJvbUhleCh0eEhhc2gpOwogICAgICAgICAgICAgIHBzYnQuc2lnbkFsbElucHV0cyhiaXRjb2luLkVDUGFpci5mcm9tV0lGKG1uZW1vbmljV2FsbGV0LldJRiwgYnRjLm5ldHdvcmspKTsKICAgICAgICAgICAgICBwc2J0LmZpbmFsaXplQWxsSW5wdXRzKCk7CiAgICAgICAgICAgICAgcmF3VHggPSBwc2J0LmV4dHJhY3RUcmFuc2FjdGlvbigpLnRvSGV4KCk7CgogICAgICAgICAgICAgIGlmICghcmF3VHgpIHsKICAgICAgICAgICAgICAgIHJlamVjdCgncmF3VHggZW1wdHknKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzb2x2ZShyYXdUeCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIxLnN0b3AoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIF9jYWxsZWUyMSk7CiAgICB9KSk7CgogICAgcmV0dXJuIGZ1bmN0aW9uIChfeDMzLCBfeDM0KSB7CiAgICAgIHJldHVybiBfcmVmMzEuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfSgpKTsKfTsKCnZhciBjaGVja1BpbkNhblJlc3RvcnkgPSBmdW5jdGlvbiBjaGVja1BpbkNhblJlc3RvcnkobW5lbW9uaWMpIHsKICB2YXIgbW5lbW9uaWNXYWxsZXQgPSBhY3Rpb25zLmJ0Yy5nZXRXYWxsZXRCeVdvcmRzKG1uZW1vbmljLCAxKTsKICB2YXIgYnRjU21zTW5lbW9uaWNLZXkgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShjb25zdGFudHMucHJpdmF0ZUtleU5hbWVzLmJ0Y1Ntc01uZW1vbmljS2V5KTsKCiAgdHJ5IHsKICAgIGJ0Y1Ntc01uZW1vbmljS2V5ID0gSlNPTi5wYXJzZShidGNTbXNNbmVtb25pY0tleSk7CiAgfSBjYXRjaCAoZSkgewogICAgY29uc29sZS5lcnJvcihlKTsKICB9CgogIGlmIChidGNTbXNNbmVtb25pY0tleSBpbnN0YW5jZW9mIEFycmF5ICYmIGJ0Y1Ntc01uZW1vbmljS2V5Lmxlbmd0aCA+IDApIHsKICAgIHJldHVybiBidGNTbXNNbmVtb25pY0tleS5pbmNsdWRlcyhtbmVtb25pY1dhbGxldC5wdWJsaWNLZXkpOwogIH0KCiAgcmV0dXJuIGZhbHNlOwp9OwoKdmFyIGNoZWNrUGluTW5lbW9uaWMgPSBmdW5jdGlvbiBjaGVja1Bpbk1uZW1vbmljKG1uZW1vbmljKSB7CiAgdmFyIF9nZXRTdGF0ZTM2ID0gZ2V0U3RhdGUoKSwKICAgICAgcHVibGljS2V5cyA9IF9nZXRTdGF0ZTM2LnVzZXIuYnRjTXVsdGlzaWdQaW5EYXRhLnB1YmxpY0tleXM7CgogIHZhciBtbmVtb25pY1dhbGxldCA9IGFjdGlvbnMuYnRjLmdldFdhbGxldEJ5V29yZHMobW5lbW9uaWMsIDEpOwoKICBpZiAobW5lbW9uaWNXYWxsZXQpIHsKICAgIHZhciBtYXRjaGVkS2V5cyA9IHB1YmxpY0tleXMuZmlsdGVyKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgcmV0dXJuIGtleS50b1N0cmluZygnSGV4JykgPT09IG1uZW1vbmljV2FsbGV0LnB1YmxpY0tleTsKICAgIH0pOwogICAgcmV0dXJuIG1hdGNoZWRLZXlzLmxlbmd0aCA+IDA7CiAgfQoKICByZXR1cm4gZmFsc2U7Cn07Cgp2YXIgY2hlY2tTbXNNbmVtb25pYyA9IGZ1bmN0aW9uIGNoZWNrU21zTW5lbW9uaWMobW5lbW9uaWMpIHsKICB2YXIgX2dldFN0YXRlMzcgPSBnZXRTdGF0ZSgpLAogICAgICBwdWJsaWNLZXlzID0gX2dldFN0YXRlMzcudXNlci5idGNNdWx0aXNpZ1NNU0RhdGEucHVibGljS2V5czsKCiAgdmFyIG1uZW1vbmljV2FsbGV0ID0gYWN0aW9ucy5idGMuZ2V0V2FsbGV0QnlXb3JkcyhtbmVtb25pYywgMSk7CgogIGlmIChtbmVtb25pY1dhbGxldCkgewogICAgdmFyIG1hdGNoZWRLZXlzID0gcHVibGljS2V5cy5maWx0ZXIoZnVuY3Rpb24gKGtleSkgewogICAgICByZXR1cm4ga2V5LnRvU3RyaW5nKCdIZXgnKSA9PT0gbW5lbW9uaWNXYWxsZXQucHVibGljS2V5OwogICAgfSk7CiAgICByZXR1cm4gbWF0Y2hlZEtleXMubGVuZ3RoID4gMDsKICB9CgogIHJldHVybiBmYWxzZTsKfTsKCnZhciBmZXRjaFVuc3BlbnRzID0gZnVuY3Rpb24gZmV0Y2hVbnNwZW50cyhhZGRyZXNzKSB7CiAgdmFyIHJlc3VsdCA9IGFjdGlvbnMuYnRjLmZldGNoVW5zcGVudHMoYWRkcmVzcyk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKCnZhciBicm9hZGNhc3RUeCA9IGZ1bmN0aW9uIGJyb2FkY2FzdFR4KHR4UmF3KSB7CiAgdmFyIHJlc3VsdCA9IGFjdGlvbnMuYnRjLmJyb2FkY2FzdFR4KHR4UmF3KTsKICByZXR1cm4gcmVzdWx0Owp9OwoKdmFyIHNpZ25NZXNzYWdlID0gZnVuY3Rpb24gc2lnbk1lc3NhZ2UobWVzc2FnZSwgZW5jb2RlZFByaXZhdGVLZXkpIHsKICB2YXIga2V5UGFpciA9IGJpdGNvaW4uRUNQYWlyLmZyb21XSUYoZW5jb2RlZFByaXZhdGVLZXksIFtiaXRjb2luLm5ldHdvcmtzLmJpdGNvaW4sIGJpdGNvaW4ubmV0d29ya3MudGVzdG5ldF0pOyAvL0AKCiAgdmFyIHByaXZhdGVLZXkgPSBrZXlQYWlyLmQudG9CdWZmZXIoMzIpOwogIHZhciBzaWduYXR1cmUgPSBiaXRjb2luTWVzc2FnZS5zaWduKG1lc3NhZ2UsIHByaXZhdGVLZXksIGtleVBhaXIuY29tcHJlc3NlZCk7CiAgcmV0dXJuIHNpZ25hdHVyZS50b1N0cmluZygnYmFzZTY0Jyk7Cn07Cgp2YXIgZ2V0UmVwdXRhdGlvbiA9IGZ1bmN0aW9uIGdldFJlcHV0YXRpb24oKSB7CiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgwKTsKfTsKCmV4cG9ydCBkZWZhdWx0IHsKICAvLyBTTVMgUHJvdGVjdGVkCiAgYmVnaW5SZWdpc3RlclNNUzogYmVnaW5SZWdpc3RlclNNUywKICBjb25maXJtUmVnaXN0ZXJTTVM6IGNvbmZpcm1SZWdpc3RlclNNUywKICBjaGVja1NNU0FjdGl2YXRlZDogY2hlY2tTTVNBY3RpdmF0ZWQsCiAgZ2V0QmFsYW5jZTogZ2V0QmFsYW5jZSwKICBsb2dpbl9TTVM6IGxvZ2luX1NNUywKICBjaGVja0cyRkFBY3RpdmF0ZWQ6IGNoZWNrRzJGQUFjdGl2YXRlZCwKICBjaGVja1VzZXJBY3RpdmF0ZWQ6IGNoZWNrVXNlckFjdGl2YXRlZCwKICBnZXRUcmFuc2FjdGlvblNNUzogZ2V0VHJhbnNhY3Rpb25TTVMsCiAgc2VuZFNNU1Byb3RlY3RlZDogc2VuZFNNU1Byb3RlY3RlZCwKICBjb25maXJtU01TUHJvdGVjdGVkOiBjb25maXJtU01TUHJvdGVjdGVkLAogIGVuYWJsZVdhbGxldFNNUzogZW5hYmxlV2FsbGV0U01TLAogIHNpZ25TbXNNbmVtb25pYzogc2lnblNtc01uZW1vbmljLAogIHNpZ25TbXNNbmVtb25pY0FuZEJ1aWxkOiBzaWduU21zTW5lbW9uaWNBbmRCdWlsZCwKICBjaGVja1Ntc01uZW1vbmljOiBjaGVja1Ntc01uZW1vbmljLAogIGdldEludm9pY2VzU01TOiBnZXRJbnZvaWNlc1NNUywKICBhZGRTTVNXYWxsZXQ6IGFkZFNNU1dhbGxldCwKICBpc0JUQ1NNU0FkZHJlc3M6IGlzQlRDU01TQWRkcmVzcywKICBnZXRTbXNLZXlGcm9tTW5lbW9uaWM6IGdldFNtc0tleUZyb21NbmVtb25pYywKICAvLyBQaW4gcHJvdGVjdGVkCiAgbG9naW5fUElOOiBsb2dpbl9QSU4sCiAgcmVnaXN0ZXJfUElOOiByZWdpc3Rlcl9QSU4sCiAgY2hlY2tQSU5BY3RpdmF0ZWQ6IGNoZWNrUElOQWN0aXZhdGVkLAogIGFkZFBpbldhbGxldDogYWRkUGluV2FsbGV0LAogIGdldEJhbGFuY2VQaW46IGdldEJhbGFuY2VQaW4sCiAgc2VuZFBpblByb3RlY3RlZDogc2VuZFBpblByb3RlY3RlZCwKICBjaGVja1Bpbk1uZW1vbmljOiBjaGVja1Bpbk1uZW1vbmljLAogIHNpZ25QaW5NbmVtb25pYzogc2lnblBpbk1uZW1vbmljLAogIGNoZWNrUGluQ2FuUmVzdG9yeTogY2hlY2tQaW5DYW5SZXN0b3J5LAogIGdldFRyYW5zYWN0aW9uUElOOiBnZXRUcmFuc2FjdGlvblBJTiwKICAvLyBVc2VyIG11bHRpc2lnCiAgbG9naW5fVVNFUjogbG9naW5fVVNFUiwKICBnZXRCYWxhbmNlVXNlcjogZ2V0QmFsYW5jZVVzZXIsCiAgZ2V0VHJhbnNhY3Rpb246IGdldFRyYW5zYWN0aW9uLAogIGdldFRyYW5zYWN0aW9uVXNlcjogZ2V0VHJhbnNhY3Rpb25Vc2VyLAogIHNlbmQ6IHNlbmQsCiAgZmV0Y2hVbnNwZW50czogZmV0Y2hVbnNwZW50cywKICBicm9hZGNhc3RUeDogYnJvYWRjYXN0VHgsCiAgYnJvYWRjYXN0VFgyUm9vbTogYnJvYWRjYXN0VFgyUm9vbSwKICBmZXRjaFR4OiBmZXRjaFR4LAogIGZldGNoVHhJbmZvOiBmZXRjaFR4SW5mbywKICBmZXRjaEJhbGFuY2U6IGZldGNoQmFsYW5jZSwKICBzaWduTWVzc2FnZTogc2lnbk1lc3NhZ2UsCiAgZ2V0UmVwdXRhdGlvbjogZ2V0UmVwdXRhdGlvbiwKICBlbmFibGVXYWxsZXRVU0VSOiBlbmFibGVXYWxsZXRVU0VSLAogIHBhcnNlUmF3VFg6IHBhcnNlUmF3VFgsCiAgc2lnbk11bHRpU2lnbjogc2lnbk11bHRpU2lnbiwKICBvblVzZXJNdWx0aXNpZ0pvaW46IG9uVXNlck11bHRpc2lnSm9pbiwKICBvblVzZXJNdWx0aXNpZ1NlbmQ6IG9uVXNlck11bHRpc2lnU2VuZCwKICBnZXRJbnZvaWNlc1VzZXI6IGdldEludm9pY2VzVXNlciwKICBnZXRCdGNNdWx0aXNpZ0tleXM6IGdldEJ0Y011bHRpc2lnS2V5cywKICBhZGRCdGNNdWx0aXNpZ0tleTogYWRkQnRjTXVsdGlzaWdLZXksCiAgcmVtb3ZlQnRjTXVsdGlzaWdOZXk6IHJlbW92ZUJ0Y011bHRpc2lnTmV5LAogIHN3aXRjaEJ0Y011bHRpc2lnS2V5OiBzd2l0Y2hCdGNNdWx0aXNpZ0tleSwKICBmZXRjaE11bHRpc2lnQmFsYW5jZXM6IGZldGNoTXVsdGlzaWdCYWxhbmNlcywKICBpc0JUQ01TVXNlckFkZHJlc3M6IGlzQlRDTVNVc2VyQWRkcmVzcywKICBzaWduVG9Vc2VyTXVsdGlzaWc6IHNpZ25Ub1VzZXJNdWx0aXNpZywKICAvLyBjb21tb24KICBpc0JUQ0FkZHJlc3M6IGlzQlRDQWRkcmVzcywKICBnZXRBZGRyQmFsYW5jZTogZ2V0QWRkckJhbGFuY2UsCiAgYWRkcmVzc1RvV2FsbGV0OiBhZGRyZXNzVG9XYWxsZXQsCiAgLy8gR29vZ2xlIDJmYSAoZHJhZnQgbm90IGltcGxlbWVudHMpCiAgbG9naW5fRzJGQTogbG9naW5fRzJGQSwKICBnZXRCYWxhbmNlRzJGQTogZ2V0QmFsYW5jZUcyRkEsCiAgZ2V0VHJhbnNhY3Rpb25HMkZBOiBnZXRUcmFuc2FjdGlvbkcyRkEsCiAgZW5hYmxlV2FsbGV0RzJGQTogZW5hYmxlV2FsbGV0RzJGQQp9Ow=="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/front/shared/redux/actions/btcmultisig.ts"],"names":["BigInteger","BigNumber","bitcoin","bitcoinMessage","getState","reducers","apiLooper","constants","btc","actions","config","SwapApp","default","bitcoinUtils","BITPAY_API","name","servers","api","bitpay","BLOCYPER_API","blockcypher","hasAdminFee","opts","fee","address","min","addressToWallet","msData","user","btcMultisigUserData","wallets","length","founded","filter","wallet","getSmsKeyFromMnemonic","mnemonic","mnemonicWallet","getWalletByWords","publicKey","_loadBtcMultisigKeys","savedKeys","localStorage","getItem","privateKeyNames","btcMultisigOtherOwnerKey","JSON","parse","e","Array","signToUserMultisig","infoAboutCurrency","walletAddreses","getBtcMultisigKeys","dontFetchBalance","walletsData","map","data","currency","fullName","isUserProtected","active","balance","unconfirmedBalance","isBalanceFetched","balanceError","publicKeys","isBTC","setAuthData","fetchMultisigBalances","index","Promise","resolve","getAddrBalance","then","setBtcMultisigBalance","amount","params","reject","privateKey","keysInfo","i","walletData","login_USER","fetchBalance","push","addBtcMultisigKey","isPrimary","includes","setItem","stringify","switchBtcMultisigKey","keyOrIndex","Number","isInteger","indexOf","newKey","splice","unshift","btcData","getBalanceUser","removeBtcMultisigNey","checkSMSActivated","isRegistered","btcMultisigSMSData","checkPINActivated","btcMultisigPinData","checkG2FAActivated","checkUserActivated","isBTCSMSAddress","toLowerCase","isBTCMSUserAddress","isBTCAddress","console","warn","getDataByAddress","createWallet","otherOwnerPublicKey","keyPair","hash","crypto","sha256","d","fromBuffer","ECPair","fromWIF","network","error","account","payments","p2wpkh","pubkey","addressOfMyOwnWallet","publicKeysRaw","toString","sort","reverse","hex","Buffer","from","p2ms","m","n","pubkeys","p2sh","redeem","window","getBtcMultisigData","getBtcMultisigAddress","info","login_SMS","login_","didProtectedBtcCreated","isSmsProtected","getBtcSmsData","login_PIN","didPinBtcCreated","isPinProtected","getBtcPinData","login_G2FA","didProtectedBtcG2FACreated","isG2FAProtected","onlyCheck","pubsubRoom","onReady","onRequestEventName","shared","services","room","subscribe","_data","txData","txRaw","sendMessagePeer","fromPeer","event","notifications","show","modals","open","BtcMultisignConfirmTx","sortKeys","log","publicKey_1","forEach","key","enableWalletSMS","enableWalletG2FA","btcMultisigG2FAData","enableWalletUSER","onUserMultisigJoin","checkKey","onUserMultisigSend","broadcastTX2Room","cbSuccess","cbFail","onSuccessEventName","failTimer","onSuccessEvent","clearTimeout","unsubscribe","cancelFunc","onFailTimer","setTimeout","sendMessageRoom","_getSign","message","sign","compressed","beginRegisterSMS","phone","ownPublicKey","mnemonicAccount","post","body","checkSign","mainnet","process","env","MAINNET","source","location","hostname","result","confirmRegisterSMS","smsCode","mnemonicKey","newKeys","answer","addSMSWallet","register_PIN","password","mainKey","btcPinServerKey","swapContract","btcPinKey","addPinWallet","mnemonicOrKey","validateMnemonicWords","btcPinMnemonicKey","btcPinPublicKeys","btcmultisig","getBalance","btcSmsMnemonicKey","btcSMSServerKey","protectedBtcKey","btcSmsPublicKeys","withUnconfirmed","apiBitpay","unconfirmed","ownAddress","ownDataKey","checkAddress","dataKey","setBalance","setBalanceError","getBalancePin","getBalanceG2FA","fetchTx","cacheResponse","fetchTxInfo","getTransactionUser","msWallets","promiseList","all","txLists","retValue","txs","getTransaction","getTransactionSMS","smsAddress","getTransactionPIN","pinAddress","getTransactionG2FA","getInvoicesSMS","invoices","getInvoices","getInvoicesUser","ownType","getTransactionBlocyper","myWallets","apiBlocyper","sendSMSProtected","to","feeValue","speed","feeFromAmount","adminFee","adminFeeMinValue","adminFeeMin","dividedBy","multipliedBy","isGreaterThan","integerValue","toNumber","estimateFeeValue","inSatoshis","method","moreInfo","feeData","satoshis","unspents","originalUnspents","fundValue","String","totalUnspent","reduce","summ","skipValue","psbt","Psbt","addOutput","value","txid","vout","fetchTxRaw","rawTx","addInput","redeemScript","output","nonWitnessUtxo","signAllInputs","rawTX","toHex","authKeys","slice","timeout","response","deadline","sendPinProtected","totalAmount","plus","isLessThan","rawTxo","signPinMnemonic","mnemonicTx","broadcastTx","broadcastResult","txId","version","confirmSMSProtected","code","send","senderWallet","fetchUnspents","getMSWalletByScript","script","myBtcWallets","toASM","keys","buf","join","walletScript","parseRawTX","txHash","myBtcAddreses","fromHex","parsedTX","input","out","isOur","inputParsed","inputs","inputWallet","globalMap","unsignedTx","tx","outs","fromOutputScript","outWallet","valueSatoshi","Object","signMofNByMnemonic","option_M","walletNumber","ownPath","txb","TransactionBuilder","fromTransaction","Transaction","__INPUTS","WIF","build","txHex","signMultiSign","finalizeAllInputs","extractTransaction","signSmsMnemonic","signSmsMnemonicAndBuild","checkPinCanRestory","checkPinMnemonic","matchedKeys","checkSmsMnemonic","signMessage","encodedPrivateKey","networks","testnet","toBuffer","signature","getReputation"],"mappings":"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","sourcesContent":["// @ts-nocheck\r\nimport BigInteger from 'bigi'\r\n\r\nimport { BigNumber } from 'bignumber.js'\r\nimport * as bitcoin from 'bitcoinjs-lib'\r\nimport bitcoinMessage from 'bitcoinjs-message'\r\nimport { getState } from 'redux/core'\r\nimport reducers from 'redux/core/reducers'\r\nimport { apiLooper, constants, api } from 'helpers'\r\nimport btc from 'helpers/btc'\r\nimport actions from 'redux/actions'\r\nimport config from 'helpers/externalConfig'\r\nimport SwapApp from 'swap.app'\r\n\r\nimport { MnemonicKey } from './types'\r\n\r\nimport { default as bitcoinUtils } from '../../../../common/utils/coin/btc'\r\n\r\nconst BITPAY_API = {\r\n  name: 'bitpay',\r\n  servers: config.api.bitpay,\r\n}\r\n\r\nconst BLOCYPER_API = {\r\n  name: 'blockcypher',\r\n  servers: config.api.blockcypher,\r\n}\r\n\r\nconst hasAdminFee = (\r\n  config\r\n  && config.opts\r\n  && config.opts.fee\r\n  && config.opts.fee.btc\r\n  && config.opts.fee.btc.fee\r\n  && config.opts.fee.btc.address\r\n  && config.opts.fee.btc.min\r\n) ? config.opts.fee.btc : false\r\n\r\nconst addressToWallet = (address) => {\r\n  const {\r\n    user: {\r\n      btcMultisigUserData: msData,\r\n    },\r\n  } = getState()\r\n\r\n  if (msData.address === address) return msData\r\n\r\n  if (msData.wallets\r\n    && msData.wallets.length\r\n  ) {\r\n    const founded = msData.wallets.filter((wallet) => wallet.address === address)\r\n    if (founded.length) return founded[0]\r\n  }\r\n\r\n  return false\r\n}\r\n\r\nconst getSmsKeyFromMnemonic = (mnemonic) => {\r\n  if (mnemonic) {\r\n    const mnemonicWallet = actions.btc.getWalletByWords(mnemonic, 1)\r\n    if (mnemonicWallet) {\r\n      return mnemonicWallet.publicKey\r\n    }\r\n  }\r\n}\r\n\r\nconst _loadBtcMultisigKeys = () => {\r\n  let savedKeys = localStorage.getItem(constants.privateKeyNames.btcMultisigOtherOwnerKey)\r\n  try { savedKeys = JSON.parse(savedKeys) } catch (e) { }\r\n  //@\r\n  if (!(savedKeys instanceof Array)) {\r\n    //@\r\n    savedKeys = [savedKeys]\r\n  }\r\n\r\n  return savedKeys\r\n}\r\n\r\nconst signToUserMultisig = async () => {\r\n  const {\r\n    user: {\r\n      btcMultisigUserData,\r\n      btcMultisigUserData: {\r\n        infoAboutCurrency,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  const walletAddreses = []\r\n\r\n  const walletsData = await getBtcMultisigKeys({\r\n    opts: {\r\n      dontFetchBalance: true,\r\n    },\r\n  })\r\n  //@\r\n  const wallets = walletsData.map((data) => ({\r\n    address: data.address,\r\n    currency: `BTC (Multisig)`,\r\n    fullName: `Bitcoin (Multisig)`,\r\n    infoAboutCurrency,\r\n    isUserProtected: true,\r\n    active: true,\r\n    balance: 0,\r\n    unconfirmedBalance: 0,\r\n    isBalanceFetched: false,\r\n    balanceError: false,\r\n    publicKeys: data.publicKeys,\r\n    publicKey: data.publicKey,\r\n    isBTC: true,\r\n  })).filter((wallet) => wallet.address !== btcMultisigUserData.address)\r\n\r\n  btcMultisigUserData.wallets = wallets\r\n\r\n  reducers.user.setAuthData({ name: 'btcMultisigUserData', data: btcMultisigUserData })\r\n\r\n  fetchMultisigBalances()\r\n}\r\n\r\nconst fetchMultisigBalances = () => {\r\n  const {\r\n    user: {\r\n      btcMultisigUserData: {\r\n        wallets,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  if (wallets && wallets.length) {\r\n    wallets.map(({ address }, index) => new Promise(async (resolve) => {\r\n      getAddrBalance(address).then(({ balance, unconfirmedBalance }) => {\r\n        reducers.user.setBtcMultisigBalance({\r\n          address,\r\n          amount: balance,\r\n          isBalanceFetched: true,\r\n          unconfirmedBalance,\r\n        })\r\n        resolve({ address, balance, unconfirmedBalance })\r\n      }).catch((e) => {\r\n        //\r\n      })\r\n    }))\r\n  }\r\n}\r\n\r\nconst getBtcMultisigKeys = (params) => {\r\n  let opts = {}\r\n  if (params && params.opts) opts = params.opts\r\n\r\n  return new Promise(async (resolve, reject) => {\r\n    const { user: { btcMultisigUserData } } = getState()\r\n    const { privateKey } = btcMultisigUserData\r\n\r\n    const savedKeys = _loadBtcMultisigKeys()\r\n    const keysInfo = []\r\n    if (savedKeys.length > 0) {\r\n      for (let i = 0; i < savedKeys.length; i++) {\r\n        if (savedKeys[i]) {\r\n          const walletData = login_USER(privateKey, savedKeys[i], true)\r\n\r\n          walletData.index = i\r\n          //@\r\n          walletData.balance = (opts.dontFetchBalance) ? 0 : await fetchBalance(walletData.address)\r\n          keysInfo.push(walletData)\r\n        }\r\n      }\r\n    }\r\n\r\n    resolve(keysInfo)\r\n  })\r\n}\r\n\r\nconst addBtcMultisigKey = (publicKey, isPrimary) => {\r\n  const savedKeys = _loadBtcMultisigKeys()\r\n\r\n  if (!savedKeys.includes(publicKey)) {\r\n    //@\r\n    savedKeys.push(publicKey)\r\n  }\r\n\r\n  localStorage.setItem(constants.privateKeyNames.btcMultisigOtherOwnerKey, JSON.stringify(savedKeys))\r\n\r\n  if (isPrimary) switchBtcMultisigKey(publicKey)\r\n}\r\n\r\nconst switchBtcMultisigKey = (keyOrIndex) => {\r\n  const savedKeys = _loadBtcMultisigKeys()\r\n\r\n  let index = keyOrIndex\r\n  if (!Number.isInteger(index)) index = savedKeys.indexOf(keyOrIndex)\r\n\r\n  if ((index > -1) && (index < savedKeys.length)) {\r\n    if (index !== 0) {\r\n      //@\r\n      const newKey = savedKeys.splice(index, 1)\r\n      //@\r\n      savedKeys.unshift(newKey[0])\r\n      localStorage.setItem(constants.privateKeyNames.btcMultisigOtherOwnerKey, JSON.stringify(savedKeys))\r\n\r\n      const {\r\n        user: {\r\n          btcData: {\r\n            privateKey,\r\n          },\r\n        },\r\n      } = getState()\r\n      //@\r\n      login_USER(privateKey, newKey[0])\r\n      //@\r\n      getBalanceUser()\r\n    }\r\n  }\r\n}\r\n\r\nconst removeBtcMultisigNey = (keyOrIndex) => {\r\n  const savedKeys = _loadBtcMultisigKeys()\r\n\r\n  let index = keyOrIndex\r\n  if (!Number.isInteger(index)) index = savedKeys.indexOf(keyOrIndex)\r\n\r\n  if (index > -1) {\r\n    //@\r\n    const newKey = savedKeys.splice(index, 1)\r\n\r\n    localStorage.setItem(constants.privateKeyNames.btcMultisigOtherOwnerKey, JSON.stringify(savedKeys))\r\n\r\n    if (index === 0) {\r\n      switchBtcMultisigKey(0)\r\n      return true\r\n    }\r\n  }\r\n}\r\n\r\nconst checkSMSActivated = () => {\r\n  const { user: { btcMultisigSMSData: { isRegistered } } } = getState()\r\n  return isRegistered\r\n}\r\n\r\nconst checkPINActivated = () => {\r\n  const { user: { btcMultisigPinData: { isRegistered } } } = getState()\r\n  return isRegistered\r\n}\r\n\r\nconst checkG2FAActivated = () => false\r\n\r\nconst checkUserActivated = () => {\r\n  const { user: { btcMultisigUserData: { active } } } = getState()\r\n  return active\r\n}\r\n\r\nconst isBTCSMSAddress = (address) => {\r\n  const {\r\n    user: {\r\n      btcData,\r\n      btcMultisigSMSData,\r\n    },\r\n  } = getState()\r\n\r\n  if (btcMultisigSMSData && btcMultisigSMSData.address && btcMultisigSMSData.address.toLowerCase() === address.toLowerCase()) return btcMultisigSMSData\r\n\r\n  return false\r\n}\r\n\r\nconst isBTCMSUserAddress = (address) => {\r\n  const {\r\n    user: {\r\n      btcMultisigUserData: msData,\r\n    },\r\n  } = getState()\r\n\r\n  if (msData.address === address) return true\r\n\r\n  if (msData.wallets\r\n    && msData.wallets.length\r\n  ) {\r\n    const founded = msData.wallets.filter((wallet) => wallet.address === address)\r\n    if (founded.length) return true\r\n  }\r\n\r\n  return false\r\n}\r\n\r\n// @ToDo - Remove.\r\nconst isBTCAddress = (address) => {\r\n  console.warn(`Deprecated call isBTCAddress`)\r\n  return actions.btc.getDataByAddress(address)\r\n\r\n  /*const {\r\n    user: {\r\n      btcData,\r\n      btcMnemonicData,\r\n      btcMultisigSMSData,\r\n      btcMultisigUserData,\r\n      btcMultisigG2FAData,\r\n    },\r\n  } = getState()\r\n\r\n  if (btcData && btcData.address && btcData.address.toLowerCase() === address.toLowerCase()) return btcData\r\n  if (btcMnemonicData && btcMnemonicData.address && btcMnemonicData.address.toLowerCase() === address.toLowerCase()) return btcMnemonicData // Sweep\r\n  if (btcMultisigSMSData && btcMultisigSMSData.address && btcMultisigSMSData.address.toLowerCase() === address.toLowerCase()) return btcMultisigSMSData\r\n  if (btcMultisigUserData && btcMultisigUserData.address && btcMultisigUserData.address.toLowerCase() === address.toLowerCase()) return btcMultisigUserData\r\n  if (btcMultisigG2FAData && btcMultisigG2FAData.address && btcMultisigG2FAData.address.toLowerCase() === address.toLowerCase()) return btcMultisigG2FAData\r\n\r\n  return false*/\r\n}\r\n\r\nconst createWallet = (privateKey, otherOwnerPublicKey) => {\r\n  // privateKey - key of our privary one-sign btc wallet\r\n  let keyPair\r\n\r\n  if (privateKey) {\r\n    const hash = bitcoin.crypto.sha256(privateKey)\r\n    const d = BigInteger.fromBuffer(hash)\r\n\r\n    keyPair = bitcoin.ECPair.fromWIF(privateKey, btc.network)\r\n  }\r\n  else {\r\n    console.error('Requery privateKey')\r\n    return false\r\n  }\r\n\r\n\r\n  const account = bitcoin.ECPair.fromWIF(privateKey, btc.network) // eslint-disable-line\r\n  //@\r\n  const { addressOfMyOwnWallet } = bitcoin.payments.p2wpkh({ pubkey: account.publicKey, network: btc.network })\r\n  const { publicKey } = account\r\n\r\n  const publicKeysRaw = [otherOwnerPublicKey, account.publicKey.toString('hex')].sort().reverse()\r\n\r\n  const publicKeys = publicKeysRaw.map(hex => Buffer.from(hex, 'hex'))\r\n\r\n  const p2ms = bitcoin.payments.p2ms({\r\n    m: 2,\r\n    n: 2,\r\n    pubkeys: publicKeys,\r\n    network: btc.network,\r\n  })\r\n  const p2sh = bitcoin.payments.p2sh({ redeem: p2ms, network: btc.network })\r\n\r\n  const { address } = p2sh\r\n\r\n\r\n  const data = {\r\n    account,\r\n    keyPair,\r\n    address,\r\n    addressOfMyOwnWallet,\r\n    currency: 'BTC (Multisig)',\r\n    fullName: 'Bitcoin (Multisig)',\r\n    privateKey,\r\n    publicKeys,\r\n    publicKey,\r\n    isBTC: true,\r\n  }\r\n\r\n  localStorage.setItem(constants.privateKeyNames.btcMultisigOtherOwnerKey, otherOwnerPublicKey)\r\n\r\n  window.getBtcMultisigData = () => data\r\n  window.getBtcMultisigAddress = () => data.address\r\n\r\n  console.info('Logged in with BitcoinMultisig', data)\r\n  reducers.user.setAuthData({ name: 'btcMultisigData', data })\r\n}\r\n\r\nconst login_SMS = (privateKey, otherOwnerPublicKey) => {\r\n  const data = login_(privateKey, otherOwnerPublicKey, false)\r\n\r\n  if (!data) return false\r\n\r\n  const isRegistered = (localStorage.getItem(`${constants.localStorage.didProtectedBtcCreated}:${data.address}`) === '1')\r\n\r\n  data.currency = 'BTC (SMS-Protected)'\r\n  data.fullName = 'Bitcoin (SMS-Protected)'\r\n  data.isRegistered = (otherOwnerPublicKey instanceof Array && otherOwnerPublicKey.length > 1) ? true : isRegistered\r\n  data.isSmsProtected = true\r\n\r\n  window.getBtcSmsData = () => data\r\n  reducers.user.setAuthData({ name: 'btcMultisigSMSData', data })\r\n}\r\n\r\nconst login_PIN = (privateKey, otherOwnerPublicKey) => {\r\n  const data = login_(privateKey, otherOwnerPublicKey, false)\r\n\r\n  if (!data) return false\r\n\r\n  const isRegistered = (localStorage.getItem(`${constants.localStorage.didPinBtcCreated}:${data.address}`) === '1')\r\n\r\n\r\n  data.currency = 'BTC (PIN-Protected)'\r\n  data.fullName = 'Bitcoin (PIN-Protected)'\r\n  data.isRegistered = (otherOwnerPublicKey instanceof Array && otherOwnerPublicKey.length > 1) ? true : isRegistered\r\n  data.isPinProtected = true\r\n\r\n  window.getBtcPinData = () => data\r\n  reducers.user.setAuthData({ name: 'btcMultisigPinData', data })\r\n}\r\n\r\nconst login_G2FA = (privateKey, otherOwnerPublicKey) => {\r\n  const data = login_(privateKey, otherOwnerPublicKey, false)\r\n\r\n  if (!data) return false\r\n\r\n  const isRegistered = (localStorage.getItem(`${constants.localStorage.didProtectedBtcG2FACreated}:${data.address}`) === '1')\r\n\r\n  data.currency = 'BTC (Google 2FA)'\r\n  data.fullName = 'Bitcoin (Google 2FA)'\r\n  data.isRegistered = isRegistered\r\n  data.isG2FAProtected = true\r\n\r\n  reducers.user.setAuthData({ name: 'btcMultisigG2FAData', data })\r\n}\r\n\r\nconst login_USER = (privateKey, otherOwnerPublicKey, onlyCheck) => {\r\n  if (otherOwnerPublicKey instanceof Array && otherOwnerPublicKey.length === 0) return\r\n\r\n  const data = login_(privateKey, (otherOwnerPublicKey instanceof Array) ? otherOwnerPublicKey[0] : otherOwnerPublicKey, true)\r\n\r\n  if (!data) return false\r\n\r\n  data.isUserProtected = true\r\n  if (onlyCheck) return data\r\n\r\n  reducers.user.setAuthData({ name: 'btcMultisigUserData', data })\r\n\r\n  // Setup pubsubRoom sign request\r\n  actions.pubsubRoom.onReady(() => {\r\n    const { user: { btcMultisigUserData: { address } } } = getState()\r\n    const onRequestEventName = `btc multisig request sign ${address}`\r\n    SwapApp.shared().services.room.subscribe(onRequestEventName, (_data) => {\r\n      const { txData } = _data\r\n      if (txData && txData.address && txData.amount && txData.currency && txData.txRaw) {\r\n        SwapApp.shared().services.room.sendMessagePeer(\r\n          _data.fromPeer,\r\n          {\r\n            event: `btc multisig accept tx ${address}`,\r\n            data: {},\r\n          }\r\n        )\r\n        actions.notifications.show('BTCMultisignRequest', txData)\r\n        actions.modals.open(constants.modals.BtcMultisignConfirmTx, {\r\n          txData: txData.txRaw,\r\n        })\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\nconst login_ = (privateKey, otherOwnerPublicKey, sortKeys) => {\r\n  let keyPair\r\n\r\n  if (privateKey) {\r\n    const hash = bitcoin.crypto.sha256(privateKey)\r\n    const d = BigInteger.fromBuffer(hash)\r\n\r\n    keyPair = bitcoin.ECPair.fromWIF(privateKey, btc.network)\r\n  }\r\n  else {\r\n    console.log('Requery privateKey')\r\n    return false\r\n  }\r\n\r\n\r\n  const account = bitcoin.ECPair.fromWIF(privateKey, btc.network) // eslint-disable-line\r\n  const { publicKey } = account\r\n  const publicKey_1 = account.publicKey.toString('hex')\r\n\r\n  // TODO - simple sort public keys by ABC - no primary and secondary\r\n  let _data\r\n\r\n  if (otherOwnerPublicKey) {\r\n    let publicKeysRaw = []\r\n    if (otherOwnerPublicKey instanceof Array) {\r\n      otherOwnerPublicKey.forEach((key) => { publicKeysRaw.push(key) })\r\n    } else {\r\n      publicKeysRaw.push(otherOwnerPublicKey)\r\n    }\r\n    publicKeysRaw.push(publicKey_1)\r\n\r\n    if (sortKeys) publicKeysRaw = publicKeysRaw.sort()\r\n\r\n    const publicKeys = publicKeysRaw.map(hex => Buffer.from(hex, 'hex'))\r\n    const p2ms = bitcoin.payments.p2ms({\r\n      m: 2,\r\n      n: publicKeysRaw.length,\r\n      pubkeys: publicKeys,\r\n      network: btc.network,\r\n    })\r\n\r\n    const p2sh = bitcoin.payments.p2sh({ redeem: p2ms, network: btc.network })\r\n    const { address } = p2sh\r\n    //@\r\n    const { addressOfMyOwnWallet } = bitcoin.payments.p2wpkh({ pubkey: account.publicKey, network: btc.network })\r\n\r\n    _data = {\r\n      account,\r\n      keyPair,\r\n      p2sh,\r\n      address,\r\n      addressOfMyOwnWallet,\r\n      currency: 'BTC (Multisig)',\r\n      fullName: 'Bitcoin (Multisig)',\r\n      privateKey,\r\n      publicKeys,\r\n      publicKey,\r\n      isBTC: true,\r\n      active: true,\r\n    }\r\n  } else {\r\n    _data = {\r\n      account,\r\n      keyPair,\r\n      address: 'Not jointed',\r\n      addressOfMyOwnWallet: 'Not jointed',\r\n      currency: 'BTC (Multisig)',\r\n      fullName: 'Bitcoin (Multisig)',\r\n      privateKey,\r\n      publicKeys: [],\r\n      publicKey,\r\n      isBTC: true,\r\n      active: false,\r\n    }\r\n  }\r\n\r\n  return _data\r\n}\r\n\r\nconst enableWalletSMS = () => {\r\n  const { user: { btcMultisigSMSData } } = getState()\r\n  btcMultisigSMSData.isRegistered = true\r\n  reducers.user.setAuthData({ name: 'btcMultisigSMSData', btcMultisigSMSData })\r\n}\r\n\r\nconst enableWalletG2FA = () => {\r\n  const { user: { btcMultisigG2FAData } } = getState()\r\n  btcMultisigG2FAData.isRegistered = true\r\n  reducers.user.setAuthData({ name: 'btcMultisigG2FAData', btcMultisigG2FAData })\r\n}\r\n\r\nconst enableWalletUSER = () => {\r\n}\r\n\r\nconst onUserMultisigJoin = (data) => {\r\n  console.log('on user multisig join', data)\r\n  const {\r\n    user: {\r\n      btcMultisigUserData,\r\n      btcData,\r\n    },\r\n  } = getState()\r\n  const { fromPeer, checkKey, publicKey } = data\r\n\r\n  if (checkKey === btcData.publicKey.toString('hex') && publicKey && (publicKey.length === 66)) {\r\n    console.log('checks ok - connect')\r\n    addBtcMultisigKey(publicKey, true)\r\n    SwapApp.shared().services.room.sendMessagePeer(fromPeer, {\r\n      event: 'btc multisig join ready',\r\n      data: {},\r\n    })\r\n  }\r\n}\r\n\r\n// Получили транзакцию из комнаты -  проверяем, наш это кошелек и если да. Записываем в историю транзакций с поменткой - нужно подтвердить\r\nconst onUserMultisigSend = (data) => {\r\n  console.log('on user multisig send', data)\r\n}\r\n\r\n// Рассылает транзакцию в комнате, если второй владелец в сети. То он сразу увидит, что ему нужно подтвердить транзакцию без передачи ссылки\r\nconst broadcastTX2Room = (txData, cbSuccess, cbFail) => {\r\n  const { user: { btcMultisigUserData: { publicKey, address } } } = getState()\r\n\r\n  const onSuccessEventName = `btc multisig accept tx ${address}`\r\n  let failTimer = false\r\n\r\n  const onSuccessEvent = (data) => {\r\n    console.log('broadcast sucess', data)\r\n    //@\r\n    clearTimeout(failTimer)\r\n    SwapApp.shared().services.room.unsubscribe(onSuccessEventName, onSuccessEvent)\r\n    if (cbSuccess) cbSuccess()\r\n  }\r\n\r\n  const cancelFunc = () => {\r\n    console.log('broadcast multisig canceled')\r\n    //@\r\n    clearTimeout(failTimer)\r\n    SwapApp.shared().services.room.unsubscribe(onSuccessEventName, onSuccessEvent)\r\n  }\r\n\r\n  const onFailTimer = () => {\r\n    console.log('broadcast multisig fail timer')\r\n    //@\r\n    clearTimeout(failTimer)\r\n    SwapApp.shared().services.room.unsubscribe(onSuccessEventName, onSuccessEvent)\r\n    if (cbFail) cbFail()\r\n  }\r\n  //@\r\n  failTimer = setTimeout(onFailTimer, 30000)\r\n\r\n  SwapApp.shared().services.room.subscribe(onSuccessEventName, onSuccessEvent)\r\n\r\n  // Broadcast TX\r\n  SwapApp.shared().services.room.sendMessageRoom({\r\n    event: `btc multisig request sign ${address}`,\r\n    data: {\r\n      txData,\r\n      publicKey: publicKey.toString('hex'),\r\n    },\r\n  })\r\n  return cancelFunc\r\n}\r\n\r\nwindow.broadcastTX2Room = broadcastTX2Room\r\n\r\nconst _getSign = () => {\r\n  const { user: { btcMultisigSMSData: { account, address, keyPair, publicKey } } } = getState()\r\n  const message = `${address}:${publicKey.toString('hex')}`\r\n\r\n  console.log(message)\r\n  const sign = bitcoinMessage.sign(message, account.privateKey, keyPair.compressed)\r\n  return sign.toString('base64')\r\n}\r\n\r\nconst beginRegisterSMS = async (phone, mnemonic, ownPublicKey) => {\r\n  const {\r\n    user: {\r\n      btcMultisigSMSData: {\r\n        account,\r\n        keyPair,\r\n        publicKey,\r\n      },\r\n      btcData: {\r\n        address,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  const publicKeys = []\r\n  if (mnemonic && !ownPublicKey) {\r\n    // 2of3 - extract public key from mnemonic\r\n    const mnemonicAccount = actions.btc.getWalletByWords(mnemonic, 1)\r\n    publicKeys.push(mnemonicAccount.publicKey)\r\n  }\r\n\r\n  // Возможность использовать произвольный публик-кей для разблокирования\r\n  if (ownPublicKey) {\r\n    publicKeys.push(ownPublicKey)\r\n  }\r\n\r\n  publicKeys.push(publicKey.toString('Hex'))\r\n\r\n  const sign = _getSign()\r\n  try {\r\n    const result: any = await apiLooper.post('btc2FAProtected', `/register/begin/`, {\r\n      body: {\r\n        phone,\r\n        address,\r\n        publicKey: JSON.stringify(publicKeys),\r\n        checkSign: sign,\r\n        mainnet: !!process.env.MAINNET,\r\n        source: window.location.hostname,\r\n      },\r\n    })\r\n    console.log(result)\r\n    return result\r\n  } catch (error) {\r\n    console.error(error)\r\n    return false\r\n  }\r\n}\r\n\r\nconst confirmRegisterSMS = async (phone, smsCode, mnemonic, ownPublicKey) => {\r\n  const {\r\n    user: {\r\n      btcMultisigSMSData: {\r\n        account,\r\n        keyPair,\r\n        publicKey,\r\n      },\r\n      btcData: {\r\n        address,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  const publicKeys = []\r\n  let mnemonicKey = false\r\n\r\n  if (mnemonic && !ownPublicKey) {\r\n    // 2of3 - extract public key from mnemonic\r\n    const mnemonicAccount = actions.btc.getWalletByWords(mnemonic, 1)\r\n    //@\r\n    mnemonicKey = mnemonicAccount.publicKey\r\n    publicKeys.push(mnemonicKey)\r\n  }\r\n\r\n  // Возможность использовать произвольный публик-кей для разблокирования\r\n  if (ownPublicKey) {\r\n    publicKeys.push(ownPublicKey)\r\n    mnemonicKey = ownPublicKey\r\n  }\r\n\r\n  publicKeys.push(publicKey.toString('Hex'))\r\n\r\n  const sign = _getSign()\r\n\r\n  const newKeys = JSON.stringify(publicKeys)\r\n\r\n  try {\r\n    const result: any = await apiLooper.post('btc2FAProtected', `/register/confirm/`, {\r\n      body: {\r\n        phone,\r\n        address,\r\n        smsCode,\r\n        publicKey: newKeys,\r\n        checkSign: sign,\r\n        mainnet: !!process.env.MAINNET,\r\n        source: window.location.hostname,\r\n      },\r\n    })\r\n\r\n    if ((result && result.answer && result.answer === 'ok') || (result.error === 'Already registered')) {\r\n      localStorage.setItem(`${constants.localStorage.didProtectedBtcCreated}:${address}`, '1')\r\n      if (mnemonic) {\r\n        addSMSWallet(mnemonicKey)\r\n      }\r\n    }\r\n\r\n    return result\r\n  } catch (error) {\r\n    console.error(error)\r\n    return false\r\n  }\r\n}\r\n\r\nconst register_PIN = async (password, mnemonic, ownPublicKey) => {\r\n  const {\r\n    user: {\r\n      btcMultisigPinData: {\r\n        account,\r\n        keyPair,\r\n        publicKey,\r\n      },\r\n      btcData: {\r\n        address,\r\n        publicKey: mainKey,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  const btcPinServerKey = config.swapContract.btcPinKey\r\n  const publicKeys = [btcPinServerKey]\r\n  let mnemonicKey = false\r\n\r\n  if (mnemonic && !ownPublicKey) {\r\n    // 2of3 - extract public key from mnemonic\r\n    const mnemonicAccount = actions.btc.getWalletByWords(mnemonic, 1)\r\n    //@\r\n    mnemonicKey = mnemonicAccount.publicKey\r\n    publicKeys.push(mnemonicKey)\r\n  }\r\n\r\n  // Возможность использовать произвольный публик-кей для разблокирования\r\n  if (ownPublicKey) {\r\n    publicKeys.push(ownPublicKey)\r\n    mnemonicKey = ownPublicKey\r\n  }\r\n\r\n  publicKeys.push(mainKey.toString('Hex'))\r\n\r\n  const sign = _getSign()\r\n\r\n  const newKeys = JSON.stringify(publicKeys)\r\n\r\n  try {\r\n    const result: any = await apiLooper.post('btcPin', `/register/`, {\r\n      body: {\r\n        address,\r\n        password,\r\n        publicKey: newKeys,\r\n        checkSign: sign,\r\n        mainnet: !!process.env.MAINNET,\r\n        source: window.location.hostname,\r\n      },\r\n    })\r\n\r\n    if ((result && result.answer && result.answer === 'ok') || (result.error === 'Already registered')) {\r\n      localStorage.setItem(`${constants.localStorage.didPinBtcCreated}:${address}`, '1')\r\n      addPinWallet(mnemonicKey)\r\n    }\r\n\r\n    return result\r\n  } catch (error) {\r\n    console.error(error)\r\n    return false\r\n  }\r\n}\r\n\r\nconst addPinWallet = async (mnemonicOrKey) => {\r\n  const {\r\n    user: {\r\n      btcData: {\r\n        privateKey,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  let mnemonicKey = mnemonicOrKey\r\n  if (actions.btc.validateMnemonicWords(mnemonicOrKey)) {\r\n    const mnemonicAccount = actions.btc.getWalletByWords(mnemonicOrKey, 1)\r\n    mnemonicKey = mnemonicAccount.publicKey\r\n  }\r\n\r\n  let btcPinMnemonicKey: MnemonicKey = localStorage.getItem(constants.privateKeyNames.btcPinMnemonicKey)\r\n  \r\n  try { \r\n    btcPinMnemonicKey = JSON.parse(btcPinMnemonicKey) \r\n  } catch (e) {\r\n    console.error(e)\r\n  }\r\n\r\n  if (!(btcPinMnemonicKey instanceof Array)) {\r\n    btcPinMnemonicKey = []\r\n  }\r\n\r\n  const index = btcPinMnemonicKey.indexOf(mnemonicKey)\r\n\r\n  if (index === -1) btcPinMnemonicKey.unshift(mnemonicKey)\r\n  if ((index > -1) && (index < btcPinMnemonicKey.length)) {\r\n    if (index !== 0) {\r\n      btcPinMnemonicKey = btcPinMnemonicKey.splice(index, 1)\r\n      btcPinMnemonicKey.unshift(mnemonicKey)\r\n    }\r\n  }\r\n\r\n  localStorage.setItem(constants.privateKeyNames.btcPinMnemonicKey, JSON.stringify(btcPinMnemonicKey))\r\n\r\n  const btcPinServerKey = config.swapContract.btcPinKey\r\n  let btcPinPublicKeys = [btcPinServerKey, mnemonicKey]\r\n\r\n  await actions.btcmultisig.login_PIN(privateKey, btcPinPublicKeys)\r\n  const { user: { btcMultisigPinData: { address } } } = getState()\r\n\r\n  await getBalance(address, 'btcMultisigPinData')\r\n}\r\n\r\nconst addSMSWallet = async (mnemonicOrKey) => {\r\n  const {\r\n    user: {\r\n      btcData: {\r\n        privateKey,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  let mnemonicKey = mnemonicOrKey\r\n  if (actions.btc.validateMnemonicWords(mnemonicOrKey)) {\r\n    const mnemonicAccount = actions.btc.getWalletByWords(mnemonicOrKey, 1)\r\n    mnemonicKey = mnemonicAccount.publicKey\r\n  }\r\n\r\n  let btcSmsMnemonicKey: MnemonicKey = localStorage.getItem(constants.privateKeyNames.btcSmsMnemonicKey)\r\n  \r\n  try { \r\n    btcSmsMnemonicKey = JSON.parse(btcSmsMnemonicKey) \r\n  } catch (e) {\r\n    console.error(e)\r\n  }\r\n\r\n  if (!(btcSmsMnemonicKey instanceof Array)) {\r\n    btcSmsMnemonicKey = []\r\n  }\r\n\r\n  const index = btcSmsMnemonicKey.indexOf(mnemonicKey)\r\n\r\n  if (index === -1) btcSmsMnemonicKey.unshift(mnemonicKey)\r\n  if ((index > -1) && (index < btcSmsMnemonicKey.length)) {\r\n    if (index !== 0) {\r\n      btcSmsMnemonicKey = btcSmsMnemonicKey.splice(index, 1)\r\n      btcSmsMnemonicKey.unshift(mnemonicKey)\r\n    }\r\n  }\r\n\r\n  localStorage.setItem(constants.privateKeyNames.btcSmsMnemonicKey, JSON.stringify(btcSmsMnemonicKey))\r\n\r\n  const btcSMSServerKey = config.swapContract.protectedBtcKey\r\n  let btcSmsPublicKeys = [btcSMSServerKey, mnemonicKey]\r\n\r\n  await actions.btcmultisig.login_SMS(privateKey, btcSmsPublicKeys)\r\n  await getBalance()\r\n}\r\n\r\nconst getAddrBalance = (address) => {\r\n  return new Promise((resolve) => {\r\n    bitcoinUtils.fetchBalance({\r\n      address,\r\n      withUnconfirmed: true,\r\n      apiBitpay: BITPAY_API\r\n    }).then((answer) => {\r\n      //@\r\n      const { balance, unconfirmed } = answer\r\n      resolve({\r\n        address,\r\n        balance: balance,\r\n        unconfirmedBalance: unconfirmed,\r\n      })\r\n    }).catch((e) => {\r\n      resolve(false)\r\n    })\r\n  })\r\n}\r\n\r\nconst getBalance = (ownAddress = null, ownDataKey = null) => {\r\n  const { user: { btcMultisigSMSData: { address } } } = getState()\r\n  const checkAddress = (ownAddress) || address\r\n  const dataKey = (ownDataKey) || 'btcMultisigSMSData'\r\n\r\n  if (checkAddress === 'Not jointed') {\r\n    return new Promise((resolve) => {\r\n      reducers.user.setBalance({\r\n        name: dataKey,\r\n        amount: 0,\r\n        unconfirmedBalance: 0,\r\n      })\r\n      resolve(0)\r\n    })\r\n  }\r\n\r\n  return getAddrBalance(checkAddress).then(({ balance, unconfirmedBalance }) => {\r\n    reducers.user.setBalance({ name: dataKey, amount: balance, unconfirmedBalance })\r\n    return balance\r\n  })\r\n    .catch((e) => {\r\n      reducers.user.setBalanceError({ name: dataKey })\r\n    })\r\n}\r\n\r\nconst getBalancePin = () => {\r\n  const { user: { btcMultisigPinData: { address } } } = getState()\r\n\r\n  return getBalance(address, 'btcMultisigPinData')\r\n}\r\n\r\nconst getBalanceUser = (checkAddress) => {\r\n  const { user: { btcMultisigUserData: { address } } } = getState()\r\n  if (!checkAddress) {\r\n    return getBalance(address, 'btcMultisigUserData')\r\n  }\r\n  return getAddrBalance(checkAddress).then(({ balance, unconfirmedBalance }) => {\r\n    reducers.user.setBtcMultisigBalance({\r\n      address: checkAddress,\r\n      amount: balance,\r\n      isBalanceFetched: true,\r\n      unconfirmedBalance,\r\n    })\r\n\r\n    return balance\r\n  })\r\n\r\n}\r\n\r\nconst getBalanceG2FA = () => {\r\n}\r\n\r\nconst fetchBalance = (address) => bitcoinUtils.fetchBalance({\r\n  address,\r\n  withUnconfirmed: false,\r\n  apiBitpay: BITPAY_API,\r\n})\r\n\r\nconst fetchTx = (hash, cacheResponse) => bitcoinUtils.fetchTx({\r\n  hash,\r\n  apiBitpay: BITPAY_API,\r\n  cacheResponse,\r\n})\r\n\r\nconst fetchTxInfo = (hash, cacheResponse) => bitcoinUtils.fetchTxInfo({\r\n  hash,\r\n  apiBitpay: BITPAY_API,\r\n  cacheResponse,\r\n  hasAdminFee,\r\n})\r\n\r\nconst getTransactionUser = (address: string = ``) => {\r\n  if (!address) {\r\n    // Fetch all\r\n    return new Promise(async (resolve) => {\r\n      const msWallets = await getBtcMultisigKeys({\r\n        opts: {\r\n          dontFetchBalance: true,\r\n        },\r\n      })\r\n      //@\r\n      if (msWallets.length) {\r\n        //@\r\n        const promiseList = msWallets.map((walletData) => getTransactionUser(walletData.address))\r\n\r\n        const txLists = await Promise.all(promiseList)\r\n\r\n        let retValue = []\r\n        txLists.forEach((txs) => {\r\n          //@\r\n          retValue = [...retValue, ...txs]\r\n        })\r\n\r\n        resolve(retValue)\r\n      } else {\r\n        resolve([])\r\n      }\r\n    })\r\n  }\r\n  return getTransaction(address, 'btc (multisig)')\r\n\r\n}\r\n//@\r\nconst getTransactionSMS = (address: string = ``) => {\r\n  const {\r\n    user: {\r\n      btcMultisigSMSData: {\r\n        address: smsAddress,\r\n        isRegistered,\r\n      },\r\n    },\r\n  } = getState()\r\n  if (!isRegistered) {\r\n    return new Promise((resolve) => { resolve([]) })\r\n  }\r\n  return getTransaction((address || smsAddress), `btc (sms-protected)`)\r\n}\r\n\r\nconst getTransactionPIN = (address: string = ``) => {\r\n  const {\r\n    user: {\r\n      btcMultisigPinData: {\r\n        address: pinAddress,\r\n        isRegistered,\r\n      },\r\n    },\r\n  } = getState()\r\n  if (!isRegistered) {\r\n    return new Promise((resolve) => { resolve([]) })\r\n  }\r\n  return getTransaction((address || pinAddress), `btc (pin-protected)`)\r\n}\r\n\r\nconst getTransactionG2FA = () => { }\r\n\r\nconst getInvoicesSMS = () => {\r\n  const { user: { btcMultisigSMSData: { address } } } = getState()\r\n\r\n  return actions.invoices.getInvoices({\r\n    currency: 'BTC',\r\n    address,\r\n  })\r\n}\r\n\r\nconst getInvoicesUser = () => {\r\n  const { user: { btcMultisigUserData: { address } } } = getState()\r\n\r\n  return actions.invoices.getInvoices({\r\n    currency: 'BTC',\r\n    address,\r\n  })\r\n}\r\n\r\nconst getTransaction = (ownAddress, ownType) => {\r\n  return bitcoinUtils.getTransactionBlocyper({\r\n    ownAddress,\r\n    ownType,\r\n    myWallets: [ownAddress],\r\n    network: btc.network,\r\n    apiBlocyper: BLOCYPER_API,\r\n  })\r\n}\r\n//@\r\nconst sendSMSProtected = async ({ from, to, amount, feeValue, speed } = {}) => {\r\n  const {\r\n    user: {\r\n      btcMultisigSMSData: {\r\n        privateKey,\r\n        address: smsAddress,\r\n        publicKeys,\r\n        publicKey,\r\n      },\r\n      btcData: {\r\n        address,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  let feeFromAmount: number | BigNumber = new BigNumber(0)\r\n\r\n  if (hasAdminFee) {\r\n    const {\r\n      fee: adminFee,\r\n      min: adminFeeMinValue,\r\n    } = hasAdminFee\r\n\r\n    const adminFeeMin = new BigNumber(adminFeeMinValue)\r\n\r\n    feeFromAmount = new BigNumber(adminFee).dividedBy(100).multipliedBy(amount)\r\n    if (adminFeeMin.isGreaterThan(feeFromAmount)) feeFromAmount = adminFeeMin\r\n\r\n    feeFromAmount = feeFromAmount.multipliedBy(1e8).integerValue() // Admin fee in satoshi\r\n  }\r\n  feeFromAmount = feeFromAmount.toNumber()\r\n\r\n  const feeData =  await btc.estimateFeeValue({\r\n    inSatoshis: true,\r\n    speed,\r\n    method: 'send_2fa',\r\n    address: smsAddress,\r\n    amount,\r\n    moreInfo: true,\r\n  })\r\n\r\n  const {\r\n    satoshis,\r\n    unspents,\r\n    unspents: originalUnspents,\r\n  } = feeData\r\n  feeValue = satoshis\r\n\r\n  const fundValue = new BigNumber(String(amount)).multipliedBy(1e8).integerValue().toNumber()\r\n  const totalUnspent = unspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n  const skipValue = totalUnspent - fundValue - feeValue - feeFromAmount\r\n\r\n  const p2ms = bitcoin.payments.p2ms({\r\n    m: 2,\r\n    n: publicKeys.length,\r\n    pubkeys: publicKeys,\r\n    network: btc.network,\r\n  })\r\n\r\n  const psbt = new bitcoin.Psbt({network: btc.network})\r\n\r\n  psbt.addOutput({\r\n    address: to,\r\n    value: fundValue,\r\n  })\r\n\r\n  if (skipValue > 546) {\r\n    psbt.addOutput({\r\n      address: from,\r\n      value: skipValue\r\n    })\r\n  }\r\n\r\n  if (hasAdminFee) {\r\n    // admin fee output\r\n    psbt.addOutput({\r\n      address: hasAdminFee.address,\r\n      value: feeFromAmount,\r\n    })\r\n  }\r\n\r\n  for (let i = 0; i < unspents.length; i++) {\r\n    const { txid, vout } = unspents[i]\r\n    const rawTx = await actions.btc.fetchTxRaw(txid, { cacheResponse: 5000 })\r\n    psbt.addInput({\r\n      hash: txid,\r\n      index: vout,\r\n      redeemScript: p2ms.output,\r\n      nonWitnessUtxo: Buffer.from(rawTx, 'hex'),\r\n    })\r\n  }\r\n\r\n  psbt.signAllInputs(bitcoin.ECPair.fromWIF(privateKey, btc.network))\r\n\r\n  const rawTX = psbt.toHex()\r\n\r\n  let authKeys = publicKeys.slice(1)\r\n  authKeys = JSON.stringify(authKeys.map((key) => key.toString('Hex')))\r\n\r\n  try {\r\n    const result: any = await apiLooper.post('btc2FAProtected', `/push/`, {\r\n      body: {\r\n        address,\r\n        publicKey: authKeys,\r\n        checkSign: _getSign,\r\n        rawTX,\r\n        mainnet: process.env.MAINNET ? true : false,\r\n        source: window.location.hostname,\r\n      },\r\n      timeout: {\r\n        response: 0,\r\n        deadline: 5000,\r\n      },\r\n    })\r\n    return {\r\n      ...result,\r\n      rawTx: rawTX,\r\n    }\r\n  } catch (apiError) {\r\n    return {\r\n      error: apiError.message,\r\n      rawTx: rawTX,\r\n    }\r\n  }\r\n}\r\n\r\n//@\r\nconst sendPinProtected = async ({ from, to, amount, feeValue, speed, password, mnemonic } = {}) => {\r\n  const {\r\n    user: {\r\n      btcMultisigPinData: {\r\n        privateKey,\r\n        publicKeys,\r\n        publicKey,\r\n        address: pinAddress,\r\n      },\r\n      btcData: {\r\n        address,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  let feeFromAmount: any = new BigNumber(0)\r\n  let totalAmount = new BigNumber(String(amount)).multipliedBy(1e8).integerValue().toNumber()\r\n\r\n  if (hasAdminFee) {\r\n    const {\r\n      fee: adminFee,\r\n      min: adminFeeMinValue,\r\n    } = hasAdminFee\r\n\r\n    const adminFeeMin = new BigNumber(adminFeeMinValue)\r\n\r\n    feeFromAmount = new BigNumber(adminFee).dividedBy(100).multipliedBy(amount)\r\n    if (adminFeeMin.isGreaterThan(feeFromAmount)) feeFromAmount = adminFeeMin\r\n\r\n\r\n    feeFromAmount = feeFromAmount.multipliedBy(1e8).integerValue() // Admin fee in satoshi\r\n    totalAmount = new BigNumber(totalAmount).plus(feeFromAmount).integerValue().toNumber()\r\n\r\n  }\r\n  feeFromAmount = feeFromAmount.toNumber()\r\n  const feeData = await btc.estimateFeeValue({\r\n    inSatoshis: true,\r\n    speed,\r\n    method: 'send_2fa',\r\n    address: pinAddress,\r\n    moreInfo: true,\r\n    amount: new BigNumber(totalAmount).dividedBy(1e8).toNumber(),\r\n  })\r\n\r\n  const {\r\n    satoshis,\r\n    unspents,\r\n    unspents: originalUnspents,\r\n  } = feeData\r\n  feeValue = satoshis\r\n\r\n  let fundValue = new BigNumber(String(amount)).multipliedBy(1e8).integerValue().toNumber()\r\n  const totalUnspent = unspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n  let skipValue = totalUnspent - fundValue - feeValue - feeFromAmount\r\n\r\n  if (new BigNumber(skipValue).isLessThan(0)) {\r\n    console.log('>>>>> skip is less than zero', skipValue, fundValue, totalUnspent)\r\n    fundValue = new BigNumber(fundValue).plus(skipValue).integerValue().toNumber()\r\n    skipValue = 0\r\n  }\r\n\r\n  const p2ms = bitcoin.payments.p2ms({\r\n    m: 2,\r\n    n: publicKeys.length,\r\n    pubkeys: publicKeys,\r\n    network: btc.network,\r\n  })\r\n\r\n  const psbt = new bitcoin.Psbt({network: btc.network})\r\n\r\n  psbt.addOutput({\r\n    address: to,\r\n    value: fundValue,\r\n  })\r\n\r\n  if (skipValue > 546) {\r\n    psbt.addOutput({\r\n      address: from,\r\n      value: skipValue\r\n    })\r\n  }\r\n\r\n  if (hasAdminFee) {\r\n    // admin fee output\r\n    psbt.addOutput({\r\n      address: hasAdminFee.address,\r\n      value: feeFromAmount,\r\n    })\r\n  }\r\n\r\n  for (let i = 0; i < unspents.length; i++) {\r\n    const { txid, vout } = unspents[i]\r\n    const rawTxo = await actions.btc.fetchTxRaw(txid, { cacheResponse: 5000 })\r\n    psbt.addInput({\r\n      hash: txid,\r\n      index: vout,\r\n      redeemScript: p2ms.output,\r\n      nonWitnessUtxo: Buffer.from(rawTxo, 'hex'),\r\n    })\r\n  }\r\n\r\n  psbt.signAllInputs(bitcoin.ECPair.fromWIF(privateKey, btc.network))\r\n\r\n  const rawTX = psbt.toHex()\r\n\r\n  if (mnemonic) {\r\n    const mnemonicTx = await signPinMnemonic(rawTX, mnemonic)\r\n    const broadcastResult = await actions.btc.broadcastTx(mnemonicTx)\r\n    if (broadcastResult\r\n      && broadcastResult.txid\r\n    ) {\r\n      return {\r\n        answer: 'ok',\r\n        txId: broadcastResult.txid,\r\n      }\r\n    } else {\r\n      return {\r\n        error: `Fail sign transaction by mnemonic`,\r\n      }\r\n    }\r\n  }\r\n\r\n  let authKeys = publicKeys//.slice(1)\r\n  authKeys = JSON.stringify(authKeys.map((key) => key.toString('Hex')))\r\n\r\n  try {\r\n    const result: any = await apiLooper.post('btcPin', `/sign/`, {\r\n      body: {\r\n        address,\r\n        publicKey: authKeys,\r\n        checkSign: _getSign,\r\n        rawTX: rawTX,\r\n        mainnet: process.env.MAINNET ? true : false,\r\n        source: window.location.hostname,\r\n        password,\r\n        version: `v5`,\r\n      },\r\n      timeout: {\r\n        response: 0,\r\n        deadline: 5000,\r\n      },\r\n    })\r\n\r\n    if (result\r\n      && result.answer\r\n      && result.answer === 'ok'\r\n      && result.rawTX\r\n    ) {\r\n      const broadcastResult = await actions.btc.broadcastTx(result.rawTX)\r\n      if (broadcastResult\r\n        && broadcastResult.txid\r\n      ) {\r\n        return {\r\n          answer: 'ok',\r\n          txId: broadcastResult.txid,\r\n        }\r\n      } else {\r\n        return {\r\n          error: 'Fail broadcast transaction'\r\n        }\r\n      }\r\n    } else {\r\n      return {\r\n        ...result,\r\n      }\r\n    }\r\n  } catch (apiError) {\r\n    return {\r\n      error: apiError.message,\r\n      rawTX,\r\n    }\r\n  }\r\n}\r\n\r\nconst confirmSMSProtected = async (smsCode) => {\r\n  const {\r\n    user: {\r\n      btcMultisigSMSData: {\r\n        privateKey,\r\n        publicKeys,\r\n        publicKey,\r\n      },\r\n      btcData: {\r\n        address,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  let authKeys = publicKeys.slice(1)\r\n  authKeys = JSON.stringify(authKeys.map((key) => key.toString('Hex')))\r\n\r\n  const result: any = await apiLooper.post('btc2FAProtected', `/sign/`, {\r\n    body: {\r\n      address,\r\n      version: 'v5',\r\n      publicKey: authKeys,\r\n      checkSign: _getSign,\r\n      code: smsCode,\r\n      mainnet: !!process.env.MAINNET,\r\n      source: window.location.hostname,\r\n    },\r\n  })\r\n  return result\r\n}\r\n//@\r\nconst send = async ({ from, to, amount, feeValue, speed } = {}) => {\r\n  const {\r\n    user: {\r\n      btcMultisigUserData: {\r\n        privateKey,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  const senderWallet = addressToWallet(from)\r\n  console.log('senderWallet', from)\r\n\r\n  const { address, publicKeys } = senderWallet\r\n\r\n  feeValue = feeValue || await btc.estimateFeeValue({\r\n    inSatoshis: true,\r\n    speed,\r\n    method: 'send_multisig',\r\n    address,\r\n  })\r\n\r\n  let feeFromAmount: number | BigNumber = new BigNumber(0)\r\n\r\n  if (hasAdminFee) {\r\n    const {\r\n      fee: adminFee,\r\n      min: adminFeeMinValue,\r\n    } = hasAdminFee\r\n\r\n    const adminFeeMin = new BigNumber(adminFeeMinValue)\r\n\r\n    feeFromAmount = new BigNumber(adminFee).dividedBy(100).multipliedBy(amount)\r\n    if (adminFeeMin.isGreaterThan(feeFromAmount)) feeFromAmount = adminFeeMin\r\n\r\n\r\n    feeFromAmount = feeFromAmount.multipliedBy(1e8).integerValue()\r\n  }\r\n  feeFromAmount = feeFromAmount.toNumber()\r\n  const unspents = await fetchUnspents(from)\r\n\r\n  const fundValue = new BigNumber(String(amount)).multipliedBy(1e8).integerValue().toNumber()\r\n  const totalUnspent = unspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n  const skipValue = totalUnspent - fundValue - feeValue - feeFromAmount\r\n\r\n  const p2ms = bitcoin.payments.p2ms({\r\n    m: 2,\r\n    n: publicKeys.length,\r\n    pubkeys: publicKeys,\r\n    network: btc.network,\r\n  })\r\n\r\n  const p2sh = bitcoin.payments.p2sh({ redeem: p2ms, network: btc.network })\r\n\r\n  const psbt = new bitcoin.Psbt({network: btc.network})\r\n\r\n  psbt.addOutput({\r\n    address: to,\r\n    value: fundValue,\r\n  })\r\n\r\n  if (skipValue > 546) {\r\n    psbt.addOutput({\r\n      address: from,\r\n      value: skipValue\r\n    })\r\n  }\r\n\r\n  if (hasAdminFee) {\r\n    // admin fee output\r\n    psbt.addOutput({\r\n      address: hasAdminFee.address,\r\n      value: feeFromAmount,\r\n    })\r\n  }\r\n\r\n  for (let i = 0; i < unspents.length; i++) {\r\n    const { txid, vout } = unspents[i]\r\n    //@\r\n    const rawTx = await actions.btc.fetchTxRaw(txid)\r\n    psbt.addInput({\r\n      hash: txid,\r\n      index: vout,\r\n      redeemScript: p2ms.output,\r\n      nonWitnessUtxo: Buffer.from(rawTx, 'hex'),\r\n    })\r\n  }\r\n\r\n  psbt.signAllInputs(bitcoin.ECPair.fromWIF(privateKey, btc.network))\r\n\r\n  const rawTx = psbt.toHex();\r\n\r\n  return rawTx\r\n}\r\n\r\nconst getMSWalletByScript = async (script, myBtcWallets) => {\r\n  //@\r\n  if (!myBtcWallets) myBtcWallets = await getBtcMultisigKeys()\r\n  if (typeof script !== 'string') script = bitcoin.script.toASM( script )\r\n\r\n  const wallets = myBtcWallets.filter((wallet) => {\r\n    const keys = wallet.publicKeys.map(buf => buf.toString('hex')).join(` `)\r\n    const walletScript = `OP_2 ${keys} OP_2 OP_CHECKMULTISIG`\r\n\r\n    if (walletScript === script) {\r\n      return true\r\n    }\r\n  }).map((wallet) => {\r\n    const {\r\n      publicKeys,\r\n      publicKey,\r\n      address,\r\n      balance,\r\n    } = wallet\r\n\r\n    return {\r\n      publicKeys,\r\n      publicKey,\r\n      address,\r\n      balance,\r\n    }\r\n  })\r\n\r\n  return (wallets.length) ? wallets[0] : false\r\n}\r\n\r\nconst parseRawTX = async (txHash) => {\r\n  //@\r\n  const myBtcWallets = await getBtcMultisigKeys()\r\n  //@\r\n  const myBtcAddreses = myBtcWallets.map((wallet) => wallet.address)\r\n\r\n  const psbt = bitcoin.Psbt.fromHex(txHash)\r\n\r\n  const parsedTX = {\r\n    psbt,\r\n    input: [],\r\n    output: [],\r\n    from: false,\r\n    to: false,\r\n    out: {},\r\n    isOur: false,\r\n    amount: new BigNumber(0),\r\n  }\r\n\r\n  await new Promise((inputParsed) => {\r\n    psbt.data.inputs.forEach( async (input) => {\r\n      const { redeemScript } = input\r\n\r\n      const inputWallet = await getMSWalletByScript( redeemScript, myBtcWallets )\r\n      if (inputWallet) {\r\n        if (inputWallet.address) parsedTX.from = inputWallet.address\r\n        //@\r\n        parsedTX.wallet = inputWallet\r\n        parsedTX.isOur = true\r\n      }\r\n    })\r\n    inputParsed(true)\r\n  }).then(() => {\r\n    //@\r\n    psbt.data.globalMap.unsignedTx.tx.outs.forEach(async (out) => {\r\n      const address = bitcoin.address.fromOutputScript(out.script, btc.network)\r\n      if (!parsedTX.isOur) {\r\n        //@\r\n        const outWallet = myBtcWallets.filter((wallet) => wallet.address === address)\r\n\r\n        if (outWallet.length) {\r\n          if (outWallet[0].address) parsedTX.from = outWallet[0].address\r\n          //@\r\n          parsedTX.wallet = outWallet[0]\r\n          parsedTX.isOur = true\r\n        }\r\n      }\r\n      //@\r\n      if (parsedTX.from !== address) {\r\n        if (!parsedTX.out[address]) {\r\n          parsedTX.out[address] = {\r\n            to: address,\r\n            amount: new BigNumber(out.value).dividedBy(1e8).toNumber(),\r\n          }\r\n        } else {\r\n          parsedTX.out[address].amount = parsedTX.out[address].amount.plus(new BigNumber(out.value).dividedBy(1e8).toNumber())\r\n        }\r\n        parsedTX.amount = parsedTX.amount.plus(new BigNumber(out.value).dividedBy(1e8).toNumber())\r\n      }\r\n\r\n      parsedTX.output.push({\r\n        address,\r\n        valueSatoshi: out.value,\r\n        value: new BigNumber(out.value).dividedBy(1e8).toNumber(),\r\n      })\r\n    })\r\n\r\n    if (Object.keys(parsedTX.out).length) {\r\n      parsedTX.to = parsedTX.out[Object.keys(parsedTX.out)[0]].to\r\n    }\r\n  })\r\n\r\n  console.log('parsedTX', parsedTX)\r\n  return parsedTX\r\n}\r\n\r\nconst signMofNByMnemonic = async (txHash, option_M, publicKeys, mnemonic, walletNumber, ownPath) => {\r\n  const mnemonicWallet = actions.btc.getWalletByWords(mnemonic, walletNumber, ownPath)\r\n  if (mnemonicWallet) {\r\n    console.log(mnemonicWallet)\r\n    console.log(txHash)\r\n    let txb = bitcoin.TransactionBuilder.fromTransaction(\r\n      bitcoin.Transaction.fromHex(txHash),\r\n      btc.network\r\n    )\r\n\r\n    console.log('p2ms', option_M, publicKeys.length, publicKeys)\r\n    const p2ms = bitcoin.payments.p2ms({\r\n      m: option_M,\r\n      n: publicKeys.length,\r\n      pubkeys: publicKeys,\r\n      network: btc.network,\r\n    })\r\n\r\n    const p2sh = bitcoin.payments.p2sh({ redeem: p2ms, network: btc.network })\r\n\r\n    console.log(txb)\r\n    //@\r\n    txb.__INPUTS.forEach((input, index) => {\r\n      txb.sign(index, bitcoin.ECPair.fromWIF(mnemonicWallet.WIF, btc.network), p2sh.redeem.output)\r\n    })\r\n\r\n    let tx = await txb.build()\r\n    const txHex = tx.toHex()\r\n    return txHex\r\n  }\r\n}\r\n\r\nconst signMultiSign = async (txHash, wallet) => {\r\n  let {\r\n    user: {\r\n      btcMultisigUserData: {\r\n        privateKey,\r\n        publicKeys,\r\n      },\r\n    },\r\n  } = getState()\r\n\r\n  const psbt = bitcoin.Psbt.fromHex(txHash)\r\n\r\n  psbt.signAllInputs(bitcoin.ECPair.fromWIF(privateKey, btc.network))\r\n\r\n  psbt.finalizeAllInputs();\r\n\r\n  const rawTx = psbt.extractTransaction().toHex()\r\n\r\n  return rawTx\r\n}\r\n\r\nconst signSmsMnemonic = (txHash, mnemonic) => {\r\n  const {\r\n    user: {\r\n      btcMultisigSMSData: {\r\n        publicKeys,\r\n      },\r\n    },\r\n  } = getState()\r\n  //@\r\n  return signMofNByMnemonic(txHash, 2, publicKeys, mnemonic, 1)\r\n}\r\n\r\nconst signPinMnemonic = (txHash, mnemonic) => {\r\n  return new Promise(async (resolve, reject) => {\r\n    const mnemonicWallet = actions.btc.getWalletByWords(mnemonic, 1)\r\n    const psbt = bitcoin.Psbt.fromHex(txHash)\r\n\r\n    psbt.signAllInputs(bitcoin.ECPair.fromWIF(mnemonicWallet.WIF, btc.network))\r\n\r\n    psbt.finalizeAllInputs();\r\n\r\n    const rawTx = psbt.extractTransaction().toHex()\r\n\r\n    if (!rawTx) {\r\n      reject('rawTx empty')\r\n    } else {\r\n      resolve(rawTx)\r\n    }\r\n  })\r\n}\r\n\r\nconst signSmsMnemonicAndBuild = (txHash, mnemonic) => {\r\n  return new Promise(async (resolve, reject) => {\r\n    const mnemonicWallet = actions.btc.getWalletByWords(mnemonic, 1)\r\n    const psbt = bitcoin.Psbt.fromHex(txHash)\r\n\r\n    psbt.signAllInputs(bitcoin.ECPair.fromWIF(mnemonicWallet.WIF, btc.network))\r\n\r\n    psbt.finalizeAllInputs();\r\n\r\n    const rawTx = psbt.extractTransaction().toHex()\r\n\r\n    if (!rawTx) {\r\n      reject('rawTx empty')\r\n    } else {\r\n      resolve(rawTx)\r\n    }\r\n  })\r\n}\r\n\r\nconst checkPinCanRestory = (mnemonic) => {\r\n  const mnemonicWallet = actions.btc.getWalletByWords(mnemonic, 1)\r\n  let btcSmsMnemonicKey: MnemonicKey = localStorage.getItem(constants.privateKeyNames.btcSmsMnemonicKey)\r\n  \r\n  try {\r\n    btcSmsMnemonicKey = JSON.parse(btcSmsMnemonicKey)\r\n  } catch (e) {\r\n    console.error(e)\r\n  }\r\n\r\n  if (btcSmsMnemonicKey instanceof Array && btcSmsMnemonicKey.length > 0) {\r\n    return btcSmsMnemonicKey.includes(mnemonicWallet.publicKey)\r\n  }\r\n  return false\r\n}\r\n\r\nconst checkPinMnemonic = (mnemonic) => {\r\n  const {\r\n    user: {\r\n      btcMultisigPinData: {\r\n        publicKeys,\r\n      },\r\n    },\r\n  } = getState()\r\n  const mnemonicWallet = actions.btc.getWalletByWords(mnemonic, 1)\r\n\r\n  if (mnemonicWallet) {\r\n    const matchedKeys = publicKeys.filter((key) => key.toString('Hex') === mnemonicWallet.publicKey)\r\n    return (matchedKeys.length > 0)\r\n  }\r\n  return false\r\n}\r\n\r\nconst checkSmsMnemonic = (mnemonic) => {\r\n  const {\r\n    user: {\r\n      btcMultisigSMSData: {\r\n        publicKeys,\r\n      },\r\n    },\r\n  } = getState()\r\n  const mnemonicWallet = actions.btc.getWalletByWords(mnemonic, 1)\r\n\r\n  if (mnemonicWallet) {\r\n    const matchedKeys = publicKeys.filter((key) => key.toString('Hex') === mnemonicWallet.publicKey)\r\n    return (matchedKeys.length > 0)\r\n  }\r\n  return false\r\n}\r\n\r\nconst fetchUnspents = (address) => {\r\n  const result: any = actions.btc.fetchUnspents(address)\r\n  return result\r\n}\r\n\r\nconst broadcastTx = (txRaw) => {\r\n  const result: any = actions.btc.broadcastTx(txRaw)\r\n  return result\r\n}\r\n\r\nconst signMessage = (message, encodedPrivateKey) => {\r\n  const keyPair = bitcoin.ECPair.fromWIF(encodedPrivateKey, [bitcoin.networks.bitcoin, bitcoin.networks.testnet])\r\n  //@\r\n  const privateKey = keyPair.d.toBuffer(32)\r\n\r\n  const signature = bitcoinMessage.sign(message, privateKey, keyPair.compressed)\r\n\r\n  return signature.toString('base64')\r\n}\r\n\r\nconst getReputation = () => Promise.resolve(0)\r\n\r\n\r\nexport default {\r\n  // SMS Protected\r\n  beginRegisterSMS,\r\n  confirmRegisterSMS,\r\n  checkSMSActivated,\r\n  getBalance,\r\n  login_SMS,\r\n  checkG2FAActivated,\r\n  checkUserActivated,\r\n  getTransactionSMS,\r\n  sendSMSProtected,\r\n  confirmSMSProtected,\r\n  enableWalletSMS,\r\n  signSmsMnemonic,\r\n  signSmsMnemonicAndBuild,\r\n  checkSmsMnemonic,\r\n  getInvoicesSMS,\r\n  addSMSWallet,\r\n  isBTCSMSAddress,\r\n  getSmsKeyFromMnemonic,\r\n\r\n  // Pin protected\r\n  login_PIN,\r\n  register_PIN,\r\n  checkPINActivated,\r\n  addPinWallet,\r\n  getBalancePin,\r\n  sendPinProtected,\r\n  checkPinMnemonic,\r\n  signPinMnemonic,\r\n  checkPinCanRestory,\r\n  getTransactionPIN,\r\n\r\n  // User multisig\r\n  login_USER,\r\n  getBalanceUser,\r\n  getTransaction,\r\n  getTransactionUser,\r\n\r\n  send,\r\n\r\n  fetchUnspents,\r\n  broadcastTx,\r\n  broadcastTX2Room,\r\n  fetchTx,\r\n  fetchTxInfo,\r\n  fetchBalance,\r\n  signMessage,\r\n  getReputation,\r\n  enableWalletUSER,\r\n\r\n  parseRawTX,\r\n  signMultiSign,\r\n\r\n  onUserMultisigJoin,\r\n  onUserMultisigSend,\r\n  getInvoicesUser,\r\n\r\n  getBtcMultisigKeys,\r\n  addBtcMultisigKey,\r\n  removeBtcMultisigNey,\r\n  switchBtcMultisigKey,\r\n\r\n  fetchMultisigBalances,\r\n\r\n  isBTCMSUserAddress,\r\n  signToUserMultisig,\r\n\r\n  // common\r\n  isBTCAddress,\r\n  getAddrBalance,\r\n  addressToWallet,\r\n\r\n  // Google 2fa (draft not implements)\r\n  login_G2FA,\r\n  getBalanceG2FA,\r\n  getTransactionG2FA,\r\n  enableWalletG2FA,\r\n}\r\n"]}]}