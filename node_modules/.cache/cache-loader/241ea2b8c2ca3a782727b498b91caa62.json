{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.room\\SwapRoom.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.room\\SwapRoom.ts","mtime":1614850288362},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXN5bmNUb0dlbmVyYXRvciI7CmltcG9ydCBfdHlwZW9mIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvdHlwZW9mIjsKaW1wb3J0IF9jbGFzc0NhbGxDaGVjayBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2NsYXNzQ2FsbENoZWNrIjsKaW1wb3J0IF9jcmVhdGVDbGFzcyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2NyZWF0ZUNsYXNzIjsKaW1wb3J0IF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQiOwppbXBvcnQgX2luaGVyaXRzIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvaW5oZXJpdHMiOwppbXBvcnQgX3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4gZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuIjsKaW1wb3J0IF9nZXRQcm90b3R5cGVPZiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldFByb3RvdHlwZU9mIjsKaW1wb3J0IF9kZWZpbmVQcm9wZXJ0eSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2RlZmluZVByb3BlcnR5IjsKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gb3duS2V5cyhvYmplY3QsIGVudW1lcmFibGVPbmx5KSB7IHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqZWN0KTsgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsgdmFyIHN5bWJvbHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKG9iamVjdCk7IGlmIChlbnVtZXJhYmxlT25seSkgc3ltYm9scyA9IHN5bWJvbHMuZmlsdGVyKGZ1bmN0aW9uIChzeW0pIHsgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBzeW0pLmVudW1lcmFibGU7IH0pOyBrZXlzLnB1c2guYXBwbHkoa2V5cywgc3ltYm9scyk7IH0gcmV0dXJuIGtleXM7IH0KCmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQodGFyZ2V0KSB7IGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7IHZhciBzb3VyY2UgPSBhcmd1bWVudHNbaV0gIT0gbnVsbCA/IGFyZ3VtZW50c1tpXSA6IHt9OyBpZiAoaSAlIDIpIHsgb3duS2V5cyhPYmplY3Qoc291cmNlKSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7IF9kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgc291cmNlW2tleV0pOyB9KTsgfSBlbHNlIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycykgeyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHNvdXJjZSkpOyB9IGVsc2UgeyBvd25LZXlzKE9iamVjdChzb3VyY2UpKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHNvdXJjZSwga2V5KSk7IH0pOyB9IH0gcmV0dXJuIHRhcmdldDsgfQoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgovLyBAdHMtbm9jaGVjawppbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnOwppbXBvcnQgeyBFdmVudHMsIFNlcnZpY2VJbnRlcmZhY2UgfSBmcm9tICdzd2FwLmFwcCc7CmltcG9ydCBjcmVhdGVQMlBOb2RlIGZyb20gJy4uLy4uL2NvbW1vbi9tZXNzYWdpbmcvcHVic3ViUm9vbS9jcmVhdGVQMlBOb2RlJzsKaW1wb3J0IHAycFJvb20gZnJvbSAnLi4vLi4vY29tbW9uL21lc3NhZ2luZy9wdWJzdWJSb29tJzsKCnZhciBTd2FwUm9vbSA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoX1NlcnZpY2VJbnRlcmZhY2UpIHsKICBfaW5oZXJpdHMoU3dhcFJvb20sIF9TZXJ2aWNlSW50ZXJmYWNlKTsKCiAgdmFyIF9zdXBlciA9IF9jcmVhdGVTdXBlcihTd2FwUm9vbSk7CgogIGZ1bmN0aW9uIFN3YXBSb29tKGNvbmZpZykgewogICAgdmFyIF90aGlzOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBTd2FwUm9vbSk7CgogICAgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJfc2VydmljZU5hbWUiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIl9jb25maWciLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIl9ldmVudHMiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgInBlZXIiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImNvbm5lY3Rpb24iLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgInJvb21OYW1lIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJhcHAiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIkNoZWNrUmVjZWlwdHNUIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJfaGFuZGxlVXNlck9ubGluZSIsIGZ1bmN0aW9uIChwZWVyKSB7CiAgICAgIGlmIChwZWVyICE9PSBfdGhpcy5wZWVyKSB7CiAgICAgICAgX3RoaXMuX2V2ZW50cy5kaXNwYXRjaCgndXNlciBvbmxpbmUnLCBwZWVyKTsKICAgICAgfQogICAgfSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiX2hhbmRsZVVzZXJPZmZsaW5lIiwgZnVuY3Rpb24gKHBlZXIpIHsKICAgICAgaWYgKHBlZXIgIT09IF90aGlzLnBlZXIpIHsKICAgICAgICBfdGhpcy5fZXZlbnRzLmRpc3BhdGNoKCd1c2VyIG9mZmxpbmUnLCBwZWVyKTsKICAgICAgfQogICAgfSk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiX2hhbmRsZU5ld01lc3NhZ2UiLCBmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICB2YXIgZnJvbSA9IG1lc3NhZ2UuZnJvbSwKICAgICAgICAgIHJhd0RhdGEgPSBtZXNzYWdlLmRhdGE7CiAgICAgIGRlYnVnKCdzd2FwLnZlcmJvc2U6cm9vbScpKCdtZXNzYWdlIGZyb20nLCBmcm9tKTsKCiAgICAgIGlmIChmcm9tID09PSBfdGhpcy5wZWVyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgcGFyc2VkRGF0YTsKCiAgICAgIHRyeSB7CiAgICAgICAgcGFyc2VkRGF0YSA9IEpTT04ucGFyc2UocmF3RGF0YS50b1N0cmluZygpKTsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigncGFyc2UgbWVzc2FnZSBkYXRhIGVycjonLCBlcnIpOwogICAgICB9CgogICAgICB2YXIgX3BhcnNlZERhdGEgPSBwYXJzZWREYXRhLAogICAgICAgICAgZnJvbUFkZHJlc3MgPSBfcGFyc2VkRGF0YS5mcm9tQWRkcmVzcywKICAgICAgICAgIGRhdGEgPSBfcGFyc2VkRGF0YS5kYXRhLAogICAgICAgICAgc2lnbiA9IF9wYXJzZWREYXRhLnNpZ24sCiAgICAgICAgICBldmVudCA9IF9wYXJzZWREYXRhLmV2ZW50LAogICAgICAgICAgYWN0aW9uID0gX3BhcnNlZERhdGEuYWN0aW9uOwoKICAgICAgaWYgKCFkYXRhKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBkZWJ1Zygnc3dhcC52ZXJib3NlOnJvb20nKSgnZGF0YTonLCBwYXJzZWREYXRhKTsKCiAgICAgIHZhciByZWNvdmVyID0gX3RoaXMuX3JlY292ZXJNZXNzYWdlKGRhdGEsIHNpZ24pOwoKICAgICAgaWYgKHJlY292ZXIgIT09IGZyb21BZGRyZXNzKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiV3JvbmcgbWVzc2FnZSBzaWduISBNZXNzYWdlIGZyb206ICIuY29uY2F0KGZyb21BZGRyZXNzLCAiLCByZWNvdmVyOiAiKS5jb25jYXQocmVjb3ZlcikpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGFjdGlvbiA9PT0gJ2FjdGl2ZScpIHsKICAgICAgICBfdGhpcy5hY2tub3dsZWRnZVJlY2VpcHQocGFyc2VkRGF0YSk7CiAgICAgIH0KCiAgICAgIF90aGlzLl9ldmVudHMuZGlzcGF0Y2goZXZlbnQsIF9vYmplY3RTcHJlYWQoewogICAgICAgIGZyb21QZWVyOiBmcm9tLmlkCiAgICAgIH0sIGRhdGEpKTsKICAgIH0pOwoKICAgIGlmICghY29uZmlnIHx8IF90eXBlb2YoY29uZmlnKSAhPT0gJ29iamVjdCcgfHwgX3R5cGVvZihjb25maWcuY29uZmlnKSAhPT0gJ29iamVjdCcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdTd2FwUm9vbVNlcnZpY2U6ICJjb25maWciIG9mIHR5cGUgb2JqZWN0IHJlcXVpcmVkJyk7CiAgICB9CgogICAgX3RoaXMuX3NlcnZpY2VOYW1lID0gJ3Jvb20nOwogICAgX3RoaXMuX2NvbmZpZyA9IGNvbmZpZzsKICAgIF90aGlzLl9ldmVudHMgPSBuZXcgRXZlbnRzKCk7CiAgICBfdGhpcy5wZWVyID0gbnVsbDsKICAgIF90aGlzLmNvbm5lY3Rpb24gPSBudWxsOwogICAgX3RoaXMucm9vbU5hbWUgPSBudWxsOwogICAgcmV0dXJuIF90aGlzOwogIH0KCiAgX2NyZWF0ZUNsYXNzKFN3YXBSb29tLCBbewogICAga2V5OiAiaW5pdFNlcnZpY2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGluaXRTZXJ2aWNlKCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHZhciBwZWVySWRKc29uID0gdGhpcy5hcHAuZW52LnN0b3JhZ2UuZ2V0SXRlbSgnbGlicDJwOnBlZXJJZEpzb24nKTsKICAgICAgY3JlYXRlUDJQTm9kZSh7CiAgICAgICAgcGVlcklkSnNvbjogcGVlcklkSnNvbgogICAgICB9KS50aGVuKGZ1bmN0aW9uIChwMnBOb2RlKSB7CiAgICAgICAgLy8gU2F2ZSBQZWVySWQKICAgICAgICBfdGhpczIuYXBwLmVudi5zdG9yYWdlLnNldEl0ZW0oJ2xpYnAycDpwZWVySWRKc29uJywgcDJwTm9kZS5wZWVySWQudG9KU09OKCkpOyAvLyBTdGFydCBwMnAgbm9kZQoKCiAgICAgICAgcDJwTm9kZS5zdGFydCgpLnRoZW4oIC8qI19fUFVSRV9fKi9fYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlJChfY29udGV4dCkgewogICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX3RoaXMyLl9pbml0KHsKICAgICAgICAgICAgICAgICAgICBwZWVyOiB7CiAgICAgICAgICAgICAgICAgICAgICBpZDogcDJwTm9kZS5wZWVySWQuX2lkQjU4U3RyaW5nCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBwMnBDb25uZWN0aW9uOiBwMnBOb2RlCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlKTsKICAgICAgICB9KSkpWyJjYXRjaCJdKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgY29uc29sZS5sb2coJ0ZhaWwgc3RhcnQgcDJwbm9kZScsIGVycm9yKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiX2luaXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9pbml0KF9yZWYyKSB7CiAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgdmFyIHBlZXIgPSBfcmVmMi5wZWVyLAogICAgICAgICAgcDJwQ29ubmVjdGlvbiA9IF9yZWYyLnAycENvbm5lY3Rpb247CiAgICAgIGNvbnNvbGUuaW5mbygnUm9vbTogaW5pdC4uLicpOwoKICAgICAgaWYgKCFwMnBDb25uZWN0aW9uKSB7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpczMuX2luaXQoewogICAgICAgICAgICBwZWVyOiBwZWVyLAogICAgICAgICAgICBwMnBDb25uZWN0aW9uOiBwMnBDb25uZWN0aW9uCiAgICAgICAgICB9KTsKICAgICAgICB9LCA5OTkpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5wZWVyID0gcGVlci5pZDsKICAgICAgdmFyIGRlZmF1bHRSb29tTmFtZSA9IHRoaXMuYXBwLmlzTWFpbk5ldCgpID8gJ3N3YXAub25saW5lJyA6ICd0ZXN0bmV0LnN3YXAub25saW5lJzsKICAgICAgdGhpcy5yb29tTmFtZSA9IHRoaXMuX2NvbmZpZy5yb29tTmFtZSB8fCBkZWZhdWx0Um9vbU5hbWU7CiAgICAgIGRlYnVnKCdzd2FwLmNvcmU6cm9vbScpKCJVc2luZyByb29tOiAiLmNvbmNhdCh0aGlzLnJvb21OYW1lKSk7CiAgICAgIHRoaXMuY29ubmVjdGlvbiA9IG5ldyBwMnBSb29tKHAycENvbm5lY3Rpb24sIHRoaXMucm9vbU5hbWUsIHsKICAgICAgICBwb2xsSW50ZXJ2YWw6IDEwMDAKICAgICAgfSk7CgogICAgICB0aGlzLmNvbm5lY3Rpb24uaXNPbmxpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgY29uc29sZS5sb2coJ0NhbGwgcHVic3ViUm9vbSBpc09ubGluZScpOyAvLyBAVG9EbyAtIG1heSBiZSB1c2UgaXNTdGFydGVkCgogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9OwoKICAgICAgdGhpcy5jb25uZWN0aW9uLm9uKCdwZWVyIGpvaW5lZCcsIHRoaXMuX2hhbmRsZVVzZXJPbmxpbmUpOwogICAgICB0aGlzLmNvbm5lY3Rpb24ub24oJ3BlZXIgbGVmdCcsIHRoaXMuX2hhbmRsZVVzZXJPZmZsaW5lKTsKICAgICAgdGhpcy5jb25uZWN0aW9uLm9uKCdtZXNzYWdlJywgdGhpcy5faGFuZGxlTmV3TWVzc2FnZSk7CgogICAgICB0aGlzLl9ldmVudHMuZGlzcGF0Y2goJ3JlYWR5Jyk7CgogICAgICBjb25zb2xlLmluZm8oIlJvb206IHJlYWR5ISAoIi5jb25jYXQodGhpcy5yb29tTmFtZSwgIikiKSk7CiAgICB9CiAgfSwgewogICAga2V5OiAib24iLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9uKGV2ZW50TmFtZSwgaGFuZGxlcikgewogICAgICB0aGlzLl9ldmVudHMuc3Vic2NyaWJlKGV2ZW50TmFtZSwgaGFuZGxlcik7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJvZmYiLAogICAgdmFsdWU6IGZ1bmN0aW9uIG9mZihldmVudE5hbWUsIGhhbmRsZXIpIHsKICAgICAgdGhpcy5fZXZlbnRzLnVuc3Vic2NyaWJlKGV2ZW50TmFtZSwgaGFuZGxlcik7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJvbmNlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBvbmNlKGV2ZW50TmFtZSwgaGFuZGxlcikgewogICAgICB0aGlzLl9ldmVudHMub25jZShldmVudE5hbWUsIGhhbmRsZXIpOwoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfSwgewogICAga2V5OiAic3Vic2NyaWJlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzdWJzY3JpYmUoZXZlbnROYW1lLCBoYW5kbGVyKSB7CiAgICAgIHRoaXMuX2V2ZW50cy5zdWJzY3JpYmUoZXZlbnROYW1lLCBoYW5kbGVyKTsKCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0sIHsKICAgIGtleTogInVuc3Vic2NyaWJlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB1bnN1YnNjcmliZShldmVudE5hbWUsIGhhbmRsZXIpIHsKICAgICAgdGhpcy5fZXZlbnRzLnVuc3Vic2NyaWJlKGV2ZW50TmFtZSwgaGFuZGxlcik7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJfcmVjb3Zlck1lc3NhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9yZWNvdmVyTWVzc2FnZShtZXNzYWdlLCBzaWduKSB7CiAgICAgIHZhciBoYXNoID0gdGhpcy5hcHAuZW52LndlYjMudXRpbHMuc29saWRpdHlTaGEzKEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpKTsKICAgICAgdmFyIHJlY292ZXIgPSB0aGlzLmFwcC5lbnYud2ViMy5ldGguYWNjb3VudHMucmVjb3ZlcihoYXNoLCBzaWduLnNpZ25hdHVyZSk7CiAgICAgIHJldHVybiByZWNvdmVyOwogICAgfQogIH0sIHsKICAgIGtleTogIl9zaWduTWVzc2FnZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3NpZ25NZXNzYWdlKG1lc3NhZ2UpIHsKICAgICAgdmFyIGhhc2ggPSB0aGlzLmFwcC5lbnYud2ViMy51dGlscy5zb2xpZGl0eVNoYTMoSlNPTi5zdHJpbmdpZnkobWVzc2FnZSkpOwogICAgICB2YXIgc2lnbiA9IHRoaXMuYXBwLmVudi53ZWIzLmV0aC5hY2NvdW50cy5zaWduKGhhc2gsIHRoaXMuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHMuZXRoLnByaXZhdGVLZXkpOwogICAgICByZXR1cm4gc2lnbjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjaGVja1JlY2VpdmluZyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2hlY2tSZWNlaXZpbmcobWVzc2FnZSwgY2FsbGJhY2spIHsKICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICB2YXIgYWRkcmVzcyA9IG1lc3NhZ2UuZnJvbUFkZHJlc3M7CgogICAgICB2YXIgd2FpdFJlY2VpcHQgPSBmdW5jdGlvbiB3YWl0UmVjZWlwdChkYXRhKSB7CiAgICAgICAgaWYgKCFkYXRhLmFjdGlvbiB8fCBkYXRhLmFjdGlvbiAhPT0gJ2NvbmZpcm1hdGlvbicpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChKU09OLnN0cmluZ2lmeShtZXNzYWdlLmRhdGEpID09PSBKU09OLnN0cmluZ2lmeShkYXRhLm1lc3NhZ2UpKSB7CiAgICAgICAgICBfdGhpczQudW5zdWJzY3JpYmUoYWRkcmVzcywgd2FpdFJlY2VpcHQpOwoKICAgICAgICAgIGlmIChfdGhpczQuQ2hlY2tSZWNlaXB0c1RbbWVzc2FnZS5wZWVyXSkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQoX3RoaXM0LkNoZWNrUmVjZWlwdHNUW21lc3NhZ2UucGVlcl0pOwogICAgICAgICAgfQoKICAgICAgICAgIGNhbGxiYWNrKHRydWUpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHRoaXMuc3Vic2NyaWJlKGFkZHJlc3MsIHdhaXRSZWNlaXB0KTsKCiAgICAgIGlmICghdGhpcy5DaGVja1JlY2VpcHRzVCkgewogICAgICAgIHRoaXMuQ2hlY2tSZWNlaXB0c1QgPSB7fTsKICAgICAgfQoKICAgICAgdGhpcy5DaGVja1JlY2VpcHRzVFttZXNzYWdlLnBlZXJdID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXM0LnVuc3Vic2NyaWJlKGFkZHJlc3MsIHdhaXRSZWNlaXB0KTsKCiAgICAgICAgY2FsbGJhY2soZmFsc2UpOwogICAgICB9LCAxNTAwMCk7CiAgICB9CiAgfSwgewogICAga2V5OiAic2VuZENvbmZpcm1hdGlvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2VuZENvbmZpcm1hdGlvbihwZWVyLCBtZXNzYWdlKSB7CiAgICAgIHZhciBfdGhpczUgPSB0aGlzOwoKICAgICAgdmFyIGNhbGxiYWNrID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiBudWxsOwogICAgICB2YXIgcmVwZWF0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbM10gOiA5OwoKICAgICAgaWYgKCF0aGlzLmNvbm5lY3Rpb24pIHsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgIF90aGlzNS5zZW5kQ29uZmlybWF0aW9uKHBlZXIsIG1lc3NhZ2UsIGNhbGxiYWNrLCByZXBlYXQpOwogICAgICAgIH0sIDEwMDApOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKG1lc3NhZ2UuYWN0aW9uID09PSAnY29uZmlybWF0aW9uJyAmJiBwZWVyICE9PSB0aGlzLnBlZXIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIG1lc3NhZ2UgPSB0aGlzLnNlbmRNZXNzYWdlUGVlcihwZWVyLCBtZXNzYWdlKTsKICAgICAgdGhpcy5jaGVja1JlY2VpdmluZyhtZXNzYWdlLCBmdW5jdGlvbiAoZGVsaXZlcmVkKSB7CiAgICAgICAgaWYgKCFkZWxpdmVyZWQgJiYgcmVwZWF0ID4gMCkgewogICAgICAgICAgcmVwZWF0LS07CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgX3RoaXM1LnNlbmRDb25maXJtYXRpb24ocGVlciwgbWVzc2FnZSwgY2FsbGJhY2ssIHJlcGVhdCk7CiAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGNhbGxiYWNrKGRlbGl2ZXJlZCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJhY2tub3dsZWRnZVJlY2VpcHQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFja25vd2xlZGdlUmVjZWlwdChtZXNzYWdlKSB7CiAgICAgIGlmICghbWVzc2FnZS5wZWVyIHx8ICFtZXNzYWdlLmFjdGlvbiB8fCBtZXNzYWdlLmFjdGlvbiA9PT0gJ2NvbmZpcm1hdGlvbicgfHwgbWVzc2FnZS5hY3Rpb24gPT09ICdhY3RpdmUnKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgZnJvbUFkZHJlc3MgPSBtZXNzYWdlLmZyb21BZGRyZXNzLAogICAgICAgICAgZGF0YSA9IG1lc3NhZ2UuZGF0YTsKICAgICAgdGhpcy5zZW5kTWVzc2FnZVBlZXIoZnJvbUFkZHJlc3MsIHsKICAgICAgICBhY3Rpb246ICdjb25maXJtYXRpb24nLAogICAgICAgIGRhdGE6IGRhdGEKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAic2VuZE1lc3NhZ2VQZWVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZW5kTWVzc2FnZVBlZXIocGVlciwgbWVzc2FnZSkgewogICAgICB2YXIgX3RoaXM2ID0gdGhpczsKCiAgICAgIGlmICghdGhpcy5jb25uZWN0aW9uKSB7CiAgICAgICAgaWYgKG1lc3NhZ2UuYWN0aW9uICE9PSAnYWN0aXZlJykgewogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIF90aGlzNi5zZW5kTWVzc2FnZVBlZXIocGVlciwgbWVzc2FnZSk7CiAgICAgICAgICB9LCA5OTkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBkZWJ1Zygnc3dhcC52ZXJib3NlOnJvb20nKSgnc2VudCBtZXNzYWdlIHRvIHBlZXInLCBwZWVyKTsgLy8gZGVidWcoJ3N3YXAudmVyYm9zZTpyb29tJykoJ21lc3NhZ2UnLCBtZXNzYWdlKQoKICAgICAgdmFyIGRhdGEgPSBtZXNzYWdlLmRhdGEsCiAgICAgICAgICBldmVudCA9IG1lc3NhZ2UuZXZlbnQ7CgogICAgICB2YXIgc2lnbiA9IHRoaXMuX3NpZ25NZXNzYWdlKGRhdGEpOwoKICAgICAgdGhpcy5jb25uZWN0aW9uLnNlbmRUbyhwZWVyLCBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgZnJvbUFkZHJlc3M6IHRoaXMuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHMuZXRoLmFkZHJlc3MsCiAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICBldmVudDogZXZlbnQsCiAgICAgICAgc2lnbjogc2lnbgogICAgICB9KSk7CiAgICAgIHJldHVybiBtZXNzYWdlOwogICAgfQogIH0sIHsKICAgIGtleTogInNlbmRNZXNzYWdlUm9vbSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2VuZE1lc3NhZ2VSb29tKG1lc3NhZ2UpIHsKICAgICAgdmFyIGRhdGEgPSBtZXNzYWdlLmRhdGEsCiAgICAgICAgICBldmVudCA9IG1lc3NhZ2UuZXZlbnQ7CgogICAgICB2YXIgc2lnbiA9IHRoaXMuX3NpZ25NZXNzYWdlKGRhdGEpOwoKICAgICAgdGhpcy5jb25uZWN0aW9uLmJyb2FkY2FzdChKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgZnJvbUFkZHJlc3M6IHRoaXMuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHMuZXRoLmFkZHJlc3MsCiAgICAgICAgZGF0YTogZGF0YSwKICAgICAgICBldmVudDogZXZlbnQsCiAgICAgICAgc2lnbjogc2lnbgogICAgICB9KSk7CiAgICB9CiAgfV0sIFt7CiAgICBrZXk6ICJuYW1lIiwKICAgIGdldDogLy9ACiAgICBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiAncm9vbSc7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gU3dhcFJvb207Cn0oU2VydmljZUludGVyZmFjZSk7CgpleHBvcnQgZGVmYXVsdCBTd2FwUm9vbTs="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.room/SwapRoom.ts"],"names":["debug","Events","ServiceInterface","createP2PNode","p2pRoom","SwapRoom","config","peer","_events","dispatch","message","from","rawData","data","parsedData","JSON","parse","toString","err","console","error","fromAddress","sign","event","action","recover","_recoverMessage","acknowledgeReceipt","fromPeer","id","Error","_serviceName","_config","connection","roomName","peerIdJson","app","env","storage","getItem","then","p2pNode","setItem","peerId","toJSON","start","_init","_idB58String","p2pConnection","log","info","setTimeout","defaultRoomName","isMainNet","pollInterval","isOnline","on","_handleUserOnline","_handleUserOffline","_handleNewMessage","eventName","handler","subscribe","unsubscribe","once","hash","web3","utils","soliditySha3","stringify","eth","accounts","signature","services","auth","privateKey","callback","address","waitReceipt","CheckReceiptsT","clearTimeout","repeat","sendConfirmation","sendMessagePeer","checkReceiving","delivered","_signMessage","sendTo","broadcast"],"mappings":";;;;;;;;;;;;;;;;;;;AAAA;AACA,OAAOA,KAAP,MAAkB,OAAlB;AACA,SAA6BC,MAA7B,EAAqCC,gBAArC,QAA6D,UAA7D;AAEA,OAAOC,aAAP,MAA0B,iDAA1B;AACA,OAAOC,OAAP,MAAoB,mCAApB;;IAGMC,Q;;;;;AAgBJ,oBAAYC,MAAZ,EAAoB;AAAA;;AAAA;;AAClB;;AADkB;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA,wEA+EA,UAACC,IAAD,EAAU;AAC5B,UAAIA,IAAI,KAAK,MAAKA,IAAlB,EAAwB;AACtB,cAAKC,OAAL,CAAaC,QAAb,CAAsB,aAAtB,EAAqCF,IAArC;AACD;AACF,KAnFmB;;AAAA,yEAqFC,UAACA,IAAD,EAAU;AAC7B,UAAIA,IAAI,KAAK,MAAKA,IAAlB,EAAwB;AACtB,cAAKC,OAAL,CAAaC,QAAb,CAAsB,cAAtB,EAAsCF,IAAtC;AACD;AACF,KAzFmB;;AAAA,wEA2FA,UAACG,OAAD,EAAa;AAAA,UACvBC,IADuB,GACCD,OADD,CACvBC,IADuB;AAAA,UACXC,OADW,GACCF,OADD,CACjBG,IADiB;AAE/Bb,MAAAA,KAAK,CAAC,mBAAD,CAAL,CAA2B,cAA3B,EAA2CW,IAA3C;;AAGA,UAAIA,IAAI,KAAK,MAAKJ,IAAlB,EAAwB;AACtB;AACD;;AAED,UAAIO,UAAJ;;AAEA,UAAI;AACFA,QAAAA,UAAU,GAAGC,IAAI,CAACC,KAAL,CAAWJ,OAAO,CAACK,QAAR,EAAX,CAAb;AACD,OAFD,CAEE,OAAOC,GAAP,EAAY;AACZC,QAAAA,OAAO,CAACC,KAAR,CAAc,yBAAd,EAAyCF,GAAzC;AACD;;AAf8B,wBAiBoBJ,UAjBpB;AAAA,UAiBvBO,WAjBuB,eAiBvBA,WAjBuB;AAAA,UAiBVR,IAjBU,eAiBVA,IAjBU;AAAA,UAiBJS,IAjBI,eAiBJA,IAjBI;AAAA,UAiBEC,KAjBF,eAiBEA,KAjBF;AAAA,UAiBSC,MAjBT,eAiBSA,MAjBT;;AAmB/B,UAAI,CAACX,IAAL,EAAW;AACT;AACD;;AAEDb,MAAAA,KAAK,CAAC,mBAAD,CAAL,CAA2B,OAA3B,EAAoCc,UAApC;;AAEA,UAAMW,OAAO,GAAG,MAAKC,eAAL,CAAqBb,IAArB,EAA2BS,IAA3B,CAAhB;;AAEA,UAAIG,OAAO,KAAKJ,WAAhB,EAA6B;AAC3BF,QAAAA,OAAO,CAACC,KAAR,6CAAmDC,WAAnD,wBAA4EI,OAA5E;AACA;AACD;;AAED,UAAID,MAAM,KAAK,QAAf,EAAyB;AACvB,cAAKG,kBAAL,CAAwBb,UAAxB;AACD;;AAED,YAAKN,OAAL,CAAaC,QAAb,CAAsBc,KAAtB;AACEK,QAAAA,QAAQ,EAAEjB,IAAI,CAACkB;AADjB,SAEKhB,IAFL;AAID,KAnImB;;AAGlB,QAAI,CAACP,MAAD,IAAW,QAAOA,MAAP,MAAkB,QAA7B,IAAyC,QAAOA,MAAM,CAACA,MAAd,MAAyB,QAAtE,EAAgF;AAC9E,YAAM,IAAIwB,KAAJ,CAAU,mDAAV,CAAN;AACD;;AAED,UAAKC,YAAL,GAAsB,MAAtB;AACA,UAAKC,OAAL,GAAsB1B,MAAtB;AACA,UAAKE,OAAL,GAAsB,IAAIP,MAAJ,EAAtB;AACA,UAAKM,IAAL,GAAsB,IAAtB;AACA,UAAK0B,UAAL,GAAsB,IAAtB;AACA,UAAKC,QAAL,GAAsB,IAAtB;AAZkB;AAanB;;;;WAED,uBAAc;AAAA;;AACZ,UAAMC,UAAU,GAAG,KAAKC,GAAL,CAASC,GAAT,CAAaC,OAAb,CAAqBC,OAArB,CACjB,mBADiB,CAAnB;AAGApC,MAAAA,aAAa,CAAC;AACZgC,QAAAA,UAAU,EAAVA;AADY,OAAD,CAAb,CAEGK,IAFH,CAEQ,UAACC,OAAD,EAAkB;AACxB;AACA,QAAA,MAAI,CAACL,GAAL,CAASC,GAAT,CAAaC,OAAb,CAAqBI,OAArB,CACE,mBADF,EAEED,OAAO,CAACE,MAAR,CAAeC,MAAf,EAFF,EAFwB,CAMxB;;;AACAH,QAAAA,OAAO,CAACI,KAAR,GAAgBL,IAAhB,wEAAqB;AAAA;AAAA;AAAA;AAAA;AACnB,kBAAA,MAAI,CAACM,KAAL,CAAW;AACTvC,oBAAAA,IAAI,EAAE;AACJsB,sBAAAA,EAAE,EAAEY,OAAO,CAACE,MAAR,CAAeI;AADf,qBADG;AAITC,oBAAAA,aAAa,EAAEP;AAJN,mBAAX;;AADmB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAArB,aAOS,UAACrB,KAAD,EAAW;AAClBD,UAAAA,OAAO,CAAC8B,GAAR,CAAY,oBAAZ,EAAkC7B,KAAlC;AACD,SATD;AAUD,OAnBD;AAoBD;;;WAGD,sBAA+B;AAAA;;AAAA,UAAvBb,IAAuB,SAAvBA,IAAuB;AAAA,UAAjByC,aAAiB,SAAjBA,aAAiB;AAC7B7B,MAAAA,OAAO,CAAC+B,IAAR,CAAa,eAAb;;AACA,UAAI,CAACF,aAAL,EAAoB;AAClBG,QAAAA,UAAU,CAAC,YAAM;AACf,UAAA,MAAI,CAACL,KAAL,CAAW;AAAEvC,YAAAA,IAAI,EAAJA,IAAF;AAAQyC,YAAAA,aAAa,EAAbA;AAAR,WAAX;AACD,SAFS,EAEP,GAFO,CAAV;AAGA;AACD;;AAED,WAAKzC,IAAL,GAAYA,IAAI,CAACsB,EAAjB;AAEA,UAAMuB,eAAe,GAAG,KAAKhB,GAAL,CAASiB,SAAT,KACpB,aADoB,GAEpB,qBAFJ;AAIA,WAAKnB,QAAL,GAAgB,KAAKF,OAAL,CAAaE,QAAb,IAAyBkB,eAAzC;AAEApD,MAAAA,KAAK,CAAC,gBAAD,CAAL,uBAAuC,KAAKkC,QAA5C;AAEA,WAAKD,UAAL,GAAkB,IAAI7B,OAAJ,CAAY4C,aAAZ,EAA2B,KAAKd,QAAhC,EAA0C;AAC1DoB,QAAAA,YAAY,EAAE;AAD4C,OAA1C,CAAlB;;AAIA,WAAKrB,UAAL,CAAgBsB,QAAhB,GAA2B,YAAM;AAC/BpC,QAAAA,OAAO,CAAC8B,GAAR,CAAY,0BAAZ,EAD+B,CAE/B;;AACA,eAAO,IAAP;AACD,OAJD;;AAMA,WAAKhB,UAAL,CAAgBuB,EAAhB,CAAmB,aAAnB,EAAkC,KAAKC,iBAAvC;AACA,WAAKxB,UAAL,CAAgBuB,EAAhB,CAAmB,WAAnB,EAAgC,KAAKE,kBAArC;AACA,WAAKzB,UAAL,CAAgBuB,EAAhB,CAAmB,SAAnB,EAA8B,KAAKG,iBAAnC;;AAEA,WAAKnD,OAAL,CAAaC,QAAb,CAAsB,OAAtB;;AACAU,MAAAA,OAAO,CAAC+B,IAAR,yBAA8B,KAAKhB,QAAnC;AACD;;;WAwDD,YAAG0B,SAAH,EAAcC,OAAd,EAAuB;AACrB,WAAKrD,OAAL,CAAasD,SAAb,CAAuBF,SAAvB,EAAkCC,OAAlC;;AACA,aAAO,IAAP;AACD;;;WAED,aAAID,SAAJ,EAAeC,OAAf,EAAwB;AACtB,WAAKrD,OAAL,CAAauD,WAAb,CAAyBH,SAAzB,EAAoCC,OAApC;;AACA,aAAO,IAAP;AACD;;;WAED,cAAKD,SAAL,EAAgBC,OAAhB,EAAyB;AACvB,WAAKrD,OAAL,CAAawD,IAAb,CAAkBJ,SAAlB,EAA6BC,OAA7B;;AACA,aAAO,IAAP;AACD;;;WAED,mBAAUD,SAAV,EAAqBC,OAArB,EAA8B;AAC5B,WAAKrD,OAAL,CAAasD,SAAb,CAAuBF,SAAvB,EAAkCC,OAAlC;;AACA,aAAO,IAAP;AACD;;;WAED,qBAAYD,SAAZ,EAAuBC,OAAvB,EAAgC;AAC9B,WAAKrD,OAAL,CAAauD,WAAb,CAAyBH,SAAzB,EAAoCC,OAApC;;AACA,aAAO,IAAP;AACD;;;WAED,yBAAgBnD,OAAhB,EAAyBY,IAAzB,EAA+B;AAC7B,UAAM2C,IAAI,GAAQ,KAAK7B,GAAL,CAASC,GAAT,CAAa6B,IAAb,CAAkBC,KAAlB,CAAwBC,YAAxB,CAAqCrD,IAAI,CAACsD,SAAL,CAAe3D,OAAf,CAArC,CAAlB;AACA,UAAMe,OAAO,GAAK,KAAKW,GAAL,CAASC,GAAT,CAAa6B,IAAb,CAAkBI,GAAlB,CAAsBC,QAAtB,CAA+B9C,OAA/B,CAAuCwC,IAAvC,EAA6C3C,IAAI,CAACkD,SAAlD,CAAlB;AAEA,aAAO/C,OAAP;AACD;;;WAED,sBAAaf,OAAb,EAAsB;AACpB,UAAMuD,IAAI,GAAI,KAAK7B,GAAL,CAASC,GAAT,CAAa6B,IAAb,CAAkBC,KAAlB,CAAwBC,YAAxB,CAAqCrD,IAAI,CAACsD,SAAL,CAAe3D,OAAf,CAArC,CAAd;AACA,UAAMY,IAAI,GAAI,KAAKc,GAAL,CAASC,GAAT,CAAa6B,IAAb,CAAkBI,GAAlB,CAAsBC,QAAtB,CAA+BjD,IAA/B,CAAoC2C,IAApC,EAA0C,KAAK7B,GAAL,CAASqC,QAAT,CAAkBC,IAAlB,CAAuBH,QAAvB,CAAgCD,GAAhC,CAAoCK,UAA9E,CAAd;AAEA,aAAOrD,IAAP;AACD;;;WAED,wBAAeZ,OAAf,EAAwBkE,QAAxB,EAAkC;AAAA;;AAChC,UAAIC,OAAO,GAAGnE,OAAO,CAACW,WAAtB;;AAEA,UAAMyD,WAAW,GAAG,SAAdA,WAAc,CAACjE,IAAD,EAAU;AAC5B,YAAI,CAACA,IAAI,CAACW,MAAN,IAAgBX,IAAI,CAACW,MAAL,KAAgB,cAApC,EAAoD;AAClD;AACD;;AAED,YAAIT,IAAI,CAACsD,SAAL,CAAe3D,OAAO,CAACG,IAAvB,MAAiCE,IAAI,CAACsD,SAAL,CAAexD,IAAI,CAACH,OAApB,CAArC,EAAmE;AACjE,UAAA,MAAI,CAACqD,WAAL,CAAiBc,OAAjB,EAA0BC,WAA1B;;AAEA,cAAI,MAAI,CAACC,cAAL,CAAoBrE,OAAO,CAACH,IAA5B,CAAJ,EAAuC;AACrCyE,YAAAA,YAAY,CAAC,MAAI,CAACD,cAAL,CAAoBrE,OAAO,CAACH,IAA5B,CAAD,CAAZ;AACD;;AAEDqE,UAAAA,QAAQ,CAAC,IAAD,CAAR;AACD;AACF,OAdD;;AAgBA,WAAKd,SAAL,CAAee,OAAf,EAAwBC,WAAxB;;AAEA,UAAI,CAAC,KAAKC,cAAV,EAA0B;AACxB,aAAKA,cAAL,GAAsB,EAAtB;AACD;;AAED,WAAKA,cAAL,CAAoBrE,OAAO,CAACH,IAA5B,IAAoC4C,UAAU,CAAC,YAAM;AACnD,QAAA,MAAI,CAACY,WAAL,CAAiBc,OAAjB,EAA0BC,WAA1B;;AAEAF,QAAAA,QAAQ,CAAC,KAAD,CAAR;AACD,OAJ6C,EAI3C,KAJ2C,CAA9C;AAKD;;;WAED,0BAAiBrE,IAAjB,EAAuBG,OAAvB,EAA6D;AAAA;;AAAA,UAA7BkE,QAA6B,uEAAlB,IAAkB;AAAA,UAAZK,MAAY,uEAAH,CAAG;;AAC3D,UAAI,CAAC,KAAKhD,UAAV,EAAsB;AACpBkB,QAAAA,UAAU,CAAC,YAAM;AACf,UAAA,MAAI,CAAC+B,gBAAL,CAAsB3E,IAAtB,EAA4BG,OAA5B,EAAqCkE,QAArC,EAA+CK,MAA/C;AACD,SAFS,EAEP,IAFO,CAAV;AAGA;AACD;;AAED,UAAIvE,OAAO,CAACc,MAAR,KAAmB,cAAnB,IAAqCjB,IAAI,KAAK,KAAKA,IAAvD,EAA6D;AAC3D;AACD;;AAEDG,MAAAA,OAAO,GAAG,KAAKyE,eAAL,CAAqB5E,IAArB,EAA2BG,OAA3B,CAAV;AAEA,WAAK0E,cAAL,CAAoB1E,OAApB,EAA6B,UAAA2E,SAAS,EAAI;AACxC,YAAI,CAACA,SAAD,IAAcJ,MAAM,GAAG,CAA3B,EAA8B;AAC5BA,UAAAA,MAAM;AACN9B,UAAAA,UAAU,CAAC,YAAM;AACf,YAAA,MAAI,CAAC+B,gBAAL,CAAsB3E,IAAtB,EAA4BG,OAA5B,EAAqCkE,QAArC,EAA+CK,MAA/C;AACD,WAFS,EAEP,IAFO,CAAV;AAGA;AACD;;AAED,YAAI,OAAOL,QAAP,KAAoB,UAAxB,EAAoC;AAClCA,UAAAA,QAAQ,CAACS,SAAD,CAAR;AACD;AACF,OAZD;AAaD;;;WAED,4BAAmB3E,OAAnB,EAA4B;AAC1B,UAAI,CAACA,OAAO,CAACH,IAAT,IAAiB,CAACG,OAAO,CAACc,MAA1B,IACCd,OAAO,CAACc,MAAR,KAAoB,cADrB,IAECd,OAAO,CAACc,MAAR,KAAoB,QAFzB,EAEmC;AACjC;AACD;;AALyB,UAOlBH,WAPkB,GAOIX,OAPJ,CAOlBW,WAPkB;AAAA,UAOLR,IAPK,GAOIH,OAPJ,CAOLG,IAPK;AAS1B,WAAKsE,eAAL,CAAqB9D,WAArB,EAAkC;AAChCG,QAAAA,MAAM,EAAI,cADsB;AAEhCX,QAAAA,IAAI,EAAJA;AAFgC,OAAlC;AAID;;;WAED,yBAAgBN,IAAhB,EAAsBG,OAAtB,EAA+B;AAAA;;AAC7B,UAAI,CAAC,KAAKuB,UAAV,EAAsB;AACpB,YAAIvB,OAAO,CAACc,MAAR,KAAmB,QAAvB,EAAiC;AAC/B2B,UAAAA,UAAU,CAAC,YAAM;AACf,YAAA,MAAI,CAACgC,eAAL,CAAqB5E,IAArB,EAA2BG,OAA3B;AACD,WAFS,EAEP,GAFO,CAAV;AAGD;;AACD;AACD;;AAEDV,MAAAA,KAAK,CAAC,mBAAD,CAAL,CAA2B,sBAA3B,EAAmDO,IAAnD,EAV6B,CAW7B;;AAX6B,UAarBM,IAbqB,GAaJH,OAbI,CAarBG,IAbqB;AAAA,UAafU,KAbe,GAaJb,OAbI,CAafa,KAbe;;AAc7B,UAAMD,IAAI,GAAG,KAAKgE,YAAL,CAAkBzE,IAAlB,CAAb;;AAEA,WAAKoB,UAAL,CAAgBsD,MAAhB,CAAuBhF,IAAvB,EAA6BQ,IAAI,CAACsD,SAAL,CAAe;AAC1ChD,QAAAA,WAAW,EAAE,KAAKe,GAAL,CAASqC,QAAT,CAAkBC,IAAlB,CAAuBH,QAAvB,CAAgCD,GAAhC,CAAoCO,OADP;AAE1ChE,QAAAA,IAAI,EAAJA,IAF0C;AAG1CU,QAAAA,KAAK,EAALA,KAH0C;AAI1CD,QAAAA,IAAI,EAAJA;AAJ0C,OAAf,CAA7B;AAOA,aAAOZ,OAAP;AACD;;;WAED,yBAAgBA,OAAhB,EAAyB;AAAA,UACfG,IADe,GACCH,OADD,CACfG,IADe;AAAA,UACTU,KADS,GACCb,OADD,CACTa,KADS;;AAEvB,UAAMD,IAAI,GAAG,KAAKgE,YAAL,CAAkBzE,IAAlB,CAAb;;AAEA,WAAKoB,UAAL,CAAgBuD,SAAhB,CAA0BzE,IAAI,CAACsD,SAAL,CAAe;AACvChD,QAAAA,WAAW,EAAE,KAAKe,GAAL,CAASqC,QAAT,CAAkBC,IAAlB,CAAuBH,QAAvB,CAAgCD,GAAhC,CAAoCO,OADV;AAEvChE,QAAAA,IAAI,EAAJA,IAFuC;AAGvCU,QAAAA,KAAK,EAALA,KAHuC;AAIvCD,QAAAA,IAAI,EAAJA;AAJuC,OAAf,CAA1B;AAMD;;;SAjSD;AACA,mBAAkB;AAChB,aAAO,MAAP;AACD;;;;EAdoBpB,gB;;AAgTvB,eAAeG,QAAf","sourcesContent":["// @ts-nocheck\r\nimport debug from 'debug'\r\nimport SwapApp, { constants, Events, ServiceInterface } from 'swap.app'\r\n\r\nimport createP2PNode from '../../common/messaging/pubsubRoom/createP2PNode'\r\nimport p2pRoom from '../../common/messaging/pubsubRoom'\r\n\r\n\r\nclass SwapRoom extends ServiceInterface {\r\n\r\n  _serviceName: string\r\n  _config: any\r\n  _events: any\r\n  peer: any\r\n  connection: any\r\n  roomName: string\r\n\r\n  app: any\r\n  CheckReceiptsT: any\r\n  //@\r\n  static get name() {\r\n    return 'room'\r\n  }\r\n\r\n  constructor(config) {\r\n    super()\r\n\r\n    if (!config || typeof config !== 'object' || typeof config.config !== 'object') {\r\n      throw new Error('SwapRoomService: \"config\" of type object required')\r\n    }\r\n\r\n    this._serviceName   = 'room'\r\n    this._config        = config\r\n    this._events        = new Events()\r\n    this.peer           = null\r\n    this.connection     = null\r\n    this.roomName       = null\r\n  }\r\n\r\n  initService() {\r\n    const peerIdJson = this.app.env.storage.getItem(\r\n      'libp2p:peerIdJson'\r\n    )\r\n    createP2PNode({\r\n      peerIdJson,\r\n    }).then((p2pNode: any) => {\r\n      // Save PeerId\r\n      this.app.env.storage.setItem(\r\n        'libp2p:peerIdJson',\r\n        p2pNode.peerId.toJSON()\r\n      )\r\n      // Start p2p node\r\n      p2pNode.start().then(async () => {\r\n        this._init({\r\n          peer: {\r\n            id: p2pNode.peerId._idB58String,\r\n          },\r\n          p2pConnection: p2pNode,\r\n        })\r\n      }).catch((error) => {\r\n        console.log('Fail start p2pnode', error)\r\n      })\r\n    })\r\n  }\r\n\r\n\r\n  _init({ peer, p2pConnection }) {\r\n    console.info('Room: init...')\r\n    if (!p2pConnection) {\r\n      setTimeout(() => {\r\n        this._init({ peer, p2pConnection })\r\n      }, 999)\r\n      return\r\n    }\r\n\r\n    this.peer = peer.id\r\n\r\n    const defaultRoomName = this.app.isMainNet()\r\n      ? 'swap.online'\r\n      : 'testnet.swap.online'\r\n\r\n    this.roomName = this._config.roomName || defaultRoomName\r\n\r\n    debug('swap.core:room')(`Using room: ${this.roomName}`)\r\n\r\n    this.connection = new p2pRoom(p2pConnection, this.roomName, {\r\n      pollInterval: 1000,\r\n    })\r\n\r\n    this.connection.isOnline = () => {\r\n      console.log('Call pubsubRoom isOnline')\r\n      // @ToDo - may be use isStarted\r\n      return true\r\n    }\r\n\r\n    this.connection.on('peer joined', this._handleUserOnline)\r\n    this.connection.on('peer left', this._handleUserOffline)\r\n    this.connection.on('message', this._handleNewMessage)\r\n\r\n    this._events.dispatch('ready')\r\n    console.info(`Room: ready! (${this.roomName})`)\r\n  }\r\n\r\n  _handleUserOnline = (peer) => {\r\n    if (peer !== this.peer) {\r\n      this._events.dispatch('user online', peer)\r\n    }\r\n  }\r\n\r\n  _handleUserOffline = (peer) => {\r\n    if (peer !== this.peer) {\r\n      this._events.dispatch('user offline', peer)\r\n    }\r\n  }\r\n\r\n  _handleNewMessage = (message) => {\r\n    const { from, data: rawData } = message\r\n    debug('swap.verbose:room')('message from', from)\r\n\r\n\r\n    if (from === this.peer) {\r\n      return\r\n    }\r\n\r\n    let parsedData\r\n\r\n    try {\r\n      parsedData = JSON.parse(rawData.toString())\r\n    } catch (err) {\r\n      console.error('parse message data err:', err)\r\n    }\r\n\r\n    const { fromAddress, data, sign, event, action } = parsedData\r\n\r\n    if (!data) {\r\n      return\r\n    }\r\n\r\n    debug('swap.verbose:room')('data:', parsedData)\r\n\r\n    const recover = this._recoverMessage(data, sign)\r\n\r\n    if (recover !== fromAddress) {\r\n      console.error(`Wrong message sign! Message from: ${fromAddress}, recover: ${recover}`)\r\n      return\r\n    }\r\n\r\n    if (action === 'active') {\r\n      this.acknowledgeReceipt(parsedData)\r\n    }\r\n\r\n    this._events.dispatch(event, {\r\n      fromPeer: from.id,\r\n      ...data,\r\n    })\r\n  }\r\n\r\n  on(eventName, handler) {\r\n    this._events.subscribe(eventName, handler)\r\n    return this\r\n  }\r\n\r\n  off(eventName, handler) {\r\n    this._events.unsubscribe(eventName, handler)\r\n    return this\r\n  }\r\n\r\n  once(eventName, handler) {\r\n    this._events.once(eventName, handler)\r\n    return this\r\n  }\r\n\r\n  subscribe(eventName, handler) {\r\n    this._events.subscribe(eventName, handler)\r\n    return this\r\n  }\r\n\r\n  unsubscribe(eventName, handler) {\r\n    this._events.unsubscribe(eventName, handler)\r\n    return this\r\n  }\r\n\r\n  _recoverMessage(message, sign) {\r\n    const hash      = this.app.env.web3.utils.soliditySha3(JSON.stringify(message))\r\n    const recover   = this.app.env.web3.eth.accounts.recover(hash, sign.signature)\r\n\r\n    return recover\r\n  }\r\n\r\n  _signMessage(message) {\r\n    const hash  = this.app.env.web3.utils.soliditySha3(JSON.stringify(message))\r\n    const sign  = this.app.env.web3.eth.accounts.sign(hash, this.app.services.auth.accounts.eth.privateKey)\r\n\r\n    return sign\r\n  }\r\n\r\n  checkReceiving(message, callback) {\r\n    let address = message.fromAddress\r\n\r\n    const waitReceipt = (data) => {\r\n      if (!data.action || data.action !== 'confirmation') {\r\n        return\r\n      }\r\n\r\n      if (JSON.stringify(message.data) === JSON.stringify(data.message)) {\r\n        this.unsubscribe(address, waitReceipt)\r\n\r\n        if (this.CheckReceiptsT[message.peer]) {\r\n          clearTimeout(this.CheckReceiptsT[message.peer])\r\n        }\r\n\r\n        callback(true)\r\n      }\r\n    }\r\n\r\n    this.subscribe(address, waitReceipt)\r\n\r\n    if (!this.CheckReceiptsT) {\r\n      this.CheckReceiptsT = {}\r\n    }\r\n\r\n    this.CheckReceiptsT[message.peer] = setTimeout(() => {\r\n      this.unsubscribe(address, waitReceipt)\r\n\r\n      callback(false)\r\n    }, 15000)\r\n  }\r\n\r\n  sendConfirmation(peer, message, callback = null, repeat = 9) {\r\n    if (!this.connection) {\r\n      setTimeout(() => {\r\n        this.sendConfirmation(peer, message, callback, repeat)\r\n      }, 1000)\r\n      return\r\n    }\r\n\r\n    if (message.action === 'confirmation' && peer !== this.peer) {\r\n      return\r\n    }\r\n\r\n    message = this.sendMessagePeer(peer, message)\r\n\r\n    this.checkReceiving(message, delivered => {\r\n      if (!delivered && repeat > 0) {\r\n        repeat--\r\n        setTimeout(() => {\r\n          this.sendConfirmation(peer, message, callback, repeat)\r\n        }, 1000)\r\n        return\r\n      }\r\n\r\n      if (typeof callback === 'function') {\r\n        callback(delivered)\r\n      }\r\n    })\r\n  }\r\n\r\n  acknowledgeReceipt(message) {\r\n    if (!message.peer || !message.action\r\n      || message.action  === 'confirmation'\r\n      || message.action  === 'active') {\r\n      return\r\n    }\r\n\r\n    const { fromAddress, data } = message\r\n\r\n    this.sendMessagePeer(fromAddress, {\r\n      action  : 'confirmation',\r\n      data,\r\n    })\r\n  }\r\n\r\n  sendMessagePeer(peer, message) {\r\n    if (!this.connection) {\r\n      if (message.action !== 'active') {\r\n        setTimeout(() => {\r\n          this.sendMessagePeer(peer, message)\r\n        }, 999)\r\n      }\r\n      return\r\n    }\r\n\r\n    debug('swap.verbose:room')('sent message to peer', peer)\r\n    // debug('swap.verbose:room')('message', message)\r\n\r\n    const { data, event }  = message\r\n    const sign = this._signMessage(data)\r\n\r\n    this.connection.sendTo(peer, JSON.stringify({\r\n      fromAddress: this.app.services.auth.accounts.eth.address,\r\n      data,\r\n      event,\r\n      sign,\r\n    }))\r\n\r\n    return message\r\n  }\r\n\r\n  sendMessageRoom(message) {\r\n    const { data, event } = message\r\n    const sign = this._signMessage(data)\r\n\r\n    this.connection.broadcast(JSON.stringify({\r\n      fromAddress: this.app.services.auth.accounts.eth.address,\r\n      data,\r\n      event,\r\n      sign,\r\n    }))\r\n  }\r\n}\r\n\r\n\r\nexport default SwapRoom\r\n"]}]}