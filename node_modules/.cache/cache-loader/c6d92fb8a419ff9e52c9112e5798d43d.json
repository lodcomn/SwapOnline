{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\NEXT2ETH.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\NEXT2ETH.ts","mtime":1614842913760},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXN5bmNUb0dlbmVyYXRvciI7CmltcG9ydCBfY2xhc3NDYWxsQ2hlY2sgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jcmVhdGVDbGFzcyI7CmltcG9ydCBfYXNzZXJ0VGhpc0luaXRpYWxpemVkIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXNzZXJ0VGhpc0luaXRpYWxpemVkIjsKaW1wb3J0IF9pbmhlcml0cyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjsKaW1wb3J0IF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiI7CmltcG9ydCBfZ2V0IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0IjsKaW1wb3J0IF9nZXRQcm90b3R5cGVPZiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldFByb3RvdHlwZU9mIjsKaW1wb3J0IF9kZWZpbmVQcm9wZXJ0eSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2RlZmluZVByb3BlcnR5IjsKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgppbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnOwppbXBvcnQgeyBjb25zdGFudHMsIHV0aWwgfSBmcm9tICdzd2FwLmFwcCc7CmltcG9ydCB7IEF0b21pY0FCMlVUWE8gfSBmcm9tICdzd2FwLnN3YXAnOwppbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdiaWdudW1iZXIuanMnOwoKdmFyIE5FWFQyRVRIID0gLyojX19QVVJFX18qL2Z1bmN0aW9uIChfQXRvbWljQUIyVVRYTykgewogIF9pbmhlcml0cyhORVhUMkVUSCwgX0F0b21pY0FCMlVUWE8pOwoKICB2YXIgX3N1cGVyID0gX2NyZWF0ZVN1cGVyKE5FWFQyRVRIKTsKCiAgZnVuY3Rpb24gTkVYVDJFVEgoc3dhcCkgewogICAgdmFyIF90aGlzU3VwZXIsIF90aGlzOwoKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBORVhUMkVUSCk7CgogICAgX3RoaXMgPSBfc3VwZXIuY2FsbCh0aGlzLCBzd2FwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJfZmxvd05hbWUiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImV0aFN3YXAiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIm5leHRTd2FwIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJzdGF0ZSIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZ2V0UmVmdW5kVHhIZXgiLCBmdW5jdGlvbiAoKSB7CiAgICAgIF90aGlzLm5leHRTd2FwLmdldFJlZnVuZEhleFRyYW5zYWN0aW9uKHsKICAgICAgICBzY3JpcHRWYWx1ZXM6IF90aGlzLnN0YXRlLnV0eG9TY3JpcHRWYWx1ZXMsCiAgICAgICAgc2VjcmV0OiBfdGhpcy5zdGF0ZS5zZWNyZXQKICAgICAgfSkudGhlbihmdW5jdGlvbiAodHhIZXgpIHsKICAgICAgICBfdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICByZWZ1bmRUeEhleDogdHhIZXgKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBfdGhpcy51dHhvQ29pbiA9ICJuZXh0IjsKICAgIF90aGlzLl9mbG93TmFtZSA9IE5FWFQyRVRILmdldE5hbWUoKTsKICAgIF90aGlzLnN0ZXBOdW1iZXJzID0gewogICAgICAnc2lnbic6IDEsCiAgICAgICdzdWJtaXQtc2VjcmV0JzogMiwKICAgICAgJ3N5bmMtYmFsYW5jZSc6IDMsCiAgICAgICdsb2NrLXV0eG8nOiA0LAogICAgICAnd2FpdC1sb2NrLWV0aCc6IDUsCiAgICAgICd3aXRoZHJhdy1ldGgnOiA2LAogICAgICAnZmluaXNoJzogNywKICAgICAgJ2VuZCc6IDgKICAgIH07CiAgICBfdGhpcy5ldGhTd2FwID0gc3dhcC5vd25lclN3YXA7CiAgICBfdGhpcy5uZXh0U3dhcCA9IHN3YXAucGFydGljaXBhbnRTd2FwOwogICAgX3RoaXMuYWJCbG9ja2NoYWluID0gX3RoaXMuZXRoU3dhcDsKICAgIF90aGlzLnV0eG9CbG9ja2NoYWluID0gX3RoaXMubmV4dFN3YXA7CiAgICBfdGhpcy5pc1VUWE9TaWRlID0gdHJ1ZTsKCiAgICBpZiAoIV90aGlzLmV0aFN3YXApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdORVhUMkVUSDogImV0aFN3YXAiIG9mIHR5cGUgb2JqZWN0IHJlcXVpcmVkJyk7CiAgICB9CgogICAgaWYgKCFfdGhpcy5uZXh0U3dhcCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ05FWFQyRVRIOiAibmV4dFN3YXAiIG9mIHR5cGUgb2JqZWN0IHJlcXVpcmVkJyk7CiAgICB9CgogICAgX3RoaXMuc3RhdGUgPSB7CiAgICAgIHN0ZXA6IDAsCiAgICAgIGlzU3RvcHBlZFN3YXA6IGZhbHNlLAogICAgICBzaWduVHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICBpc1NpZ25GZXRjaGluZzogZmFsc2UsCiAgICAgIGlzUGFydGljaXBhbnRTaWduZWQ6IGZhbHNlLAogICAgICBldGhTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgIHNlY3JldEhhc2g6IG51bGwsCiAgICAgIGlzQmFsYW5jZUZldGNoaW5nOiBmYWxzZSwKICAgICAgaXNCYWxhbmNlRW5vdWdoOiB0cnVlLAogICAgICBiYWxhbmNlOiBudWxsLAogICAgICBpc0V0aENvbnRyYWN0RnVuZGVkOiBmYWxzZSwKICAgICAgbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgZXRoU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICBjYW5DcmVhdGVFdGhUcmFuc2FjdGlvbjogdHJ1ZSwKICAgICAgaXNFdGhXaXRoZHJhd246IGZhbHNlLAogICAgICByZWZ1bmRUcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgIGlzUmVmdW5kZWQ6IGZhbHNlLAogICAgICB3aXRoZHJhd0ZlZTogbnVsbCwKICAgICAgcmVmdW5kVHhIZXg6IG51bGwsCiAgICAgIGlzRmluaXNoZWQ6IGZhbHNlLAogICAgICBpc1N3YXBFeGlzdDogZmFsc2UsCiAgICAgIHJlcXVpcmVXaXRoZHJhd0ZlZTogZmFsc2UKICAgIH07CgogICAgX3RoaXMuX3BlcnNpc3RTdGF0ZSgpOwoKICAgIF9nZXQoKF90aGlzU3VwZXIgPSBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgX2dldFByb3RvdHlwZU9mKE5FWFQyRVRILnByb3RvdHlwZSkpLCAiX3BlcnNpc3RTdGVwcyIsIF90aGlzU3VwZXIpLmNhbGwoX3RoaXNTdXBlcik7CgogICAgcmV0dXJuIF90aGlzOwogIH0KCiAgX2NyZWF0ZUNsYXNzKE5FWFQyRVRILCBbewogICAga2V5OiAiX3BlcnNpc3RTdGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3BlcnNpc3RTdGF0ZSgpIHsKICAgICAgX2dldChfZ2V0UHJvdG90eXBlT2YoTkVYVDJFVEgucHJvdG90eXBlKSwgIl9wZXJzaXN0U3RhdGUiLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9nZXRTdGVwcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2dldFN0ZXBzKCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHZhciBmbG93ID0gdGhpczsKICAgICAgcmV0dXJuIFsKICAgICAgLyojX19QVVJFX18qLwogICAgICAvLyAxLiBTaWducwogICAgICBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfdGhpczIuc2lnblVUWE9TaWRlKCk7CgogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUpOwogICAgICB9KSksIC8vIDIuIENyZWF0ZSBzZWNyZXQsIHNlY3JldCBoYXNoIGFuZCBORVhUIHNjcmlwdAogICAgICBmdW5jdGlvbiAoKSB7Ly8gdGhpcy5zdWJtaXRTZWNyZXQoKQogICAgICB9LCAvLyAzLiBDaGVjayBiYWxhbmNlCiAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICBfdGhpczIuc3luY0JhbGFuY2UoKTsKICAgICAgfSwKICAgICAgLyojX19QVVJFX18qLwogICAgICAvLyA0LiBDcmVhdGUgTkVYVCBTY3JpcHQsIGZ1bmQsIG5vdGlmeSBwYXJ0aWNpcGFudAogICAgICBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNCgpIHsKICAgICAgICB2YXIgb25UcmFuc2FjdGlvbkhhc2gsIHNlbGxBbW91bnQsIF9mbG93JHN0YXRlMiwgaXNCYWxhbmNlRW5vdWdoLCB1dHhvU2NyaXB0VmFsdWVzLCBjaGVja05FWFRTY3JpcHRCYWxhbmNlLCBpc1N0b3BwZWRTd2FwOwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU0JChfY29udGV4dDQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ0LnByZXYgPSBfY29udGV4dDQubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIG9uVHJhbnNhY3Rpb25IYXNoID0gZnVuY3Rpb24gb25UcmFuc2FjdGlvbkhhc2godHhJRCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Zsb3ckc3RhdGUgPSBmbG93LnN0YXRlLAogICAgICAgICAgICAgICAgICAgICAgdXR4b1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoID0gX2Zsb3ckc3RhdGUudXR4b1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoLAogICAgICAgICAgICAgICAgICAgICAgdXR4b1NjcmlwdFZhbHVlcyA9IF9mbG93JHN0YXRlLnV0eG9TY3JpcHRWYWx1ZXM7CgogICAgICAgICAgICAgICAgICBpZiAodXR4b1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICB1dHhvU2NyaXB0Q3JlYXRpbmdUcmFuc2FjdGlvbkhhc2g6IHR4SUQKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLm9uY2UoJ3JlcXVlc3QgdXR4byBzY3JpcHQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6ICdjcmVhdGUgdXR4byBzY3JpcHQnLAogICAgICAgICAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXM6IHV0eG9TY3JpcHRWYWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgIHV0eG9TY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaDogdHhJRAogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgIGV2ZW50OiAnY3JlYXRlIHV0eG8gc2NyaXB0JywKICAgICAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXM6IHV0eG9TY3JpcHRWYWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgICB1dHhvU2NyaXB0Q3JlYXRpbmdUcmFuc2FjdGlvbkhhc2g6IHR4SUQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBzZWxsQW1vdW50ID0gZmxvdy5zd2FwLnNlbGxBbW91bnQ7CiAgICAgICAgICAgICAgICBfZmxvdyRzdGF0ZTIgPSBmbG93LnN0YXRlLCBpc0JhbGFuY2VFbm91Z2ggPSBfZmxvdyRzdGF0ZTIuaXNCYWxhbmNlRW5vdWdoLCB1dHhvU2NyaXB0VmFsdWVzID0gX2Zsb3ckc3RhdGUyLnV0eG9TY3JpcHRWYWx1ZXM7CgogICAgICAgICAgICAgICAgaWYgKCFpc0JhbGFuY2VFbm91Z2gpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSA2OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDY7CiAgICAgICAgICAgICAgICByZXR1cm4gZmxvdy5uZXh0U3dhcC5mdW5kU2NyaXB0KHsKICAgICAgICAgICAgICAgICAgc2NyaXB0VmFsdWVzOiB1dHhvU2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICBhbW91bnQ6IHNlbGxBbW91bnQKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICBjaGVja05FWFRTY3JpcHRCYWxhbmNlID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWYzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90aGlzMiRuZXh0U3dhcCRjcmVhdCwgc2NyaXB0QWRkcmVzcywgdW5zcGVudHMsIHR4SUQsIGJhbGFuY2UsIGlzRW5vdWdoTW9uZXk7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIkKF9jb250ZXh0MikgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDIucHJldiA9IF9jb250ZXh0Mi5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMyJG5leHRTd2FwJGNyZWF0ID0gX3RoaXMyLm5leHRTd2FwLmNyZWF0ZVNjcmlwdCh1dHhvU2NyaXB0VmFsdWVzKSwgc2NyaXB0QWRkcmVzcyA9IF90aGlzMiRuZXh0U3dhcCRjcmVhdC5zY3JpcHRBZGRyZXNzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzMi5uZXh0U3dhcC5mZXRjaFVuc3BlbnRzKHNjcmlwdEFkZHJlc3MpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bnNwZW50cyA9IF9jb250ZXh0Mi5zZW50OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKHVuc3BlbnRzLmxlbmd0aCA9PT0gMCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSA2OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLmFicnVwdCgicmV0dXJuIiwgZmFsc2UpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eElEID0gdW5zcGVudHNbMF0udHhpZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Mi5uZXh0ID0gOTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczIubmV4dFN3YXAuZ2V0QmFsYW5jZSh1dHhvU2NyaXB0VmFsdWVzKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmFsYW5jZSA9IF9jb250ZXh0Mi5zZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNFbm91Z2hNb25leSA9IG5ldyBCaWdOdW1iZXIoYmFsYW5jZSkuaXNHcmVhdGVyVGhhbk9yRXF1YWxUbyhzZWxsQW1vdW50LnRpbWVzKDFlOCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Vub3VnaE1vbmV5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdEJhbGFuY2U6IG5ldyBCaWdOdW1iZXIoYmFsYW5jZSkuZGl2KDFlOCkuZHAoOCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uVHJhbnNhY3Rpb25IYXNoKHR4SUQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuYWJydXB0KCJyZXR1cm4iLCBpc0Vub3VnaE1vbmV5KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxMzoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBfY2FsbGVlMik7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBjaGVja05FWFRTY3JpcHRCYWxhbmNlKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmMy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSgpOwoKICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gOTsKICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLmhlbHBlcnMucmVwZWF0QXN5bmNVbnRpbFJlc3VsdCggLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9yZWY0ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMoc3RvcFJlcGVhdCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpc1N0b3BwZWRTd2FwOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTMkKF9jb250ZXh0MykgewogICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDMucHJldiA9IF9jb250ZXh0My5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNTdG9wcGVkU3dhcCA9IGZsb3cuc3RhdGUuaXNTdG9wcGVkU3dhcDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdG9wcGVkU3dhcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGVja05FWFRTY3JpcHRCYWxhbmNlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuYWJydXB0KCJyZXR1cm4iLCBfY29udGV4dDMuc2VudCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BSZXBlYXQoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUzKTsKICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVmNC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfSgpKTsKCiAgICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICAgICAgaXNTdG9wcGVkU3dhcCA9IGZsb3cuc3RhdGUuaXNTdG9wcGVkU3dhcDsKCiAgICAgICAgICAgICAgICBpZiAoIWlzU3RvcHBlZFN3YXApIHsKICAgICAgICAgICAgICAgICAgZmxvdy5maW5pc2hTdGVwKHsKICAgICAgICAgICAgICAgICAgICBpc05leHRTY3JpcHRGdW5kZWQ6IHRydWUKICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIHN0ZXA6ICdsb2NrLXV0eG8nCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU0KTsKICAgICAgfSkpLAogICAgICAvKiNfX1BVUkVfXyovCiAgICAgIC8vIDUuIFdhaXQgcGFydGljaXBhbnQgY3JlYXRlcyBFVEggQ29udHJhY3QKICAgICAgX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTUoKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNSQoX2NvbnRleHQ1KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NS5wcmV2ID0gX2NvbnRleHQ1Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDUubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gZmxvdy5ldGhTd2FwLndhaXRBQjJVVFhPQ29udHJhY3QoewogICAgICAgICAgICAgICAgICBmbG93OiBmbG93LAogICAgICAgICAgICAgICAgICB1dHhvQ29pbjogIm5leHQiCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ1LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU1KTsKICAgICAgfSkpLAogICAgICAvKiNfX1BVUkVfXyovCiAgICAgIC8vIDYuIFdpdGhkcmF3CiAgICAgIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU2KCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTYkKF9jb250ZXh0NikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDYucHJldiA9IF9jb250ZXh0Ni5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSAyOwogICAgICAgICAgICAgICAgcmV0dXJuIGZsb3cuZXRoU3dhcC53aXRoZHJhd0Zyb21BQjJVVFhPKHsKICAgICAgICAgICAgICAgICAgZmxvdzogZmxvdwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNik7CiAgICAgIH0pKSwgLy8gNy4gRmluaXNoCiAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICBmbG93LnN3YXAucm9vbS5vbmNlKCdzd2FwIGZpbmlzaGVkJywgZnVuY3Rpb24gKF9yZWY3KSB7CiAgICAgICAgICB2YXIgbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCA9IF9yZWY3Lm5leHRTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g7CiAgICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgICAgbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaAogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgZXZlbnQ6ICdyZXF1ZXN0IHN3YXAgZmluaXNoZWQnCiAgICAgICAgfSk7CiAgICAgICAgZmxvdy5maW5pc2hTdGVwKHsKICAgICAgICAgIGlzRmluaXNoZWQ6IHRydWUKICAgICAgICB9LCAnZmluaXNoJyk7CiAgICAgIH0sIC8vIDguIEZpbmlzaGVkIQogICAgICBmdW5jdGlvbiAoKSB7fV07CiAgICB9CiAgfSwgewogICAga2V5OiAic2tpcFN5bmNCYWxhbmNlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfc2tpcFN5bmNCYWxhbmNlID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTcoKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNyQoX2NvbnRleHQ3KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Ny5wcmV2ID0gX2NvbnRleHQ3Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICB0aGlzLmZpbmlzaFN0ZXAoe30sIHsKICAgICAgICAgICAgICAgICAgc3RlcDogJ3N5bmMtYmFsYW5jZScKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDcuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTcsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBza2lwU3luY0JhbGFuY2UoKSB7CiAgICAgICAgcmV0dXJuIF9za2lwU3luY0JhbGFuY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHNraXBTeW5jQmFsYW5jZTsKICAgIH0oKQogIH0sIHsKICAgIGtleTogInRyeVJlZnVuZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdHJ5UmVmdW5kKCkgewogICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgIHZhciBmbG93ID0gdGhpczsKICAgICAgdmFyIF9mbG93JHN0YXRlMyA9IGZsb3cuc3RhdGUsCiAgICAgICAgICB1dHhvU2NyaXB0VmFsdWVzID0gX2Zsb3ckc3RhdGUzLnV0eG9TY3JpcHRWYWx1ZXMsCiAgICAgICAgICBzZWNyZXQgPSBfZmxvdyRzdGF0ZTMuc2VjcmV0OwogICAgICByZXR1cm4gZmxvdy5uZXh0U3dhcC5yZWZ1bmQoewogICAgICAgIHNjcmlwdFZhbHVlczogdXR4b1NjcmlwdFZhbHVlcywKICAgICAgICBzZWNyZXQ6IHNlY3JldAogICAgICB9KS50aGVuKGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgICAgaWYgKCFoYXNoKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBfdGhpczMuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgIGV2ZW50OiAndXR4byByZWZ1bmQgY29tcGxldGVkJwogICAgICAgIH0pOwoKICAgICAgICBmbG93LnNldFN0YXRlKHsKICAgICAgICAgIHJlZnVuZFRyYW5zYWN0aW9uSGFzaDogaGFzaCwKICAgICAgICAgIGlzUmVmdW5kZWQ6IHRydWUsCiAgICAgICAgICBpc1N3YXBFeGlzdDogZmFsc2UKICAgICAgICB9LCB0cnVlKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSlbImNhdGNoIl0oZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgaWYgKC9BZGRyZXNzIGlzIGVtcHR5Ly50ZXN0KGVycm9yKSkgewogICAgICAgICAgLy8gVE9ETyAtIGZldGNoIFRYIGxpc3QgdG8gc2NyaXB0IGZvciByZWZ1bmQgVFgKICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICBpc1JlZnVuZGVkOiB0cnVlLAogICAgICAgICAgICBpc1N3YXBFeGlzdDogZmFsc2UKICAgICAgICAgIH0sIHRydWUpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnNvbGUud2FybignTmV4dCByZWZ1bmQ6JywgZXJyb3IpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiaXNSZWZ1bmRTdWNjZXNzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfaXNSZWZ1bmRTdWNjZXNzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTgoKSB7CiAgICAgICAgdmFyIF90aGlzJHN0YXRlLCByZWZ1bmRUcmFuc2FjdGlvbkhhc2gsIGlzUmVmdW5kZWQ7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTgkKF9jb250ZXh0OCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDgucHJldiA9IF9jb250ZXh0OC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX3RoaXMkc3RhdGUgPSB0aGlzLnN0YXRlLCByZWZ1bmRUcmFuc2FjdGlvbkhhc2ggPSBfdGhpcyRzdGF0ZS5yZWZ1bmRUcmFuc2FjdGlvbkhhc2gsIGlzUmVmdW5kZWQgPSBfdGhpcyRzdGF0ZS5pc1JlZnVuZGVkOwoKICAgICAgICAgICAgICAgIGlmICghKHJlZnVuZFRyYW5zYWN0aW9uSGFzaCAmJiBpc1JlZnVuZGVkKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDgubmV4dCA9IDExOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBfY29udGV4dDgubmV4dCA9IDQ7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5uZXh0U3dhcC5jaGVja1RYKHJlZnVuZFRyYW5zYWN0aW9uSGFzaCk7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIGlmICghX2NvbnRleHQ4LnNlbnQpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ4Lm5leHQgPSA4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ4LmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignTkVYVDJFVEggLSB1bmtub3duIHJlZnVuZCB0cmFuc2FjdGlvbicpOwogICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgIHJlZnVuZFRyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgICAgICAgICAgICAgaXNSZWZ1bmRlZDogZmFsc2UKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OC5hYnJ1cHQoInJldHVybiIsIGZhbHNlKTsKCiAgICAgICAgICAgICAgY2FzZSAxMToKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDguYWJydXB0KCJyZXR1cm4iLCBmYWxzZSk7CgogICAgICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDguc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTgsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBpc1JlZnVuZFN1Y2Nlc3MoKSB7CiAgICAgICAgcmV0dXJuIF9pc1JlZnVuZFN1Y2Nlc3MuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGlzUmVmdW5kU3VjY2VzczsKICAgIH0oKQogIH0sIHsKICAgIGtleTogInRyeVdpdGhkcmF3IiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfdHJ5V2l0aGRyYXcgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlOShfc2VjcmV0KSB7CiAgICAgICAgdmFyIF90aGlzNCA9IHRoaXM7CgogICAgICAgIHZhciBfdGhpcyRzdGF0ZTIsIHNlY3JldCwgc2VjcmV0SGFzaCwgaXNFdGhXaXRoZHJhd24sIF9zZWNyZXRIYXNoLCBmbG93LCBkYXRhOwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU5JChfY29udGV4dDkpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ5LnByZXYgPSBfY29udGV4dDkubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF90aGlzJHN0YXRlMiA9IHRoaXMuc3RhdGUsIHNlY3JldCA9IF90aGlzJHN0YXRlMi5zZWNyZXQsIHNlY3JldEhhc2ggPSBfdGhpcyRzdGF0ZTIuc2VjcmV0SGFzaCwgaXNFdGhXaXRoZHJhd24gPSBfdGhpcyRzdGF0ZTIuaXNFdGhXaXRoZHJhd247CgogICAgICAgICAgICAgICAgaWYgKF9zZWNyZXQpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAzOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldpdGhkcmF3YWwgaXMgYXV0b21hdGljLiBGb3IgbWFudWFsIHdpdGhkcmF3YWwsIHByb3ZpZGUgYSBzZWNyZXQiKTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgaWYgKHNlY3JldCAmJiBzZWNyZXQgIT0gX3NlY3JldCkgY29uc29sZS53YXJuKCJTZWNyZXQgYWxyZWFkeSBrbm93biBhbmQgaXMgZGlmZmVyZW50LiBBcmUgeW91IHN1cmU/Iik7CiAgICAgICAgICAgICAgICBpZiAoaXNFdGhXaXRoZHJhd24pIGNvbnNvbGUud2FybigiTG9va3MgbGlrZSBtb25leSB3ZXJlIGFscmVhZHkgd2l0aGRyYXduLCBhcmUgeW91IHN1cmU/Iik7CiAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgiV0lUSERSQVcgdXNpbmcgc2VjcmV0ID0gIi5jb25jYXQoX3NlY3JldCkpOwogICAgICAgICAgICAgICAgX3NlY3JldEhhc2ggPSB0aGlzLmFwcC5lbnYuYml0Y29pbi5jcnlwdG8ucmlwZW1kMTYwKEJ1ZmZlci5mcm9tKF9zZWNyZXQsICdoZXgnKSkudG9TdHJpbmcoJ2hleCcpOwogICAgICAgICAgICAgICAgaWYgKHNlY3JldEhhc2ggIT0gX3NlY3JldEhhc2gpIGNvbnNvbGUud2FybigiSGFzaCBkb2VzIG5vdCBtYXRjaCEgc3RhdGU6ICIuY29uY2F0KHNlY3JldEhhc2gsICIsIGdpdmVuOiAiKS5jb25jYXQoX3NlY3JldEhhc2gpKTsKICAgICAgICAgICAgICAgIGZsb3cgPSB0aGlzOwogICAgICAgICAgICAgICAgZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgb3duZXJBZGRyZXNzOiB0aGlzLmFwcC5nZXRQYXJ0aWNpcGFudEV0aEFkZHJlc3MoZmxvdy5zd2FwKSwKICAgICAgICAgICAgICAgICAgc2VjcmV0OiBfc2VjcmV0CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgX2NvbnRleHQ5Lm5leHQgPSAxMjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV0aFN3YXAud2l0aGRyYXcoZGF0YSwgZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoIlRYIGhhc2g9Ii5jb25jYXQoaGFzaCkpOwoKICAgICAgICAgICAgICAgICAgX3RoaXM0LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICBldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IGhhc2gsCiAgICAgICAgICAgICAgICAgICAgY2FuQ3JlYXRlRXRoVHJhbnNhY3Rpb246IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgX3RoaXM0LmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICAgIGlzRXRoV2l0aGRyYXduOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0sICd3aXRoZHJhdy1ldGgnKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ5LnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWU5LCB0aGlzKTsKICAgICAgfSkpOwoKICAgICAgZnVuY3Rpb24gdHJ5V2l0aGRyYXcoX3gyKSB7CiAgICAgICAgcmV0dXJuIF90cnlXaXRoZHJhdy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gdHJ5V2l0aGRyYXc7CiAgICB9KCkKICB9XSwgW3sKICAgIGtleTogImdldE5hbWUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldE5hbWUoKSB7CiAgICAgIHJldHVybiAiIi5jb25jYXQodGhpcy5nZXRGcm9tTmFtZSgpLCAiMiIpLmNvbmNhdCh0aGlzLmdldFRvTmFtZSgpKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJnZXRGcm9tTmFtZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0RnJvbU5hbWUoKSB7CiAgICAgIHJldHVybiBjb25zdGFudHMuQ09JTlMubmV4dDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJnZXRUb05hbWUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldFRvTmFtZSgpIHsKICAgICAgcmV0dXJuIGNvbnN0YW50cy5DT0lOUy5ldGg7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gTkVYVDJFVEg7Cn0oQXRvbWljQUIyVVRYTyk7CgpleHBvcnQgZGVmYXVsdCBORVhUMkVUSDs="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.flows/NEXT2ETH.ts"],"names":["debug","constants","util","AtomicAB2UTXO","BigNumber","NEXT2ETH","swap","nextSwap","getRefundHexTransaction","scriptValues","state","utxoScriptValues","secret","then","txHex","setState","refundTxHex","utxoCoin","_flowName","getName","stepNumbers","ethSwap","ownerSwap","participantSwap","abBlockchain","utxoBlockchain","isUTXOSide","Error","step","isStoppedSwap","signTransactionHash","isSignFetching","isParticipantSigned","ethSwapCreationTransactionHash","secretHash","isBalanceFetching","isBalanceEnough","balance","isEthContractFunded","nextSwapWithdrawTransactionHash","ethSwapWithdrawTransactionHash","canCreateEthTransaction","isEthWithdrawn","refundTransactionHash","isRefunded","withdrawFee","isFinished","isSwapExist","requireWithdrawFee","_persistState","flow","signUTXOSide","syncBalance","onTransactionHash","txID","utxoScriptCreatingTransactionHash","room","once","sendMessage","event","data","sellAmount","fundScript","amount","checkNEXTScriptBalance","createScript","scriptAddress","fetchUnspents","unspents","length","txid","getBalance","isEnoughMoney","isGreaterThanOrEqualTo","times","scriptBalance","div","dp","helpers","repeatAsyncUntilResult","stopRepeat","finishStep","isNextScriptFunded","waitAB2UTXOContract","withdrawFromAB2UTXO","refund","hash","error","test","console","warn","checkTX","_secret","_secretHash","app","env","bitcoin","crypto","ripemd160","Buffer","from","toString","ownerAddress","getParticipantEthAddress","withdraw","getFromName","getToName","COINS","next","eth"],"mappings":";;;;;;;;;;;;;;;AAAA,OAAOA,KAAP,MAAkB,OAAlB;AACA,SAAkBC,SAAlB,EAA6BC,IAA7B,QAAyC,UAAzC;AACA,SAASC,aAAT,QAA8B,WAA9B;AACA,SAASC,SAAT,QAA0B,cAA1B;;IAGMC,Q;;;;;AAiBJ,oBAAYC,IAAZ,EAAkB;AAAA;;AAAA;;AAChB,8BAAMA,IAAN;;AADgB;;AAAA;;AAAA;;AAAA;;AAAA,qEAoOD,YAAM;AACrB,YAAKC,QAAL,CAAcC,uBAAd,CAAsC;AACpCC,QAAAA,YAAY,EAAE,MAAKC,KAAL,CAAWC,gBADW;AAEpCC,QAAAA,MAAM,EAAE,MAAKF,KAAL,CAAWE;AAFiB,OAAtC,EAIGC,IAJH,CAIQ,UAACC,KAAD,EAAW;AACf,cAAKC,QAAL,CAAc;AACZC,UAAAA,WAAW,EAAEF;AADD,SAAd;AAGD,OARH;AASD,KA9OiB;;AAEhB,UAAKG,QAAL;AAEA,UAAKC,SAAL,GAAiBb,QAAQ,CAACc,OAAT,EAAjB;AAEA,UAAKC,WAAL,GAAmB;AACjB,cAAQ,CADS;AAEjB,uBAAiB,CAFA;AAGjB,sBAAgB,CAHC;AAIjB,mBAAa,CAJI;AAKjB,uBAAiB,CALA;AAMjB,sBAAgB,CANC;AAOjB,gBAAU,CAPO;AAQjB,aAAO;AARU,KAAnB;AAWA,UAAKC,OAAL,GAAef,IAAI,CAACgB,SAApB;AACA,UAAKf,QAAL,GAAgBD,IAAI,CAACiB,eAArB;AAEA,UAAKC,YAAL,GAAoB,MAAKH,OAAzB;AACA,UAAKI,cAAL,GAAsB,MAAKlB,QAA3B;AACA,UAAKmB,UAAL,GAAkB,IAAlB;;AAEA,QAAI,CAAC,MAAKL,OAAV,EAAmB;AACjB,YAAM,IAAIM,KAAJ,CAAU,6CAAV,CAAN;AACD;;AACD,QAAI,CAAC,MAAKpB,QAAV,EAAoB;AAClB,YAAM,IAAIoB,KAAJ,CAAU,8CAAV,CAAN;AACD;;AAED,UAAKjB,KAAL,GAAa;AACXkB,MAAAA,IAAI,EAAE,CADK;AAGXC,MAAAA,aAAa,EAAE,KAHJ;AAKXC,MAAAA,mBAAmB,EAAE,IALV;AAMXC,MAAAA,cAAc,EAAE,KANL;AAOXC,MAAAA,mBAAmB,EAAE,KAPV;AASXC,MAAAA,8BAA8B,EAAE,IATrB;AAWXC,MAAAA,UAAU,EAAE,IAXD;AAaXC,MAAAA,iBAAiB,EAAE,KAbR;AAcXC,MAAAA,eAAe,EAAE,IAdN;AAeXC,MAAAA,OAAO,EAAE,IAfE;AAiBXC,MAAAA,mBAAmB,EAAE,KAjBV;AAmBXC,MAAAA,+BAA+B,EAAE,IAnBtB;AAoBXC,MAAAA,8BAA8B,EAAE,IApBrB;AAsBXC,MAAAA,uBAAuB,EAAE,IAtBd;AAuBXC,MAAAA,cAAc,EAAE,KAvBL;AAyBXC,MAAAA,qBAAqB,EAAE,IAzBZ;AA0BXC,MAAAA,UAAU,EAAE,KA1BD;AA4BXC,MAAAA,WAAW,EAAE,IA5BF;AA6BX7B,MAAAA,WAAW,EAAE,IA7BF;AA8BX8B,MAAAA,UAAU,EAAE,KA9BD;AA+BXC,MAAAA,WAAW,EAAE,KA/BF;AAiCXC,MAAAA,kBAAkB,EAAE;AAjCT,KAAb;;AAoCA,UAAKC,aAAL;;AACA;;AApEgB;AAqEjB;;;;WAED,yBAAgB;AACd;AACD;;;WAED,qBAAY;AAAA;;AACV,UAAMC,IAAI,GAAG,IAAb;AAEA,aAAO;AAAA;AAEL;AAFK,+DAIL;AAAA;AAAA;AAAA;AAAA;AACE,gBAAA,MAAI,CAACC,YAAL;;AADF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAJK,IAQL;AAEA,kBAAM,CACJ;AACD,OAZI,EAcL;AAEA,kBAAM;AACJ,QAAA,MAAI,CAACC,WAAL;AACD,OAlBI;AAAA;AAoBL;AApBK,+DAsBL;AAAA;;AAAA;AAAA;AAAA;AAAA;AACQC,gBAAAA,iBADR,GAC4B,SAApBA,iBAAoB,CAACC,IAAD,EAAU;AAAA,oCAC8BJ,IAAI,CAACxC,KADnC;AAAA,sBAC1B6C,iCAD0B,eAC1BA,iCAD0B;AAAA,sBACS5C,gBADT,eACSA,gBADT;;AAGlC,sBAAI4C,iCAAJ,EAAuC;AACrC;AACD;;AAEDL,kBAAAA,IAAI,CAACnC,QAAL,CAAc;AACZwC,oBAAAA,iCAAiC,EAAED;AADvB,mBAAd;AAIAJ,kBAAAA,IAAI,CAAC5C,IAAL,CAAUkD,IAAV,CAAeC,IAAf,CAAoB,qBAApB,EAA2C,YAAM;AAC/CP,oBAAAA,IAAI,CAAC5C,IAAL,CAAUkD,IAAV,CAAeE,WAAf,CAA2B;AACzBC,sBAAAA,KAAK,EAAG,oBADiB;AAEzBC,sBAAAA,IAAI,EAAE;AACJnD,wBAAAA,YAAY,EAAEE,gBADV;AAEJ4C,wBAAAA,iCAAiC,EAAED;AAF/B;AAFmB,qBAA3B;AAOD,mBARD;AAUAJ,kBAAAA,IAAI,CAAC5C,IAAL,CAAUkD,IAAV,CAAeE,WAAf,CAA2B;AACzBC,oBAAAA,KAAK,EAAE,oBADkB;AAEzBC,oBAAAA,IAAI,EAAE;AACJnD,sBAAAA,YAAY,EAAGE,gBADX;AAEJ4C,sBAAAA,iCAAiC,EAAGD;AAFhC;AAFmB,mBAA3B;AAOD,iBA7BH;;AA+BUO,gBAAAA,UA/BV,GA+ByBX,IAAI,CAAC5C,IA/B9B,CA+BUuD,UA/BV;AAAA,+BAgCgDX,IAAI,CAACxC,KAhCrD,EAgCU0B,eAhCV,gBAgCUA,eAhCV,EAgC2BzB,gBAhC3B,gBAgC2BA,gBAhC3B;;AAAA,qBAkCMyB,eAlCN;AAAA;AAAA;AAAA;;AAAA;AAAA,uBAmCUc,IAAI,CAAC3C,QAAL,CAAcuD,UAAd,CAAyB;AAC7BrD,kBAAAA,YAAY,EAAEE,gBADe;AAE7BoD,kBAAAA,MAAM,EAAEF;AAFqB,iBAAzB,CAnCV;;AAAA;AAyCQG,gBAAAA,sBAzCR;AAAA,uFAyCiC;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,oDACH,MAAI,CAACzD,QAAL,CAAc0D,YAAd,CAA2BtD,gBAA3B,CADG,EACrBuD,aADqB,yBACrBA,aADqB;AAAA;AAAA,mCAEN,MAAI,CAAC3D,QAAL,CAAc4D,aAAd,CAA4BD,aAA5B,CAFM;;AAAA;AAEvBE,4BAAAA,QAFuB;;AAAA,kCAIzBA,QAAQ,CAACC,MAAT,KAAoB,CAJK;AAAA;AAAA;AAAA;;AAAA,8DAKpB,KALoB;;AAAA;AAQvBf,4BAAAA,IARuB,GAQhBc,QAAQ,CAAC,CAAD,CAAR,CAAYE,IARI;AAAA;AAAA,mCAUP,MAAI,CAAC/D,QAAL,CAAcgE,UAAd,CAAyB5D,gBAAzB,CAVO;;AAAA;AAUvB0B,4BAAAA,OAVuB;AAYvBmC,4BAAAA,aAZuB,GAYP,IAAIpE,SAAJ,CAAciC,OAAd,EAAuBoC,sBAAvB,CAA8CZ,UAAU,CAACa,KAAX,CAAiB,GAAjB,CAA9C,CAZO;;AAc7B,gCAAIF,aAAJ,EAAmB;AACjBtB,8BAAAA,IAAI,CAACnC,QAAL,CAAc;AACZ4D,gCAAAA,aAAa,EAAE,IAAIvE,SAAJ,CAAciC,OAAd,EAAuBuC,GAAvB,CAA2B,GAA3B,EAAgCC,EAAhC,CAAmC,CAAnC;AADH,+BAAd;AAIAxB,8BAAAA,iBAAiB,CAACC,IAAD,CAAjB;AACD;;AApB4B,8DAsBtBkB,aAtBsB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAzCjC;;AAAA,kCAyCQR,sBAzCR;AAAA;AAAA;AAAA;;AAAA;AAAA,uBAkEQ9D,IAAI,CAAC4E,OAAL,CAAaC,sBAAb;AAAA,uFAAoC,kBAAOC,UAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAChCnD,4BAAAA,aADgC,GACdqB,IAAI,CAACxC,KADS,CAChCmB,aADgC;;AAAA,gCAGnCA,aAHmC;AAAA;AAAA;AAAA;;AAAA;AAAA,mCAIzBmC,sBAAsB,EAJG;;AAAA;AAAA;;AAAA;AAMtCgB,4BAAAA,UAAU;;AAN4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAApC;;AAAA;AAAA;AAAA;AAAA,oBAlER;;AAAA;AA4EUnD,gBAAAA,aA5EV,GA4E4BqB,IAAI,CAACxC,KA5EjC,CA4EUmB,aA5EV;;AA8EE,oBAAI,CAACA,aAAL,EAAoB;AAClBqB,kBAAAA,IAAI,CAAC+B,UAAL,CAAgB;AACdC,oBAAAA,kBAAkB,EAAE;AADN,mBAAhB,EAEG;AAAEtD,oBAAAA,IAAI,EAAE;AAAR,mBAFH;AAGD;;AAlFH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAtBK;AAAA;AA2GL;AA3GK,+DA6GL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBACQsB,IAAI,CAAC7B,OAAL,CAAa8D,mBAAb,CAAiC;AACrCjC,kBAAAA,IAAI,EAAJA,IADqC;AAErCjC,kBAAAA,QAAQ;AAF6B,iBAAjC,CADR;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OA7GK;AAAA;AAoHL;AApHK,+DAsHL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBACQiC,IAAI,CAAC7B,OAAL,CAAa+D,mBAAb,CAAiC;AAAElC,kBAAAA,IAAI,EAAJA;AAAF,iBAAjC,CADR;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAtHK,IA0HL;AAEA,kBAAM;AACJA,QAAAA,IAAI,CAAC5C,IAAL,CAAUkD,IAAV,CAAeC,IAAf,CAAoB,eAApB,EAAqC,iBAAuC;AAAA,cAArClB,+BAAqC,SAArCA,+BAAqC;AAC1EW,UAAAA,IAAI,CAACnC,QAAL,CAAc;AACZwB,YAAAA,+BAA+B,EAA/BA;AADY,WAAd;AAGD,SAJD;AAMAW,QAAAA,IAAI,CAAC5C,IAAL,CAAUkD,IAAV,CAAeE,WAAf,CAA2B;AACzBC,UAAAA,KAAK,EAAE;AADkB,SAA3B;AAIAT,QAAAA,IAAI,CAAC+B,UAAL,CAAgB;AACdnC,UAAAA,UAAU,EAAE;AADE,SAAhB,EAEG,QAFH;AAGD,OA1II,EA4IL;AAEA,kBAAM,CAAE,CA9IH,CAAP;AAgJD;;;;sFAED;AAAA;AAAA;AAAA;AAAA;AACE,qBAAKmC,UAAL,CAAgB,EAAhB,EAAoB;AAAErD,kBAAAA,IAAI,EAAE;AAAR,iBAApB;;AADF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;;;WAgBA,qBAAY;AAAA;;AACV,UAAMsB,IAAI,GAAG,IAAb;AADU,yBAE2BA,IAAI,CAACxC,KAFhC;AAAA,UAEFC,gBAFE,gBAEFA,gBAFE;AAAA,UAEgBC,MAFhB,gBAEgBA,MAFhB;AAIV,aAAOsC,IAAI,CAAC3C,QAAL,CAAc8E,MAAd,CAAqB;AAC1B5E,QAAAA,YAAY,EAAEE,gBADY;AAE1BC,QAAAA,MAAM,EAAEA;AAFkB,OAArB,EAIJC,IAJI,CAIC,UAACyE,IAAD,EAAU;AACd,YAAI,CAACA,IAAL,EAAW;AACT,iBAAO,KAAP;AACD;;AAED,QAAA,MAAI,CAAChF,IAAL,CAAUkD,IAAV,CAAeE,WAAf,CAA2B;AACzBC,UAAAA,KAAK,EAAE;AADkB,SAA3B;;AAIAT,QAAAA,IAAI,CAACnC,QAAL,CAAc;AACZ4B,UAAAA,qBAAqB,EAAE2C,IADX;AAEZ1C,UAAAA,UAAU,EAAE,IAFA;AAGZG,UAAAA,WAAW,EAAE;AAHD,SAAd,EAIG,IAJH;AAMA,eAAO,IAAP;AACD,OApBI,WAqBE,UAACwC,KAAD,EAAW;AAChB,YAAI,mBAAmBC,IAAnB,CAAwBD,KAAxB,CAAJ,EAAoC;AAClC;AACArC,UAAAA,IAAI,CAACnC,QAAL,CAAc;AACZ6B,YAAAA,UAAU,EAAE,IADA;AAEZG,YAAAA,WAAW,EAAE;AAFD,WAAd,EAGG,IAHH;AAIA,iBAAO,IAAP;AACD,SAPD,MAOO;AACL0C,UAAAA,OAAO,CAACC,IAAR,CAAa,cAAb,EAA6BH,KAA7B;AAEA,iBAAO,KAAP;AACD;AACF,OAlCI,CAAP;AAmCD;;;;sFAED;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,8BACgD,KAAK7E,KADrD,EACUiC,qBADV,eACUA,qBADV,EACiCC,UADjC,eACiCA,UADjC;;AAAA,sBAEMD,qBAAqB,IAAIC,UAF/B;AAAA;AAAA;AAAA;;AAAA;AAAA,uBAGc,KAAKrC,QAAL,CAAcoF,OAAd,CAAsBhD,qBAAtB,CAHd;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,kDAIa,IAJb;;AAAA;AAMM8C,gBAAAA,OAAO,CAACC,IAAR,CAAa,uCAAb;AACA,qBAAK3E,QAAL,CAAe;AACb4B,kBAAAA,qBAAqB,EAAE,IADV;AAEbC,kBAAAA,UAAU,EAAE;AAFC,iBAAf;AAPN,kDAWa,KAXb;;AAAA;AAAA,kDAcS,KAdT;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;;;;kFAiBA,kBAAkBgD,OAAlB;AAAA;;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,+BACiD,KAAKlF,KADtD,EACUE,MADV,gBACUA,MADV,EACkBsB,UADlB,gBACkBA,UADlB,EAC8BQ,cAD9B,gBAC8BA,cAD9B;;AAAA,oBAGOkD,OAHP;AAAA;AAAA;AAAA;;AAAA,sBAIU,IAAIjE,KAAJ,oEAJV;;AAAA;AAME,oBAAIf,MAAM,IAAIA,MAAM,IAAIgF,OAAxB,EACEH,OAAO,CAACC,IAAR;AAEF,oBAAIhD,cAAJ,EACE+C,OAAO,CAACC,IAAR;AAEF1F,gBAAAA,KAAK,CAAC,gBAAD,CAAL,mCAAmD4F,OAAnD;AAEMC,gBAAAA,WAdR,GAcsB,KAAKC,GAAL,CAASC,GAAT,CAAaC,OAAb,CAAqBC,MAArB,CAA4BC,SAA5B,CAAsCC,MAAM,CAACC,IAAP,CAAYR,OAAZ,EAAqB,KAArB,CAAtC,EAAmES,QAAnE,CAA4E,KAA5E,CAdtB;AAgBE,oBAAInE,UAAU,IAAI2D,WAAlB,EACEJ,OAAO,CAACC,IAAR,uCAA4CxD,UAA5C,sBAAkE2D,WAAlE;AAEI3C,gBAAAA,IAnBR,GAmBe,IAnBf;AAqBQU,gBAAAA,IArBR,GAqBe;AACX0C,kBAAAA,YAAY,EAAE,KAAKR,GAAL,CAASS,wBAAT,CAAkCrD,IAAI,CAAC5C,IAAvC,CADH;AAEXM,kBAAAA,MAAM,EAAEgF;AAFG,iBArBf;AAAA;AAAA,uBA0BQ,KAAKvE,OAAL,CAAamF,QAAb,CAAsB5C,IAAtB,EAA4B,UAAC0B,IAAD,EAAU;AAC1CtF,kBAAAA,KAAK,CAAC,gBAAD,CAAL,mBAAmCsF,IAAnC;;AACA,kBAAA,MAAI,CAACvE,QAAL,CAAc;AACZyB,oBAAAA,8BAA8B,EAAE8C,IADpB;AAEZ7C,oBAAAA,uBAAuB,EAAE;AAFb,mBAAd;AAID,iBANK,EAMH5B,IANG,CAME,YAAM;AAEZ,kBAAA,MAAI,CAACoE,UAAL,CAAgB;AACdvC,oBAAAA,cAAc,EAAE;AADF,mBAAhB,EAEG,cAFH;AAGD,iBAXK,CA1BR;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,O;;;;;;;;;;WApTA,mBAAiB;AACf,uBAAU,KAAK+D,WAAL,EAAV,cAAgC,KAAKC,SAAL,EAAhC;AACD;;;WACD,uBAAqB;AACnB,aAAOzG,SAAS,CAAC0G,KAAV,CAAgBC,IAAvB;AACD;;;WACD,qBAAmB;AACjB,aAAO3G,SAAS,CAAC0G,KAAV,CAAgBE,GAAvB;AACD;;;;EAfoB1G,a;;AAoWvB,eAAeE,QAAf","sourcesContent":["import debug from 'debug'\r\nimport SwapApp, { constants, util } from 'swap.app'\r\nimport { AtomicAB2UTXO } from 'swap.swap'\r\nimport { BigNumber } from 'bignumber.js'\r\n\r\n\r\nclass NEXT2ETH extends AtomicAB2UTXO {\r\n\r\n  _flowName: string\r\n  ethSwap: any\r\n  nextSwap: any\r\n  state: any\r\n\r\n  static getName() {\r\n    return `${this.getFromName()}2${this.getToName()}`\r\n  }\r\n  static getFromName() {\r\n    return constants.COINS.next\r\n  }\r\n  static getToName() {\r\n    return constants.COINS.eth\r\n  }\r\n\r\n  constructor(swap) {\r\n    super(swap)\r\n    this.utxoCoin = `next`\r\n\r\n    this._flowName = NEXT2ETH.getName()\r\n\r\n    this.stepNumbers = {\r\n      'sign': 1,\r\n      'submit-secret': 2,\r\n      'sync-balance': 3,\r\n      'lock-utxo': 4,\r\n      'wait-lock-eth': 5,\r\n      'withdraw-eth': 6,\r\n      'finish': 7,\r\n      'end': 8\r\n    }\r\n\r\n    this.ethSwap = swap.ownerSwap\r\n    this.nextSwap = swap.participantSwap\r\n\r\n    this.abBlockchain = this.ethSwap\r\n    this.utxoBlockchain = this.nextSwap\r\n    this.isUTXOSide = true\r\n\r\n    if (!this.ethSwap) {\r\n      throw new Error('NEXT2ETH: \"ethSwap\" of type object required')\r\n    }\r\n    if (!this.nextSwap) {\r\n      throw new Error('NEXT2ETH: \"nextSwap\" of type object required')\r\n    }\r\n\r\n    this.state = {\r\n      step: 0,\r\n\r\n      isStoppedSwap: false,\r\n\r\n      signTransactionHash: null,\r\n      isSignFetching: false,\r\n      isParticipantSigned: false,\r\n\r\n      ethSwapCreationTransactionHash: null,\r\n\r\n      secretHash: null,\r\n\r\n      isBalanceFetching: false,\r\n      isBalanceEnough: true,\r\n      balance: null,\r\n\r\n      isEthContractFunded: false,\r\n\r\n      nextSwapWithdrawTransactionHash: null,\r\n      ethSwapWithdrawTransactionHash: null,\r\n\r\n      canCreateEthTransaction: true,\r\n      isEthWithdrawn: false,\r\n\r\n      refundTransactionHash: null,\r\n      isRefunded: false,\r\n\r\n      withdrawFee: null,\r\n      refundTxHex: null,\r\n      isFinished: false,\r\n      isSwapExist: false,\r\n\r\n      requireWithdrawFee: false,\r\n    }\r\n\r\n    this._persistState()\r\n    super._persistSteps()\r\n  }\r\n\r\n  _persistState() {\r\n    super._persistState()\r\n  }\r\n\r\n  _getSteps() {\r\n    const flow = this\r\n\r\n    return [\r\n\r\n      // 1. Signs\r\n\r\n      async () => {\r\n        this.signUTXOSide()\r\n      },\r\n\r\n      // 2. Create secret, secret hash and NEXT script\r\n\r\n      () => {\r\n        // this.submitSecret()\r\n      },\r\n\r\n      // 3. Check balance\r\n\r\n      () => {\r\n        this.syncBalance()\r\n      },\r\n\r\n      // 4. Create NEXT Script, fund, notify participant\r\n\r\n      async () => {\r\n        const onTransactionHash = (txID) => {\r\n          const { utxoScriptCreatingTransactionHash, utxoScriptValues } = flow.state\r\n\r\n          if (utxoScriptCreatingTransactionHash) {\r\n            return\r\n          }\r\n\r\n          flow.setState({\r\n            utxoScriptCreatingTransactionHash: txID,\r\n          })\r\n\r\n          flow.swap.room.once('request utxo script', () => {\r\n            flow.swap.room.sendMessage({\r\n              event:  'create utxo script',\r\n              data: {\r\n                scriptValues: utxoScriptValues,\r\n                utxoScriptCreatingTransactionHash: txID,\r\n              }\r\n            })\r\n          })\r\n\r\n          flow.swap.room.sendMessage({\r\n            event: 'create utxo script',\r\n            data: {\r\n              scriptValues : utxoScriptValues,\r\n              utxoScriptCreatingTransactionHash : txID,\r\n            }\r\n          })\r\n        }\r\n\r\n        const { sellAmount } = flow.swap\r\n        const { isBalanceEnough, utxoScriptValues } = flow.state\r\n\r\n        if (isBalanceEnough) {\r\n          await flow.nextSwap.fundScript({\r\n            scriptValues: utxoScriptValues,\r\n            amount: sellAmount,\r\n          })\r\n        }\r\n\r\n        const checkNEXTScriptBalance = async () => {\r\n          const { scriptAddress } = this.nextSwap.createScript(utxoScriptValues)\r\n          const unspents = await this.nextSwap.fetchUnspents(scriptAddress)\r\n\r\n          if (unspents.length === 0) {\r\n            return false\r\n          }\r\n\r\n          const txID = unspents[0].txid\r\n\r\n          const balance = await this.nextSwap.getBalance(utxoScriptValues)\r\n\r\n          const isEnoughMoney = new BigNumber(balance).isGreaterThanOrEqualTo(sellAmount.times(1e8))\r\n\r\n          if (isEnoughMoney) {\r\n            flow.setState({\r\n              scriptBalance: new BigNumber(balance).div(1e8).dp(8),\r\n            })\r\n\r\n            onTransactionHash(txID)\r\n          }\r\n\r\n          return isEnoughMoney\r\n        }\r\n\r\n        await util.helpers.repeatAsyncUntilResult(async (stopRepeat) => {\r\n          const { isStoppedSwap } = flow.state\r\n\r\n          if (!isStoppedSwap) {\r\n            return await checkNEXTScriptBalance()\r\n          } else {\r\n            stopRepeat()\r\n          }\r\n        })\r\n\r\n        const { isStoppedSwap } = flow.state\r\n\r\n        if (!isStoppedSwap) {\r\n          flow.finishStep({\r\n            isNextScriptFunded: true,\r\n          }, { step: 'lock-utxo' })\r\n        }\r\n      },\r\n\r\n      // 5. Wait participant creates ETH Contract\r\n\r\n      async () => {\r\n        await flow.ethSwap.waitAB2UTXOContract({\r\n          flow,\r\n          utxoCoin: `next`,\r\n        })\r\n      },\r\n\r\n      // 6. Withdraw\r\n\r\n      async () => {\r\n        await flow.ethSwap.withdrawFromAB2UTXO({ flow })\r\n      },\r\n\r\n      // 7. Finish\r\n\r\n      () => {\r\n        flow.swap.room.once('swap finished', ({nextSwapWithdrawTransactionHash}) => {\r\n          flow.setState({\r\n            nextSwapWithdrawTransactionHash,\r\n          })\r\n        })\r\n\r\n        flow.swap.room.sendMessage({\r\n          event: 'request swap finished',\r\n        })\r\n\r\n        flow.finishStep({\r\n          isFinished: true,\r\n        }, 'finish')\r\n      },\r\n\r\n      // 8. Finished!\r\n\r\n      () => {}\r\n    ]\r\n  }\r\n\r\n  async skipSyncBalance() {\r\n    this.finishStep({}, { step: 'sync-balance' })\r\n  }\r\n\r\n  getRefundTxHex = () => {\r\n    this.nextSwap.getRefundHexTransaction({\r\n      scriptValues: this.state.utxoScriptValues,\r\n      secret: this.state.secret,\r\n    })\r\n      .then((txHex) => {\r\n        this.setState({\r\n          refundTxHex: txHex,\r\n        })\r\n      })\r\n  }\r\n\r\n  tryRefund() {\r\n    const flow = this\r\n    const { utxoScriptValues, secret } = flow.state\r\n\r\n    return flow.nextSwap.refund({\r\n      scriptValues: utxoScriptValues,\r\n      secret: secret,\r\n    })\r\n      .then((hash) => {\r\n        if (!hash) {\r\n          return false\r\n        }\r\n\r\n        this.swap.room.sendMessage({\r\n          event: 'utxo refund completed',\r\n        })\r\n\r\n        flow.setState({\r\n          refundTransactionHash: hash,\r\n          isRefunded: true,\r\n          isSwapExist: false,\r\n        }, true)\r\n\r\n        return true\r\n      })\r\n      .catch((error) => {\r\n        if (/Address is empty/.test(error)) {\r\n          // TODO - fetch TX list to script for refund TX\r\n          flow.setState({\r\n            isRefunded: true,\r\n            isSwapExist: false,\r\n          }, true)\r\n          return true\r\n        } else {\r\n          console.warn('Next refund:', error)\r\n\r\n          return false\r\n        }\r\n      })\r\n  }\r\n\r\n  async isRefundSuccess() {\r\n    const { refundTransactionHash, isRefunded } = this.state\r\n    if (refundTransactionHash && isRefunded) {\r\n      if (await this.nextSwap.checkTX(refundTransactionHash)) {\r\n        return true\r\n      } else {\r\n        console.warn('NEXT2ETH - unknown refund transaction')\r\n        this.setState( {\r\n          refundTransactionHash: null,\r\n          isRefunded: false,\r\n        } )\r\n        return false\r\n      }\r\n    }\r\n    return false\r\n  }\r\n\r\n  async tryWithdraw(_secret) {\r\n    const { secret, secretHash, isEthWithdrawn } = this.state\r\n\r\n    if (!_secret)\r\n      throw new Error(`Withdrawal is automatic. For manual withdrawal, provide a secret`)\r\n\r\n    if (secret && secret != _secret)\r\n      console.warn(`Secret already known and is different. Are you sure?`)\r\n\r\n    if (isEthWithdrawn)\r\n      console.warn(`Looks like money were already withdrawn, are you sure?`)\r\n\r\n    debug('swap.core:flow')(`WITHDRAW using secret = ${_secret}`)\r\n\r\n    const _secretHash = this.app.env.bitcoin.crypto.ripemd160(Buffer.from(_secret, 'hex')).toString('hex')\r\n\r\n    if (secretHash != _secretHash)\r\n      console.warn(`Hash does not match! state: ${secretHash}, given: ${_secretHash}`)\r\n\r\n    const flow = this\r\n\r\n    const data = {\r\n      ownerAddress: this.app.getParticipantEthAddress(flow.swap),\r\n      secret: _secret,\r\n    }\r\n\r\n    await this.ethSwap.withdraw(data, (hash) => {\r\n      debug('swap.core:flow')(`TX hash=${hash}`)\r\n      this.setState({\r\n        ethSwapWithdrawTransactionHash: hash,\r\n        canCreateEthTransaction: true,\r\n      })\r\n    }).then(() => {\r\n\r\n      this.finishStep({\r\n        isEthWithdrawn: true,\r\n      }, 'withdraw-eth')\r\n    })\r\n  }\r\n}\r\n\r\nexport default NEXT2ETH\r\n"]}]}