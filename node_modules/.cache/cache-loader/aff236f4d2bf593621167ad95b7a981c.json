{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\NEXT2BTC.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\NEXT2BTC.ts","mtime":1614842913759},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXN5bmNUb0dlbmVyYXRvciI7CmltcG9ydCBfY2xhc3NDYWxsQ2hlY2sgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jcmVhdGVDbGFzcyI7CmltcG9ydCBfYXNzZXJ0VGhpc0luaXRpYWxpemVkIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXNzZXJ0VGhpc0luaXRpYWxpemVkIjsKaW1wb3J0IF9pbmhlcml0cyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjsKaW1wb3J0IF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiI7CmltcG9ydCBfZ2V0IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0IjsKaW1wb3J0IF9nZXRQcm90b3R5cGVPZiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldFByb3RvdHlwZU9mIjsKaW1wb3J0IF9kZWZpbmVQcm9wZXJ0eSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2RlZmluZVByb3BlcnR5IjsKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgppbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnOwppbXBvcnQgY3J5cHRvIGZyb20gJ2JpdGNvaW5qcy1saWIvc3JjL2NyeXB0byc7IC8vIG1vdmUgdG8gQnRjU3dhcAoKaW1wb3J0IHsgY29uc3RhbnRzIH0gZnJvbSAnc3dhcC5hcHAnOwppbXBvcnQgeyBGbG93LCBzdGVwc0ZvckNvaW5zIH0gZnJvbSAnc3dhcC5zd2FwJzsKdmFyIGZyb21Db2luID0gY29uc3RhbnRzLkNPSU5fREFUQS5ORVhUOwp2YXIgdG9Db2luID0gY29uc3RhbnRzLkNPSU5fREFUQS5CVEM7Cgp2YXIgTkVYVDJCVEMgPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKF9GbG93KSB7CiAgX2luaGVyaXRzKE5FWFQyQlRDLCBfRmxvdyk7CgogIHZhciBfc3VwZXIgPSBfY3JlYXRlU3VwZXIoTkVYVDJCVEMpOwoKICBmdW5jdGlvbiBORVhUMkJUQyhzd2FwKSB7CiAgICB2YXIgX3RoaXNTdXBlciwgX3RoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIE5FWFQyQlRDKTsKCiAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsIHN3YXApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgIl9mbG93TmFtZSIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAibmV4dFN3YXAiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImJ0Y1N3YXAiLCB2b2lkIDApOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgInN0YXRlIiwgdm9pZCAwKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJnZXRSZWZ1bmRUeEhleCIsIGZ1bmN0aW9uICgpIHsKICAgICAgX3RoaXMubmV4dFN3YXAuZ2V0UmVmdW5kSGV4VHJhbnNhY3Rpb24oewogICAgICAgIHNjcmlwdFZhbHVlczogX3RoaXMuc3RhdGUubmV4dFNjcmlwdFZhbHVlcywKICAgICAgICBzZWNyZXQ6IF90aGlzLnN0YXRlLnNlY3JldAogICAgICB9KS50aGVuKGZ1bmN0aW9uICh0eEhleCkgewogICAgICAgIF90aGlzLnNldFN0YXRlKHsKICAgICAgICAgIHJlZnVuZFR4SGV4OiB0eEhleAogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0pOwoKICAgIF90aGlzLl9mbG93TmFtZSA9IE5FWFQyQlRDLmdldE5hbWUoKTsgLy8gdG9kbzogcmVtb3ZlIGZvciBhbGwgZmxvd3MKCiAgICAvKg0KICAgIHRoaXMuc3RlcE51bWJlcnMgPSB7DQogICAgICAnc2lnbic6IDEsDQogICAgICAnd2FpdC1sb2NrLWJ0Yyc6IDIsDQogICAgICAndmVyaWZ5LXNjcmlwdCc6IDMsDQogICAgICAnc3luYy1iYWxhbmNlJzogNCwNCiAgICAgICdsb2NrLXV0eG8nOiA1LA0KICAgICAgJ3dhaXQtd2l0aGRyYXctbmV4dCc6IDYsIC8vIGFrYSBnZXRTZWNyZXQNCiAgICAgICd3aXRoZHJhdy1idGMnOiA3LA0KICAgICAgJ2ZpbmlzaCc6IDgsDQogICAgICAnZW5kJzogOQ0KICAgIH0NCiAgICAqLwoKICAgIF90aGlzLnN0ZXBOdW1iZXJzID0gc3RlcHNGb3JDb2lucyhmcm9tQ29pbiwgdG9Db2luKTsKICAgIF90aGlzLm5leHRTd2FwID0gc3dhcC5wYXJ0aWNpcGFudFN3YXA7CiAgICBfdGhpcy5idGNTd2FwID0gc3dhcC5vd25lclN3YXA7CgogICAgaWYgKCFfdGhpcy5uZXh0U3dhcCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JUQzJORVhUOiAibmV4dFN3YXAiIG9mIHR5cGUgb2JqZWN0IHJlcXVpcmVkJyk7CiAgICB9CgogICAgaWYgKCFfdGhpcy5idGNTd2FwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQlRDMk5FWFQ6ICJidGNTd2FwIiBvZiB0eXBlIG9iamVjdCByZXF1aXJlZCcpOwogICAgfQoKICAgIF90aGlzLnN0YXRlID0gewogICAgICBzdGVwOiAwLAogICAgICBzaWduVHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICBpc1NpZ25GZXRjaGluZzogZmFsc2UsCiAgICAgIGlzTWVTaWduZWQ6IGZhbHNlLAogICAgICBzZWNyZXRIYXNoOiBudWxsLAogICAgICBidGNTY3JpcHRWYWx1ZXM6IG51bGwsCiAgICAgIG5leHRTY3JpcHRWYWx1ZXM6IG51bGwsCiAgICAgIGJ0Y1NjcmlwdFZlcmlmaWVkOiBmYWxzZSwKICAgICAgaXNCYWxhbmNlRmV0Y2hpbmc6IGZhbHNlLAogICAgICBpc0JhbGFuY2VFbm91Z2g6IGZhbHNlLAogICAgICBiYWxhbmNlOiBudWxsLAogICAgICBidGNTY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgbmV4dFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgaXNOZXh0U2NyaXB0RnVuZGVkOiBmYWxzZSwKICAgICAgc2VjcmV0OiBudWxsLAogICAgICBpc05leHRXaXRoZHJhd246IGZhbHNlLAogICAgICBpc2J0Y1dpdGhkcmF3bjogZmFsc2UsCiAgICAgIHJlZnVuZFRyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgaXNSZWZ1bmRlZDogZmFsc2UsCiAgICAgIGlzRmluaXNoZWQ6IGZhbHNlLAogICAgICBpc1N3YXBFeGlzdDogZmFsc2UKICAgIH07CgogICAgX3RoaXMuX3BlcnNpc3RTdGF0ZSgpOwoKICAgIF9nZXQoKF90aGlzU3VwZXIgPSBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgX2dldFByb3RvdHlwZU9mKE5FWFQyQlRDLnByb3RvdHlwZSkpLCAiX3BlcnNpc3RTdGVwcyIsIF90aGlzU3VwZXIpLmNhbGwoX3RoaXNTdXBlcik7CgogICAgcmV0dXJuIF90aGlzOwogIH0KCiAgX2NyZWF0ZUNsYXNzKE5FWFQyQlRDLCBbewogICAga2V5OiAiX3BlcnNpc3RTdGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX3BlcnNpc3RTdGF0ZSgpIHsKICAgICAgX2dldChfZ2V0UHJvdG90eXBlT2YoTkVYVDJCVEMucHJvdG90eXBlKSwgIl9wZXJzaXN0U3RhdGUiLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgfQogIH0sIHsKICAgIGtleTogIl9nZXRTdGVwcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gX2dldFN0ZXBzKCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHZhciBmbG93ID0gdGhpczsKICAgICAgcmV0dXJuIFsvLyAxLiBTaWduIHN3YXAgdG8gc3RhcnQKICAgICAgZnVuY3Rpb24gKCkgey8vIHRoaXMuc2lnbigpCiAgICAgIH0sIC8vIDIuIFdhaXQgcGFydGljaXBhbnQgY3JlYXRlLCBmdW5kIEJUQyBTY3JpcHQKICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIGZsb3cuc3dhcC5yb29tLm9uY2UoJ2NyZWF0ZSBidGMgc2NyaXB0JywgZnVuY3Rpb24gKF9yZWYpIHsKICAgICAgICAgIHZhciBzY3JpcHRWYWx1ZXMgPSBfcmVmLnNjcmlwdFZhbHVlcywKICAgICAgICAgICAgICBidGNTY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaCA9IF9yZWYuYnRjU2NyaXB0Q3JlYXRpbmdUcmFuc2FjdGlvbkhhc2g7CiAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgICBzZWNyZXRIYXNoOiBzY3JpcHRWYWx1ZXMuc2VjcmV0SGFzaCwKICAgICAgICAgICAgYnRjU2NyaXB0VmFsdWVzOiBzY3JpcHRWYWx1ZXMsCiAgICAgICAgICAgIGJ0Y1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoOiBidGNTY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaAogICAgICAgICAgfSwgewogICAgICAgICAgICBzdGVwOiAnd2FpdC1sb2NrLWJ0YycsCiAgICAgICAgICAgIHNpbGVudEVycm9yOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICBldmVudDogJ3JlcXVlc3QgYnRjIHNjcmlwdCcKICAgICAgICB9KTsKICAgICAgfSwgLy8gMy4gVmVyaWZ5IEJUQyBTY3JpcHQKICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJ3YWl0aW5nIHZlcmlmeSBidGMgc2NyaXB0Iik7IC8vIHRoaXMudmVyaWZ5QnRjU2NyaXB0KCkKICAgICAgfSwgLy8gNC4gQ2hlY2sgYmFsYW5jZQogICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMyLnN5bmNCYWxhbmNlKCk7CgogICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKF90aGlzMik7CiAgICAgIH0sCiAgICAgIC8qI19fUFVSRV9fKi8KICAgICAgLy8gNS4gQ3JlYXRlIE5leHQgU2NyaXB0CiAgICAgIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUoKSB7CiAgICAgICAgdmFyIF9mbG93JHN3YXAsIHBhcnRpY2lwYW50LCBidXlBbW91bnQsIHNlbGxBbW91bnQsIG5leHRTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2gsIHV0Y05vdywgZ2V0TG9ja1RpbWUsIHNjcmlwdENoZWNrUmVzdWx0LCBzY3JpcHRWYWx1ZXM7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfZmxvdyRzd2FwID0gZmxvdy5zd2FwLCBwYXJ0aWNpcGFudCA9IF9mbG93JHN3YXAucGFydGljaXBhbnQsIGJ1eUFtb3VudCA9IF9mbG93JHN3YXAuYnV5QW1vdW50LCBzZWxsQW1vdW50ID0gX2Zsb3ckc3dhcC5zZWxsQW1vdW50OwoKICAgICAgICAgICAgICAgIC8vIFRPRE8gbW92ZSB0aGlzIHNvbWV3aGVyZSEKICAgICAgICAgICAgICAgIHV0Y05vdyA9IGZ1bmN0aW9uIHV0Y05vdygpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBnZXRMb2NrVGltZSA9IGZ1bmN0aW9uIGdldExvY2tUaW1lKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdXRjTm93KCkgKyAzNjAwICogMTsKICAgICAgICAgICAgICAgIH07IC8vIDEgaG91ciBmcm9tIG5vdwoKCiAgICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gNTsKICAgICAgICAgICAgICAgIHJldHVybiBmbG93LmJ0Y1N3YXAuY2hlY2tTY3JpcHQoZmxvdy5zdGF0ZS5idGNTY3JpcHRWYWx1ZXMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IGJ1eUFtb3VudCwKICAgICAgICAgICAgICAgICAgcmVjaXBpZW50UHVibGljS2V5OiBfdGhpczIuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHMuYnRjLmdldFB1YmxpY0tleSgpLAogICAgICAgICAgICAgICAgICBsb2NrVGltZTogZ2V0TG9ja1RpbWUoKQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgIHNjcmlwdENoZWNrUmVzdWx0ID0gX2NvbnRleHQuc2VudDsKCiAgICAgICAgICAgICAgICBpZiAoIXNjcmlwdENoZWNrUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSAxMDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigiQnRjIHNjcmlwdCBjaGVjayBlcnJvcjoiLCBzY3JpcHRDaGVja1Jlc3VsdCk7CiAgICAgICAgICAgICAgICBmbG93LnN3YXAuZXZlbnRzLmRpc3BhdGNoKCdidGMgc2NyaXB0IGNoZWNrIGVycm9yJywgc2NyaXB0Q2hlY2tSZXN1bHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LmFicnVwdCgicmV0dXJuIik7CgogICAgICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXMgPSB7CiAgICAgICAgICAgICAgICAgIHNlY3JldEhhc2g6IGZsb3cuc3RhdGUuc2VjcmV0SGFzaCwKICAgICAgICAgICAgICAgICAgb3duZXJQdWJsaWNLZXk6IF90aGlzMi5hcHAuc2VydmljZXMuYXV0aC5hY2NvdW50cy5uZXh0LmdldFB1YmxpY0tleSgpLAogICAgICAgICAgICAgICAgICByZWNpcGllbnRQdWJsaWNLZXk6IHBhcnRpY2lwYW50Lm5leHQucHVibGljS2V5LAogICAgICAgICAgICAgICAgICBsb2NrVGltZTogZ2V0TG9ja1RpbWUoKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIF9jb250ZXh0LnByZXYgPSAxMTsKICAgICAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSAxNDsKICAgICAgICAgICAgICAgIHJldHVybiBmbG93Lm5leHRTd2FwLmZ1bmRTY3JpcHQoewogICAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXM6IHNjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgYW1vdW50OiBzZWxsQW1vdW50CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICBuZXh0U3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoID0gaGFzaDsKICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgbmV4dFN3YXBDcmVhdGlvblRyYW5zYWN0aW9uSGFzaDogaGFzaAogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDI3OwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgICAgICBfY29udGV4dC5wcmV2ID0gMTY7CiAgICAgICAgICAgICAgICBfY29udGV4dC50MCA9IF9jb250ZXh0WyJjYXRjaCJdKDExKTsKCiAgICAgICAgICAgICAgICBpZiAoIS9rbm93biB0cmFuc2FjdGlvbi8udGVzdChfY29udGV4dC50MC5tZXNzYWdlKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gMjI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsIGNvbnNvbGUuZXJyb3IoImtub3duIHR4OiAiLmNvbmNhdChfY29udGV4dC50MC5tZXNzYWdlKSkpOwoKICAgICAgICAgICAgICBjYXNlIDIyOgogICAgICAgICAgICAgICAgaWYgKCEvb3V0IG9mIGdhcy8udGVzdChfY29udGV4dC50MC5tZXNzYWdlKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dC5uZXh0ID0gMjY7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5hYnJ1cHQoInJldHVybiIsIGNvbnNvbGUuZXJyb3IoInR4IGZhaWxlZCAod3Jvbmcgc2VjcmV0Pyk6ICIuY29uY2F0KF9jb250ZXh0LnQwLm1lc3NhZ2UpKSk7CgogICAgICAgICAgICAgIGNhc2UgMjY6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuYWJydXB0KCJyZXR1cm4iLCBjb25zb2xlLmVycm9yKF9jb250ZXh0LnQwKSk7CgogICAgICAgICAgICAgIGNhc2UgMjc6CiAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5vbigncmVxdWVzdCBuZXh0IHNjcmlwdCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgIGV2ZW50OiAnY3JlYXRlIG5leHQgc2NyaXB0JywKICAgICAgICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXM6IHNjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgICAgIG5leHRTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2g6IG5leHRTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2gKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgIGV2ZW50OiAnY3JlYXRlIG5leHQgc2NyaXB0JywKICAgICAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlczogc2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgIG5leHRTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2g6IG5leHRTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2gKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICBpc05leHRTY3JpcHRGdW5kZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgIG5leHRTY3JpcHRWYWx1ZXM6IHNjcmlwdFZhbHVlcwogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBzdGVwOiAnbG9jay11dHhvJwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgMzA6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlLCBudWxsLCBbWzExLCAxNl1dKTsKICAgICAgfSkpLCAvLyA2LiBXYWl0IHBhcnRpY2lwYW50IHdpdGhkcmF3CiAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICBmbG93LnN3YXAucm9vbS5vbmNlKCduZXh0V2l0aGRyYXdUeEhhc2gnLCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIF9yZWY0ID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTIoX3JlZjMpIHsKICAgICAgICAgICAgdmFyIG5leHRTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2gsIHNlY3JldDsKICAgICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMiQoX2NvbnRleHQyKSB7CiAgICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyLnByZXYgPSBfY29udGV4dDIubmV4dCkgewogICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCA9IF9yZWYzLm5leHRTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g7CiAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICBuZXh0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBuZXh0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQyLm5leHQgPSA0OwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmbG93Lm5leHRTd2FwLmdldFNlY3JldEZyb21UeGhhc2gobmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCk7CgogICAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgICAgc2VjcmV0ID0gX2NvbnRleHQyLnNlbnQ7CgogICAgICAgICAgICAgICAgICAgIGlmICghZmxvdy5zdGF0ZS5pc05leHRXaXRoZHJhd24gJiYgc2VjcmV0KSB7CiAgICAgICAgICAgICAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICAgICAgICBpc05leHRXaXRoZHJhd246IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHNlY3JldDogc2VjcmV0CiAgICAgICAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZXA6ICd3YWl0LXdpdGhkcmF3LW5leHQnCiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Mi5zdG9wKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBfY2FsbGVlMik7CiAgICAgICAgICB9KSk7CgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChfeCkgewogICAgICAgICAgICByZXR1cm4gX3JlZjQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgfSgpKTsKICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICBldmVudDogJ3JlcXVlc3QgbmV4dFdpdGhkcmF3VHhIYXNoJwogICAgICAgIH0pOwogICAgICB9LAogICAgICAvKiNfX1BVUkVfXyovCiAgICAgIC8vIDcuIFdpdGhkcmF3CiAgICAgIF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUzKCkgewogICAgICAgIHZhciBfZmxvdyRzdGF0ZSwgc2VjcmV0LCBidGNTY3JpcHRWYWx1ZXM7CgogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTMkKF9jb250ZXh0MykgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDMucHJldiA9IF9jb250ZXh0My5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgX2Zsb3ckc3RhdGUgPSBmbG93LnN0YXRlLCBzZWNyZXQgPSBfZmxvdyRzdGF0ZS5zZWNyZXQsIGJ0Y1NjcmlwdFZhbHVlcyA9IF9mbG93JHN0YXRlLmJ0Y1NjcmlwdFZhbHVlczsKCiAgICAgICAgICAgICAgICBpZiAoYnRjU2NyaXB0VmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gNDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignVGhlcmUgaXMgbm8gImJ0Y1NjcmlwdFZhbHVlcyIgaW4gc3RhdGUuIE5vIHdheSB0byBjb250aW51ZSBzd2FwLi4uJyk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLmFicnVwdCgicmV0dXJuIik7CgogICAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gNjsKICAgICAgICAgICAgICAgIHJldHVybiBmbG93LmJ0Y1N3YXAud2l0aGRyYXcoewogICAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXM6IGZsb3cuc3RhdGUuYnRjU2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICBzZWNyZXQ6IHNlY3JldAogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgYnRjU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOiBoYXNoCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgIGZsb3cuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgIGlzYnRjV2l0aGRyYXduOiB0cnVlCiAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgIHN0ZXA6ICd3aXRoZHJhdy1idGMnCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sIF9jYWxsZWUzKTsKICAgICAgfSkpLCAvLyA4LiBGaW5pc2gKICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgIGV2ZW50OiAnc3dhcCBmaW5pc2hlZCcKICAgICAgICB9KTsKICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgaXNGaW5pc2hlZDogdHJ1ZQogICAgICAgIH0sIHsKICAgICAgICAgIHN0ZXA6ICdmaW5pc2gnCiAgICAgICAgfSk7CiAgICAgIH0sIC8vIDkuIEZpbmlzaGVkIQogICAgICBmdW5jdGlvbiAoKSB7fV07CiAgICB9CiAgfSwgewogICAga2V5OiAiX2NoZWNrU3dhcEFscmVhZHlFeGlzdHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9jaGVja1N3YXBBbHJlYWR5RXhpc3RzKCkgewogICAgICB2YXIgcGFydGljaXBhbnQgPSB0aGlzLnN3YXAucGFydGljaXBhbnQ7CiAgICAgIHZhciBzd2FwRGF0YSA9IHsKICAgICAgICBvd25lckFkZHJlc3M6IHRoaXMuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHMubmV4dC5hZGRyZXNzLAogICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogcGFydGljaXBhbnQubmV4dC5hZGRyZXNzCiAgICAgIH07CiAgICAgIHJldHVybiBmYWxzZTsgLy90aGlzLm5leHRTd2FwLmNoZWNrU3dhcEV4aXN0cyhzd2FwRGF0YSkKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzaWduIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfc2lnbiA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU0KCkgewogICAgICAgIHZhciBfdGhpczMgPSB0aGlzOwoKICAgICAgICB2YXIgc3dhcEV4aXN0czsKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU0JChfY29udGV4dDQpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ0LnByZXYgPSBfY29udGV4dDQubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gMjsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9jaGVja1N3YXBBbHJlYWR5RXhpc3RzKCk7CgogICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIHN3YXBFeGlzdHMgPSBfY29udGV4dDQuc2VudDsKCiAgICAgICAgICAgICAgICBpZiAoIXN3YXBFeGlzdHMpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSA4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgIGV2ZW50OiAnc3dhcCBleGlzdHMnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICBpc1N3YXBFeGlzdDogdHJ1ZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDEzOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICBpc1NpZ25GZXRjaGluZzogdHJ1ZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLnN3YXAucm9vbS5vbigncmVxdWVzdCBzaWduJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICBfdGhpczMuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICBldmVudDogJ3N3YXAgc2lnbicKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgZXZlbnQ6ICdzd2FwIHNpZ24nCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgIGlzTWVTaWduZWQ6IHRydWUKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgc3RlcDogJ3NpZ24nLAogICAgICAgICAgICAgICAgICBzaWxlbnRFcnJvcjogdHJ1ZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgIGNhc2UgMTM6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTQsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiBzaWduKCkgewogICAgICAgIHJldHVybiBfc2lnbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gc2lnbjsKICAgIH0oKQogIH0sIHsKICAgIGtleTogInZlcmlmeUJ0Y1NjcmlwdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmVyaWZ5QnRjU2NyaXB0KCkgewogICAgICBpZiAodGhpcy5zdGF0ZS5idGNTY3JpcHRWZXJpZmllZCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuc3RhdGUuYnRjU2NyaXB0VmFsdWVzKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyBzY3JpcHQsIGNhbm5vdCB2ZXJpZnkiKTsKICAgICAgfQoKICAgICAgdGhpcy5maW5pc2hTdGVwKHsKICAgICAgICBidGNTY3JpcHRWZXJpZmllZDogdHJ1ZQogICAgICB9LCB7CiAgICAgICAgc3RlcDogJ3ZlcmlmeS1zY3JpcHQnCiAgICAgIH0pOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzeW5jQmFsYW5jZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3N5bmNCYWxhbmNlID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTUoKSB7CiAgICAgICAgdmFyIHNlbGxBbW91bnQsIGJhbGFuY2UsIGlzRW5vdWdoTW9uZXk7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNSQoX2NvbnRleHQ1KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NS5wcmV2ID0gX2NvbnRleHQ1Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBzZWxsQW1vdW50ID0gdGhpcy5zd2FwLnNlbGxBbW91bnQ7CiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgaXNCYWxhbmNlRmV0Y2hpbmc6IHRydWUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgX2NvbnRleHQ1Lm5leHQgPSA0OwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubmV4dFN3YXAuZmV0Y2hCYWxhbmNlKHRoaXMuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHMubmV4dC5nZXRBZGRyZXNzKCkpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICBiYWxhbmNlID0gX2NvbnRleHQ1LnNlbnQ7CiAgICAgICAgICAgICAgICBpc0Vub3VnaE1vbmV5ID0gc2VsbEFtb3VudC5pc0xlc3NUaGFuT3JFcXVhbFRvKGJhbGFuY2UpOwoKICAgICAgICAgICAgICAgIGlmIChpc0Vub3VnaE1vbmV5KSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogYmFsYW5jZSwKICAgICAgICAgICAgICAgICAgICBpc0JhbGFuY2VGZXRjaGluZzogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgaXNCYWxhbmNlRW5vdWdoOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBzdGVwOiAnc3luYy1iYWxhbmNlJwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgIGJhbGFuY2U6IGJhbGFuY2UsCiAgICAgICAgICAgICAgICAgICAgaXNCYWxhbmNlRmV0Y2hpbmc6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGlzQmFsYW5jZUVub3VnaDogZmFsc2UKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNhc2UgNzoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHN5bmNCYWxhbmNlKCkgewogICAgICAgIHJldHVybiBfc3luY0JhbGFuY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHN5bmNCYWxhbmNlOwogICAgfSgpCiAgfSwgewogICAga2V5OiAidHJ5UmVmdW5kIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB0cnlSZWZ1bmQoKSB7CiAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgcmV0dXJuIHRoaXMubmV4dFN3YXAucmVmdW5kKHsKICAgICAgICBzY3JpcHRWYWx1ZXM6IHRoaXMuc3RhdGUubmV4dFNjcmlwdFZhbHVlcywKICAgICAgICBzZWNyZXQ6IHRoaXMuc3RhdGUuc2VjcmV0CiAgICAgIH0sIGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgICAgX3RoaXM0LnNldFN0YXRlKHsKICAgICAgICAgIHJlZnVuZFRyYW5zYWN0aW9uSGFzaDogaGFzaCwKICAgICAgICAgIGlzUmVmdW5kZWQ6IHRydWUKICAgICAgICB9KTsKICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXM0LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICBldmVudDogJ3JlZnVuZCBjb21wbGV0ZWQnCiAgICAgICAgfSk7CgogICAgICAgIF90aGlzNC5zZXRTdGF0ZSh7CiAgICAgICAgICBpc1N3YXBFeGlzdDogZmFsc2UKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiaXNSZWZ1bmRTdWNjZXNzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfaXNSZWZ1bmRTdWNjZXNzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTYoKSB7CiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNiQoX2NvbnRleHQ2KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Ni5wcmV2ID0gX2NvbnRleHQ2Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ2LmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNik7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGlzUmVmdW5kU3VjY2VzcygpIHsKICAgICAgICByZXR1cm4gX2lzUmVmdW5kU3VjY2Vzcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gaXNSZWZ1bmRTdWNjZXNzOwogICAgfSgpCiAgfSwgewogICAga2V5OiAidHJ5V2l0aGRyYXciLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF90cnlXaXRoZHJhdyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU3KF9zZWNyZXQpIHsKICAgICAgICB2YXIgX3RoaXM1ID0gdGhpczsKCiAgICAgICAgdmFyIF90aGlzJHN0YXRlLCBzZWNyZXQsIHNlY3JldEhhc2gsIGlzTmV4dFdpdGhkcmF3biwgaXNidGNXaXRoZHJhd24sIGJ0Y1NjcmlwdFZhbHVlcywgX3NlY3JldEhhc2gsIF90aGlzJGJ0Y1N3YXAkY3JlYXRlUywgc2NyaXB0QWRkcmVzcywgYmFsYW5jZTsKCiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNyQoX2NvbnRleHQ3KSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Ny5wcmV2ID0gX2NvbnRleHQ3Lm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfdGhpcyRzdGF0ZSA9IHRoaXMuc3RhdGUsIHNlY3JldCA9IF90aGlzJHN0YXRlLnNlY3JldCwgc2VjcmV0SGFzaCA9IF90aGlzJHN0YXRlLnNlY3JldEhhc2gsIGlzTmV4dFdpdGhkcmF3biA9IF90aGlzJHN0YXRlLmlzTmV4dFdpdGhkcmF3biwgaXNidGNXaXRoZHJhd24gPSBfdGhpcyRzdGF0ZS5pc2J0Y1dpdGhkcmF3biwgYnRjU2NyaXB0VmFsdWVzID0gX3RoaXMkc3RhdGUuYnRjU2NyaXB0VmFsdWVzOwoKICAgICAgICAgICAgICAgIGlmIChfc2VjcmV0KSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ny5uZXh0ID0gMzsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaXRoZHJhd2FsIGlzIGF1dG9tYXRpYy4gRm9yIG1hbnVhbCB3aXRoZHJhd2FsLCBwcm92aWRlIGEgc2VjcmV0Iik7CgogICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIGlmIChidGNTY3JpcHRWYWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ3Lm5leHQgPSA1OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCB3aXRoZHJhdyB3aXRob3V0IHNjcmlwdCB2YWx1ZXMiKTsKCiAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgaWYgKHNlY3JldCAmJiBzZWNyZXQgIT0gX3NlY3JldCkgY29uc29sZS53YXJuKCJTZWNyZXQgYWxyZWFkeSBrbm93biBhbmQgaXMgZGlmZmVyZW50LiBBcmUgeW91IHN1cmU/Iik7CiAgICAgICAgICAgICAgICBpZiAoaXNidGNXaXRoZHJhd24pIGNvbnNvbGUud2FybigiTG9va3MgbGlrZSBtb25leSB3ZXJlIGFscmVhZHkgd2l0aGRyYXduLCBhcmUgeW91IHN1cmU/Iik7CiAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgiV0lUSERSQVcgdXNpbmcgc2VjcmV0ID0gIi5jb25jYXQoX3NlY3JldCkpOwogICAgICAgICAgICAgICAgX3NlY3JldEhhc2ggPSBjcnlwdG8ucmlwZW1kMTYwKEJ1ZmZlci5mcm9tKF9zZWNyZXQsICdoZXgnKSkudG9TdHJpbmcoJ2hleCcpOwogICAgICAgICAgICAgICAgaWYgKHNlY3JldEhhc2ggIT0gX3NlY3JldEhhc2gpIGNvbnNvbGUud2FybigiSGFzaCBkb2VzIG5vdCBtYXRjaCEiKTsKICAgICAgICAgICAgICAgIF90aGlzJGJ0Y1N3YXAkY3JlYXRlUyA9IHRoaXMuYnRjU3dhcC5jcmVhdGVTY3JpcHQoYnRjU2NyaXB0VmFsdWVzKSwgc2NyaXB0QWRkcmVzcyA9IF90aGlzJGJ0Y1N3YXAkY3JlYXRlUy5zY3JpcHRBZGRyZXNzOwogICAgICAgICAgICAgICAgX2NvbnRleHQ3Lm5leHQgPSAxMzsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmJ0Y1N3YXAuZ2V0QmFsYW5jZShzY3JpcHRBZGRyZXNzKTsKCiAgICAgICAgICAgICAgY2FzZSAxMzoKICAgICAgICAgICAgICAgIGJhbGFuY2UgPSBfY29udGV4dDcuc2VudDsKICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJhZGRyZXNzPSIuY29uY2F0KHNjcmlwdEFkZHJlc3MsICIsIGJhbGFuY2U9IikuY29uY2F0KGJhbGFuY2UpKTsKCiAgICAgICAgICAgICAgICBpZiAoIShiYWxhbmNlID09PSAwKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDcubmV4dCA9IDE4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICBpc2J0Y1dpdGhkcmF3bjogdHJ1ZQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBzdGVwOiAnd2l0aGRyYXctYnRjJwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFscmVhZHkgd2l0aGRyYXduOiBhZGRyZXNzPSIuY29uY2F0KHNjcmlwdEFkZHJlc3MsICIsYmFsYW5jZT0iKS5jb25jYXQoYmFsYW5jZSkpOwoKICAgICAgICAgICAgICBjYXNlIDE4OgogICAgICAgICAgICAgICAgX2NvbnRleHQ3Lm5leHQgPSAyMDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmJ0Y1N3YXAud2l0aGRyYXcoewogICAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXM6IGJ0Y1NjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgc2VjcmV0OiBfc2VjcmV0CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgiVFggaGFzaD0iLmNvbmNhdChoYXNoKSk7CgogICAgICAgICAgICAgICAgICBfdGhpczUuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgIGJ0Y1N3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogaGFzaAogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBjYXNlIDIwOgogICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoIlRYIHdpdGhkcmF3IHNlbnQ6ICIuY29uY2F0KHRoaXMuc3RhdGUuYnRjU3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoKSk7CiAgICAgICAgICAgICAgICB0aGlzLmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICBpc2J0Y1dpdGhkcmF3bjogdHJ1ZQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBzdGVwOiAnd2l0aGRyYXctYnRjJwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgMjI6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDcuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTcsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiB0cnlXaXRoZHJhdyhfeDIpIHsKICAgICAgICByZXR1cm4gX3RyeVdpdGhkcmF3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnlXaXRoZHJhdzsKICAgIH0oKQogIH1dLCBbewogICAga2V5OiAiZ2V0TmFtZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0TmFtZSgpIHsKICAgICAgcmV0dXJuICIiLmNvbmNhdCh0aGlzLmdldEZyb21OYW1lKCksICIyIikuY29uY2F0KHRoaXMuZ2V0VG9OYW1lKCkpOwogICAgfQogIH0sIHsKICAgIGtleTogImdldEZyb21OYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRGcm9tTmFtZSgpIHsKICAgICAgcmV0dXJuIGZyb21Db2luLnRpY2tlcjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJnZXRUb05hbWUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdldFRvTmFtZSgpIHsKICAgICAgcmV0dXJuIHRvQ29pbi50aWNrZXI7CiAgICB9CiAgfV0pOwoKICByZXR1cm4gTkVYVDJCVEM7Cn0oRmxvdyk7CgpleHBvcnQgZGVmYXVsdCBORVhUMkJUQzs="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.flows/NEXT2BTC.ts"],"names":["debug","crypto","constants","Flow","stepsForCoins","fromCoin","COIN_DATA","NEXT","toCoin","BTC","NEXT2BTC","swap","nextSwap","getRefundHexTransaction","scriptValues","state","nextScriptValues","secret","then","txHex","setState","refundTxHex","_flowName","getName","stepNumbers","participantSwap","btcSwap","ownerSwap","Error","step","signTransactionHash","isSignFetching","isMeSigned","secretHash","btcScriptValues","btcScriptVerified","isBalanceFetching","isBalanceEnough","balance","btcScriptCreatingTransactionHash","nextSwapCreationTransactionHash","isNextScriptFunded","isNextWithdrawn","isbtcWithdrawn","refundTransactionHash","isRefunded","isFinished","isSwapExist","_persistState","flow","room","once","finishStep","silentError","sendMessage","event","syncBalance","participant","buyAmount","sellAmount","utcNow","Math","floor","Date","now","getLockTime","checkScript","value","recipientPublicKey","app","services","auth","accounts","btc","getPublicKey","lockTime","scriptCheckResult","console","error","events","dispatch","ownerPublicKey","next","publicKey","fundScript","amount","hash","test","message","on","data","nextSwapWithdrawTransactionHash","getSecretFromTxhash","withdraw","btcSwapWithdrawTransactionHash","swapData","ownerAddress","address","participantAddress","_checkSwapAlreadyExists","swapExists","fetchBalance","getAddress","isEnoughMoney","isLessThanOrEqualTo","refund","_secret","warn","_secretHash","ripemd160","Buffer","from","toString","createScript","scriptAddress","getBalance","getFromName","getToName","ticker"],"mappings":"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","sourcesContent":["import debug from 'debug'\r\nimport crypto from 'bitcoinjs-lib/src/crypto' // move to BtcSwap\r\nimport SwapApp, { constants } from 'swap.app'\r\nimport COIN_DATA from 'swap.app/constants'\r\nimport { Flow, stepsForCoins } from 'swap.swap'\r\n\r\nconst fromCoin = constants.COIN_DATA.NEXT\r\nconst toCoin = constants.COIN_DATA.BTC\r\n\r\nclass NEXT2BTC extends Flow {\r\n\r\n  _flowName: string\r\n  nextSwap: any\r\n  btcSwap: any\r\n  state: any\r\n\r\n  static getName() {\r\n    return `${this.getFromName()}2${this.getToName()}`\r\n  }\r\n  static getFromName() {\r\n    return fromCoin.ticker\r\n  }\r\n  static getToName() {\r\n    return toCoin.ticker\r\n  }\r\n  constructor(swap) {\r\n    super(swap)\r\n\r\n    this._flowName = NEXT2BTC.getName()\r\n\r\n    // todo: remove for all flows\r\n    /*\r\n    this.stepNumbers = {\r\n      'sign': 1,\r\n      'wait-lock-btc': 2,\r\n      'verify-script': 3,\r\n      'sync-balance': 4,\r\n      'lock-utxo': 5,\r\n      'wait-withdraw-next': 6, // aka getSecret\r\n      'withdraw-btc': 7,\r\n      'finish': 8,\r\n      'end': 9\r\n    }\r\n    */\r\n    this.stepNumbers = stepsForCoins(fromCoin, toCoin)\r\n\r\n    this.nextSwap = swap.participantSwap\r\n    this.btcSwap = swap.ownerSwap\r\n\r\n    if (!this.nextSwap) {\r\n      throw new Error('BTC2NEXT: \"nextSwap\" of type object required')\r\n    }\r\n    if (!this.btcSwap) {\r\n      throw new Error('BTC2NEXT: \"btcSwap\" of type object required')\r\n    }\r\n\r\n    this.state = {\r\n      step: 0,\r\n\r\n      signTransactionHash: null,\r\n      isSignFetching: false,\r\n      isMeSigned: false,\r\n\r\n      secretHash: null,\r\n      btcScriptValues: null,\r\n      nextScriptValues: null,\r\n\r\n      btcScriptVerified: false,\r\n\r\n      isBalanceFetching: false,\r\n      isBalanceEnough: false,\r\n      balance: null,\r\n\r\n      btcScriptCreatingTransactionHash: null,\r\n      nextSwapCreationTransactionHash: null,\r\n\r\n      isNextScriptFunded: false,\r\n\r\n      secret: null,\r\n\r\n      isNextWithdrawn: false,\r\n      isbtcWithdrawn: false,\r\n\r\n      refundTransactionHash: null,\r\n      isRefunded: false,\r\n\r\n      isFinished: false,\r\n      isSwapExist: false,\r\n    }\r\n\r\n    this._persistState()\r\n    super._persistSteps()\r\n  }\r\n\r\n  _persistState() {\r\n    super._persistState()\r\n  }\r\n\r\n  _getSteps() {\r\n    const flow = this\r\n\r\n    return [\r\n\r\n      // 1. Sign swap to start\r\n\r\n      () => {\r\n        // this.sign()\r\n      },\r\n\r\n      // 2. Wait participant create, fund BTC Script\r\n\r\n      () => {\r\n        flow.swap.room.once('create btc script', ({ scriptValues, btcScriptCreatingTransactionHash }) => {\r\n          flow.finishStep({\r\n            secretHash: scriptValues.secretHash,\r\n            btcScriptValues: scriptValues,\r\n            btcScriptCreatingTransactionHash,\r\n          }, { step: 'wait-lock-btc', silentError: true })\r\n        })\r\n\r\n        flow.swap.room.sendMessage({\r\n          event: 'request btc script',\r\n        })\r\n      },\r\n\r\n      // 3. Verify BTC Script\r\n\r\n      () => {\r\n        debug('swap.core:flow')(`waiting verify btc script`)\r\n        // this.verifyBtcScript()\r\n      },\r\n\r\n      // 4. Check balance\r\n\r\n      () => {\r\n        this.syncBalance()\r\n        debug('swap.core:flow')(this)\r\n      },\r\n\r\n      // 5. Create Next Script\r\n\r\n      async () => {\r\n        const { participant, buyAmount, sellAmount } = flow.swap\r\n        let nextSwapCreationTransactionHash\r\n\r\n        // TODO move this somewhere!\r\n        const utcNow = () => Math.floor(Date.now() / 1000)\r\n        const getLockTime = () => utcNow() + 3600 * 1 // 1 hour from now\r\n\r\n        const scriptCheckResult = await flow.btcSwap.checkScript(flow.state.btcScriptValues, {\r\n          value: buyAmount,\r\n          recipientPublicKey: this.app.services.auth.accounts.btc.getPublicKey(),\r\n          lockTime: getLockTime(),\r\n        })\r\n\r\n        if (scriptCheckResult) {\r\n          console.error(`Btc script check error:`, scriptCheckResult)\r\n          flow.swap.events.dispatch('btc script check error', scriptCheckResult)\r\n          return\r\n        }\r\n\r\n        const scriptValues = {\r\n          secretHash:         flow.state.secretHash,\r\n          ownerPublicKey:     this.app.services.auth.accounts.next.getPublicKey(),\r\n          recipientPublicKey: participant.next.publicKey,\r\n          lockTime:           getLockTime(),\r\n        }\r\n\r\n        try {\r\n          await flow.nextSwap.fundScript({\r\n            scriptValues,\r\n            amount: sellAmount,\r\n          }, (hash) => {\r\n            nextSwapCreationTransactionHash = hash\r\n            flow.setState({\r\n              nextSwapCreationTransactionHash: hash,\r\n            })\r\n          })\r\n        } catch (err) {\r\n          // TODO user can stuck here after page reload...\r\n          if ( /known transaction/.test(err.message) )\r\n            return console.error(`known tx: ${err.message}`)\r\n          else if ( /out of gas/.test(err.message) )\r\n            return console.error(`tx failed (wrong secret?): ${err.message}`)\r\n          else\r\n            return console.error(err)\r\n        }\r\n\r\n        flow.swap.room.on('request next script', () => {\r\n          flow.swap.room.sendMessage({\r\n            event: 'create next script',\r\n            data: {\r\n              scriptValues,\r\n              nextSwapCreationTransactionHash,\r\n            }\r\n          })\r\n        })\r\n\r\n        flow.swap.room.sendMessage({\r\n          event: 'create next script',\r\n          data: {\r\n            scriptValues,\r\n            nextSwapCreationTransactionHash,\r\n          }\r\n        })\r\n\r\n        flow.finishStep({\r\n          isNextScriptFunded: true,\r\n          nextScriptValues: scriptValues,\r\n        }, { step: 'lock-utxo' })\r\n      },\r\n\r\n      // 6. Wait participant withdraw\r\n\r\n      () => {\r\n\r\n        flow.swap.room.once('nextWithdrawTxHash', async ({ nextSwapWithdrawTransactionHash }) => {\r\n          flow.setState({\r\n            nextSwapWithdrawTransactionHash,\r\n          })\r\n\r\n          const secret = await flow.nextSwap.getSecretFromTxhash(nextSwapWithdrawTransactionHash)\r\n\r\n          if (!flow.state.isNextWithdrawn && secret) {\r\n            flow.finishStep({\r\n              isNextWithdrawn: true,\r\n              secret,\r\n            }, { step: 'wait-withdraw-next' })\r\n          }\r\n        })\r\n\r\n        flow.swap.room.sendMessage({\r\n          event: 'request nextWithdrawTxHash',\r\n        })\r\n      },\r\n\r\n      // 7. Withdraw\r\n\r\n      async () => {\r\n        let { secret, btcScriptValues } = flow.state\r\n\r\n        if (!btcScriptValues) {\r\n          console.error('There is no \"btcScriptValues\" in state. No way to continue swap...')\r\n          return\r\n        }\r\n\r\n        await flow.btcSwap.withdraw({\r\n          scriptValues: flow.state.btcScriptValues,\r\n          secret,\r\n        }, (hash) => {\r\n          flow.setState({\r\n            btcSwapWithdrawTransactionHash: hash,\r\n          })\r\n        })\r\n\r\n        flow.finishStep({\r\n          isbtcWithdrawn: true,\r\n        }, { step: 'withdraw-btc' })\r\n      },\r\n\r\n      // 8. Finish\r\n\r\n      () => {\r\n        flow.swap.room.sendMessage({\r\n          event: 'swap finished',\r\n        })\r\n\r\n        flow.finishStep({\r\n          isFinished: true,\r\n        }, { step: 'finish' })\r\n      },\r\n\r\n      // 9. Finished!\r\n      () => {\r\n\r\n      }\r\n    ]\r\n  }\r\n\r\n  _checkSwapAlreadyExists() {\r\n    const { participant } = this.swap\r\n\r\n    const swapData = {\r\n      ownerAddress:       this.app.services.auth.accounts.next.address,\r\n      participantAddress: participant.next.address\r\n    }\r\n\r\n    return false//this.nextSwap.checkSwapExists(swapData)\r\n  }\r\n\r\n  async sign() {\r\n    const swapExists = await this._checkSwapAlreadyExists()\r\n\r\n    if (swapExists) {\r\n      this.swap.room.sendMessage({\r\n        event: 'swap exists',\r\n      })\r\n\r\n      this.setState({\r\n        isSwapExist: true,\r\n      })\r\n    } else {\r\n      this.setState({\r\n        isSignFetching: true,\r\n      })\r\n\r\n      this.swap.room.on('request sign', () => {\r\n        this.swap.room.sendMessage({\r\n          event: 'swap sign',\r\n        })\r\n      })\r\n\r\n      this.swap.room.sendMessage({\r\n        event: 'swap sign',\r\n      })\r\n\r\n      this.finishStep({\r\n        isMeSigned: true,\r\n      }, { step: 'sign', silentError: true })\r\n\r\n      return true\r\n    }\r\n  }\r\n\r\n\r\n  verifyBtcScript() {\r\n    if (this.state.btcScriptVerified) {\r\n      return true\r\n    }\r\n    if (!this.state.btcScriptValues) {\r\n      throw new Error(`No script, cannot verify`)\r\n    }\r\n\r\n    this.finishStep({\r\n      btcScriptVerified: true,\r\n    }, { step: 'verify-script' })\r\n\r\n    return true\r\n  }\r\n\r\n  async syncBalance() {\r\n    const { sellAmount } = this.swap\r\n\r\n    this.setState({\r\n      isBalanceFetching: true,\r\n    })\r\n\r\n    const balance = await this.nextSwap.fetchBalance(this.app.services.auth.accounts.next.getAddress())\r\n\r\n    const isEnoughMoney = sellAmount.isLessThanOrEqualTo(balance)\r\n\r\n    if (isEnoughMoney) {\r\n      this.finishStep({\r\n        balance,\r\n        isBalanceFetching: false,\r\n        isBalanceEnough: true,\r\n      }, { step: 'sync-balance' })\r\n    } else {\r\n      this.setState({\r\n        balance,\r\n        isBalanceFetching: false,\r\n        isBalanceEnough: false,\r\n      })\r\n    }\r\n  }\r\n\r\n  getRefundTxHex = () => {\r\n    this.nextSwap.getRefundHexTransaction({\r\n      scriptValues: this.state.nextScriptValues,\r\n      secret: this.state.secret,\r\n    })\r\n      .then((txHex) => {\r\n        this.setState({\r\n          refundTxHex: txHex,\r\n        })\r\n      })\r\n  }\r\n\r\n  tryRefund() {\r\n    return this.nextSwap.refund({\r\n      scriptValues: this.state.nextScriptValues,\r\n      secret: this.state.secret,\r\n    }, (hash) => {\r\n      this.setState({\r\n        refundTransactionHash: hash,\r\n        isRefunded: true,\r\n      })\r\n    })\r\n      .then(() => {\r\n        this.swap.room.sendMessage({\r\n          event: 'refund completed',\r\n        })\r\n\r\n        this.setState({\r\n          isSwapExist: false,\r\n        })\r\n      })\r\n  }\r\n\r\n  async isRefundSuccess() {\r\n    return true\r\n  }\r\n\r\n  async tryWithdraw(_secret) {\r\n    const { secret, secretHash, isNextWithdrawn, isbtcWithdrawn, btcScriptValues } = this.state\r\n    if (!_secret)\r\n      throw new Error(`Withdrawal is automatic. For manual withdrawal, provide a secret`)\r\n\r\n    if (!btcScriptValues)\r\n      throw new Error(`Cannot withdraw without script values`)\r\n\r\n    if (secret && secret != _secret)\r\n      console.warn(`Secret already known and is different. Are you sure?`)\r\n\r\n    if (isbtcWithdrawn)\r\n      console.warn(`Looks like money were already withdrawn, are you sure?`)\r\n\r\n    debug('swap.core:flow')(`WITHDRAW using secret = ${_secret}`)\r\n\r\n    const _secretHash = crypto.ripemd160(Buffer.from(_secret, 'hex')).toString('hex')\r\n    if (secretHash != _secretHash)\r\n      console.warn(`Hash does not match!`)\r\n\r\n    const { scriptAddress } = this.btcSwap.createScript(btcScriptValues)\r\n    const balance = await this.btcSwap.getBalance(scriptAddress)\r\n\r\n    debug('swap.core:flow')(`address=${scriptAddress}, balance=${balance}`)\r\n\r\n    if (balance === 0) {\r\n      this.finishStep({\r\n        isbtcWithdrawn: true,\r\n      }, { step: 'withdraw-btc' })\r\n      throw new Error(`Already withdrawn: address=${scriptAddress},balance=${balance}`)\r\n    }\r\n\r\n    await this.btcSwap.withdraw({\r\n      scriptValues: btcScriptValues,\r\n      secret: _secret,\r\n    }, (hash) => {\r\n      debug('swap.core:flow')(`TX hash=${hash}`)\r\n      this.setState({\r\n        btcSwapWithdrawTransactionHash: hash,\r\n      })\r\n    })\r\n    debug('swap.core:flow')(`TX withdraw sent: ${this.state.btcSwapWithdrawTransactionHash}`)\r\n\r\n    this.finishStep({\r\n      isbtcWithdrawn: true,\r\n    }, { step: 'withdraw-btc' })\r\n  }\r\n\r\n}\r\n\r\n\r\nexport default NEXT2BTC\r\n"]}]}