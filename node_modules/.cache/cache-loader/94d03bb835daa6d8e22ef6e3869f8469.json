{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.swap\\AtomicAB2UTXO.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.swap\\AtomicAB2UTXO.ts","mtime":1614842913766},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXN5bmNUb0dlbmVyYXRvciI7CmltcG9ydCBfY2xhc3NDYWxsQ2hlY2sgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jcmVhdGVDbGFzcyI7CmltcG9ydCBfYXNzZXJ0VGhpc0luaXRpYWxpemVkIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXNzZXJ0VGhpc0luaXRpYWxpemVkIjsKaW1wb3J0IF9pbmhlcml0cyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjsKaW1wb3J0IF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiI7CmltcG9ydCBfZ2V0UHJvdG90eXBlT2YgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9nZXRQcm90b3R5cGVPZiI7CmltcG9ydCBfZGVmaW5lUHJvcGVydHkgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9kZWZpbmVQcm9wZXJ0eSI7CmltcG9ydCBfcmVnZW5lcmF0b3JSdW50aW1lIGZyb20gIkBiYWJlbC9ydW50aW1lL3JlZ2VuZXJhdG9yIjsKCmZ1bmN0aW9uIG93bktleXMob2JqZWN0LCBlbnVtZXJhYmxlT25seSkgeyB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iamVjdCk7IGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7IHZhciBzeW1ib2xzID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhvYmplY3QpOyBpZiAoZW51bWVyYWJsZU9ubHkpIHN5bWJvbHMgPSBzeW1ib2xzLmZpbHRlcihmdW5jdGlvbiAoc3ltKSB7IHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgc3ltKS5lbnVtZXJhYmxlOyB9KTsga2V5cy5wdXNoLmFwcGx5KGtleXMsIHN5bWJvbHMpOyB9IHJldHVybiBrZXlzOyB9CgpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkKHRhcmdldCkgeyBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgeyB2YXIgc291cmNlID0gYXJndW1lbnRzW2ldICE9IG51bGwgPyBhcmd1bWVudHNbaV0gOiB7fTsgaWYgKGkgJSAyKSB7IG93bktleXMoT2JqZWN0KHNvdXJjZSksIHRydWUpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgeyBfZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNvdXJjZVtrZXldKTsgfSk7IH0gZWxzZSBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMpIHsgT2JqZWN0LmRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhzb3VyY2UpKTsgfSBlbHNlIHsgb3duS2V5cyhPYmplY3Qoc291cmNlKSkuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGtleSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihzb3VyY2UsIGtleSkpOyB9KTsgfSB9IHJldHVybiB0YXJnZXQ7IH0KCmZ1bmN0aW9uIF9jcmVhdGVTdXBlcihEZXJpdmVkKSB7IHZhciBoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0ID0gX2lzTmF0aXZlUmVmbGVjdENvbnN0cnVjdCgpOyByZXR1cm4gZnVuY3Rpb24gX2NyZWF0ZVN1cGVySW50ZXJuYWwoKSB7IHZhciBTdXBlciA9IF9nZXRQcm90b3R5cGVPZihEZXJpdmVkKSwgcmVzdWx0OyBpZiAoaGFzTmF0aXZlUmVmbGVjdENvbnN0cnVjdCkgeyB2YXIgTmV3VGFyZ2V0ID0gX2dldFByb3RvdHlwZU9mKHRoaXMpLmNvbnN0cnVjdG9yOyByZXN1bHQgPSBSZWZsZWN0LmNvbnN0cnVjdChTdXBlciwgYXJndW1lbnRzLCBOZXdUYXJnZXQpOyB9IGVsc2UgeyByZXN1bHQgPSBTdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9IHJldHVybiBfcG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCByZXN1bHQpOyB9OyB9CgpmdW5jdGlvbiBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCkgeyBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJ1bmRlZmluZWQiIHx8ICFSZWZsZWN0LmNvbnN0cnVjdCkgcmV0dXJuIGZhbHNlOyBpZiAoUmVmbGVjdC5jb25zdHJ1Y3Quc2hhbSkgcmV0dXJuIGZhbHNlOyBpZiAodHlwZW9mIFByb3h5ID09PSAiZnVuY3Rpb24iKSByZXR1cm4gdHJ1ZTsgdHJ5IHsgQm9vbGVhbi5wcm90b3R5cGUudmFsdWVPZi5jYWxsKFJlZmxlY3QuY29uc3RydWN0KEJvb2xlYW4sIFtdLCBmdW5jdGlvbiAoKSB7fSkpOyByZXR1cm4gdHJ1ZTsgfSBjYXRjaCAoZSkgeyByZXR1cm4gZmFsc2U7IH0gfQoKaW1wb3J0IGRlYnVnIGZyb20gJ2RlYnVnJzsKaW1wb3J0IHsgdXRpbCB9IGZyb20gJ3N3YXAuYXBwJzsKaW1wb3J0IEZsb3cgZnJvbSAnLi9GbG93JzsKaW1wb3J0IHsgQmlnTnVtYmVyIH0gZnJvbSAnYmlnbnVtYmVyLmpzJzsKCnZhciBBdG9taWNBQjJVVFhPID0gLyojX19QVVJFX18qL2Z1bmN0aW9uIChfRmxvdykgewogIF9pbmhlcml0cyhBdG9taWNBQjJVVFhPLCBfRmxvdyk7CgogIHZhciBfc3VwZXIgPSBfY3JlYXRlU3VwZXIoQXRvbWljQUIyVVRYTyk7CgogIC8vIEB0by1kbyAtIG1ha2UgaW5tbGVtZW50YXRpb24gZm9yIEFCc3dhcAogIC8vIEB0by1kbyAtIG1ha2UgaW1wbGVtZW50YXRpb24gZm9yIFVUWE9Td2FwCiAgZnVuY3Rpb24gQXRvbWljQUIyVVRYTyhzd2FwKSB7CiAgICB2YXIgX3RoaXM7CgogICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEF0b21pY0FCMlVUWE8pOwoKICAgIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgc3dhcCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAidXR4b0NvaW4iLCBudWxsKTsKCiAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJpc1VUWE9TaWRlIiwgZmFsc2UpOwoKICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImFiQmxvY2tjaGFpbiIsIHZvaWQgMCk7CgogICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAidXR4b0Jsb2NrY2hhaW4iLCB2b2lkIDApOwoKICAgIF90aGlzLnN0YXRlID0gX29iamVjdFNwcmVhZChfb2JqZWN0U3ByZWFkKHt9LCBfdGhpcy5zdGF0ZSksIHsKICAgICAgLyoqIEFCLVVUWE8gKiovCiAgICAgIC8vIFBhcnRpY2FsIChidGMtc2VsbGVyKSBoYXMgdW5jb25maXJtZWQgdHhzIGluIG1lbXBvb2wKICAgICAgcGFydGljaXBhbnRIYXNMb2NrZWRVVFhPOiBmYWxzZSwKICAgICAgcmVxdWlyZVdpdGhkcmF3RmVlOiBmYWxzZSwKICAgICAgcmVxdWlyZVdpdGhkcmF3RmVlU2VuZGVkOiBmYWxzZSwKICAgICAgLy8gU2NyaXB0IGNoYXJnZWQsIGNvbmZpcm1lZCBhbmQgY2hlY2tlZCAtIG5leHQgc3RlcCAtIGNoYXJnZSBBQiBjb250cmFjdAogICAgICBpc1VUWE9TY3JpcHRPazogZmFsc2UsCiAgICAgIHV0eG9TY3JpcHRWYWx1ZXM6IG51bGwsCiAgICAgIHV0eG9TY3JpcHRWZXJpZmllZDogZmFsc2UsCiAgICAgIHV0eG9TY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaDogbnVsbCwKCiAgICAgIC8qKiBVVFhPLUFCICoqLwogICAgICAvLyBXZSBhcmUgaGF2ZSBsb2NrZWQgdHhzIGluIG1lbS1wb29sCiAgICAgIHdhaXRVbmxvY2tVVFhPOiBmYWxzZSwKICAgICAgdXR4b0Z1bmRFcnJvcjogbnVsbCwKICAgICAgd2l0aGRyYXdSZXF1ZXN0QWNjZXB0ZWQ6IGZhbHNlCiAgICB9KTsKICAgIHJldHVybiBfdGhpczsKICB9CgogIF9jcmVhdGVDbGFzcyhBdG9taWNBQjJVVFhPLCBbewogICAga2V5OiAic2lnbkFCU2lkZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2lnbkFCU2lkZSgpIHsKICAgICAgdGhpcy5zd2FwLnByb2Nlc3NNZXRhbWFzaygpOwogICAgfQogIH0sIHsKICAgIGtleTogInNpZ25VVFhPU2lkZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2lnblVUWE9TaWRlKCkgewogICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgIHRoaXMuc3dhcC5wcm9jZXNzTWV0YW1hc2soKTsKICAgICAgdGhpcy5zd2FwLnJvb20ub25jZSgnc3dhcCBzaWduJywgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzdGVwID0gX3RoaXMyLnN0YXRlLnN0ZXA7CgogICAgICAgIGlmIChzdGVwID49IDIpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIF90aGlzMi5zd2FwLnJvb20ub25jZSgnZXRoIHJlZnVuZCBjb21wbGV0ZWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpczIudHJ5UmVmdW5kKCk7CiAgICAgICAgfSk7CgogICAgICAgIF90aGlzMi5maW5pc2hTdGVwKHsKICAgICAgICAgIGlzUGFydGljaXBhbnRTaWduZWQ6IHRydWUKICAgICAgICB9LCB7CiAgICAgICAgICBzdGVwOiAnc2lnbicsCiAgICAgICAgICBzaWxlbnRFcnJvcjogdHJ1ZQogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgdGhpcy5zd2FwLnJvb20ub25jZSgnc3dhcCBleGlzdHMnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgX3RoaXMyLnNldFN0YXRlKHsKICAgICAgICAgIGlzU3dhcEV4aXN0OiB0cnVlCiAgICAgICAgfSk7CgogICAgICAgIF90aGlzMi5zdG9wU3dhcFByb2Nlc3MoKTsKICAgICAgfSk7CiAgICAgIHRoaXMuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICBldmVudDogJ3JlcXVlc3Qgc2lnbicKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAid2FpdFVUWE9TY3JpcHRDcmVhdGVkIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB3YWl0VVRYT1NjcmlwdENyZWF0ZWQoKSB7CiAgICAgIHZhciBmbG93ID0gdGhpczsKICAgICAgdGhpcy5zd2FwLnJvb20ub24oJ2NyZWF0ZSB1dHhvIHNjcmlwdCcsIGZ1bmN0aW9uIChfcmVmKSB7CiAgICAgICAgdmFyIHNjcmlwdFZhbHVlcyA9IF9yZWYuc2NyaXB0VmFsdWVzLAogICAgICAgICAgICB1dHhvU2NyaXB0Q3JlYXRpbmdUcmFuc2FjdGlvbkhhc2ggPSBfcmVmLnV0eG9TY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaDsKICAgICAgICB2YXIgc3RlcCA9IGZsb3cuc3RhdGUuc3RlcDsKCiAgICAgICAgaWYgKHN0ZXAgPj0gMykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZmxvdy5maW5pc2hTdGVwKHsKICAgICAgICAgIHNlY3JldEhhc2g6IHNjcmlwdFZhbHVlcy5zZWNyZXRIYXNoLAogICAgICAgICAgdXR4b1NjcmlwdFZhbHVlczogc2NyaXB0VmFsdWVzLAogICAgICAgICAgdXR4b1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoOiB1dHhvU2NyaXB0Q3JlYXRpbmdUcmFuc2FjdGlvbkhhc2gKICAgICAgICB9LCB7CiAgICAgICAgICBzdGVwOiAnd2FpdC1sb2NrLXV0eG8nLAogICAgICAgICAgc2lsZW50RXJyb3I6IHRydWUKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIHRoaXMuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICBldmVudDogJ3JlcXVlc3QgdXR4byBzY3JpcHQnCiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIndhaXRVVFhPU2NyaXB0RnVuZGVkIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfd2FpdFVUWE9TY3JpcHRGdW5kZWQgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMigpIHsKICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgdmFyIGlzRnVuZGVkLCBmbG93LCBfZmxvdyRzd2FwLCBwYXJ0aWNpcGFudCwgYnV5QW1vdW50LCBzZWxsQW1vdW50LCB3YWl0Q29uZmlybSwgc2VjcmV0SGFzaCwgdXRjTm93LCBpc1VUWE9TY3JpcHRPazsKCiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMiQoX2NvbnRleHQyKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Mi5wcmV2ID0gX2NvbnRleHQyLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBpc0Z1bmRlZCA9IHRoaXMuc3RhdGUuaXNVVFhPU2NyaXB0T2s7CgogICAgICAgICAgICAgICAgaWYgKCFpc0Z1bmRlZCkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDM7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgZmxvdyA9IHRoaXM7CiAgICAgICAgICAgICAgICBfZmxvdyRzd2FwID0gZmxvdy5zd2FwLCBwYXJ0aWNpcGFudCA9IF9mbG93JHN3YXAucGFydGljaXBhbnQsIGJ1eUFtb3VudCA9IF9mbG93JHN3YXAuYnV5QW1vdW50LCBzZWxsQW1vdW50ID0gX2Zsb3ckc3dhcC5zZWxsQW1vdW50LCB3YWl0Q29uZmlybSA9IF9mbG93JHN3YXAud2FpdENvbmZpcm07CiAgICAgICAgICAgICAgICBzZWNyZXRIYXNoID0gdGhpcy5zdGF0ZS5zZWNyZXRIYXNoOwoKICAgICAgICAgICAgICAgIHV0Y05vdyA9IGZ1bmN0aW9uIHV0Y05vdygpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5oZWxwZXJzLnJlcGVhdEFzeW5jVW50aWxSZXN1bHQoIC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfcmVmMiA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUoc3RvcFJlcGVhdCkgewogICAgICAgICAgICAgICAgICAgIHZhciB1dHhvU2NyaXB0VmFsdWVzLCBzY3JpcHRDaGVja0Vycm9yOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1dHhvU2NyaXB0VmFsdWVzID0gZmxvdy5zdGF0ZS51dHhvU2NyaXB0VmFsdWVzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMzWyIiLmNvbmNhdChfdGhpczMudXR4b0NvaW4sICJTd2FwIildLmNoZWNrU2NyaXB0KHV0eG9TY3JpcHRWYWx1ZXMsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGJ1eUFtb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjaXBpZW50UHVibGljS2V5OiBfdGhpczMuYXBwLnNlcnZpY2VzLmF1dGguYWNjb3VudHNbX3RoaXMzLnV0eG9Db2luXS5nZXRQdWJsaWNLZXkoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9ja1RpbWU6IHV0Y05vdygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWRlbmNlOiAwLjgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzV2hpdGVMaXN0OiBfdGhpczMuYXBwLmlzV2hpdGVsaXN0QnRjKHBhcnRpY2lwYW50LmJ0Yy5hZGRyZXNzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQHRvZG8gLSBtYXkgYmUgbmVlZCBtb3JlIHdoaXRlIGxpc3QgY29pbnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2FpdENvbmZpcm06IHdhaXRDb25maXJtCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0Q2hlY2tFcnJvciA9IF9jb250ZXh0LnNlbnQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzY3JpcHRDaGVja0Vycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSA5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoL0V4cGVjdGVkIHNjcmlwdCBsb2NrVGltZS8udGVzdChzY3JpcHRDaGVja0Vycm9yKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCIiLmNvbmNhdChfdGhpczMudXR4b0NvaW4sICIgc2NyaXB0IGNoZWNrIGVycm9yOiAiKS5jb25jYXQoX3RoaXMzLnV0eG9Db2luLCAiIHdhcyByZWZ1bmRlZCIpLCBzY3JpcHRDaGVja0Vycm9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvdy5zdG9wU3dhcFByb2Nlc3MoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcFJlcGVhdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgvRXhwZWN0ZWQgc2NyaXB0IHZhbHVlLy50ZXN0KHNjcmlwdENoZWNrRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiIi5jb25jYXQoX3RoaXMzLnV0eG9Db2luLCAiIHNjcmlwdCBjaGVjazogd2FpdGluZyBiYWxhbmNlIikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgvQ2FuIGJlIHJlcGxhY2UgYnkgZmVlLiBXYWl0IGNvbmZpcm0vLnRlc3Qoc2NyaXB0Q2hlY2tFcnJvcikgfHwgL1dhaXQgY29uZmlybSB0eC8udGVzdChzY3JpcHRDaGVja0Vycm9yKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6ICJ3YWl0ICIuY29uY2F0KF90aGlzMy51dHhvQ29pbiwgIiBjb25maXJtIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YToge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpczMuc3dhcC5ldmVudHMuZGlzcGF0Y2goIiIuY29uY2F0KF90aGlzMy51dHhvQ29pbiwgIiBzY3JpcHQgY2hlY2sgZXJyb3IiKSwgc2NyaXB0Q2hlY2tFcnJvcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LmFicnVwdCgicmV0dXJuIiwgZmFsc2UpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0LnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIF9jYWxsZWUpOwogICAgICAgICAgICAgICAgICB9KSk7CgogICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKF94KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9yZWYyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KCkpOwoKICAgICAgICAgICAgICBjYXNlIDk6CiAgICAgICAgICAgICAgICBpc1VUWE9TY3JpcHRPayA9IF9jb250ZXh0Mi5zZW50OwoKICAgICAgICAgICAgICAgIGlmIChpc1VUWE9TY3JpcHRPaykgewogICAgICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDE0OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLmFicnVwdCgicmV0dXJuIiwgZmFsc2UpOwoKICAgICAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgIGlzVVRYT1NjcmlwdE9rOiBpc1VUWE9TY3JpcHRPawogICAgICAgICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDIuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwgX2NhbGxlZTIsIHRoaXMpOwogICAgICB9KSk7CgogICAgICBmdW5jdGlvbiB3YWl0VVRYT1NjcmlwdEZ1bmRlZCgpIHsKICAgICAgICByZXR1cm4gX3dhaXRVVFhPU2NyaXB0RnVuZGVkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB3YWl0VVRYT1NjcmlwdEZ1bmRlZDsKICAgIH0oKQogIH0sIHsKICAgIGtleTogImdldFNjcmlwdFZhbHVlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0U2NyaXB0VmFsdWVzKCkgewogICAgICByZXR1cm4gdGhpcy5zdGF0ZS51dHhvU2NyaXB0VmFsdWVzOwogICAgfQogIH0sIHsKICAgIGtleTogInZlcmlmeVNjcmlwdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmVyaWZ5U2NyaXB0KCkgewogICAgICB2YXIgX3RoaXMkc3RhdGUgPSB0aGlzLnN0YXRlLAogICAgICAgICAgdXR4b1NjcmlwdFZlcmlmaWVkID0gX3RoaXMkc3RhdGUudXR4b1NjcmlwdFZlcmlmaWVkLAogICAgICAgICAgdXR4b1NjcmlwdFZhbHVlcyA9IF90aGlzJHN0YXRlLnV0eG9TY3JpcHRWYWx1ZXM7CgogICAgICBpZiAodXR4b1NjcmlwdFZlcmlmaWVkKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KCiAgICAgIGlmICghdXR4b1NjcmlwdFZhbHVlcykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiTm8gc2NyaXB0LCBjYW5ub3QgdmVyaWZ5Iik7CiAgICAgIH0KCiAgICAgIHRoaXMuZmluaXNoU3RlcCh7CiAgICAgICAgdXR4b1NjcmlwdFZlcmlmaWVkOiB0cnVlCiAgICAgIH0sIHsKICAgICAgICBzdGVwOiAndmVyaWZ5LXNjcmlwdCcKICAgICAgfSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0sIHsKICAgIGtleTogImdldFNjcmlwdENyZWF0ZVR4IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRTY3JpcHRDcmVhdGVUeCgpIHsKICAgICAgdmFyIHV0eG9TY3JpcHRDcmVhdGluZ1RyYW5zYWN0aW9uSGFzaCA9IHRoaXMuc3RhdGUudXR4b1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoOwogICAgICByZXR1cm4gdXR4b1NjcmlwdENyZWF0aW5nVHJhbnNhY3Rpb25IYXNoOwogICAgfSAvL3RyeVJlZnVuZCgpOiBQcm9taXNlPGFueT4ge30KCiAgfSwgewogICAga2V5OiAiX2NoZWNrU3dhcEFscmVhZHlFeGlzdHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIF9jaGVja1N3YXBBbHJlYWR5RXhpc3RzKCkge30KICB9LCB7CiAgICBrZXk6ICJzaWduIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfc2lnbiA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWUzKCkgewogICAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgICB2YXIgc3dhcEV4aXN0cywgX3RoaXMkc3RhdGUyLCBpc1NpZ25GZXRjaGluZywgaXNNZVNpZ25lZDsKCiAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlMyQoX2NvbnRleHQzKSB7CiAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0My5wcmV2ID0gX2NvbnRleHQzLm5leHQpIHsKICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDI7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fY2hlY2tTd2FwQWxyZWFkeUV4aXN0cygpOwoKICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBzd2FwRXhpc3RzID0gX2NvbnRleHQzLnNlbnQ7CgogICAgICAgICAgICAgICAgaWYgKCFzd2FwRXhpc3RzKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gOTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICBldmVudDogJ3N3YXAgZXhpc3RzJwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgaXNTd2FwRXhpc3Q6IHRydWUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5zdG9wU3dhcFByb2Nlc3MoKTsKICAgICAgICAgICAgICAgIF9jb250ZXh0My5uZXh0ID0gMTg7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICAgICAgX3RoaXMkc3RhdGUyID0gdGhpcy5zdGF0ZSwgaXNTaWduRmV0Y2hpbmcgPSBfdGhpcyRzdGF0ZTIuaXNTaWduRmV0Y2hpbmcsIGlzTWVTaWduZWQgPSBfdGhpcyRzdGF0ZTIuaXNNZVNpZ25lZDsKCiAgICAgICAgICAgICAgICBpZiAoIShpc1NpZ25GZXRjaGluZyB8fCBpc01lU2lnbmVkKSkgewogICAgICAgICAgICAgICAgICBfY29udGV4dDMubmV4dCA9IDEyOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQzLmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgIGNhc2UgMTI6CiAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgaXNTaWduRmV0Y2hpbmc6IHRydWUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5zd2FwLnJvb20ub25jZSgndXR4byByZWZ1bmQgY29tcGxldGVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICBfdGhpczQudHJ5UmVmdW5kKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuc3dhcC5yb29tLm9uKCdyZXF1ZXN0IHNpZ24nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIF90aGlzNC5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICAgIGV2ZW50OiAnc3dhcCBzaWduJwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgICAgICBldmVudDogJ3N3YXAgc2lnbicKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy5maW5pc2hTdGVwKHsKICAgICAgICAgICAgICAgICAgaXNNZVNpZ25lZDogdHJ1ZQogICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICBzdGVwOiAnc2lnbicsCiAgICAgICAgICAgICAgICAgIHNpbGVudEVycm9yOiB0cnVlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgY2FzZSAxODoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0My5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlMywgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHNpZ24oKSB7CiAgICAgICAgcmV0dXJuIF9zaWduLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBzaWduOwogICAgfSgpCiAgfSwgewogICAga2V5OiAiYWNjZXB0V2l0aGRyYXdSZXF1ZXN0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBhY2NlcHRXaXRoZHJhd1JlcXVlc3QoKSB7CiAgICAgIHZhciBfdGhpczUgPSB0aGlzOwoKICAgICAgdmFyIGZsb3cgPSB0aGlzOwogICAgICB2YXIgd2l0aGRyYXdSZXF1ZXN0QWNjZXB0ZWQgPSBmbG93LnN0YXRlLndpdGhkcmF3UmVxdWVzdEFjY2VwdGVkOwoKICAgICAgaWYgKHdpdGhkcmF3UmVxdWVzdEFjY2VwdGVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICB3aXRoZHJhd1JlcXVlc3RBY2NlcHRlZDogdHJ1ZQogICAgICB9KTsKICAgICAgdGhpcy5zd2FwLnJvb20ub25jZSgnZG8gd2l0aGRyYXcnLCAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfcmVmNCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU0KF9yZWYzKSB7CiAgICAgICAgICB2YXIgc2VjcmV0LCBkYXRhOwogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDQucHJldiA9IF9jb250ZXh0NC5uZXh0KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIHNlY3JldCA9IF9yZWYzLnNlY3JldDsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0LnByZXYgPSAxOwogICAgICAgICAgICAgICAgICBkYXRhID0gewogICAgICAgICAgICAgICAgICAgIHBhcnRpY2lwYW50QWRkcmVzczogX3RoaXM1LmFwcC5nZXRQYXJ0aWNpcGFudEV0aEFkZHJlc3MoZmxvdy5zd2FwKSwKICAgICAgICAgICAgICAgICAgICBzZWNyZXQ6IHNlY3JldAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDU7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfdGhpczUuYWJCbG9ja2NoYWluLndpdGhkcmF3Tm9Nb25leShkYXRhLCBmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICAgIGV2ZW50OiAnd2l0aGRyYXcgcmVhZHknLAogICAgICAgICAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgICAgICAgICBldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IGhhc2gKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDEwOwogICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NC5wcmV2ID0gNzsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0LnQwID0gX2NvbnRleHQ0WyJjYXRjaCJdKDEpOwogICAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKShfY29udGV4dDQudDAubWVzc2FnZSk7CgogICAgICAgICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuc3RvcCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwgX2NhbGxlZTQsIG51bGwsIFtbMSwgN11dKTsKICAgICAgICB9KSk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoX3gyKSB7CiAgICAgICAgICByZXR1cm4gX3JlZjQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgICB9KCkpOwogICAgICB0aGlzLnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgZXZlbnQ6ICdhY2NlcHQgd2l0aGRyYXcgcmVxdWVzdCcKICAgICAgfSk7CiAgICB9CiAgICAvKioNCiAgICAgKiBUT0RPIC0gYmFja3BvcnQgdmVyc2lvbiBjb21wYXRpYmlsaXR5DQogICAgICogIG1hcHBlZCB0byBzZW5kV2l0aGRyYXdSZXF1ZXN0VG9Bbm90aGVyUGFydGljaXBhbnQNCiAgICAgKiAgcmVtb3ZlIGF0IG5leHQgaXRlcmF0aW9uIGFmdGVyIGNsaWVudCBzb2Z0d2FyZSB1cGRhdGUNCiAgICAgKiAgVXNlZCBpbiBzd2FwLnJlYWN0DQogICAgICovCgogIH0sIHsKICAgIGtleTogInNlbmRXaXRoZHJhd1JlcXVlc3QiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNlbmRXaXRoZHJhd1JlcXVlc3QoKSB7CiAgICAgIHJldHVybiB0aGlzLnNlbmRXaXRoZHJhd1JlcXVlc3RUb0Fub3RoZXJQYXJ0aWNpcGFudCgpOwogICAgfQogIH0sIHsKICAgIGtleTogInNlbmRXaXRoZHJhd1JlcXVlc3RUb0Fub3RoZXJQYXJ0aWNpcGFudCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2VuZFdpdGhkcmF3UmVxdWVzdFRvQW5vdGhlclBhcnRpY2lwYW50KCkgewogICAgICB2YXIgZmxvdyA9IHRoaXM7CiAgICAgIHZhciBfZmxvdyRzdGF0ZSA9IGZsb3cuc3RhdGUsCiAgICAgICAgICByZXF1aXJlV2l0aGRyYXdGZWUgPSBfZmxvdyRzdGF0ZS5yZXF1aXJlV2l0aGRyYXdGZWUsCiAgICAgICAgICByZXF1aXJlV2l0aGRyYXdGZWVTZW5kZWQgPSBfZmxvdyRzdGF0ZS5yZXF1aXJlV2l0aGRyYXdGZWVTZW5kZWQ7CgogICAgICBpZiAoIXJlcXVpcmVXaXRoZHJhd0ZlZSB8fCByZXF1aXJlV2l0aGRyYXdGZWVTZW5kZWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgIHJlcXVpcmVXaXRoZHJhd0ZlZVNlbmRlZDogdHJ1ZQogICAgICB9KTsKICAgICAgZmxvdy5zd2FwLnJvb20ub24oJ2FjY2VwdCB3aXRoZHJhdyByZXF1ZXN0JywgZnVuY3Rpb24gKCkgewogICAgICAgIGZsb3cuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgIGV2ZW50OiAnZG8gd2l0aGRyYXcnLAogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBzZWNyZXQ6IGZsb3cuc3RhdGUuc2VjcmV0CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgZXZlbnQ6ICdyZXF1ZXN0IHdpdGhkcmF3JwogICAgICB9KTsKICAgIH0gLy8gVGhpcyBmdW5jdGlvbiBjYWxsIEFCIHNpZGUgaW4gY2xhc3NpYyBBQjJVVFhPIHdpdGhvdXQgdGFrZXItbWFrZXIgbW9kZWwKCiAgfSwgewogICAga2V5OiAiY2hlY2tPdGhlclNpZGVSZWZ1bmQiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9jaGVja090aGVyU2lkZVJlZnVuZCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU1KCkgewogICAgICAgIHZhciB1dHhvU2NyaXB0VmFsdWVzLCBfdGhpcyR1dHhvQmxvY2tjaGFpbiQsIHNjcmlwdEFkZHJlc3MsIGRlc3RpbmF0aW9uQWRkcmVzcywgZGVzdEFkZHJlc3MsIGhhc1dpdGhkcmF3OwoKICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU1JChfY29udGV4dDUpIHsKICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQ1LnByZXYgPSBfY29udGV4dDUubmV4dCkgewogICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIGlmICghKHR5cGVvZiB0aGlzLnV0eG9CbG9ja2NoYWluLmNoZWNrV2l0aGRyYXcgPT09ICdmdW5jdGlvbicpKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NS5uZXh0ID0gMTE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHV0eG9TY3JpcHRWYWx1ZXMgPSB0aGlzLnN0YXRlLnV0eG9TY3JpcHRWYWx1ZXM7CgogICAgICAgICAgICAgICAgaWYgKCF1dHhvU2NyaXB0VmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NS5uZXh0ID0gMTE7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIF90aGlzJHV0eG9CbG9ja2NoYWluJCA9IHRoaXMudXR4b0Jsb2NrY2hhaW4uY3JlYXRlU2NyaXB0KHV0eG9TY3JpcHRWYWx1ZXMpLCBzY3JpcHRBZGRyZXNzID0gX3RoaXMkdXR4b0Jsb2NrY2hhaW4kLnNjcmlwdEFkZHJlc3M7CiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbkFkZHJlc3MgPSB0aGlzLnN3YXAuZGVzdGluYXRpb25CdXlBZGRyZXNzOwogICAgICAgICAgICAgICAgZGVzdEFkZHJlc3MgPSBkZXN0aW5hdGlvbkFkZHJlc3MgPyBkZXN0aW5hdGlvbkFkZHJlc3MgOiB0aGlzLmFwcC5zZXJ2aWNlcy5hdXRoLmFjY291bnRzLmJ0Yy5nZXRBZGRyZXNzKCk7CiAgICAgICAgICAgICAgICBfY29udGV4dDUubmV4dCA9IDg7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51dHhvQmxvY2tjaGFpbi5jaGVja1dpdGhkcmF3KHNjcmlwdEFkZHJlc3MpOwoKICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICBoYXNXaXRoZHJhdyA9IF9jb250ZXh0NS5zZW50OwoKICAgICAgICAgICAgICAgIGlmICghKGhhc1dpdGhkcmF3ICYmIGhhc1dpdGhkcmF3LmFkZHJlc3MudG9Mb3dlckNhc2UoKSAhPT0gZGVzdEFkZHJlc3MudG9Mb3dlckNhc2UoKSkpIHsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ1Lm5leHQgPSAxMTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5hYnJ1cHQoInJldHVybiIsIHRydWUpOwoKICAgICAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5hYnJ1cHQoInJldHVybiIsIGZhbHNlKTsKCiAgICAgICAgICAgICAgY2FzZSAxMjoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNSwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIGNoZWNrT3RoZXJTaWRlUmVmdW5kKCkgewogICAgICAgIHJldHVybiBfY2hlY2tPdGhlclNpZGVSZWZ1bmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNoZWNrT3RoZXJTaWRlUmVmdW5kOwogICAgfSgpCiAgfSwgewogICAga2V5OiAic3VibWl0U2VjcmV0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzdWJtaXRTZWNyZXQoc2VjcmV0KSB7CiAgICAgIGlmICh0aGlzLnN0YXRlLnNlY3JldCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLnN0YXRlLmlzUGFydGljaXBhbnRTaWduZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBwcm9jZWVkOiBwYXJ0aWNpcGFudCBub3Qgc2lnbmVkLiBzdGVwPSIuY29uY2F0KHRoaXMuc3RhdGUuc3RlcCkpOwogICAgICB9CgogICAgICB2YXIgc2VjcmV0SGFzaCA9IHRoaXMuYXBwLmVudi5iaXRjb2luLmNyeXB0by5yaXBlbWQxNjAoQnVmZmVyLmZyb20oc2VjcmV0LCAnaGV4JykpLnRvU3RyaW5nKCdoZXgnKTsKICAgICAgLyogU2VjcmV0IGhhc2ggZ2VuZXJhdGVkIC0gY3JlYXRlIEJUQyBzY3JpcHQgLSBhbmQgb25seSBhZnRlciB0aGlzIG5vdGlmeSBvdGhlciBwYXJ0ICovCgogICAgICB0aGlzLmNyZWF0ZVdvcmtVVFhPU2NyaXB0KHNlY3JldEhhc2gpOwoKICAgICAgdmFyIF9zZWNyZXQgPSAiMHgiLmNvbmNhdChzZWNyZXQucmVwbGFjZSgvXjB4LywgJycpKTsKCiAgICAgIHRoaXMuZmluaXNoU3RlcCh7CiAgICAgICAgc2VjcmV0OiBfc2VjcmV0LAogICAgICAgIHNlY3JldEhhc2g6IHNlY3JldEhhc2gKICAgICAgfSwgewogICAgICAgIHN0ZXA6ICdzdWJtaXQtc2VjcmV0JwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjcmVhdGVXb3JrVVRYT1NjcmlwdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY3JlYXRlV29ya1VUWE9TY3JpcHQoc2VjcmV0SGFzaCkgewogICAgICBpZiAodGhpcy5zdGF0ZS51dHhvU2NyaXB0VmFsdWVzKSB7CiAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ0JUQyBTY3JpcHQgYWxyZWFkeSBnZW5lcmF0ZWQnLCB0aGlzLnN0YXRlLnV0eG9TY3JpcHRWYWx1ZXMpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHBhcnRpY2lwYW50ID0gdGhpcy5zd2FwLnBhcnRpY2lwYW50OwoKICAgICAgdmFyIHV0Y05vdyA9IGZ1bmN0aW9uIHV0Y05vdygpIHsKICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMTAwMCk7CiAgICAgIH07CgogICAgICB2YXIgZ2V0TG9ja1RpbWUgPSBmdW5jdGlvbiBnZXRMb2NrVGltZSgpIHsKICAgICAgICByZXR1cm4gdXRjTm93KCkgKyA2MCAqIDYwICogMzsKICAgICAgfTsgLy8gMyBob3VycyBmcm9tIG5vdwoKCiAgICAgIHZhciBzY3JpcHRWYWx1ZXMgPSB7CiAgICAgICAgc2VjcmV0SGFzaDogc2VjcmV0SGFzaCwKICAgICAgICBvd25lclB1YmxpY0tleTogdGhpcy5hcHAuc2VydmljZXMuYXV0aC5hY2NvdW50c1t0aGlzLnV0eG9Db2luXS5nZXRQdWJsaWNLZXkoKSwKICAgICAgICByZWNpcGllbnRQdWJsaWNLZXk6IHBhcnRpY2lwYW50W3RoaXMudXR4b0NvaW5dLnB1YmxpY0tleSwKICAgICAgICBsb2NrVGltZTogZ2V0TG9ja1RpbWUoKQogICAgICB9OwoKICAgICAgdmFyIF90aGlzJHV0eG9CbG9ja2NoYWluJDIgPSB0aGlzLnV0eG9CbG9ja2NoYWluLmNyZWF0ZVNjcmlwdChzY3JpcHRWYWx1ZXMpLAogICAgICAgICAgc2NyaXB0QWRkcmVzcyA9IF90aGlzJHV0eG9CbG9ja2NoYWluJDIuc2NyaXB0QWRkcmVzczsKCiAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgIHNjcmlwdEFkZHJlc3M6IHNjcmlwdEFkZHJlc3MsCiAgICAgICAgdXR4b1NjcmlwdFZhbHVlczogc2NyaXB0VmFsdWVzLAogICAgICAgIHNjcmlwdEJhbGFuY2U6IDAsCiAgICAgICAgc2NyaXB0VW5zcGVuZEJhbGFuY2U6IDAKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAic3luY0JhbGFuY2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9zeW5jQmFsYW5jZSA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU2KCkgewogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTYkKF9jb250ZXh0NikgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDYucHJldiA9IF9jb250ZXh0Ni5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5hYnJ1cHQoInJldHVybiIsIHRoaXMuaXNVVFhPU2lkZSA/IHRoaXMuc3luY0JhbGFuY2VVVFhPKCkgOiB0aGlzLnN5bmNCYWxhbmNlQUIoKSk7CgogICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNiwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHN5bmNCYWxhbmNlKCkgewogICAgICAgIHJldHVybiBfc3luY0JhbGFuY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHN5bmNCYWxhbmNlOwogICAgfSgpCiAgfSwgewogICAga2V5OiAic3luY0JhbGFuY2VBQiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgX3N5bmNCYWxhbmNlQUIgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNygpIHsKICAgICAgICB2YXIgc2VsbEFtb3VudCwgYmFsYW5jZSwgaXNFbm91Z2hNb25leSwgc3RhdGVEYXRhOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTckKF9jb250ZXh0NykgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDcucHJldiA9IF9jb250ZXh0Ny5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgc2VsbEFtb3VudCA9IHRoaXMuc3dhcC5zZWxsQW1vdW50OwogICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgIGlzQmFsYW5jZUZldGNoaW5nOiB0cnVlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIF9jb250ZXh0Ny5uZXh0ID0gNDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFiQmxvY2tjaGFpbi5mZXRjaEJhbGFuY2UodGhpcy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCkpOwoKICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICBiYWxhbmNlID0gX2NvbnRleHQ3LnNlbnQ7CiAgICAgICAgICAgICAgICBpc0Vub3VnaE1vbmV5ID0gc2VsbEFtb3VudC5pc0xlc3NUaGFuT3JFcXVhbFRvKGJhbGFuY2UpOwogICAgICAgICAgICAgICAgc3RhdGVEYXRhID0gewogICAgICAgICAgICAgICAgICBiYWxhbmNlOiBiYWxhbmNlLAogICAgICAgICAgICAgICAgICBpc0JhbGFuY2VGZXRjaGluZzogZmFsc2UsCiAgICAgICAgICAgICAgICAgIGlzQmFsYW5jZUVub3VnaDogaXNFbm91Z2hNb25leQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAoaXNFbm91Z2hNb25leSkgewogICAgICAgICAgICAgICAgICB0aGlzLmZpbmlzaFN0ZXAoc3RhdGVEYXRhLCB7CiAgICAgICAgICAgICAgICAgICAgc3RlcDogJ3N5bmMtYmFsYW5jZScKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLnNldFN0YXRlKHN0YXRlRGF0YSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ny5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlNywgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHN5bmNCYWxhbmNlQUIoKSB7CiAgICAgICAgcmV0dXJuIF9zeW5jQmFsYW5jZUFCLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBzeW5jQmFsYW5jZUFCOwogICAgfSgpCiAgfSwgewogICAga2V5OiAic3luY0JhbGFuY2VVVFhPIiwKICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfc3luY0JhbGFuY2VVVFhPID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTgoKSB7CiAgICAgICAgdmFyIHNlbGxBbW91bnQsIHV0eG9BZGRyZXNzLCB0eEZlZSwgdW5zcGVudHMsIHRvdGFsVW5zcGVudCwgYmFsYW5jZSwgbmVlZEFtb3VudCwgaXNFbm91Z2hNb25leSwgc3RhdGVEYXRhOwogICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTgkKF9jb250ZXh0OCkgewogICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDgucHJldiA9IF9jb250ZXh0OC5uZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgc2VsbEFtb3VudCA9IHRoaXMuc3dhcC5zZWxsQW1vdW50OwogICAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgIGlzQmFsYW5jZUZldGNoaW5nOiB0cnVlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHV0eG9BZGRyZXNzID0gdGhpcy5hcHAuc2VydmljZXMuYXV0aC5hY2NvdW50c1t0aGlzLnV0eG9Db2luXS5nZXRBZGRyZXNzKCk7CiAgICAgICAgICAgICAgICBfY29udGV4dDgubmV4dCA9IDU7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51dHhvQmxvY2tjaGFpbi5lc3RpbWF0ZUZlZVZhbHVlKHsKICAgICAgICAgICAgICAgICAgbWV0aG9kOiAnc3dhcCcsCiAgICAgICAgICAgICAgICAgIGZpeGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICBhZGRyZXNzOiB1dHhvQWRkcmVzcwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgIHR4RmVlID0gX2NvbnRleHQ4LnNlbnQ7CiAgICAgICAgICAgICAgICBfY29udGV4dDgubmV4dCA9IDg7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy51dHhvQmxvY2tjaGFpbi5mZXRjaFVuc3BlbnRzKHV0eG9BZGRyZXNzKTsKCiAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgdW5zcGVudHMgPSBfY29udGV4dDguc2VudDsKICAgICAgICAgICAgICAgIHRvdGFsVW5zcGVudCA9IHVuc3BlbnRzLnJlZHVjZShmdW5jdGlvbiAoc3VtbSwgX3JlZjUpIHsKICAgICAgICAgICAgICAgICAgdmFyIHNhdG9zaGlzID0gX3JlZjUuc2F0b3NoaXM7CiAgICAgICAgICAgICAgICAgIHJldHVybiBzdW1tICsgc2F0b3NoaXM7CiAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgIGJhbGFuY2UgPSBuZXcgQmlnTnVtYmVyKHRvdGFsVW5zcGVudCkuZGl2aWRlZEJ5KDFlOCk7CiAgICAgICAgICAgICAgICBuZWVkQW1vdW50ID0gc2VsbEFtb3VudC5wbHVzKHR4RmVlKTsKICAgICAgICAgICAgICAgIGlzRW5vdWdoTW9uZXkgPSBuZWVkQW1vdW50LmlzTGVzc1RoYW5PckVxdWFsVG8oYmFsYW5jZSk7CiAgICAgICAgICAgICAgICBzdGF0ZURhdGEgPSB7CiAgICAgICAgICAgICAgICAgIGJhbGFuY2U6IGJhbGFuY2UsCiAgICAgICAgICAgICAgICAgIGlzQmFsYW5jZUZldGNoaW5nOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgaXNCYWxhbmNlRW5vdWdoOiBpc0Vub3VnaE1vbmV5CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGlmIChpc0Vub3VnaE1vbmV5KSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuZmluaXNoU3RlcChzdGF0ZURhdGEsIHsKICAgICAgICAgICAgICAgICAgICBzdGVwOiAnc3luYy1iYWxhbmNlJwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoc3RhdGVEYXRhLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2FzZSAxNToKICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0OC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LCBfY2FsbGVlOCwgdGhpcyk7CiAgICAgIH0pKTsKCiAgICAgIGZ1bmN0aW9uIHN5bmNCYWxhbmNlVVRYTygpIHsKICAgICAgICByZXR1cm4gX3N5bmNCYWxhbmNlVVRYTy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gc3luY0JhbGFuY2VVVFhPOwogICAgfSgpIC8vIEB0by1kbyAtIG5vdCB1c2VkIGluIGNvZGUgLSBmcm9udC9ib3QgLSAoYnRjL2dob3N0L25leHQpIC0gbWF5IGJlIG5lZWQgZGVsZXRlZAogICAgLy8gZG90IHdpdGggY29tbWEgaW4gb3JpZ2luYWwgLSBzYXkgLSBpdHMgYXJ0ZWZhY3QuLi4uCgogIH0sIHsKICAgIGtleTogImdldFV0eG9TY3JpcHRBZGRyZXNzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRVdHhvU2NyaXB0QWRkcmVzcygpIHsKICAgICAgdmFyIHNjcmlwdEFkZHJlc3MgPSB0aGlzLnN0YXRlLnNjcmlwdEFkZHJlc3M7CiAgICAgIHJldHVybiBzY3JpcHRBZGRyZXNzOwogICAgfQogIH1dKTsKCiAgcmV0dXJuIEF0b21pY0FCMlVUWE87Cn0oRmxvdyk7CgpleHBvcnQgZGVmYXVsdCBBdG9taWNBQjJVVFhPOw=="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.swap/AtomicAB2UTXO.ts"],"names":["debug","util","Flow","BigNumber","AtomicAB2UTXO","swap","state","participantHasLockedUTXO","requireWithdrawFee","requireWithdrawFeeSended","isUTXOScriptOk","utxoScriptValues","utxoScriptVerified","utxoScriptCreatingTransactionHash","waitUnlockUTXO","utxoFundError","withdrawRequestAccepted","processMetamask","room","once","step","tryRefund","finishStep","isParticipantSigned","silentError","setState","isSwapExist","stopSwapProcess","sendMessage","event","flow","on","scriptValues","secretHash","isFunded","participant","buyAmount","sellAmount","waitConfirm","utcNow","Math","floor","Date","now","helpers","repeatAsyncUntilResult","stopRepeat","utxoCoin","checkScript","value","recipientPublicKey","app","services","auth","accounts","getPublicKey","lockTime","confidence","isWhiteList","isWhitelistBtc","btc","address","scriptCheckError","test","console","error","warn","data","events","dispatch","Error","_checkSwapAlreadyExists","swapExists","isSignFetching","isMeSigned","secret","participantAddress","getParticipantEthAddress","abBlockchain","withdrawNoMoney","hash","ethSwapWithdrawTransactionHash","message","sendWithdrawRequestToAnotherParticipant","utxoBlockchain","checkWithdraw","createScript","scriptAddress","destinationAddress","destinationBuyAddress","destAddress","getAddress","hasWithdraw","toLowerCase","env","bitcoin","crypto","ripemd160","Buffer","from","toString","createWorkUTXOScript","_secret","replace","getLockTime","ownerPublicKey","publicKey","scriptBalance","scriptUnspendBalance","isUTXOSide","syncBalanceUTXO","syncBalanceAB","isBalanceFetching","fetchBalance","getMyEthAddress","balance","isEnoughMoney","isLessThanOrEqualTo","stateData","isBalanceEnough","utxoAddress","estimateFeeValue","method","fixed","txFee","fetchUnspents","unspents","totalUnspent","reduce","summ","satoshis","dividedBy","needAmount","plus"],"mappings":"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","sourcesContent":["import debug from 'debug'\r\nimport SwapApp, { util } from 'swap.app'\r\nimport Flow from './Flow'\r\nimport { BigNumber } from 'bignumber.js'\r\n\r\n\r\nclass AtomicAB2UTXO extends Flow {\r\n\r\n  utxoCoin: string = null\r\n  isUTXOSide: boolean = false\r\n\r\n  abBlockchain: any // @to-do - make inmlementation for ABswap\r\n  utxoBlockchain: any // @to-do - make implementation for UTXOSwap\r\n\r\n\r\n  constructor(swap) {\r\n    super(swap)\r\n\r\n    this.state = {\r\n      ...this.state,\r\n      ...{\r\n        /** AB-UTXO **/\r\n        // Partical (btc-seller) has unconfirmed txs in mempool\r\n        participantHasLockedUTXO: false,\r\n        requireWithdrawFee: false,\r\n        requireWithdrawFeeSended: false,\r\n        // Script charged, confirmed and checked - next step - charge AB contract\r\n        isUTXOScriptOk: false,\r\n        utxoScriptValues: null,\r\n        utxoScriptVerified: false,\r\n        utxoScriptCreatingTransactionHash: null,\r\n        /** UTXO-AB **/\r\n        // We are have locked txs in mem-pool\r\n        waitUnlockUTXO: false,\r\n        utxoFundError: null,\r\n        withdrawRequestAccepted: false,\r\n      },\r\n    }\r\n  }\r\n\r\n  signABSide() {\r\n    this.swap.processMetamask()\r\n  }\r\n\r\n  signUTXOSide() {\r\n    this.swap.processMetamask()\r\n    this.swap.room.once('swap sign', () => {\r\n      const { step } = this.state\r\n\r\n      if (step >= 2) {\r\n        return\r\n      }\r\n\r\n      this.swap.room.once('eth refund completed', () => {\r\n        this.tryRefund()\r\n      })\r\n\r\n      this.finishStep({\r\n        isParticipantSigned: true,\r\n      }, { step: 'sign', silentError: true })\r\n    })\r\n\r\n    this.swap.room.once('swap exists', () => {\r\n      this.setState({\r\n        isSwapExist: true,\r\n      })\r\n\r\n      this.stopSwapProcess()\r\n    })\r\n\r\n    this.swap.room.sendMessage({\r\n      event: 'request sign',\r\n    })\r\n  }\r\n\r\n  waitUTXOScriptCreated() {\r\n    const flow = this\r\n    this.swap.room.on('create utxo script', ({ scriptValues, utxoScriptCreatingTransactionHash }) => {\r\n      const { step } = flow.state\r\n\r\n      if (step >= 3) {\r\n        return\r\n      }\r\n\r\n      flow.finishStep({\r\n        secretHash: scriptValues.secretHash,\r\n        utxoScriptValues: scriptValues,\r\n        utxoScriptCreatingTransactionHash,\r\n      }, { step: 'wait-lock-utxo', silentError: true })\r\n    })\r\n\r\n    this.swap.room.sendMessage({\r\n      event: 'request utxo script',\r\n    })\r\n  }\r\n\r\n  async waitUTXOScriptFunded(): Promise<boolean> {\r\n    const {\r\n      isUTXOScriptOk: isFunded,\r\n    } = this.state\r\n    if (isFunded) return true\r\n\r\n    const flow = this\r\n    const {\r\n      participant,\r\n      buyAmount,\r\n      sellAmount,\r\n      waitConfirm,\r\n    } = flow.swap\r\n\r\n    const { secretHash } = this.state\r\n\r\n    const utcNow = () => Math.floor(Date.now() / 1000)\r\n\r\n    const isUTXOScriptOk = await util.helpers.repeatAsyncUntilResult(async (stopRepeat) => {\r\n      const {\r\n        utxoScriptValues,\r\n      } = flow.state\r\n\r\n\r\n      const scriptCheckError = await this[`${this.utxoCoin}Swap`].checkScript(utxoScriptValues, {\r\n        value: buyAmount,\r\n        recipientPublicKey: this.app.services.auth.accounts[this.utxoCoin].getPublicKey(),\r\n        lockTime: utcNow(),\r\n        confidence: 0.8,\r\n        isWhiteList: this.app.isWhitelistBtc(participant.btc.address), // @todo - may be need more white list coins\r\n        waitConfirm,\r\n      })\r\n\r\n      if (scriptCheckError) {\r\n        if (/Expected script lockTime/.test(scriptCheckError)) {\r\n          console.error(`${this.utxoCoin} script check error: ${this.utxoCoin} was refunded`, scriptCheckError)\r\n          flow.stopSwapProcess()\r\n          stopRepeat()\r\n        } else if (/Expected script value/.test(scriptCheckError)) {\r\n          console.warn(`${this.utxoCoin} script check: waiting balance`)\r\n        } else if (\r\n          /Can be replace by fee. Wait confirm/.test(scriptCheckError)\r\n          ||\r\n          /Wait confirm tx/.test(scriptCheckError)\r\n        ) {\r\n          flow.swap.room.sendMessage({\r\n            event: `wait ${this.utxoCoin} confirm`,\r\n            data: {},\r\n          })\r\n        } else {\r\n          this.swap.events.dispatch(`${this.utxoCoin} script check error`, scriptCheckError)\r\n        }\r\n\r\n        return false\r\n      } else {\r\n        return true\r\n      }\r\n    })\r\n\r\n    if (!isUTXOScriptOk) {\r\n      return false\r\n    } else {\r\n      flow.setState({\r\n        isUTXOScriptOk,\r\n      }, true)\r\n      return true\r\n    }\r\n  }\r\n\r\n  getScriptValues() {\r\n    return this.state.utxoScriptValues\r\n  }\r\n\r\n  verifyScript() {\r\n    const { utxoScriptVerified, utxoScriptValues } = this.state\r\n\r\n    if (utxoScriptVerified) {\r\n      return true\r\n    }\r\n\r\n    if (!utxoScriptValues) {\r\n      throw new Error(`No script, cannot verify`)\r\n    }\r\n\r\n    this.finishStep({\r\n      utxoScriptVerified: true,\r\n    }, { step: 'verify-script' })\r\n\r\n    return true\r\n  }\r\n\r\n  getScriptCreateTx() {\r\n    const {\r\n      utxoScriptCreatingTransactionHash,\r\n    } = this.state\r\n    return utxoScriptCreatingTransactionHash\r\n  }\r\n\r\n  //tryRefund(): Promise<any> {}\r\n\r\n  _checkSwapAlreadyExists() {}\r\n\r\n  async sign() {\r\n    const swapExists = await this._checkSwapAlreadyExists()\r\n\r\n    if (swapExists) {\r\n      this.swap.room.sendMessage({\r\n        event: 'swap exists',\r\n      })\r\n\r\n      this.setState({\r\n        isSwapExist: true,\r\n      })\r\n\r\n      this.stopSwapProcess()\r\n    } else {\r\n      const { isSignFetching, isMeSigned } = this.state\r\n\r\n      if (isSignFetching || isMeSigned) {\r\n        return true\r\n      }\r\n\r\n      this.setState({\r\n        isSignFetching: true,\r\n      })\r\n\r\n      this.swap.room.once('utxo refund completed', () => {\r\n        this.tryRefund()\r\n      })\r\n\r\n      this.swap.room.on('request sign', () => {\r\n        this.swap.room.sendMessage({\r\n          event: 'swap sign',\r\n        })\r\n      })\r\n\r\n      this.swap.room.sendMessage({\r\n        event: 'swap sign',\r\n      })\r\n\r\n      this.finishStep({\r\n        isMeSigned: true,\r\n      }, { step: 'sign', silentError: true })\r\n\r\n      return true\r\n    }\r\n  }\r\n\r\n  acceptWithdrawRequest() {\r\n    const flow = this\r\n    const { withdrawRequestAccepted } = flow.state\r\n\r\n    if (withdrawRequestAccepted) {\r\n      return\r\n    }\r\n\r\n    this.setState({\r\n      withdrawRequestAccepted: true,\r\n    })\r\n\r\n    this.swap.room.once('do withdraw', async ({secret}) => {\r\n      try {\r\n        const data = {\r\n          participantAddress: this.app.getParticipantEthAddress(flow.swap),\r\n          secret,\r\n        }\r\n\r\n        await this.abBlockchain.withdrawNoMoney(data, (hash) => {\r\n          flow.swap.room.sendMessage({\r\n            event: 'withdraw ready',\r\n            data: {\r\n              ethSwapWithdrawTransactionHash: hash,\r\n            }\r\n          })\r\n        })\r\n      } catch (err) {\r\n        debug('swap.core:flow')(err.message)\r\n      }\r\n    })\r\n\r\n    this.swap.room.sendMessage({\r\n      event: 'accept withdraw request'\r\n    })\r\n  }\r\n\r\n  /**\r\n   * TODO - backport version compatibility\r\n   *  mapped to sendWithdrawRequestToAnotherParticipant\r\n   *  remove at next iteration after client software update\r\n   *  Used in swap.react\r\n   */\r\n  sendWithdrawRequest() {\r\n    return this.sendWithdrawRequestToAnotherParticipant()\r\n  }\r\n\r\n  sendWithdrawRequestToAnotherParticipant() {\r\n    const flow = this\r\n\r\n    const { requireWithdrawFee, requireWithdrawFeeSended } = flow.state\r\n\r\n    if (!requireWithdrawFee || requireWithdrawFeeSended) {\r\n      return\r\n    }\r\n\r\n    flow.setState({\r\n      requireWithdrawFeeSended: true,\r\n    })\r\n\r\n    flow.swap.room.on('accept withdraw request', () => {\r\n      flow.swap.room.sendMessage({\r\n        event: 'do withdraw',\r\n        data: {\r\n          secret: flow.state.secret,\r\n        }\r\n      })\r\n    })\r\n\r\n    flow.swap.room.sendMessage({\r\n      event: 'request withdraw',\r\n    })\r\n  }\r\n\r\n  // This function call AB side in classic AB2UTXO without taker-maker model\r\n  async checkOtherSideRefund() {\r\n    if (typeof this.utxoBlockchain.checkWithdraw === 'function') {\r\n      const { utxoScriptValues } = this.state\r\n      if (utxoScriptValues) {\r\n        const { scriptAddress } = this.utxoBlockchain.createScript(utxoScriptValues)\r\n\r\n        const destinationAddress = this.swap.destinationBuyAddress\r\n        const destAddress = (destinationAddress) ? destinationAddress : this.app.services.auth.accounts.btc.getAddress()\r\n\r\n        const hasWithdraw = await this.utxoBlockchain.checkWithdraw(scriptAddress)\r\n        if (hasWithdraw\r\n          && hasWithdraw.address.toLowerCase() !== destAddress.toLowerCase()\r\n        ) {\r\n          return true\r\n        }\r\n      }\r\n    }\r\n    return false\r\n  }\r\n\r\n  submitSecret(secret) {\r\n    if (this.state.secret) { return }\r\n\r\n    if (!this.state.isParticipantSigned) {\r\n      throw new Error(`Cannot proceed: participant not signed. step=${this.state.step}`)\r\n    }\r\n\r\n    const secretHash = this.app.env.bitcoin.crypto.ripemd160(Buffer.from(secret, 'hex')).toString('hex')\r\n\r\n    /* Secret hash generated - create BTC script - and only after this notify other part */\r\n    this.createWorkUTXOScript(secretHash);\r\n\r\n    const _secret = `0x${secret.replace(/^0x/, '')}`\r\n\r\n    this.finishStep({\r\n      secret: _secret,\r\n      secretHash,\r\n    }, { step: 'submit-secret' })\r\n  }\r\n\r\n  createWorkUTXOScript(secretHash) {\r\n    if (this.state.utxoScriptValues) {\r\n      debug('swap.core:flow')('BTC Script already generated', this.state.utxoScriptValues)\r\n      return\r\n    }\r\n\r\n    const { participant } = this.swap\r\n\r\n    const utcNow = () => Math.floor(Date.now() / 1000)\r\n    const getLockTime = () => utcNow() + 60 * 60 * 3 // 3 hours from now\r\n\r\n    const scriptValues = {\r\n      secretHash:         secretHash,\r\n      ownerPublicKey:     this.app.services.auth.accounts[this.utxoCoin].getPublicKey(),\r\n      recipientPublicKey: participant[this.utxoCoin].publicKey,\r\n      lockTime:           getLockTime(),\r\n    }\r\n    const { scriptAddress } = this.utxoBlockchain.createScript(scriptValues)\r\n\r\n    this.setState({\r\n      scriptAddress: scriptAddress,\r\n      utxoScriptValues: scriptValues,\r\n      scriptBalance: 0,\r\n      scriptUnspendBalance: 0\r\n    })\r\n  }\r\n\r\n  async syncBalance(): Promise<void> {\r\n    return (this.isUTXOSide)\r\n      ? this.syncBalanceUTXO()\r\n      : this.syncBalanceAB()\r\n  }\r\n\r\n  async syncBalanceAB(): Promise<void> {\r\n    const { sellAmount } = this.swap\r\n\r\n    this.setState({\r\n      isBalanceFetching: true,\r\n    })\r\n\r\n    const balance = await this.abBlockchain.fetchBalance(\r\n      this.app.getMyEthAddress()\r\n    )\r\n    const isEnoughMoney = sellAmount.isLessThanOrEqualTo(balance)\r\n\r\n    const stateData = {\r\n      balance,\r\n      isBalanceFetching: false,\r\n      isBalanceEnough: isEnoughMoney,\r\n    }\r\n\r\n    if (isEnoughMoney) {\r\n      this.finishStep(stateData, { step: 'sync-balance' })\r\n    }\r\n    else {\r\n      this.setState(stateData, true)\r\n    }\r\n  }\r\n\r\n  async syncBalanceUTXO(): Promise<void> {\r\n    const { sellAmount } = this.swap\r\n\r\n    this.setState({\r\n      isBalanceFetching: true,\r\n    })\r\n\r\n    const utxoAddress = this.app.services.auth.accounts[this.utxoCoin].getAddress()\r\n\r\n    const txFee = await this.utxoBlockchain.estimateFeeValue({ method: 'swap', fixed: true, address: utxoAddress })\r\n    const unspents = await this.utxoBlockchain.fetchUnspents(utxoAddress)\r\n    const totalUnspent = unspents.reduce((summ, { satoshis }) => summ + satoshis, 0)\r\n    const balance = new BigNumber(totalUnspent).dividedBy(1e8)\r\n\r\n    const needAmount = sellAmount.plus(txFee)\r\n    const isEnoughMoney = needAmount.isLessThanOrEqualTo(balance)\r\n\r\n    const stateData = {\r\n      balance,\r\n      isBalanceFetching: false,\r\n      isBalanceEnough: isEnoughMoney,\r\n    }\r\n\r\n    if (isEnoughMoney) {\r\n      this.finishStep(stateData, { step: 'sync-balance' })\r\n    } else {\r\n      this.setState(stateData, true)\r\n    }\r\n  }\r\n\r\n  // @to-do - not used in code - front/bot - (btc/ghost/next) - may be need deleted\r\n  // dot with comma in original - say - its artefact....\r\n  getUtxoScriptAddress() {\r\n    const { scriptAddress } = this.state\r\n    return scriptAddress\r\n  }\r\n}\r\n\r\n\r\nexport default AtomicAB2UTXO\r\n"]}]}