{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\ETHTOKEN2GHOST.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\ETHTOKEN2GHOST.ts","mtime":1614842913757},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXN5bmNUb0dlbmVyYXRvciI7CmltcG9ydCBfY2xhc3NDYWxsQ2hlY2sgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jcmVhdGVDbGFzcyI7CmltcG9ydCBfYXNzZXJ0VGhpc0luaXRpYWxpemVkIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXNzZXJ0VGhpc0luaXRpYWxpemVkIjsKaW1wb3J0IF9pbmhlcml0cyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjsKaW1wb3J0IF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiI7CmltcG9ydCBfZ2V0IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0IjsKaW1wb3J0IF9nZXRQcm90b3R5cGVPZiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldFByb3RvdHlwZU9mIjsKaW1wb3J0IF9kZWZpbmVQcm9wZXJ0eSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2RlZmluZVByb3BlcnR5IjsKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgppbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnOwppbXBvcnQgeyBjb25zdGFudHMsIHV0aWwgfSBmcm9tICdzd2FwLmFwcCc7CmltcG9ydCB7IEF0b21pY0FCMlVUWE8gfSBmcm9tICdzd2FwLnN3YXAnOwpleHBvcnQgZGVmYXVsdCAoZnVuY3Rpb24gKHRva2VuTmFtZSkgewogIHZhciBFVEhUT0tFTjJHSE9TVCA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoX0F0b21pY0FCMlVUWE8pIHsKICAgIF9pbmhlcml0cyhFVEhUT0tFTjJHSE9TVCwgX0F0b21pY0FCMlVUWE8pOwoKICAgIHZhciBfc3VwZXIgPSBfY3JlYXRlU3VwZXIoRVRIVE9LRU4yR0hPU1QpOwoKICAgIGZ1bmN0aW9uIEVUSFRPS0VOMkdIT1NUKHN3YXApIHsKICAgICAgdmFyIF90aGlzU3VwZXIsIF90aGlzOwoKICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEVUSFRPS0VOMkdIT1NUKTsKCiAgICAgIF90aGlzID0gX3N1cGVyLmNhbGwodGhpcywgc3dhcCk7CgogICAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJfZmxvd05hbWUiLCB2b2lkIDApOwoKICAgICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiZXRoVG9rZW5Td2FwIiwgdm9pZCAwKTsKCiAgICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImdob3N0U3dhcCIsIHZvaWQgMCk7CgogICAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJzdGF0ZSIsIHZvaWQgMCk7CgogICAgICBfdGhpcy51dHhvQ29pbiA9ICJnaG9zdCI7CiAgICAgIF90aGlzLl9mbG93TmFtZSA9IEVUSFRPS0VOMkdIT1NULmdldE5hbWUoKTsKICAgICAgX3RoaXMuc3RlcE51bWJlcnMgPSB7CiAgICAgICAgJ3NpZ24nOiAxLAogICAgICAgICd3YWl0LWxvY2stdXR4byc6IDIsCiAgICAgICAgJ3ZlcmlmeS1zY3JpcHQnOiAzLAogICAgICAgICdzeW5jLWJhbGFuY2UnOiA0LAogICAgICAgICdsb2NrLWV0aCc6IDUsCiAgICAgICAgJ3dhaXQtd2l0aGRyYXctZXRoJzogNiwKICAgICAgICAvLyBha2EgZ2V0U2VjcmV0CiAgICAgICAgJ3dpdGhkcmF3LXV0eG8nOiA3LAogICAgICAgICdmaW5pc2gnOiA4LAogICAgICAgICdlbmQnOiA5CiAgICAgIH07CiAgICAgIF90aGlzLmV0aFRva2VuU3dhcCA9IHN3YXAucGFydGljaXBhbnRTd2FwOwogICAgICBfdGhpcy5naG9zdFN3YXAgPSBzd2FwLm93bmVyU3dhcDsKICAgICAgX3RoaXMuYWJCbG9ja2NoYWluID0gX3RoaXMuZXRoVG9rZW5Td2FwOwogICAgICBfdGhpcy51dHhvQmxvY2tjaGFpbiA9IF90aGlzLmdob3N0U3dhcDsKCiAgICAgIGlmICghX3RoaXMuZXRoVG9rZW5Td2FwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFVEhUT0tFTjJHSE9TVDogImV0aFRva2VuU3dhcCIgb2YgdHlwZSBvYmplY3QgcmVxdWlyZWQnKTsKICAgICAgfQoKICAgICAgaWYgKCFfdGhpcy5naG9zdFN3YXApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VUSFRPS0VOMkdIT1NUOiAiZ2hvc3RTd2FwIiBvZiB0eXBlIG9iamVjdCByZXF1aXJlZCcpOwogICAgICB9CgogICAgICBfdGhpcy5zdGF0ZSA9IHsKICAgICAgICBzdGVwOiAwLAogICAgICAgIGlzU3RvcHBlZFN3YXA6IGZhbHNlLAogICAgICAgIHNpZ25UcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgICAgaXNTaWduRmV0Y2hpbmc6IGZhbHNlLAogICAgICAgIGlzTWVTaWduZWQ6IGZhbHNlLAogICAgICAgIHRhcmdldFdhbGxldDogbnVsbCwKICAgICAgICBzZWNyZXRIYXNoOiBudWxsLAogICAgICAgIGlzQmFsYW5jZUZldGNoaW5nOiBmYWxzZSwKICAgICAgICBpc0JhbGFuY2VFbm91Z2g6IHRydWUsCiAgICAgICAgYmFsYW5jZTogbnVsbCwKICAgICAgICBldGhTd2FwQ3JlYXRpb25UcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgICAgY2FuQ3JlYXRlRXRoVHJhbnNhY3Rpb246IHRydWUsCiAgICAgICAgaXNFdGhDb250cmFjdEZ1bmRlZDogZmFsc2UsCiAgICAgICAgc2VjcmV0OiBudWxsLAogICAgICAgIGlzRXRoV2l0aGRyYXduOiBmYWxzZSwKICAgICAgICBpc0dob3N0V2l0aGRyYXduOiBmYWxzZSwKICAgICAgICBldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgICAgZ2hvc3RTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgICAgcmVmdW5kVHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICAgIGlzUmVmdW5kZWQ6IGZhbHNlLAogICAgICAgIGlzRmluaXNoZWQ6IGZhbHNlLAogICAgICAgIGlzU3dhcEV4aXN0OiBmYWxzZSwKICAgICAgICB3aXRoZHJhd1JlcXVlc3RJbmNvbWluZzogZmFsc2UsCiAgICAgICAgd2l0aGRyYXdSZXF1ZXN0QWNjZXB0ZWQ6IGZhbHNlLAogICAgICAgIGlzRmFpbGVkVHJhbnNhY3Rpb246IGZhbHNlLAogICAgICAgIGlzRmFpbGVkVHJhbnNhY3Rpb25FcnJvcjogbnVsbCwKICAgICAgICBnYXNBbW91bnROZWVkZWQ6IDAKICAgICAgfTsKCiAgICAgIF90aGlzLl9wZXJzaXN0U3RhdGUoKTsKCiAgICAgIHZhciBmbG93ID0gX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyk7CgogICAgICBmbG93LnN3YXAucm9vbS5vbmNlKCdyZXF1ZXN0IHdpdGhkcmF3JywgZnVuY3Rpb24gKCkgewogICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgd2l0aGRyYXdSZXF1ZXN0SW5jb21pbmc6IHRydWUKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICBfZ2V0KChfdGhpc1N1cGVyID0gX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksIF9nZXRQcm90b3R5cGVPZihFVEhUT0tFTjJHSE9TVC5wcm90b3R5cGUpKSwgIl9wZXJzaXN0U3RlcHMiLCBfdGhpc1N1cGVyKS5jYWxsKF90aGlzU3VwZXIpOwoKICAgICAgcmV0dXJuIF90aGlzOwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhFVEhUT0tFTjJHSE9TVCwgW3sKICAgICAga2V5OiAiX3BlcnNpc3RTdGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfcGVyc2lzdFN0YXRlKCkgewogICAgICAgIF9nZXQoX2dldFByb3RvdHlwZU9mKEVUSFRPS0VOMkdIT1NULnByb3RvdHlwZSksICJfcGVyc2lzdFN0YXRlIiwgdGhpcykuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfZ2V0U3RlcHMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2dldFN0ZXBzKCkgewogICAgICAgIHZhciBfdGhpczIgPSB0aGlzOwoKICAgICAgICB2YXIgZmxvdyA9IHRoaXM7CiAgICAgICAgcmV0dXJuIFsvLyAxLiBTaWduIHN3YXAgdG8gc3RhcnQKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpczIuc2lnbkFCU2lkZSgpOwogICAgICAgIH0sIC8vIDIuIFdhaXQgcGFydGljaXBhbnQgY3JlYXRlLCBmdW5kIEdIT1NUIFNjcmlwdAogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGZsb3cud2FpdFVUWE9TY3JpcHRDcmVhdGVkKCk7CiAgICAgICAgfSwgLy8gMy4gVmVyaWZ5IEdIT1NUIFNjcmlwdAogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJ3YWl0aW5nIHZlcmlmeSBnaG9zdCBzY3JpcHQiKTsgLy8gdGhpcy52ZXJpZnlHaG9zdFNjcmlwdCgpCiAgICAgICAgfSwgLy8gNC4gQ2hlY2sgYmFsYW5jZQogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIF90aGlzMi5zeW5jQmFsYW5jZSgpOwogICAgICAgIH0sCiAgICAgICAgLyojX19QVVJFX18qLwogICAgICAgIC8vIDUuIENyZWF0ZSBFVEggQ29udHJhY3QKICAgICAgICBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlKCkgewogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlJChfY29udGV4dCkgewogICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQucHJldiA9IF9jb250ZXh0Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQubmV4dCA9IDI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmbG93LmV0aFRva2VuU3dhcC5mdW5kQUIyVVRYT0NvbnRyYWN0KHsKICAgICAgICAgICAgICAgICAgICBmbG93OiBmbG93LAogICAgICAgICAgICAgICAgICAgIHV0eG9Db2luOiAiZ2hvc3QiCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlKTsKICAgICAgICB9KSksCiAgICAgICAgLyojX19QVVJFX18qLwogICAgICAgIC8vIDYuIFdhaXQgcGFydGljaXBhbnQgd2l0aGRyYXcKICAgICAgICBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMigpIHsKICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIkKF9jb250ZXh0MikgewogICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyLnByZXYgPSBfY29udGV4dDIubmV4dCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmbG93LmV0aFRva2VuU3dhcC5nZXRTZWNyZXRGcm9tQUIyVVRYTyh7CiAgICAgICAgICAgICAgICAgICAgZmxvdzogZmxvdwogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIF9jYWxsZWUyKTsKICAgICAgICB9KSksCiAgICAgICAgLyojX19QVVJFX18qLwogICAgICAgIC8vIDcuIFdpdGhkcmF3CiAgICAgICAgX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMoKSB7CiAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzJChfY29udGV4dDMpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0My5wcmV2ID0gX2NvbnRleHQzLm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQzLm5leHQgPSAyOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5oZWxwZXJzLnJlcGVhdEFzeW5jVW50aWxSZXN1bHQoZnVuY3Rpb24gKHN0b3BSZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2Zsb3ckc3RhdGUgPSBmbG93LnN0YXRlLAogICAgICAgICAgICAgICAgICAgICAgICBzZWNyZXQgPSBfZmxvdyRzdGF0ZS5zZWNyZXQsCiAgICAgICAgICAgICAgICAgICAgICAgIHV0eG9TY3JpcHRWYWx1ZXMgPSBfZmxvdyRzdGF0ZS51dHhvU2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgICAgICBnaG9zdFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCA9IF9mbG93JHN0YXRlLmdob3N0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZ2hvc3RTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKCF1dHhvU2NyaXB0VmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdUaGVyZSBpcyBubyAidXR4b1NjcmlwdFZhbHVlcyIgaW4gc3RhdGUuIE5vIHdheSB0byBjb250aW51ZSBzd2FwLi4uJyk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmbG93Lmdob3N0U3dhcC53aXRoZHJhdyh7CiAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRWYWx1ZXM6IHV0eG9TY3JpcHRWYWx1ZXMsCiAgICAgICAgICAgICAgICAgICAgICBzZWNyZXQ6IHNlY3JldCwKICAgICAgICAgICAgICAgICAgICAgIGRlc3RpbmF0aW9uQWRkcmVzczogZmxvdy5zd2FwLmRlc3RpbmF0aW9uQnV5QWRkcmVzcwogICAgICAgICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgIGZsb3cuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgICAgICBnaG9zdFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogaGFzaAogICAgICAgICAgICAgICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9KVsiY2F0Y2giXShmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgIGZsb3cuZmluaXNoU3RlcCh7CiAgICAgICAgICAgICAgICAgICAgaXNHaG9zdFdpdGhkcmF3bjogdHJ1ZQogICAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgc3RlcDogJ3dpdGhkcmF3LXV0eG8nCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuc3RvcCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwgX2NhbGxlZTMpOwogICAgICAgIH0pKSwgLy8gOC4gRmluaXNoCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgZmxvdy5zd2FwLnJvb20ub25jZSgncmVxdWVzdCBzd2FwIGZpbmlzaGVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZ2hvc3RTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2ggPSBmbG93LnN0YXRlLmdob3N0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoOwogICAgICAgICAgICBmbG93LnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgZXZlbnQ6ICdzd2FwIGZpbmlzaGVkJywKICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICBnaG9zdFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogZ2hvc3RTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2gKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgICBpc0ZpbmlzaGVkOiB0cnVlCiAgICAgICAgICB9LCB7CiAgICAgICAgICAgIHN0ZXA6ICdmaW5pc2gnCiAgICAgICAgICB9KTsKICAgICAgICB9LCAvLyA5LiBGaW5pc2hlZCEKICAgICAgICBmdW5jdGlvbiAoKSB7fV07CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiX2NoZWNrU3dhcEFscmVhZHlFeGlzdHMiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gX2NoZWNrU3dhcEFscmVhZHlFeGlzdHMoKSB7CiAgICAgICAgdmFyIGZsb3cgPSB0aGlzOwogICAgICAgIHZhciBzd2FwRGF0YSA9IHsKICAgICAgICAgIG93bmVyQWRkcmVzczogdGhpcy5hcHAuZ2V0TXlFdGhBZGRyZXNzKCksCiAgICAgICAgICBwYXJ0aWNpcGFudEFkZHJlc3M6IHRoaXMuYXBwLmdldFBhcnRpY2lwYW50RXRoQWRkcmVzcyhmbG93LnN3YXApCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gdGhpcy5ldGhUb2tlblN3YXAuY2hlY2tTd2FwRXhpc3RzKHN3YXBEYXRhKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJ0cnlSZWZ1bmQiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfdHJ5UmVmdW5kID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTQoKSB7CiAgICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgICB2YXIgc2VjcmV0SGFzaCwgcmVmdW5kSGFuZGxlciwgd2FzUmVmdW5kZWQ7CiAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU0JChfY29udGV4dDQpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NC5wcmV2ID0gX2NvbnRleHQ0Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgc2VjcmV0SGFzaCA9IHRoaXMuc3RhdGUuc2VjcmV0SGFzaDsKCiAgICAgICAgICAgICAgICAgIHJlZnVuZEhhbmRsZXIgPSBmdW5jdGlvbiByZWZ1bmRIYW5kbGVyKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBoYXNoID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBudWxsOwoKICAgICAgICAgICAgICAgICAgICBfdGhpczMuc3dhcC5yb29tLnNlbmRNZXNzYWdlKHsKICAgICAgICAgICAgICAgICAgICAgIGV2ZW50OiAnZXRoIHJlZnVuZCBjb21wbGV0ZWQnCiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIF90aGlzMy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICByZWZ1bmRUcmFuc2FjdGlvbkhhc2g6IGhhc2gsCiAgICAgICAgICAgICAgICAgICAgICBpc1JlZnVuZGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgaXNTd2FwRXhpc3Q6IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICBfY29udGV4dDQucHJldiA9IDI7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0NC5uZXh0ID0gNTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXRoVG9rZW5Td2FwLndhc1JlZnVuZGVkKHsKICAgICAgICAgICAgICAgICAgICBzZWNyZXRIYXNoOiBzZWNyZXRIYXNoCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgd2FzUmVmdW5kZWQgPSBfY29udGV4dDQuc2VudDsKCiAgICAgICAgICAgICAgICAgIGlmICghd2FzUmVmdW5kZWQpIHsKICAgICAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDEwOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgnVGhpcyBzd2FwIHdhcyByZWZ1bmRlZCcpOwogICAgICAgICAgICAgICAgICByZWZ1bmRIYW5kbGVyKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDE2OwogICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICAgICAgICBfY29udGV4dDQucHJldiA9IDEyOwogICAgICAgICAgICAgICAgICBfY29udGV4dDQudDAgPSBfY29udGV4dDRbImNhdGNoIl0oMik7CiAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2Fybignd2FzUmVmdW5kZWQgZXJyb3I6JywgX2NvbnRleHQ0LnQwKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5hYnJ1cHQoInJldHVybiIsIGZhbHNlKTsKCiAgICAgICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LmFicnVwdCgicmV0dXJuIiwgdGhpcy5ldGhUb2tlblN3YXAucmVmdW5kKHsKICAgICAgICAgICAgICAgICAgICBwYXJ0aWNpcGFudEFkZHJlc3M6IHRoaXMuYXBwLmdldFBhcnRpY2lwYW50RXRoQWRkcmVzcyh0aGlzLnN3YXApCiAgICAgICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWhhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJlZnVuZEhhbmRsZXIoaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0pWyJjYXRjaCJdKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgICAgIGNhc2UgMTc6CiAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIF9jYWxsZWU0LCB0aGlzLCBbWzIsIDEyXV0pOwogICAgICAgIH0pKTsKCiAgICAgICAgZnVuY3Rpb24gdHJ5UmVmdW5kKCkgewogICAgICAgICAgcmV0dXJuIF90cnlSZWZ1bmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnlSZWZ1bmQ7CiAgICAgIH0oKQogICAgfSwgewogICAgICBrZXk6ICJpc1JlZnVuZFN1Y2Nlc3MiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfaXNSZWZ1bmRTdWNjZXNzID0gX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTUoKSB7CiAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU1JChfY29udGV4dDUpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0NS5wcmV2ID0gX2NvbnRleHQ1Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NS5hYnJ1cHQoInJldHVybiIsIHRydWUpOwoKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuc3RvcCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwgX2NhbGxlZTUpOwogICAgICAgIH0pKTsKCiAgICAgICAgZnVuY3Rpb24gaXNSZWZ1bmRTdWNjZXNzKCkgewogICAgICAgICAgcmV0dXJuIF9pc1JlZnVuZFN1Y2Nlc3MuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBpc1JlZnVuZFN1Y2Nlc3M7CiAgICAgIH0oKQogICAgfSwgewogICAgICBrZXk6ICJ0cnlXaXRoZHJhdyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIF90cnlXaXRoZHJhdyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU2KF9zZWNyZXQpIHsKICAgICAgICAgIHZhciBfdGhpczQgPSB0aGlzOwoKICAgICAgICAgIHZhciBfdGhpcyRzdGF0ZSwgc2VjcmV0LCBzZWNyZXRIYXNoLCBpc0V0aFdpdGhkcmF3biwgaXNHaG9zdFdpdGhkcmF3biwgdXR4b1NjcmlwdFZhbHVlcywgX3NlY3JldEhhc2gsIF90aGlzJGdob3N0U3dhcCRjcmVhdCwgc2NyaXB0QWRkcmVzcywgYmFsYW5jZTsKCiAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU2JChfY29udGV4dDYpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Ni5wcmV2ID0gX2NvbnRleHQ2Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX3RoaXMkc3RhdGUgPSB0aGlzLnN0YXRlLCBzZWNyZXQgPSBfdGhpcyRzdGF0ZS5zZWNyZXQsIHNlY3JldEhhc2ggPSBfdGhpcyRzdGF0ZS5zZWNyZXRIYXNoLCBpc0V0aFdpdGhkcmF3biA9IF90aGlzJHN0YXRlLmlzRXRoV2l0aGRyYXduLCBpc0dob3N0V2l0aGRyYXduID0gX3RoaXMkc3RhdGUuaXNHaG9zdFdpdGhkcmF3biwgdXR4b1NjcmlwdFZhbHVlcyA9IF90aGlzJHN0YXRlLnV0eG9TY3JpcHRWYWx1ZXM7CgogICAgICAgICAgICAgICAgICBpZiAoX3NlY3JldCkgewogICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaXRoZHJhd2FsIGlzIGF1dG9tYXRpYy4gRm9yIG1hbnVhbCB3aXRoZHJhd2FsLCBwcm92aWRlIGEgc2VjcmV0Iik7CgogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgICBpZiAodXR4b1NjcmlwdFZhbHVlcykgewogICAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gNTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgd2l0aGRyYXcgd2l0aG91dCBzY3JpcHQgdmFsdWVzIik7CgogICAgICAgICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICAgICAgICBpZiAoc2VjcmV0ICYmIHNlY3JldCAhPSBfc2VjcmV0KSBjb25zb2xlLndhcm4oIlNlY3JldCBhbHJlYWR5IGtub3duIGFuZCBpcyBkaWZmZXJlbnQuIEFyZSB5b3Ugc3VyZT8iKTsKICAgICAgICAgICAgICAgICAgaWYgKGlzR2hvc3RXaXRoZHJhd24pIGNvbnNvbGUud2FybigiTG9va3MgbGlrZSBtb25leSB3ZXJlIGFscmVhZHkgd2l0aGRyYXduLCBhcmUgeW91IHN1cmU/Iik7CiAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJXSVRIRFJBVyB1c2luZyBzZWNyZXQgPSAiLmNvbmNhdChfc2VjcmV0KSk7CiAgICAgICAgICAgICAgICAgIF9zZWNyZXRIYXNoID0gdGhpcy5hcHAuZW52LmJpdGNvaW4uY3J5cHRvLnJpcGVtZDE2MChCdWZmZXIuZnJvbShfc2VjcmV0LCAnaGV4JykpLnRvU3RyaW5nKCdoZXgnKTsKICAgICAgICAgICAgICAgICAgaWYgKHNlY3JldEhhc2ggIT0gX3NlY3JldEhhc2gpIGNvbnNvbGUud2FybigiSGFzaCBkb2VzIG5vdCBtYXRjaCEgc3RhdGU6ICIuY29uY2F0KHNlY3JldEhhc2gsICIsIGdpdmVuOiAiKS5jb25jYXQoX3NlY3JldEhhc2gpKTsKICAgICAgICAgICAgICAgICAgX3RoaXMkZ2hvc3RTd2FwJGNyZWF0ID0gdGhpcy5naG9zdFN3YXAuY3JlYXRlU2NyaXB0KHV0eG9TY3JpcHRWYWx1ZXMpLCBzY3JpcHRBZGRyZXNzID0gX3RoaXMkZ2hvc3RTd2FwJGNyZWF0LnNjcmlwdEFkZHJlc3M7CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Ni5uZXh0ID0gMTM7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdob3N0U3dhcC5nZXRCYWxhbmNlKHNjcmlwdEFkZHJlc3MpOwoKICAgICAgICAgICAgICAgIGNhc2UgMTM6CiAgICAgICAgICAgICAgICAgIGJhbGFuY2UgPSBfY29udGV4dDYuc2VudDsKICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoImFkZHJlc3M9Ii5jb25jYXQoc2NyaXB0QWRkcmVzcywgIiwgYmFsYW5jZT0iKS5jb25jYXQoYmFsYW5jZSkpOwoKICAgICAgICAgICAgICAgICAgaWYgKCEoYmFsYW5jZSA9PT0gMCkpIHsKICAgICAgICAgICAgICAgICAgICBfY29udGV4dDYubmV4dCA9IDE4OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICB0aGlzLmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICAgIGlzR2hvc3RXaXRoZHJhd246IHRydWUKICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIHN0ZXA6ICd3aXRoZHJhdy11dHhvJwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbHJlYWR5IHdpdGhkcmF3bjogYWRkcmVzcz0iLmNvbmNhdChzY3JpcHRBZGRyZXNzLCAiLGJhbGFuY2U9IikuY29uY2F0KGJhbGFuY2UpKTsKCiAgICAgICAgICAgICAgICBjYXNlIDE4OgogICAgICAgICAgICAgICAgICBfY29udGV4dDYubmV4dCA9IDIwOwogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5naG9zdFN3YXAud2l0aGRyYXcoewogICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlczogdXR4b1NjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgICBzZWNyZXQ6IF9zZWNyZXQKICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGhhc2gpIHsKICAgICAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgiVFggaGFzaD0iLmNvbmNhdChoYXNoKSk7CgogICAgICAgICAgICAgICAgICAgIF90aGlzNC5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICBnaG9zdFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogaGFzaAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBjYXNlIDIwOgogICAgICAgICAgICAgICAgICBkZWJ1Zygnc3dhcC5jb3JlOmZsb3cnKSgiVFggd2l0aGRyYXcgc2VudDogIi5jb25jYXQodGhpcy5zdGF0ZS5naG9zdFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCkpOwogICAgICAgICAgICAgICAgICB0aGlzLmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICAgIGlzR2hvc3RXaXRoZHJhd246IHRydWUKICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIHN0ZXA6ICd3aXRoZHJhdy11dHhvJwogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBjYXNlIDIyOgogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0Ni5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlNiwgdGhpcyk7CiAgICAgICAgfSkpOwoKICAgICAgICBmdW5jdGlvbiB0cnlXaXRoZHJhdyhfeCkgewogICAgICAgICAgcmV0dXJuIF90cnlXaXRoZHJhdy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRyeVdpdGhkcmF3OwogICAgICB9KCkKICAgIH1dLCBbewogICAgICBrZXk6ICJnZXROYW1lIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldE5hbWUoKSB7CiAgICAgICAgcmV0dXJuICIiLmNvbmNhdCh0aGlzLmdldEZyb21OYW1lKCksICIyIikuY29uY2F0KHRoaXMuZ2V0VG9OYW1lKCkpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldEZyb21OYW1lIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldEZyb21OYW1lKCkgewogICAgICAgIHJldHVybiB0b2tlbk5hbWUudG9VcHBlckNhc2UoKTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJnZXRUb05hbWUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0VG9OYW1lKCkgewogICAgICAgIHJldHVybiBjb25zdGFudHMuQ09JTlMuZ2hvc3Q7CiAgICAgIH0KICAgIH1dKTsKCiAgICByZXR1cm4gRVRIVE9LRU4yR0hPU1Q7CiAgfShBdG9taWNBQjJVVFhPKTsKCiAgcmV0dXJuIEVUSFRPS0VOMkdIT1NUOwp9KTs="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.flows/ETHTOKEN2GHOST.ts"],"names":["debug","constants","util","AtomicAB2UTXO","tokenName","ETHTOKEN2GHOST","swap","utxoCoin","_flowName","getName","stepNumbers","ethTokenSwap","participantSwap","ghostSwap","ownerSwap","abBlockchain","utxoBlockchain","Error","state","step","isStoppedSwap","signTransactionHash","isSignFetching","isMeSigned","targetWallet","secretHash","isBalanceFetching","isBalanceEnough","balance","ethSwapCreationTransactionHash","canCreateEthTransaction","isEthContractFunded","secret","isEthWithdrawn","isGhostWithdrawn","ethSwapWithdrawTransactionHash","ghostSwapWithdrawTransactionHash","refundTransactionHash","isRefunded","isFinished","isSwapExist","withdrawRequestIncoming","withdrawRequestAccepted","isFailedTransaction","isFailedTransactionError","gasAmountNeeded","_persistState","flow","room","once","setState","signABSide","waitUTXOScriptCreated","syncBalance","fundAB2UTXOContract","getSecretFromAB2UTXO","helpers","repeatAsyncUntilResult","stopRepeat","utxoScriptValues","console","error","withdraw","scriptValues","destinationAddress","destinationBuyAddress","then","hash","finishStep","sendMessage","event","data","swapData","ownerAddress","app","getMyEthAddress","participantAddress","getParticipantEthAddress","checkSwapExists","refundHandler","wasRefunded","warn","refund","_secret","_secretHash","env","bitcoin","crypto","ripemd160","Buffer","from","toString","createScript","scriptAddress","getBalance","getFromName","getToName","toUpperCase","COINS","ghost"],"mappings":"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","sourcesContent":["import debug from 'debug'\r\nimport SwapApp, { constants, util } from 'swap.app'\r\nimport { AtomicAB2UTXO } from 'swap.swap'\r\n\r\n\r\nexport default (tokenName) => {\r\n\r\n  class ETHTOKEN2GHOST extends AtomicAB2UTXO {\r\n\r\n    _flowName: string\r\n    ethTokenSwap: any\r\n    ghostSwap: any\r\n    state: any\r\n\r\n    static getName() {\r\n      return `${this.getFromName()}2${this.getToName()}`\r\n    }\r\n    static getFromName() {\r\n      return tokenName.toUpperCase()\r\n    }\r\n    static getToName() {\r\n      return constants.COINS.ghost\r\n    }\r\n    constructor(swap) {\r\n      super(swap)\r\n      this.utxoCoin = `ghost`\r\n\r\n      this._flowName = ETHTOKEN2GHOST.getName()\r\n\r\n      this.stepNumbers = {\r\n        'sign': 1,\r\n        'wait-lock-utxo': 2,\r\n        'verify-script': 3,\r\n        'sync-balance': 4,\r\n        'lock-eth': 5,\r\n        'wait-withdraw-eth': 6, // aka getSecret\r\n        'withdraw-utxo': 7,\r\n        'finish': 8,\r\n        'end': 9\r\n      }\r\n\r\n      this.ethTokenSwap = swap.participantSwap\r\n      this.ghostSwap = swap.ownerSwap\r\n\r\n      this.abBlockchain = this.ethTokenSwap\r\n      this.utxoBlockchain = this.ghostSwap\r\n\r\n      if (!this.ethTokenSwap) {\r\n        throw new Error('ETHTOKEN2GHOST: \"ethTokenSwap\" of type object required')\r\n      }\r\n      if (!this.ghostSwap) {\r\n        throw new Error('ETHTOKEN2GHOST: \"ghostSwap\" of type object required')\r\n      }\r\n\r\n      this.state = {\r\n        step: 0,\r\n\r\n        isStoppedSwap: false,\r\n\r\n        signTransactionHash: null,\r\n        isSignFetching: false,\r\n        isMeSigned: false,\r\n\r\n        targetWallet : null,\r\n        secretHash: null,\r\n\r\n        isBalanceFetching: false,\r\n        isBalanceEnough: true,\r\n        balance: null,\r\n\r\n        ethSwapCreationTransactionHash: null,\r\n        canCreateEthTransaction: true,\r\n        isEthContractFunded: false,\r\n\r\n        secret: null,\r\n\r\n        isEthWithdrawn: false,\r\n        isGhostWithdrawn: false,\r\n\r\n        ethSwapWithdrawTransactionHash: null,\r\n        ghostSwapWithdrawTransactionHash: null,\r\n\r\n        refundTransactionHash: null,\r\n        isRefunded: false,\r\n\r\n        isFinished: false,\r\n        isSwapExist: false,\r\n\r\n        withdrawRequestIncoming: false,\r\n        withdrawRequestAccepted: false,\r\n\r\n        isFailedTransaction: false,\r\n        isFailedTransactionError: null,\r\n        gasAmountNeeded: 0,\r\n      }\r\n\r\n      this._persistState()\r\n\r\n      const flow = this\r\n      flow.swap.room.once('request withdraw', () => {\r\n        flow.setState({\r\n          withdrawRequestIncoming: true,\r\n        })\r\n      })\r\n\r\n      super._persistSteps()\r\n    }\r\n\r\n    _persistState() {\r\n      super._persistState()\r\n    }\r\n\r\n    _getSteps() {\r\n      const flow = this\r\n\r\n      return [\r\n\r\n        // 1. Sign swap to start\r\n\r\n        () => {\r\n          this.signABSide()\r\n        },\r\n\r\n        // 2. Wait participant create, fund GHOST Script\r\n\r\n        () => {\r\n          flow.waitUTXOScriptCreated()\r\n        },\r\n\r\n        // 3. Verify GHOST Script\r\n\r\n        () => {\r\n          debug('swap.core:flow')(`waiting verify ghost script`)\r\n          // this.verifyGhostScript()\r\n        },\r\n\r\n        // 4. Check balance\r\n\r\n        () => {\r\n          this.syncBalance()\r\n        },\r\n\r\n        // 5. Create ETH Contract\r\n\r\n        async () => {\r\n          await flow.ethTokenSwap.fundAB2UTXOContract({\r\n            flow,\r\n            utxoCoin: `ghost`,\r\n          })\r\n        },\r\n\r\n        // 6. Wait participant withdraw\r\n\r\n        async () => {\r\n          await flow.ethTokenSwap.getSecretFromAB2UTXO({ flow })\r\n        },\r\n\r\n        // 7. Withdraw\r\n\r\n        async () => {\r\n          await util.helpers.repeatAsyncUntilResult((stopRepeat) => {\r\n            const { secret, utxoScriptValues, ghostSwapWithdrawTransactionHash } = flow.state\r\n\r\n            if (ghostSwapWithdrawTransactionHash) {\r\n              return true\r\n            }\r\n\r\n            if (!utxoScriptValues) {\r\n              console.error('There is no \"utxoScriptValues\" in state. No way to continue swap...')\r\n              return null\r\n            }\r\n\r\n            return flow.ghostSwap.withdraw({\r\n              scriptValues: utxoScriptValues,\r\n              secret,\r\n              destinationAddress: flow.swap.destinationBuyAddress,\r\n            })\r\n              .then((hash) => {\r\n                flow.setState({\r\n                  ghostSwapWithdrawTransactionHash: hash,\r\n                }, true)\r\n                return true\r\n              })\r\n              .catch((error) => null)\r\n          })\r\n\r\n          flow.finishStep({\r\n            isGhostWithdrawn: true,\r\n          }, { step: 'withdraw-utxo' })\r\n        },\r\n\r\n        // 8. Finish\r\n\r\n        () => {\r\n          flow.swap.room.once('request swap finished', () => {\r\n            const { ghostSwapWithdrawTransactionHash } = flow.state\r\n\r\n            flow.swap.room.sendMessage({\r\n              event: 'swap finished',\r\n              data: {\r\n                ghostSwapWithdrawTransactionHash,\r\n              },\r\n            })\r\n          })\r\n\r\n          flow.finishStep({\r\n            isFinished: true,\r\n          }, { step: 'finish' })\r\n        },\r\n\r\n        // 9. Finished!\r\n\r\n        () => {},\r\n      ]\r\n    }\r\n\r\n    _checkSwapAlreadyExists() {\r\n      const flow = this\r\n\r\n      const swapData = {\r\n        ownerAddress: this.app.getMyEthAddress(),\r\n        participantAddress: this.app.getParticipantEthAddress(flow.swap)\r\n      }\r\n\r\n      return this.ethTokenSwap.checkSwapExists(swapData)\r\n    }\r\n\r\n    async tryRefund() {\r\n      const { secretHash } = this.state\r\n\r\n      const refundHandler = (hash = null) => {\r\n        this.swap.room.sendMessage({\r\n          event: 'eth refund completed',\r\n        })\r\n\r\n        this.setState({\r\n          refundTransactionHash: hash,\r\n          isRefunded: true,\r\n          isSwapExist: false,\r\n        }, true)\r\n      }\r\n\r\n      try {\r\n        const wasRefunded = await this.ethTokenSwap.wasRefunded({ secretHash })\r\n\r\n        if (wasRefunded) {\r\n          debug('swap.core:flow')('This swap was refunded')\r\n\r\n          refundHandler()\r\n\r\n          return true\r\n        }\r\n      } catch (error) {\r\n        console.warn('wasRefunded error:', error)\r\n\r\n        return false\r\n      }\r\n\r\n      return this.ethTokenSwap.refund({\r\n        participantAddress: this.app.getParticipantEthAddress(this.swap),\r\n      })\r\n        .then((hash) => {\r\n          if (!hash) {\r\n            return false\r\n          }\r\n\r\n          refundHandler(hash)\r\n\r\n          return true\r\n        })\r\n        .catch((error) => false)\r\n    }\r\n\r\n    async isRefundSuccess() {\r\n      return true\r\n    }\r\n\r\n    async tryWithdraw(_secret) {\r\n      const { secret, secretHash, isEthWithdrawn, isGhostWithdrawn, utxoScriptValues } = this.state\r\n\r\n      if (!_secret)\r\n        throw new Error(`Withdrawal is automatic. For manual withdrawal, provide a secret`)\r\n\r\n      if (!utxoScriptValues)\r\n        throw new Error(`Cannot withdraw without script values`)\r\n\r\n      if (secret && secret != _secret)\r\n        console.warn(`Secret already known and is different. Are you sure?`)\r\n\r\n      if (isGhostWithdrawn)\r\n        console.warn(`Looks like money were already withdrawn, are you sure?`)\r\n\r\n      debug('swap.core:flow')(`WITHDRAW using secret = ${_secret}`)\r\n\r\n      const _secretHash = this.app.env.bitcoin.crypto.ripemd160(Buffer.from(_secret, 'hex')).toString('hex')\r\n\r\n      if (secretHash != _secretHash)\r\n        console.warn(`Hash does not match! state: ${secretHash}, given: ${_secretHash}`)\r\n\r\n      const {scriptAddress} = this.ghostSwap.createScript(utxoScriptValues)\r\n      const balance = await this.ghostSwap.getBalance(scriptAddress)\r\n\r\n      debug('swap.core:flow')(`address=${scriptAddress}, balance=${balance}`)\r\n\r\n      if (balance === 0) {\r\n        this.finishStep({\r\n          isGhostWithdrawn: true,\r\n        }, {step: 'withdraw-utxo'})\r\n        throw new Error(`Already withdrawn: address=${scriptAddress},balance=${balance}`)\r\n      }\r\n\r\n      await this.ghostSwap.withdraw({\r\n        scriptValues: utxoScriptValues,\r\n        secret: _secret,\r\n      }, (hash) => {\r\n        debug('swap.core:flow')(`TX hash=${hash}`)\r\n        this.setState({\r\n          ghostSwapWithdrawTransactionHash: hash,\r\n        })\r\n      })\r\n      debug('swap.core:flow')(`TX withdraw sent: ${this.state.ghostSwapWithdrawTransactionHash}`)\r\n\r\n      this.finishStep({\r\n        isGhostWithdrawn: true,\r\n      }, { step: 'withdraw-utxo' })\r\n    }\r\n  }\r\n\r\n  return ETHTOKEN2GHOST\r\n}\r\n"]}]}