{"remainingRequest":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js??ref--9-1!C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\ETHTOKEN2NEXT.ts","dependencies":[{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\src\\core\\swap.flows\\ETHTOKEN2NEXT.ts","mtime":1614842913757},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\Users\\Alexei\\MultiCurrencyWallet\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF9hc3luY1RvR2VuZXJhdG9yIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXN5bmNUb0dlbmVyYXRvciI7CmltcG9ydCBfY2xhc3NDYWxsQ2hlY2sgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jbGFzc0NhbGxDaGVjayI7CmltcG9ydCBfY3JlYXRlQ2xhc3MgZnJvbSAiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jcmVhdGVDbGFzcyI7CmltcG9ydCBfYXNzZXJ0VGhpc0luaXRpYWxpemVkIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvYXNzZXJ0VGhpc0luaXRpYWxpemVkIjsKaW1wb3J0IF9pbmhlcml0cyBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2luaGVyaXRzIjsKaW1wb3J0IF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuIGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvcG9zc2libGVDb25zdHJ1Y3RvclJldHVybiI7CmltcG9ydCBfZ2V0IGZyb20gIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvZ2V0IjsKaW1wb3J0IF9nZXRQcm90b3R5cGVPZiBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2dldFByb3RvdHlwZU9mIjsKaW1wb3J0IF9kZWZpbmVQcm9wZXJ0eSBmcm9tICJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2RlZmluZVByb3BlcnR5IjsKaW1wb3J0IF9yZWdlbmVyYXRvclJ1bnRpbWUgZnJvbSAiQGJhYmVsL3J1bnRpbWUvcmVnZW5lcmF0b3IiOwoKZnVuY3Rpb24gX2NyZWF0ZVN1cGVyKERlcml2ZWQpIHsgdmFyIGhhc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QgPSBfaXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KCk7IHJldHVybiBmdW5jdGlvbiBfY3JlYXRlU3VwZXJJbnRlcm5hbCgpIHsgdmFyIFN1cGVyID0gX2dldFByb3RvdHlwZU9mKERlcml2ZWQpLCByZXN1bHQ7IGlmIChoYXNOYXRpdmVSZWZsZWN0Q29uc3RydWN0KSB7IHZhciBOZXdUYXJnZXQgPSBfZ2V0UHJvdG90eXBlT2YodGhpcykuY29uc3RydWN0b3I7IHJlc3VsdCA9IFJlZmxlY3QuY29uc3RydWN0KFN1cGVyLCBhcmd1bWVudHMsIE5ld1RhcmdldCk7IH0gZWxzZSB7IHJlc3VsdCA9IFN1cGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH0gcmV0dXJuIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIHJlc3VsdCk7IH07IH0KCmZ1bmN0aW9uIF9pc05hdGl2ZVJlZmxlY3RDb25zdHJ1Y3QoKSB7IGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gInVuZGVmaW5lZCIgfHwgIVJlZmxlY3QuY29uc3RydWN0KSByZXR1cm4gZmFsc2U7IGlmIChSZWZsZWN0LmNvbnN0cnVjdC5zaGFtKSByZXR1cm4gZmFsc2U7IGlmICh0eXBlb2YgUHJveHkgPT09ICJmdW5jdGlvbiIpIHJldHVybiB0cnVlOyB0cnkgeyBCb29sZWFuLnByb3RvdHlwZS52YWx1ZU9mLmNhbGwoUmVmbGVjdC5jb25zdHJ1Y3QoQm9vbGVhbiwgW10sIGZ1bmN0aW9uICgpIHt9KSk7IHJldHVybiB0cnVlOyB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfSB9CgppbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnOwppbXBvcnQgeyBjb25zdGFudHMsIHV0aWwgfSBmcm9tICdzd2FwLmFwcCc7CmltcG9ydCB7IEF0b21pY0FCMlVUWE8gfSBmcm9tICdzd2FwLnN3YXAnOwpleHBvcnQgZGVmYXVsdCAoZnVuY3Rpb24gKHRva2VuTmFtZSkgewogIHZhciBFVEhUT0tFTjJORVhUID0gLyojX19QVVJFX18qL2Z1bmN0aW9uIChfQXRvbWljQUIyVVRYTykgewogICAgX2luaGVyaXRzKEVUSFRPS0VOMk5FWFQsIF9BdG9taWNBQjJVVFhPKTsKCiAgICB2YXIgX3N1cGVyID0gX2NyZWF0ZVN1cGVyKEVUSFRPS0VOMk5FWFQpOwoKICAgIGZ1bmN0aW9uIEVUSFRPS0VOMk5FWFQoc3dhcCkgewogICAgICB2YXIgX3RoaXNTdXBlciwgX3RoaXM7CgogICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgRVRIVE9LRU4yTkVYVCk7CgogICAgICBfdGhpcyA9IF9zdXBlci5jYWxsKHRoaXMsIHN3YXApOwoKICAgICAgX2RlZmluZVByb3BlcnR5KF9hc3NlcnRUaGlzSW5pdGlhbGl6ZWQoX3RoaXMpLCAiX2Zsb3dOYW1lIiwgdm9pZCAwKTsKCiAgICAgIF9kZWZpbmVQcm9wZXJ0eShfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgImV0aFRva2VuU3dhcCIsIHZvaWQgMCk7CgogICAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJuZXh0U3dhcCIsIHZvaWQgMCk7CgogICAgICBfZGVmaW5lUHJvcGVydHkoX2Fzc2VydFRoaXNJbml0aWFsaXplZChfdGhpcyksICJzdGF0ZSIsIHZvaWQgMCk7CgogICAgICBfdGhpcy51dHhvQ29pbiA9ICJuZXh0IjsKICAgICAgX3RoaXMuX2Zsb3dOYW1lID0gRVRIVE9LRU4yTkVYVC5nZXROYW1lKCk7CiAgICAgIF90aGlzLnN0ZXBOdW1iZXJzID0gewogICAgICAgICdzaWduJzogMSwKICAgICAgICAnd2FpdC1sb2NrLXV0eG8nOiAyLAogICAgICAgICd2ZXJpZnktc2NyaXB0JzogMywKICAgICAgICAnc3luYy1iYWxhbmNlJzogNCwKICAgICAgICAnbG9jay1ldGgnOiA1LAogICAgICAgICd3YWl0LXdpdGhkcmF3LWV0aCc6IDYsCiAgICAgICAgLy8gYWthIGdldFNlY3JldAogICAgICAgICd3aXRoZHJhdy11dHhvJzogNywKICAgICAgICAnZmluaXNoJzogOCwKICAgICAgICAnZW5kJzogOQogICAgICB9OwogICAgICBfdGhpcy5ldGhUb2tlblN3YXAgPSBzd2FwLnBhcnRpY2lwYW50U3dhcDsKICAgICAgX3RoaXMubmV4dFN3YXAgPSBzd2FwLm93bmVyU3dhcDsKICAgICAgX3RoaXMuYWJCbG9ja2NoYWluID0gX3RoaXMuZXRoVG9rZW5Td2FwOwogICAgICBfdGhpcy51dHhvQmxvY2tjaGFpbiA9IF90aGlzLm5leHRTd2FwOwoKICAgICAgaWYgKCFfdGhpcy5ldGhUb2tlblN3YXApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VUSFRPS0VOMk5FWFQ6ICJldGhUb2tlblN3YXAiIG9mIHR5cGUgb2JqZWN0IHJlcXVpcmVkJyk7CiAgICAgIH0KCiAgICAgIGlmICghX3RoaXMubmV4dFN3YXApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VUSFRPS0VOMk5FWFQ6ICJuZXh0U3dhcCIgb2YgdHlwZSBvYmplY3QgcmVxdWlyZWQnKTsKICAgICAgfQoKICAgICAgX3RoaXMuc3RhdGUgPSB7CiAgICAgICAgc3RlcDogMCwKICAgICAgICBpc1N0b3BwZWRTd2FwOiBmYWxzZSwKICAgICAgICBzaWduVHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICAgIGlzU2lnbkZldGNoaW5nOiBmYWxzZSwKICAgICAgICBpc01lU2lnbmVkOiBmYWxzZSwKICAgICAgICB0YXJnZXRXYWxsZXQ6IG51bGwsCiAgICAgICAgc2VjcmV0SGFzaDogbnVsbCwKICAgICAgICBpc0JhbGFuY2VGZXRjaGluZzogZmFsc2UsCiAgICAgICAgaXNCYWxhbmNlRW5vdWdoOiB0cnVlLAogICAgICAgIGJhbGFuY2U6IG51bGwsCiAgICAgICAgZXRoU3dhcENyZWF0aW9uVHJhbnNhY3Rpb25IYXNoOiBudWxsLAogICAgICAgIGNhbkNyZWF0ZUV0aFRyYW5zYWN0aW9uOiB0cnVlLAogICAgICAgIGlzRXRoQ29udHJhY3RGdW5kZWQ6IGZhbHNlLAogICAgICAgIHNlY3JldDogbnVsbCwKICAgICAgICBpc0V0aFdpdGhkcmF3bjogZmFsc2UsCiAgICAgICAgaXNOZXh0V2l0aGRyYXduOiBmYWxzZSwKICAgICAgICBldGhTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgICAgbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogbnVsbCwKICAgICAgICByZWZ1bmRUcmFuc2FjdGlvbkhhc2g6IG51bGwsCiAgICAgICAgaXNSZWZ1bmRlZDogZmFsc2UsCiAgICAgICAgaXNGaW5pc2hlZDogZmFsc2UsCiAgICAgICAgaXNTd2FwRXhpc3Q6IGZhbHNlLAogICAgICAgIHdpdGhkcmF3UmVxdWVzdEluY29taW5nOiBmYWxzZSwKICAgICAgICB3aXRoZHJhd1JlcXVlc3RBY2NlcHRlZDogZmFsc2UsCiAgICAgICAgaXNGYWlsZWRUcmFuc2FjdGlvbjogZmFsc2UsCiAgICAgICAgaXNGYWlsZWRUcmFuc2FjdGlvbkVycm9yOiBudWxsLAogICAgICAgIGdhc0Ftb3VudE5lZWRlZDogMAogICAgICB9OwoKICAgICAgX3RoaXMuX3BlcnNpc3RTdGF0ZSgpOwoKICAgICAgdmFyIGZsb3cgPSBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKTsKCiAgICAgIGZsb3cuc3dhcC5yb29tLm9uY2UoJ3JlcXVlc3Qgd2l0aGRyYXcnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICB3aXRoZHJhd1JlcXVlc3RJbmNvbWluZzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIF9nZXQoKF90aGlzU3VwZXIgPSBfYXNzZXJ0VGhpc0luaXRpYWxpemVkKF90aGlzKSwgX2dldFByb3RvdHlwZU9mKEVUSFRPS0VOMk5FWFQucHJvdG90eXBlKSksICJfcGVyc2lzdFN0ZXBzIiwgX3RoaXNTdXBlcikuY2FsbChfdGhpc1N1cGVyKTsKCiAgICAgIHJldHVybiBfdGhpczsKICAgIH0KCiAgICBfY3JlYXRlQ2xhc3MoRVRIVE9LRU4yTkVYVCwgW3sKICAgICAga2V5OiAiX3BlcnNpc3RTdGF0ZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfcGVyc2lzdFN0YXRlKCkgewogICAgICAgIF9nZXQoX2dldFByb3RvdHlwZU9mKEVUSFRPS0VOMk5FWFQucHJvdG90eXBlKSwgIl9wZXJzaXN0U3RhdGUiLCB0aGlzKS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogIl9nZXRTdGVwcyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfZ2V0U3RlcHMoKSB7CiAgICAgICAgdmFyIF90aGlzMiA9IHRoaXM7CgogICAgICAgIHZhciBmbG93ID0gdGhpczsKICAgICAgICByZXR1cm4gWy8vIDEuIFNpZ24gc3dhcCB0byBzdGFydAogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIF90aGlzMi5zaWduQUJTaWRlKCk7CiAgICAgICAgfSwgLy8gMi4gV2FpdCBwYXJ0aWNpcGFudCBjcmVhdGUsIGZ1bmQgTkVYVCBTY3JpcHQKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmbG93LndhaXRVVFhPU2NyaXB0Q3JlYXRlZCgpOwogICAgICAgIH0sIC8vIDMuIFZlcmlmeSBORVhUIFNjcmlwdAogICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJ3YWl0aW5nIHZlcmlmeSBuZXh0IHNjcmlwdCIpOyAvLyB0aGlzLnZlcmlmeU5leHRTY3JpcHQoKQogICAgICAgIH0sIC8vIDQuIENoZWNrIGJhbGFuY2UKICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBfdGhpczIuc3luY0JhbGFuY2UoKTsKICAgICAgICB9LAogICAgICAgIC8qI19fUFVSRV9fKi8KICAgICAgICAvLyA1LiBDcmVhdGUgRVRIIENvbnRyYWN0CiAgICAgICAgX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZSgpIHsKICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZSQoX2NvbnRleHQpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0LnByZXYgPSBfY29udGV4dC5uZXh0KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIF9jb250ZXh0Lm5leHQgPSAyOwogICAgICAgICAgICAgICAgICByZXR1cm4gZmxvdy5ldGhUb2tlblN3YXAuZnVuZEFCMlVUWE9Db250cmFjdCh7CiAgICAgICAgICAgICAgICAgICAgZmxvdzogZmxvdywKICAgICAgICAgICAgICAgICAgICB1dHhvQ29pbjogIm5leHQiCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dC5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlKTsKICAgICAgICB9KSksCiAgICAgICAgLyojX19QVVJFX18qLwogICAgICAgIC8vIDYuIFdhaXQgcGFydGljaXBhbnQgd2l0aGRyYXcKICAgICAgICBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlMigpIHsKICAgICAgICAgIHJldHVybiBfcmVnZW5lcmF0b3JSdW50aW1lLndyYXAoZnVuY3Rpb24gX2NhbGxlZTIkKF9jb250ZXh0MikgewogICAgICAgICAgICB3aGlsZSAoMSkgewogICAgICAgICAgICAgIHN3aXRjaCAoX2NvbnRleHQyLnByZXYgPSBfY29udGV4dDIubmV4dCkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICBfY29udGV4dDIubmV4dCA9IDI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmbG93LmV0aFRva2VuU3dhcC5nZXRTZWNyZXRGcm9tQUIyVVRYTyh7CiAgICAgICAgICAgICAgICAgICAgZmxvdzogZmxvdwogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQyLnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIF9jYWxsZWUyKTsKICAgICAgICB9KSksCiAgICAgICAgLyojX19QVVJFX18qLwogICAgICAgIC8vIDcuIFdpdGhkcmF3CiAgICAgICAgX2FzeW5jVG9HZW5lcmF0b3IoIC8qI19fUFVSRV9fKi9fcmVnZW5lcmF0b3JSdW50aW1lLm1hcmsoZnVuY3Rpb24gX2NhbGxlZTMoKSB7CiAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWUzJChfY29udGV4dDMpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0My5wcmV2ID0gX2NvbnRleHQzLm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQzLm5leHQgPSAyOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5oZWxwZXJzLnJlcGVhdEFzeW5jVW50aWxSZXN1bHQoZnVuY3Rpb24gKHN0b3BSZXBlYXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX2Zsb3ckc3RhdGUgPSBmbG93LnN0YXRlLAogICAgICAgICAgICAgICAgICAgICAgICBzZWNyZXQgPSBfZmxvdyRzdGF0ZS5zZWNyZXQsCiAgICAgICAgICAgICAgICAgICAgICAgIHV0eG9TY3JpcHRWYWx1ZXMgPSBfZmxvdyRzdGF0ZS51dHhvU2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgICAgICBuZXh0U3dhcFdpdGhkcmF3VHJhbnNhY3Rpb25IYXNoID0gX2Zsb3ckc3RhdGUubmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2gpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKCF1dHhvU2NyaXB0VmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdUaGVyZSBpcyBubyAidXR4b1NjcmlwdFZhbHVlcyIgaW4gc3RhdGUuIE5vIHdheSB0byBjb250aW51ZSBzd2FwLi4uJyk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmbG93Lm5leHRTd2FwLndpdGhkcmF3KHsKICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdFZhbHVlczogdXR4b1NjcmlwdFZhbHVlcywKICAgICAgICAgICAgICAgICAgICAgIHNlY3JldDogc2VjcmV0LAogICAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb25BZGRyZXNzOiBmbG93LnN3YXAuZGVzdGluYXRpb25CdXlBZGRyZXNzCiAgICAgICAgICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICAgICAgZmxvdy5zZXRTdGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIG5leHRTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IGhhc2gKICAgICAgICAgICAgICAgICAgICAgIH0sIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSlbImNhdGNoIl0oZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICBmbG93LmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICAgIGlzTmV4dFdpdGhkcmF3bjogdHJ1ZQogICAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgc3RlcDogJ3dpdGhkcmF3LXV0eG8nCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDMuc3RvcCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwgX2NhbGxlZTMpOwogICAgICAgIH0pKSwgLy8gOC4gRmluaXNoCiAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgZmxvdy5zd2FwLnJvb20ub25jZSgncmVxdWVzdCBzd2FwIGZpbmlzaGVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCA9IGZsb3cuc3RhdGUubmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDsKICAgICAgICAgICAgZmxvdy5zd2FwLnJvb20uc2VuZE1lc3NhZ2UoewogICAgICAgICAgICAgIGV2ZW50OiAnc3dhcCBmaW5pc2hlZCcsCiAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaDogbmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGZsb3cuZmluaXNoU3RlcCh7CiAgICAgICAgICAgIGlzRmluaXNoZWQ6IHRydWUKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgc3RlcDogJ2ZpbmlzaCcKICAgICAgICAgIH0pOwogICAgICAgIH0sIC8vIDkuIEZpbmlzaGVkIQogICAgICAgIGZ1bmN0aW9uICgpIHt9XTsKICAgICAgfQogICAgfSwgewogICAgICBrZXk6ICJfY2hlY2tTd2FwQWxyZWFkeUV4aXN0cyIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBfY2hlY2tTd2FwQWxyZWFkeUV4aXN0cygpIHsKICAgICAgICB2YXIgc3dhcERhdGEgPSB7CiAgICAgICAgICBvd25lckFkZHJlc3M6IHRoaXMuYXBwLmdldE15RXRoQWRkcmVzcygpLAogICAgICAgICAgcGFydGljaXBhbnRBZGRyZXNzOiB0aGlzLmFwcC5nZXRQYXJ0aWNpcGFudEV0aEFkZHJlc3ModGhpcy5zd2FwKQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIHRoaXMuZXRoVG9rZW5Td2FwLmNoZWNrU3dhcEV4aXN0cyhzd2FwRGF0YSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAidHJ5UmVmdW5kIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgX3RyeVJlZnVuZCA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU0KCkgewogICAgICAgICAgdmFyIF90aGlzMyA9IHRoaXM7CgogICAgICAgICAgdmFyIHNlY3JldEhhc2gsIHJlZnVuZEhhbmRsZXIsIHdhc1JlZnVuZGVkOwogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNCQoX2NvbnRleHQ0KSB7CiAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDQucHJldiA9IF9jb250ZXh0NC5uZXh0KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIHNlY3JldEhhc2ggPSB0aGlzLnN0YXRlLnNlY3JldEhhc2g7CgogICAgICAgICAgICAgICAgICByZWZ1bmRIYW5kbGVyID0gZnVuY3Rpb24gcmVmdW5kSGFuZGxlcigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaGFzaCA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDogbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgX3RoaXMzLnN3YXAucm9vbS5zZW5kTWVzc2FnZSh7CiAgICAgICAgICAgICAgICAgICAgICBldmVudDogJ2V0aCByZWZ1bmQgY29tcGxldGVkJwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBfdGhpczMuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgICAgICAgcmVmdW5kVHJhbnNhY3Rpb25IYXNoOiBoYXNoLAogICAgICAgICAgICAgICAgICAgICAgaXNSZWZ1bmRlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgIGlzU3dhcEV4aXN0OiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0sIHRydWUpOwogICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0LnByZXYgPSAyOwogICAgICAgICAgICAgICAgICBfY29udGV4dDQubmV4dCA9IDU7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV0aFRva2VuU3dhcC53YXNSZWZ1bmRlZCh7CiAgICAgICAgICAgICAgICAgICAgc2VjcmV0SGFzaDogc2VjcmV0SGFzaAogICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICAgIHdhc1JlZnVuZGVkID0gX2NvbnRleHQ0LnNlbnQ7CgogICAgICAgICAgICAgICAgICBpZiAoIXdhc1JlZnVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSAxMDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoJ1RoaXMgc3dhcCB3YXMgcmVmdW5kZWQnKTsKICAgICAgICAgICAgICAgICAgcmVmdW5kSGFuZGxlcigpOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ0LmFicnVwdCgicmV0dXJuIiwgdHJ1ZSk7CgogICAgICAgICAgICAgICAgY2FzZSAxMDoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0Lm5leHQgPSAxNjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgY2FzZSAxMjoKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0LnByZXYgPSAxMjsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ0LnQwID0gX2NvbnRleHQ0WyJjYXRjaCJdKDIpOwogICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ3dhc1JlZnVuZGVkIGVycm9yOicsIF9jb250ZXh0NC50MCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDQuYWJydXB0KCJyZXR1cm4iLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5hYnJ1cHQoInJldHVybiIsIHRoaXMuZXRoVG9rZW5Td2FwLnJlZnVuZCh7CiAgICAgICAgICAgICAgICAgICAgcGFydGljaXBhbnRBZGRyZXNzOiB0aGlzLmFwcC5nZXRQYXJ0aWNpcGFudEV0aEFkZHJlc3ModGhpcy5zd2FwKQogICAgICAgICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChoYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZWZ1bmRIYW5kbGVyKGhhc2gpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICB9KVsiY2F0Y2giXShmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgICAgICBjYXNlIDE3OgogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jb250ZXh0NC5zdG9wKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LCBfY2FsbGVlNCwgdGhpcywgW1syLCAxMl1dKTsKICAgICAgICB9KSk7CgogICAgICAgIGZ1bmN0aW9uIHRyeVJlZnVuZCgpIHsKICAgICAgICAgIHJldHVybiBfdHJ5UmVmdW5kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ5UmVmdW5kOwogICAgICB9KCkKICAgIH0sIHsKICAgICAga2V5OiAiaXNSZWZ1bmRTdWNjZXNzIiwKICAgICAgdmFsdWU6IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgX2lzUmVmdW5kU3VjY2VzcyA9IF9hc3luY1RvR2VuZXJhdG9yKCAvKiNfX1BVUkVfXyovX3JlZ2VuZXJhdG9yUnVudGltZS5tYXJrKGZ1bmN0aW9uIF9jYWxsZWU1KCkgewogICAgICAgICAgcmV0dXJuIF9yZWdlbmVyYXRvclJ1bnRpbWUud3JhcChmdW5jdGlvbiBfY2FsbGVlNSQoX2NvbnRleHQ1KSB7CiAgICAgICAgICAgIHdoaWxlICgxKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChfY29udGV4dDUucHJldiA9IF9jb250ZXh0NS5uZXh0KSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgIHJldHVybiBfY29udGV4dDUuYWJydXB0KCJyZXR1cm4iLCB0cnVlKTsKCiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ1LnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIF9jYWxsZWU1KTsKICAgICAgICB9KSk7CgogICAgICAgIGZ1bmN0aW9uIGlzUmVmdW5kU3VjY2VzcygpIHsKICAgICAgICAgIHJldHVybiBfaXNSZWZ1bmRTdWNjZXNzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaXNSZWZ1bmRTdWNjZXNzOwogICAgICB9KCkKICAgIH0sIHsKICAgICAga2V5OiAidHJ5V2l0aGRyYXciLAogICAgICB2YWx1ZTogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBfdHJ5V2l0aGRyYXcgPSBfYXN5bmNUb0dlbmVyYXRvciggLyojX19QVVJFX18qL19yZWdlbmVyYXRvclJ1bnRpbWUubWFyayhmdW5jdGlvbiBfY2FsbGVlNihfc2VjcmV0KSB7CiAgICAgICAgICB2YXIgX3RoaXM0ID0gdGhpczsKCiAgICAgICAgICB2YXIgX3RoaXMkc3RhdGUsIHNlY3JldCwgc2VjcmV0SGFzaCwgaXNFdGhXaXRoZHJhd24sIGlzTmV4dFdpdGhkcmF3biwgdXR4b1NjcmlwdFZhbHVlcywgX3NlY3JldEhhc2gsIF90aGlzJG5leHRTd2FwJGNyZWF0ZSwgc2NyaXB0QWRkcmVzcywgYmFsYW5jZTsKCiAgICAgICAgICByZXR1cm4gX3JlZ2VuZXJhdG9yUnVudGltZS53cmFwKGZ1bmN0aW9uIF9jYWxsZWU2JChfY29udGV4dDYpIHsKICAgICAgICAgICAgd2hpbGUgKDEpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKF9jb250ZXh0Ni5wcmV2ID0gX2NvbnRleHQ2Lm5leHQpIHsKICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgX3RoaXMkc3RhdGUgPSB0aGlzLnN0YXRlLCBzZWNyZXQgPSBfdGhpcyRzdGF0ZS5zZWNyZXQsIHNlY3JldEhhc2ggPSBfdGhpcyRzdGF0ZS5zZWNyZXRIYXNoLCBpc0V0aFdpdGhkcmF3biA9IF90aGlzJHN0YXRlLmlzRXRoV2l0aGRyYXduLCBpc05leHRXaXRoZHJhd24gPSBfdGhpcyRzdGF0ZS5pc05leHRXaXRoZHJhd24sIHV0eG9TY3JpcHRWYWx1ZXMgPSBfdGhpcyRzdGF0ZS51dHhvU2NyaXB0VmFsdWVzOwoKICAgICAgICAgICAgICAgICAgaWYgKF9zZWNyZXQpIHsKICAgICAgICAgICAgICAgICAgICBfY29udGV4dDYubmV4dCA9IDM7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2l0aGRyYXdhbCBpcyBhdXRvbWF0aWMuIEZvciBtYW51YWwgd2l0aGRyYXdhbCwgcHJvdmlkZSBhIHNlY3JldCIpOwoKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgaWYgKHV0eG9TY3JpcHRWYWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICBfY29udGV4dDYubmV4dCA9IDU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHdpdGhkcmF3IHdpdGhvdXQgc2NyaXB0IHZhbHVlcyIpOwoKICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgaWYgKHNlY3JldCAmJiBzZWNyZXQgIT0gX3NlY3JldCkgY29uc29sZS53YXJuKCJTZWNyZXQgYWxyZWFkeSBrbm93biBhbmQgaXMgZGlmZmVyZW50LiBBcmUgeW91IHN1cmU/Iik7CiAgICAgICAgICAgICAgICAgIGlmIChpc05leHRXaXRoZHJhd24pIGNvbnNvbGUud2FybigiTG9va3MgbGlrZSBtb25leSB3ZXJlIGFscmVhZHkgd2l0aGRyYXduLCBhcmUgeW91IHN1cmU/Iik7CiAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJXSVRIRFJBVyB1c2luZyBzZWNyZXQgPSAiLmNvbmNhdChfc2VjcmV0KSk7CiAgICAgICAgICAgICAgICAgIF9zZWNyZXRIYXNoID0gdGhpcy5hcHAuZW52LmJpdGNvaW4uY3J5cHRvLnJpcGVtZDE2MChCdWZmZXIuZnJvbShfc2VjcmV0LCAnaGV4JykpLnRvU3RyaW5nKCdoZXgnKTsKICAgICAgICAgICAgICAgICAgaWYgKHNlY3JldEhhc2ggIT0gX3NlY3JldEhhc2gpIGNvbnNvbGUud2FybigiSGFzaCBkb2VzIG5vdCBtYXRjaCEgc3RhdGU6ICIuY29uY2F0KHNlY3JldEhhc2gsICIsIGdpdmVuOiAiKS5jb25jYXQoX3NlY3JldEhhc2gpKTsKICAgICAgICAgICAgICAgICAgX3RoaXMkbmV4dFN3YXAkY3JlYXRlID0gdGhpcy5uZXh0U3dhcC5jcmVhdGVTY3JpcHQodXR4b1NjcmlwdFZhbHVlcyksIHNjcmlwdEFkZHJlc3MgPSBfdGhpcyRuZXh0U3dhcCRjcmVhdGUuc2NyaXB0QWRkcmVzczsKICAgICAgICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSAxMzsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubmV4dFN3YXAuZ2V0QmFsYW5jZShzY3JpcHRBZGRyZXNzKTsKCiAgICAgICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICAgICAgICBiYWxhbmNlID0gX2NvbnRleHQ2LnNlbnQ7CiAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJhZGRyZXNzPSIuY29uY2F0KHNjcmlwdEFkZHJlc3MsICIsIGJhbGFuY2U9IikuY29uY2F0KGJhbGFuY2UpKTsKCiAgICAgICAgICAgICAgICAgIGlmICghKGJhbGFuY2UgPT09IDApKSB7CiAgICAgICAgICAgICAgICAgICAgX2NvbnRleHQ2Lm5leHQgPSAxODsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgdGhpcy5maW5pc2hTdGVwKHsKICAgICAgICAgICAgICAgICAgICBpc05leHRXaXRoZHJhd246IHRydWUKICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgIHN0ZXA6ICd3aXRoZHJhdy11dHhvJwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbHJlYWR5IHdpdGhkcmF3bjogYWRkcmVzcz0iLmNvbmNhdChzY3JpcHRBZGRyZXNzLCAiLGJhbGFuY2U9IikuY29uY2F0KGJhbGFuY2UpKTsKCiAgICAgICAgICAgICAgICBjYXNlIDE4OgogICAgICAgICAgICAgICAgICBfY29udGV4dDYubmV4dCA9IDIwOwogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5uZXh0U3dhcC53aXRoZHJhdyh7CiAgICAgICAgICAgICAgICAgICAgc2NyaXB0VmFsdWVzOiB1dHhvU2NyaXB0VmFsdWVzLAogICAgICAgICAgICAgICAgICAgIHNlY3JldDogX3NlY3JldAogICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoaGFzaCkgewogICAgICAgICAgICAgICAgICAgIGRlYnVnKCdzd2FwLmNvcmU6ZmxvdycpKCJUWCBoYXNoPSIuY29uY2F0KGhhc2gpKTsKCiAgICAgICAgICAgICAgICAgICAgX3RoaXM0LnNldFN0YXRlKHsKICAgICAgICAgICAgICAgICAgICAgIG5leHRTd2FwV2l0aGRyYXdUcmFuc2FjdGlvbkhhc2g6IGhhc2gKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgY2FzZSAyMDoKICAgICAgICAgICAgICAgICAgZGVidWcoJ3N3YXAuY29yZTpmbG93JykoIlRYIHdpdGhkcmF3IHNlbnQ6ICIuY29uY2F0KHRoaXMuc3RhdGUubmV4dFN3YXBXaXRoZHJhd1RyYW5zYWN0aW9uSGFzaCkpOwogICAgICAgICAgICAgICAgICB0aGlzLmZpbmlzaFN0ZXAoewogICAgICAgICAgICAgICAgICAgIGlzTmV4dFdpdGhkcmF3bjogdHJ1ZQogICAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgc3RlcDogJ3dpdGhkcmF3LXV0eG8nCiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGNhc2UgMjI6CiAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICByZXR1cm4gX2NvbnRleHQ2LnN0b3AoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIF9jYWxsZWU2LCB0aGlzKTsKICAgICAgICB9KSk7CgogICAgICAgIGZ1bmN0aW9uIHRyeVdpdGhkcmF3KF94KSB7CiAgICAgICAgICByZXR1cm4gX3RyeVdpdGhkcmF3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ5V2l0aGRyYXc7CiAgICAgIH0oKQogICAgfV0sIFt7CiAgICAgIGtleTogImdldE5hbWUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0TmFtZSgpIHsKICAgICAgICByZXR1cm4gIiIuY29uY2F0KHRoaXMuZ2V0RnJvbU5hbWUoKSwgIjIiKS5jb25jYXQodGhpcy5nZXRUb05hbWUoKSk7CiAgICAgIH0KICAgIH0sIHsKICAgICAga2V5OiAiZ2V0RnJvbU5hbWUiLAogICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0RnJvbU5hbWUoKSB7CiAgICAgICAgcmV0dXJuIHRva2VuTmFtZS50b1VwcGVyQ2FzZSgpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGtleTogImdldFRvTmFtZSIsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiBnZXRUb05hbWUoKSB7CiAgICAgICAgcmV0dXJuIGNvbnN0YW50cy5DT0lOUy5uZXh0OwogICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIEVUSFRPS0VOMk5FWFQ7CiAgfShBdG9taWNBQjJVVFhPKTsKCiAgcmV0dXJuIEVUSFRPS0VOMk5FWFQ7Cn0pOw=="},{"version":3,"sources":["C:/Users/Alexei/MultiCurrencyWallet/src/core/swap.flows/ETHTOKEN2NEXT.ts"],"names":["debug","constants","util","AtomicAB2UTXO","tokenName","ETHTOKEN2NEXT","swap","utxoCoin","_flowName","getName","stepNumbers","ethTokenSwap","participantSwap","nextSwap","ownerSwap","abBlockchain","utxoBlockchain","Error","state","step","isStoppedSwap","signTransactionHash","isSignFetching","isMeSigned","targetWallet","secretHash","isBalanceFetching","isBalanceEnough","balance","ethSwapCreationTransactionHash","canCreateEthTransaction","isEthContractFunded","secret","isEthWithdrawn","isNextWithdrawn","ethSwapWithdrawTransactionHash","nextSwapWithdrawTransactionHash","refundTransactionHash","isRefunded","isFinished","isSwapExist","withdrawRequestIncoming","withdrawRequestAccepted","isFailedTransaction","isFailedTransactionError","gasAmountNeeded","_persistState","flow","room","once","setState","signABSide","waitUTXOScriptCreated","syncBalance","fundAB2UTXOContract","getSecretFromAB2UTXO","helpers","repeatAsyncUntilResult","stopRepeat","utxoScriptValues","console","error","withdraw","scriptValues","destinationAddress","destinationBuyAddress","then","hash","finishStep","sendMessage","event","data","swapData","ownerAddress","app","getMyEthAddress","participantAddress","getParticipantEthAddress","checkSwapExists","refundHandler","wasRefunded","warn","refund","_secret","_secretHash","env","bitcoin","crypto","ripemd160","Buffer","from","toString","createScript","scriptAddress","getBalance","getFromName","getToName","toUpperCase","COINS","next"],"mappings":"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","sourcesContent":["import debug from 'debug'\r\nimport SwapApp, { constants, util } from 'swap.app'\r\nimport { AtomicAB2UTXO } from 'swap.swap'\r\n\r\n\r\nexport default (tokenName) => {\r\n\r\n  class ETHTOKEN2NEXT extends AtomicAB2UTXO {\r\n\r\n    _flowName: string\r\n    ethTokenSwap: any\r\n    nextSwap: any\r\n    state: any\r\n\r\n    static getName() {\r\n      return `${this.getFromName()}2${this.getToName()}`\r\n    }\r\n    static getFromName() {\r\n      return tokenName.toUpperCase()\r\n    }\r\n    static getToName() {\r\n      return constants.COINS.next\r\n    }\r\n    constructor(swap) {\r\n      super(swap)\r\n      this.utxoCoin = `next`\r\n\r\n      this._flowName = ETHTOKEN2NEXT.getName()\r\n\r\n      this.stepNumbers = {\r\n        'sign': 1,\r\n        'wait-lock-utxo': 2,\r\n        'verify-script': 3,\r\n        'sync-balance': 4,\r\n        'lock-eth': 5,\r\n        'wait-withdraw-eth': 6, // aka getSecret\r\n        'withdraw-utxo': 7,\r\n        'finish': 8,\r\n        'end': 9\r\n      }\r\n\r\n      this.ethTokenSwap = swap.participantSwap\r\n      this.nextSwap = swap.ownerSwap\r\n\r\n      this.abBlockchain = this.ethTokenSwap\r\n      this.utxoBlockchain = this.nextSwap\r\n\r\n      if (!this.ethTokenSwap) {\r\n        throw new Error('ETHTOKEN2NEXT: \"ethTokenSwap\" of type object required')\r\n      }\r\n      if (!this.nextSwap) {\r\n        throw new Error('ETHTOKEN2NEXT: \"nextSwap\" of type object required')\r\n      }\r\n\r\n      this.state = {\r\n        step: 0,\r\n\r\n        isStoppedSwap: false,\r\n\r\n        signTransactionHash: null,\r\n        isSignFetching: false,\r\n        isMeSigned: false,\r\n\r\n        targetWallet : null,\r\n        secretHash: null,\r\n\r\n        isBalanceFetching: false,\r\n        isBalanceEnough: true,\r\n        balance: null,\r\n\r\n        ethSwapCreationTransactionHash: null,\r\n        canCreateEthTransaction: true,\r\n        isEthContractFunded: false,\r\n\r\n        secret: null,\r\n\r\n        isEthWithdrawn: false,\r\n        isNextWithdrawn: false,\r\n\r\n        ethSwapWithdrawTransactionHash: null,\r\n        nextSwapWithdrawTransactionHash: null,\r\n\r\n        refundTransactionHash: null,\r\n        isRefunded: false,\r\n\r\n        isFinished: false,\r\n        isSwapExist: false,\r\n\r\n        withdrawRequestIncoming: false,\r\n        withdrawRequestAccepted: false,\r\n\r\n        isFailedTransaction: false,\r\n        isFailedTransactionError: null,\r\n        gasAmountNeeded: 0,\r\n      }\r\n\r\n      this._persistState()\r\n\r\n      const flow = this\r\n      flow.swap.room.once('request withdraw', () => {\r\n        flow.setState({\r\n          withdrawRequestIncoming: true,\r\n        })\r\n      })\r\n\r\n      super._persistSteps()\r\n    }\r\n\r\n    _persistState() {\r\n      super._persistState()\r\n    }\r\n\r\n    _getSteps() {\r\n      const flow = this\r\n\r\n      return [\r\n\r\n        // 1. Sign swap to start\r\n\r\n        () => {\r\n          this.signABSide()\r\n        },\r\n\r\n        // 2. Wait participant create, fund NEXT Script\r\n\r\n        () => {\r\n          flow.waitUTXOScriptCreated()\r\n        },\r\n\r\n        // 3. Verify NEXT Script\r\n\r\n        () => {\r\n          debug('swap.core:flow')(`waiting verify next script`)\r\n          // this.verifyNextScript()\r\n        },\r\n\r\n        // 4. Check balance\r\n\r\n        () => {\r\n          this.syncBalance()\r\n        },\r\n\r\n        // 5. Create ETH Contract\r\n\r\n        async () => {\r\n          await flow.ethTokenSwap.fundAB2UTXOContract({\r\n            flow,\r\n            utxoCoin: `next`,\r\n          })\r\n        },\r\n\r\n        // 6. Wait participant withdraw\r\n\r\n        async () => {\r\n          await flow.ethTokenSwap.getSecretFromAB2UTXO({ flow })\r\n        },\r\n\r\n        // 7. Withdraw\r\n\r\n        async () => {\r\n          await util.helpers.repeatAsyncUntilResult((stopRepeat) => {\r\n            const { secret, utxoScriptValues, nextSwapWithdrawTransactionHash } = flow.state\r\n\r\n            if (nextSwapWithdrawTransactionHash) {\r\n              return true\r\n            }\r\n\r\n            if (!utxoScriptValues) {\r\n              console.error('There is no \"utxoScriptValues\" in state. No way to continue swap...')\r\n              return null\r\n            }\r\n\r\n            return flow.nextSwap.withdraw({\r\n              scriptValues: utxoScriptValues,\r\n              secret,\r\n              destinationAddress: flow.swap.destinationBuyAddress,\r\n            })\r\n              .then((hash) => {\r\n                flow.setState({\r\n                  nextSwapWithdrawTransactionHash: hash,\r\n                }, true)\r\n                return true\r\n              })\r\n              .catch((error) => null)\r\n          })\r\n\r\n          flow.finishStep({\r\n            isNextWithdrawn: true,\r\n          }, { step: 'withdraw-utxo' })\r\n        },\r\n\r\n        // 8. Finish\r\n\r\n        () => {\r\n          flow.swap.room.once('request swap finished', () => {\r\n            const { nextSwapWithdrawTransactionHash } = flow.state\r\n\r\n            flow.swap.room.sendMessage({\r\n              event: 'swap finished',\r\n              data: {\r\n                nextSwapWithdrawTransactionHash,\r\n              },\r\n            })\r\n          })\r\n\r\n          flow.finishStep({\r\n            isFinished: true,\r\n          }, { step: 'finish' })\r\n        },\r\n\r\n        // 9. Finished!\r\n\r\n        () => {},\r\n      ]\r\n    }\r\n\r\n    _checkSwapAlreadyExists() {\r\n      const swapData = {\r\n        ownerAddress: this.app.getMyEthAddress(),\r\n        participantAddress: this.app.getParticipantEthAddress(this.swap)\r\n      }\r\n\r\n      return this.ethTokenSwap.checkSwapExists(swapData)\r\n    }\r\n\r\n    async tryRefund() {\r\n      const { secretHash } = this.state\r\n\r\n      const refundHandler = (hash = null) => {\r\n        this.swap.room.sendMessage({\r\n          event: 'eth refund completed',\r\n        })\r\n\r\n        this.setState({\r\n          refundTransactionHash: hash,\r\n          isRefunded: true,\r\n          isSwapExist: false,\r\n        }, true)\r\n      }\r\n\r\n      try {\r\n        const wasRefunded = await this.ethTokenSwap.wasRefunded({ secretHash })\r\n\r\n        if (wasRefunded) {\r\n          debug('swap.core:flow')('This swap was refunded')\r\n\r\n          refundHandler()\r\n\r\n          return true\r\n        }\r\n      } catch (error) {\r\n        console.warn('wasRefunded error:', error)\r\n\r\n        return false\r\n      }\r\n\r\n      return this.ethTokenSwap.refund({\r\n        participantAddress: this.app.getParticipantEthAddress(this.swap),\r\n      })\r\n        .then((hash) => {\r\n          if (!hash) {\r\n            return false\r\n          }\r\n\r\n          refundHandler(hash)\r\n\r\n          return true\r\n        })\r\n        .catch((error) => false)\r\n    }\r\n\r\n    async isRefundSuccess() {\r\n      return true\r\n    }\r\n\r\n    async tryWithdraw(_secret) {\r\n      const { secret, secretHash, isEthWithdrawn, isNextWithdrawn, utxoScriptValues } = this.state\r\n\r\n      if (!_secret)\r\n        throw new Error(`Withdrawal is automatic. For manual withdrawal, provide a secret`)\r\n\r\n      if (!utxoScriptValues)\r\n        throw new Error(`Cannot withdraw without script values`)\r\n\r\n      if (secret && secret != _secret)\r\n        console.warn(`Secret already known and is different. Are you sure?`)\r\n\r\n      if (isNextWithdrawn)\r\n        console.warn(`Looks like money were already withdrawn, are you sure?`)\r\n\r\n      debug('swap.core:flow')(`WITHDRAW using secret = ${_secret}`)\r\n\r\n      const _secretHash = this.app.env.bitcoin.crypto.ripemd160(Buffer.from(_secret, 'hex')).toString('hex')\r\n\r\n      if (secretHash != _secretHash)\r\n        console.warn(`Hash does not match! state: ${secretHash}, given: ${_secretHash}`)\r\n\r\n      const {scriptAddress} = this.nextSwap.createScript(utxoScriptValues)\r\n      const balance = await this.nextSwap.getBalance(scriptAddress)\r\n\r\n      debug('swap.core:flow')(`address=${scriptAddress}, balance=${balance}`)\r\n\r\n      if (balance === 0) {\r\n        this.finishStep({\r\n          isNextWithdrawn: true,\r\n        }, {step: 'withdraw-utxo'})\r\n        throw new Error(`Already withdrawn: address=${scriptAddress},balance=${balance}`)\r\n      }\r\n\r\n      await this.nextSwap.withdraw({\r\n        scriptValues: utxoScriptValues,\r\n        secret: _secret,\r\n      }, (hash) => {\r\n        debug('swap.core:flow')(`TX hash=${hash}`)\r\n        this.setState({\r\n          nextSwapWithdrawTransactionHash: hash,\r\n        })\r\n      })\r\n      debug('swap.core:flow')(`TX withdraw sent: ${this.state.nextSwapWithdrawTransactionHash}`)\r\n\r\n      this.finishStep({\r\n        isNextWithdrawn: true,\r\n      }, { step: 'withdraw-utxo' })\r\n    }\r\n  }\r\n\r\n  return ETHTOKEN2NEXT\r\n}\r\n"]}]}